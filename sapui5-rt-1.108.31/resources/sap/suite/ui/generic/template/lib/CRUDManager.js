sap.ui.define(["sap/ui/base/Object","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/model/Context","sap/m/MessageBox","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/ui/core/message/Message","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser"],function(e,t,n,r,a,i,o,s,l,c,u,g,f,p,v,d){"use strict";var C="lib.CRUDManager";var E=Promise.reject();E.catch(Function.prototype);function m(e){return Object.keys(e).map(function(t){return e[t]})}function h(e){if(e){return e.map(function(e,t){return t})}}function D(e,p,D,y,A){function b(t,n,a,i){if(a){r.handleError(t,e,D,a,i)}return(n||Function.prototype)(a)}var T;function M(t){return new Promise(function(n,a){var i=e.getOwnerComponent();var o=i.getBindingContext();var s=i.getModel();s.read(o.getPath(),{urlParameters:{$expand:"DraftAdministrativeData"},success:function(e){if(!e.DraftAdministrativeData){if(t){return b(r.operations.editEntity,a,t)}return n({})}if(e.DraftAdministrativeData.InProcessByUser){var i=e.DraftAdministrativeData.InProcessByUserDescription||e.DraftAdministrativeData.InProcessByUser;var o=Promise.resolve(t||p.getMainComponentUtils().then(function(e){var t=e.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",i]);return new c(t)}));return o.then(function(e){b(r.operations.editEntity,a,e,e)})}return n({draftAdministrativeData:e.DraftAdministrativeData})},error:b.bind(null,r.operations.editEntity,a)})})}function P(){return new Promise(function(t){var n=e.getView().getModel();if(d.isContentIdReferencingAllowed(n)){p.getMainComponentUtils().then(function(e){t(e.getRootExpand())})}else{t(null)}})}function x(e,t,n){var a=e.bindingContext;if(n&&n.draftAdministrativeData){return Promise.resolve(n)}return P().then(function(n){return new Promise(function(i,o){D.oTransactionController.editEntity(a,!t,n).then(function(t){var n;n=e.view;var r=function(){a.getModel().invalidateEntry(a);n.detachEvent("modelContextChange",r)};if(n){n.attachEvent("modelContextChange",r)}return i({context:t.context})},function(e){if(e&&e.response&&e.response.statusCode==="409"&&!t){D.oApplication.removeTransientMessages();return M(e).then(i,o)}else{b(r.operations.editEntity,o,e,e)}})})})}T=function(t){var n=p.isDraftEnabled();var r,a;if(n){var i=p.getViewLevel();var o;if(i>0){o=p.getMainComponentDetails();var s=D.oApplication.checkContextData(o.bindingContext);if(!s){D.oApplication.registerContext(o.bindingContext,1,o.entitySet,D.oApplication.getCurrentKeys(1))}a=p.getTargetKeyFromLevel(2)}if(!t){var l=D.oDraftController.getDraftContext();var c=l.hasPreserveChanges(o.bindingContext);if(!c){r=M().then(x.bind(null,o,true))}}r=r||x(o,t,{});D.oApplication.editingStarted(o.bindingContext,r)}else{var u=e.getView().getBindingContext();r=Promise.resolve({context:u})}var g=Promise.all([r,a]);return g.then(function(e){var t={};var n=Object.keys(e[0])[0];t[n]=e[0][n];t.targetSiblingKey=e[1];return t})};function S(e){if(A.isBusy()){return E}var t=T(e);A.setBusy(t);return t}function O(n,a,i){var o=new Promise(function(o,s){var l=function(){var e=t.getEntitySetFromContext(i);var o=D.oDraftController.getDraftContext();var s=o.isDraftRoot(e);var l=p.getViewLevel();var c=l>=2?y.getText("ITEM_DELETED"):y.getText("ST_GENERIC_OBJECT_DELETED");if(!n&&s){c=y.getText(a?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED")}r.showSuccessMessageIfRequired(c,D)};var c=function(t){if(t.length===0){l();o()}else{r.handleError(r.operations.deleteEntity,e,D,t[0].oError,null);s()}};var u=w({pathes:[i.getPath()],withWarningDialog:true});u.then(c,s)});return o}function R(){var t=e.getView().getBindingContext();var n=D.oDraftController.isActiveEntity(t);return a.deleteEntity(D.oDraftController,O,D.oApplication,t,n,"deleteAction")}function I(e,t,n){var a={mFailed:Object.create(null),mSuccess:Object.create(null),mWarning:Object.create(null),aMessagesForUserDecision:[]};for(var i=0;i<e.length;i++){var o=e[i];var s=t[i];var c=r.parseError(s);var u=parseInt(c.httpStatusCode,10);var g=s&&s.response&&s.response.headers;if(u>=200&&u<300||u===304){a.mSuccess[o]=s}else if(u===412&&g&&g["preference-applied"]){a.mWarning[o]=s}else{a.mFailed[o]=s}}if(!l(a.mWarning)&&n){a.aMessagesForUserDecision=D.oApplication.getTransientMessages();D.oApplication.removeTransientMessages()}return a}function w(e){var t=new Promise(function(t,n){var r=Object.create(null);var a=Object.create(null);var i=function(e,t,n){a[e]={resolve:t,reject:n}};for(var o=0;o<e.pathes.length;o++){var c=e.pathes[o];r[c]=new Promise(i.bind(null,c))}D.oApplication.prepareDeletion(r,e.suppressRefreshAllComponents);var u=Object.create(null);var g=Object.create(null);var f;var v=function(r){if(!l(u)){D.oApplication.markCurrentDraftAsModified()}for(var i in a){var o=a[i];o[u[i]?"resolve":"reject"]()}if(r){return n()}var s=e.pathes.map(function(e){return{sPath:e,oError:g[e]||f[e],isWarning:!!f[e]}}).filter(function(e){return!!e.oError});t(s)};var d=function(e){if(e.length>0){var t=p.getCRUDActionHandler();var n={messagesForUserDecison:e};t.handleCRUDScenario(4,C.bind(null,Object.keys(f),false,false),v.bind(null,true),"Delete",n);return}v()};var C=function(t,n,r){if(e.suppressRefreshAllComponents&&e.smartTable){D.oPresentationControlHandlerFactory.getPresentationControlHandler(e.smartTable).refresh("Changes")}var a=function(n){var a=I(t,n,r,e.onlyOneDraftPlusActive);g=s(g,a.mFailed);u=s(u,a.mSuccess);f=a.mWarning;d(a.aMessagesForUserDecision)};var i=D.oTransactionController.deleteEntities(t,{bIsStrict:n}).then(a,a);A.setBusy(i)};var E=e.withWarningDialog&&(e.pathes.length===1||e.onlyOneDraftPlusActive);C(e.pathes,true,E)});return t}function _(e){return a.discardDraft(D.oDraftController,D.oTransactionController,D.oApplication,e)}function U(e){var t=function(t){var n=[];e.forEach(function(e){n.push(e.sContextPath)});var r=I(n,t);var a=m(r.mSuccess);return a};var n=D.oTransactionController.updateMultipleEntities(e).then(t,t);A.setBusy(n);return n}function B(t){var n=t.getMetaModel().getODataEntitySet(e.getOwnerComponent().getEntitySet())["Org.OData.Capabilities.V1.InsertRestrictions"],r=[];if(n&&n.RequiredProperties){var a=e.getView().getBindingContext().getObject();n.RequiredProperties.forEach(function(e){if(!a[e["PropertyPath"]]){r.push(e["PropertyPath"])}})}return r}function F(t){var n=t.oMetaModel.getODataEntitySet(e.getOwnerComponent().getEntitySet()),r=t.oMetaModel.getODataEntityType(n.entityType);return r}function N(e,t,n,r){t.removeAllMessages();var a=F(r);e.forEach(function(e){var i=n.target,o=n.fullTarget,s=r.oMetaModel.getODataProperty(a,e)&&r.oMetaModel.getODataProperty(a,e)["sap:label"];if(s){var l=new v({message:y.getSpecializedText("ENTER_MANDATORY",e,null,[s]),persistent:false,technical:false,target:i+"/"+e,fullTarget:o+"/"+e,type:sap.ui.core.MessageType.Error,processor:r});t.addMessages(l)}});D.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover()}function H(t,n,r){if(A.isBusy()){n();return}var i,o,s=Object.create(null),o;i=sap.ui.getCore().getMessageManager();var l=r?r:D.oTemplateCapabilities.oMessageButtonHelper&&D.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(false);o=a.fnGetMessagesFromContextFilter(l,i,true);o=o.map(function(e){s[e.getId()]=e;return e});var c=e.getView().getModel();if(!r){var u=B(c);if(u.length>0){N(u,i,D.oTemplateCapabilities.oMessageButtonHelper.getTargetInfo(c),c);n();return}}var g=function(){var e=p.getCRUDActionHandler();e.handleCRUDScenario(4,f.bind(null,false),n,"Activate")};var f=function(e){var c=D.oTransactionController.triggerSubmitChanges({bStrict:e});c.then(function(e){i.removeMessages(o);t(e.context)},function(t){var o=false;var c=[];var u=a.fnGetMessagesFromContextFilter(l,i,true);var f=u.map(function(e){if(!s[e.getId()]){e.persistent=false;e.technical=false;o=o||e.technicalDetails.statusCode==="412"&&e.technicalDetails.headers["preference-applied"]==="handling=strict";c.push(e)}return e});if(c.length){i.removeMessages(f);i.addMessages(c);if(o&&e){g();return}if(!r){D.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover()}}n()});A.setBusy(c)};f(true)}function j(e){var t=e;var n=new Promise(function(e,n){D.oApplication.performAfterSideEffectExecution(H.bind(null,e,n,t))});return n}function G(t,n){return a.activateDraftEntity(t,n,A,D,e,p)}function L(e){return new n(e)}function W(e,t,n){if(!p.isDraftEnabled()||n){var r,a;var i=D.oPresentationControlHandlerFactory.getPresentationControlHandler(y.getOwnerPresentationControl(e));var o=i.getEntitySet();var s=i.getBindingContext();if(s&&s.getPath()!==o){r=s;a=i.getBindingPath()}else{r=new u(i.getModel(),"/"+o)}return D.oTransactionController.getDefaultValues([r],[t],a)}else{return t}}function V(t,n,r,a){if(A.isBusy()){a();return}var i=[];var o=[];var s=[];var l=false;var c;var f=[];var v=t.functionImportPath;var d=t.contexts||[];var C=t.sourceControlHandler;if(d.length===0&&C){var E=C.getModel();var b="/";var T=C.getEntitySet();var M=b.concat(T);d.push(new u(E,M))}var P=t.label;var x=t.operationGrouping;var S=t.skipProperties;var O=function(){if(d[0]){var e=d[0].oModel;if(e&&e.hasPendingChanges()){e.resetChanges()}}};var R=function(e){O();a(e)};var w=function(e,t){if(e.length>0){var n=p.getCRUDActionHandler();var r;if(d.length===0){r=U.bind(null,false,false,d)}else{var a=d.filter(function(e,t){return f.includes(""+t)});r=U.bind(null,false,false,a)}var i={messagesForUserDecison:e,actionName:P};n.handleCRUDScenario(4,r,t,"BOPFAction",i);return}t()};var _=d.length<=1;var U=function(t,n,u){if(!t){O()}var d=L({controller:e,contexts:u,applicationController:D.oApplicationController,operationGrouping:x});d.call(v,P,p.isDraftEnabled(),S,t,c).then(function(e){var t={};t.actionLabel=P;A.setBusy(e.executionPromise,null,t);e.executionPromise.then(E,E)},R);var E=function(e){var t=Array.isArray(e)?e:[e];var r=h(t);var a=t.map(function(e){var t=e.error||e.response;if(t){t.actionContext=e.actionContext}return t});c=t[0].userEnteredAdditionalParams;var l=I(r,a,n);o=o.concat(m(l.mFailed));i=i.concat(m(l.mSuccess));f=Object.keys(l.mWarning);s=m(l.mWarning);w(l.aMessagesForUserDecision,b.bind(null,t))};var b=function(e){var t=o.concat(i.concat(s));if(t.length>1){var n=s.length>0;var c=o.concat(s);var u=t.length;var f=c.length;if(f>0){var v;if(u===f){v=y.getText("ST_GENERIC_NOT_PROCESSED_RECORDS_PLURAL")}else{v=y.getText("ST_GENERIC_NOT_PROCESSED_RECORDS",[f,u])}if(n){v=v+"\n";if(f===1){v=v+y.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_SINGULAR")}else{v=v+y.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_PLURAL")}}A.getUnbusy().then(function(){if(o.length>1){g.error(v)}else{g.warning(v)}})}}var E,m;l=l||d.getExecutedSuccessfully();if(l){var h;if(i.length===1&&s.length===0&&o.length===0){E=i[0];h=e[0].actionContext}m=E&&E.context;var b;if(m&&m.getObject()){b=D.oApplication.registerContext(m)}if(m&&m!==h&&m.getPath()!=="/undefined"){D.oApplication.navigateToDetailContextIfPossible(m,false,b.bIsDraft?2*(1+b.bIsCreate):1,b)}var T=C&&C.getBindingInfo();var M=T&&T.binding;if(M&&M.oEntityType){C.setEnabledToolbarButtons();if(p.getViewLevel()===0){C.setEnabledFooterButtons()}}r(t)}else{O();a(t)}}};U(true,_,d)}function k(e,t){var n=new Promise(function(n,r){D.oApplication.performAfterSideEffectExecution(V.bind(null,e,t,n,r))});return n}function q(t,n){if(!t){throw new c(C,"Unknown Table")}var o="";var s="";var l;var u=e.getOwnerComponent();var g=u.getAppComponent();if(u.getMetadata().getName()==="sap.suite.ui.generic.template.ListReport.Component"){l=u.getCreationEntitySet&&u.getCreationEntitySet()||t.getEntitySet&&t.getEntitySet()}else{l=u.getCreationEntitySet&&u.getCreationEntitySet()||u.getEntitySet()}var v=e.getView();var d=v.getModel();var E=v.getBindingContext();if(E){s=D.oPresentationControlHandlerFactory.getPresentationControlHandler(y.getOwnerPresentationControl(t)).getBindingInfo().path;var m=d.getMetaModel();var h=m.getODataEntitySet(l);var A=m.getODataEntityType(h.entityType);var T=m.getODataAssociationSetEnd(A,s);if(T){l=T.entitySet}s="/"+s;o=u.getComponentContainer().getElementBinding().getPath()+s}else{o="/"+l}return new Promise(function(t,s){var c=function(e){var t=D.oApplication.getBusyHelper();t.setBusy(e);D.oApplication.setNextFocus(Function.prototype)};var u=i.getInfoForContentIdPromise(l,d,g.getId());c(u);u.then(function(i){var u=p.getSettings();var g=i.contentIdRequestPossible?i.parametersForContentIdRequest.sRootExpand:null;var v={sRootExpand:g,oController:e,oApplicationController:D.oApplicationController,bUseNewActionForCreate:u&&u.useNewActionForCreate,fnSetBusy:c};var C=a.create(D.oDraftController,l,o,d,D.oApplication,n,v,y);C.catch(b.bind(null,r.operations.addEntry,function(e){s();if(e){throw e}}));C.then(function(e){D.oApplication.markCurrentDraftAsModified();var n=p.getCurrentKeys();n.push(f.analyseContext(e).key);var r=n.length-1;D.oApplication.registerContext(e,r,l,n);t(e)});p.preloadComponent(l)})})}var b=o.testable(b,"handleError");var L=o.testable(L,"getActionUtil");return{editEntity:S,deleteEntity:R,deleteEntities:w,saveEntity:j,activateDraftEntity:G,discardDraft:_,callAction:k,addEntry:q,updateMultipleEntities:U,getDefaultValues:W}}return e.extend("sap.suite.ui.generic.template.lib.CRUDManager",{constructor:function(e,t,n,r,a){s(this,D(e,t,n,r,a))}})});
//# sourceMappingURL=CRUDManager.js.map
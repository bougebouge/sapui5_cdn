sap.ui.define(["sap/ui/base/Object","sap/base/util/each","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper"],function(t,e,o,n){"use strict";function r(t){var r={};var a=[];var i=Object.create(null);function f(e){var o=t.oAppComponent.getTransactionController().getDraftController();var n=o.getDraftContext();var r=e.getObject();var a=n.hasDraft(e);var i=a&&!r.IsActiveEntity;var f=i&&!r.HasActiveEntity;var s=false;var l=r.HasDraftEntity?e.getObject("DraftAdministrativeData/DraftIsCreatedByMe"):false;if(r.DraftEntityCreationDateTime&&r.DraftEntityLastChangeDateTime){s=r.DraftEntityCreationDateTime.getTime()!==r.DraftEntityLastChangeDateTime.getTime()}return{bIsDraft:i,bIsDraftSupported:a,bIsCreate:f,bIsDraftModified:s,bOwnDraftExists:l}}function s(e,n,s,l){var c=e.getPath();var u=f(e);if(n===1&&!u.bIsCreate){a.push(c)}var v=o(r[c]||{},{oContextInfo:u,oContext:e});r[c]=v;if(u.bIsDraft&&!u.bIsCreate){v.bReplaceByActive=false}else if(u.bOwnDraftExists&&!u.bIsCreate){if(v.oEditingPromise){v.oEditingPromise.then(function(t){var e=t.context.getPath();r[e].bReplaceByActive=true})}else{h(e).then(function(t){var e=t.getPath();var o=r[e];if(o){r[e].bReplaceByActive=true}})}}var x=null;var C;if(u.bIsDraftSupported&&!u.bIsCreate&&s){var d=t.mEntityTree[s];if(d&&!d.noOData){if(l){if(u.bIsDraft){var I=[];var P=t.oApplicationProxy.fillSiblingKeyPromise(d,l,I);P.then(function(t){var e=t.getPath(3,I);if(!r[e]){r[e]={oContextInfo:{bIsDraft:false,bIsDraftSupported:true,bIsCreate:false,bIsDraftModified:false,bOwnDraftExists:true},aKeysFromIdentity:I}}})}if(d&&!d.noOData){var m=t.oApplicationProxy.getAncestralNode(d,1);var g=i[m.entitySet];if(!g){g={treeNode:m,draftRoots:Object.create(null)};i[m.entitySet]=g}var p=l[1];C=g[p];if(!C){C={treeNode:m,key:p,childContexts:Object.create(null)};g[p]=C}}}var b=e.getModel();var y=b.getMetaModel();var D=y.getODataEntitySet(s);var S=y.getODataEntityType(D.entityType);var A=S["com.sap.vocabularies.Common.v1.SemanticKey"];if(A){x=[];for(var E=0;E<A.length;E++){x.push(e.getProperty(A[E].PropertyPath))}}}}if(x){v.aSemanticKeysValues=x}if(l){v.aKeysFromIdentity=l}if(C){v.oRootContextInfo=C;C.childContexts[c]=v}if(u.bIsDraftSupported&&v.oRootContextInfo){for(var R in v.oRootContextInfo.childContexts){var M=v.oRootContextInfo.childContexts[R];delete M.oRemovalPromise}}return u}function l(){for(var t=a.length-1;t>=0;t--){var e=r[a[t]].oContext;if(e){return a[t]}}}function c(t){var e=t.getPath();var o=r[e];return o}function u(t){var e=c(t);return!!(e&&(e.oContext||e.oRemovalPromise))}function v(t,e,o,n){if(!t.oContextInfo.bIsCreate||!o){if(n){t.oRemovalPromise=e.then(function(t){return t.context})}else{t.oRemovalPromise=t.oSiblingPromise||t.oContext&&h(t.oContext)}}e.then(function(){t.oContext=null},function(){delete t.oRemovalPromise})}function x(e,o,n,a){var i=c(e);var f=[];if(a==="deleteAction"&&!i.oContextInfo.bIsCreate){i.oRemovalPromise=o.then(function(t){i.oContext=null;return t.context},function(){delete i.oRemovalPromise})}else if(i.oRootContextInfo){for(var s in i.oRootContextInfo.childContexts){var l=i.oRootContextInfo.childContexts[s];if(l.oContextInfo.bIsDraftSupported){v(l,o,n,i===l);if(i.oContext){f.push(i.oContext.getPath())}}}}else{v(i,o,n,true)}var u=e.getModel();o.then(function(o){if(!i.oContextInfo.bIsCreate||!n){var a=o.context.getPath();var s=r[a];if(s){delete s.oEditingPromise;I(s,false)}}t.oBusyHelper.getUnbusy().then(function(){u.invalidateEntry(e);if(f.length>0){var t=u.mContexts;var o=function(t,e){return t.startsWith(e)};for(var n in t){var r=t[n];if(r!==e){var a=r.sDeepPath;var s=a&&f.some(o.bind(null,a));if(s){u.invalidateEntry(r)}}}}delete i.oRootContextInfo})})}function C(t,e){x(t,e,false)}function d(t,e,o,n){x(t,e,true,o);if(n){var a=n.getModel();var i="/"+a.getKey(n);var f=r[i];if(f){a.read(i,{urlParameters:{$expand:"DraftAdministrativeData,SiblingEntity"},groupId:"Changes"})}}}function I(t,o){if(t.oRootContextInfo){e(t.oRootContextInfo.childContexts,function(){this.oContextInfo.bOwnDraftExists=o})}else{t.oContextInfo.bOwnDraftExists=o}}function P(t,e){var o=c(t);o.oEditingPromise=new Promise(function(n,a){var i=function(){delete o.oEditingPromise;I(o,false);a()};e.then(function(e){if(e.draftAdministrativeData){i()}else{I(o,true);var a=e.context.getPath();r[a]={sActiveContextPath:t.getPath(),oContext:e.context,oContextInfo:{bIsDraft:true,bIsDraftSupported:true,bIsCreate:false,bIsDraftModified:false,bOwnDraftExists:false}};n(e)}},i)});o.oEditingPromise.catch(Function.prototype)}function m(t){var e=r[t];if(e){e.oContext=null}}function g(t,e,o){return new Promise(function(n,r){t.read(e+"/SiblingEntity",{success:function(e){if(e){var o="/"+t.getKey(e);var a=t.getContext(o);n(a)}else{r()}},error:function(t){r(t)},groupId:o})})}function h(t,e){var o=c(t);if(o.oContextInfo.bIsCreate){return Promise.resolve()}else if(o.sActiveContextPath){var n=r[o.sActiveContextPath];return Promise.resolve(n.oContext)}var a=o.oSiblingPromise;if(!a){if(o.oContextInfo.bIsDraftSupported&&o.oEditingPromise){a=o.oEditingPromise.then(function(e){var o=e.context.getPath();var n=o&&r[o];if(n&&!n.oRemovalPromise){return Promise.resolve(e.context)}else{return g(t.getModel(),t.getPath())}})}else{a=o.oContextInfo.bIsDraftSupported?g(t.getModel(),t.getPath(),e):Promise.resolve(t);if(o.oContextInfo.bIsDraft||!o.oContextInfo.bIsDraftSupported){o.oSiblingPromise=a}}}return a}function p(e,o){var a=r[e];if(a&&a.oSiblingPromise){return a.oSiblingPromise}else if(a&&a.sActiveContextPath){var i=r[a.sActiveContextPath];return Promise.resolve(i.oContext)}else{var s=a&&a.oContext?h(a.oContext,o):g(t.oAppComponent.getModel(),e,o);s.then(function(o){if(o){var i=n.analyseContext(o).canonicalPath;if(!r[i]){r[i]={oContextInfo:f(o),oContext:o}}}var s=a&&a.oContext;if(!s){var l=t.oAppComponent.getModel();s=l.createBindingContext(e);if(s){a=a||{};a.oContext=s;a.oContextInfo=f(s);r[e]=a}}if(s&&o&&a.oContextInfo.bIsDraftSupported){var c=a.oContextInfo.bIsDraft?e:i;var u=a.oContextInfo.bIsDraft?i:e;r[c].sActiveContextPath=u}});return s}}function b(e){if(e.treeNode.level===0){return Promise.resolve()}var o=t.oApplicationProxy.getAncestralNode(e.treeNode,1);if(o.noOData||!o.isDraft){return Promise.resolve()}var r=o.getPath(3,e.keys.slice(0,2));return y(r).then(function(o){if(!o){return null}var r=o.iDisplayMode||1;var a=false;var i=o.context?["",n.analyseContext(o.context).key]:[""];var f=function(o){if(!a&&r===2){r=o.isDraft?6:1}var n={treeNode:o,keys:i};var f={identity:n,displayMode:r};return t.oNavigationControllerProxy.adaptAppStates(e,n).then(function(){return f})};if(!o.context){return f(t.mRoutingTree.root)}var s=function(o){if(o===e.treeNode){return f(o)}var l=t.oApplicationProxy.getAncestralNode(e.treeNode,o.level+1);var c=e.keys.slice(0,l.level+1);var u=l.getPath(3,c);return y(u).then(function(t){if(!t||!t.context){return f(o)}i.push(n.analyseContext(t.context).key);r=t.iDisplayMode;a=true;return s(l)})};return t.oApplicationProxy.fillSiblingKeyPromise(e.treeNode,e.keys,i).then(s)})}function y(t){var e=r[t];if(!e){return Promise.resolve()}if(!e.oContext&&!e.oRemovalPromise){return Promise.resolve({})}return new Promise(function(t){var o=null;var n=function(){t(o)};var a=function(t){t.then(function(t){var e=t.context.getPath();var a=r[e];if(a&&a.oContext&&!a.bReplaceByActive){o={context:t.context,iDisplayMode:2}}n()},n)};if(e.oRemovalPromise){e.oRemovalPromise.then(function(t){o={context:t,iDisplayMode:1};var e=t.getPath();var i=r[e];var f=i&&i.oEditingPromise;if(f){a(f)}else{n()}},n)}else if(e.bReplaceByActive){h(e.oContext).then(function(t){o={context:t,iDisplayMode:1};n()})}else if(!e.oContextInfo.bIsDraft&&e.oContextInfo.bOwnDraftExists){if(e.oEditingPromise){a(e.oEditingPromise)}else if(e.oContext){h(e.oContext).then(function(t){var e=t.getPath();var a=r[e];if(!a||!a.bReplaceByActive){o={context:t,iDisplayMode:2}}n()})}else{n()}}else{n()}})}function D(t){var e=c(t);return e&&e.aKeysFromIdentity}function S(e,o,a,i,l){return new Promise(function(c,u){var v=t.oAppComponent.getModel();var x=e&&n.analyseContextPath(e,v).canonicalPath;var C=o&&n.analyseContextPath(o,v).canonicalPath;if(x===C){c(true);return}if(!x||!C){c(false);return}var d=r[x];if(!d||!d.oContextInfo.bIsDraftSupported){c(false);return}var I=r[C];var P,m;if((!d||!d.oContext)&&(I&&!I.oContextInfo.bIsDraft)){var g=function(t){return t};d=g(I,I=d);x=g(C,C=x);i=g(l,l=i)}function p(t,e){if(!t||!e){c(false);return}if(!t.oContextInfo.bIsDraft&&!e.oContextInfo.bIsDraft){c(false);return}if(t.oContextInfo.bIsCreate&&e.oContextInfo.bIsCreate){c(false);return}if(a){y(x).then(function(t){c(!!(t&&t.context)&&t.context.getPath()===C)},u);return}if(t.aSemanticKeysValues){var o=!!e.aSemanticKeysValues;for(var n=0;o&&n<t.aSemanticKeysValues.length;n++){o=t.aSemanticKeysValues[n]===e.aSemanticKeysValues[n]}c(o);return}c(false)}if(d.oContext&&!d.oContextInfo.bIsDraft&&(!I||!I.oContext)){if(I&&I.oRemovalPromise){I.oRemovalPromise.then(function(t){var e=n.analyseContext(t).canonicalPath;c(e===x)});return}if(i&&l&&i.treeNode.entitySet===l.treeNode.entitySet){m=l&&l.keys;var b=v.getContext(C)||v.createBindingContext(C);var D=b&&f(b);if(b&&(!D.bIsDraft||D.bIsCreate)){c(false)}else{var S=h(d.oContext);S.then(function(t){if(t.sPath&&C===t.sPath){P=t;I=r[C];if(!I||!I.oContext){s(P,l.treeNode.level,l.treeNode.entitySet,m);r[C].sActiveContextPath=d.oContext.getPath()}p(d,r[C])}else{c(false)}},function(){c(false)})}}else{c(false);return}}else{p(d,I)}})}function A(t){return r[t].oContextInfo.bIsDraftModified}function E(t){if(r[t]){r[t].oContextInfo.bIsDraftModified=true}}function R(t){if(r[t]){return r[t].oContextInfo.bIsDraft}}function M(t){if(r[t]){return r[t].oContext}}return{registerContext:s,adaptAfterObjectDeleted:m,activationStarted:C,cancellationStarted:d,editingStarted:P,getDraftSiblingPromise:h,getSiblingPromise:p,getAlternativeIdentityPromise:b,getPathOfLastShownDraftRoot:l,areTwoKnownPathesIdentical:S,markDraftAsModified:E,getIsDraftModified:A,getIdentityKeyForContext:D,checkmPath2ContextData:u,checkIfObjectIsADraftInstance:R,getContextForPath:M}}return t.extend("sap.suite.ui.generic.template.lib.ContextBookkeeping",{constructor:function(t){o(this,r(t))}})});
//# sourceMappingURL=ContextBookkeeping.js.map
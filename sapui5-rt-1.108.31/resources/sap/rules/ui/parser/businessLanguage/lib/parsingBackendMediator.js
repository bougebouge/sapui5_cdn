sap.ui.define(["sap/rules/ui/parser/businessLanguage/lib/constants","sap/rules/ui/parser/resources/dependencies/lib/constantsBase","sap/rules/ui/parser/businessLanguage/lib/parseModel","sap/rules/ui/parser/businessLanguage/lib/parseUtils","sap/rules/ui/parser/resources/vocabulary/lib/parameterRuntimeServices","sap/rules/ui/parser/businessLanguage/lib/IDPLexer","sap/rules/ui/parser/businessLanguage/lib/IDPParser","sap/rules/ui/parser/businessLanguage/lib/autoCompleteUtils","sap/rules/ui/parser/businessLanguage/lib/parserTokens","sap/rules/ui/parser/businessLanguage/lib/antlr3_all_min","sap/rules/ui/parser/resources/vocabulary/lib/vocabularyDataProviderFactory","sap/rules/ui/parser/businessLanguage/lib/conversionUtils","sap/rules/ui/parser/businessLanguage/lib/valueHelpValidator"],function(e,r,t,n,s,a,o,u,i,p,l,E,c){"use strict";var d=new n.parseUtilsLib;var g=new t.parseModelLib;var v=new u.autoCompleteUtilsLib;var m=new l.vocaDataProviderFactoryLib;var y=new E.conversionUtilsLib;function f(){}f.prototype.getRELType=function r(t,n){var s;s=t===undefined||t===null?e.TYPE_ALL:t;if(n!==null&&n!==undefined&&n[e.propertiesEnum.isCollection]===true){s=d.getCollectionRelTypeFromBusinessDT(s)}return s};f.prototype.parseExpression=function(r,t,n,s,u,i,l,E){function m(r,t){var n="";var s=t&&t.hasOwnProperty(e.propertiesEnum.locale);var a=t&&t.hasOwnProperty(e.propertiesEnum.locale)&&t[e.propertiesEnum.locale].hasOwnProperty(e.propertiesEnum.convert)&&t[e.propertiesEnum.locale][e.propertiesEnum.convert].hasOwnProperty(e.propertiesEnum.source)&&t[e.propertiesEnum.locale][e.propertiesEnum.convert].hasOwnProperty(e.propertiesEnum.target)&&t[e.propertiesEnum.locale][e.propertiesEnum.convert][e.propertiesEnum.source]===e.CODE_TEXT&&t[e.propertiesEnum.locale][e.propertiesEnum.convert][e.propertiesEnum.target]===e.DISPLAY_TEXT;if(!s||a){var o=false;var u=false;var i="";var p="";if(typeof r!=="string"){n=r}else{for(p in r){if(r.hasOwnProperty(p)){if(!r[p]){continue}u=false;switch(r[p]){case"'":o=!o;break;case",":if(o===false){u=true}break}if(u===true){i+=";"}else{i+=r[p]}}}n=i}}else{n=r}return n}try{jQuery.sap.log.debug("ParsingBackendMediator expression to parse: "+r);var f=g.createModelManger();f.vocaRTServ=n;f.vocabulary=i;f.mode=t;f.paramServ=s;f.flags=l===undefined||l===null?{}:l;u=this.getRELType(u,l);r=m(r,l);var T=r;if(r!==null&&r!==undefined){r=r.toString();r=r.replace(/(\r\n|\n|\r)/gm," ");r=r.replace(/\\/g,"\\\\")}if(r===null||r===undefined||d.isBlank(r)){var O={};O.status=e.statusEnum.SUCCESS;if(t===e.TOKEN_TYPES||f.flags.hasOwnProperty(e.propertiesEnum.tokens)&&f.flags[e.propertiesEnum.tokens]===true){O.tokens=[];if(r!==null&&r!==undefined){var P=T.length;var b=new d.TokenInfo(T,e.tokenTypesEnum.whitespace,null,0,P);O.tokens.push(b)}}if(t===e.VALIDATE_MODE||t===e.PARSE_MODE){O.errorDetails=null;O.model=null;O.cursorPosition=null;O.actualReturnType=e.TYPE_ALL;if(f.flags.hasOwnProperty(e.propertiesEnum.conversionOutput)&&(f.flags[e.propertiesEnum.conversionOutput]===e.conversionOutputEnum.toKeys||f.flags[e.propertiesEnum.conversionOutput]===e.conversionOutputEnum.toDescriptions)||l&&l.hasOwnProperty(e.propertiesEnum.locale)&&l[e.propertiesEnum.locale].hasOwnProperty(e.propertiesEnum.convert)){O.convertedExpression=T}return O}else if(t===e.TOKEN_TYPES){return O}}f.expression=r;var R=new p.antlr.runtime.ANTLRStringStream(r);var k=new a(R);k.displayRecognitionError=function(e,r){var t=k.getErrorHeader(r);var n=k.getErrorMessage(r,e);d.handleWarning(t+" "+n)};var h=new p.antlr.runtime.CommonTokenStream(k);var D=new o(h);D.mode=t;D.displayRecognitionError=function(e,r){var t=D.getErrorHeader(r);var n=D.getErrorMessage(r,e);d.handleWarning(t+" "+n)};var w={};var M={};switch(t){case e.AUTOCOMPLETE_MODE:case e.AUTOCOMPLETE_MODE_LOWERCASE:jQuery.sap.log.debug("mode autocomplete");w.suggs=JSON.parse(v.getNextSuggestions(r,k,D,n,u,E));if(f.flags.hasOwnProperty(e.propertiesEnum.tokens)&&f.flags[e.propertiesEnum.tokens]===true){w.tokens=d.buildTokenTypes(D,T,f)}jQuery.sap.log.debug("ParsingBackendMediator: autocomplete responseObject: "+w);return w;case e.PARSE_MODE:case e.VALIDATE_MODE:jQuery.sap.log.debug("mode validate");d.parseWithValidation(k,D,u,g.getModelManger());w=g.getModelManger().parseResult.getParseResults();if(f.flags.hasOwnProperty(e.propertiesEnum.tokens)&&f.flags[e.propertiesEnum.tokens]===true){w.tokens=d.buildTokenTypes(D,T,f)}if(f.flags.hasOwnProperty(e.propertiesEnum.valueHelp)&&w.status===e.statusEnum.SUCCESS){c.handleExternalValueHelp(D,T,f,w)}if(y.needsConversion(f)){M=w.tokens||d.buildTokenTypes(D,T,f);w.convertedExpression=y.convert(n,i,f,M,T)}if(f.flags.hasOwnProperty(e.propertiesEnum.rootObjectContext)&&f.flags[e.propertiesEnum.rootObjectContext]===true){w.rootObjectContext=null;if(w.status===e.statusEnum.SUCCESS){w.rootObjectContext={};w.rootObjectContext.name=f[e.propertiesEnum.rootObjectContext].name;w.rootObjectContext.associations=f[e.propertiesEnum.rootObjectContext].assocs}}return w;case e.TOKEN_TYPES:jQuery.sap.log.debug("mode token types");d.parseWithValidation(k,D,u,g.getModelManger());w.tokens=d.buildTokenTypes(D,T,f);w.status=e.statusEnum.SUCCESS;return w;default:d.handleError("Unknown mode",null,g.getModelManger());w=g.getModelManger().parseResult.getParseResults();return w}}catch(r){g.getModelManger().parseResult.status=e.statusEnum.ERROR;jQuery.sap.log.error("ParsingBackendMediator error: "+r);return g.getModelManger().parseResult.getParseResults()}};f.prototype.convertExpressionToKeys=function(r,t,n,s,a,o){var u={};if(o){u=o}u[e.propertiesEnum.conversionOutput]=e.conversionOutputEnum.toKeys;return this.parseExpression(r,e.VALIDATE_MODE,t,n,s,a,u)};f.prototype.convertExpressionToDescriptions=function(r,t,n,s,a,o){var u={};if(o){u=o}u[e.propertiesEnum.conversionOutput]=e.conversionOutputEnum.toDescriptions;return this.parseExpression(r,e.VALIDATE_MODE,t,n,s,a,u)};f.prototype.parseInputRT=function(e,r,t,n,a,o,u){var i=null;if(n){i=new s.ParameterRuntimeServices(n,t,o)}return this.parseExpression(e,r,t,i,a,o,u)};f.prototype.parseInput=function(e,r,t,n,s,a,o){var u=null;u=m.getVocabularyDataProvider();return this.parseInputRT(e,r,u,n,s,a,o)};f.prototype.isReservedWord=function(e){var r=g.getModelManger();r.clearModelData();r.parseResult.clear();e=e.split(" ")[0];var t=new p.antlr.runtime.ANTLRStringStream(e);var n=new a(t);var s=new p.antlr.runtime.CommonTokenStream(n);var u=new o(s);var l=true;u.reportError=function(e){if(u.input.tokens.length>0&&(u.input.tokens[0].type===i.NAVIGATION||u.input.tokens[0].type===i.TYPEATTRIBUTE||u.input.tokens[0].type===i.INT||u.input.tokens[0].type===i.STRING||u.input.tokens[0].type===i.ANYCHAR||u.input.tokens[0].type===undefined||u.input.tokens[0].type===null)){l=false}};n.reportError=function(e){if(u.input.tokens.length>0&&(u.input.tokens[0].type===i.NAVIGATION||u.input.tokens[0].type===i.TYPEATTRIBUTE||u.input.tokens[0].type===i.INT||u.input.tokens[0].type===i.STRING||u.input.tokens[0].type===undefined||u.input.tokens[0].type===null)){l=false}};u.dummyRule();return l};f.prototype.validateAndGetExpressionActualReturnTypeRT=function(t,n,s,a,o,u){var i={type:null,dataObject:null,businessDataType:null,unknownTokens:{},isCollection:false,errorDetails:null,isValid:false,dependenciesOutput:{}};if(a===undefined){a=null}var p;if(u){p=u}else{p={};p[e.propertiesEnum.unknownTokens]=true;p[r.PROPERTY_NAME_DEPENDENCIES_OUTPUT]=true}if(o!==undefined&&o===false){p[e.propertiesEnum.raiseError]=false}var l=this.parseExpression(n,e.VALIDATE_MODE,t,a,e.TYPE_ALL,s,p);if(l.actualReturnType){jQuery.sap.log.debug(l.actualReturnType)}if(l.status===e.statusEnum.ERROR){i.errorDetails=l.errorDetails;i.unknownTokens=l[e.propertiesEnum.unknownTokens];return i}i.type=l.actualReturnType;i.dataObject=l.hasOwnProperty(e.attributesNamesEnum.dataObject)?l.dataObject:null;i.isValid=true;var E=d.getBusinessDTFromRelType(i.type);i.isCollection=E[e.propertiesEnum.isCollection];i.businessDataType=E[e.propertiesEnum.businessType];i.dependenciesOutput=l.hasOwnProperty(r.PROPERTY_NAME_DEPENDENCIES_OUTPUT)?l.dependenciesOutput:{};if(l.hasOwnProperty(e.propertiesEnum.convertedExpression)){i.convertedExpression=l.convertedExpression}return i};f.prototype.validateAndGetExpressionActualReturnType=function(e,r,t,n,a,o){var u=null;var i=null;u=m.getVocabularyDataProvider();if(e){if(n){i=new s.ParameterRuntimeServices(n,u,t)}}return this.validateAndGetExpressionActualReturnTypeRT(u,r,t,i,a,o)};f.prototype.validateExpression=function(e,r,t,n,s,a){var o=this.parseInput(r,n,e,a,s,t);var u={status:o.status,errorDetails:o.errorDetails};return u};f.prototype.validateAndGetExpressionModel=function(e,r,t,n,s,a){var o=this.parseInput(r,n,e,a,s,t);return o.model};f.prototype.getRELDependencies=function(t,n,s,a){var o={};o[r.PROPERTY_NAME_DEPENDENCIES_OUTPUT]=true;var u=this.parseInput(n,e.VALIDATE_MODE,t,a,e.TYPE_ALL,s,o);return u[r.PROPERTY_NAME_DEPENDENCIES_OUTPUT]};f.prototype.handleParse=function(r){if(!r.hasOwnProperty("expression")){return g.getModelManger().parseResult.getParseResults()}if(!r.hasOwnProperty("vocabulary")){r.vocabulary=null}if(!r.hasOwnProperty("mode")){r.mode=e.VALIDATE_MODE}if(!r.hasOwnProperty("returnType")){r.returnType=e.TYPE_ALL}if(!r.hasOwnProperty("parameters")){r.parameters=null}if(!r.hasOwnProperty(e.propertiesEnum.flags)){r.flags={}}return this.parseInput(r.expression,r.mode,r.connection,r.parameters,r.returnType,r.vocabulary,r.flags)};return{parsingBackendMediatorLib:f}},true);
//# sourceMappingURL=parsingBackendMediator.js.map
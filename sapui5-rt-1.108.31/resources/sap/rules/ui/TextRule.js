/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/ui/thirdparty/jquery","./library","sap/m/Label","sap/rules/ui/RuleBase","sap/m/Panel","sap/ui/core/Title","sap/ui/layout/form/Form","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/Text","sap/m/Button","sap/ui/layout/Grid","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement","sap/rules/ui/ExpressionAdvanced","sap/m/Link","sap/m/FlexBox","sap/m/Dialog","sap/rules/ui/TextRuleSettings","sap/rules/ui/oldast/lib/AstYamlConverter","sap/rules/ui/Constants","sap/rules/ui/AstExpressionBasic","sap/rules/ui/services/ExpressionLanguage","sap/rules/ui/services/AstExpressionLanguage","./TextRuleRenderer"],function(e,jQuery,t,n,s,i,a,r,o,l,u,d,p,g,c,h,f,v,x,y,T,R,b,_,C,I){"use strict";var E=s.extend("sap.rules.ui.TextRule",{metadata:{properties:{enableSettings:{type:"boolean",group:"Misc",defaultValue:false},enableSettingResult:{type:"boolean",defaultValue:true},enableElse:{type:"boolean",defaultValue:true},enableElseIf:{type:"boolean",defaultValue:true}},aggregations:{_toolbar:{type:"sap.m.Toolbar",multiple:false,singularName:"_toolbar"},_verticalLayout:{type:"sap.ui.core.Control",multiple:false,visibility:"visible",singularName:"_verticalLayout"}}},_addConditionBlock:function(t,n){var s=this;var a=this._getModel();var r=t.getSource();var o=r.getParent();if(n===this.typeElseIf&&!(o instanceof i)){o=r.getParent().getParent()}var l=o.getParent();var u=l.indexOfContent(o);var d=this._internalModel.getProperty("/ruleId");var p=this._internalModel.getProperty("/ruleVersion");var g=u+1;var c=false;var h;var f;var v={RuleId:d,RuleVersion:p};if(n===s.typeElse){f="/TextRuleDefaultBranches";c=true}else{f="/TextRuleBranches";if(r.getParent()instanceof i){h=g;c=true}else{h=g+1}v.Sequence=h}this._updateBusyState(true);var x={};x.properties=v;x.success=function(e){var t={};t.verticalLayout=l;t.nIndex=u;t.bfirst=c;s._addConditionSuccess(e,s,t);if(c){r.destroy()}};x.error=function(){e.info("Error creating "+f+"entity")};a.createEntry(f,x)},_addConditionSuccess:function(t,n,s){var i;var a;var r=t.Id;var o=n._getModel();var l={RuleId:t.RuleId,Id:r,RuleVersion:t.RuleVersion};var u=o.createKey("/TextRuleConditions",l);var d=new sap.ui.model.Context(o,u);var p="TextRuleResultExpressions";if(this.getAstExpressionLanguage()){p="TextRuleResultExpressions/TextRuleResultExpressionASTs,TextRuleConditionASTs"}o.read(u,{urlParameters:{$expand:p},success:function(e){var t=s.verticalLayout;n.getModel("displayModel").getProperty("/textRuleConditions").push(e);n.getModel("displayModel").setProperty("/bCancelButtonVisible("+e.Id+")",e.TextRuleResultExpressions.results.length>1);if(e.Type===n.typeElse){n.getModel("displayModel").getProperty("/textRuleConditions/Else").push(e);var r=n._createElseFormLayout(d,n.oBundle.getText("titleElse"),true);t.removeContent(s.nIndex);t.insertContent(r,s.nIndex)}else if(e.Type===n.typeElseIf){n.getModel("displayModel").getProperty("/textRuleConditions/ElseIf").push(e);if(s.bfirst){a=s.nIndex;t.removeContent(s.nIndex)}else{a=s.nIndex+1}i=" ("+a+")";var o=n._createFormLayout(d,n.oBundle.getText("titleElseIf")+i,true);t.insertContent(o,a);n._adjustElseIfTitle(s.verticalLayout,a,true)}n._updateBusyState(false);sap.m.MessageToast.show(n.oBundle.getText("branchCreatedSuccess"))},error:function(){e.info("Error reading TextRuleResultExpressions")}})},_adjustElseIfTitle:function(e,t,n){var s=e.getContent();var i=this.oBundle.getText("titleElseIf");var a;if(n){a=t+1}else{a=t}for(;a<s.length;a++){var r=s[a];if(r.getHeaderText().indexOf(i)>-1&&r.getHeaderToolbar()){r.getHeaderToolbar().getContent()[0].setText(i+" ("+a+")")}}},_addToolBar:function(){var e=new o({design:"Transparent",enabled:"{TextRuleModel>/editable}"});var t=new sap.m.Title({text:this.oBundle.getText("textRule")});var n=new d({text:"",press:this._openTextRuleSettings.bind(this),visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},enabled:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement}}).setTooltip(this.oBundle.getText("settings"));n.setIcon("sap-icon://action-settings");e.addContent(t);e.addContent(new l({}));e.addContent(n);e.addContent(new l({width:"1em"}));this.setAggregation("_toolbar",e,true)},_addTextRuleControl:function(){this.verticalLayout=new sap.ui.layout.VerticalLayout({width:"100%"});this.setAggregation("_verticalLayout",this.verticalLayout,true)},_bindRule:function(){var t=this;var n=this._getModel();var s=[this._getBindModelName(),this.getBindingContextPath()].join("");if(s&&n){n.setDeferredGroups(["read"]);n.read(s,{groupId:"read",urlParameters:{$expand:"TextRule"}});var i=[s,"/TextRule/TextRuleResults"].join("");var a={groupId:"read"};if(this.getAstExpressionLanguage()){a.urlParameters={$expand:"TextRuleResultASTs"}}n.read(i,a);var r="TextRuleResultExpressions";if(this.getAstExpressionLanguage()){r="TextRuleResultExpressions/TextRuleResultExpressionASTs,TextRuleConditionASTs"}i=[s,"/TextRule/TextRuleConditions"].join("");n.read(i,{groupId:"read",urlParameters:{$expand:r}});n.submitChanges({groupId:"read",success:function(e){t._handleVerticalLayoutDataReceived(e)},error:function(){e.info("Error reading TextRule data from backend")}})}},_bindVerticalLayout:function(){var e=this._getIfPanel();this.verticalLayout.addContent(e);if(this.getEnableElseIf()===true){var t=this._getElseIfPanel();for(var n=0;n<t.length;n++){this.verticalLayout.addContent(t[n])}}if(this.getEnableElse()===true){var s=this._getElsePanel();this.verticalLayout.addContent(s[0])}},_createFormLayout:function(e,t,n){var s=this;var a=new o({design:"Transparent"});var u=new sap.m.Title({text:t});a.addContent(u);var p=new i({expandable:true,expanded:n,height:"100%",backgroundDesign:"Translucent",content:[new r({editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout({labelSpanXL:2,labelSpanL:2,labelSpanM:2,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:4,emptySpanL:4,emptySpanM:4,emptySpanS:4,columnsL:1,columnsM:1}),formContainers:[s._createIfBlockFormContainer(e,t)]}),new r({editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout({labelSpanXL:2,labelSpanL:2,labelSpanM:2,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:3,emptySpanL:3,emptySpanM:3,emptySpanS:3,columnsL:1,columnsM:1}),formContainers:[s._createThenFormContainer(e,this.oBundle.getText("then"))]})]}).addStyleClass("sapTextRulePanel");if(t!==this.typeIf){var g=new d({visible:"{TextRuleModel>/editable}",text:this.oBundle.getText("addButton"),tooltip:this.oBundle.getText("addNewElseIf"),press:function(e){s._addConditionBlock(e,s.typeElseIf)}}).setBindingContext(e);var c=new d({text:this.oBundle.getText("deleteButton"),tooltip:this.oBundle.getText("deleteElseIf"),visible:"{TextRuleModel>/editable}",press:function(e){s._deleteConditionBlock(e)}}).setBindingContext(e);a.addContent(new l);a.addContent(g);a.addContent(new l({width:"0.5px"}));a.addContent(c)}p.setHeaderToolbar(a);return p},_createElseFormLayout:function(e,t,n){var s=this;var a=new o({design:"Transparent"});var u=new sap.m.Title({text:t});var p=new d({text:this.oBundle.getText("deleteButton"),tooltip:this.oBundle.getText("deleteElse"),visible:"{TextRuleModel>/editable}",press:function(e){s._deleteConditionBlock(e)}}).setBindingContext(e);a.addContent(u);a.addContent(new l);a.addContent(p);var g=new i({expandable:true,expanded:n,height:"100%",backgroundDesign:"Translucent",content:new r({editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout({labelSpanXL:2,labelSpanL:2,labelSpanM:2,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:3,emptySpanL:3,emptySpanM:3,emptySpanS:3,columnsL:1,columnsM:1}),formContainers:[this._createThenFormContainer(e,t)]})}).addStyleClass("sapTextRulePanel");g.setHeaderToolbar(a);return g},_createIfBlockFormContainer:function(e,t){var s=e?e.getProperty("Expression"):"";var i=true;var a=new g({formElements:[new c({label:new n({text:""}),fields:[this._getExpressionAdvancedText(e,s,undefined,undefined,i)]})]});return a},_createThenFormContainer:function(e,t){var s=new g({visible:false});if(e.getProperty("Type")!==this.typeElse){var i=new o({content:[new l({width:"2em"}),new n({text:t}).addStyleClass("sapTextRuleFontSize")]});s.setToolbar(i)}var a=e.getProperty("Id");var r=this.getModel("displayModel").getProperty("/textRuleConditions");for(var u=0;u<r.length;u++){if(a===r[u].Id){var d=r[u].TextRuleResultExpressions.results;if(d){for(var p=0;p<d.length;p++){var c={RuleId:d[p].RuleId,ConditionId:d[p].ConditionId,ResultId:d[p].ResultId,RuleVersion:d[p].RuleVersion};var h=this._getModel().createKey("/TextRuleResultExpressions",c);var f=new sap.ui.model.Context(this._getModel(),h);var v=d[p].BusinessDataType;if(this.getExpressionLanguage()){if(v===R.DATE_BUSINESS_TYPE||v===R.TIMESTAMP_BUSINESS_TYPE||v===R.NUMBER||v===R.STRING||v===R.BOOLEAN_BUSINESS_TYPE||v===R.BOOLEAN_ENHANCED_BUSINESS_TYPE){s.addFormElement(this._formElementsFactory(t+"result"+p,f))}}else{s.addFormElement(this._formElementsFactory(t+"result"+p,f))}}}}}var x=s.getFormElements();for(var y in x){if(x[y].getVisible()){s.setVisible(true);break}}return s},_createTextRuleSettings:function(){var e=this._getModel();var t=this.getBindingContext();var n=new y({newTextRule:this._internalModel.getProperty("/newTextRule"),enableSettingResult:this.getEnableSettingResult()});if(this.getAstExpressionLanguage()){n.setAstExpressionLanguage(this.getAstExpressionLanguage())}else{n.setExpressionLanguage(this.getExpressionLanguage())}var s=JSON.stringify(this._settingsModel.getData());var i=JSON.parse(s);var a=new sap.ui.model.json.JSONModel(i);n.setModel(a);n.setModel(this._internalModel,"TextRuleModel");n.setModel(e,"oDataModel");n.setBindingContext(t,"dummy");return n},_decideSettingsEnablement:function(e,t){return e&&t},_deleteConditionBlock:function(t){var n=this;var s=this._getModel();var i=t.getSource();var a=i.getParent().getParent();var r=a.getParent();var o=r.indexOfContent(a);var l=i.getBindingContext();var u=l.getProperty("Id");var d=l.getProperty("Type");var p;if(d===n.typeElse){p="/TextRuleDefaultBranches"}else if(d===n.typeElseIf){p="/TextRuleBranches"}var g={RuleId:l.getProperty("RuleId"),Id:u,RuleVersion:l.getProperty("RuleVersion")};var c=s.createKey(p,g);var h=function(){var e;r.removeContent(o);if(d===n.typeElse){n.getModel("displayModel").setProperty("/textRuleConditions/Else",[]);e=n._getElsePanel();r.insertContent(e[0],o)}else{if(o===1&&r.getContent().length<=2){n.getModel("displayModel").setProperty("/textRuleConditions/ElseIf",[]);e=n._getElseIfPanel();r.insertContent(e[0],o)}else{var t=n.getModel("displayModel").getProperty("/textRuleConditions/ElseIf");for(var s in t){if(t[s].Id===u){t.splice(s,1);n.getModel("displayModel").setProperty("/textRuleConditions/ElseIf",t);break}}}n._adjustElseIfTitle(r,o,false)}n._updateBusyState(false);sap.m.MessageToast.show(n.oBundle.getText("branchDeletedSuccess"))};this._updateBusyState(true);s.remove(c,{success:function(e){h()},error:function(){e.info("Error deleting "+p+"entity")}})},_formRuleData:function(e,t){var n=this.getBindingContextPath();var s=n.split("/")[2];var i=e.getProperty("RuleId");var a=e.getProperty("Version");var r=jQuery.extend({},this.getModel().oData);r=r[s];if(!r){r={}}if(!r.DecisionTable){r.DecisionTable={}}r.Type="DT";r.DecisionTable.metadata={};r.DecisionTable.RuleID=i;r.DecisionTable.version=a;r.DecisionTable.HitPolicy="FM";r.DecisionTable.DecisionTableColumns={};r.DecisionTable.DecisionTableColumns.results=[];r.DecisionTable.DecisionTableColumns.results.push({metadata:{},RuleId:i,Id:1,Version:a,Sequence:1,Type:"CONDITION",Condition:{metadata:{},RuleId:i,Id:1,Version:a,Expression:t,Description:null,ValueOnly:false,FixedOperator:null},Result:null});r.DecisionTable.DecisionTableRows={};r.DecisionTable.DecisionTableRows.results=[];r.DecisionTable.DecisionTableColumnsCondition={};r.DecisionTable.DecisionTableColumnsCondition.results=[];r.DecisionTable.DecisionTableColumnsResult={};r.DecisionTable.DecisionTableColumnsResult.results=[];return r},_addTextRuleResultExpression:function(t){var n=this;var s=this._getModel();var i=t.getSource();var a=i.getParent();var r=a.getParent();var o=r.getParent().indexOfFormElement(r)+1;var l=this._internalModel.getProperty("/ruleId");var u=this._internalModel.getProperty("/ruleVersion");var d=o+1;var p=null;if(t&&t.oSource&&t.oSource.getBindingContext()&&t.oSource.getBindingContext().getModel()&&t.oSource.getBindingContext().getPath()&&t.oSource.getBindingContext().getModel().getProperty(t.oSource.getBindingContext().getPath())){p=t.oSource.getBindingContext().getModel().getProperty(t.oSource.getBindingContext().getPath()).ConditionId}var g="/TextRuleResultExpressions";var c={RuleId:l,RuleVersion:u,ConditionId:p,Sequence:d};var h={};h.properties=c;h.success=function(e){var t={RuleId:e.RuleId,ConditionId:e.ConditionId,ResultId:e.ResultId,RuleVersion:e.RuleVersion};var s=n._getModel().createKey("/TextRuleResultExpressions",t);var i=new sap.ui.model.Context(n._getModel(),s);var a=n.getModel("displayModel").getProperty("/textRuleConditions");for(var l=0;l<a.length;l++){if(p===a[l].Id&&a[l].TextRuleResultExpressions){var u=a[l].TextRuleResultExpressions.results;if(u&&i){u.push(i.getModel().getProperty(i.getPath()));n.getModel("displayModel").setProperty("/bCancelButtonVisible("+p+")",u.length>1)}r.getParent().insertFormElement(n._formElementsFactory(n.oBundle.getText("then")+"result"+o,i),o);break}}};h.error=function(){e.info(n.oBundle.getText("errorCreating")+g+n.oBundle.getText("entity"))};s.createEntry(g,h)},_deleteTextRuleResultExpression:function(t){var n=this;var s=this._getModel();var i=t.getSource();var a=i.getParent();var r=a.getParent();var o=r.getParent().indexOfFormElement(r);var l=this._internalModel.getProperty("/ruleId");var u=this._internalModel.getProperty("/ruleVersion");var d=i.getBindingContext();var p=d.getProperty("ConditionId");var g=d.getProperty("ResultId");var c="/TextRuleResultExpressions";var h={RuleId:l,RuleVersion:u,ConditionId:p,ResultId:g};var f=s.createKey(c,h);s.remove(f,{success:function(e){var t=n.getModel("displayModel").getProperty("/textRuleConditions");for(var s=0;s<t.length;s++){if(p===t[s].Id&&t[s].TextRuleResultExpressions){var i=t[s].TextRuleResultExpressions.results;if(i){for(var a in i){if(i[a].ResultId===g){i.splice(a,1)}}}n.getModel("displayModel").setProperty("/bCancelButtonVisible("+p+")",i.length>1);r.getParent().removeFormElement(o);break}}},error:function(){e.info(n.oBundle.getText("errorDeleting")+sKeytext+n.oBundle.getText("entity"))}})},_decideCancelButtonEnablement:function(e,t,n){return e&&!t&&n==="2.0"?true:false},_formElementsFactory:function(e,t){var s=this;var i=t.getProperty("ResultId"),a=t.getProperty("RuleId"),r=t.getProperty("RuleVersion"),o=t.getProperty("ConditionId"),l=true;var u={RuleId:a,Id:i,RuleVersion:r};if(this.getAstExpressionLanguage()){this._internalModel.setProperty("/expressionLanguageVersion","2.0")}else{this._internalModel.setProperty("/expressionLanguageVersion","1.0")}var d=t.getProperty("Expression");var p=t.getModel().createKey("/TextRuleResults",u);this._internalModel.getProperty("/textRuleResultExpressions").push(t.getModel().getProperty(t.getPath()));var g=t.getModel().getProperty(p+"/BusinessDataType");var h=t.getModel().getProperty(p+"/DataObjectAttributeName");var f=t.getModel().getProperty(p+"/DataObjectAttributeLabel");var v=f?f:h;var x=t.getModel().getProperty(p+"/AccessMode");var y=t.getModel().getProperty(p+"/DataObjectAttributeId");if(x===R.EDITABLE){l=true}else if(x===R.HIDDEN){l=false}var T=new n({text:v,tooltip:v,labelFor:_});var b=this._getExpressionAdvancedText(t,d,g,y,false,T.getId());var _=b.getId();var C=new c({visible:l,label:T,fields:[b,new sap.ui.layout.HorizontalLayout({layoutData:new sap.ui.layout.GridData({span:"L1 M1 S1"}),content:[new sap.m.Button({enabled:"{TextRuleModel>/editable}",type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("sys-cancel"),visible:{parts:[{path:"displayModel>/bCancelButtonVisible("+o+")"},{path:"TextRuleModel>/resultDataObjectId"},{path:"TextRuleModel>/expressionLanguageVersion"}],formatter:this._decideCancelButtonEnablement},press:function(e){s._deleteTextRuleResultExpression(e)}.bind(this)}).setTooltip(this.oBundle.getText("removeColumn")),new sap.m.Button({enabled:"{TextRuleModel>/editable}",type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("add"),visible:s.bOperationsContext,press:function(e){s._addTextRuleResultExpression(e)}.bind(this)}).setTooltip(this.oBundle.getText("addColumn"))]})]}).setBindingContext(t);return C},_getBindModelName:function(){var e="";var t=this.getModelName();if(t){e=t+">"}return e},_getBlankContent:function(){var e=new n({text:this.oBundle.getText("startTextRule")});var t=new u;t.setText(" ");var s=new f({enabled:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement},text:" "+this.oBundle.getText("settings"),press:[this._openTextRuleSettings,this]}).addStyleClass("sapTextRuleLink");var i=new v({justifyContent:"Center",items:[e,t,s],visible:{parts:[{path:"TextRuleModel>/enableSettings"},{path:"TextRuleModel>/editable"}],formatter:this._decideSettingsEnablement}}).addStyleClass("sapUiMediumMargin");return i},_getConvertedExpression:function(e,t,n){var s=sap.ui.getCore().byId(this.getExpressionLanguage());var i=this._formRuleData(n,e);var a;if(t){a=s.convertRuleToCodeValues(i)}else{a=s.convertRuleToDisplayValues(i)}i.Type="TextRule";return a},_getDataLoadedPromise:function(){if(!this._dataLoaded){this._setDataLoadedPromise()}return this._dataLoaded.promise()},_getElseButton:function(){var e=this;if(!sap.ui.getCore().getElementById("_elseButton")){this.oElseButton=new sap.m.Button({id:"_elseButton",text:this.oBundle.getText("addElse"),tooltip:this.oBundle.getText("addElse"),enabled:"{TextRuleModel>/editable}",press:function(t){e._addConditionBlock(t,e.typeElse)}})}return this.oElseButton},_getElseIfButton:function(){var e=this;if(!sap.ui.getCore().getElementById("_elseIfButton")){this.oElseIfButton=new sap.m.Button({id:"_elseIfButton",text:this.oBundle.getText("addElseIf"),tooltip:this.oBundle.getText("addElseIf"),enabled:"{TextRuleModel>/editable}",press:function(t){e._addConditionBlock(t,e.typeElseIf)}})}return this.oElseIfButton},_getElseIfPanel:function(){var e=this.oBundle.getText("titleElseIf");var t=[];var n=this._displayModel.getProperty("/textRuleConditions/ElseIf");if(n.length>0){for(var s=0;s<n.length;s++){var a={RuleId:n[s].RuleId,Id:n[s].Id,RuleVersion:n[s].RuleVersion};var r=this._getModel().createKey("/TextRuleConditions",a);var o=new sap.ui.model.Context(this._getModel(),r);var l=s+1;var u=" ("+l+")";t.push(this._createFormLayout(o,e+u,false))}}else{var d=new i({headerText:e,visible:"{TextRuleModel>/editable}",content:this._getElseIfButton()});t.push(d)}return t},_getElsePanel:function(){var e=this.oBundle.getText("titleElse");var t=[];var n=this._displayModel.getProperty("/textRuleConditions/Else");if(n.length>0){var s={RuleId:n[0].RuleId,Id:n[0].Id,RuleVersion:n[0].RuleVersion};var a=this._getModel().createKey("/TextRuleConditions",s);var r=new sap.ui.model.Context(this._getModel(),a);t.push(this._createElseFormLayout(r,e),false)}else{var o=new i({headerText:e,visible:"{TextRuleModel>/editable}",content:this._getElseButton()});t.push(o)}return t},_getExpressionAdvancedText:function(t,n,s,i,a,r){var o=this;var l=null;var u="";var d=s?s:sap.rules.ui.ExpressionType.BooleanEnhanced;this.valueState="None";this.bOperationsContext=false;if(this.getAstExpressionLanguage()){l=sap.ui.getCore().byId(this.getAstExpressionLanguage());var p=this._getExpressionFromAstNodes(t);if(p&&p.relString){p.relString=p.relString.replace(/\\/g,"\\\\").replace(/{/g,"\\{").replace(/}/g,"\\}")}var g=this._internalModel.getProperty("/ruleBindingPath").split("/")[2];var c=t.getObject("/"+g).ResultDataObjectId;this._internalModel.setProperty("/resultDataObjectId",c);if(i){u="/"+c+"/"+this._formatAttributeId(i)}if(c){c=c}if(!c&&!a){this.bOperationsContext=true}return new b({astExpressionLanguage:l,value:p.relString,jsonData:p.JSON,attributeInfo:u,resultDataObjectId:c,conditionContext:a,operationsContext:this.bOperationsContext,editable:"{TextRuleModel>/editable}",placeholder:this.oBundle.getText("expressionPlaceHolder"),valueState:this.valueState,ariaLabelledBy:r,change:function(e){var s=e.getSource();var i=sap.ui.getCore().getEventBus();t=s.getBindingContext();var a=t.getPath();var r=e.getParameter("astNodes");if(r&&r.length>0&&r[0].Type==="I"&&r[0].Value!=""&&r[0].Value!=undefined){e.oSource.setValueState("Error")}else{e.oSource.setValueState("None")}i.publish("sap.ui.rules","astCreating");var l=t.getModel();if(!l.hasPendingChanges()){o._removeAndUpdateExisitingNodes(a,t,r,n,l)}}.bind(this)}).setBindingContext(t)}else if(this.getExpressionLanguage()){l=sap.ui.getCore().byId(this.getExpressionLanguage());var f=o._getConvertedExpression(n,false,t);var p=o._getExpressionFromParseResults(n,f);p=p?p:n;return new h({expressionLanguage:l,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,type:d,value:p,attributeInfo:i,editable:"{TextRuleModel>/editable}",change:function(n){var s=n.getSource();t=s.getBindingContext();var i=t.getPath();f=o._getConvertedExpression(s.getValue(),true,t);var a=o._getExpressionFromParseResults(s.getValue(),f);a=a?a:s.getValue();o._updateModelExpression(i,t,a);var r=f.output.decisionTableData.DecisionTable.DecisionTableColumns.results["0"].Condition.parserResults;if(r.status!=="Error"){o._astUtils.Id=0;var l=r.converted.ASTOutput;try{var u=JSON.stringify(o._astUtils.parseConditionStatement(l));var d=t.oModel.oMetadata.mEntityTypes["/TextRuleConditions"].property;var p=0;if(d){for(var g=0;g<d.length;g++){if(d[g].name==="AST"){p=d[g].maxLength}}if(u&&u.length<=p){o._updateModelExpressionModelAst(i,t,u)}}}catch(t){e.error("Exception while converting ast for expression"+s.getValue()+" :"+t.message)}}}.bind(this)}).setBindingContext(t)}},_formatAttributeId:function(e){var t=e;if(t&&t.indexOf(":")>-1){t=t.replace(/:/g,"/")}return t},_removeAndUpdateExisitingNodes:function(e,t,n,s,i){var a=this;var r=sap.ui.getCore().getEventBus();i.setDeferredGroups(["astGroupId"]);i.update(t.getPath(),{Expression:t.getProperty("Expression")},{groupId:"astGroupId"});a._removeExistingAstNodes(e,t,n,s,i);a._updateModelAstNodes(e,t,n,i);i.submitChanges({groupId:"astGroupId",success:function(e){r.publish("sap.ui.rules","astCreated")}})},_getExpressionFromParseResults:function(e,t){if(t&&t.output.decisionTableData.DecisionTable.DecisionTableColumns.results[0].Condition.parserResults&&t.output.decisionTableData.DecisionTable.DecisionTableColumns.results[0].Condition.parserResults.converted){return t.output.decisionTableData.DecisionTable.DecisionTableColumns.results[0].Condition.parserResults.converted.Expression}else{return e}},_getExpressionFromAstNodes:function(e){var t=this;var n=sap.ui.getCore().byId(this.getAstExpressionLanguage());var s="";var i=[];var a=[];if(t.includes(e.sPath,"TextRuleConditions")){i=e.getObject(e.sPath).TextRuleConditionASTs}else{i=e.getObject(e.sPath).TextRuleResultExpressionASTs}var r=n._astBunldeInstance.ASTUtil;r.clearNodes();i=i.__list;if(i&&i.length>0){for(var o in i){var l=i[o];t._addNodeObject(e.getObject("/"+l))}a=r.getNodes();s=r.toAstExpressionString(a);if(a&&a[0].Type==="I"&&a[0].Value!=""&&a[0].Value!=undefined){this.valueState="Error"}else{this.valueState="None"}}return s},_addNodeObject:function(e){var t=[];var n=sap.ui.getCore().byId(this.getAstExpressionLanguage());var s=n._astBunldeInstance.ASTUtil;var i=[];i.Root=e.Root;i.SequenceNumber=e.Sequence;i.ParentId=e.ParentId;i.Reference=e.Reference;i.Id=e.NodeId;i.Type=e.Type;i.Value=e.Value?e.Value:"";if(e.Type==="I"){i.Value=e.IncompleteExpression}if(e.Function){i.Function=e.Function}if(e.Type!=="P"&&!e.Function){var a=[];a.BusinessDataType=e.Output?e.Output.BusinessDataType:e.BusinessDataType;a.DataObjectType=e.Output?e.Output.DataObjectType:e.DataObjectType;i.Output=a}s.createNode(i)},_getIfPanel:function(){var e=this.oBundle.getText("titleIf");var t=this._displayModel.getProperty("/textRuleConditions/If");var n={RuleId:t[0].RuleId,Id:t[0].Id,RuleVersion:t[0].RuleVersion};var s=this._getModel()?this._getModel().createKey("/TextRuleConditions",n):"";var i=new sap.ui.model.Context(this._getModel(),s);return this._createFormLayout(i,e,true)},_getModel:function(){var e=this.getModelName();if(e){return this.getModel(e)}return this.getModel()},_handleVerticalLayoutDataReceived:function(e){var t=e.__batchResponses[1].data;if(t&&t.results){this._internalModel.setProperty("/textRuleResults",t.results)}var n=e.__batchResponses[2].data;var s;if(!n){return}var i=this.getAggregation("_verticalLayout");if(n.results&&n.results.length===0){s=this._getBlankContent();i.addContent(s);this._internalModel.setProperty("/newTextRule",true);this._updateBusyState(false)}else{this._segregateTextRuleData(n.results);if(this._displayModel.getProperty("/textRuleConditions/If").length===0){s=this._getBlankContent();i.addContent(s);this._internalModel.setProperty("/newTextRule",true);this._updateBusyState(false)}else{this._bindVerticalLayout();this._internalModel.setProperty("/newTextRule",false)}}},_initDisplayModel:function(){var e={};e.textRuleConditions=[];e.textRuleConditions.If=[];e.textRuleConditions.ElseIf=[];e.textRuleConditions.Else=[];this._displayModel=new sap.ui.model.json.JSONModel(e);this.setModel(this._displayModel,"displayModel")},_initInternalModel:function(){var e={};e.editable=this.getEditable();e.newTextRule=true;e.enableSettings=true;e.projectId="";e.projectVersion="";e.ruleId="";e.ruleVersion="";e.ruleBindingPath="";e.textRuleResults=[];e.textRuleResultExpressions=[];e.resultDataObjectId="";e.expressionLanguageVersion="";this._internalModel=new sap.ui.model.json.JSONModel(e);this.setModel(this._internalModel,"TextRuleModel");var t=this.getModel("ruleBuilderInternalModel");var n=this.getModel("TextRuleModel");if(t&&n){var s=t&&t.getObject("/textRuleConfiguration")?t.getObject("/textRuleConfiguration").enableSettings:true;n.setProperty("/enableSettings",s)}},_initSettingsModel:function(){this._settingsModel=new sap.ui.model.json.JSONModel;this.setModel(this._settingsModel,"settingModel")},_openTextRuleSettings:function(){var e=this._createTextRuleSettings();var t=new x({contentWidth:"70%",contentHeight:"315px",title:this.oBundle.getText("textRuleSettings")});t.addContent(e);var n=e.getButtons(t);for(var s=0;s<n.length;s++){t.addButton(n[s])}t.attachBeforeClose(function(e){var n=t.getState();if(n===sap.ui.core.ValueState.Success){if(this._internalModel.getProperty("/resultChanged")){var s=sap.ui.getCore().getEventBus();s.publish("sap.ui.rules","refreshTextRuleModel")}this._resetControl()}t.destroy()},this);t.open()},_resetControl:function(){this._unbindVerticalLayout();this._initInternalModel();this._initSettingsModel();this._initDisplayModel();var e=this._getModel();var t=this.getBindingContextPath();if(!t||!e){return}this._updateBusyState(true);e.removeData();this._resetContent=false;var n=t.split("'");this._internalModel.setProperty("/projectId",n[1]);this._internalModel.setProperty("/projectVersion",n[3]);this._internalModel.setProperty("/ruleId",n[5]);this._internalModel.setProperty("/ruleVersion",n[7]);this._internalModel.setProperty("/ruleBindingPath",t);var s=new sap.ui.model.Context(e,t);this.setBindingContext(s);this._bindRule()},_segregateTextRuleData:function(e){var t=[];t.If=[];t.ElseIf=[];t.Else=[];if(e.length>0){e[0].Type=this.typeIf}for(var n=0;n<e.length;n++){t.push(e[n]);this.getModel("displayModel").setProperty("/bCancelButtonVisible("+e[n].Id+")",e[n].TextRuleResultExpressions.results.length>1);if(e[n].Type===this.typeIf){t.If.push(e[n])}else if(e[n].Type===this.typeElseIf){t.ElseIf.push(e[n])}else if(e[n].Type===this.typeElse){t.Else.push(e[n])}}this.getModel("displayModel").setProperty("/textRuleConditions",t)},_updateBusyState:function(e){var t=this;if(e){this.setBusy(true)}else{setTimeout(function(){t.setBusy(false)},1500)}},_unbindVerticalLayout:function(){var e=this.getAggregation("_verticalLayout");if(e){e.destroyContent()}},_updateModelExpression:function(e,t,n){t.getModel().setProperty(e+"/Expression",n,t,true)},_updateModelAstNodes:function(e,t,n,s){var e=t.getPath();var i=this.getModel().getObject(e);var a=i.RuleId;var r=i.RuleVersion;var o="";var l={};if(this.includes(e,"TextRuleConditions")){l.Id=i.Id;o="/TextRuleConditionASTs"}else{l.ConditionId=i.ConditionId;l.ResultId=i.ResultId;o="/TextRuleResultExpressionASTs"}for(var u in n){var d={};if(n[u].Root){d.Sequence=1;d.Root=true}else{d.Sequence=n[u].SequenceNumber;d.ParentId=n[u].ParentId}if(n[u].Reference){d.Reference=n[u].Reference}if(n[u].Function){d.Function=n[u].Function?n[u].Function:""}if(n[u].Type!=="P"&&!n[u].Function){d.BusinessDataType=n[u].Output?n[u].Output.BusinessDataType:n[u].BusinessDataType;d.DataObjectType=n[u].Output?n[u].Output.DataObjectType:n[u].DataObjectType;d.Value=n[u].Value?n[u].Value:""}if(n[u].Type==="I"){d.IncompleteExpression=n[u].Value}d.NodeId=n[u].Id;d.Type=n[u].Type;d.RuleId=a;d.RuleVersion=r;for(var p in l){d[p]=l[p]}var g={};g.properties=d;g.groupId="astGroupId";s.createEntry(o,g)}},_removeExistingAstNodes:function(e,t,n,s,i){var a=this;var r=this.getModel().getObject(e);var o=r.RuleId;var l=r.RuleVersion;var u="";var d={};if(a.includes(e,"TextRuleConditions")){d.Id=r.Id;u="/DeleteTextRuleConditionASTDraft"}else if(a.includes(e,"TextRuleResultExpression")){d.ConditionId=r.ConditionId;d.ResultId=r.ResultId;u="/DeleteTextRuleResultExpressionASTDraft"}else{d.Id=r.Id;u="/DeleteTextRuleResultASTDraft"}d.RuleId=o;d.RuleVersion=l;i.callFunction(u,{method:"POST",groupId:"astGroupId",urlParameters:d})},_updateModelExpressionModelAst:function(e,t,n){if(t.getModel().getProperty(e+"/AST")){t.getModel().setProperty(e+"/AST",n,t,true)}},init:function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.typeIf="If";this.typeElseIf="ElseIf";this.typeElse="Else";this._resetContent=true;this._initInternalModel();this._initDisplayModel();this._initSettingsModel();this._addToolBar();this._addTextRuleControl();this._astUtils=T},onAfterRendering:function(){var e=this.getAggregation("_verticalLayout");var t=this;e.addEventDelegate({onAfterRendering:function(){t._updateBusyState(false)}},this)},onBeforeRendering:function(){if(this._resetContent){this._resetControl()}},setEnableSettings:function(e){this.setProperty("enableSettings",e,true);this._internalModel.setProperty("/enableSettings",e);return this},setEnableSettingResult:function(e){this.setProperty("enableSettingResult",e,true);return this},setModelName:function(e){this.setProperty("modelName",e);this._resetContent=true;return this},setExpressionLanguage:function(e){this.setAssociation("expressionLanguage",e,true);var t=e instanceof Object?e:sap.ui.getCore().byId(e);if(!t){return this}var n=this.getAggregation("_verticalLayout");if(n){var s=n.getBinding("content");if(s){s.refresh()}}return this},setAstExpressionLanguage:function(e){this.setAssociation("astExpressionLanguage",e,true);var t=e instanceof Object?e:sap.ui.getCore().byId(e);if(!t){return this}var n=this.getAggregation("_verticalLayout");if(n){var s=n.getBinding("content");if(s){s.refresh()}}return this},setEditable:function(e){this.setProperty("editable",e,true);this._internalModel.setProperty("/editable",e);return this},setBindingContextPath:function(e){var t=this.getBindingContextPath();if(e&&t!==e){this._unbindVerticalLayout();this.setProperty("bindingContextPath",e);this._resetContent=true}return this},includes:function(e,t){var n=false;if(e.indexOf(t)!==-1){n=true}return n},renderer:I});return E},true);
//# sourceMappingURL=TextRule.js.map
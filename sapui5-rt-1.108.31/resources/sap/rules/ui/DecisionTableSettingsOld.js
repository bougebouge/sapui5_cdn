/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/rules/ui/library","sap/ui/core/Control","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Switch","sap/m/Select","sap/m/Table","sap/m/Text","sap/m/CheckBox","sap/m/Input","sap/m/Button","sap/rules/ui/ExpressionAdvanced","sap/ui/layout/VerticalLayout","sap/rules/ui/type/Expression","./DecisionTableSettingsOldRenderer"],function(jQuery,e,t,i,s,a,o,r,n,l,u,p,d,c,g,h){"use strict";var y=t.extend("sap.rules.ui.DecisionTableSettingsOld",{metadata:{library:"sap.rules.ui",properties:{hitPolicies:{type:"sap.rules.ui.RuleHitPolicy[]",defaultValue:[sap.rules.ui.RuleHitPolicy.FirstMatch,sap.rules.ui.RuleHitPolicy.AllMatch]},modelName:{type:"string",defaultValue:""},newDecisionTable:{type:"boolean",defaultValue:false}},aggregations:{mainLayout:{type:"sap.ui.layout.form.SimpleForm",multiple:false}},defaultAggregation:"mainLayout",associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,singularName:"expressionLanguage"}},events:{},publicMethods:[]},renderer:h});sap.rules.ui.DecisionTableSettingsOld.prototype.init=function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.needCreateLayout=true;this.firstLoad=true;this.onsapescape=function(e){e.stopPropagation()};this._decisionTableHeaderSettingFormatter=new g;this.setBusyIndicatorDelay(0)};sap.rules.ui.DecisionTableSettingsOld.prototype.onBeforeRendering=function(){if(this.firstLoad){this._initSettingsModel();if(this.getProperty("newDecisionTable")===true){this._prepareNewRuleWorkaround()}this.firstLoad=false}if(this.needCreateLayout){var e=this.getAggregation("mainLayout");if(e){e.destroy()}e=this._createLayout();this.setAggregation("mainLayout",e,true);this.needCreateLayout=false;this.conditionsTable.getBinding("items").attachDataRequested(function(){this.setBusy(true)}.bind(this));this.conditionsTable.getBinding("items").attachDataReceived(function(){this.setBusy(false)}.bind(this))}};sap.rules.ui.DecisionTableSettingsOld.prototype._prepareNewRule=function(){var e=this._getModel();var t=this.getBindingContext();var i=sap.rules.ui.RuleFormat.Advanced;e.setProperty("Type",sap.rules.ui.RuleType.DecisionTable,t,true);e.setProperty("RuleFormat",i,t,true);var s=sap.ui.getCore().byId(this.getExpressionLanguage());var a=s.getExpressionLanguageVersion();e.setProperty("ExpressionLanguageVersion",a,t,true);var o={ruleId:t.getProperty("Id"),version:t.getProperty("Version")};var r={};this._createDecisionTable(o,r);o.colId=1;o.expression="";this._createCondition(o,r);o.colId=2;var n=this._createResult(o,r);o.rowId=1;o.columnsNumber=1+n;this._createRow(o,r)};sap.rules.ui.DecisionTableSettingsOld.prototype._createDecisionTable=function(e,t){var i=this._getModel();var s=this.getBindingContext();var a=this.getHitPolicies()[0];if(s.getProperty("DecisionTable")){i.setProperty("DecisionTable/HitPolicy",a,s,true)}else{var o={RuleId:e.ruleId,Version:e.version,HitPolicy:a};t=t?t:{};t.properties=o;i.createEntry("/DecisionTables",t)}};sap.rules.ui.DecisionTableSettingsOld.prototype._createRow=function(e,t){t=t?t:{};var i=this._getModel();var s={RuleId:e.ruleId,Version:e.version,Id:e.rowId};t.properties=s;i.createEntry("/DecisionTableRows",t);this._createCellsForNewRow(e,t)};sap.rules.ui.DecisionTableSettingsOld.prototype._createCondition=function(e,t){t=t?t:{};var i=this._getModel();var s={RuleId:e.ruleId,Version:e.version,Id:e.colId,Type:sap.rules.ui.DecisionTableColumn.Condition};t.properties=s;i.createEntry("/DecisionTableColumns",t);var a={RuleId:e.ruleId,Version:e.version,Id:e.colId,Expression:e.expression,ValueOnly:false,FixedOperator:"",Description:""};t.properties=a;i.createEntry("/DecisionTableColumnConditions",t)};sap.rules.ui.DecisionTableSettingsOld.prototype._createCellsForNewColumn=function(e,t){t=t?t:{};var i=this._getModel();var s=this.getBindingContext();var a=i.getProperty("DecisionTable/DecisionTableRows",s);for(var o=0;o<a.length;o++){var r=i.getProperty("/"+a[o]).Id;var n={RuleId:e.ruleId,Version:e.version,RowId:r,ColId:e.colId,Content:""};t.properties=n;i.createEntry("/DecisionTableRowCells",t)}};sap.rules.ui.DecisionTableSettingsOld.prototype._createCellsForNewRow=function(e,t){t=t?t:{};var i=this._getModel();for(var s=1;s<=e.columnsNumber;s++){var a={RuleId:e.ruleId,Version:e.version,RowId:e.rowId,ColId:s,Content:""};t.properties=a;i.createEntry("/DecisionTableRowCells",t)}};sap.rules.ui.DecisionTableSettingsOld.prototype._createResult=function(e,t){var i=this.getBindingContext();var s=i.getProperty("ResultDataObjectName");var a=sap.ui.getCore().byId(this.getExpressionLanguage());var o=a.getResultInfo(s);var r=o?o.requiredParams:[];var n=r.length;var l=e.colId;for(var u=0;u<n;u++){e.colId=l+u;e.resultParameterData=r[u];this._createResultParameter(e,t)}return n};sap.rules.ui.DecisionTableSettingsOld.prototype._createResultParameter=function(e,t){t=t?t:{};var i=this._getModel();var s={RuleId:e.ruleId,Version:e.version,Id:e.colId,Type:sap.rules.ui.DecisionTableColumn.Result};t.properties=s;i.createEntry("/DecisionTableColumns",t);var a={RuleId:e.ruleId,Version:e.version,Id:e.colId,DataObjectAttributeName:e.resultParameterData.name,DataObjectAttributeId:e.resultParameterData.paramId,BusinessDataType:e.resultParameterData.businessDataType};t.properties=a;i.createEntry("/DecisionTableColumnResults",t)};sap.rules.ui.DecisionTableSettingsOld.prototype._removeColumn=function(e,t){var i=this._getModel();var s=e.getPath();i.remove(s,t);this._internalModel.setProperty("/tableData",{},true)};sap.rules.ui.DecisionTableSettingsOld.prototype._removeCellsForColumn=function(e,t){var i=this._getModel();var s=this.getBindingContext();var a=i.getProperty("DecisionTable/DecisionTableRows",s);var o=e.colId-1;for(var r=0;r<a.length;r++){var n=i.getProperty("/"+a[r]+"/Cells");var l="/"+n[o];i.remove(l,t)}};sap.rules.ui.DecisionTableSettingsOld.prototype._createTable=function(){this.conditionsTable=new r({backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.None,fixedLayout:true,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new sap.m.Column({width:"50%",header:new sap.m.Label({text:this.oBundle.getText("colOfDecisionTable"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("colOfDecisionTable"))}),new sap.m.Column({width:"30%",header:new sap.m.Label({text:this.oBundle.getText("fixedOperator"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("fixedOperator"))}),new sap.m.Column({width:"20%"})]}).data("hrf-id","columnsTable",true);this.conditionsTable.bindItems({path:"DecisionTable/DecisionTableColumnsCondition",factory:this._tableColumnsFactory.bind(this),parameters:{expand:"Condition"}});this.conditionsTable.setBusyIndicatorDelay(0);return this.conditionsTable};sap.rules.ui.DecisionTableSettingsOld.prototype._createLayout=function(){var e=new i({editable:true,layout:"ResponsiveGridLayout",maxContainerCols:1,columnsL:1,columnsM:1,labelSpanM:1,content:[new s({text:this.oBundle.getText("hitPolicy")}).setTooltip(this.oBundle.getText("hitPolicy")),new o({width:"25%",enabled:"{settingsModel>/hitPolicy/enabled}",items:{path:"settingsModel>/hitPolicy/hitPolicyEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>text}"})},selectedKey:"{DecisionTable/HitPolicy}"}),new s,this._createTable(),new s({text:this.oBundle.getText("ouput")}).setTooltip(this.oBundle.getText("ouput")),new n({width:"25%",text:"{ResultDataObjectName}"})]});return e};sap.rules.ui.DecisionTableSettingsOld.prototype._setFixedOperatorOnExpressionChange=function(e,t){var i=this._getFixedOperatorDataForExpression(e);this._internalModel.setProperty("/tableData/"+t,i,true);this._updateRemoveRowEnabled()};sap.rules.ui.DecisionTableSettingsOld.prototype.setExpressionLanguage=function(e){this.setAssociation("expressionLanguage",e,true);this._decisionTableHeaderSettingFormatter.setExpressionLanguage(e)};sap.rules.ui.DecisionTableSettingsOld.prototype._getColumnControlObject=function(e){var t=this._internalModel.getProperty("/advancedMode/current");if(t===sap.rules.ui.RuleFormat.Advanced){var i=sap.ui.getCore().byId(this.getExpressionLanguage());return new d({expressionLanguage:i,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,type:sap.rules.ui.ExpressionType.NonComparison,value:{path:"Condition/Expression",type:this._decisionTableHeaderSettingFormatter,events:{change:function(e){var t=e.getSource();var s=t.getContext();var a=s.getProperty("Id");var o=i.convertDecisionTableExpressionToDisplayValue(t.getValue(),"","",sap.rules.ui.ExpressionType.All);var r;if(o.output.status==="Success"&&o.output.converted){r=o.output.converted.header}else{r=t.getValue()}this._setFixedOperatorOnExpressionChange(r,a)}.bind(this)}},enabled:true,change:function(e){var t=e.getSource();var i=t.getBindingContext();var s=i.getProperty("Id");this._setFixedOperatorOnExpressionChange(t.getValue(),s);var a=i.getProperty("Condition/Expression");if(!a){var o=i.getModel();o.setProperty(i.getPath()+"/Condition/FixedOperator","")}}.bind(this)})}else{return new o({width:"100%",items:{path:"",template:new sap.ui.core.Item({key:"",text:""})},selectedKey:"{Condition/Expression}",enabled:true,change:function(e){}})}};sap.rules.ui.DecisionTableSettingsOld.prototype._tableColumnsFactory=function(e,t){var i=t.getProperty("RuleId");var s=t.getProperty("Version");var a=t.getProperty("Id");return new sap.m.ColumnListItem({cells:[this._getColumnControlObject(t),new sap.m.Select({width:"100%",items:{path:"settingsModel>/tableData/"+a+"/fixOperatorEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>value}"})},selectedKey:"{Condition/FixedOperator}",enabled:"{settingsModel>/tableData/"+a+"/fixOperatorEnabled}"}),new sap.ui.layout.HorizontalLayout({content:[new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("sys-cancel"),visible:"{settingsModel>/removeRowEnabled}",press:function(e){var t=e.getSource().getBindingContext();var i={};this._removeColumnWorkaround(t,i)}.bind(this)}).setTooltip(this.oBundle.getText("removeColumn")),new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("add"),press:function(e){var t={ruleId:i,version:s,colId:a+1,expression:""};var o={};this._addConditionWorkaround(t,o)}.bind(this)}).setTooltip(this.oBundle.getText("addColumn"))],height:"1em"})]})};sap.rules.ui.DecisionTableSettingsOld.prototype._prepareNewRuleWorkaround=function(){this._prepareNewRule();this._saveWorkaround()};sap.rules.ui.DecisionTableSettingsOld.prototype._addConditionWorkaround=function(e,t){this._createCondition(e,t);this._saveWorkaround()};sap.rules.ui.DecisionTableSettingsOld.prototype._removeColumnWorkaround=function(e,t){var i=this._getModel();if(i.hasPendingChanges()){this._saveWorkaround({success:function(){this._removeColumn(e,t)}.bind(this)})}else{this._removeColumn(e,t)}};sap.rules.ui.DecisionTableSettingsOld.prototype._saveWorkaround=function(e){var t=this._getModel();t.submitChanges(e)};sap.rules.ui.DecisionTableSettingsOld.prototype._getModel=function(){var e=this.getModelName();if(e){return this.getModel(e)}return this.getModel()};sap.rules.ui.DecisionTableSettingsOld.prototype._getBindModelName=function(){var e="";var t=this.getModelName();if(t){e=t+">"}return e};sap.rules.ui.DecisionTableSettingsOld.prototype._initSettingsModel=function(){var e={};e.advancedMode=this._getAdvancedModeData();e.hitPolicy=this._getHitPoliciesData();e.tableData={};e.removeRowEnabled=false;this._internalModel=new sap.ui.model.json.JSONModel(e);this.setModel(this._internalModel,"settingsModel")};sap.rules.ui.DecisionTableSettingsOld.prototype._getAdvancedModeData=function(){var e;var t={};var i=this.getBindingContext();var s=i.getProperty("RuleFormat");if(s===sap.rules.ui.RuleFormat.Advanced){e=sap.rules.ui.RuleFormat.Advanced}else{e=sap.rules.ui.RuleFormat.Advanced}switch(e){case sap.rules.ui.RuleFormat.All:t={current:sap.rules.ui.RuleFormat.Basic,enabled:true,visible:true};break;case sap.rules.ui.RuleFormat.Basic:t={current:sap.rules.ui.RuleFormat.Basic,enabled:false,visible:false};break;case sap.rules.ui.RuleFormat.Advanced:t={current:sap.rules.ui.RuleFormat.Advanced,enabled:false,visible:true};break;default:}return t};sap.rules.ui.DecisionTableSettingsOld.prototype._getHitPoliciesData=function(){var e=this.getProperty("hitPolicies");var t=e.length;var i={hitPolicyEnumration:[]};for(var s=0;s<t;s++){i.hitPolicyEnumration.push({key:e[s],text:this.oBundle.getText(e[s])})}i.enabled=t>1?true:false;return i};sap.rules.ui.DecisionTableSettingsOld.prototype._getFixedOperatorDataForExpression=function(e){var t=e?true:false;var i={fixOperatorEnumration:[{key:"",value:this.oBundle.getText("fixOperatorDefaultValue")}],fixOperatorEnabled:t};if(t){var s=[];var a=sap.ui.getCore().byId(this.getExpressionLanguage());var o=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonExistOp}];s=a.getSuggestionsByCategories(e,o);for(var r=0;r<s.length;r++){i.fixOperatorEnumration.push({key:s[r].text,value:s[r].text})}}return i};sap.rules.ui.DecisionTableSettingsOld.prototype._setAdvancedMode=function(e){var t=e.getParameter("selected");var i=t?sap.rules.ui.RuleFormat.Advanced:sap.rules.ui.RuleFormat.Basic;var s=this._getModel();var a=this.getBindingContext().getPath();s.setProperty(a+"/RuleFormat",i);this.needCreateLayout=true;this.invalidate()};sap.rules.ui.DecisionTableSettingsOld.prototype._updateRemoveRowEnabled=function(){var e=this._internalModel.getProperty("/tableData");var t=Object.keys(e).length;var i=t>1;this._internalModel.setProperty("/removeRowEnabled",i,null,true)};sap.rules.ui.DecisionTableSettingsOld.prototype.getButtons=function(e){var t=[];var i=new p({text:this.oBundle.getText("applyChangesBtn")}).setTooltip(this.oBundle.getText("applyChangesBtn"));i.attachPress(function(){this.multiHeaderFlag=false;this.getModel().submitChanges();e.setState(sap.ui.core.ValueState.Success);e.close()},this);t.push(i);return t};return y},true);
//# sourceMappingURL=DecisionTableSettingsOld.js.map
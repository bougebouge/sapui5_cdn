sap.ui.define(["sap/ui/core/Control","sap/m/List","sap/ui/model/json/JSONModel","sap/rules/ui/ast/constants/Constants"],function(e,t,a,s){"use strict";var r;var i=function(){this._vocabularyExpressionId="";this.functionLabelDisplay="";this.functionLabel="";this._aggregateFunctionSelected="";this._whereExpressionId="";this._groupBy=[];this.functionLabelExpression="";this.displayTextVocabulary="";this.jsonDataArray=[];this.groupBySelectEnable=true;this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n")};i.prototype._filterAggregateFunction=function(e){var t=[];if(e&&e.aggregate){for(var a=0;a<e.aggregate.length;a++){if(e.aggregate[a].name!==s.FILTER){t.push(e.aggregate[a])}}return{aggregate:t}}};i.prototype._createFunctionSelectionDropDown=function(e,t){var a=this;e=this._filterAggregateFunction(e);var s=new sap.ui.model.json.JSONModel(e);this.functionSelect=new sap.m.Select({selectedKey:this._aggregateFunctionSelected,forceSelection:false,showSecondaryValues:true,layoutData:new sap.ui.layout.GridData({span:"L3 M3 S12"}),ariaLabelledBy:t,change:function(e){this._aggregateFunctionSelected=e.getSource().getSelectedItem().getText();this.astExpressionBasicForVocabulary.setValue("");this.applyButton.setEnabled(false);this.astExpressionBasicForWhere.setEditable(false);this.astExpressionBasicForAttributes.setEditable(false);this.groupBySelect.setEnabled(false);this.astExpressionBasicForAttributes.setValue("");this._attributeId="";this._groupBy=[];this.groupBySelected=[];this.astExpressionBasicForWhere.setValue("");this._whereExpressionId="";this.functionLabelField.setValue("");this.groupBySelect.setSelectedKeys([])}.bind(this)}).addStyleClass("sapAstExpressionDialogField");this.functionSelect.setModel(s);this.functionSelect.bindItems({path:"/aggregate",template:new sap.ui.core.ListItem({text:"{name}",key:"{name}",additionalText:"{label}"})});return this.functionSelect};i.prototype._enableField=function(){if(this._vocabularyExpressionId&&this._aggregateFunctionSelected){return true}else{return false}};i.prototype._enableFieldGroupBy=function(){if(this._vocabularyExpressionId&&this._aggregateFunctionSelected&&this.groupBySelectEnable){return true}else{return false}};i.prototype._enableFieldWhere=function(){if(this._vocabularyExpressionId&&this._aggregateFunctionSelected&&this.jsonDataArray.length===0){return true}else{return false}};i.prototype._enableFieldAttribute=function(){var e=false;if(this._vocabularyExpressionId&&this._aggregateFunctionSelected&&this.jsonDataArray.length===0){e=true}return e};i.prototype._createVocabularyAstExpression=function(e){var t=this;var a=[];this.astExpressionBasicForVocabulary=new sap.rules.ui.AstExpressionBasic({value:this._vocabularyExpressionId,jsonData:this.jsonDataArray,astExpressionLanguage:this._oAstExpressionLanguage,enableAggregateFunctionVocabulary:true,ariaLabelledBy:e,editable:true,change:function(e){this._vocabularyExpressionId=e.getParameter("newValue");this.sDataObjectSelected=t._getDataObjectFromExpression(t._vocabularyExpressionId);if(t._vocabularyExpressionId&&this._aggregateFunctionSelected){if(e.getSource().getProperty("jsonData")&&e.getSource().getProperty("jsonData").length>0){t._helperForSelectFunction(e)}else{if(this.sDataObjectSelected){this.functionLabelDisplay=this._aggregateFunctionSelected+"("+this.sDataObjectSelected.label+")";this.functionLabel=this._aggregateFunctionSelected+"("+this.dataObjectId+")";this.functionLabelField.setValue(t.functionLabelDisplay);this.astExpressionBasicForWhere.setValue("");this.astExpressionBasicForAttributes.setValue("");this._whereExpressionId="";this._attributeId="";this.applyButton.setEnabled(this._aggregateFunctionSelected===s.COUNT?true:false);this.jsonDataArray=[];var a=this._setDataObjectInfoForWhereConditionAutoSuggestion();this.astExpressionBasicForWhere.setDataObjectInfo(a);this.astExpressionBasicForAttributes.setDataObjectInfo(this._getDataObjectInfoForAttribute());this._bindGroupByDropDown();this._groupBy=[];this.groupBySelected=[];this.astExpressionBasicForWhere.setEditable(true);this.astExpressionBasicForAttributes.setEditable(this._aggregateFunctionSelected===s.COUNT?false:true);this.groupBySelectEnable=this._aggregateFunctionSelected!==s.COUNTDISTINCT&&this._aggregateFunctionSelected!==s.DISTINCT?true:false;this.groupBySelect.setEnabled(this.groupBySelectEnable);if(!this._isDataObjectStructure()&&!this._isDataObjectElement()){this.astExpressionBasicForVocabulary.setValueState("None")}}}}else{this.applyButton.setEnabled(false);this.astExpressionBasicForWhere.setEditable(false);this.astExpressionBasicForAttributes.setEditable(false);this.groupBySelect.setEnabled(false);this.astExpressionBasicForWhere.setValue("");this._whereExpressionId="";this.astExpressionBasicForWhere.setDataObjectInfo("");this.astExpressionBasicForAttributes.setValue("");this._attributeId="";this.functionLabelField.setValue("");this.groupBySelect.setSelectedKeys([]);this.jsonDataArray=[];this.astExpressionBasicForVocabulary.setValueState("None")}}.bind(this)});this.astExpressionBasicForVocabulary.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForVocabulary};i.prototype._helperForSelectFunction=function(e){if(e.getSource().getProperty("jsonData")&&e.getSource().getProperty("jsonData").length>0){this.functionLabelExpression=e.getSource().getProperty("jsonData")[0].functionLabel;this.jsonDataArray=e.getSource().getProperty("jsonData");this.sDataObjectSelected=this._getDataObjectFromExpression(this.functionLabelExpression);if(!this._isDataObjectStructure()&&!this._isDataObjectElement()){this.astExpressionBasicForVocabulary.setValueState("None")}else{this.astExpressionBasicForVocabulary.setValueState("Error")}if(Object.keys(this.jsonDataArray[0].attributes).length===0||Object.keys(this.jsonDataArray[0].attributes).length>1){this.applyButton.setEnabled(false);this.astExpressionBasicForVocabulary.setValueState("Error");this.astExpressionBasicForVocabulary.setValueStateText(this.oBundle.getText("invalidAttribute"))}else{this.applyButton.setEnabled(true);this.astExpressionBasicForVocabulary.setValueState("None")}this.displayTextVocabulary=e.getParameter("displayText");this.functionLabelDisplay=this._aggregateFunctionSelected+"("+this.displayTextVocabulary+")";this.functionLabelField.setValue(this.functionLabelDisplay);this.functionLabel=this._aggregateFunctionSelected+"("+this.functionLabelExpression+")";this.astExpressionBasicForWhere.setValue("");this._whereExpressionId="";this.astExpressionBasicForAttributes.setValue("");this._attributeId="";var t=this._setDataObjectInfoForWhereConditionAutoSuggestion();this.astExpressionBasicForWhere.setDataObjectInfo(t);this._bindGroupByDropDown();this._groupBy=[];this.groupBySelected=[];this.astExpressionBasicForWhere.setEditable(false);this.astExpressionBasicForAttributes.setEditable(false);this.groupBySelectEnable=this._aggregateFunctionSelected!==s.COUNTDISTINCT&&this._aggregateFunctionSelected!==s.DISTINCT?true:false;this.groupBySelect.setEnabled(this.groupBySelectEnable)}};i.prototype._setDataObjectInfoForWhereConditionAutoSuggestion=function(){var e="";if(this.jsonDataArray&&this.jsonDataArray.length>0){return this._aggregateFunctionSelected+"(FILTER("+this._vocabularyExpressionId+","}else if(this.dataObjectId){var t=this.dataObjectId;if(this.includes(t,"/")){t=t.replace("/","")}e=this._returnDataObjectBasedOnType(this._vocabularyExpressionId);if(e){return this._aggregateFunctionSelected+"(FILTER("+e+","}return this._aggregateFunctionSelected+"(FILTER(/"+t+","}};i.prototype._getDataObjectInfoForAttribute=function(){var e="";if(this.jsonDataArray&&this.jsonDataArray.length===0&&this._vocabularyExpressionId){e=this._vocabularyExpressionId}return e};i.prototype._getDataObjectFromExpression=function(e){var t="";if(e&&e.trim()&&this.includes(e,"(")){var a=/\(([^)]+),/;var r=e.split("(");t=r[0]===s.SELECT||r[0]===s.TOP||r[0]===s.BOTTOM||r[0]===s.FIRST?this.jsonDataArray[0]?this.jsonDataArray[0].dataObject:"":"";t=t.replace("/","")}else if(e&&e.trim()){var i=e.split("/");t=i[1]}if(t){var o={};t=t.trim();var n=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var l=n.getTermByTermId(t);if(l){o={name:n.getTermByTermId(t)._termName,label:n.getTermByTermId(t)._label};this.dataObjectId="/"+t}return o}};i.prototype._createAttributeAstExpressionBasic=function(e){var t=this;this.astExpressionBasicForAttributes=new sap.rules.ui.AstExpressionBasic({value:this._attributeId,astExpressionLanguage:this._oAstExpressionLanguage,dataObjectInfo:this._getDataObjectInfoForAttribute(),ariaLabelledBy:e,enableAggregateFunctionAttribute:true,isAttributeContext:true,editable:t._enableFieldAttribute(),change:function(e){t._attributeId=e.getParameter("newValue");if(t._attributeId){t.applyButton.setEnabled(true)}else{t.applyButton.setEnabled(false)}}.bind(this)});this.astExpressionBasicForAttributes.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForAttributes};i.prototype._createWhereAstExpressionBasic=function(e){var t=this;this.oModel=new sap.ui.model.json.JSONModel;this.oModel.setData({value:this._whereExpressionId});this.astExpressionBasicForWhere=new sap.rules.ui.AstExpressionBasic({astExpressionLanguage:this._oAstExpressionLanguage,enableAggregateFunctionWhereClause:true,value:this._whereExpressionId,editable:t._enableFieldWhere(),dataObjectInfo:this._setDataObjectInfoForWhereConditionAutoSuggestion(),ariaLabelledBy:e,change:function(e){t._whereExpressionId=e.getParameter("newValue")}.bind(this)});this.astExpressionBasicForWhere.setModel(this.oModel);this.astExpressionBasicForWhere.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForWhere};i.prototype._createGroupByDropDown=function(e){var t=this;this.groupBySelect=new sap.m.MultiComboBox({showSecondaryValues:true,enabled:t._enableFieldGroupBy(),ariaLabelledBy:e,selectionFinish:function(e){t._groupBy=[];for(var a=0;a<e.getSource().getSelectedItems().length;a++){var s="./"+e.getSource().getSelectedItems()[a].getKey();t._groupBy.push(s)}}}).addStyleClass("sapAstExpressionDialogField");this.groupBySelect.bindItems({path:"/terms",template:new sap.ui.core.ListItem({text:"{label}",key:"{id}"})});this._bindGroupByDropDown();return this.groupBySelect};i.prototype._bindGroupByDropDown=function(){var e="";if(this.dataObjectId){e=this._returnDataObjectBasedOnType(this._vocabularyExpressionId);if(e){var t=this._getSuggestionsForTheGivenInput(e)}else{var t=this._getSuggestionsForTheGivenInput(this.dataObjectId)}var a=this._getAttributesForGroupBy(t.autoComplete.categories);var s=new sap.ui.model.json.JSONModel(a);this.groupBySelect.setModel(s)}if(this.groupBySelected){this.groupBySelect.setSelectedKeys(this.groupBySelected)}};i.prototype._getAttributesForGroupBy=function(e){var t=[];if(e&&e.terms){for(var a=0;a<e.terms.length;a++){if(e.terms[a].type==="E"){t.push(e.terms[a])}}return{terms:t}}};i.prototype._createFunctionLabel=function(){this.functionLabelField=new sap.m.TextArea({value:this.functionLabelDisplay,enabled:false,width:"100%",height:"34px"}).addStyleClass("sapAstFieldMargin sapAstExpressionDialogTextField");return this.functionLabelField};i.prototype._clearData=function(){this._vocabularyExpressionId="";this.functionLabelDisplay="";this.functionLabel="";this._aggregateFunctionSelected="";this._groupBy=[];this._whereExpressionId="";this._attributeId="";this.groupBySelected=[];this.dataObjectId="";this.functionLabelExpression="";this.displayTextVocabulary="";this.jsonDataArray=[];this.groupBySelectEnable=true};i.prototype._convertFunctionLabelToText=function(e,t){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var a=this.termsProvider.getTermNameFromASTNodeReference(e);t=t.replace(e,a);return t};i.prototype._createAggregationFunctionDialog=function(e,t,a,r,i){var o=this;this._clearData();this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this._oAstExpressionLanguage=a;if(i){this._whereExpressionId=i.filter;this._aggregateFunctionSelected=i.function;this._attributeId=i.attribute;this.functionLabel=i.functionLabel;this.functionLabelDisplay=this._convertFunctionLabelToText(i.dataObject,i.functionLabel);if(i.groupBy){for(var n=0;n<i.groupBy.length;n++){this.groupBySelected.push(i.groupBy[n].replace("./",""))}}this._groupBy=i.groupBy;this.dataObjectId=i.dataObject;if(typeof i.vocabulary==="object"||i.vocabulary instanceof Object){this._vocabularyExpressionId=i.selectExpression;this.jsonDataArray=[i.vocabulary]}else{this._vocabularyExpressionId=i.vocabulary}this.groupBySelectEnable=this._aggregateFunctionSelected!==s.COUNTDISTINCT&&this._aggregateFunctionSelected!==s.DISTINCT?true:false}var l=o._createFunctionSelectionDropDown(e,"aggregateFunctionSelectLabelId");var u=new sap.m.Text({text:o.oBundle.getText("vocabulary"),tooltip:o.oBundle.getText("vocabulary"),textAlign:"End",width:"90%",layoutData:new sap.ui.layout.GridData({span:"L2 M2 S12"})});var c=o._createWhereAstExpressionBasic("aggregateWhereLabelId");var p=o._createGroupByDropDown("aggregateGroupByLabelId");var h=o._createAttributeAstExpressionBasic("aggregateAttributeLabelId");var g=o._createFunctionLabel("aggregateFunctionLabelId");var d=new sap.ui.layout.form.SimpleForm({layout:sap.ui.layout.form.SimpleFormLayout.ResponsiveGridLayout,editable:true,content:[new sap.m.Label("aggregateFunctionSelectLabelId",{text:o.oBundle.getText("function"),tooltip:o.oBundle.getText("function"),labelFor:l.getId()}),l,u,o._createVocabularyAstExpression(u.getId()),new sap.m.Label("aggregateAttributeLabelId",{text:o.oBundle.getText("attribute"),tooltip:o.oBundle.getText("attribute"),labelFor:h.getId()}),h,new sap.m.Label("aggregateWhereLabelId",{text:o.oBundle.getText("where"),tooltip:o.oBundle.getText("where"),labelFor:c.getId()}),c,new sap.m.Label("aggregateGroupByLabelId",{text:o.oBundle.getText("group_by"),tooltip:o.oBundle.getText("group_by"),labelFor:p.getId()}),p,new sap.m.Label("aggregateFunctionLabelId",{text:o.oBundle.getText("function_label"),tooltip:o.oBundle.getText("function_label"),labelFor:g.getId()}).addStyleClass("sapAstDialogLabelMargin"),g]});var b=new sap.m.Dialog({title:this.oBundle.getText("configure_aggr_title"),contentWidth:"800px",showHeader:true,afterOpen:function(){o.astExpressionBasicForWhere.setValue(o._whereExpressionId)},beforeClose:function(){r(false)},content:[d],buttons:[this.applyButton=new sap.m.Button({text:o.oBundle.getText("apply"),enabled:o._enableField(),tooltip:o.oBundle.getText("applyChangesBtnTooltip"),press:function(e){if(o._isDataObjectStructure()||o._isDataObjectElement()){o.astExpressionBasicForVocabulary.setValueState("Error");o.astExpressionBasicForVocabulary.setValueStateText(o.oBundle.getText("StructureElementNotSupported"))}else{o.astExpressionBasicForVocabulary.setValueState("None");if(o.jsonDataArray&&o.jsonDataArray.length>0){var a=o._whereExpressionId;var s=o._attributeId;var r=o._groupBy;var i=o._createJson(o._aggregateFunctionSelected,o.jsonDataArray[0],a,r,o.functionLabel,o.dataObjectId,s)}else{var a=o._whereExpressionId;var s=o._attributeId;var r=o._groupBy;var i=o._createJson(o._aggregateFunctionSelected,o._vocabularyExpressionId,a,r,o.functionLabel,o.dataObjectId,s)}e.getSource().mProperties={value:o.functionLabel,jsonData:i};t(e);o._setModal(false);b.close();b.destroy()}}}),new sap.m.Button({text:o.oBundle.getText("cancel"),tooltip:o.oBundle.getText("cancelBtnTooltip"),press:function(e){o._setModal(false);b.close();b.destroy()}})]}).addStyleClass("sapUiSizeCompact");this._setModal(true);b.open()};i.prototype._returnDataObjectBasedOnType=function(e){var t="";if(this.jsonDataArray&&this.jsonDataArray.length>0){if(this.jsonDataArray[0]&&this.jsonDataArray[0].attributes){for(var a in this.jsonDataArray[0].attributes){t=this.jsonDataArray[0].doVocabId+a.replace(".","");break}}}else{t=this._vocabularyExpressionId}if(t){var s=t.split("/");var r=s[1];var i=0;var o;var n="";if(s.length>2){for(var l=2;l<s.length;l++){r+="."+s[l];o=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(r);if(o&&o._dataObjectType==="AO"&&o._cardinality==="1..n"){i=l}else if(o&&o._dataObjectType==="R"&&o._isDataObjectTable){i=l}}if(i>0){for(var l=1;l<=i;l++){n+="/"+s[l]}}}if(n){return n}else{return"/"+s[1]}}};i.prototype._isDataObjectStructure=function(){if(this.jsonDataArray&&this.jsonDataArray.length===0){this.tableId=this._vocabularyExpressionId;this.tableId=this.tableId.replace(/\//,"");this.tableId=this.tableId.replace(/\//g,".");var e=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(this.tableId);if(e&&e._dataObjectType&&e._dataObjectType==="S"){return true}else if(e&&e._dataObjectType&&e._dataObjectType==="AO"&&e._cardinality&&e._cardinality==="1..1"){return true}else if(e&&e._dataObjectType&&e._dataObjectType==="R"&&!e._isDataObjectTable){return true}}else{this.tableId=this._returnDataObjectBasedOnType(this._vocabularyExpressionId);if(this.tableId&&(this.tableId.match(/\//g)||[]).length===1){var e=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(this.tableId.replace(/\//,""));if(e&&e._dataObjectType==="S"){return true}}}return false};i.prototype._isDataObjectElement=function(){var e=this.jsonDataArray?this.jsonDataArray[0]:undefined;var t=e?e.dataObject:this._vocabularyExpressionId;this.elementDOId=t.replace(/\//,"");this.elementDOId=this.elementDOId.trim();var a=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(this.elementDOId);if(a&&(a._isDataObjectElement||a.isResultDataObjectElement)){return true}return false};i.prototype._setModal=function(e){var t=sap.ui.getCore().byId("popover");if(t){t.setModal(e)}};i.prototype._createJson=function(e,t,a,s,r,i,o){return{function:e,vocabulary:t,filter:a,attribute:o,groupBy:s,functionLabel:r,dataObject:i}};i.prototype._getSuggestionsForTheGivenInput=function(e){var t=this._oAstExpressionLanguage.getTokensForGivenStringInput(e);var a=this._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(t);var s={};s.AttributeContext=true;s.OperationsContext=false;var r=this._oAstExpressionLanguage.getSuggesstions(a,s);return r};i.prototype.includes=function(e,t){var a=false;if(e.indexOf(t)!==-1){a=true}return a};return{getInstance:function(){if(!r){r=new i;r.constructor=null}return r}}},true);
//# sourceMappingURL=AggregateFunctionDialog.js.map
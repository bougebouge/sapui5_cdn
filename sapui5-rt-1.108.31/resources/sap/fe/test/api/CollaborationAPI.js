/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/controllerextensions/collaboration/ActivityBase","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/draft","sap/ui/model/json/JSONModel"],function(t,e,n,o,i){"use strict";var a=n.Activity;var r=e.initializeCollaboration;var s=e.endCollaboration;var l=e.broadcastCollaborationMessage;var c={_lastReceivedMessage:undefined,_rootPath:"",_oModel:undefined,_lockedPropertyPath:"",_internalModel:undefined,enterDraft:function(e,n,o){var a=e.getModel().getMetaModel().getObject("/@com.sap.vocabularies.Common.v1.WebSocketBaseURL");if(!a){t.error("Cannot find WebSocketBaseURL annotation");return}var s=e.getProperty("DraftAdministrativeData/DraftUUID");this._internalModel=new i({});var l=e.getModel().getServiceUrl();r({id:n,name:o,initialName:o},a,s,l,this._internalModel,this._onMessageReceived.bind(this),true);this._rootPath=e.getPath();this._oModel=e.getModel()},checkReceived:function(t){if(!this._lastReceivedMessage){return false}var e=(!t.userID||t.userID===this._lastReceivedMessage.userID)&&(!t.userAction||t.userAction===this._lastReceivedMessage.userAction)&&(!t.clientContent||t.clientContent===this._lastReceivedMessage.clientContent);this._lastReceivedMessage=undefined;return e},leaveDraft:function(){if(this._internalModel){s(this._internalModel);this._internalModel.destroy();this._internalModel=undefined}},startLiveChange:function(t){if(this._internalModel){if(this._lockedPropertyPath){this.undoChange()}this._lockedPropertyPath=t;l(a.LiveChange,"".concat(this._rootPath,"/").concat(t),this._internalModel)}},updatePropertyValue:function(e,n){var o=this;if(this._internalModel){if(this._lockedPropertyPath!==e){this.startLiveChange(e)}var i=this._oModel.bindContext(this._rootPath,undefined,{$$patchWithoutSideEffects:true,$$groupId:"$auto",$$updateGroupId:"$auto"});var r=this._oModel.bindProperty(e,i.getBoundContext());r.requestValue().then(function(){r.setValue(n);i.attachEventOnce("patchCompleted",function(){l(a.Change,"".concat(o._rootPath,"/").concat(e),o._internalModel);o._lockedPropertyPath=""})}).catch(function(e){t.error(e)})}},undoChange:function(){if(this._lockedPropertyPath){l(a.Undo,"".concat(this._rootPath,"/").concat(this._lockedPropertyPath),this._internalModel);this._lockedPropertyPath=""}},discardDraft:function(){var e=this;if(this._internalModel){var n=this._getDraftContext();n.requestProperty("IsActiveEntity").then(function(){o.deleteDraft(n)}).then(function(){l(a.Discard,e._rootPath.replace("IsActiveEntity=false","IsActiveEntity=true"),e._internalModel);e._internalModel.destroy();e._internalModel=undefined}).catch(function(e){t.error(e)})}},deleteDraft:function(){var e=this;if(this._internalModel){var n=this._getDraftContext();var i;n.requestProperty("IsActiveEntity").then(function(){return n.getModel().bindContext("".concat(e._rootPath,"/SiblingEntity")).getBoundContext()}).then(function(t){i=t;return t.requestCanonicalPath()}).then(function(){return o.deleteDraft(n)}).then(function(){i.delete();l(a.Delete,e._rootPath,e._internalModel);e._internalModel.destroy();e._internalModel=undefined}).catch(function(e){t.error(e)})}},_getDraftContext:function(){return this._oModel.bindContext(this._rootPath,undefined,{$$patchWithoutSideEffects:true,$$groupId:"$auto",$$updateGroupId:"$auto"}).getBoundContext()},_onMessageReceived:function(t){t.userAction=t.userAction||t.clientAction;this._lastReceivedMessage=t;if(t.userAction===a.Join){l(a.JoinEcho,this._lockedPropertyPath?"".concat(this._rootPath,"/").concat(this._lockedPropertyPath):undefined,this._internalModel)}}};return c},false);
//# sourceMappingURL=CollaborationAPI.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/ConverterContext","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticDateOperators","sap/fe/core/templating/DisplayModeFormatter","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/ODataMetaModelUtil","sap/ui/core/Core","sap/ui/mdc/condition/Condition","sap/ui/mdc/condition/ConditionConverter","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/odata/v4/TypeUtil","sap/ui/mdc/p13n/StateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/v4/ODataUtils"],function(e,t,r,n,a,i,o,l,s,f,c,g,u,d,p,v,y,h,C,m,F,P){"use strict";var T=s.ODATA_TYPE_MAPPING;var S={getFilter:function(e){var t=S.getFilterInfo(e).filters;return t.length?new m(S.getFilterInfo(e).filters,false):undefined},getFilterField:function(e,t,r){return n.getFilterField(e,t,r)},buildProperyInfo:function(e,t){var r;var a={};var i=t.getConverterContextFor(e.annotationPath);var o=i.getDataModelObjectPath().targetObject;var l=n.fetchTypeConfig(o);r=n.fetchPropertyInfo(t,e,l);a[e.key]=l;r=n.assignDataTypeToPropertyInfo(r,t,[],a);return r},createConverterContext:function(e,n,o,l){var s=c.getCustomData(e,"entityType"),f=n||s;var g=e.isA?r.getTargetView(e):null;var u=o||e.getModel().getMetaModel();var d=l||g&&r.getAppComponent(g);var p=i.getInvolvedDataModelObjects(u.createBindingContext(f));var v;if(e.isA&&!e.isA("sap.ui.mdc.filterbar.vh.FilterBar")){v=g&&g.getViewData()||undefined}return a.createConverterContextForMacro(p.startingEntitySet.name,u,d&&d.getDiagnostics(),t,p.contextLocation,v)},getConvertedFilterFields:function(e,t,r,n,a,i,o){var l=this._getFilterMetaModel(e,n);var s=c.getCustomData(e,"entityType"),f=t||s;var g=this._getFieldsForTable(e,t);var u=this.createConverterContext(e,t,n,a);return this._getSelectionFields(e,t,s,f,g,l,u,r,i,o)},getBindingPathForParameters:function(e,r,n,a){var i=[];n=S.setTypeConfigToProperties(n);for(var o=0;o<a.length;o++){var l=a[o];if(r[l]&&r[l].length>0){var s=t({},r[l][0]);var f=C.getPropertyByKey(n,l);var c=f.typeConfig||y.getTypeConfig(f.dataType,f.formatOptions,f.constraints);var g=p.toType(s,c,e.getTypeUtil());var u=T[c.className];i.push("".concat(l,"=").concat(encodeURIComponent(P.formatLiteral(g.values[0],u))))}}var d=e.data("entityType");var v=d.substring(0,d.length-1);var h=v.slice(0,v.lastIndexOf("/"));var m=v.substring(v.lastIndexOf("/")+1);return"".concat(h,"(").concat(i.toString(),")/").concat(m)},getEditStateIsHideDraft:function(e){var t=false;if(e&&e.$editState){var r=e.$editState.find(function(e){return e.operator==="DRAFT_EDIT_STATE"});if(r&&(r.values.includes("ALL_HIDING_DRAFTS")||r.values.includes("SAVED_ONLY"))){t=true}}return t},getFilterInfo:function(e,t,r){var n=t&&t.ignoredProperties||[];var a=t&&t.targetControl,i=a?a.data("entityType"):undefined;var o=e,l,s=[],f,c=t&&t.propertiesMetadata;if(typeof e==="string"){o=u.byId(e)}if(o){l=this._getSearchField(o,n);var g=this._getFilterConditions(t,r,o);var d=o.getPropertyInfoSet?o.getPropertyInfoSet():null;d=this._getFilterPropertiesMetadata(d,o);if(t&&t.targetControl&&t.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(g).forEach(function(e){if(e==="$editState"){delete g["$editState"]}})}var p=o.data("parameters")||[];p=typeof p==="string"?JSON.parse(p):p;if(p&&p.length>0){f=S.getBindingPathForParameters(o,g,d,p)}if(g){if(i&&o.data("entityType")!==i){var v=o.getModel().getMetaModel();var y=o.getControlDelegate().fetchPropertiesForEntity(i,v,o);c=y;var h={};for(var m in y){var F=y[m];h[F.name]={hasProperty:true,dataType:F.dataType}}var P=this._getIgnoredProperties(d,h);if(P.length>0){n=n.concat(P)}}else if(!c){c=d}var T=C.getFilterInfo(o,g,S.setTypeConfigToProperties(c),n.concat(p)).filters;s=T?[T]:[]}}return{filters:s,search:l||undefined,bindingPath:f}},setTypeConfigToProperties:function(e){if(e&&e.length){e.forEach(function(e){if(e.typeConfig&&e.typeConfig.typeInstance&&e.typeConfig.typeInstance.getConstraints instanceof Function){return}if(e.path==="$editState"){e.typeConfig=y.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(e.path==="$search"){e.typeConfig=y.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(e.dataType||e.typeConfig&&e.typeConfig.className){e.typeConfig=y.getTypeConfig(e.dataType||e.typeConfig.className,e.formatOptions,e.constraints)}})}return e},getNotApplicableFilters:function(e,t){var r=t.data("entityType"),n=e.data("entityType"),a=e.getModel().getMetaModel().getObject(n),i=[],o=e.getConditions(),l=e.getModel().getMetaModel(),s=r===e.data("entityType"),u=t.isA("sap.ui.mdc.Chart"),d=!u&&t.getParent().getTableDefinition().enableAnalytics,p=u?f.parseCustomData(c.getCustomData(t,"applySupported")).enableSearch:!d||t.getParent().getTableDefinition().enableAnalyticsSearch;if(o&&(!s||d||u)){var v=s?[]:e.getControlDelegate().fetchPropertiesForEntity(r,l,e),y=v.reduce(function(e,t){e[t.name]=t;return e},{}),h=!u&&t.getParent().getTableDefinition().aggregates||{},C={};Object.keys(h).forEach(function(e){var t=h[e];C[t.relativePath]=t});var m=t.getModel().getMetaModel().getObject(t.data("targetCollectionPath")+"/");if(t.isA("sap.ui.mdc.Chart")){var F=t.getModel().getMetaModel().getObject("".concat(t.data("targetCollectionPath"),"@")),P=g.getAllCustomAggregates(F);Object.keys(P).forEach(function(e){if(!C[e]){var t=P[e];C[e]=t}})}for(var T in o){var S=o[T];var b=true;if(m[T]&&a[T]){b=m[T]["$Type"]===a[T]["$Type"]}if(Array.isArray(S)&&S.length>0&&((!y[T]||y[T]&&!b)&&(!s||T==="$editState"&&u)||C[T])){i.push(T.replace(/\+|\*/g,""))}}}if(!p&&e.getSearch()){i.push("$search")}return i},setFilterValues:function(t,r){try{function y(){return Promise.resolve(h.applyExternalState(t,{filter:u})).then(function(){})}for(var n=arguments.length,a=new Array(n>2?n-2:0),i=2;i<n;i++){a[i-2]=arguments[i]}var o=a===null||a===void 0?void 0:a[0];var s=a===null||a===void 0?void 0:a[1];if(!t){return Promise.resolve()}if(a.length===2&&(s===undefined||s===null||s==="")&&o&&Object.keys(F).indexOf(o)!==-1){e.warning("An empty filter value cannot be applied with the ".concat(o," operator"));return Promise.resolve()}if(s===undefined&&!l.getSemanticDateOperations().includes(o||"")){var f;s=(f=o)!==null&&f!==void 0?f:[];o=undefined}if(!o){o=F.EQ}var c=["string","number","boolean"];if(s!==undefined&&(!Array.isArray(s)&&!c.includes(typeof s)||Array.isArray(s)&&s.length>0&&!c.includes(typeof s[0]))){throw new Error("FilterUtils.js#_setFilterValues: Filter value not supported; only primitive values or an array thereof can be used.")}var g;if(s!==undefined){g=Array.isArray(s)?s:[s]}var u={};var p=function(){if(r){var e=function(){if(g&&g.length){if(o===F.BT){u[r]=[d.createCondition(o,g,null,null,v.NotValidated)]}else{u[r]=g.map(function(e){return d.createCondition(o,[e],null,null,v.NotValidated)})}}else{var e=function(){if(!l.getSemanticDateOperations().includes(o||"")){return Promise.resolve(h.retrieveExternalState(t)).then(function(e){if(e.filter[r]){e.filter[r].forEach(function(e){e.filtered=false});u=e.filter}})}else{u[r]=[d.createCondition(o,[],null,null,v.NotValidated)]}}();if(e&&e.then)return e.then(function(){})}}();if(e&&e.then)return e.then(function(){})}}();return Promise.resolve(p&&p.then?p.then(y):y(p))}catch(C){return Promise.reject(C)}},conditionToModelPath:function(e){return e.replace(/\//g,"\\")},_getFilterMetaModel:function(e,t){return t||e.getModel().getMetaModel()},_getEntitySetPath:function(e){return e&&o.getEntitySetPath(e)},_getFieldsForTable:function(e,t){var n=[];if(t){var a=r.getTargetView(e);var i=a&&a.oController&&a.oController._getControls&&a.oController._getControls("table");if(i){i.forEach(function(e){n.push(e.getParent().getTableDefinition())})}return n}return[]},_getSelectionFields:function(e,t,r,a,o,l,s,f,c,g){var u=n.getSelectionFields(s,o,undefined,f,g).selectionFields;if((c?c.getControlType(e)==="sap.ui.mdc.FilterBar":e.isA("sap.ui.mdc.FilterBar"))&&t!==r){var d=i.getInvolvedDataModelObjects(l.createBindingContext(a));var p=s.getConverterContextFor(r);var v=p.getEntityTypeAnnotation("@com.sap.vocabularies.UI.v1.SelectionFields").annotation||[];var y={};u.forEach(function(e){y[e.conditionPath]=true});v.forEach(function(e){var t=e.value;if(!y[t]){var r=n.getFilterField(t,s,d.startingEntitySet.entityType);if(r){u.push(r)}}})}if(u){var h=[];u.forEach(function(e){h.push(e.key)});u=this._getSelectionFieldsFromPropertyInfos(e,h,u)}return u},_getSelectionFieldsFromPropertyInfos:function(e,t,r){var n=e.getPropertyInfo&&e.getPropertyInfo()||[];n.forEach(function(e){if(e.name==="$search"||e.name==="$editState"){return}var n=r[t.indexOf(e.key)];if(t.indexOf(e.key)!==-1&&n.annotationPath){e.group=n.group;e.groupLabel=n.groupLabel;e.settings=n.settings;e.visualFilter=n.visualFilter;e.label=n.label;r[t.indexOf(e.key)]=e}if(t.indexOf(e.key)===-1&&!e.annotationPath){r.push(e)}});return r},_getSearchField:function(e,t){return e.getSearch&&t.indexOf("search")===-1?e.getSearch():null},_getFilterConditions:function(e,t,r){var n=t||r.getConditions();if(e&&e.targetControl&&e.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(n).forEach(function(e){if(e==="$editState"){delete n["$editState"]}})}return n},_getFilterPropertiesMetadata:function(e,t){if(!(e&&e.length)){if(t.getPropertyInfo){e=t.getPropertyInfo()}else{e=null}}return e},_getIgnoredProperties:function(e,t){var r=[];e.forEach(function(e){var n=e.name;var a=t[n];if(a&&(!a["hasProperty"]||a["hasProperty"]&&e.dataType!==a.dataType)){r.push(n)}});return r},getFilters:function(e){var t=this.getFilterInfo(e),r=t.filters,n=t.search;return{filters:r,search:n}}};return S},false);
//# sourceMappingURL=FilterUtils.js.map
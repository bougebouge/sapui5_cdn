/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/converters/helpers/SelectionVariantHelper","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/BindingToolkit","sap/fe/macros/DelegateUtil","sap/fe/macros/field/FieldRuntime","sap/fe/macros/filter/FilterUtils","sap/ui/core/Component","sap/ui/core/format/NumberFormat","sap/ui/model/Filter"],function(e,t,a,n,r,i,o,c,s,l,f){"use strict";var u=r.pathInModel;var g=r.compileExpression;var v=n.getInvolvedDataModelObjects;var d=a.getRangeDefinition;function m(e,a){var n=t.getAppComponent(e).getMetaModel();var r=n.getMetaContext("".concat(e.data("entityType")).concat(a)),i=v(r).targetObject,o={},c=[],s=[];var l="";if(i){l=i.Text;(i.SelectOptions||[]).forEach(function(e){var t,a;if((t=e.PropertyName)!==null&&t!==void 0&&t.$target&&((a=e.Ranges)===null||a===void 0?void 0:a.length)>0){var n=e.PropertyName.$target.type;var r=e.PropertyName.value;if(!s.includes(r)){s.push(r)}for(var i in e.Ranges){var c=d(e.Ranges[i],n);o[r]=(o[r]||[]).concat(new f(r,c.operator,c.rangeLow,c.rangeHigh))}}});for(var u in o){c.push(new f({filters:o[u],and:false}))}}return{properties:s,filters:c,text:l}}function p(e){var t=[];var a=e.data("hiddenFilters");if(a&&Array.isArray(a.paths)){a.paths.forEach(function(a){var n=m(e,a.annotationPath);t=t.concat(n.filters)})}return t}function b(e){var t=[];var a=i.getCustomData(e,"quickFilterKey");if(a){t=t.concat(m(e,a).filters)}return t}function h(e){return b(e).concat(p(e))}function O(e,t,a){var n;var r=e.data("rowsBindingInfo"),i=e.getModel();var o=a.batchGroupId||"",c=j(e);var s=Array.isArray(a.additionalFilters)?a.additionalFilters:[];var l=c.bindingPath?c.bindingPath:r.path;s=s.concat(c.filters).concat(F(e));var u=new f({filters:s,and:true});var g=i.bindList((t?"".concat(t.getPath(),"/"):"")+l,e.getBindingContext(),[],u);return g.fetchFilter(g.getContext()).then(function(e){n=i.bindProperty("".concat(g.getPath(),"/$count"),g.getContext(),{$$groupId:o||"$auto",$filter:e[0],$search:c.search});return n.requestValue()}).then(function(e){n.destroy();g.destroy();return e})}function P(e){var t=l.getIntegerInstance({groupingEnabled:true});return t.format(e)}function j(e){var t=e.getParent().getTableDefinition();var a=[];function n(e){var t=e.getParent().getTableDefinition().aggregates;return Object.keys(t).map(function(e){return t[e].relativePath})}if(t.enableAnalytics){a=a.concat(n(e));if(!t.enableAnalyticsSearch){a=a.concat(["search"])}}return c.getFilterInfo(e.getFilter(),{ignoredProperties:a,targetControl:e})}function F(e){var t=e.getP13nMode();if(t&&t.indexOf("Filter")>-1){var a=(i.getCustomData(e,"sap_fe_TableDelegate_propertyInfoMap")||[]).filter(function(e){return e&&!(e.filterable===false)}),n=c.getFilterInfo(e,{propertiesMetadata:a});if(n&&n.filters){return n.filters}}return[]}function y(e){var t=j(e);return{filters:t.filters.concat(h(e),F(e)),search:t.search,bindingPath:t.bindingPath}}function C(e){return S(e).promise}function x(e){var t=S(e);if(t.resolve){t.resolve(e);e.data("boundPromiseResolve",null)}}function S(e){if(!e.data("boundPromise")){var t;e.data("boundPromise",new Promise(function(e){t=e}));if(e.isBound()){t(e)}else{e.data("boundPromiseResolve",t)}}return{promise:e.data("boundPromise"),resolve:e.data("boundPromiseResolve")}}function T(e,a,n){e.filters=n;if(a.search){e.parameters.$search=t.normalizeSearchTerm(a.search)}else{e.parameters.$search=undefined}}function I(a,n){var r=a.getView();var c=r.getBindingContext("internal");if(c){var l=i.getCustomData(n,"targetCollectionPath");if(l){var f=a.getOwnerComponent();var v=s.getOwnerComponentFor(f);var d=v.getMetaModel();var m=t.getShellServices(v);var p=o._fnFixHashQueryString(t.getHash());var b=n.getParent().getTableDefinition().columns;var h=[];var O=[];var P=[];var j="",F,y;var C;var x=[];var S,T;for(var I=0;I<b.length;I++){F=b[I].annotationPath;if(F){y=d.getObject(F);if(y&&y.$kind==="Property"){j=b[I].annotationPath}else if(y&&y.$Type==="com.sap.vocabularies.UI.v1.DataField"){j="".concat(l,"/").concat(d.getObject("".concat(F,"/Value/$Path")))}}if(j!==""){var M=Object.keys(d.getObject(j+"@"));for(var $=0;$<M.length;$++){if(!P.includes(j)&&M[$].indexOf("@".concat("com.sap.vocabularies.Common.v1.SemanticObject"))===0&&M[$].indexOf("@".concat("com.sap.vocabularies.Common.v1.SemanticObjectMapping"))===-1&&M[$].indexOf("@".concat("com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions"))===-1){T=/#(.*)/.exec(M[$]);S=T?T[1]:"";x.push(t.getSemanticObjectPromise(v,r,d,j,S));P.push(j)}}}j=""}if(x.length===0){return Promise.resolve()}else{Promise.all(x).then(function(e){var a=[];var n;var r=e.filter(function(e){if(e.semanticObject&&typeof e.semanticObject.semanticObject==="object"){n=g(u(e.semanticObject.semanticObject.$Path));e.semanticObject.semanticObject=n;e.semanticObjectForGetLinks[0].semanticObject=n;return true}else if(e){return e.semanticObject!==undefined}else{return false}});for(var i=0;i<r.length;i++){C=r[i];if(C&&C.semanticObject&&!(C.semanticObject.semanticObject.indexOf("{")===0)){h.push(C.semanticObjectForGetLinks);O.push({semanticObject:C.semanticObject&&C.semanticObject.semanticObject,unavailableActions:C.unavailableActions,path:r[i].semanticObjectPath});a.push(m.getLinksWithCache([C.semanticObjectForGetLinks]))}}return t.updateSemanticTargets(a,O,c,p)}).catch(function(t){e.error("fnGetSemanticTargetsFromTable: Cannot get Semantic Objects",t)})}}}}function M(e){e.clearSelection();var t=e.getBindingContext("internal");if(t){t.setProperty("deleteEnabled",false);t.setProperty("numberOfSelectedContexts",0);t.setProperty("selectedContexts",[]);t.setProperty("deletableContexts",[])}}var $={getCountFormatted:P,getHiddenFilters:p,getFiltersInfoForSV:m,getTableFilters:h,getListBindingForCount:O,getFilterInfo:j,getP13nFilters:F,getAllFilterInfo:y,whenBound:C,onTableBound:x,getSemanticTargetsFromTable:I,updateBindingInfo:T,clearSelection:M};return $},false);
//# sourceMappingURL=Utils.js.map
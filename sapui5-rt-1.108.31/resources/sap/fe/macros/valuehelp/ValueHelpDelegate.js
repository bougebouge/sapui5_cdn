/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/macros/internal/valuehelp/ValueListHelperNew","sap/m/inputUtils/highlightDOMElements","sap/ui/mdc/condition/Condition","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/odata/v4/ValueHelpDelegate","sap/ui/mdc/p13n/StateUtil"],function(e,t,r,n,i,a,l,o){"use strict";function u(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=f(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var n=0;var i=function(){};return{s:i,n:function(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,l=false,o;return{s:function(){r=r.call(e)},n:function(){var e=r.next();a=e.done;return e},e:function(e){l=true;o=e},f:function(){try{if(!a&&r.return!=null)r.return()}finally{if(l)throw o}}}}function f(e,t){if(!e)return;if(typeof e==="string")return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return s(e,t)}function s(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++){n[r]=e[r]}return n}var v="sap.fe.core.controls.FilterBar";var c="sap.ui.mdc.filterbar.FilterBarBase";var d={onAfterRendering:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++){t[r]=arguments[r]}var i=t[0].srcControl;var a=i.$().find("tbody .sapMText");n(a,i.getParent().getFilterValue(),true)}};return Object.assign({},l,{retrieveContent:function(e,t,n){return r.showValueList(e,t,n)},onConditionPropagation:function(t,n,l,f){if(l!=="ControlChange"){return}var s=t.qualifiers[t.valueHelpQualifier];var d=(s===null||s===void 0?void 0:s.vhParameters)&&r.getOutParameters(s.vhParameters)||[],h=n.getControl(),p=h.getParent(),g=n.getParent();var m=g.isA(v)&&g.getFilterItems();var y=h.getConditions();y=y.filter(function(e){var r=e.payload&&e.payload||{};return r[t.valueHelpQualifier]});if(p.isA(c)){o.retrieveExternalState(p).then(function(e){y.forEach(function(t){var r=t.payload,n=r&&Object.keys(r),l=d.length&&!!n?r[n[0]]:[];if(!l){return}var o=u(d),f;try{var s=function(){var t=f.value;var r=t.source.split("/").pop()||"";if(m&&m.find(function(e){return e.getId().split("::").pop()===r})){l.forEach(function(n){var l=i.createCondition("EQ",[n[t.helpPath]],null,null,a.Validated);e.filter[r]=e.filter&&e.filter[r]||[];e.filter[r].push(l)})}};for(o.s();!(f=o.n()).done;){s()}}catch(e){o.e(e)}finally{o.f()}});o.applyExternalState(p,e)}).catch(function(t){e.error("ValueHelpDelegate: ".concat(t.message))})}else{y.forEach(function(t){var r=t.payload,i=r&&Object.keys(r),a=d.length&&!!i?r[i[0]]:[];if(!a){return}var l=n.getBindingContext();if(l){d.forEach(function(t){var r=t.source;if((a===null||a===void 0?void 0:a.length)===1){var n=a[0];l.setProperty(r,n[t.helpPath])}else if(a!==null&&a!==void 0&&a.length&&(a===null||a===void 0?void 0:a.length)>1){e.warning("ValueHelpDelegate: ParamterOut in multi-value-field not supported")}})}})}},_createInitialFilterCondition:function(t,r){var n;if(t===undefined||t===null){e.error("ValueHelpDelegate: value of the property could not be requested")}else if(t===""){if(r){n=i.createCondition("Empty",[],null,null,a.Validated)}}else{n=i.createCondition("EQ",[t],null,null,a.Validated)}return n},_getInitialFilterConditionsFromBinding:function(t,r,n){try{var i=this;var a=n.map(function(e){return e.source});var l=r.getBindingContext();if(!l){e.error("ValueHelpDelegate: No BindingContext");return Promise.resolve(t)}return Promise.resolve(l.requestProperty(a)).then(function(e){for(var r=0;r<n.length;r++){var a=n[r];var l=i._createInitialFilterCondition(e[r],a.initialValueFilterEmpty);if(l){t[a.helpPath]=[l]}}return t})}catch(e){return Promise.reject(e)}},_getInitialFilterConditionsFromFilterBar:function(e,t,r){try{var n=t.getParent();return Promise.resolve(o.retrieveExternalState(n)).then(function(t){var n=u(r),i;try{for(n.s();!(i=n.n()).done;){var a=i.value;var l=a.source.split("/").pop();var o=t.filter[l];if(o){e[a.helpPath]=o}}}catch(e){n.e(e)}finally{n.f()}return e})}catch(e){return Promise.reject(e)}},_partitionInParameters:function(e){var t={constant:[],binding:[],filter:[]};var r=u(e),n;try{for(r.s();!(n=r.n()).done;){var i=n.value;if(i.constantValue!==undefined){t.constant.push(i)}else if(i.source.indexOf("$filter")===0){t.filter.push(i)}else{t.binding.push(i)}}}catch(e){r.e(e)}finally{r.f()}return t},getInitialFilterConditions:function(t,n,i){try{var a=this;function P(){var e=function(){if(v.filter.length){return Promise.resolve(a._getInitialFilterConditionsFromFilterBar(o,i,v.filter)).then(function(){})}}();return e&&e.then?e.then(function(){return o}):o}if(n!==null&&n!==void 0&&n.isA("sap.ui.mdc.valuehelp.content.MTable")){var l=n.getTable();l===null||l===void 0?void 0:l.removeEventDelegate(d);l===null||l===void 0?void 0:l.addEventDelegate(d,a)}var o={};if(!i){e.error("ValueHelpDelegate: Control undefined");return Promise.resolve(o)}var f=t.qualifiers[t.valueHelpQualifier];var s=f.vhParameters&&r.getInParameters(f.vhParameters)||[];var v=a._partitionInParameters(s);var c=i.getBindingContext();var h=u(v.constant),p;try{for(h.s();!(p=h.n()).done;){var g=p.value;var m=a._createInitialFilterCondition(g.constantValue,c?g.initialValueFilterEmpty:false);if(m){o[g.helpPath]=[m]}}}catch(C){h.e(C)}finally{h.f()}var y=function(){if(v.binding.length){return Promise.resolve(a._getInitialFilterConditionsFromBinding(o,i,v.binding)).then(function(){})}}();return Promise.resolve(y&&y.then?y.then(P):P(y))}catch(b){return Promise.reject(b)}},createConditionPayload:function(e,t,r,n){var i=e.qualifiers[e.valueHelpQualifier],a={},l={};var o=t.getControl();var u=o===null||o===void 0?void 0:o.isA("sap.ui.mdc.MultiValueField");if(!i.vhKeys||i.vhKeys.length===1||u){return undefined}i.vhKeys.forEach(function(e){var t=n.getObject(e);if(t!=null){a[e]=(t===null||t===void 0?void 0:t.length)===0?"":t}});if(Object.keys(a).length){l[e.valueHelpQualifier]=[a]}return l},adjustSearch:function(e,r,n){return t.normalizeSearchTerm(n)},isFilterableListItemSelected:function(e,t,r,n){var i;if(!e.isValueListWithFixedValues&&((i=t.getConfig())===null||i===void 0?void 0:i.maxConditions)===1){return false}var a=r.getBindingContext();var l=n.find(function(r){var n;var i=r.payload,l=e.valueHelpQualifier||"";if(!i&&Object.keys(e.qualifiers)[0]===l){var o=t.getKeyPath();return(a===null||a===void 0?void 0:a.getObject(o))===(r===null||r===void 0?void 0:r.values[0])}var u=(i===null||i===void 0?void 0:(n=i[l])===null||n===void 0?void 0:n[0])||{},f=Object.keys(u);if(f.length){return f.every(function(e){return u[e]===(a===null||a===void 0?void 0:a.getObject(e))})}return false});return l?true:false}})},false);
//# sourceMappingURL=ValueHelpDelegate.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/fe/core/CommonUtils","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/PropertyHelper","sap/fe/core/type/TypeUtil","sap/fe/macros/DelegateUtil","sap/fe/macros/ODataMetaModelUtil","sap/ui/core/Core","sap/ui/mdc/odata/v4/TableDelegate","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter"],function(e,t,r,a,n,i,o,l,p,s,f,c,u,d,g,v,h,y,m){"use strict";var b=p.getLabel;var P=p.getAssociatedUnitPropertyPath;var C=p.getAssociatedTimezonePropertyPath;var M=p.getAssociatedTextPropertyPath;var I=p.getAssociatedCurrencyPropertyPath;var T=l.getDisplayMode;var O=o.getTargetObjectPath;var D=o.enhanceDataModelPath;var F=n.getInvolvedDataModelObjects;var j=a.fetchTypeConfig;var U=Object.assign({},d);U.fetchProperties=function(e){var t=this;var r=this._getModel(e);var a;if(!r){a=new Promise(function(r){e.attachModelContextChange({resolver:r},x,t)}).then(function(r){return t._createPropertyInfos(e,r)})}else{a=this._createPropertyInfos(e,r)}return a.then(function(t){if(e.data){e.data("$tablePropertyInfo",t)}return t})};function x(e,t){var r=e.getSource();var a=this._getModel(r);if(a){r.detachModelContextChange(x);t.resolver(a)}}function E(e){var t=R(e);var r={};if(t!==null&&t!==void 0&&t.targetObject){var a,n,i,o,l;var p=t.targetObject;var s=t.navigationProperties.length?O(t,true):p.name;var f=e.targetObject;var c=e.navigationProperties.length?O(e,true):f.name;var u=(a=f.annotations)===null||a===void 0?void 0:(n=a.Common)===null||n===void 0?void 0:n.Text,d=u===null||u===void 0?void 0:(i=u.annotations)===null||i===void 0?void 0:(o=i.UI)===null||o===void 0?void 0:(l=o.TextArrangement)===null||l===void 0?void 0:l.toString(),g=u&&d&&T(f);if(g==="Description"){r[s]=p}else if(g&&g!=="Value"||!u){r[c]=f;r[s]=p}}return r}U._createPropertyInfos=function(e,t){var r=e.getDelegate().payload;var a=[];var n="/".concat(r.collectionName);var i=t.getMetaModel();return i.requestObject("".concat(n,"@")).then(function(t){var r=t["@Org.OData.Capabilities.V1.SortRestrictions"];var i=c.getSortRestrictionsInfo(r);var o=t["@Org.OData.Capabilities.V1.FilterRestrictions"];var l=c.getFilterRestrictionsInfo(o);var p=f.getCustomData(e,"columns");var u={};var d=F(e.getModel().getMetaModel().getContext(n));p.customData.forEach(function(t){var r={name:t.path,label:t.label,sortable:S(i,t),filterable:B(l,t),maxConditions:_(l,t),typeConfig:f.isTypeFilterable(t.$Type)?e.getTypeUtil().getTypeConfig(t.$Type):undefined};var n=D(d,t.path);var o=n.targetObject;if(o){var p=n.navigationProperties.length?O(n,true):o.name;var c;if(f.isTypeFilterable(o.type)){var g;var v=j(o);c=(g=s.getTypeConfig(v.type,v.formatOptions,v.constraints))!==null&&g!==void 0?g:e.getTypeUtil().getTypeConfig(t.$Type)}var h=E(n);var y=Object.keys(h);if(y.length){r.propertyInfos=y;r.sortable=false;r.filterable=false;y.forEach(function(e){u[e]=h[e]});if(!y.find(function(e){return h[e]===o})){u[p]=o}}else{r.path=t.path}r.typeConfig=r.typeConfig?c:undefined}else{r.path=t.path}a.push(r)});var g=$(u,a,i,l);return a.concat(g)})};U.updateBindingInfo=function(e,t){d.updateBindingInfo.apply(this,[e,t]);if(!e){return}var a=e.getDelegate().payload;if(a&&t){t.path=t.path||a.collectionPath||"/".concat(a.collectionName);t.model=t.model||a.model}if(!t){t={}}var n=u.byId(e.getFilter()),o=e.isFilteringEnabled();var l;var p,s;var f=[];var c=e.data("$tablePropertyInfo");if(o){l=e.getConditions();p=v.getFilterInfo(e,l,c,[]);if(p.filters){f.push(p.filters)}}if(n){l=n.getConditions();if(l){var m=g.getParameterNames(n);U._updatePropertyInfo(c,e,l,a);s=v.getFilterInfo(n,l,c,m);if(s.filters){f.push(s.filters)}var b=g.getParametersInfo(n,l);if(b){t.path=b}}t.parameters.$search=r.normalizeSearchTerm(n.getSearch())||undefined}this._applyDefaultSorting(t,e.getDelegate().payload);t.parameters.$select=c.reduce(function(e,t){if(t.path&&t.path.indexOf("/")===-1){e=e?"".concat(e,",").concat(t.path):t.path}return e},"");t.parameters.$count=true;if(i.isDraftSupported(e.getModel().getMetaModel(),t.path)){f.push(new h("IsActiveEntity",y.EQ,true))}t.filters=new h(f,true)};U.getTypeUtil=function(){return s};U._getModel=function(e){var t=e.getDelegate().payload;return e.getModel(t.model)};U._applyDefaultSorting=function(e,t){if(e.parameters&&e.parameters.$search==undefined&&e.sorter&&e.sorter.length==0){var r=t?t.defaultSortPropertyName:undefined;if(r){e.sorter.push(new m(r,false))}}};U._updatePropertyInfo=function(e,t,r,a){var n=Object.keys(r),i=t.getModel().getMetaModel();n.forEach(function(r){if(e.findIndex(function(e){return e.path===r})===-1){var n={path:r,typeConfig:t.getTypeUtil().getTypeConfig(i.getObject("/".concat(a.collectionName,"/").concat(r)).$Type)};e.push(n)}})};U.updateBinding=function(r,a,n){var i=false;var o=r.getBindingContext("internal");var l="pendingManualBindingUpdate";var p=o===null||o===void 0?void 0:o.getProperty(l);var s=r.getRowBinding();d.updateBinding.apply(U,[r,a,n]);if(!s){s=r.getRowBinding()}if(s){var f=s.getFilters("Application");i=t(a.filters,f[0])&&s.getQueryOptionsFromParameters().$search===a.parameters.$search&&!p}if(i&&r.getFilter()){o===null||o===void 0?void 0:o.setProperty(l,true);s.requestRefresh(s.getGroupId()).finally(function(){o===null||o===void 0?void 0:o.setProperty(l,false)}).catch(function(t){e.error("Error while refreshing a filterBar VH table",t)})}r.fireEvent("bindingUpdated")};function $(e,t,r,a){var n={},i=[];Object.keys(e).forEach(function(o){var l=e[o],p=t.find(function(e){return e.path===o});if(!p){var c="Property::".concat(o);n[o]=c;var u={name:c,label:b(l),path:o,sortable:S(r,l),filterable:B(a,l)};u.maxConditions=_(a,u);if(f.isTypeFilterable(l.type)){var d=j(l);u.typeConfig=s.getTypeConfig(d.type,d.formatOptions,d.constraints)}i.push(u)}});t.forEach(function(e){if(e.propertyInfos){var t;e.propertyInfos=(t=e.propertyInfos)===null||t===void 0?void 0:t.map(function(e){var t;return(t=n[e])!==null&&t!==void 0?t:e})}});return i}function S(e,t){return t.path&&e[t.path]?e[t.path].sortable:t.sortable}function B(e,t){return t.path&&e[t.path]?e[t.path].filterable:t.filterable}function _(e,t){return t.path&&c.isMultiValueFilterExpression(e.propertyInfo[t.path])?-1:1}function R(e){var t=e.targetObject;var r=M(t)||I(t)||P(t)||C(t);if(!r){return undefined}var a=D(e,r);var n=a.targetObject;if(!n){return undefined}return a}return U},false);
//# sourceMappingURL=TableDelegate.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/macros/internal/valuehelp/ValueListHelper","sap/ui/core/Fragment","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/Device","sap/ui/dom/units/Rem","sap/ui/mdc/valuehelp/content/Conditions","sap/ui/mdc/valuehelp/content/MDCTable","sap/ui/mdc/valuehelp/content/MTable","sap/ui/model/json/JSONModel"],function(e,t,a,n,r,o,i,l,u,s,c,f){"use strict";var p=i.system;var d=e.Level;function v(e,t){var a=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=h(e))||t&&e&&typeof e.length==="number"){if(a)e=a;var n=0;var r=function(){};return{s:r,n:function(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o=true,i=false,l;return{s:function(){a=a.call(e)},n:function(){var e=a.next();o=e.done;return e},e:function(e){i=true;l=e},f:function(){try{if(!o&&a.return!=null)a.return()}finally{if(i)throw l}}}}function g(e){return P(e)||y(e)||h(e)||m()}function m(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function h(e,t){if(!e)return;if(typeof e==="string")return b(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);if(a==="Object"&&e.constructor)a=e.constructor.name;if(a==="Map"||a==="Set")return Array.from(e);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return b(e,t)}function y(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function P(e){if(Array.isArray(e))return b(e)}function b(e,t){if(t==null||t>e.length)t=e.length;for(var a=0,n=new Array(t);a<t;a++){n[a]=e[a]}return n}function C(e,t){try{var a=e()}catch(e){return t(e)}if(a&&a.then){return a.then(void 0,t)}return a}var I="@com.sap.vocabularies.Common.v1.Label",V="@com.sap.vocabularies.Common.v1.Text",L="@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement",T="com.sap.vocabularies.Common.v1.ValueListParameterIn",M="com.sap.vocabularies.Common.v1.ValueListParameterConstant",F="com.sap.vocabularies.Common.v1.ValueListParameterOut",$="com.sap.vocabularies.Common.v1.ValueListParameterInOut",S="@com.sap.vocabularies.Common.v1.ValueListWithFixedValues";var O={entityIsSearchable:function(e,t){var a,n;var r=(a=e["@com.sap.vocabularies.Common.v1.ValueList"])===null||a===void 0?void 0:a.SearchSupported,o=(n=t["@Org.OData.Capabilities.V1.SearchRestrictions"])===null||n===void 0?void 0:n.Searchable;if(o===undefined&&r===false||o===true&&r===false||o===false){return false}return true},_getConditionPath:function(e,t,a){var n=a.split("/");var r="",o;while(n.length){var i=n.shift();o=o?"".concat(o,"/").concat(i):i;var l=e.getObject("".concat(t,"/").concat(o));if(l&&l.$kind==="NavigationProperty"&&l.$isCollection){i+="*"}r=r?"".concat(r,"/").concat(i):i}return r},_getColumnDefinitionFromSelectionFields:function(e,a){var n=[],r=e.getObject("".concat(a,"/@")),o=r["@com.sap.vocabularies.UI.v1.SelectionFields"];if(o){o.forEach(function(r){var o="".concat(a,"/").concat(r.$PropertyPath),i=O._getConditionPath(e,a,r.$PropertyPath),l=e.getObject("".concat(o,"@")),u={path:i,label:l[I]||o,sortable:true,filterable:t.isPropertyFilterable(e,a,r.$PropertyPath,false),$Type:e.getObject(o).$Type};n.push(u)})}return n},_mergeColumnDefinitionsFromProperties:function(e,t,a,n,r){var o;var i=a,l=n.$Type;var u=r[I]||i,s=r[V];if(s&&((o=r[L])===null||o===void 0?void 0:o.$EnumMember)==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){i=s.$Path;var c="/".concat(t.CollectionPath,"/").concat(i);l=t.$model.getMetaModel().getObject(c).$Type}var f=e.findIndex(function(e){return e.path===i})===-1;if(f){var p={path:i,label:u,sortable:true,filterable:!r["@com.sap.vocabularies.UI.v1.HiddenFilter"],$Type:l};e.push(p)}},filterInOutParameters:function(e,t){return e.filter(function(e){return t.indexOf(e.parmeterType)>-1})},getInParameters:function(e){return O.filterInOutParameters(e,[T,M,$])},getOutParameters:function(e){return O.filterInOutParameters(e,[F,$])},createVHUIModel:function(e,t,a){var n=new f({}),r=a.getObject("".concat(t,"@"));e.setModel(n,"_VHUI");n.setProperty("/hasValueListRelevantQualifiers",!!r["@com.sap.vocabularies.Common.v1.ValueListRelevantQualifiers"]);return n},destroyVHContent:function(e){if(e.getDialog()){e.getDialog().destroyContent()}if(e.getTypeahead()){e.getTypeahead().destroyContent()}},putDefaultQualifierFirst:function(e){var t=e.indexOf("");if(t>0){e.unshift(e[t]);e.splice(t+1,1)}return e},getValueListInfo:function(t,a,n){try{var r=this;var o=t.getBindingContext(),i=n.conditionModel,l=t.getModel().getMetaModel(),u=[];var s=C(function(){return Promise.resolve(l.requestValueListInfo(a,true,o)).then(function(e){var s=e;var c=r.putDefaultQualifierFirst(Object.keys(s)),f=a.split("/").pop();var p="";if(n.useMultiValueField&&o&&o.getPath()){var d=o.getPath().split("/");var m=a.split("/");if(m.length-d.length>1){var h=[];for(var y=d.length;y<m.length-1;y++){h.push(m[y])}p="".concat(h.join("/"),"/")}}c.forEach(function(e){var a;var n=s[e],r=n.$model.getMetaModel(),c="/".concat(n.CollectionPath),d=O._getColumnDefinitionFromSelectionFields(r,c),m=[],h=(a=r.getObject(c+"/"))!==null&&a!==void 0&&a.$Key?g(r.getObject(c+"/").$Key):[];var y="",P="",b="";n.Parameters.forEach(function(e){var a="/".concat(n.CollectionPath,"/").concat(e.ValueListProperty),u=r.getObject(a),s=r.getObject("".concat(a,"@"))||{};if(u){if(!b&&(e.$Type===F||e.$Type===$)&&e.LocalDataProperty.$PropertyPath===f){var c;y=a;b=e.ValueListProperty;P=((c=s[V])===null||c===void 0?void 0:c.$Path)||""}var v=e.ValueListProperty;O._mergeColumnDefinitionsFromProperties(d,n,v,u,s)}if((e.$Type===T||e.$Type===$||e.$Type===F)&&e.LocalDataProperty.$PropertyPath!==f){var g="";if(i&&i.length>0){if(t.getParent().isA("sap.ui.mdc.Table")&&t.getBindingContext()&&(e.$Type===T||e.$Type===$)){var C=e.LocalDataProperty.$PropertyPath.split("/");if(C.length>1){var I=C[0];var L=l.getMetaContext(o.getPath());var S=t.getParent().getRowBinding().getPath();if(L.getObject("".concat(S,"/$Partner"))===I){g=e.LocalDataProperty.$PropertyPath.replace(I+"/","")}}}if(!g){g=i+">/conditions/"+e.LocalDataProperty.$PropertyPath}}else{g=p+e.LocalDataProperty.$PropertyPath}m.push({parmeterType:e.$Type,source:g,helpPath:e.ValueListProperty,constantValue:e.Constant,initialValueFilterEmpty:e.InitialValueIsSignificant})}if(e.$Type===M){m.push({parmeterType:e.$Type,source:e.ValueListProperty,helpPath:e.ValueListProperty,constantValue:e.Constant,initialValueFilterEmpty:e.InitialValueIsSignificant})}if((e.$Type===$||e.$Type===F)&&!h.includes(e.ValueListProperty)){h.push(e.ValueListProperty)}});var C=v(h),I;try{var L=function(){var e=I.value;if(d.findIndex(function(t){return t.path===e})===-1){var t={path:e,$Type:r.getObject("/".concat(n.CollectionPath,"/").concat(b)).$Type,label:"",sortable:false,filterable:undefined};d.push(t)}};for(C.s();!(I=C.n()).done;){L()}}catch(e){C.e(e)}finally{C.f()}var S={keyValue:b,descriptionValue:P,fieldPropertyPath:y,vhKeys:h,vhParameters:m,valueListInfo:n,columnDefs:d,valueHelpQualifier:e};u.push(S)})})},function(n){var r=n.status,o=r&&r===404?"Metadata not found (".concat(r,") for value help of property ").concat(a):n.message;e.error(o);O.destroyVHContent(t)});return Promise.resolve(s&&s.then?s.then(function(){return u}):u)}catch(e){return Promise.reject(e)}},ALLFRAGMENTS:undefined,logFragment:undefined,_logTemplatedFragments:function(t,a,n){var r={path:t,fragmentName:a,fragment:n};if(e.getLevel()===d.DEBUG){O.ALLFRAGMENTS=O.ALLFRAGMENTS||[];O.ALLFRAGMENTS.push(r)}if(O.logFragment){setTimeout(function(){O.logFragment(r)},0)}},_templateFragment:function(e,t,a,i,l){try{var u=t.valueListInfo,s=new f(u),c=u.$model.getMetaModel(),p=new f(Object.assign({converterType:"ListReport",columns:t.columnDefs||null},l));return Promise.resolve(Promise.resolve(r.process(o.loadTemplate(e,"fragment"),{name:e},{bindingContexts:{valueList:s.createBindingContext("/"),contextPath:c.createBindingContext("/".concat(u.CollectionPath,"/")),source:a.createBindingContext("/")},models:{valueList:s,contextPath:c,source:a,metaModel:c,viewData:p}}))).then(function(t){O._logTemplatedFragments(i,e,t);return Promise.resolve(n.load({definition:t}))})}catch(e){return Promise.reject(e)}},_getContentId:function(e,t,a){var n=a?"Popover":"Dialog";return"".concat(e,"::").concat(n,"::qualifier::").concat(t)},_addInOutParametersToPayload:function(e,t){var a=t.valueHelpQualifier;if(!e.qualifiers){e.qualifiers={}}if(!e.qualifiers[a]){e.qualifiers[a]={vhKeys:t.vhKeys,vhParameters:t.vhParameters}}},_getValueHelpColumnDisplayFormat:function(e,a){var n=t.computeDisplayMode(e,undefined),r=e&&e[V],o=r&&e[L];if(a){return r&&typeof r!=="string"&&r.$Path?n:"Value"}else{return o?n:"Value"}},_getWidthInRem:function(e,t){var a=e.$().width();if(t&&a){a=.3*a}var n=a?parseFloat(String(l.fromPx(a))):0;return isNaN(n)?0:n},getTableWidth:function(e,t){var a;var n=e.getColumns(),r=n&&n.filter(function(e){return e&&e.getVisible&&e.getVisible()})||[],o=r.reduce(function(e,t){a=t.getWidth();if(a&&a.endsWith("px")){a=String(l.fromPx(a))}var n=parseFloat(a);return e+(isNaN(n)?9:n)},r.length);return"".concat(Math.max(o,t),"em")},createValueHelpTypeahead:function(t,n,r,o,i){var l=r.getId(),u=n.getModel().getMetaModel().getObject("".concat(t,"@")),s=u[S]||false,c=false,p=a.getColumnVisibilityInfo(o.valueListInfo,t,s,c),d=new f({id:l,groupId:i.requestGroupId||undefined,bSuggestion:true,propertyPath:t,columnInfo:p,valueHelpWithFixedValues:s});r.setKeyPath(o.keyValue);r.setDescriptionPath(o.descriptionValue);i.isValueListWithFixedValues=s;var v=o.valueListInfo.$model.getMetaModel().getObject("/".concat(o.valueListInfo.CollectionPath,"@"))||{};r.setFilterFields(O.entityIsSearchable(u,v)?"$search":"");var g=r.getTable()||O._templateFragment("sap.fe.macros.internal.valuehelp.ValueListTable",o,d,t);return Promise.all([g]).then(function(a){var l=a[0];l.setModel(o.valueListInfo.$model);e.info("Value List- suggest Table XML content created [".concat(t,"]"),l.getMetadata().getName(),"MDC Templating");r.setTable(l);var u=n.getControl();if(u&&(u.isA("sap.ui.mdc.FilterField")||u.isA("sap.ui.mdc.Field")||u.isA("sap.ui.mdc.MultiValueField"))){var c=Boolean(i.isUnitValueHelp);var f=O.getTableWidth(l,O._getWidthInRem(u,c));l.setWidth(f);if(s){l.setMode(u.getMaxConditions()===1?"SingleSelectMaster":"MultiSelect")}else{l.setMode("SingleSelectMaster")}}})},createValueHelpDialog:function(e,t,n,r,o){var i=t.getModel().getMetaModel().getObject("".concat(e,"@")),l=false,u=true,s=a.getColumnVisibilityInfo(r.valueListInfo,e,l,u),c=new f({id:n.getId(),groupId:o.requestGroupId||undefined,bSuggestion:false,columnInfo:s,valueHelpWithFixedValues:l});n.setKeyPath(r.keyValue);n.setDescriptionPath(r.descriptionValue);var d=r.valueListInfo.$model.getMetaModel().getObject("/".concat(r.valueListInfo.CollectionPath,"@"))||{};n.setFilterFields(O.entityIsSearchable(i,d)?"$search":"");var v=n.getTable()||O._templateFragment("sap.fe.macros.internal.valuehelp.ValueListDialogTable",r,c,e,{enableAutoColumnWidth:!p.phone});var g=n.getFilterBar()||O._templateFragment("sap.fe.macros.internal.valuehelp.ValueListFilterBar",r,c,e);return Promise.all([v,g]).then(function(e){var a=e[0],o=e[1];a.setModel(r.valueListInfo.$model);o.setModel(r.valueListInfo.$model);n.setFilterBar(o);n.setTable(a);a.setFilter(o.getId());a.initialized();var i=t.getControl();if(i){a.setSelectionMode(i.getMaxConditions()===1?"Single":"Multi")}a.setWidth("100%");var l=a;l._setShowP13nButton(false)})},_getContentById:function(e,t){return e.find(function(e){return e.getId()===t})},_createPopoverContent:function(e,t){return new c({id:e,group:"group1",caseSensitive:t})},_createDialogContent:function(e,t,a){return new s({id:e,group:"group1",caseSensitive:t,forceBind:a})},showValueList:function(t,a,n){var r=a.getParent(),o=a.isTypeahead(),i=t.propertyPath,l=r.getModel().getMetaModel(),s=r.getModel("_VHUI")||O.createVHUIModel(r,i,l),c=r.data("showConditionPanel")&&r.data("showConditionPanel")!=="false";if(!t.qualifiers){t.qualifiers={}}s.setProperty("/isSuggestion",o);s.setProperty("/minScreenWidth",!o?"418px":undefined);return O.getValueListInfo(r,i,t).then(function(e){var l=r.getTypeahead().getContent()[0].getCaseSensitive();var s=a.getContent();if(o){var f=r.data("valuelistForValidation")||"";if(f===" "){f=""}var p=f?e.filter(function(e){return e.valueHelpQualifier===f})[0]:e[0];O._addInOutParametersToPayload(t,p);var d=O._getContentId(r.getId(),p.valueHelpQualifier,o);var v=O._getContentById(s,d);if(!v){v=O._createPopoverContent(d,l);a.insertContent(v,0);s=a.getContent()}else if(d!==s[0].getId()){a.removeContent(v);a.insertContent(v,0);s=a.getContent()}t.valueHelpQualifier=p.valueHelpQualifier;v.setTitle(p.valueListInfo.Label);return O.createValueHelpTypeahead(i,r,v,p,t)}else{for(var g=0;g<s.length;g+=1){s[g].setVisible(false)}if(c){var m=s.length&&s[s.length-1].getMetadata().getName()==="sap.ui.mdc.valuehelp.content.Conditions"?s[s.length-1]:undefined;if(m){m.setVisible(true)}else{m=new u;a.addContent(m);s=a.getContent()}}var h,y;for(var P=0;P<e.length;P+=1){var b=e[P],C=b.valueHelpQualifier;O._addInOutParametersToPayload(t,b);var I=O._getContentId(r.getId(),C,o);var V=O._getContentById(s,I);if(!V){var L=b.valueListInfo.FetchValues==2?false:true;V=O._createDialogContent(I,l,L);if(!c){a.addContent(V)}else{a.insertContent(V,s.length-1)}s=a.getContent()}else{V.setVisible(true)}V.setTitle(b.valueListInfo.Label);if(!y||n&&n===I){y=V;h=b}}if(!h||!y){throw new Error("selectedInfo or selectedContent undefined")}t.valueHelpQualifier=h.valueHelpQualifier;a.setTitle(h.valueListInfo.Label);return O.createValueHelpDialog(i,r,y,h,t)}}).catch(function(t){var a=t.status,n=a&&a===404?"Metadata not found (".concat(a,") for value help of property ").concat(i):t.message;e.error(n);O.destroyVHContent(r)})}};return O},false);
//# sourceMappingURL=ValueListHelperNew.js.map
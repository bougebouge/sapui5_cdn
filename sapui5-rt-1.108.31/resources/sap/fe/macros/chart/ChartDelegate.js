/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/macros/chart/ChartUtils","sap/fe/macros/CommonHelper","sap/fe/macros/filter/FilterUtils","sap/fe/macros/ODataMetaModelUtil","sap/ui/mdc/library","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/odata/v4/vizChart/ChartDelegate","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,a,r,n,o,i,s,l,c,g,f){"use strict";var u=s.ChartItemRoleType;var p=Object.assign({},c);p._setChartNoDataText=function(t,n){var o="";var i=r.getAllFilterInfo(t),s=n.path.startsWith("/")?n.path.substr(1):n.path;var l=function(){if(t.data("multiViews")){return"M_TABLE_AND_CHART_NO_DATA_TEXT_MULTI_VIEW"}else{return"T_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER"}};if(t.getFilter()){if(i.search||i.filters&&i.filters.length){o=l()}else{o="T_TABLE_AND_CHART_NO_DATA_TEXT"}}else if(i.search||i.filters&&i.filters.length){o=l()}else{o="M_TABLE_AND_CHART_NO_FILTERS_NO_DATA_TEXT"}return t.getModel("sap.fe.i18n").getResourceBundle().then(function(e){t.setNoDataText(a.getTranslatedText(o,e,null,s))}).catch(function(t){e.error(t)})};p._handleProperty=function(t,a,r,o,s,l){var c=n.parseCustomData(t.data("applySupported"));var g=a["@Org.OData.Capabilities.V1.SortRestrictions"]||{};var f=i.getSortRestrictionsInfo(g);var d=a["@Org.OData.Capabilities.V1.FilterRestrictions"];var h=i.getFilterRestrictionsInfo(d);var m=this.getModel().getObject(this.getPath());var v=this.getModel().getObject("".concat(this.getPath(),"@sapui.name"));var b=this.getModel();if(m&&m.$kind==="Property"){if(m.$isCollection){return}var _=b.getObject("".concat(this.getPath(),"@"));var C=b.getObject("@sapui.name",b.getMetaContext(this.getPath()));var y=c&&c.GroupableProperties;var T=c&&c.AggregatableProperties;var P=false,A=false;if(y&&y.length){for(var D=0;D<y.length;D++){if(y[D].$PropertyPath===C){P=true;break}}}if(T&&T.length){for(var x=0;x<T.length;x++){if(T[x].Property.$PropertyPath===C){A=true;break}}}if(!y||y&&!y.length){P=_["@Org.OData.Aggregation.V1.Groupable"]}if(!T||T&&!T.length){A=_["@Org.OData.Aggregation.V1.Aggregatable"]}if(!P&&!A){return}if(A){var I=p._createPropertyInfosForAggregatable(t,v,_,h,f,r,o);I.forEach(function(e){s.push(e)})}if(P){var O=v||"",M=_["@com.sap.vocabularies.Common.v1.Text"]?_["@com.sap.vocabularies.Common.v1.Text"].$Path:null;var S=false;if(O&&O.indexOf("/")>-1){e.error("$expand is not yet supported. Property: ".concat(O," from an association cannot be used"));return}if(M&&M.indexOf("/")>-1){e.error("$expand is not yet supported. Text Property: ".concat(M," from an association cannot be used"));S=true}s.push({name:"_fe_groupable_"+v,propertyPath:v,label:_["@com.sap.vocabularies.Common.v1.Label"]||v,sortable:p._getSortable(t,f[v],false),filterable:h[v]?h[v].filterable:true,groupable:true,aggregatable:false,maxConditions:i.isMultiValueFilterExpression(h.propertyInfo[v])?-1:1,sortKey:v,role:u.category,criticality:l,textProperty:!S&&_["@com.sap.vocabularies.Common.v1.Text"]?_["@com.sap.vocabularies.Common.v1.Text"].$Path:null,textFormatter:_["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"]})}}};p.formatText=function(e,t){var a=this.textFormatter;if(a.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst"){return"".concat(t," (").concat(e,")")}else if(a.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextLast"){return"".concat(e," (").concat(t,")")}else if(a.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){return t}return t?t:e};p.updateBindingInfo=function(e,t){p._setChartNoDataText(e,t);var i=sap.ui.getCore().byId(e.getFilter());if(i){var s=i.getConditions();if(s){if(!t){t={}}t.sorter=this.getSorters(e);var c=e.getControlDelegate().getInnerChart(e);var g;if(c){if(r.getChartSelectionsExist(e)){g=r.getAllFilterInfo(e)}}g=g?g:r.getFilterBarFilterInfo(e);if(g){t.filters=g.filters}var f=l.getParametersInfo(i,s);if(f){t.path=f}}var u=o.getFilterInfo(i,{});var d=n.parseCustomData(e.data("applySupported"));if(d&&d.enableSearch&&u.search){t.parameters.$search=a.normalizeSearchTerm(u.search)}else if(t.parameters.$search){delete t.parameters.$search}}else{if(!t){t={}}t.sorter=this.getSorters(e)}p._checkAndAddDraftFilter(e,t)};p.fetchProperties=function(e){var t=this;var a=this._getModel(e);var r;if(!a){r=new Promise(function(a){e.attachModelContextChange({resolver:a},d,t)}).then(function(a){return t._createPropertyInfos(e,a)})}else{r=this._createPropertyInfos(e,a)}return r.then(function(t){if(e.data){e.data("$mdcChartPropertyInfo",t)}return t})};function d(e,t){var a=e.getSource();var r=this._getModel(a);if(r){a.detachModelContextChange(d);t.resolver(r)}}p._createPropertyInfos=function(t,a){try{var r="/".concat(t.data("entitySet"));var o=a.getMetaModel();return Promise.resolve(Promise.all([o.requestObject("".concat(r,"/")),o.requestObject("".concat(r,"@"))])).then(function(a){var s=[];var l=a[0],c=a[1];var g=n.parseCustomData(t.data("customAgg"));var f;var u=[];for(var d in c){if(d.startsWith("@Org.OData.Aggregation.V1.CustomAggregate")){f=d.replace("@Org.OData.Aggregation.V1.CustomAggregate#","");var h=f.split("@");if(h.length==2&&h[1]=="com.sap.vocabularies.Common.v1.Label"){g[h[0]]=c[d]}}}var m=[],v=[];if(Object.keys(g).length>=1){var b=t.getItems();for(var _ in b){if(b[_].isA("sap.ui.mdc.chart.DimensionItem")){m.push(b[_].getKey())}else if(b[_].isA("sap.ui.mdc.chart.MeasureItem")){v.push(b[_].getKey())}}if(v.filter(function(e){return m.indexOf(e)!=-1}).length>=1){e.error("Dimension and Measure has the sameProperty Configured")}}var C=n.parseCustomData(t.data("transAgg"));var y={};for(var T in C){var P=C[T].propertyPath;y[P]=y[P]||{};y[P][C[T].aggregationMethod]={name:C[T].name,label:C[T].label}}for(var A in l){if(A.indexOf("$")!==0){u.push(i.fetchCriticality(o,o.createBindingContext("".concat(r,"/").concat(A))).then(p._handleProperty.bind(o.getMetaContext("".concat(r,"/").concat(A)),t,c,y,g,s)))}}return Promise.resolve(Promise.all(u)).then(function(){return s})})}catch(e){return Promise.reject(e)}};p._createPropertyInfosForAggregatable=function(e,a,r,n,o,s,l){var c=[];if(Object.keys(s).indexOf(a)>-1){for(var g in s[a]){c.push({name:"_fe_aggregatable_"+s[a][g].name,propertyPath:a,label:s[a][g].label||"".concat(r["@com.sap.vocabularies.Common.v1.Label"]," (").concat(g,")")||"".concat(a," (").concat(g,")"),sortable:o[a]?o[a].sortable:true,filterable:n[a]?n[a].filterable:true,groupable:false,aggregatable:true,aggregationMethod:g,maxConditions:i.isMultiValueFilterExpression(n.propertyInfo[a])?-1:1,role:u.axis1,datapoint:null})}}if(Object.keys(l).indexOf(a)>-1){for(var f in l){if(f===a){var p=t({},l[f],{name:"_fe_aggregatable_"+f,groupable:false,aggregatable:true,role:u.axis1,datapoint:null});c.push(p);break}}}return c};p.rebind=function(e,t){var a=t.parameters.$search;if(a){delete t.parameters.$search}c.rebind(e,t);if(a){var r=e.getControlDelegate().getInnerChart(e),n=r&&r.getBinding("data");n.suspend();n.setAggregation({search:a});var o={onBeforeRendering:function(){n.resume();r.removeEventDelegate(o)}};r.addEventDelegate(o)}e.fireEvent("bindingUpdated")};p._setChart=function(e,t){var a=e.getParent();t.setVizProperties(e.data("vizProperties"));t.detachSelectData(a.handleSelectionChange.bind(a));t.detachDeselectData(a.handleSelectionChange.bind(a));t.detachDrilledUp(a.handleSelectionChange.bind(a));t.attachSelectData(a.handleSelectionChange.bind(a));t.attachDeselectData(a.handleSelectionChange.bind(a));t.attachDrilledUp(a.handleSelectionChange.bind(a));t.setSelectionMode(e.getPayload().selectionMode.toUpperCase());c._setChart(e,t)};p._getBindingInfo=function(e){if(this._getBindingInfoFromState(e)){return this._getBindingInfoFromState(e)}var a=e.getDelegate().payload;var r=e.getModel()&&e.getModel().getMetaModel();var n=e.data("targetCollectionPath");var o=(r.getObject("".concat(n,"/$kind"))!=="NavigationProperty"?"/":"")+a.contextPath;var i=t({},a.parameters,{entitySet:e.data("entitySet"),useBatchRequests:true,provideGrandTotals:true,provideTotalResultSize:true,noPaging:true});return{path:o,events:{dataRequested:e.getParent().onInternalDataRequested.bind(e.getParent())},parameters:i}};p.removeItemFromInnerChart=function(e,t){c.removeItemFromInnerChart.call(this,e,t);if(t.getType()==="groupable"){var a=this._getChart(e);a.fireDeselectData()}};p._getSortable=function(e,t,a){if(a){if(e.data("draftSupported")==="true"){return false}else{return t?t.sortable:true}}return t?t.sortable:true};p._checkAndAddDraftFilter=function(e,t){if(e.data("draftSupported")==="true"){if(!t){t={}}if(!t.filters){t.filters=[]}t.filters.push(new g("IsActiveEntity",f.EQ,true))}};p.getInternalChartNameFromPropertyNameAndKind=function(e,t){return e.replace("_fe_"+t+"_","")};p.getPropertyFromNameAndKind=function(e,t,a){return a.getPropertyHelper().getProperty("_fe_"+t+"_"+e)};return p},false);
//# sourceMappingURL=ChartDelegate.js.map
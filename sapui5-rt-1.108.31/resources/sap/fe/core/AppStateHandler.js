/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/ToES6Promise","sap/fe/navigation/library","sap/ui/base/Object","./controllerextensions/BusyLocker","./helpers/ModelHelper"],function(t,e,n,o,r,a,i,p){"use strict";var s,u;var c=n.defineUI5Class;function l(t,e){try{var n=t()}catch(t){return e(t)}if(n&&n.then){return n.then(void 0,e)}return n}function f(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;v(t,e)}function v(t,e){v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,n){e.__proto__=n;return e};return v(t,e)}var h=r.NavType;var A=(s=c("sap.fe.core.AppStateHandler"),s(u=function(n){f(r,n);function r(e){var o;o=n.call(this)||this;o._mCurrentAppState={};o.oAppComponent=e;o.sId="".concat(e.getId(),"/AppStateHandler");o.bNoRouteChange=false;t.info("APPSTATE : Appstate handler initialized");return o}var a=r.prototype;a.getId=function t(){return this.sId};a.createAppState=function n(){try{var o=this;if(!o.oAppComponent.getEnvironmentCapabilities().getCapabilities().AppState||i.isLocked(o)){return Promise.resolve()}var r=o.oAppComponent.getNavigationService(),a=o.oAppComponent.getRouterProxy(),s=a.getHash(),u=o.oAppComponent.getRootControl().getController(),c=p.isStickySessionSupported(o.oAppComponent.getMetaModel());if(!u.viewState){throw new Error("viewState controller extension not available for controller: ".concat(u.getMetadata().getName()))}return Promise.resolve(u.viewState.retrieveViewState()).then(function(n){var i={appState:n};var p=function(){if(n&&!e(o._mCurrentAppState,n)){o._mCurrentAppState=n;var p=l(function(){return Promise.resolve(r.storeInnerAppStateAsync(i,true,true)).then(function(e){t.info("APPSTATE: Appstate stored");var n=r.replaceInnerAppStateKey(s,e);if(n!==s){a.navToHash(n,null,null,null,!c);o.bNoRouteChange=true}t.info("APPSTATE: navToHash")})},function(e){t.error(e)});if(p&&p.then)return p.then(function(){})}}();return p&&p.then?p.then(function(){return i}):i})}catch(t){return Promise.reject(t)}};a._createNavigationParameters=function t(e,n){return Object.assign({},e,{selectionVariantDefaults:e.oDefaultedSelectionVariant,selectionVariant:e.oSelectionVariant,requiresStandardVariant:!e.bNavSelVarHasDefaultsOnly,navigationType:n})};a.applyAppState=function e(){var n=this;if(!this.oAppComponent.getEnvironmentCapabilities().getCapabilities().AppState||i.isLocked(this)){return Promise.resolve()}i.lock(this);i.lock(this.oAppComponent.getRootControl());var r=this.oAppComponent.getNavigationService();return o(r.parseNavigation()).catch(function(e){if(!e){e=[]}t.warning("APPSTATE: Parse Navigation failed",e[0]);return[{},e[1],e[2]]}).then(function(e){t.info("APPSTATE: Parse Navigation done");var o=e[0]||{},r=e[2]||h.initial,a=n.oAppComponent.getRootControl().getController();n._mCurrentAppState=r===h.iAppState?o&&o.appState:undefined;if(!a.viewState){throw new Error("viewState extension required for controller ".concat(a.getMetadata().getName()))}if(!o&&r==h.iAppState){return{}}return a.viewState.applyViewState(n._mCurrentAppState,n._createNavigationParameters(o,r))}).catch(function(e){t.error("appState could not be applied",e);throw e}).finally(function(){i.unlock(n);i.unlock(n.oAppComponent.getRootControl())})};a.checkIfRouteChangedByIApp=function t(){return this.bNoRouteChange};a.resetRouteChangedByIApp=function t(){if(this.bNoRouteChange){this.bNoRouteChange=false}};a._isListBasedComponent=function t(e){return e.isA("sap.fe.templates.ListComponent")};return r}(a))||u);return A},true);
//# sourceMappingURL=AppStateHandler.js.map
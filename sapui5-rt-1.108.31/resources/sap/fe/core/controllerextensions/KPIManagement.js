/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/formatters/TableFormatterTypes","sap/m/Popover","sap/ui/core/Core","sap/ui/core/format/DateFormat","sap/ui/core/format/NumberFormat","sap/ui/core/Locale","sap/ui/core/mvc/ControllerExtension","sap/ui/model/Filter","sap/ui/model/json/JSONModel","sap/ui/model/Sorter","../helpers/ClassSupport"],function(e,t,a,n,i,r,o,s,c,l,u,d){"use strict";var f,p,g,m,v,h;var y=d.publicExtension;var P=d.methodOverride;var b=d.defineUI5Class;var D=t.MessageType;function C(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;I(e,t)}function I(e,t){I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,a){t.__proto__=a;return t};return I(e,t)}function N(e,t,a,n,i){var r={};Object.keys(n).forEach(function(e){r[e]=n[e]});r.enumerable=!!r.enumerable;r.configurable=!!r.configurable;if("value"in r||r.initializer){r.writable=true}r=a.slice().reverse().reduce(function(a,n){return n(e,t,a)||a},r);if(i&&r.initializer!==void 0){r.value=r.initializer?r.initializer.call(i):void 0;r.initializer=undefined}if(r.initializer===void 0){Object.defineProperty(e,t,r);r=null}return r}var T={1:D.Error,2:D.Warning,3:D.Success,5:D.Information};var S={Error:"Error",Warning:"Critical",Success:"Good",Information:"None",None:"None"};function j(e,t){var a;if(t[0]!==undefined&&t[0]!==null&&e<t[0]){a=D.Error}else if(t[1]!==undefined&&t[1]!==null&&e<t[1]){a=D.Warning}else if(t[2]!==undefined&&t[2]!==null&&e<t[2]){a=D.None}else if(t[5]!==undefined&&t[5]!==null&&e>t[5]){a=D.Error}else if(t[4]!==undefined&&t[4]!==null&&e>t[4]){a=D.Warning}else if(t[3]!==undefined&&t[3]!==null&&e>t[3]){a=D.None}else{a=D.Success}return a}function w(e,t){var a;if(t[2]!==undefined&&t[2]!==null&&e>t[2]){a=D.Error}else if(t[1]!==undefined&&t[1]!==null&&e>t[1]){a=D.Warning}else if(t[0]!==undefined&&t[0]!==null&&e>t[0]){a=D.None}else{a=D.Success}return a}function x(e,t){var a;if(t[0]!==undefined&&t[0]!==null&&e<t[0]){a=D.Error}else if(t[1]!==undefined&&t[1]!==null&&e<t[1]){a=D.Warning}else if(t[2]!==undefined&&t[2]!==null&&e<t[2]){a=D.None}else{a=D.Success}return a}function A(e){var t;switch(e){case 1:case"1":case 2:case"2":t="Up";break;case 4:case"4":case 5:case"5":t="Down";break;default:t="None"}return t}function F(e,t,a,n){var i;if(!n||a&&!t){return"None"}var r=a?(e-t)/t:e-t;if(n[0]!==undefined&&n[0]!==null&&r<=n[0]){i="Down"}else if(n[1]!==undefined&&n[1]!==null&&r<=n[1]){i="Down"}else if(n[3]!==undefined&&n[3]!==null&&r>=n[3]){i="Up"}else if(n[2]!==undefined&&n[2]!==null&&r>=n[2]){i="Up"}else{i="None"}return i}function V(e){if(e.ranges.length===0){return undefined}else if(e.ranges.length===1){return new c(e.propertyPath,e.ranges[0].operator,e.ranges[0].rangeLow,e.ranges[0].rangeHigh)}else{var t=e.ranges.map(function(t){return new c(e.propertyPath,t.operator,t.rangeLow,t.rangeHigh)});return new c({filters:t,and:false})}}function O(e){var t=new o(sap.ui.getCore().getConfiguration().getLanguage());var a=n.getLibraryResourceBundle("sap.fe.core");var r=i.getDateInstance({style:"medium"},t);function s(t){var n=e.propertyType.indexOf("Edm.Date")===0?r.format(new Date(t.rangeLow)):t.rangeLow;var i=e.propertyType.indexOf("Edm.Date")===0?r.format(new Date(t.rangeHigh)):t.rangeHigh;switch(t.operator){case"BT":return"[".concat(n," - ").concat(i,"]");case"Contains":return"*".concat(n,"*");case"GE":return"≥".concat(n);case"GT":return">".concat(n);case"LE":return"≤".concat(n);case"LT":return"<".concat(n);case"NB":return a.getText("C_KPICARD_FILTERSTRING_NOT",["[".concat(n," - ").concat(i,"]")]);case"NE":return"≠".concat(n);case"NotContains":return a.getText("C_KPICARD_FILTERSTRING_NOT",["*".concat(n,"*")]);case"EQ":default:return n}}if(e.ranges.length===0){return""}else if(e.ranges.length===1){return s(e.ranges[0])}else{return"(".concat(e.ranges.map(s).join(","),")")}}function E(e){var t=n.getLibraryResourceBundle("sap.fe.core");function a(e){if(e.length===0){return""}else if(e.length===1){return e[0].label}else{var a=e[0].label;for(var n=1;n<e.length-1;n++){a+=", ".concat(e[n].label)}return t.getText("C_KPICARD_ITEMSLIST",[a,e[e.length-1].label])}}return t.getText("C_KPICARD_CHARTTITLE",[a(e.chart.measures),a(e.chart.dimensions)])}function L(e,t){switch(e.chartType){case"Donut":t.categoryAxis={title:{visible:false}};t.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};t.plotArea.dataLabel={visible:true,type:"value",formatString:"ShortFloat_MFD2"};break;case"bubble":t.valueAxis={title:{visible:true},label:{formatString:"ShortFloat"}};t.valueAxis2={title:{visible:true},label:{formatString:"ShortFloat"}};t.legendGroup={layout:{position:"bottom",alignment:"topLeft"}};t.sizeLegend={visible:true};t.plotArea.dataLabel={visible:false};break;case"scatter":t.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};t.valueAxis2={title:{visible:false},label:{formatString:"ShortFloat"}};t.plotArea.dataLabel={visible:false};break;default:t.categoryAxis={title:{visible:false}};t.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};t.plotArea.dataLabel={visible:false}}}function M(e,t){if(t&&t.length){return e.filter(function(e){return t.indexOf(e.role)>=0}).map(function(e){return e.label})}else{return e.map(function(e){return e.label})}}function R(e){var t=M(e.measures,["Axis1"]);var a=M(e.measures,["Axis2"]);var n=M(e.measures,["Axis3"]);var i=M(e.measures,[undefined]);var r=M(e.dimensions,["Series"]);var o=e.dimensions.find(function(e){return e.role==="Category"});var s=t.shift()||a.shift()||n.shift()||i.shift()||"";var c=a.shift()||t.shift()||n.shift()||i.shift()||"";var l=[{uid:"valueAxis",type:"Measure",values:[s]},{uid:"valueAxis2",type:"Measure",values:[c]}];if(e.chartType==="bubble"){var u=n.shift()||t.shift()||a.shift()||i.shift()||"";l.push({uid:"bubbleWidth",type:"Measure",values:[u]})}if(r.length){l.push({uid:"color",type:"Dimension",values:r})}if(o){l.push({uid:"shape",type:"Dimension",values:[o.label]})}return l}function _(e){var t;switch(e.chartType){case"Donut":t=[{uid:"size",type:"Measure",values:M(e.measures)},{uid:"color",type:"Dimension",values:M(e.dimensions)}];break;case"bubble":case"scatter":t=R(e);break;case"vertical_bullet":t=[{uid:"actualValues",type:"Measure",values:M(e.measures,[undefined,"Axis1"])},{uid:"targetValues",type:"Measure",values:M(e.measures,["Axis2"])},{uid:"categoryAxis",type:"Dimension",values:M(e.dimensions,[undefined,"Category"])},{uid:"color",type:"Dimension",values:M(e.dimensions,["Series"])}];break;default:t=[{uid:"valueAxis",type:"Measure",values:M(e.measures)},{uid:"categoryAxis",type:"Dimension",values:M(e.dimensions,[undefined,"Category"])},{uid:"color",type:"Dimension",values:M(e.dimensions,["Series"])}]}return t}function K(e,t){if(e.semanticObject){if(e.action){return t.getLinks({semanticObject:e.semanticObject,action:e.action}).then(function(t){return t.length?{semanticObject:e.semanticObject,action:e.action}:undefined})}else{return t.getPrimaryIntent(e.semanticObject).then(function(a){if(!a){return undefined}var n=t.parseShellHash(a.intent);return e.unavailableActions&&e.unavailableActions.indexOf(n.action)>=0?undefined:{semanticObject:n.semanticObject,action:n.action}})}}else{return e.outboundNavigation?Promise.resolve({outbound:e.outboundNavigation}):Promise.resolve(undefined)}}var k=(f=b("sap.fe.core.controllerextensions.KPIManagement"),p=P(),g=P(),m=y(),f(v=(h=function(t){C(i,t);function i(){return t.apply(this,arguments)||this}var s=i.prototype;s.initCardManifest=function e(t,a){var i;var r={"sap.app":{id:"sap.fe",type:"card"},"sap.ui":{technology:"UI5"},"sap.card":{type:"Analytical",data:{json:{}},header:{type:"Numeric",title:t.datapoint.title,subTitle:t.datapoint.description,unitOfMeasurement:"{mainUnit}",mainIndicator:{number:"{mainValueNoScale}",unit:"{mainValueScale}",state:"{mainState}",trend:"{trend}"}},content:{minHeight:"25rem",chartProperties:{plotArea:{},title:{visible:true,alignment:"left"}},data:{path:"/chartData"}}}};if(t.datapoint.targetPath||t.datapoint.targetValue!==undefined){var o=n.getLibraryResourceBundle("sap.fe.core");r["sap.card"].header.sideIndicators=[{title:o.getText("C_KPICARD_INDICATOR_TARGET"),number:"{targetNumber}",unit:"{targetUnit}"},{title:o.getText("C_KPICARD_INDICATOR_DEVIATION"),number:"{deviationNumber}",unit:"%"}]}if((i=t.selectionVariantFilterDefinitions)!==null&&i!==void 0&&i.length){var s=[];t.selectionVariantFilterDefinitions.forEach(function(e){var t=O(e);if(t){s.push(t)}});if(s.length){r["sap.card"].header.details=s.join(", ")}}r["sap.card"].content.chartType=t.chart.chartType;L(t.chart,r["sap.card"].content.chartProperties);r["sap.card"].content.chartProperties.title.text=E(t);r["sap.card"].content.dimensions=t.chart.dimensions.map(function(e){return{label:e.label,value:"{".concat(e.name,"}")}});r["sap.card"].content.measures=t.chart.measures.map(function(e){return{label:e.label,value:"{".concat(e.name,"}")}});r["sap.card"].content.feeds=_(t.chart);a.setProperty("/".concat(t.id),{manifest:r})};s.initNavigationInfo=function e(t,a,n){if(t.navigation){return K(t.navigation,n).then(function(e){if(e){a.setProperty("/".concat(t.id,"/manifest/sap.card/header/actions"),[{type:"Navigation",parameters:e}])}})}else{return Promise.resolve()}};s.onInit=function t(){var a,n=this;this.aKPIDefinitions=(a=this.getView().getController()._getPageModel())===null||a===void 0?void 0:a.getProperty("/kpiDefinitions");if(this.aKPIDefinitions&&this.aKPIDefinitions.length){var i=this.getView();var r=i.getController().getAppComponent();var o=new l;i.setModel(o,"kpiModel");this.aKPIDefinitions.forEach(function(t){n.initCardManifest(t,o);n.initNavigationInfo(t,o,r.getShellServices()).catch(function(t){e.error(t)});n.loadKPITagData(t,r.getModel(),o).catch(function(t){e.error(t)})})}};s.onExit=function e(){var t=this.getView().getModel("kpiModel");if(t){t.destroy()}};s.updateDatapointValueAndCurrency=function e(t,a,n){var i,s,c;var l=new o(sap.ui.getCore().getConfiguration().getLanguage());var u=(i=t.datapoint.unit)!==null&&i!==void 0&&i.isPath?a.getProperty(t.datapoint.unit.value):(s=t.datapoint.unit)===null||s===void 0?void 0:s.value;var d=((c=t.datapoint.unit)===null||c===void 0?void 0:c.isCurrency)===false&&u==="%";var f=Number.parseFloat(a.getProperty(t.datapoint.propertyPath));var p=r.getFloatInstance({style:d?undefined:"short",minFractionDigits:0,maxFractionDigits:1,showScale:!d},l).format(f);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainValue"),p);var g=r.getFloatInstance({maxFractionDigits:2,showScale:false,groupingEnabled:true},l).format(f);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainValueUnscaled"),g);var m=r.getFloatInstance({style:d?undefined:"short",minFractionDigits:0,maxFractionDigits:1,showScale:false},l).format(f);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainValueNoScale"),m);var v=r.getFloatInstance({style:d?undefined:"short",decimals:0,maxIntegerDigits:0,showScale:true},l).format(f);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainValueScale"),v);if(t.datapoint.unit&&u){if(t.datapoint.unit.isCurrency){n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainUnit"),u)}else{var h=r.getUnitInstance({showNumber:false},l).format(f,u);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainUnit"),h)}}};s.updateDatapointCriticality=function e(t,a,n){var i=Number.parseFloat(a.getProperty(t.datapoint.propertyPath));var r=D.None;if(t.datapoint.criticalityValue){r=t.datapoint.criticalityValue}else if(t.datapoint.criticalityPath){r=T[a.getProperty(t.datapoint.criticalityPath)]||D.None}else if(t.datapoint.criticalityCalculationThresholds&&t.datapoint.criticalityCalculationMode){switch(t.datapoint.criticalityCalculationMode){case"UI.ImprovementDirectionType/Target":r=j(i,t.datapoint.criticalityCalculationThresholds);break;case"UI.ImprovementDirectionType/Minimize":r=w(i,t.datapoint.criticalityCalculationThresholds);break;case"UI.ImprovementDirectionType/Maximize":default:r=x(i,t.datapoint.criticalityCalculationThresholds);break}}n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainCriticality"),r);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainState"),S[r]||"None")};s.updateDatapointTrend=function e(t,a,n){var i=Number.parseFloat(a.getProperty(t.datapoint.propertyPath));var r="None";if(t.datapoint.trendValue){r=t.datapoint.trendValue}else if(t.datapoint.trendPath){r=A(a.getProperty(t.datapoint.trendPath))}else if(t.datapoint.trendCalculationReferenceValue!==undefined||t.datapoint.trendCalculationReferencePath){var o;if(t.datapoint.trendCalculationReferenceValue!==undefined){o=t.datapoint.trendCalculationReferenceValue}else{o=Number.parseFloat(a.getProperty(t.datapoint.trendCalculationReferencePath||""))}r=F(i,o,!!t.datapoint.trendCalculationIsRelative,t.datapoint.trendCalculationTresholds)}n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/trend"),r)};s.updateTargetValue=function e(t,a,n){if(t.datapoint.targetValue===undefined&&t.datapoint.targetPath===undefined){return}var i=Number.parseFloat(a.getProperty(t.datapoint.propertyPath));var s=new o(sap.ui.getCore().getConfiguration().getLanguage());var c;if(t.datapoint.targetValue!==undefined){c=t.datapoint.targetValue}else{c=Number.parseFloat(a.getProperty(t.datapoint.targetPath||""))}var l=c!==0?(i-c)/c*100:undefined;var u=r.getFloatInstance({style:"short",minFractionDigits:0,maxFractionDigits:1,showScale:false},s).format(c);var d=r.getFloatInstance({style:"short",decimals:0,maxIntegerDigits:0,showScale:true},s).format(c);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/targetNumber"),u);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/targetUnit"),d);if(l!==undefined){var f=r.getFloatInstance({minFractionDigits:0,maxFractionDigits:1,showScale:false},s).format(l);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/deviationNumber"),f)}else{n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/deviationNumber"),"N/A")}};s.loadKPITagData=function e(t,a,n,i){var r,o,s=this;var c=i?a.bindList("/".concat(t.entitySet)):a.bindList("/".concat(t.entitySet),undefined,undefined,undefined,{$$groupId:"$auto.LongRunners"});var l={};if((r=t.datapoint.unit)!==null&&r!==void 0&&r.isPath){l[t.datapoint.propertyPath]={unit:t.datapoint.unit.value}}else{l[t.datapoint.propertyPath]={}}if(t.datapoint.criticalityPath){l[t.datapoint.criticalityPath]={}}if(i){if(t.datapoint.trendPath){l[t.datapoint.trendPath]={}}if(t.datapoint.trendCalculationReferencePath){l[t.datapoint.trendCalculationReferencePath]={}}if(t.datapoint.targetPath){l[t.datapoint.targetPath]={}}}c.setAggregation({aggregate:l});if((o=t.selectionVariantFilterDefinitions)!==null&&o!==void 0&&o.length){var u=t.selectionVariantFilterDefinitions.map(V).filter(function(e){return e!==undefined});c.filter(u)}return c.requestContexts(0,1).then(function(e){if(e.length){var a,r;var o=(a=t.datapoint.unit)!==null&&a!==void 0&&a.isPath?e[0].getProperty(t.datapoint.unit.value):(r=t.datapoint.unit)===null||r===void 0?void 0:r.value;if(t.datapoint.unit&&!o){n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainValue"),"*");n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainValueUnscaled"),"*");n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainValueNoScale"),"*");n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainValueScale"),"");n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainUnit"),undefined);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainCriticality"),D.None);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/mainState"),"None");n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/trend"),"None");n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/targetNumber"),undefined);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/targetUnit"),undefined);n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/deviationNumber"),undefined)}else{s.updateDatapointValueAndCurrency(t,e[0],n);s.updateDatapointCriticality(t,e[0],n);if(i){s.updateDatapointTrend(t,e[0],n);s.updateTargetValue(t,e[0],n)}}}})};s.loadKPICardData=function e(t,a,n){var i;var r=a.bindList("/".concat(t.entitySet));var o={};var s={};t.chart.dimensions.forEach(function(e){o[e.name]={}});t.chart.measures.forEach(function(e){s[e.name]={}});r.setAggregation({group:o,aggregate:s});if((i=t.selectionVariantFilterDefinitions)!==null&&i!==void 0&&i.length){var c=t.selectionVariantFilterDefinitions.map(V).filter(function(e){return e!==undefined});r.filter(c)}if(t.chart.sortOrder){r.sort(t.chart.sortOrder.map(function(e){return new u(e.name,e.descending)}))}return r.requestContexts(0,t.chart.maxItems).then(function(e){var a=e.map(function(e){var a={};t.chart.dimensions.forEach(function(t){a[t.name]=e.getProperty(t.name)});t.chart.measures.forEach(function(t){a[t.name]=e.getProperty(t.name)});return a});n.setProperty("/".concat(t.id,"/manifest/sap.card/data/json/chartData"),a)})};s.getPopover=function e(t){var i=this;if(!this.oPopover){return new Promise(function(e,r){n.loadLibrary("sap/ui/integration",{async:true}).then(function(){sap.ui.require(["sap/ui/integration/widgets/Card","sap/ui/integration/Host"],function(n,r){var o=new r;o.attachAction(function(e){var t=e.getParameter("type");var a=e.getParameter("parameters");if(t==="Navigation"){if(a.semanticObject){i.getView().getController()._intentBasedNavigation.navigate(a.semanticObject,a.action)}else{i.getView().getController()._intentBasedNavigation.navigateOutbound(a.outbound)}}});i.oCard=new n({width:"25rem",height:"auto"});i.oCard.setHost(o);i.oPopover=new a("kpi-Popover",{showHeader:false,placement:"Auto",content:[i.oCard]});t.addDependent(i.oPopover);e(i.oPopover)})}).catch(function(){r()})})}else{return Promise.resolve(this.oPopover)}};s.onKPIPressed=function t(a,n){var i=this;var r=a.getModel("kpiModel");if(this.aKPIDefinitions&&this.aKPIDefinitions.length){var o=this.aKPIDefinitions.find(function(e){return e.id===n});if(o){var s=a.getModel();var c=[this.loadKPITagData(o,s,r,true),this.loadKPICardData(o,s,r),this.getPopover(a)];Promise.all(c).then(function(e){i.oCard.setManifest(r.getProperty("/".concat(n,"/manifest")));i.oCard.refresh();var t=e[2];t.openBy(a,false)}).catch(function(t){e.error(t)})}}};return i}(s),N(h.prototype,"onInit",[p],Object.getOwnPropertyDescriptor(h.prototype,"onInit"),h.prototype),N(h.prototype,"onExit",[g],Object.getOwnPropertyDescriptor(h.prototype,"onExit"),h.prototype),N(h.prototype,"onKPIPressed",[m],Object.getOwnPropertyDescriptor(h.prototype,"onKPIPressed"),h.prototype),h))||v);return k},false);
//# sourceMappingURL=KPIManagement.js.map
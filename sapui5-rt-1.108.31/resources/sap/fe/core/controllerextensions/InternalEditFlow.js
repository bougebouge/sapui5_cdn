/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/collaboration/ActivitySync","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/sticky","sap/fe/core/controllerextensions/editFlow/TransactionHelper","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/EditState","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/Text","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution"],function(e,t,r,o,n,i,a,s,c,p,u,l,d,f,g){"use strict";var y,h,v,m,P,S,w,O,M,b,D,C,E,A,k,T,_,I,x,R,j,H,N,B,F,V,G,L,U,z,K,W,$,q,J,X,Q,Y,Z,ee,te,re,oe,ne,ie,ae,se,ce,pe,ue;var le=s.publicExtension;var de=s.privateExtension;var fe=s.methodOverride;var ge=s.finalExtension;var ye=s.extensible;var he=s.defineUI5Class;var ve=n.Activity;var me=o.send;function Pe(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}function Se(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;we(e,t)}function we(e,t){we=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return we(e,t)}function Oe(e,t,r,o,n){var i={};Object.keys(o).forEach(function(e){i[e]=o[e]});i.enumerable=!!i.enumerable;i.configurable=!!i.configurable;if("value"in i||i.initializer){i.writable=true}i=r.slice().reverse().reduce(function(r,o){return o(e,t,r)||r},i);if(n&&i.initializer!==void 0){i.value=i.initializer?i.initializer.call(n):void 0;i.initializer=undefined}if(i.initializer===void 0){Object.defineProperty(e,t,i);i=null}return i}var Me=p.ProgrammingModel,be=p.DraftStatus,De=p.EditMode,Ce=p.CreationMode;var Ee=(y=he("sap.fe.core.controllerextensions.InternalEditFlow"),h=fe(),v=de(),m=ye(g.After),P=le(),S=ge(),w=le(),O=ge(),M=le(),b=ge(),D=le(),C=ge(),E=le(),A=ge(),k=le(),T=ge(),_=le(),I=ge(),x=le(),R=ge(),j=le(),H=ge(),N=le(),B=ge(),F=le(),V=ge(),G=le(),L=ge(),U=le(),z=ge(),K=le(),W=ge(),$=le(),q=ge(),J=le(),X=ge(),Q=le(),Y=ge(),Z=le(),ee=ge(),te=le(),re=ge(),oe=le(),ne=ge(),ie=le(),ae=ge(),se=le(),ce=ge(),y(pe=(ue=function(o){Se(n,o);function n(){return o.apply(this,arguments)||this}var s=n.prototype;s.onInit=function e(){this._oAppComponent=this.base.getAppComponent()};s.setCreationMode=function e(t){};s.createMultipleDocuments=function o(n,i,a,s,c){var p=this;var u=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;var l=this.getTransactionHelper(),d=this.getGlobalUIModel(),f=this.getView().getController().oResourceBundle;r.lock(d);var g=[];return this.syncTask().then(function(){return c?c({contextPath:n&&n.getPath()}):Promise.resolve()}).then(function(){var e=n.getModel(),t=e.getMetaModel();var r;if(n.getContext()){r=t.getMetaPath("".concat(n.getContext().getPath(),"/").concat(n.getPath()))}else{r=t.getMetaPath(n.getPath())}p.handleCreateEvents(n);var o=i.map(function(e){var o={data:{}};o.keepTransientContextOnFailed=false;o.busyMode="None";o.creationMode=Ce.CreationRow;o.parentControl=p.getView();o.createAtEnd=a;o.inactive=u;for(var i in e){var c=t.getObject("".concat(r,"/").concat(i));if(c&&c.$kind!=="NavigationProperty"&&e[i]){o.data[i]=e[i]}}return l.createDocument(n,o,f,p.getMessageHandler(),s,p.getView())});return Promise.all(o)}).then(function(e){g=e;return Promise.all(e.map(function(e){if(!e.bInactive){return e.created()}}))}).then(function(){var e=p.getView().getBindingContext();if(!t.hasTransientContext(n)){p._oAppComponent.getSideEffectsService().requestSideEffectsForNavigationProperty(n.getPath(),e)}}).catch(function(t){e.error("Error while creating multiple documents.");return Promise.reject(t)}).finally(function(){r.unlock(d)}).then(function(){return g})};s.deleteMultipleDocuments=function o(n,i){var a=this;var s=this.getGlobalUIModel();var p=this.getView().byId(i.controlId);if(!p){throw new Error("parameter controlId missing or incorrect")}else{i.parentControl=p}var u=p.getBinding("items")||p.getRowBinding();i.bFindActiveContexts=true;r.lock(s);return this.deleteDocumentTransaction(n,i).then(function(){var e;if(p.isA("sap.ui.mdc.Table")){p.clearSelection()}var r=a.getView().getBindingContext();if(u.isRoot()){e=new Promise(function(e){u.attachEventOnce("dataReceived",function(){e()})});u.refresh()}else if(r){if(!t.hasTransientContext(u)){a._oAppComponent.getSideEffectsService().requestSideEffectsForNavigationProperty(u.getPath(),r)}}if(!a._isFclEnabled()){c.setEditStateDirty()}me(a.getView(),ve.Delete,n.map(function(e){return e.getPath()}));return e}).catch(function(t){e.error("Error while deleting the document(s)",t)}).finally(function(){r.unlock(s)})};s.computeEditMode=function t(r){try{var o=this;var n=o.getInternalModel().getProperty("/sCustomAction");var i=o.getProgrammingModel(r);return Promise.resolve(function(){if(i===Me.Draft){return Pe(function(){o.setDraftStatus(be.Clear);return Promise.resolve(r.requestObject("IsActiveEntity")).then(function(e){var t=function(){if(e===false){o.setEditMode(De.Editable);return Promise.resolve(r.requestObject("HasActiveEntity")).then(function(e){o.setEditMode(undefined,!e)})}else{o.setEditMode(De.Display,false)}}();if(t&&t.then)return t.then(function(){})})},function(t){e.error("Error while determining the editMode for draft",t);throw t})}else if(i===Me.Sticky){if(n&&n!==""&&o._hasNewActionForSticky(r,o.getView(),n)){o.getTransactionHelper()._bCreateMode=true;o.getTransactionHelper().handleDocumentModifications();o.setEditMode(De.Editable,true);c.setEditStateDirty();o.handleStickyOn(r);o.getInternalModel().setProperty("/sCustomAction","")}}}())}catch(e){return Promise.reject(e)}};s.setEditMode=function e(t,r){var o=this.getGlobalUIModel();if(t){o.setProperty("/isEditable",t==="Editable",undefined,true)}if(r!==undefined){this.setCreationMode(r)}};s.setDraftStatus=function e(t){this.base.getView().getModel("ui").setProperty("/draftStatus",t,undefined,true)};s.getRoutingListener=function e(){if(this.base._routing){return this.base._routing}else{throw new Error("Edit Flow works only with a given routing listener")}};s.getGlobalUIModel=function e(){return this.base.getView().getModel("ui")};s.syncTask=function e(t){var r;if(t instanceof Promise){r=function(){return t}}else if(typeof t==="function"){r=t}this._pTasks=this._pTasks||Promise.resolve();if(r){this._pTasks=this._pTasks.then(r).catch(function(){return Promise.resolve()})}return this._pTasks};s.getProgrammingModel=function e(t){return this.getTransactionHelper().getProgrammingModel(t)};s.deleteDocumentTransaction=function e(t,r){var o,n=this;var i=this.getView().getController().oResourceBundle,a=this.getTransactionHelper();r=r||{};r.internalModelContext=r.controlId?(o=sap.ui.getCore().byId(r.controlId))===null||o===void 0?void 0:o.getBindingContext("internal"):null;return this.syncTask().then(a.deleteDocument.bind(a,t,r,i,this.getMessageHandler())).then(function(){var e=n.getInternalModel();e.setProperty("/sessionOn",false);e.setProperty("/stickySessionToken",undefined)}).catch(function(e){return Promise.reject(e)})};s.handleCreateEvents=function e(t){var r=this;var o=this.getTransactionHelper();this.setDraftStatus(be.Clear);t=t.getBinding&&t.getBinding()||t;var n=this.getProgrammingModel(t);t.attachEvent("createSent",function(){o.handleDocumentModifications();if(n===Me.Draft){r.setDraftStatus(be.Saving)}});t.attachEvent("createCompleted",function(e){var t=e.getParameter("success");if(n===Me.Draft){r.setDraftStatus(t?be.Saved:be.Clear)}r.getMessageHandler().showMessageDialog()})};s.getTransactionHelper=function e(){if(!this._oTransactionHelper){this._oTransactionHelper=new a(this._oAppComponent,this.getGlobalUIModel())}return this._oTransactionHelper};s.getInternalModel=function e(){return this.base.getView().getModel("internal")};s.createActionPromise=function e(t,r){var o=this;var n,i;this.oActionPromise=new Promise(function(e,t){n=e;i=t}).then(function(e){return Object.assign({controlId:r},o.getActionResponseDataAndKeys(t,e))});return{fResolver:n,fRejector:i}};s.getCurrentActionPromise=function e(){return this.oActionPromise};s.deleteCurrentActionPromise=function e(){this.oActionPromise=undefined};s.getActionResponseDataAndKeys=function e(t,r){if(Array.isArray(r)){if(r.length===1){r=r[0].value}else{return null}}if(!r){return null}var o=this.getView(),n=o.getModel().getMetaModel().getData(),i=n&&n[t]&&n[t][0]&&n[t][0].$ReturnType?n[t][0].$ReturnType.$Type:null,a=i&&n[i]?n[i].$Key:null;return{oData:r.getObject(),keys:a}};s.getMessageHandler=function e(){if(this.base.messageHandler){return this.base.messageHandler}else{throw new Error("Edit Flow works only with a given message handler")}};s.handleStickyOn=function r(o){var n=t.getAppComponent(this.getView());try{if(n===undefined||o===undefined){throw new Error("undefined AppComponent or Context for function handleStickyOn")}if(!n.getRouterProxy().hasNavigationGuard()){var i=n.getRouterProxy().getHash(),a=this.getInternalModel();setTimeout(function(){n.getRouterProxy().setNavigationGuard(o.getPath().substring(1))},0);n.getShellServices().setBackNavigation(this.onBackNavigationInSession.bind(this));this.fnDirtyStateProvider=this._registerDirtyStateProvider(n,a,i);n.getShellServices().registerDirtyStateProvider(this.fnDirtyStateProvider);var s=this.getView().getModel("sap.fe.i18n");this.fnHandleSessionTimeout=this._attachSessionTimeout(o,s);this.getView().getModel().attachSessionTimeout(this.fnHandleSessionTimeout);this.fnStickyDiscardAfterNavigation=this._attachRouteMatched(this,o,n);n.getRoutingService().attachRouteMatched(this.fnStickyDiscardAfterNavigation)}}catch(t){e.info(t);return undefined}return true};s.handleStickyOff=function r(){var o=t.getAppComponent(this.getView());try{if(o===undefined){throw new Error("undefined AppComponent for function handleStickyOff")}if(o&&o.getRouterProxy){o.getRouterProxy().discardNavigationGuard()}if(this.fnDirtyStateProvider){o.getShellServices().deregisterDirtyStateProvider(this.fnDirtyStateProvider);this.fnDirtyStateProvider=undefined}if(this.getView().getModel()&&this.fnHandleSessionTimeout){this.getView().getModel().detachSessionTimeout(this.fnHandleSessionTimeout)}o.getRoutingService().detachRouteMatched(this.fnStickyDiscardAfterNavigation);this.fnStickyDiscardAfterNavigation=undefined;this.getTransactionHelper()._bCreateMode=false;this.setEditMode(De.Display,false);if(o){o.getShellServices().setBackNavigation()}}catch(t){e.info(t);return undefined}return true};s.onBackNavigationInSession=function e(){var r=this;var o=this.getView(),n=t.getAppComponent(o),a=n.getRouterProxy();if(a.checkIfBackIsOutOfGuard()){var s=o&&o.getBindingContext();i.processDataLossConfirmation(function(){r.discardStickySession(s);history.back()},o,this.getProgrammingModel(s));return}history.back()};s.discardStickySession=function e(t){i.discardDocument(t);this.handleStickyOff()};s._hasNewActionForSticky=function t(r,o,n){try{if(r===undefined||o===undefined){throw new Error("Invalid input parameters for function _hasNewActionForSticky")}var i=o.getModel().getMetaModel(),a=r.getPath().substring(0,r.getPath().indexOf("(")),s=i.getObject("".concat(a,"@com.sap.vocabularies.Session.v1.StickySessionSupported"));if(s&&s.NewAction&&s.NewAction===n){return true}else if(s&&s.AdditionalNewActions){return n===s.AdditionalNewActions.find(function(e){return e===n})?true:false}else{return false}}catch(t){e.info(t);return undefined}};s._registerDirtyStateProvider=function t(r,o,n){return function t(i){try{if(i===undefined){throw new Error("Invalid input parameters for function fnDirtyStateProvider")}var a=i.innerAppRoute,s=r.getRouterProxy();var c="";var p;var u=o.getProperty("/sessionOn");if(!u){return undefined}if(!s.isNavigationFinalized()){p=false;c=a}else if(n===a){p=true}else if(s.checkHashWithGuard(a)||s.isGuardCrossAllowedByUser()){c=a;p=false}else{p=true}if(p){setTimeout(function(){r.getShellServices().setDirtyFlag(false)},0)}else{n=c}return p}catch(t){e.info(t);return undefined}}};s._attachSessionTimeout=function t(r,o){var n=this;return function(){try{if(r===undefined){throw new Error("Context missing for function fnHandleSessionTimeout")}n.getMessageHandler().removeTransitionMessages();var t=new l({title:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_TITLE}",state:"Warning",content:new d({text:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_MESSAGE}"}),beginButton:new u({text:"{sap.fe.i18n>C_COMMON_DIALOG_OK}",type:"Emphasized",press:function(){n.handleStickyOff();n.getRoutingListener().navigateBackFromContext(r)}}),afterClose:function(){t.destroy()}});t.addStyleClass("sapUiContentPadding");t.setModel(o,"sap.fe.i18n");n.getView().addDependent(t);t.open()}catch(t){e.info(t);return undefined}return true}};s._attachRouteMatched=function e(t,r,o){return function e(){var n=o.getRouterProxy().getHash();if(!n||!o.getRouterProxy().checkHashWithGuard(n)){t.discardStickySession(r)}}};s.scrollAndFocusOnInactiveRow=function e(t){var r=t.getRowBinding();var o=r.getCount()||0;if(o>0){t.scrollToIndex(o-1);t.focusRow(o,true)}else{t.focusRow(o,true)}};s._isFclEnabled=function e(){return this.base.getAppComponent()._isFclEnabled()};return n}(f),Oe(ue.prototype,"onInit",[h],Object.getOwnPropertyDescriptor(ue.prototype,"onInit"),ue.prototype),Oe(ue.prototype,"setCreationMode",[v,m],Object.getOwnPropertyDescriptor(ue.prototype,"setCreationMode"),ue.prototype),Oe(ue.prototype,"createMultipleDocuments",[P,S],Object.getOwnPropertyDescriptor(ue.prototype,"createMultipleDocuments"),ue.prototype),Oe(ue.prototype,"deleteMultipleDocuments",[w,O],Object.getOwnPropertyDescriptor(ue.prototype,"deleteMultipleDocuments"),ue.prototype),Oe(ue.prototype,"computeEditMode",[M,b],Object.getOwnPropertyDescriptor(ue.prototype,"computeEditMode"),ue.prototype),Oe(ue.prototype,"setEditMode",[D,C],Object.getOwnPropertyDescriptor(ue.prototype,"setEditMode"),ue.prototype),Oe(ue.prototype,"setDraftStatus",[E,A],Object.getOwnPropertyDescriptor(ue.prototype,"setDraftStatus"),ue.prototype),Oe(ue.prototype,"getRoutingListener",[k,T],Object.getOwnPropertyDescriptor(ue.prototype,"getRoutingListener"),ue.prototype),Oe(ue.prototype,"getGlobalUIModel",[_,I],Object.getOwnPropertyDescriptor(ue.prototype,"getGlobalUIModel"),ue.prototype),Oe(ue.prototype,"syncTask",[x,R],Object.getOwnPropertyDescriptor(ue.prototype,"syncTask"),ue.prototype),Oe(ue.prototype,"getProgrammingModel",[j,H],Object.getOwnPropertyDescriptor(ue.prototype,"getProgrammingModel"),ue.prototype),Oe(ue.prototype,"deleteDocumentTransaction",[N,B],Object.getOwnPropertyDescriptor(ue.prototype,"deleteDocumentTransaction"),ue.prototype),Oe(ue.prototype,"handleCreateEvents",[F,V],Object.getOwnPropertyDescriptor(ue.prototype,"handleCreateEvents"),ue.prototype),Oe(ue.prototype,"getTransactionHelper",[G,L],Object.getOwnPropertyDescriptor(ue.prototype,"getTransactionHelper"),ue.prototype),Oe(ue.prototype,"getInternalModel",[U,z],Object.getOwnPropertyDescriptor(ue.prototype,"getInternalModel"),ue.prototype),Oe(ue.prototype,"createActionPromise",[K,W],Object.getOwnPropertyDescriptor(ue.prototype,"createActionPromise"),ue.prototype),Oe(ue.prototype,"getCurrentActionPromise",[$,q],Object.getOwnPropertyDescriptor(ue.prototype,"getCurrentActionPromise"),ue.prototype),Oe(ue.prototype,"deleteCurrentActionPromise",[J,X],Object.getOwnPropertyDescriptor(ue.prototype,"deleteCurrentActionPromise"),ue.prototype),Oe(ue.prototype,"getActionResponseDataAndKeys",[Q,Y],Object.getOwnPropertyDescriptor(ue.prototype,"getActionResponseDataAndKeys"),ue.prototype),Oe(ue.prototype,"getMessageHandler",[Z,ee],Object.getOwnPropertyDescriptor(ue.prototype,"getMessageHandler"),ue.prototype),Oe(ue.prototype,"handleStickyOn",[te,re],Object.getOwnPropertyDescriptor(ue.prototype,"handleStickyOn"),ue.prototype),Oe(ue.prototype,"handleStickyOff",[oe,ne],Object.getOwnPropertyDescriptor(ue.prototype,"handleStickyOff"),ue.prototype),Oe(ue.prototype,"onBackNavigationInSession",[ie,ae],Object.getOwnPropertyDescriptor(ue.prototype,"onBackNavigationInSession"),ue.prototype),Oe(ue.prototype,"discardStickySession",[se,ce],Object.getOwnPropertyDescriptor(ue.prototype,"discardStickySession"),ue.prototype),ue))||pe);return Ee},false);
//# sourceMappingURL=InternalEditFlow.js.map
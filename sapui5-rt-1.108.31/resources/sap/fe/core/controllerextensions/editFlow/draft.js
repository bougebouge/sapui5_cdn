/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/ActivitySync","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/m/Text","sap/ui/core/Core","../../operationsHelper","./draftDataLossPopup"],function(e,t,r,n,o,i,a,c,s,u,f){"use strict";function l(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}var v=function(e,t,r,n){try{function a(r){var i=false;function a(t){return i?t:o.fnAfterActivateDocument?o.fnAfterActivateDocument(e,c):c}if(!r){throw new Error("Activation of the document was aborted by extension for document: ".concat(e.getPath()))}var c;var s=function(){if(!b(e)){return Promise.resolve(m(e,t)).then(function(e){c=e})}else{var r="draft";var o=O.executeDraftPreparationAction(e,r,false);e.getModel().submitBatch(r);var i=O.executeDraftActivationAction(e,t,r);return l(function(){return Promise.resolve(Promise.all([o,i])).then(function(e){c=e[1]})},function(t){function i(){throw t}var a=x(e);var c=function(){if(a){o=O.executeDraftPreparationAction(e,r,true);e.getModel().submitBatch(r);return Promise.resolve(o).then(function(){return Promise.resolve(e.requestObject()).then(function(t){if(t[a].length>0){n===null||n===void 0?void 0:n.removeTransitionMessages(false,false,e.getPath())}})})}}();return c&&c.then?c.then(i):i(c)})}}();return s&&s.then?s.then(a):a(s)}var o=r||{};if(!e){throw new Error("Binding context to draft document is required")}var i=o.fnBeforeActivateDocument;return Promise.resolve(i?Promise.resolve(o.fnBeforeActivateDocument(e)).then(a):a(true))}catch(c){return Promise.reject(c)}};var d=function(e,u,f){try{var v=false;var d=function(r){try{var o=false;function c(t){if(o)return t;throw new Error("Draft creation aborted for document: ".concat(e.getPath()))}var i=function(){if(r){var i=e.getModel();var c=i.bindContext("".concat(e.getPath(),"/DraftAdministrativeData")).getBoundContext();return Promise.resolve(f.oView.getModel("sap.fe.i18n").getResourceBundle()).then(function(r){return Promise.resolve(c.requestObject()).then(function(i){return function(){if(i){n.removeUnboundTransitionMessages();var c=i.InProcessByUserDescription||i.InProcessByUser;var s=f.oView.getViewData().entitySet;if(c){var u=t.getTranslatedText("C_DRAFT_OBJECT_PAGE_DRAFT_LOCKED_BY_USER",r,c,s);a.error(u);throw new Error(u)}else{c=i.CreatedByUserDescription||i.CreatedByUser;var l=t.getTranslatedText("C_DRAFT_OBJECT_PAGE_DRAFT_UNSAVED_CHANGES",r,c,s);return Promise.resolve(D(l)).then(function(){var t=E(e,false,f.oView);o=true;return t})}}}()})})}}();return Promise.resolve(i&&i.then?i.then(c):c(i))}catch(s){return Promise.reject(s)}};function D(t){return new Promise(function(r,n){var a=new i({title:h.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_WARNING"),state:"Warning",content:new c({text:t}),beginButton:new o({text:h.getText("C_COMMON_OBJECT_PAGE_EDIT"),type:"Emphasized",press:function(){a.close();r(true)}}),endButton:new o({text:h.getText("C_COMMON_OBJECT_PAGE_CANCEL"),press:function(){a.close();n("Draft creation aborted for document: ".concat(e.getPath()))}}),afterClose:function(){a.destroy()}});a.addStyleClass("sapUiContentPadding");a.open()})}var g=f||{},h=s.getLibraryResourceBundle("sap.fe.core"),m=typeof g.bPreserveChanges==="undefined"||typeof g.bPreserveChanges==="boolean"&&g.bPreserveChanges;if(!e){throw new Error("Binding context to active document is required")}var P=g.fnBeforeCreateDraftFromActiveDocument?g.fnBeforeCreateDraftFromActiveDocument(e,m):true;if(!P){throw new Error("Draft creation was aborted by extension for document: ".concat(e.getPath()))}return Promise.resolve(l(function(){function t(t){if(v)return t;o=o&&g.fnAfterCreateDraftFromActiveDocument?g.fnAfterCreateDraftFromActiveDocument(e,o):o;if(o){var r;var n=p(o,A.EDIT);var i=u.getSideEffectsService().getODataActionSideEffects(n,o);if(i!==null&&i!==void 0&&(r=i.triggerActions)!==null&&r!==void 0&&r.length){return Promise.resolve(u.getSideEffectsService().requestSideEffectsForODataAction(i,o)).then(function(){return o})}else{return o}}else{return undefined}}var o;var i=l(function(){return Promise.resolve(O.executeDraftEditAction(e,m,f.oView)).then(function(e){o=e})},function(t){return function(){if(m&&t.status===409){n.removeBoundTransitionMessages();n.removeUnboundTransitionMessages();return function(){if(r.isCollaborationEnabled(f.oView)){return Promise.resolve(O.computeSiblingInformation(e,e)).then(function(e){if(e!==null&&e!==void 0&&e.targetContext){var r=e.targetContext;v=true;return r}else{throw new Error(t)}})}else{return Promise.resolve(d(g.fnWhenDecisionToOverwriteDocumentIsRequired?g.fnWhenDecisionToOverwriteDocumentIsRequired():true)).then(function(e){o=e})}}()}else if(!(t&&t.canceled)){throw new Error(t)}}()});return i&&i.then?i.then(t):t(i)},function(e){throw e}))}catch(C){return Promise.reject(C)}};var g=function(t,r){try{if(!r.getPath().startsWith(t.getPath())){e.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}if(r.getProperty("IsActiveEntity")===false&&r.getProperty("HasActiveEntity")===false){return Promise.resolve(undefined)}var n=t.getModel();return Promise.resolve(l(function(){var e=r.getPath().replace(t.getPath(),"");var o=e?e.substring(1).split("/"):[];o.unshift(t.getPath().substring(1));var i=[];var a=[];var c="";var s=o.map(function(e){c+="/".concat(e);i.unshift(c);if(c.endsWith(")")){var t=n.bindContext("".concat(c,"/SiblingEntity")).getBoundContext();return t.requestCanonicalPath()}else{return Promise.resolve(undefined)}});return Promise.resolve(Promise.all(s)).then(function(e){var t=e;var r="";t.forEach(function(e,t){if(t!==0){if(o[t].endsWith(")")){var n=o[t].replace(/\(.*$/,"");var i=e.replace(/.*\(/,"(");r+="/".concat(n).concat(i)}else{r+="/".concat(o[t])}}else{r=e}a.unshift(r)});return{targetContext:n.bindContext(r).getBoundContext(),pathMapping:i.map(function(e,t){return{oldPath:e,newPath:a[t]}})}})},function(){return undefined}))}catch(e){return Promise.reject(e)}};var h=function(e,r,n){try{if(!e.getProperty("IsActiveEntity")){function i(r){var i="direct";var a=t.getTranslatedText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON",r);var c=!n?o.execute(i):o.execute(i,undefined,u.fnOnStrictHandlingFailed.bind(O,i,{label:a,model:e.getModel()},r,null,null,null,undefined),false);e.getModel().submitBatch(i);return c}var o=O.createOperation(e,A.DISCARD);return Promise.resolve(r?Promise.resolve(r.getModel("sap.fe.i18n").getResourceBundle()).then(i):i(r))}else{throw new Error("The discard action cannot be executed on an active document")}}catch(a){return Promise.reject(a)}};var m=function(r,n,o){try{var i=b(r);var a=i;if(!r.getProperty("IsActiveEntity")){var c=D(r,A.ACTIVATION,{$$inheritExpandSelect:true});return Promise.resolve(n.getModel("sap.fe.i18n").getResourceBundle()).then(function(s){var f=t.getTranslatedText("C_OP_OBJECT_PAGE_SAVE",s);return l(function(){return Promise.resolve(c.execute(o,a,o?u.fnOnStrictHandlingFailed.bind(O,o,{label:f,model:r.getModel()},s,null,null,null,undefined):undefined,r.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")))},function(t){function o(){throw t}var a=function(){if(i){var t=p(r,A.PREPARE),o=n.getSideEffectsService(),a=o.getODataActionSideEffects(t,r),c=a&&a.pathExpressions;var s=function(){if(c&&c.length>0){var t=l(function(){return Promise.resolve(o.requestSideEffects(c,r)).then(function(){})},function(t){e.error("Error while requesting side effects",t)});if(t&&t.then)return t.then(function(){})}else{var n=l(function(){return Promise.resolve(M(r,o)).then(function(){})},function(t){e.error("Error while requesting messages",t)});if(n&&n.then)return n.then(function(){})}}();if(s&&s.then)return s.then(function(){})}}();return a&&a.then?a.then(o):o(a)})})}else{throw new Error("The activation action cannot be executed on an active document")}}catch(e){return Promise.reject(e)}};var P=function(t,r){try{if(O.getMessagesPath(t)&&O.hasPrepareAction(t)){return Promise.resolve(O.executeDraftPreparationAction(t,t.getUpdateGroupId(),true).then(function(e){if(e&&!C(t,A.PREPARE)){var n=r.getSideEffectsService();M(t,n)}return e}).catch(function(t){e.error("Error while requesting messages",t)}))}return Promise.resolve(undefined)}catch(e){return Promise.reject(e)}};var E=function(e,r,n){try{if(e.getProperty("IsActiveEntity")){var o={$$inheritExpandSelect:true};var i=D(e,A.EDIT,o);i.setParameter("PreserveChanges",r);var a="direct";return Promise.resolve(n.getModel("sap.fe.i18n").getResourceBundle()).then(function(r){var n=t.getTranslatedText("C_COMMON_OBJECT_PAGE_EDIT",r);var o=i.execute(a,undefined,u.fnOnStrictHandlingFailed.bind(O,a,{label:n,model:e.getModel()},r,null,null,null,undefined),e.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding"));i.getModel().submitBatch(a);return Promise.resolve(o)})}else{throw new Error("You cannot edit this draft document")}}catch(e){return Promise.reject(e)}};var A={EDIT:"EditAction",ACTIVATION:"ActivationAction",DISCARD:"DiscardAction",PREPARE:"PreparationAction"};function p(e,t){var r=e.getModel(),n=r.getMetaModel(),o=n.getMetaPath(e.getPath());return n.getObject("".concat(o,"@com.sap.vocabularies.Common.v1.DraftRoot/").concat(t))}function D(e,t,r){var n=p(e,t);return e.getModel().bindContext("".concat(n,"(...)"),e,r)}function C(e,t){var r=e.getModel(),n=r.getMetaModel(),o=n.getMetaPath(e.getPath());return n.getObject("".concat(o,"@com.sap.vocabularies.Common.v1.DraftRoot/").concat(t,"/$ReturnType"))}function b(e){return!!p(e,A.PREPARE)}function x(e){var t=e.getModel().getMetaModel();var r=t.getMetaPath(e.getPath());var n=C(e,A.PREPARE);return!!n?t.getObject("".concat(r,"/@").concat("com.sap.vocabularies.Common.v1.Messages","/$Path")):null}function T(t,r,n){if(!t.getProperty("IsActiveEntity")){var o=n?x(t):null;var i=D(t,A.PREPARE,o?{$select:o}:null);i.setParameter("SideEffectsQualifier","");var a=r||i.getGroupId();return i.execute(a).then(function(){return i}).catch(function(t){e.error("Error while executing the operation",t)})}else{throw new Error("The preparation action cannot be executed on an active document")}}function w(e){var t=e.getModel(),r=t.getMetaModel(),n=r.getMetaPath(e.getPath());return r.getObject("".concat(n,"/@com.sap.vocabularies.Common.v1.Messages/$Path"))}function M(e,t){var r=O.getMessagesPath(e);if(r){return t.requestSideEffects([{$PropertyPath:r}],e)}return Promise.resolve()}function y(e,t,r){var n=p(e,A.DISCARD),o=e.getObject().IsActiveEntity;if(o||!o&&!n){if(e.hasPendingChanges()){return e.getBinding().resetChanges().then(function(){return e.delete()}).catch(function(e){return Promise.reject(e)})}else{return e.delete()}}else{return h(e,t,r)}}var O={createDraftFromActiveDocument:d,activateDocument:v,deleteDraft:y,executeDraftEditAction:E,executeDraftValidation:P,executeDraftPreparationAction:T,executeDraftActivationAction:m,hasPrepareAction:b,getMessagesPath:w,computeSiblingInformation:g,processDataLossOrDraftDiscardConfirmation:f.processDataLossOrDraftDiscardConfirmation,silentlyKeepDraftOnForwardNavigation:f.silentlyKeepDraftOnForwardNavigation,createOperation:D,executeDraftDiscardAction:h,NavigationType:f.NavigationType};return O},false);
//# sourceMappingURL=draft.js.map
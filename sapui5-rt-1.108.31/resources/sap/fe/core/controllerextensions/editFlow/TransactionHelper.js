/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controllerextensions/editFlow/operations","sap/fe/core/controllerextensions/editFlow/sticky","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/library","sap/m/Button","sap/m/CheckBox","sap/m/Dialog","sap/m/MessageBox","sap/m/MessageToast","sap/m/Popover","sap/m/Text","sap/m/VBox","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","../../helpers/ToES6Promise"],function(e,t,n,r,o,a,i,s,c,l,u,f,d,C,g,v,h,_,E,m,T,p,P,x,b){"use strict";function O(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}function A(e,t){try{var n=e()}catch(e){return t(true,e)}if(n&&n.then){return n.then(t.bind(null,false),t.bind(null,true))}return t(false,n)}function N(e,t,n){if(!e.s){if(n instanceof D){if(n.s){if(t&1){t=n.s}n=n.v}else{n.o=N.bind(null,e,t);return}}if(n&&n.then){n.then(N.bind(null,e,t),N.bind(null,e,2));return}e.s=t;e.v=n;var r=e.o;if(r){r(e)}}}var D=function(){function e(){}e.prototype.then=function(t,n){var r=new e;var o=this.s;if(o){var a=o&1?t:n;if(a){try{N(r,1,a(this.v))}catch(e){N(r,2,e)}return r}else{return this}}this.o=function(e){try{var o=e.v;if(e.s&1){N(r,1,t?t(o):o)}else if(n){N(r,1,n(o))}else{N(r,2,o)}}catch(e){N(r,2,e)}};return r};return e}();function I(e,t){var n=-1;var r;e:{for(var o=0;o<t.length;o++){var a=t[o][0];if(a){var i=a();if(i&&i.then){break e}if(i===e){n=o;break}}else{n=o}}if(n!==-1){do{var s=t[n][1];while(!s){n++;s=t[n][1]}var c=s();if(c&&c.then){r=true;break e}var l=t[n][2];n++}while(l&&!l());return c}}var u=new D;var f=N.bind(null,u,2);(r?c.then(C):i.then(d)).then(void 0,f);return u;function d(r){for(;;){if(r===e){n=o;break}if(++o===t.length){if(n!==-1){break}else{N(u,1,s);return}}a=t[o][0];if(a){r=a();if(r&&r.then){r.then(d).then(void 0,f);return}}else{n=o}}do{var i=t[n][1];while(!i){n++;i=t[n][1]}var s=i();if(s&&s.then){s.then(C).then(void 0,f);return}var c=t[n][2];n++}while(c&&!c());N(u,1,s)}function C(e){for(;;){var r=t[n][2];if(!r||r()){break}n++;var o=t[n][1];while(!o){n++;o=t[n][1]}e=o();if(e&&e.then){e.then(C).then(void 0,f);return}}N(u,1,e)}}var S=l.CreationMode;var M=l.ProgrammingModel;var L=T.ValueState;function R(e){if(e&&e.getMetadata&&e.getMetadata().getName()==="sap.ui.base.Event"){e={}}return e||{}}var y=function(){function N(e,t){this._bIsModified=false;this._bCreateMode=false;this._bContinueDiscard=false;this._oAppComponent=e;this.oLockObject=t}var D=N.prototype;D.getProgrammingModel=function e(t){if(!this.sProgrammingModel&&t){var n;if(t.isA("sap.ui.model.odata.v4.Context")){n=t.getPath()}else{n=t.isRelative()?t.getResolvedPath():t.getPath()}if(c.isDraftSupported(t.getModel().getMetaModel(),n)){this.sProgrammingModel=M.Draft}else if(c.isStickySessionSupported(t.getModel().getMetaModel())){this.sProgrammingModel=M.Sticky}else{return M.NonDraft}}return this.sProgrammingModel};D.validateDocument=function e(t,n,r){var o=n&&n.customValidationFunction;if(o){var a=o.substring(0,o.lastIndexOf(".")||-1).replace(/\./gi,"/"),i=o.substring(o.lastIndexOf(".")+1,o.length),c=n.data;delete c["@$ui5.context.isTransient"];return s.validationWrapper(a,i,c,r,t)}return Promise.resolve([])};D.createDocument=function r(a,i,s,u){var f=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;var d=arguments.length>5?arguments[5]:undefined;try{var C=false;var g=this;var v=a.getModel(),h=v.getMetaModel(),_=h.getMetaPath(a.getHeaderContext().getPath()),m=g._getAppComponent().getRouterProxy().getHash(),T=g._getAppComponent().getComponentData(),p=T&&T.startupParameters||{},P=!a.isRelative()?g._getNewAction(p,m,h,_):undefined;var x={$$patchWithoutSideEffects:true};var N=h.getObject("".concat(_,"/@com.sap.vocabularies.Common.v1.Messages/$Path"));var D="/busy";var I=h.getObject("".concat(_,"@com.sap.vocabularies.Common.v1.DefaultValuesFunction"))||h.getObject("".concat(c.getTargetEntitySet(h.getContext(_)),"@com.sap.vocabularies.Common.v1.DefaultValuesFunction"));var L;var y;if(I){if(h.getObject("".concat(_,"@com.sap.vocabularies.Common.v1.DefaultValuesFunction"))&&c.getTargetEntitySet(h.getContext(_))!==_){L=true}else{L=false}}if(N){x["$select"]=N}var w=R(i);if(!a){throw new Error("Binding required for new document creation")}var B=g.getProgrammingModel(a);if(B!==M.Draft&&B!==M.Sticky){throw new Error("Create document only allowed for draft or sticky session supported services")}if(w.busyMode==="Local"){D="/busyLocal/".concat(w.busyId)}w.beforeCreateCallBack=f?null:w.beforeCreateCallBack;n.lock(g.oLockObject,D);var k=E.getLibraryResourceBundle("sap.fe.core");var H;return Promise.resolve(A(function(){return O(function(){function n(e){if(C)return e;if(!a.isRelative()){g._bCreateMode=true}y=y||H;if(r){g.handleDocumentModifications()}return Promise.resolve(u.showMessageDialog()).then(function(){return y})}var r=false;var i=function(){if(P){r=true;return Promise.resolve(g.callAction(P,{contexts:a.getHeaderContext(),showActionParameterDialog:true,label:g._getSpecificCreateActionDialogLabel(h,_,P,k),bindingParameters:x,parentControl:w.parentControl,bIsCreateAction:true,skipParameterDialog:w.skipParameterDialog},null,u)).then(function(e){H=e})}else{var n=w.creationMode!==S.CreationRow&&w.creationMode!==S.Inline;var i=n?t.getNonComputedVisibleFields(h,_,d):[];I=f?null:I;var s,c;if(I){if(L){s=a.getContext()&&"".concat(h.getMetaPath(a.getContext().getPath()),"/").concat(I);c=a.getContext()}else{s=a.getHeaderContext()&&"".concat(h.getMetaPath(a.getHeaderContext().getPath()),"/").concat(I);c=a.getHeaderContext()}}var l=s&&h.createBindingContext(s);return O(function(){function t(e){if(C)return e;w.data=n?Object.assign({},n,w.data):w.data;if(w.data){delete w.data["@odata.context"]}var t=function(){if(i.length>0){return Promise.resolve(g._launchDialogWithKeyFields(a,i,v,w,u)).then(function(e){H=e;y=H.newContext})}else{function t(){y=a.create(w.data,true,w.createAtEnd,w.inactive);var e=function(){if(!w.inactive){return Promise.resolve(g.onAfterCreateCompletion(a,y,w)).then(function(e){H=e})}}();if(e&&e.then)return e.then(function(){})}var e=function(){if(w.beforeCreateCallBack){return Promise.resolve(b(w.beforeCreateCallBack({contextPath:a&&a.getPath()}))).then(function(){})}}();return e&&e.then?e.then(t):t(e)}}();if(t&&t.then)return t.then(function(){})}var n;var r=O(function(){return Promise.resolve(l&&l.getObject()&&l.getObject()[0].$IsBound?o.callBoundFunction(I,c,v):o.callFunctionImport(I,v)).then(function(e){if(e){n=e.getObject()}})},function(t){e.error("Error while executing the function ".concat(I),t);throw t});return r&&r.then?r.then(t):t(r)},function(t){e.error("Error while creating the new document",t);throw t})}}();return i&&i.then?i.then(n):n(i)},function(e){return Promise.resolve(u.showMessageDialog()).then(function(){var t;if((e===l.Constants.ActionExecutionFailed||e===l.Constants.CancelActionDialog)&&(t=y)!==null&&t!==void 0&&t.isTransient()){y.delete("$direct")}throw e})})},function(e,t){n.unlock(g.oLockObject,D);if(e)throw t;return t}))}catch(e){return Promise.reject(e)}};D.findActiveDraftRootContexts=function e(t,n){if(!n){return Promise.resolve()}var r=t.reduce(function(e,t){var n=t.getModel().getMetaModel();var r=n.getMetaPath(t.getPath());if(n.getObject("".concat(r,"@com.sap.vocabularies.Common.v1.DraftRoot"))){var o=t.getObject().IsActiveEntity,a=t.getObject().HasActiveEntity;if(!o&&a){var i=t.getModel().bindContext("".concat(t.getPath(),"/SiblingEntity")).getBoundContext();e.push(i)}}return e},[]);return Promise.all(r.map(function(e){return e.requestCanonicalPath().then(function(){return e})}))};D.afterDeleteProcess=function e(n,r,o,a){var i=n.internalModelContext;if(i&&i.getProperty("deleteEnabled")!=undefined){if(r.isCheckBoxVisible===true&&r.isCheckBoxSelected===false){i.setProperty("deleteEnabled",true);var s=Object.assign(i.getObject(),{});s.selectedContexts=s.selectedContexts.filter(function(e){return s.deletableContexts.indexOf(e)===-1});s.deletableContexts=[];s.selectedContexts=[];s.numberOfSelectedContexts=s.selectedContexts.length;i.setProperty("",s)}else{i.setProperty("deleteEnabled",false);i.setProperty("selectedContexts",[]);i.setProperty("numberOfSelectedContexts",0)}}if(o.length===1){g.show(t.getTranslatedText("C_TRANSACTION_HELPER_DELETE_TOAST_SINGULAR",a,null,n.entitySetName))}else{g.show(t.getTranslatedText("C_TRANSACTION_HELPER_DELETE_TOAST_PLURAL",a,null,n.entitySetName))}};D.deleteDocument=function e(o,a,s,c){var l=this;var g=[],v=false,m=false,T=false,p,P=false;var x=this,b=E.getLibraryResourceBundle("sap.fe.core");var N;var D={title:b.getText("C_COMMON_DELETE")};n.lock(this.oLockObject);var I;if(Array.isArray(o)){I=o}else{I=[o]}return new Promise(function(e,o){try{var E=l.getProgrammingModel(I[0]);if(a){if(!a.numberOfSelectedContexts){if(E===M.Draft){for(var S=0;S<I.length;S++){var L=I[S].getObject();if(L.IsActiveEntity===true&&L.HasDraftEntity===true&&L.DraftAdministrativeData&&L.DraftAdministrativeData.InProcessByUser&&!L.DraftAdministrativeData.DraftIsCreatedByMe){var y="";var w=L&&L.DraftAdministrativeData;if(w){y=w["InProcessByUser"]}N=[y];C.show(t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_SINGLE_OBJECT_LOCKED",s,N),{title:b.getText("C_COMMON_DELETE"),onClose:o});return}}}a=R(a);if(a.title){if(a.description){N=[a.title+" ",a.description]}else{N=[a.title,""]}D.text=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO",s,N,a.entitySetName)}else{D.text=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",s,null,a.entitySetName)}g=I}else{D={title:b.getText("C_COMMON_DELETE")};if(a.numberOfSelectedContexts===1&&a.numberOfSelectedContexts===I.length){g=I;var B=I[0].getObject();var k=a.parentControl;var H=k&&k.getParent().getIdentifierColumn();if(H){var F=H?B[H]:undefined;var j=a.description&&a.description.path?B[a.description.path]:undefined;if(F){if(j&&a.description&&H!==a.description.path){N=[F+" ",j]}else{N=[F,""]}D.text=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO",s,N,a.entitySetName)}else if(F){N=[F,""];D.text=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO",s,N,a.entitySetName)}else{D.text=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",s,null,a.entitySetName)}}else{D.text=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",s,null,a.entitySetName)}}else if(a.numberOfSelectedContexts===1&&a.unSavedContexts.length===1){g=a.unSavedContexts;var U=g[0].getObject()["DraftAdministrativeData"];var W="";if(U){W=U["LastChangedByUserDescription"]||U["LastChangedByUser"]||""}N=[W];D.text=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",s,N)}else if(a.numberOfSelectedContexts===a.unSavedContexts.length){g=a.unSavedContexts;D.text=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_CHANGES_MULTIPLE_OBJECTS",s)}else if(a.numberOfSelectedContexts===I.concat(a.unSavedContexts.concat(a.lockedContexts)).length){g=I.concat(a.unSavedContexts);D.text=g.length===1?t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",s,null,a.entitySetName):t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL",s,null,a.entitySetName)}else{g=I.concat(a.unSavedContexts);T=true;D.text=g.length===1?t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR_NON_DELETABLE",s,null,a.entitySetName):t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL_NON_DELETABLE",s,[g.length],a.entitySetName);D.nonDeletableText=x._getNonDeletableText(a,I,s)}if(a.lockedContexts.length==1){m=true;D.nonDeletableText=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_ONE_OBJECT_LOCKED",s,[a.numberOfSelectedContexts])}if(a.lockedContexts.length>1){m=true;D.nonDeletableText=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",s,[a.lockedContexts.length,a.numberOfSelectedContexts])}if(a.unSavedContexts.length>0&&a.unSavedContexts.length!==a.numberOfSelectedContexts){if((T||m)&&g.length===a.unSavedContexts.length){v=false;g=a.unSavedContexts;if(a.unSavedContexts.length===1){D.text=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_SINGULAR",s)}else{D.text=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_PLURAL",s)}}else{if(a.unSavedContexts.length===1){D.checkBoxText=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_SINGULAR",s)}else{D.checkBoxText=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_PLURAL",s)}v=true}}if(T&&m){var V=x._getNonDeletableText(a,I,s);if(a.unSavedContexts.length>1){D.nonDeletableText=V+" "+t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",s,[a.lockedContexts.length,a.numberOfSelectedContexts])}if(a.unSavedContexts.length==1){D.nonDeletableText=V+" "+t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_ONE_OBJECT_LOCKED",s,[a.numberOfSelectedContexts])}}}}var J,G;var K=new _({items:[J=new h({text:D.nonDeletableText,visible:m||T}),G=new h({text:D.text}),new f({text:D.checkBoxText,selected:true,select:function(e){var t=e.getSource().getSelected();if(t){g=I.concat(a.unSavedContexts);p=true}else{g=I;p=false}},visible:v})]});var q=b.getText("C_COMMON_DELETE");var $=function(){try{P=true;n.lock(x.oLockObject);var t=g;return Promise.resolve(A(function(){return O(function(){function n(){return Promise.resolve(x.findActiveDraftRootContexts(t,a.bFindActiveContexts)).then(function(n){var o=false;function i(r){if(o)return r;var i={isCheckBoxVisible:v,isCheckBoxSelected:p};var l=function(){if(n&&n.length){return Promise.resolve(Promise.all(n.map(function(e){return e.delete()}))).then(function(){x.afterDeleteProcess(a,i,t,s);return Promise.resolve(c.showMessageDialog()).then(function(){e()})})}else{x.afterDeleteProcess(a,i,t,s);return Promise.resolve(c.showMessageDialog()).then(function(){e()})}}();if(l&&l.then)return l.then(function(){})}var l=O(function(){return Promise.resolve(Promise.all(t.map(function(e){var n=t.length===1?true:false;return r.deleteDraft(e,x._oAppComponent,n)}))).then(function(){})},function(e){return Promise.resolve(c.showMessages()).then(function(){throw e})});return l&&l.then?l.then(i):i(l)})}var o=function(){if(a.beforeDeleteCallBack){return Promise.resolve(a.beforeDeleteCallBack({contexts:t})).then(function(){})}}();return o&&o.then?o.then(n):n(o)},function(){o()})},function(e,t){n.unlock(x.oLockObject);if(e)throw t;return t}))}catch(e){return Promise.reject(e)}};var z=new d({title:q,state:"Warning",content:[K],ariaLabelledBy:J.getVisible()?[J,G]:G,beginButton:new u({text:b.getText("C_COMMON_DELETE"),type:"Emphasized",press:function(){i.removeBoundTransitionMessages();z.close();$()}}),endButton:new u({text:t.getTranslatedText("C_COMMON_DIALOG_CANCEL",s),press:function(){z.close()}}),afterClose:function(){z.destroy();if(!P){o()}}});if(a.noDialog){$()}else{z.addStyleClass("sapUiContentPadding");z.open()}}finally{n.unlock(x.oLockObject)}})};D.editDocument=function e(t,o,i){try{var s=this;var c=s;var l=s.getProgrammingModel(t);if(!t){throw new Error("Binding context to active document is required")}if(l!==M.Draft&&l!==M.Sticky){throw new Error("Edit is only allowed for draft or sticky session supported services")}s._bIsModified=false;n.lock(c.oLockObject);i.removeTransitionMessages();return Promise.resolve(A(function(){return O(function(){return Promise.resolve(l===M.Draft?r.createDraftFromActiveDocument(t,s._getAppComponent(),{bPreserveChanges:true,oView:o}):a.editDocumentInStickySession(t,s._getAppComponent())).then(function(e){s._bCreateMode=false;return Promise.resolve(i.showMessageDialog()).then(function(){return e})})},function(e){return Promise.resolve(i.showMessages({concurrentEditFlag:true})).then(function(){throw e})})},function(e,t){n.unlock(c.oLockObject);if(e)throw t;return t}))}catch(e){return Promise.reject(e)}};D.cancelDocument=function e(t,o,i,s){try{var c=this;if(!t){throw new Error("No context exists. Pass a meaningful context")}n.lock(c.oLockObject);var l=R(o);var u=t.getModel();var f=c.getProgrammingModel(t);return Promise.resolve(A(function(){return O(function(){function e(){function e(){function e(){var e=false,o=false;function i(t){if(e)return t;c._bIsModified=false;s.removeTransitionMessages();return Promise.resolve(s.showMessages()).then(function(){return n})}var l=I(f,[[function(){return M.Draft},function(){return Promise.resolve(t.requestObject("HasActiveEntity")).then(function(e){function a(){o=true}var i=function(){if(!e){if(t&&t.hasPendingChanges()){t.getBinding().resetChanges()}return Promise.resolve(r.deleteDraft(t,c._oAppComponent)).then(function(e){n=e})}else{var o=u.bindContext("".concat(t.getPath(),"/SiblingEntity")).getBoundContext();var a=A(function(){return Promise.resolve(o.requestCanonicalPath()).then(function(e){if(t&&t.hasPendingChanges()){t.getBinding().resetChanges()}n=u.bindContext(e).getBoundContext()})},function(e,n){return Promise.resolve(r.deleteDraft(t,c._oAppComponent)).then(function(){if(e)throw n;return n})});if(a&&a.then)return a.then(function(){})}}();return i&&i.then?i.then(a):a(i)})}],[function(){return M.Sticky},function(){return Promise.resolve(a.discardDocument(t)).then(function(e){if(e){if(e.hasPendingChanges()){e.getBinding().resetChanges()}if(!c._bCreateMode){e.refresh();n=e}}o=true})}],[void 0,function(){throw new Error("Cancel document only allowed for draft or sticky session supported services")}]]);return l&&l.then?l.then(i):i(l)}if(t.isKeepAlive()){t.setKeepAlive(true,undefined)}var o=function(){if(l.beforeCancelCallBack){return Promise.resolve(l.beforeCancelCallBack({context:t})).then(function(){})}}();return o&&o.then?o.then(e):e(o)}var o=function(){if(!l.skipDiscardPopover){return Promise.resolve(c._showDiscardPopover(l.cancelButton,c._bIsModified,i)).then(function(){})}}();return o&&o.then?o.then(e):e(o)}var n=false;var o=function(){if(f===M.Draft&&!c._bIsModified){var e=u.bindContext("".concat(t.getPath(),"/DraftAdministrativeData")).getBoundContext();return Promise.resolve(e.requestObject()).then(function(e){if(e){c._bIsModified=!(e.CreationDateTime===e.LastChangeDateTime)}})}}();return o&&o.then?o.then(e):e(o)},function(e){return Promise.resolve(s.showMessages()).then(function(){throw e})})},function(e,t){n.unlock(c.oLockObject);if(e)throw t;return t}))}catch(e){return Promise.reject(e)}};D.saveDocument=function e(o,s,c,l,u){try{var f=this;if(!o){return Promise.reject(new Error("Binding context to draft document is required"))}var d=f.getProgrammingModel(o);if(d!==M.Sticky&&d!==M.Draft){throw new Error("Save is only allowed for draft or sticky session supported services")}u.removeTransitionMessages();return Promise.resolve(A(function(){return O(function(){n.lock(f.oLockObject);return Promise.resolve(d===M.Draft?r.activateDocument(o,f._getAppComponent(),{},u):a.activateDocument(o,f._getAppComponent())).then(function(e){var n=d===M.Sticky?f._bCreateMode:!o.getObject().HasActiveEntity;var r=i.getMessages().concat(i.getMessages(true,true));if(!(r.length===1&&r[0].type===T.MessageType.Success)){g.show(n?t.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_CREATED",s):t.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_SAVED",s))}f._bIsModified=false;return e})},function(e){if(l&&l.length>0){l.forEach(function(e){if(!t.hasTransientContext(e)&&c){var n=f._getAppComponent();n.getSideEffectsService().requestSideEffectsForNavigationProperty(e.getPath(),o)}})}return Promise.resolve(u.showMessages()).then(function(){throw e})})},function(e,t){n.unlock(f.oLockObject);if(e)throw t;return t}))}catch(e){return Promise.reject(e)}};D.callAction=function e(t,r,a,i){try{var s=this;r=R(r);var c=s;var l,u;var f=r.bindingParameters;if(!t){throw new Error("Provide name of action to be executed")}var d=t.split("/")[1];t=d||t;l=d?undefined:r.contexts;if(l&&(Array.isArray(l)&&l.length||!Array.isArray(l))){l=Array.isArray(l)?l[0]:l;u=l.getModel()}if(r.model){u=r.model}if(!u){throw new Error("Pass a context for a bound action or pass the model for an unbound action")}var C=c._getAppComponent();var g=C.getSideEffectsService().getODataActionSideEffects(t,l)||{};var v=function(){if(!r.notApplicableContext||r.notApplicableContext.length===0){return Promise.resolve(r.contexts)}return new Promise(function(e,t){try{var n=function(e){var t;var n=r.notApplicableContext.length,o=[];for(var a=0;a<r.notApplicableContext.length;a++){t=r.notApplicableContext[a].getObject();o.push(t)}var i=new x(o);var s=new x({total:n,label:r.label});e.setModel(i,"notApplicable");e.setModel(s,"totals");e.open()};var o="sap.fe.core.controls.ActionPartial";var a=P.loadTemplate(o,"fragment");var i=u.getMetaModel();var s=r.contexts[0].getCanonicalPath();var c="".concat(s.substr(0,s.indexOf("(")),"/");var l=new x({title:r.label});var f=O(function(){return Promise.resolve(p.process(a,{name:o},{bindingContexts:{entityType:i.createBindingContext(c),label:l.createBindingContext("/")},models:{entityType:i,metaModel:i,label:l}})).then(function(t){var o;var a={onClose:function(){o.close();e()},onContinue:function(){o.close();e(r.applicableContext)}};return Promise.resolve(m.load({definition:t,controller:a})).then(function(t){o=t;a.onClose=function(){o.close();e()};a.onContinue=function(){o.close();e(r.applicableContext)};r.parentControl.addDependent(o);n(o)})})},function(e){t(e)});return Promise.resolve(f&&f.then?f.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})};return Promise.resolve(O(function(){function e(){return Promise.resolve(s._handleActionResponse(i,r,t)).then(function(){return a})}var a;var d=function(){if(l&&u){return Promise.resolve(v()).then(function(e){var s=function(){if(e){return Promise.resolve(o.callBoundAction(t,e,u,C,{parameterValues:r.parameterValues,invocationGrouping:r.invocationGrouping,label:r.label,skipParameterDialog:r.skipParameterDialog,mBindingParameters:f,entitySetName:r.entitySetName,additionalSideEffect:g,onSubmitted:function(){i.removeTransitionMessages();n.lock(c.oLockObject)},onResponse:function(){n.unlock(c.oLockObject)},parentControl:r.parentControl,controlId:r.controlId,internalModelContext:r.internalModelContext,operationAvailableMap:r.operationAvailableMap,bIsCreateAction:r.bIsCreateAction,bGetBoundContext:r.bGetBoundContext,bObjectPage:r.bObjectPage,messageHandler:i,defaultValuesExtensionFunction:r.defaultValuesExtensionFunction,selectedItems:r.contexts})).then(function(e){a=e})}else{a=null}}();if(s&&s.then)return s.then(function(){})})}else{return Promise.resolve(o.callActionImport(t,u,C,{parameterValues:r.parameterValues,label:r.label,skipParameterDialog:r.skipParameterDialog,bindingParameters:f,entitySetName:r.entitySetName,onSubmitted:function(){n.lock(c.oLockObject)},onResponse:function(){n.unlock(c.oLockObject)},parentControl:r.parentControl,internalModelContext:r.internalModelContext,operationAvailableMap:r.operationAvailableMap,messageHandler:i,bObjectPage:r.bObjectPage})).then(function(e){a=e})}}();return d&&d.then?d.then(e):e(d)},function(e){return Promise.resolve(s._handleActionResponse(i,r,t)).then(function(){throw e})}))}catch(e){return Promise.reject(e)}};D._handleActionResponse=function e(t,n,r){var o=i.getMessages(true,true);if(o.length>0&&n&&n.internalModelContext){n.internalModelContext.setProperty("sActionName",n.label?n.label:r)}return t.showMessages()};D.handleValidationError=function e(){var t=E.getMessageManager(),n=t.getMessageModel().getData().filter(function(e){if(e.validation){return e}});t.removeMessages(n)};D._showDiscardPopover=function e(n,r,o){var a=this;a._bContinueDiscard=false;return new Promise(function(e,i){if(!n){i("Cancel button not found")}if(r){var s=function(){n.setEnabled(true);if(a._bContinueDiscard){e()}else{i("Discard operation was rejected. Document has not been discarded")}a._oPopover.detachAfterClose(s)};if(!a._oPopover){var c=new h({text:t.getTranslatedText("C_TRANSACTION_HELPER_DRAFT_DISCARD_MESSAGE",o)}),l=new u({text:t.getTranslatedText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON",o),width:"100%",press:function(){a.handleValidationError();a._bContinueDiscard=true;a._oPopover.close()},ariaLabelledBy:c});a._oPopover=new v({showHeader:false,placement:"Top",content:[new _({items:[c,l]})],beforeOpen:function(){n.setEnabled(false);a._oPopover.setInitialFocus(l)}});a._oPopover.addStyleClass("sapUiContentPadding")}a._oPopover.attachAfterClose(s);a._oPopover.openBy(n,false)}else{a.handleValidationError();e()}})};D.handleDocumentModifications=function e(){this._bIsModified=true};D._getAppComponent=function e(){return this._oAppComponent};D._onFieldChange=function e(t,n,r,o){r.removeTransitionMessages();var a=t.getSource();var i=t.getParameter("promise");if(i){return i.then(function(e){a.setValue(e);o();return a.getValue()}).catch(function(e){if(e!==""){n.setEnabled(false)}else{a.setValue(e);o()}})}};D._getNonDeletableText=function e(n,r,o){var a=n.numberOfSelectedContexts-r.concat(n.unSavedContexts).length;return a===1?t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_ONE_OBJECT_NON_DELETABLE",o,[n.numberOfSelectedContexts]):t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_NON_DELETABLE",o,[n.numberOfSelectedContexts-r.concat(n.unSavedContexts).length,n.numberOfSelectedContexts])};D._launchDialogWithKeyFields=function e(r,o,a,i,s){var c=this;var u;var f=i.parentControl;var C=a.bindList(r.getPath(),r.getContext(),[],[],{$$updateGroupId:"submitLater"});C.refreshInternal=function(){};var g=C.create(i.data,true);return new Promise(function(e,v){try{var h="sap/fe/core/controls/NonComputedVisibleKeyFieldsDialog";var _=P.loadTemplate(h,"fragment"),E=f.getController().oResourceBundle,T=a.getMetaModel(),N=[],D=c._getAppComponent(),I=r.isRelative()?r.getResolvedPath():r.getPath(),S=T.createBindingContext(I),M=T.getMetaPath(I);for(var R in o){N.push(T.createBindingContext("".concat(M,"/").concat(o[R])))}var y=new x(N);var w=y.createBindingContext("/");var B=t.getRequiredPropertiesFromInsertRestrictions(M,T);var k=new x(B);var H=k.createBindingContext("/");return Promise.resolve(p.process(_,{name:h},{bindingContexts:{entitySet:S,fields:w,requiredProperties:H},models:{entitySet:S.getModel(),fields:w.getModel(),metaModel:T,requiredProperties:k}})).then(function(o){var a=[];var h={};var _;var p=function(){try{function n(){_.setEnabled(e)}var e=false;var t=O(function(){return Promise.resolve(Promise.all(a.map(function(e){return e.getFields()[0]}).filter(function(e){return e.getRequired()||e.getValueState()===L.Error}).map(function(e){try{var t=false;function o(n){return t?n:e.getValue()===""?undefined:e.getValue()}var n=e.getId();var r=function(){if(n in h){return O(function(){return Promise.resolve(h[n]).then(function(n){var r=e.getValue()===""?undefined:n;t=true;return r})},function(){t=true;return undefined})}}();return Promise.resolve(r&&r.then?r.then(o):o(r))}catch(a){return Promise.reject(a)}}))).then(function(t){e=t.every(function(e){if(Array.isArray(e)){e=e[0]}return e!==undefined&&e!==null&&e!==""})})},function(){e=false});return Promise.resolve(t&&t.then?t.then(n):n(t))}catch(r){return Promise.reject(r)}};var P={handleChange:function(e){var t=e.getParameter("id");h[t]=c._onFieldChange(e,_,s,p)},handleLiveChange:function(e){var t=e.getParameter("id");var n=e.getParameter("value");h[t]=n;p()}};return Promise.resolve(m.load({definition:o,controller:P})).then(function(o){var m;u=new d({title:t.getTranslatedText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE",E),content:[o],beginButton:{text:t.getTranslatedText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE_BUTTON",E),type:"Emphasized",press:function(e){try{var t=e.getSource();t.setEnabled(false);n.lock(u);i.bIsCreateDialog=true;var o=A(function(){return O(function(){return Promise.resolve(Promise.all(Object.keys(h).map(function(e){try{return Promise.resolve(h[e]).then(function(t){var n={};n[e]=t;return n})}catch(e){return Promise.reject(e)}}))).then(function(e){function t(){var e=g.getObject();var t={};Object.keys(e).forEach(function(n){var r=T.getObject("".concat(M,"/").concat(n));if(r&&r.$kind==="NavigationProperty"){return}t[n]=e[n]});var n=r.create(t,true,i.createAtEnd,i.inactive);var o=c.onAfterCreateCompletion(r,n,i);return Promise.resolve(o).then(function(e){if(!e||e&&e.bKeepDialogOpen!==true){var t;e=(t=e)!==null&&t!==void 0?t:{};u.setBindingContext(null);e.newContext=n;m={response:e};u.close()}})}var n=function(){if(i.beforeCreateCallBack){return Promise.resolve(b(i.beforeCreateCallBack({contextPath:r&&r.getPath(),createParameters:e}))).then(function(){})}}();return n&&n.then?n.then(t):t(n)})},function(e){if(e!==l.Constants.CreationFailed){m={error:e};u.close()}})},function(e,r){n.unlock(u);t.setEnabled(true);s.showMessages();if(e)throw r;return r});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}},endButton:{text:t.getTranslatedText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL",E),press:function(){m={error:l.Constants.CancelActionDialog};u.close()}},afterClose:function(){var t;(t=u.getBindingContext("internal"))===null||t===void 0?void 0:t.setProperty("isCreateDialogOpen",false);u.destroy();C.destroy();if(m.error){v(m.error)}else{e(m.response)}}});a=o===null||o===void 0?void 0:o.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");if(f&&f.addDependent){f.addDependent(u)}_=u.getBeginButton();u.setBindingContext(g);return O(function(){return Promise.resolve(t.setUserDefaults(D,N,g,false,i.createAction,i.data)).then(function(){p();u.getBindingContext("internal").setProperty("isCreateDialogOpen",true);u.open()})},function(e){return Promise.resolve(s.showMessages()).then(function(){throw e})})})})}catch(e){return Promise.reject(e)}})};D.onAfterCreateCompletion=function t(n,r,o){var a=this;var i;var s=new Promise(function(e){i=e});var c=function(e){var t=e.getParameter("context"),o=e.getParameter("success");if(t===r){n.detachCreateCompleted(c,a);i(o)}};var u=function(){r.created().then(undefined,function(){e.trace("transient creation context deleted")}).catch(function(t){e.trace("transient creation context deletion error",t)})};n.attachCreateCompleted(c,this);return s.then(function(e){if(!e){if(!o.keepTransientContextOnFailed){u();n.resetChanges();n.getModel().resetChanges(n.getUpdateGroupId());throw l.Constants.CreationFailed}return{bKeepDialogOpen:true}}else{return r.created()}})};D._getNewAction=function e(t,n,r,o){var a;if(t&&t.preferredMode&&n.toUpperCase().indexOf("I-ACTION=CREATEWITH")>-1){var i=t.preferredMode[0];a=i.toUpperCase().indexOf("CREATEWITH:")>-1?i.substr(i.lastIndexOf(":")+1):undefined}else if(t&&t.preferredMode&&n.toUpperCase().indexOf("I-ACTION=AUTOCREATEWITH")>-1){var s=t.preferredMode[0];a=s.toUpperCase().indexOf("AUTOCREATEWITH:")>-1?s.substr(s.lastIndexOf(":")+1):undefined}else{a=r&&r.getObject!==undefined?r.getObject("".concat(o,"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction"))||r.getObject("".concat(o,"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction")):undefined}return a};D._getSpecificCreateActionDialogLabel=function e(t,n,r,o){var a=function(){if(t&&t.getObject("".concat(n,"/@com.sap.vocabularies.UI.v1.LineItem"))){var e=t.getObject("".concat(n,"/@com.sap.vocabularies.UI.v1.LineItem")).findIndex(function(e){var t=e.Action?e.Action.split("("):undefined;return t?t[0]===r:false});return e>-1?t.getObject("".concat(n,"/@com.sap.vocabularies.UI.v1.LineItem"))[e].Label:undefined}else{return undefined}};return a()||t&&t.getObject("".concat(n,"/").concat(r,"@com.sap.vocabularies.Common.v1.Label"))||o&&o.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE")};return N}();return y},false);
//# sourceMappingURL=TransactionHelper.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/EditState","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/ui/core/Component","sap/ui/core/Core","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,n,o,i,r,a,s,c,g,u,l,p,h){"use strict";var f,v,d,C,P,m,_,y,x,b,w,B,O,R,E,S,A,T,F,D,M,I,L,V,j,k,H,$,N,q,K;var z=i.publicExtension;var U=i.methodOverride;var Q=i.finalExtension;var W=i.extensible;var X=i.defineUI5Class;function G(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}function J(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;Y(e,t)}function Y(e,t){Y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,n){t.__proto__=n;return t};return Y(e,t)}function Z(e,t,n,o,i){var r={};Object.keys(o).forEach(function(e){r[e]=o[e]});r.enumerable=!!r.enumerable;r.configurable=!!r.configurable;if("value"in r||r.initializer){r.writable=true}r=n.slice().reverse().reduce(function(n,o){return o(e,t,n)||n},r);if(i&&r.initializer!==void 0){r.value=r.initializer?r.initializer.call(i):void 0;r.initializer=undefined}if(r.initializer===void 0){Object.defineProperty(e,t,r);r=null}return r}var ee=(f=X("sap.fe.core.controllerextensions.InternalRouting"),v=U(),d=U(),C=z(),P=W(l.After),m=z(),_=W(l.After),y=z(),x=W(l.After),b=z(),w=W(l.After),B=z(),O=z(),R=z(),E=Q(),S=z(),A=Q(),T=z(),F=Q(),D=z(),M=Q(),I=z(),L=Q(),V=z(),j=Q(),k=z(),H=Q(),$=z(),N=W(l.Before),f(q=(K=function(i){J(u,i);function u(){return i.apply(this,arguments)||this}var l=u.prototype;l.onExit=function e(){if(this._oRoutingService){this._oRoutingService.detachRouteMatched(this._fnRouteMatchedBound)}};l.onInit=function e(){var n=this;this._oView=this.base.getView();this._oAppComponent=t.getAppComponent(this._oView);this._oPageComponent=c.getOwnerComponentFor(this._oView);this._oRouter=this._oAppComponent.getRouter();this._oRouterProxy=this._oAppComponent.getRouterProxy();if(!this._oAppComponent||!this._oPageComponent){throw new Error("Failed to initialize controler extension 'sap.fe.core.controllerextesions.InternalRouting")}if(this._oAppComponent===this._oPageComponent){this._oPageComponent=null}this._oAppComponent.getService("routingService").then(function(e){n._oRoutingService=e;n._fnRouteMatchedBound=n._onRouteMatched.bind(n);n._oRoutingService.attachRouteMatched(n._fnRouteMatchedBound);n._oTargetInformation=e.getTargetInformationFor(n._oPageComponent||n._oView)}).catch(function(){throw new Error("This controller extension cannot work without a 'routingService' on the main AppComponent")})};l.onRouteMatched=function e(){};l.onRouteMatchedFinished=function e(){};l.onBeforeBinding=function e(t,n){var o=this.base.getView().getController().routing;if(o&&o.onBeforeBinding){o.onBeforeBinding(t,n)}};l.onAfterBinding=function e(t,n){this._oAppComponent.getRootViewController().onContextBoundToView(t);var o=this.base.getView().getController().routing;if(o&&o.onAfterBinding){o.onAfterBinding(t,n)}};l.navigateToTarget=function e(t,n,o,i){var r=this._oPageComponent&&this._oPageComponent.getNavigationConfiguration&&this._oPageComponent.getNavigationConfiguration(n);if(r){var a=r.detail;var s=a.route;var c=a.parameters;this._oRoutingService.navigateTo(t,s,c,i)}else{this._oRoutingService.navigateTo(t,null,null,i)}this._oView.getViewData()};l.navigateToRoute=function e(t,n){return this._oRoutingService.navigateToRoute(t,n)};l.navigateToContext=function t(n,o){var i=this;var r={};o=o||{};if(n.isA("sap.ui.model.odata.v4.ODataListBinding")){if(o.asyncContext){this._oRouterProxy.activateRouteMatchSynchronization();o.asyncContext.then(function(e){i.navigateToContext(e,{checkNoHashChange:o.checkNoHashChange,editable:o.editable,bPersistOPScroll:o.bPersistOPScroll,updateFCLLevel:o.updateFCLLevel,bForceFocus:o.bForceFocus})}).catch(function(t){e.error("Error with the async context",t)})}else if(!o.bDeferredContext){throw"navigation to a list binding is not yet supported"}}if(o.callExtension){var a=this._oView.getModel("internal");a.setProperty("/paginatorCurrentContext",null);r.sourceBindingContext=n.getObject();r.bindingContext=n;if(o.oEvent){r.oEvent=o.oEvent}var s=this.base.getView().getController().routing.onBeforeNavigation(r);if(s){a.setProperty("/paginatorCurrentContext",n);return Promise.resolve(true)}}o.FCLLevel=this._getFCLLevel();return this._oRoutingService.navigateToContext(n,o,this._oView.getViewData(),this._oTargetInformation)};l.navigateBackFromContext=function e(t,n){n=n||{};n.updateFCLLevel=-1;return this.navigateToContext(t,n)};l.navigateForwardToContext=function e(t,n){var o;if(((o=this._oView.getBindingContext("internal"))===null||o===void 0?void 0:o.getProperty("messageFooterContainsErrors"))===true){return Promise.resolve(true)}n=n||{};n.updateFCLLevel=1;return this.navigateToContext(t,n)};l.navigateBackFromTransientState=function e(){var t=this._oRouterProxy.getHash();if(t.indexOf("(...)")!==-1){this._oRouterProxy.navBack()}};l.navigateToMessagePage=function e(t,n){n=n||{};if(this._oRouterProxy.getHash().indexOf("i-action=create")>-1||this._oRouterProxy.getHash().indexOf("i-action=autoCreate")>-1){return this._oRouterProxy.navToHash(this._oRoutingService.getDefaultCreateHash())}else{n.FCLLevel=this._getFCLLevel();return this._oAppComponent.getRootViewController().displayMessagePage(t,n)}};l.isCurrentStateImpactedBy=function e(t){return this._oRoutingService.isCurrentStateImpactedBy(t)};l._isViewPartOfRoute=function e(t){var n=t===null||t===void 0?void 0:t.targets;if(!n||n.indexOf(this._oTargetInformation.targetName)===-1){var o,i;if(((o=this._oTargetInformation.viewLevel)!==null&&o!==void 0?o:0)>=((i=t===null||t===void 0?void 0:t.routeLevel)!==null&&i!==void 0?i:0)){this._setBindingContext(null)}return false}return true};l._buildBindingPath=function e(t,n,o){var i=n.replace(":?query:","");var r=false;for(var a in t){var s=t[a];if(s==="..."&&n.indexOf("{".concat(a,"}"))>=0){r=true;o.bTargetEditable=true}i=i.replace("{".concat(a,"}"),s)}if(t["?query"]&&t["?query"].hasOwnProperty("i-action")){o.bActionCreate=true}if(i&&i[0]!=="/"){i="/".concat(i)}return{path:i,deferred:r}};l._onRouteMatched=function e(t){var n=this;if(!this._isViewPartOfRoute(t.getParameter("routeInformation"))){return}var o;if(this._oPageComponent&&this._oPageComponent.getBindingContextPattern){o=this._oPageComponent.getBindingContextPattern()}o=o||this._oTargetInformation.contextPattern;if(o===null||o===undefined){o=t.getParameter("routePattern")}var i=t.getParameters().arguments;var r=t.getParameter("navigationInfo");var a=this._buildBindingPath(i,o,r),s=a.path,c=a.deferred;this.onRouteMatched();var g=this._oView.getModel();var u;if(c){u=this._bindDeferred(s,r)}else{u=this._bindPage(s,g,r)}u.finally(function(){n.onRouteMatchedFinished()});this._oAppComponent.getRootViewController().updateUIStateForView(this._oView,this._getFCLLevel())};l._bindDeferred=function e(t,n){this.onBeforeBinding(null,{editable:n.bTargetEditable});if(n.bDeferredContext||!n.oAsyncContext){if(this._oPageComponent&&this._oPageComponent.createDeferredContext){this._oPageComponent.createDeferredContext(t,n.useContext,n.bActionCreate)}}var o=this._getBindingContext();if(o!==null&&o!==void 0&&o.hasPendingChanges()){o.getBinding().resetChanges()}this._setBindingContext(null);this.onAfterBinding(null);return Promise.resolve()};l._bindPage=function e(t,n,o){var i=this;if(t===""){return Promise.resolve(this._bindPageToContext(null,n,o))}else{return this._resolveSemanticPath(t,n).then(function(e){i._bindPageToPath(e,n,o)}).catch(function(e){var t=g.getLibraryResourceBundle("sap.fe.core");i.navigateToMessagePage(t.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:t.getText("C_COMMON_SAPFE_ERROR"),description:e.message})})}};l._createFilterFromSemanticPath=function e(t,n,o){var i=function(e){if(e.indexOf("'")===0&&e.lastIndexOf("'")===e.length-1){e=decodeURIComponent(e.substring(1,e.length-1))}return e};var r=t.substring(t.indexOf("(")+1,t.length-1).split(",");var s;if(n.length!=r.length){return null}var c=a.isFilteringCaseSensitive(o);if(n.length===1){var g=i(r[0]);s=[new p({path:n[0].$PropertyPath,operator:h.EQ,value1:g,caseSensitive:c})]}else{var u={};r.forEach(function(e){var t=e.split("="),n=i(t[1]);u[t[0]]=n});var l=false;s=n.map(function(e){var t=e.$PropertyPath,n=u[t];if(n!==undefined){return new p({path:t,operator:h.EQ,value1:n,caseSensitive:c})}else{l=true;return new p({path:"XX"})}});if(l){return null}}var f=new p({filters:[new p("IsActiveEntity","EQ",false),new p("SiblingEntity/IsActiveEntity","EQ",null)],and:false});s.push(f);return new p(s,true)};l._getTechnicalPathFromSemanticPath=function e(t,n,o){var i;var r=n.getMetaModel();var a=r.getMetaContext(t).getPath();if(!o||o.length===0){return Promise.resolve(null)}var s=this._createFilterFromSemanticPath(t,o,r);if(s===null){return Promise.resolve(null)}if(!((i=a)!==null&&i!==void 0&&i.startsWith("/"))){a="/".concat(a)}var c=n.bindList(a,undefined,undefined,s,{$$groupId:"$auto.Heroes"});return c.requestContexts(0,2).then(function(e){if(e&&e.length){return e[0].getPath()}else{return null}})};l._checkPathForSemanticBookmarking=function e(t,n){var o=/^[\/]?(\w+)\([^\/]+\)$/.exec(t);if(!o){return false}var i="/".concat(o[1]);var r=n.getObject("".concat(i,"@com.sap.vocabularies.Common.v1.DraftRoot"));var a=n.getObject("".concat(i,"@com.sap.vocabularies.Common.v1.DraftNode"));return r||a?true:false};l._resolveSemanticPath=function e(t,n){var o=this;var i=n.getMetaModel();var r=this._oRoutingService.getLastSemanticMapping();var a=this._oRouter.getHashChanger().getHash().split("?")[0];if(a&&a.lastIndexOf("/")===a.length-1){a=a.substring(0,a.length-1)}var c=a&&a.substr(0,a.indexOf("("));if(c.indexOf("/")===0){c=c.substring(1)}var g=this._checkPathForSemanticBookmarking(a,i),u=g&&s.getSemanticKeys(i,c);if(!u){return Promise.resolve(t)}else if(r&&r.semanticPath===t){return Promise.resolve(r.technicalPath)}else{return this._getTechnicalPathFromSemanticPath(a,n,u).then(function(e){if(e&&e!==t){o._oRoutingService.setLastSemanticMapping({technicalPath:e,semanticPath:t});return e}else{return t}})}};l._bindPageToPath=function e(t,n,o){var i=this._getBindingContext(),a=i&&i.getPath(),s=o.useContext;if(a!==t||s&&s.getPath()===t){var c;if(s&&s.getPath()===t){c=s}else{c=this._createContext(t,n)}if(c!==i){this._bindPageToContext(c,n,o)}}else if(!o.bReasonIsIappState&&r.isEditStateDirty()){this._refreshBindingContext(i)}};l._bindPageToContext=function t(n,o,i){var r=this;if(!n){this.onBeforeBinding(null);this.onAfterBinding(null);return}var a=n.getBinding();var s=this._oAppComponent.getRootViewController();if(s.isFclEnabled()){if(!a||!a.isA("sap.ui.model.odata.v4.ODataListBinding")){n=this._createContext(n.getPath(),o)}try{this._setKeepAlive(n,true,function(){if(s.isContextUsedInPages(n)){r.navigateBackFromContext(n)}},true)}catch(t){e.error("View for ".concat(n.getPath()," won't be synchronized. Parent listBinding must have binding parameter $$ownRequest=true"))}}else if(!a||a.isA("sap.ui.model.odata.v4.ODataListBinding")){n=this._createContext(n.getPath(),o)}this.onBeforeBinding(n,{editable:i.bTargetEditable,listBinding:a,bPersistOPScroll:i.bPersistOPScroll,bDraftNavigation:i.bDraftNavigation,showPlaceholder:i.bShowPlaceholder});this._setBindingContext(n);this.onAfterBinding(n)};l._createContext=function t(o,i){var r=this;var a=this._oPageComponent,s=a&&a.getEntitySet&&a.getEntitySet(),c=a&&a.getContextPath&&a.getContextPath()||s&&"/".concat(s),g=i.getMetaModel(),u={$$groupId:"$auto.Heroes",$$updateGroupId:"$auto",$$patchWithoutSideEffects:true};var l=g.getObject("".concat(c,"@com.sap.vocabularies.Common.v1.DraftRoot"));var p=g.getObject("".concat(c,"@com.sap.vocabularies.Common.v1.DraftNode"));var h=this._oAppComponent.getRootViewController();if(h.isFclEnabled()){var f=this._getKeepAliveContext(i,o,false,u);if(!f){throw new Error("Cannot create keepAlive context ".concat(o))}else if(l||p){if(f.getProperty("IsActiveEntity")===undefined){f.requestProperty(["HasActiveEntity","HasDraftEntity","IsActiveEntity"]);if(l){f.requestObject("DraftAdministrativeData")}}else{f.requestSideEffects(l?["HasActiveEntity","HasDraftEntity","IsActiveEntity","DraftAdministrativeData"]:["HasActiveEntity","HasDraftEntity","IsActiveEntity"])}}return f}else{if(s){var v=g.getObject("".concat(c,"/@com.sap.vocabularies.Common.v1.Messages/$Path"));if(v){u.$select=v}}if(l||p){if(u.$select===undefined){u.$select="HasActiveEntity,HasDraftEntity,IsActiveEntity"}else{u.$select+=",HasActiveEntity,HasDraftEntity,IsActiveEntity"}}if(this._oView.getBindingContext()){var d;var C=(d=this._oView.getBindingContext())===null||d===void 0?void 0:d.getBinding();C===null||C===void 0?void 0:C.resetChanges().then(function(){C.destroy()}).catch(function(t){e.error("Error while reseting the changes to the binding",t)})}var P=i.bindContext(o,undefined,u);P.attachEventOnce("dataRequested",function(){n.lock(r._oView)});P.attachEventOnce("dataReceived",this._dataReceivedEventHandler.bind(this));return P.getBoundContext()}};l._dataReceivedEventHandler=function t(o){try{var i=this;var r=o&&o.getParameter("error");n.unlock(i._oView);var a=function(){if(r){var t=G(function(){return Promise.resolve(g.getLibraryResourceBundle("sap.fe.core",true)).then(function(e){var t=i.base.messageHandler;var n={};if(r&&r.status===503){n={isInitialLoad503Error:true,shellBack:true}}else{n={title:e.getText("C_COMMON_SAPFE_ERROR"),description:r,isDataReceivedError:true,shellBack:true}}return Promise.resolve(t.showMessages(n)).then(function(){})})},function(t){e.error("Error while getting the core resource bundle",t)});if(t&&t.then)return t.then(function(){})}}();return Promise.resolve(a&&a.then?a.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};l._refreshBindingContext=function e(t){var n=this._oPageComponent;var o=this._oAppComponent.getSideEffectsService();var i=t.getPath();var r=n&&n.getEntitySet&&n.getEntitySet();var a=n&&n.getContextPath&&n.getContextPath()||r&&"/".concat(r);var s=this._oView.getModel().getMetaModel();var c;var g=[];var u=[];var l={TargetProperties:[],TargetEntities:[]};function p(e){var t;var n=(e.getContext()&&e.getContext().getPath()||"").replace(i,"");var o=(n?"".concat(n.slice(1),"/"):n)+e.getPath();if(e.isA("sap.ui.model.odata.v4.ODataContextBinding")){t=e.getDependentBindings();if(t){for(var r=0;r<t.length;r++){p(t[r])}}else if(g.indexOf(o)===-1){g.push(o)}}else if(e.isA("sap.ui.model.odata.v4.ODataListBinding")){if(g.indexOf(o)===-1){g.push(o)}}else if(e.isA("sap.ui.model.odata.v4.ODataPropertyBinding")){if(u.indexOf(o)===-1){u.push(o)}}}if(a){c=s.getObject("".concat(a,"/@com.sap.vocabularies.Common.v1.Messages/$Path"))}p(t.getBinding());var h;for(h=0;h<g.length;h++){l.TargetEntities.push({$NavigationPropertyPath:g[h]})}l.TargetProperties=u;if(c){l.TargetProperties.push(c)}l.TargetProperties=l.TargetProperties.map(function(e){if(e){var t=e.indexOf("/");if(t>0){return e.slice(0,t)}return e}});o.requestSideEffects(l.TargetEntities.concat(l.TargetProperties),t)};l._getBindingContext=function e(){if(this._oPageComponent){return this._oPageComponent.getBindingContext()}else{return this._oView.getBindingContext()}};l._setBindingContext=function e(t){var n,o;if(this._oPageComponent){n=this._oPageComponent.getBindingContext();o=this._oPageComponent}else{n=this._oView.getBindingContext();o=this._oView}if(t!==n){var i;o.setBindingContext(t);if((i=n)!==null&&i!==void 0&&i.isKeepAlive()){this._setKeepAlive(n,false)}}};l._getFCLLevel=function e(){return this._oTargetInformation.FCLLevel};l._setKeepAlive=function e(t,n,o,i){if(t.getPath().endsWith(")")){var r=t.getModel().getMetaModel();var a=r.getMetaPath(t.getPath());var s=r.getObject("".concat(a,"/@com.sap.vocabularies.Common.v1.Messages/$Path"));t.setKeepAlive(n,o,!!s&&i)}};l._getKeepAliveContext=function e(t,n,o,i){var r=n.split("/");var a=[];while(r.length&&!r[r.length-1].endsWith(")")){a.push(r.pop())}if(r.length===0){return undefined}var s=r.join("/");var c=t.getKeepAliveContext(s,o,i);if(a.length===0){return c}else{a.reverse();var g=a.join("/");return t.bindContext(g,c).getBoundContext()}};l.switchFullScreen=function t(){var n=this.base.getView();var o=n.getModel("fclhelper"),i=o.getProperty("/actionButtonsInfo/isFullScreen"),r=o.getProperty(i?"/actionButtonsInfo/exitFullScreen":"/actionButtonsInfo/fullScreen"),a=this._oAppComponent.getRootViewController();var s=a.getRightmostContext?a.getRightmostContext():n.getBindingContext();this.base._routing.navigateToContext(s,{sLayout:r}).catch(function(){e.warning("cannot switch between column and fullscreen")})};l.closeColumn=function e(){var t=this.base.getView();var n=t.getViewData();var i=t.getBindingContext();var r=this.base;var s=i.getModel().getMetaModel();if(n&&n.viewLevel===1&&a.isDraftSupported(s,i.getPath())){o.processDataLossOrDraftDiscardConfirmation(function(){r._routing.navigateBackFromContext(i,{noPreservationCache:true})},Function.prototype,i,t.getController(),false,o.NavigationType.BackNavigation)}else{r._routing.navigateBackFromContext(i,{noPreservationCache:true})}};return u}(u),Z(K.prototype,"onExit",[v],Object.getOwnPropertyDescriptor(K.prototype,"onExit"),K.prototype),Z(K.prototype,"onInit",[d],Object.getOwnPropertyDescriptor(K.prototype,"onInit"),K.prototype),Z(K.prototype,"onRouteMatched",[C,P],Object.getOwnPropertyDescriptor(K.prototype,"onRouteMatched"),K.prototype),Z(K.prototype,"onRouteMatchedFinished",[m,_],Object.getOwnPropertyDescriptor(K.prototype,"onRouteMatchedFinished"),K.prototype),Z(K.prototype,"onBeforeBinding",[y,x],Object.getOwnPropertyDescriptor(K.prototype,"onBeforeBinding"),K.prototype),Z(K.prototype,"onAfterBinding",[b,w],Object.getOwnPropertyDescriptor(K.prototype,"onAfterBinding"),K.prototype),Z(K.prototype,"navigateToTarget",[B],Object.getOwnPropertyDescriptor(K.prototype,"navigateToTarget"),K.prototype),Z(K.prototype,"navigateToRoute",[O],Object.getOwnPropertyDescriptor(K.prototype,"navigateToRoute"),K.prototype),Z(K.prototype,"navigateToContext",[R,E],Object.getOwnPropertyDescriptor(K.prototype,"navigateToContext"),K.prototype),Z(K.prototype,"navigateBackFromContext",[S,A],Object.getOwnPropertyDescriptor(K.prototype,"navigateBackFromContext"),K.prototype),Z(K.prototype,"navigateForwardToContext",[T,F],Object.getOwnPropertyDescriptor(K.prototype,"navigateForwardToContext"),K.prototype),Z(K.prototype,"navigateBackFromTransientState",[D,M],Object.getOwnPropertyDescriptor(K.prototype,"navigateBackFromTransientState"),K.prototype),Z(K.prototype,"navigateToMessagePage",[I,L],Object.getOwnPropertyDescriptor(K.prototype,"navigateToMessagePage"),K.prototype),Z(K.prototype,"isCurrentStateImpactedBy",[V,j],Object.getOwnPropertyDescriptor(K.prototype,"isCurrentStateImpactedBy"),K.prototype),Z(K.prototype,"switchFullScreen",[k,H],Object.getOwnPropertyDescriptor(K.prototype,"switchFullScreen"),K.prototype),Z(K.prototype,"closeColumn",[$,N],Object.getOwnPropertyDescriptor(K.prototype,"closeColumn"),K.prototype),K))||q);return ee},false);
//# sourceMappingURL=InternalRouting.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/helpers/IssueManager","sap/fe/core/converters/helpers/SelectionVariantHelper","sap/fe/core/formatters/TableFormatterTypes","sap/fe/core/templating/PropertyHelper","../../helpers/Aggregation","../../helpers/ID","./Criticality"],function(e,a,t,i,n,r,l){"use strict";var o={};var u=l.getMessageTypeFromCriticalityType;var c=r.getKPIID;var d=n.AggregationHelper;var s=i.isPathExpression;var v=t.MessageType;var p=a.getFilterDefinitionsFromSelectionVariant;var f=e.IssueType;var g=e.IssueSeverity;var y=e.IssueCategory;var C={"UI.TrendType/StrongUp":"Up","UI.TrendType/Up":"Up","UI.TrendType/StrongDown":"Down","UI.TrendType/Down":"Down","UI.TrendType/Sideways":"None"};var T={"UI.ChartType/ColumnStacked":"StackedColumn","UI.ChartType/BarStacked":"StackedBar","UI.ChartType/Donut":"Donut","UI.ChartType/Line":"Line","UI.ChartType/Bubble":"bubble","UI.ChartType/Column":"column","UI.ChartType/Bar":"bar","UI.ChartType/VerticalBullet":"vertical_bullet","UI.ChartType/Combination":"combination","UI.ChartType/Scatter":"scatter"};function h(e,a){var t,i;if(e.Measures===undefined){return undefined}var n=e.Dimensions?e.Dimensions.map(function(a){var t,i,n,r;var l=(t=e.DimensionAttributes)===null||t===void 0?void 0:t.find(function(e){var t;return((t=e.Dimension)===null||t===void 0?void 0:t.value)===a.value});return{name:a.value,label:((i=a.$target.annotations.Common)===null||i===void 0?void 0:(n=i.Label)===null||n===void 0?void 0:n.toString())||a.value,role:l===null||l===void 0?void 0:(r=l.Role)===null||r===void 0?void 0:r.replace("UI.ChartDimensionRoleType/","")}}):[];var r=e.Measures.map(function(a){var t,i,n,r;var l=(t=e.MeasureAttributes)===null||t===void 0?void 0:t.find(function(e){var t;return((t=e.Measure)===null||t===void 0?void 0:t.value)===a.value});return{name:a.value,label:((i=a.$target.annotations.Common)===null||i===void 0?void 0:(n=i.Label)===null||n===void 0?void 0:n.toString())||a.value,role:l===null||l===void 0?void 0:(r=l.Role)===null||r===void 0?void 0:r.replace("UI.ChartMeasureRoleType/","")}});return{chartType:T[e.ChartType]||"Line",dimensions:n,measures:r,sortOrder:a===null||a===void 0?void 0:(t=a.SortOrder)===null||t===void 0?void 0:t.map(function(e){var a;return{name:((a=e.Property)===null||a===void 0?void 0:a.value)||"",descending:!!e.Descending}}),maxItems:a===null||a===void 0?void 0:(i=a.MaxItems)===null||i===void 0?void 0:i.valueOf()}}function m(e,a){var t,i;var n=e.Value.$target;if((t=n.annotations.Measures)!==null&&t!==void 0&&t.ISOCurrency){var r;var l=(r=n.annotations.Measures)===null||r===void 0?void 0:r.ISOCurrency;if(s(l)){a.datapoint.unit={value:l.$target.name,isCurrency:true,isPath:true}}else{a.datapoint.unit={value:l.toString(),isCurrency:true,isPath:false}}}else if((i=n.annotations.Measures)!==null&&i!==void 0&&i.Unit){var o;var u=(o=n.annotations.Measures)===null||o===void 0?void 0:o.Unit;if(s(u)){a.datapoint.unit={value:u.$target.name,isCurrency:false,isPath:true}}else{a.datapoint.unit={value:u.toString(),isCurrency:false,isPath:false}}}}function I(e,a,t){if(e.Criticality){if(typeof e.Criticality==="object"){var i=e.Criticality.$target;if(a.isPropertyAggregatable(i)){t.datapoint.criticalityPath=e.Criticality.path}else{t.datapoint.criticalityValue=v.None}}else{t.datapoint.criticalityValue=u(e.Criticality)}}else if(e.CriticalityCalculation){t.datapoint.criticalityCalculationMode=e.CriticalityCalculation.ImprovementDirection;t.datapoint.criticalityCalculationThresholds=[];switch(t.datapoint.criticalityCalculationMode){case"UI.ImprovementDirectionType/Target":t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeLowValue);t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeLowValue);t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeLowValue);t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeHighValue);t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeHighValue);t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeHighValue);break;case"UI.ImprovementDirectionType/Minimize":t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeHighValue);t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeHighValue);t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeHighValue);break;case"UI.ImprovementDirectionType/Maximize":default:t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeLowValue);t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeLowValue);t.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeLowValue)}}else{t.datapoint.criticalityValue=v.None}}function S(e,a,t){if(e.Trend){if(typeof e.Trend==="object"){var i=e.Trend.$target;if(a.isPropertyAggregatable(i)){t.datapoint.trendPath=e.Trend.path}else{t.datapoint.trendValue="None"}}else{t.datapoint.trendValue=C[e.Trend]||"None"}}else if(e.TrendCalculation){t.datapoint.trendCalculationIsRelative=e.TrendCalculation.IsRelativeDifference?true:false;if(e.TrendCalculation.ReferenceValue.$target){var n=e.TrendCalculation.ReferenceValue.$target;if(a.isPropertyAggregatable(n)){t.datapoint.trendCalculationReferencePath=e.TrendCalculation.ReferenceValue.path}else{t.datapoint.trendValue="None"}}else{t.datapoint.trendCalculationReferenceValue=e.TrendCalculation.ReferenceValue}if(t.datapoint.trendCalculationReferencePath!==undefined||t.datapoint.trendCalculationReferenceValue!==undefined){t.datapoint.trendCalculationTresholds=[e.TrendCalculation.StrongDownDifference.valueOf(),e.TrendCalculation.DownDifference.valueOf(),e.TrendCalculation.UpDifference.valueOf(),e.TrendCalculation.StrongUpDifference.valueOf()]}}else{t.datapoint.trendValue="None"}}function D(e,a,t){if(e.TargetValue){if(e.TargetValue.$target){var i=e.TargetValue.$target;if(a.isPropertyAggregatable(i)){t.datapoint.targetPath=e.TargetValue.path}}else{t.datapoint.targetValue=e.TargetValue}}}function b(e){var a=e.annotations["Common"]||{};var t;Object.keys(a).forEach(function(e){var i=a[e];if(i.term==="com.sap.vocabularies.Common.v1.SemanticObject"){if(!i.qualifier||!t){t=i}}});if(t){var i={semanticObject:t.toString(),unavailableActions:[]};var n=Object.keys(a).find(function(e){var i;return a[e].term==="com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions"&&a[e].qualifier===((i=t)===null||i===void 0?void 0:i.qualifier)});if(n){i.unavailableActions=a[n]}return i}else{return undefined}}function V(e,a,t){var i,n;var r=t.getConverterContextFor("/".concat(a.entitySet));var l=new d(r.getEntityType(),r);if(!l.isAnalyticsSupported()){t.getDiagnostics().addIssue(y.Annotation,g.Medium,f.KPI_ISSUES.NO_ANALYTICS+a.entitySet);return undefined}var o;var u;var s;var v;var C;var T=r.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.KPI");var V=T.find(function(e){return e.qualifier===a.qualifier});if(V){var U,P,A,R,O;u=V.DataPoint;o=V.SelectionVariant;s=(U=V.Detail)===null||U===void 0?void 0:U.DefaultPresentationVariant;v=(P=s)===null||P===void 0?void 0:(A=P.Visualizations)===null||A===void 0?void 0:(R=A.find(function(e){return e.$target.$Type==="com.sap.vocabularies.UI.v1.ChartDefinitionType"}))===null||R===void 0?void 0:R.$target;if((O=V.Detail)!==null&&O!==void 0&&O.SemanticObject){var M;C={semanticObject:V.Detail.SemanticObject.toString(),action:(M=V.Detail.Action)===null||M===void 0?void 0:M.toString(),unavailableActions:[]}}}else{var $=r.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.SelectionPresentationVariant");var N=$.find(function(e){return e.qualifier===a.qualifier});if(N){var w,L,_,E,j,q;o=N.SelectionVariant;s=N.PresentationVariant;u=(w=s)===null||w===void 0?void 0:(L=w.Visualizations)===null||L===void 0?void 0:(_=L.find(function(e){return e.$target.$Type==="com.sap.vocabularies.UI.v1.DataPointType"}))===null||_===void 0?void 0:_.$target;v=(E=s)===null||E===void 0?void 0:(j=E.Visualizations)===null||j===void 0?void 0:(q=j.find(function(e){return e.$target.$Type==="com.sap.vocabularies.UI.v1.ChartDefinitionType"}))===null||q===void 0?void 0:q.$target}else{t.getDiagnostics().addIssue(y.Annotation,g.Medium,f.KPI_ISSUES.KPI_NOT_FOUND+a.qualifier);return undefined}}if(!s||!u||!v){t.getDiagnostics().addIssue(y.Annotation,g.Medium,f.KPI_ISSUES.KPI_DETAIL_NOT_FOUND+a.qualifier);return undefined}var K=u.Value.$target;if(!l.isPropertyAggregatable(K)){t.getDiagnostics().addIssue(y.Annotation,g.Medium,f.KPI_ISSUES.MAIN_PROPERTY_NOT_AGGREGATABLE+a.qualifier);return undefined}var k=h(v,s);if(!k){return undefined}var B={id:c(e),entitySet:a.entitySet,datapoint:{propertyPath:u.Value.path,annotationPath:r.getEntitySetBasedAnnotationPath(u.fullyQualifiedName),title:(i=u.Title)===null||i===void 0?void 0:i.toString(),description:(n=u.Description)===null||n===void 0?void 0:n.toString()},selectionVariantFilterDefinitions:o?p(o):undefined,chart:k};if(!C){if(a.detailNavigation){C={outboundNavigation:a.detailNavigation}}else{C=b(K)}}if(C){B.navigation=C}m(u,B);I(u,l,B);S(u,l,B);D(u,l,B);return B}function U(e){var a=e.getManifestWrapper().getKPIConfiguration(),t=[];Object.keys(a).forEach(function(i){var n=V(i,a[i],e);if(n){t.push(n)}});return t}o.getKPIDefinitions=U;return o},false);
//# sourceMappingURL=KPI.js.map
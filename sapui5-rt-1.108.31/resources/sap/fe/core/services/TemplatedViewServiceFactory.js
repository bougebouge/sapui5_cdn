/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/UriParameters","sap/fe/core/helpers/LoaderUtils","sap/fe/core/TemplateModel","sap/ui/core/Component","sap/ui/core/mvc/View","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/Device","sap/ui/model/base/ManagedObjectModel","sap/ui/model/json/JSONModel","sap/ui/VersionInfo","../helpers/DynamicAnnotationPathHelper"],function(e,t,r,n,o,a,i,s,c,u,l,f,v,p){"use strict";var d=p.resolveDynamicExpression;var g=r.requireDependencies;function h(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}function m(e,t){return M(e)||C(e,t)||b(e,t)||y()}function y(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function b(e,t){if(!e)return;if(typeof e==="string")return w(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return w(e,t)}function w(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++){n[r]=e[r]}return n}function C(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,a,i,s=[],c=!0,u=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=a.call(r)).done)&&(s.push(n.value),s.length!==t);c=!0){}}catch(e){u=!0,o=e}finally{try{if(!c&&null!=r.return&&(i=r.return(),Object(i)!==i))return}finally{if(u)throw o}}return s}}function M(e){if(Array.isArray(e))return e}function O(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;V(e,t)}function V(e,t){V=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return V(e,t)}var S=function(r){O(i,r);function i(){return r.apply(this,arguments)||this}var s=i.prototype;s.init=function e(){var t=this;var r=this;var n=[];var a=this.getContext();var i=a.scopeObject;var s=o.getOwnerComponentFor(i);var u=s.getMetaModel();var l="".concat(s.getMetadata().getComponentName(),"::").concat(s.getLocalId(i.getId()));var f=i.getEnhanceI18n()||[];var p;this.oFactory=a.factory;if(f){p=s.getMetadata().getComponentName();for(var d=0;d<f.length;d++){var h=s.getModel(f[d]);if(h&&h.isA("sap.ui.model.resource.ResourceModel")){f[d]=h}else{f[d]="".concat(p,".").concat(f[d].replace(".properties",""))}}}var y="".concat(s.getMetadata().getName(),"_").concat(l,"_").concat(sap.ui.getCore().getConfiguration().getLanguageTag());n.push(c.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:i,settings:{bundles:["sap.fe.core.messagebundle","sap.fe.macros.messagebundle","sap.fe.templates.messagebundle"],enhanceI18n:f,modelName:"sap.fe.i18n"}}).then(function(e){r.oResourceModelService=e;return e.getResourceModel()}));n.push(c.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:u,appComponent:s,component:i}}).then(function(e){r.oCacheHandlerService=e;return e.validateCacheKey(y,i)}));n.push(v.load().then(function(e){var t="";if(!e.libraries){t=sap.ui.buildinfo.buildtime}else{e.libraries.forEach(function(e){t+=e.buildTimestamp})}return t}).catch(function(){return"<NOVALUE>"}));this.initPromise=Promise.all(n).then(function(e){try{var r=e[0];var n=e[1];var o=s.getSideEffectsService();o.initializeSideEffects(s.getEnvironmentCapabilities().getCapabilities());return Promise.resolve(g(["sap/fe/core/converters/TemplateConverter","sap/fe/core/converters/MetaModelConverter"])).then(function(e){var o=m(e,2),a=o[0],i=o[1];return t.createView(r,l,n,a,i)})}catch(e){return Promise.reject(e)}}).then(function(e){var t=c.get("sap.fe.core.services.CacheHandlerService").getInstance(u);t.invalidateIfNeeded(e,y,i)})};s.refreshView=function t(r){var n=r.getRootControl();if(n){n.destroy()}else if(this.oView){this.oView.destroy()}return this.createView(this.resourceModel,this.stableId,"",this.TemplateConverter,this.MetaModelConverter).then(function(){r.oContainer.invalidate()}).catch(function(t){r.oContainer.invalidate();e.error(t)})};s.createView=function r(i,s,c,v,p){try{var g=this;g.resourceModel=i;g.stableId=s;g.TemplateConverter=v;g.MetaModelConverter=p;var m=g.getContext();var y=m.settings;var b=y.converterType;var w=m.scopeObject;var C=o.getOwnerComponentFor(w);var M=C.getRoutingService().getTargetInformationFor(w).options.settings.fullContextPath;var O=C.getMetaModel();var V=C.getManifest();var S=new f(u).setDefaultBindingMode("OneWay");var I=new f(V);var j=false;function A(){var e=M.split("/");var t=e.reduce(function(e,t){if(t===""){return e}if(e===""){e="/".concat(t)}else{var r=O.getObject("".concat(e,"/$NavigationPropertyBinding/").concat(t));if(r&&Object.keys(r).length>0){e+="/$NavigationPropertyBinding"}e+="/".concat(t)}return e},"");var r=y.viewType||w.getViewType()||"XML";if(r!=="XML"){r=undefined}return{type:r,preprocessors:{xml:{bindingContexts:{entitySet:t?O.createBindingContext(t):null,fullContextPath:M?O.createBindingContext(M):null,contextPath:M?O.createBindingContext(M):null,converterContext:x.createBindingContext("/",undefined,{noResolve:true}),viewData:N?D.createBindingContext("/"):null},models:{entitySet:O,fullContextPath:O,contextPath:O,"sap.fe.i18n":i,metaModel:O,device:S,manifest:I,converterContext:x,viewData:D},appComponent:C}},id:s,viewName:y.viewName||w.getViewName(),viewData:N,cache:{keys:[c],additionalData:{getAdditionalCacheData:function(){return x.getData()},setAdditionalCacheData:function(e){x.setData(e)}}},models:{"sap.fe.i18n":i},height:"100%"}}var x,D,P,N;var T=function(t){e.error(t.message,t);P.viewName=y.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage";P.preprocessors.xml.models["error"]=new f(t);return w.runAsOwner(function(){return a.create(P).then(function(e){g.oView=e;g.oView.setModel(new l(g.oView),"$view");w.setAggregation("rootControl",g.oView);return c})})};return Promise.resolve(h(function(){return Promise.resolve(C.getService("routingService")).then(function(r){var o;var h=r.getTargetInformationFor(w);var m=V["sap.app"]&&V["sap.app"].crossNavigation&&V["sap.app"].crossNavigation.outbounds||{};var y=w.getNavigation()||{};Object.keys(y).forEach(function(e){var t=y[e];var r;if(t.detail&&t.detail.outbound&&m[t.detail.outbound]){r=m[t.detail.outbound];t.detail.outboundDetail={semanticObject:r.semanticObject,action:r.action,parameters:r.parameters}}if(t.create&&t.create.outbound&&m[t.create.outbound]){r=m[t.create.outbound];t.create.outboundDetail={semanticObject:r.semanticObject,action:r.action,parameters:r.parameters}}});N={navigation:y,viewLevel:h.viewLevel,stableId:s,contentDensities:(o=V["sap.ui5"])===null||o===void 0?void 0:o.contentDensities,resourceBundle:i.__bundle,fullContextPath:M,isDesktop:u.system.desktop,isPhone:u.system.phone};if(w.getViewData){Object.assign(N,w.getViewData())}var S=C.getShellServices();N.converterType=b;N.shellContentDensity=S.getContentDensity();N.useNewLazyLoading=t.fromQuery(window.location.search).get("sap-fe-xx-lazyloadingtest")==="true";N.retrieveTextFromValueList=V["sap.fe"]&&V["sap.fe"].form?V["sap.fe"].form.retrieveTextFromValueList:undefined;D=new f(N);if(N&&N.controlConfiguration){Object.keys(N.controlConfiguration).forEach(function(e){if(e.indexOf("[")!==-1){var t=d(e,O);N.controlConfiguration[t]=N.controlConfiguration[e]}})}p.convertTypes(O,C.getEnvironmentCapabilities().getCapabilities());x=new n(function(){try{var t=C.getDiagnostics();var r=t.getIssues().length;var n=v.convertPage(b,O,N,t,M,C.getEnvironmentCapabilities().getCapabilities(),w);var o=t.getIssues();var a=o.slice(r);if(a.length>0){e.warning("Some issues have been detected in your project, please check the UI5 support assistant rule for sap.fe.core")}return n}catch(t){e.error(t,t);return{}}},O);if(!j){P=A();w.setModel(x,"_pageModel");return w.runAsOwner(function(){return a.create(P).catch(T).then(function(e){g.oView=e;g.oView.setModel(new l(g.oView),"$view");g.oView.setModel(D,"viewData");w.setAggregation("rootControl",g.oView);return c}).catch(function(t){return e.error(t.message,t)})})}})},function(t){e.error(t.message,t);throw new Error("Error while creating view : ".concat(t))}))}catch(E){return Promise.reject(E)}};s.getView=function e(){return this.oView};s.getInterface=function e(){return this};s.exit=function e(){if(this.oResourceModelService){this.oResourceModelService.destroy()}if(this.oCacheHandlerService){this.oCacheHandlerService.destroy()}this.oFactory.removeGlobalInstance()};return i}(i);var I=function(e){O(t,e);function t(){var t;for(var r=arguments.length,n=new Array(r),o=0;o<r;o++){n[o]=arguments[o]}t=e.call.apply(e,[this].concat(n))||this;t._oInstanceRegistry={};return t}var r=t.prototype;r.createInstance=function e(r){t.iCreatingViews++;var n=new S(Object.assign({factory:this},r));return n.initPromise.then(function(){t.iCreatingViews--;return n})};r.removeGlobalInstance=function e(){this._oInstanceRegistry={}};t.getNumberOfViewsInCreationState=function e(){return t.iCreatingViews};return t}(s);return I},false);
//# sourceMappingURL=TemplatedViewServiceFactory.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/strings/hash","sap/ui/core/cache/CacheManager","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory"],function(e,t,n,r){"use strict";var i={};function a(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}function o(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;s(e,t)}function s(e,t){s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,n){t.__proto__=n;return t};return s(e,t)}function c(e,t,n){return new Promise(function(r){jQuery.ajax(e,{method:"GET"}).done(function(i,a,o){n[e]=o.getResponseHeader("ETag")||o.getResponseHeader("Last-Modified");r(t===n[e])}).fail(function(){n[e]="";r(false)})})}var u=function(n){o(r,n);function r(){return n.apply(this,arguments)||this}i.CacheHandlerService=r;var s=r.prototype;s.init=function e(){var t=this;var n=this.getContext();this.oFactory=n.factory;var r=n.settings;if(!r.metaModel){throw new Error("a `metaModel` property is expected when instantiating the CacheHandlerService")}this.oMetaModel=r.metaModel;this.oAppComponent=r.appComponent;this.oComponent=r.component;this.initPromise=this.oMetaModel.fetchEntityContainer().then(function(){return t});this.mCacheNeedsInvalidate={}};s.exit=function e(){this.oFactory.removeGlobalInstance(this.oMetaModel)};s.validateCacheKey=function e(n,r){try{var i=this;function f(){i.mCacheNeedsInvalidate[n]=o;return s}var o=true;var s;var u=a(function(){return Promise.resolve(t.get(n)).then(function(e){var t=i.getETags(r);s=JSON.stringify(t);var n=function(){if(e){var n={};var r=JSON.parse(e.cachedETags);return Promise.resolve(Promise.all(Object.keys(r).map(function(e){if(r[e]){if(t[e]){n[e]=t[e];return r[e]===t[e]}else{return c(e,r[e],n)}}else{n[e]=t[e];return r[e]===t[e]}}))).then(function(t){o=t.indexOf(false)>=0;if(Object.keys(n).some(function(e){return!n[e]})){s=null}else{s=o?JSON.stringify(n):e.viewCacheKey}})}else if(Object.keys(t).some(function(e){return!t[e]})){o=true;s=null}}();if(n&&n.then)return n.then(function(){})})},function(){o=true;s=null});return Promise.resolve(u&&u.then?u.then(f):f(u))}catch(h){return Promise.reject(h)}};s.invalidateIfNeeded=function e(n,r,i){var a=JSON.stringify(this.getETags(i));if(this.mCacheNeedsInvalidate[r]||n&&n!==a){var o={};o.cachedETags=a;o.viewCacheKey=n;return t.set(r,o)}else{return Promise.resolve()}};s.getETags=function t(n){var r=this.oMetaModel.getETags();Object.keys(r).forEach(function(e){if(r[e]instanceof Date){r[e]=r[e].toISOString()}});var i=this.oAppComponent.getManifest();var a=e(JSON.stringify({sapApp:i["sap.app"],viewData:n.getViewData()}));r["manifest"]=a;return r};s.getInterface=function e(){return this};return r}(n);i.CacheHandlerService=u;var f=function(e){o(t,e);function t(){var t;for(var n=arguments.length,r=new Array(n),i=0;i<n;i++){r[i]=arguments[i]}t=e.call.apply(e,[this].concat(r))||this;t._oInstanceRegistry={};return t}var n=t.prototype;n.createInstance=function e(t){var n=this;var r=t.settings.metaModel.getId();var i=this._oInstanceRegistry[r];if(!i){this._oInstanceRegistry[r]=i=new u(Object.assign({factory:this,scopeObject:null,scopeType:"service"},t))}return i.initPromise.then(function(){return n._oInstanceRegistry[r]}).catch(function(e){n._oInstanceRegistry[r]=null;throw e})};n.getInstance=function e(t){return this._oInstanceRegistry[t.getId()]};n.removeGlobalInstance=function e(t){this._oInstanceRegistry[t.getId()]=null};return t}(r);return f},false);
//# sourceMappingURL=CacheHandlerServiceFactory.js.map
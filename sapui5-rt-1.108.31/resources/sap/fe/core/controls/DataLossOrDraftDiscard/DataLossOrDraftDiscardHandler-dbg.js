/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log", "sap/ui/core/Fragment", "sap/ui/core/util/XMLPreprocessor", "sap/ui/core/XMLTemplateProcessor", "sap/ui/model/json/JSONModel"], function (Log, Fragment, XMLPreprocessor, XMLTemplateProcessor, JSONModel) {
  "use strict";

  var _exports = {};
  var DraftDataLossOptions;
  (function (DraftDataLossOptions) {
    DraftDataLossOptions["Save"] = "draftDataLossOptionSave";
    DraftDataLossOptions["Keep"] = "draftDataLossOptionKeep";
    DraftDataLossOptions["Discard"] = "draftDataLossOptionDiscard";
  })(DraftDataLossOptions || (DraftDataLossOptions = {}));
  var fnOnDataLossConfirmed;
  var fnOnDataLossCancel;
  function fnDataLossConfirmation(onDataLossOk, onDataLossCancel, controller, skipBindingToView) {
    // Open the data loss popup and after processing the selected function finally call
    // onDataLossConfirmed which resolves the promise and leads to processing of the originally
    // triggered action like e.g. a back navigation
    var dataLossPopup;
    fnOnDataLossConfirmed = onDataLossOk;
    fnOnDataLossCancel = onDataLossCancel;
    var fragmentName = "sap.fe.core.controls.DataLossOrDraftDiscard.DataLossDraft";
    var view = controller.getView();
    var fragmentController = {
      onDataLossOk: function () {
        var selectedKey = getSelectedKey(dataLossPopup);
        if (selectedKey === DraftDataLossOptions.Save) {
          saveDocument(controller).then(fnOnDataLossConfirmed).catch(function (error) {
            Log.error("Error while saving document", error);
          });
          dataLossPopup.close();
        } else if (selectedKey === DraftDataLossOptions.Keep) {
          fnOnDataLossConfirmed();
          dataLossPopup.close();
        } else if (selectedKey === DraftDataLossOptions.Discard) {
          discardDraft(controller, skipBindingToView).then(fnOnDataLossConfirmed).catch(function (error) {
            Log.error("Error while discarding draft", error);
          });
          dataLossPopup.close();
        }
      },
      onDataLossCancel: function () {
        fnOnDataLossCancel();
        dataLossPopup.close();
      },
      setDataLossPopup: function (inDataLossPopup) {
        controller.dataLossPopup = inDataLossPopup;
      }
    };
    var i18nModel = view.getModel("sap.fe.i18n");
    var localThisModel = new JSONModel({}),
      preprocessorSettings = {
        bindingContexts: {
          "this": localThisModel.createBindingContext("/")
        },
        models: {
          "this": localThisModel,
          "i18n": i18nModel
        }
      };
    if (controller.dataLossPopup) {
      dataLossPopup = controller.dataLossPopup;
      dataLossPopup.open();
      selectAndFocusFirstEntry(dataLossPopup);
    } else {
      var dialogFragment = XMLTemplateProcessor.loadTemplate(fragmentName, "fragment");
      Promise.resolve(XMLPreprocessor.process(dialogFragment, {
        name: fragmentName
      }, preprocessorSettings)).then(function (fragment) {
        return Fragment.load({
          definition: fragment,
          controller: fragmentController
        });
      }).then(function (popup) {
        dataLossPopup = popup;
        popup.attachAfterOpen(function () {
          selectAndFocusFirstEntry(dataLossPopup);
        });
        view.addDependent(dataLossPopup);
        dataLossPopup.open();
        fragmentController.setDataLossPopup(dataLossPopup);
      }).catch(function (error) {
        Log.error("Error while opening the Discard Dialog fragment", error);
      });
    }
  }
  function performAfterDiscardorKeepDraft(processFunctionOnDatalossOk, processFunctionOnDatalossCancel, controller, skipBindingToView) {
    // Depending on if the user closed the data loss popup with Ok or Cancel,
    // execute the provided follow-up function and resolve or reject the promise
    return new Promise(function (resolve, reject) {
      var dataLossPopupOk = function (context) {
        var returnValue = processFunctionOnDatalossOk(context);
        resolve(returnValue);
      };
      var dataLossPopupCancel = function () {
        processFunctionOnDatalossCancel();
        reject();
      };
      fnDataLossConfirmation(dataLossPopupOk, dataLossPopupCancel, controller, skipBindingToView);
    });
  }
  _exports.performAfterDiscardorKeepDraft = performAfterDiscardorKeepDraft;
  function discardDraft(controller, skipBindingToView) {
    var context = controller.getView().getBindingContext();
    var params = {
      skipBackNavigation: true,
      skipDiscardPopover: true,
      skipBindingToView: skipBindingToView !== undefined ? skipBindingToView : true
    };
    return controller.editFlow.cancelDocument(context, params);
  }
  _exports.discardDraft = discardDraft;
  function saveDocument(controller) {
    var context = controller.getView().getBindingContext();
    // We check if we are on the OP and then call the internal _saveDocument from the OP controller
    // since here some special handling is done for creationRow before editFlow.saveDocument is called.
    // In case of a custom controller we directly call saveDocument from the editFlow
    if (controller.isA("sap.fe.templates.ObjectPage.ObjectPageController")) {
      return controller._saveDocument(context);
    } else {
      return controller.editFlow.saveDocument(context);
    }
  }
  _exports.saveDocument = saveDocument;
  function getSelectedKey(dataLossPopup) {
    // For not using control IDs we introduced customData in the fragment and
    // use it here for finding the correct list in the dialog and for
    // determining the selected option from the list
    var dataLossOptionsList = dataLossPopup.getContent().find(function (element) {
      return element.data("listIdentifier") === "draftDataLossOptionsList";
    });
    return dataLossOptionsList.getSelectedItem().data("itemKey");
  }
  _exports.getSelectedKey = getSelectedKey;
  function selectAndFocusFirstEntry(dataLossPopup) {
    // For not using control IDs we introduced customData in the fragment and
    // use it here for finding the correct list in the dialog.
    var dataLossOptionsList = dataLossPopup.getContent().find(function (element) {
      return element.data("listIdentifier") === "draftDataLossOptionsList";
    });
    // Preselect the first entry in the list
    var firstListItemOption = dataLossOptionsList.getItems()[0];
    dataLossOptionsList.setSelectedItem(firstListItemOption);
    // By default set the focus on the first button of the dialog
    dataLossPopup.getButtons()[0].focus();
  }
  _exports.selectAndFocusFirstEntry = selectAndFocusFirstEntry;
  return {
    performAfterDiscardorKeepDraft: performAfterDiscardorKeepDraft,
    discardDraft: discardDraft,
    saveDocument: saveDocument,
    getSelectedKey: getSelectedKey,
    selectAndFocusFirstEntry: selectAndFocusFirstEntry
  };
}, false);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEcmFmdERhdGFMb3NzT3B0aW9ucyIsImZuT25EYXRhTG9zc0NvbmZpcm1lZCIsImZuT25EYXRhTG9zc0NhbmNlbCIsImZuRGF0YUxvc3NDb25maXJtYXRpb24iLCJvbkRhdGFMb3NzT2siLCJvbkRhdGFMb3NzQ2FuY2VsIiwiY29udHJvbGxlciIsInNraXBCaW5kaW5nVG9WaWV3IiwiZGF0YUxvc3NQb3B1cCIsImZyYWdtZW50TmFtZSIsInZpZXciLCJnZXRWaWV3IiwiZnJhZ21lbnRDb250cm9sbGVyIiwic2VsZWN0ZWRLZXkiLCJnZXRTZWxlY3RlZEtleSIsIlNhdmUiLCJzYXZlRG9jdW1lbnQiLCJ0aGVuIiwiY2F0Y2giLCJlcnJvciIsIkxvZyIsImNsb3NlIiwiS2VlcCIsIkRpc2NhcmQiLCJkaXNjYXJkRHJhZnQiLCJzZXREYXRhTG9zc1BvcHVwIiwiaW5EYXRhTG9zc1BvcHVwIiwiaTE4bk1vZGVsIiwiZ2V0TW9kZWwiLCJsb2NhbFRoaXNNb2RlbCIsIkpTT05Nb2RlbCIsInByZXByb2Nlc3NvclNldHRpbmdzIiwiYmluZGluZ0NvbnRleHRzIiwiY3JlYXRlQmluZGluZ0NvbnRleHQiLCJtb2RlbHMiLCJvcGVuIiwic2VsZWN0QW5kRm9jdXNGaXJzdEVudHJ5IiwiZGlhbG9nRnJhZ21lbnQiLCJYTUxUZW1wbGF0ZVByb2Nlc3NvciIsImxvYWRUZW1wbGF0ZSIsIlByb21pc2UiLCJyZXNvbHZlIiwiWE1MUHJlcHJvY2Vzc29yIiwicHJvY2VzcyIsIm5hbWUiLCJmcmFnbWVudCIsIkZyYWdtZW50IiwibG9hZCIsImRlZmluaXRpb24iLCJwb3B1cCIsImF0dGFjaEFmdGVyT3BlbiIsImFkZERlcGVuZGVudCIsInBlcmZvcm1BZnRlckRpc2NhcmRvcktlZXBEcmFmdCIsInByb2Nlc3NGdW5jdGlvbk9uRGF0YWxvc3NPayIsInByb2Nlc3NGdW5jdGlvbk9uRGF0YWxvc3NDYW5jZWwiLCJyZWplY3QiLCJkYXRhTG9zc1BvcHVwT2siLCJjb250ZXh0IiwicmV0dXJuVmFsdWUiLCJkYXRhTG9zc1BvcHVwQ2FuY2VsIiwiZ2V0QmluZGluZ0NvbnRleHQiLCJwYXJhbXMiLCJza2lwQmFja05hdmlnYXRpb24iLCJza2lwRGlzY2FyZFBvcG92ZXIiLCJ1bmRlZmluZWQiLCJlZGl0RmxvdyIsImNhbmNlbERvY3VtZW50IiwiaXNBIiwiX3NhdmVEb2N1bWVudCIsImRhdGFMb3NzT3B0aW9uc0xpc3QiLCJnZXRDb250ZW50IiwiZmluZCIsImVsZW1lbnQiLCJkYXRhIiwiZ2V0U2VsZWN0ZWRJdGVtIiwiZmlyc3RMaXN0SXRlbU9wdGlvbiIsImdldEl0ZW1zIiwic2V0U2VsZWN0ZWRJdGVtIiwiZ2V0QnV0dG9ucyIsImZvY3VzIl0sInNvdXJjZVJvb3QiOiIuIiwic291cmNlcyI6WyJEYXRhTG9zc09yRHJhZnREaXNjYXJkSGFuZGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTG9nIGZyb20gXCJzYXAvYmFzZS9Mb2dcIjtcbmltcG9ydCB0eXBlIEN1c3RvbUxpc3RJdGVtIGZyb20gXCJzYXAvbS9DdXN0b21MaXN0SXRlbVwiO1xuaW1wb3J0IHR5cGUgRGlhbG9nIGZyb20gXCJzYXAvbS9EaWFsb2dcIjtcbmltcG9ydCB0eXBlIExpc3QgZnJvbSBcInNhcC9tL0xpc3RcIjtcbmltcG9ydCBGcmFnbWVudCBmcm9tIFwic2FwL3VpL2NvcmUvRnJhZ21lbnRcIjtcbmltcG9ydCBYTUxQcmVwcm9jZXNzb3IgZnJvbSBcInNhcC91aS9jb3JlL3V0aWwvWE1MUHJlcHJvY2Vzc29yXCI7XG5pbXBvcnQgWE1MVGVtcGxhdGVQcm9jZXNzb3IgZnJvbSBcInNhcC91aS9jb3JlL1hNTFRlbXBsYXRlUHJvY2Vzc29yXCI7XG5pbXBvcnQgSlNPTk1vZGVsIGZyb20gXCJzYXAvdWkvbW9kZWwvanNvbi9KU09OTW9kZWxcIjtcblxuZW51bSBEcmFmdERhdGFMb3NzT3B0aW9ucyB7XG5cdFNhdmUgPSBcImRyYWZ0RGF0YUxvc3NPcHRpb25TYXZlXCIsXG5cdEtlZXAgPSBcImRyYWZ0RGF0YUxvc3NPcHRpb25LZWVwXCIsXG5cdERpc2NhcmQgPSBcImRyYWZ0RGF0YUxvc3NPcHRpb25EaXNjYXJkXCJcbn1cblxubGV0IGZuT25EYXRhTG9zc0NvbmZpcm1lZDogRnVuY3Rpb247XG5sZXQgZm5PbkRhdGFMb3NzQ2FuY2VsOiBGdW5jdGlvbjtcbmZ1bmN0aW9uIGZuRGF0YUxvc3NDb25maXJtYXRpb24ob25EYXRhTG9zc09rOiBhbnksIG9uRGF0YUxvc3NDYW5jZWw6IGFueSwgY29udHJvbGxlcjogYW55LCBza2lwQmluZGluZ1RvVmlldzogYW55KSB7XG5cdC8vIE9wZW4gdGhlIGRhdGEgbG9zcyBwb3B1cCBhbmQgYWZ0ZXIgcHJvY2Vzc2luZyB0aGUgc2VsZWN0ZWQgZnVuY3Rpb24gZmluYWxseSBjYWxsXG5cdC8vIG9uRGF0YUxvc3NDb25maXJtZWQgd2hpY2ggcmVzb2x2ZXMgdGhlIHByb21pc2UgYW5kIGxlYWRzIHRvIHByb2Nlc3Npbmcgb2YgdGhlIG9yaWdpbmFsbHlcblx0Ly8gdHJpZ2dlcmVkIGFjdGlvbiBsaWtlIGUuZy4gYSBiYWNrIG5hdmlnYXRpb25cblx0bGV0IGRhdGFMb3NzUG9wdXA6IERpYWxvZztcblx0Zm5PbkRhdGFMb3NzQ29uZmlybWVkID0gb25EYXRhTG9zc09rO1xuXHRmbk9uRGF0YUxvc3NDYW5jZWwgPSBvbkRhdGFMb3NzQ2FuY2VsO1xuXHRjb25zdCBmcmFnbWVudE5hbWUgPSBcInNhcC5mZS5jb3JlLmNvbnRyb2xzLkRhdGFMb3NzT3JEcmFmdERpc2NhcmQuRGF0YUxvc3NEcmFmdFwiO1xuXHRjb25zdCB2aWV3ID0gY29udHJvbGxlci5nZXRWaWV3KCk7XG5cdGNvbnN0IGZyYWdtZW50Q29udHJvbGxlcjogYW55ID0ge1xuXHRcdG9uRGF0YUxvc3NPazogZnVuY3Rpb24gKCkge1xuXHRcdFx0Y29uc3Qgc2VsZWN0ZWRLZXkgPSBnZXRTZWxlY3RlZEtleShkYXRhTG9zc1BvcHVwKTtcblx0XHRcdGlmIChzZWxlY3RlZEtleSA9PT0gRHJhZnREYXRhTG9zc09wdGlvbnMuU2F2ZSkge1xuXHRcdFx0XHRzYXZlRG9jdW1lbnQoY29udHJvbGxlcilcblx0XHRcdFx0XHQudGhlbihmbk9uRGF0YUxvc3NDb25maXJtZWQpXG5cdFx0XHRcdFx0LmNhdGNoKGZ1bmN0aW9uIChlcnJvcjogYW55KSB7XG5cdFx0XHRcdFx0XHRMb2cuZXJyb3IoXCJFcnJvciB3aGlsZSBzYXZpbmcgZG9jdW1lbnRcIiwgZXJyb3IpO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRkYXRhTG9zc1BvcHVwLmNsb3NlKCk7XG5cdFx0XHR9IGVsc2UgaWYgKHNlbGVjdGVkS2V5ID09PSBEcmFmdERhdGFMb3NzT3B0aW9ucy5LZWVwKSB7XG5cdFx0XHRcdGZuT25EYXRhTG9zc0NvbmZpcm1lZCgpO1xuXHRcdFx0XHRkYXRhTG9zc1BvcHVwLmNsb3NlKCk7XG5cdFx0XHR9IGVsc2UgaWYgKHNlbGVjdGVkS2V5ID09PSBEcmFmdERhdGFMb3NzT3B0aW9ucy5EaXNjYXJkKSB7XG5cdFx0XHRcdGRpc2NhcmREcmFmdChjb250cm9sbGVyLCBza2lwQmluZGluZ1RvVmlldylcblx0XHRcdFx0XHQudGhlbihmbk9uRGF0YUxvc3NDb25maXJtZWQpXG5cdFx0XHRcdFx0LmNhdGNoKGZ1bmN0aW9uIChlcnJvcjogYW55KSB7XG5cdFx0XHRcdFx0XHRMb2cuZXJyb3IoXCJFcnJvciB3aGlsZSBkaXNjYXJkaW5nIGRyYWZ0XCIsIGVycm9yKTtcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0ZGF0YUxvc3NQb3B1cC5jbG9zZSgpO1xuXHRcdFx0fVxuXHRcdH0sXG5cdFx0b25EYXRhTG9zc0NhbmNlbDogZnVuY3Rpb24gKCkge1xuXHRcdFx0Zm5PbkRhdGFMb3NzQ2FuY2VsKCk7XG5cdFx0XHRkYXRhTG9zc1BvcHVwLmNsb3NlKCk7XG5cdFx0fSxcblx0XHRzZXREYXRhTG9zc1BvcHVwOiBmdW5jdGlvbiAoaW5EYXRhTG9zc1BvcHVwOiBEaWFsb2cpIHtcblx0XHRcdGNvbnRyb2xsZXIuZGF0YUxvc3NQb3B1cCA9IGluRGF0YUxvc3NQb3B1cDtcblx0XHR9XG5cdH07XG5cblx0Y29uc3QgaTE4bk1vZGVsID0gdmlldy5nZXRNb2RlbChcInNhcC5mZS5pMThuXCIpO1xuXHRjb25zdCBsb2NhbFRoaXNNb2RlbCA9IG5ldyBKU09OTW9kZWwoe30pLFxuXHRcdHByZXByb2Nlc3NvclNldHRpbmdzID0ge1xuXHRcdFx0YmluZGluZ0NvbnRleHRzOiB7XG5cdFx0XHRcdFwidGhpc1wiOiBsb2NhbFRoaXNNb2RlbC5jcmVhdGVCaW5kaW5nQ29udGV4dChcIi9cIilcblx0XHRcdH0sXG5cdFx0XHRtb2RlbHM6IHtcblx0XHRcdFx0XCJ0aGlzXCI6IGxvY2FsVGhpc01vZGVsLFxuXHRcdFx0XHRcImkxOG5cIjogaTE4bk1vZGVsXG5cdFx0XHR9XG5cdFx0fTtcblxuXHRpZiAoY29udHJvbGxlci5kYXRhTG9zc1BvcHVwKSB7XG5cdFx0ZGF0YUxvc3NQb3B1cCA9IGNvbnRyb2xsZXIuZGF0YUxvc3NQb3B1cDtcblx0XHRkYXRhTG9zc1BvcHVwLm9wZW4oKTtcblx0XHRzZWxlY3RBbmRGb2N1c0ZpcnN0RW50cnkoZGF0YUxvc3NQb3B1cCk7XG5cdH0gZWxzZSB7XG5cdFx0Y29uc3QgZGlhbG9nRnJhZ21lbnQgPSBYTUxUZW1wbGF0ZVByb2Nlc3Nvci5sb2FkVGVtcGxhdGUoZnJhZ21lbnROYW1lLCBcImZyYWdtZW50XCIpO1xuXHRcdFByb21pc2UucmVzb2x2ZShYTUxQcmVwcm9jZXNzb3IucHJvY2VzcyhkaWFsb2dGcmFnbWVudCwgeyBuYW1lOiBmcmFnbWVudE5hbWUgfSwgcHJlcHJvY2Vzc29yU2V0dGluZ3MpKVxuXHRcdFx0LnRoZW4oKGZyYWdtZW50KSA9PiB7XG5cdFx0XHRcdHJldHVybiBGcmFnbWVudC5sb2FkKHsgZGVmaW5pdGlvbjogZnJhZ21lbnQsIGNvbnRyb2xsZXI6IGZyYWdtZW50Q29udHJvbGxlciB9KTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbigocG9wdXA6IGFueSkgPT4ge1xuXHRcdFx0XHRkYXRhTG9zc1BvcHVwID0gcG9wdXA7XG5cdFx0XHRcdHBvcHVwLmF0dGFjaEFmdGVyT3BlbigoKSA9PiB7XG5cdFx0XHRcdFx0c2VsZWN0QW5kRm9jdXNGaXJzdEVudHJ5KGRhdGFMb3NzUG9wdXApO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0dmlldy5hZGREZXBlbmRlbnQoZGF0YUxvc3NQb3B1cCk7XG5cdFx0XHRcdGRhdGFMb3NzUG9wdXAub3BlbigpO1xuXHRcdFx0XHRmcmFnbWVudENvbnRyb2xsZXIuc2V0RGF0YUxvc3NQb3B1cChkYXRhTG9zc1BvcHVwKTtcblx0XHRcdH0pXG5cdFx0XHQuY2F0Y2goZnVuY3Rpb24gKGVycm9yOiBhbnkpIHtcblx0XHRcdFx0TG9nLmVycm9yKFwiRXJyb3Igd2hpbGUgb3BlbmluZyB0aGUgRGlzY2FyZCBEaWFsb2cgZnJhZ21lbnRcIiwgZXJyb3IpO1xuXHRcdFx0fSk7XG5cdH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBlcmZvcm1BZnRlckRpc2NhcmRvcktlZXBEcmFmdChcblx0cHJvY2Vzc0Z1bmN0aW9uT25EYXRhbG9zc09rOiBhbnksXG5cdHByb2Nlc3NGdW5jdGlvbk9uRGF0YWxvc3NDYW5jZWw6IGFueSxcblx0Y29udHJvbGxlcjogYW55LFxuXHRza2lwQmluZGluZ1RvVmlldzogYW55XG4pIHtcblx0Ly8gRGVwZW5kaW5nIG9uIGlmIHRoZSB1c2VyIGNsb3NlZCB0aGUgZGF0YSBsb3NzIHBvcHVwIHdpdGggT2sgb3IgQ2FuY2VsLFxuXHQvLyBleGVjdXRlIHRoZSBwcm92aWRlZCBmb2xsb3ctdXAgZnVuY3Rpb24gYW5kIHJlc29sdmUgb3IgcmVqZWN0IHRoZSBwcm9taXNlXG5cdHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZTogKHZhbHVlOiBhbnkpID0+IHZvaWQsIHJlamVjdDogKHJlYXNvbj86IGFueSkgPT4gdm9pZCkge1xuXHRcdGNvbnN0IGRhdGFMb3NzUG9wdXBPayA9IGZ1bmN0aW9uIChjb250ZXh0OiBhbnkpIHtcblx0XHRcdGNvbnN0IHJldHVyblZhbHVlID0gcHJvY2Vzc0Z1bmN0aW9uT25EYXRhbG9zc09rKGNvbnRleHQpO1xuXHRcdFx0cmVzb2x2ZShyZXR1cm5WYWx1ZSk7XG5cdFx0fTtcblx0XHRjb25zdCBkYXRhTG9zc1BvcHVwQ2FuY2VsID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0cHJvY2Vzc0Z1bmN0aW9uT25EYXRhbG9zc0NhbmNlbCgpO1xuXHRcdFx0cmVqZWN0KCk7XG5cdFx0fTtcblx0XHRmbkRhdGFMb3NzQ29uZmlybWF0aW9uKGRhdGFMb3NzUG9wdXBPaywgZGF0YUxvc3NQb3B1cENhbmNlbCwgY29udHJvbGxlciwgc2tpcEJpbmRpbmdUb1ZpZXcpO1xuXHR9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRpc2NhcmREcmFmdChjb250cm9sbGVyOiBhbnksIHNraXBCaW5kaW5nVG9WaWV3OiBhbnkpIHtcblx0Y29uc3QgY29udGV4dCA9IGNvbnRyb2xsZXIuZ2V0VmlldygpLmdldEJpbmRpbmdDb250ZXh0KCk7XG5cdGNvbnN0IHBhcmFtcyA9IHtcblx0XHRza2lwQmFja05hdmlnYXRpb246IHRydWUsXG5cdFx0c2tpcERpc2NhcmRQb3BvdmVyOiB0cnVlLFxuXHRcdHNraXBCaW5kaW5nVG9WaWV3OiBza2lwQmluZGluZ1RvVmlldyAhPT0gdW5kZWZpbmVkID8gc2tpcEJpbmRpbmdUb1ZpZXcgOiB0cnVlXG5cdH07XG5cdHJldHVybiBjb250cm9sbGVyLmVkaXRGbG93LmNhbmNlbERvY3VtZW50KGNvbnRleHQsIHBhcmFtcyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzYXZlRG9jdW1lbnQoY29udHJvbGxlcjogYW55KSB7XG5cdGNvbnN0IGNvbnRleHQgPSBjb250cm9sbGVyLmdldFZpZXcoKS5nZXRCaW5kaW5nQ29udGV4dCgpO1xuXHQvLyBXZSBjaGVjayBpZiB3ZSBhcmUgb24gdGhlIE9QIGFuZCB0aGVuIGNhbGwgdGhlIGludGVybmFsIF9zYXZlRG9jdW1lbnQgZnJvbSB0aGUgT1AgY29udHJvbGxlclxuXHQvLyBzaW5jZSBoZXJlIHNvbWUgc3BlY2lhbCBoYW5kbGluZyBpcyBkb25lIGZvciBjcmVhdGlvblJvdyBiZWZvcmUgZWRpdEZsb3cuc2F2ZURvY3VtZW50IGlzIGNhbGxlZC5cblx0Ly8gSW4gY2FzZSBvZiBhIGN1c3RvbSBjb250cm9sbGVyIHdlIGRpcmVjdGx5IGNhbGwgc2F2ZURvY3VtZW50IGZyb20gdGhlIGVkaXRGbG93XG5cdGlmIChjb250cm9sbGVyLmlzQShcInNhcC5mZS50ZW1wbGF0ZXMuT2JqZWN0UGFnZS5PYmplY3RQYWdlQ29udHJvbGxlclwiKSkge1xuXHRcdHJldHVybiBjb250cm9sbGVyLl9zYXZlRG9jdW1lbnQoY29udGV4dCk7XG5cdH0gZWxzZSB7XG5cdFx0cmV0dXJuIGNvbnRyb2xsZXIuZWRpdEZsb3cuc2F2ZURvY3VtZW50KGNvbnRleHQpO1xuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTZWxlY3RlZEtleShkYXRhTG9zc1BvcHVwOiBEaWFsb2cpIHtcblx0Ly8gRm9yIG5vdCB1c2luZyBjb250cm9sIElEcyB3ZSBpbnRyb2R1Y2VkIGN1c3RvbURhdGEgaW4gdGhlIGZyYWdtZW50IGFuZFxuXHQvLyB1c2UgaXQgaGVyZSBmb3IgZmluZGluZyB0aGUgY29ycmVjdCBsaXN0IGluIHRoZSBkaWFsb2cgYW5kIGZvclxuXHQvLyBkZXRlcm1pbmluZyB0aGUgc2VsZWN0ZWQgb3B0aW9uIGZyb20gdGhlIGxpc3Rcblx0Y29uc3QgZGF0YUxvc3NPcHRpb25zTGlzdDogTGlzdCA9IGRhdGFMb3NzUG9wdXBcblx0XHQuZ2V0Q29udGVudCgpXG5cdFx0LmZpbmQoKGVsZW1lbnQpID0+IGVsZW1lbnQuZGF0YShcImxpc3RJZGVudGlmaWVyXCIpID09PSBcImRyYWZ0RGF0YUxvc3NPcHRpb25zTGlzdFwiKSBhcyBMaXN0O1xuXHRyZXR1cm4gZGF0YUxvc3NPcHRpb25zTGlzdC5nZXRTZWxlY3RlZEl0ZW0oKS5kYXRhKFwiaXRlbUtleVwiKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdEFuZEZvY3VzRmlyc3RFbnRyeShkYXRhTG9zc1BvcHVwOiBEaWFsb2cpIHtcblx0Ly8gRm9yIG5vdCB1c2luZyBjb250cm9sIElEcyB3ZSBpbnRyb2R1Y2VkIGN1c3RvbURhdGEgaW4gdGhlIGZyYWdtZW50IGFuZFxuXHQvLyB1c2UgaXQgaGVyZSBmb3IgZmluZGluZyB0aGUgY29ycmVjdCBsaXN0IGluIHRoZSBkaWFsb2cuXG5cdGNvbnN0IGRhdGFMb3NzT3B0aW9uc0xpc3Q6IExpc3QgPSBkYXRhTG9zc1BvcHVwXG5cdFx0LmdldENvbnRlbnQoKVxuXHRcdC5maW5kKChlbGVtZW50KSA9PiBlbGVtZW50LmRhdGEoXCJsaXN0SWRlbnRpZmllclwiKSA9PT0gXCJkcmFmdERhdGFMb3NzT3B0aW9uc0xpc3RcIikgYXMgTGlzdDtcblx0Ly8gUHJlc2VsZWN0IHRoZSBmaXJzdCBlbnRyeSBpbiB0aGUgbGlzdFxuXHRjb25zdCBmaXJzdExpc3RJdGVtT3B0aW9uOiBDdXN0b21MaXN0SXRlbSA9IGRhdGFMb3NzT3B0aW9uc0xpc3QuZ2V0SXRlbXMoKVswXSBhcyBDdXN0b21MaXN0SXRlbTtcblx0ZGF0YUxvc3NPcHRpb25zTGlzdC5zZXRTZWxlY3RlZEl0ZW0oZmlyc3RMaXN0SXRlbU9wdGlvbik7XG5cdC8vIEJ5IGRlZmF1bHQgc2V0IHRoZSBmb2N1cyBvbiB0aGUgZmlyc3QgYnV0dG9uIG9mIHRoZSBkaWFsb2dcblx0ZGF0YUxvc3NQb3B1cC5nZXRCdXR0b25zKClbMF0uZm9jdXMoKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgeyBwZXJmb3JtQWZ0ZXJEaXNjYXJkb3JLZWVwRHJhZnQsIGRpc2NhcmREcmFmdCwgc2F2ZURvY3VtZW50LCBnZXRTZWxlY3RlZEtleSwgc2VsZWN0QW5kRm9jdXNGaXJzdEVudHJ5IH07XG4iXSwibWFwcGluZ3MiOiI7QUFBQTtBQUFBO0FBQUE7Ozs7O01BU0tBLG9CQUFvQjtFQUFBLFdBQXBCQSxvQkFBb0I7SUFBcEJBLG9CQUFvQjtJQUFwQkEsb0JBQW9C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
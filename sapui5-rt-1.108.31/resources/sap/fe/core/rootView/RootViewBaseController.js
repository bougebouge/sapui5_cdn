/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/BaseController","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/Placeholder","sap/fe/core/helpers/ClassSupport","sap/fe/macros/table/TableSizeHelper","sap/ui/base/BindingParser","sap/ui/core/routing/HashChanger","sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/thirdparty/URI"],function(e,t,r,n,a,o,i,c,s,u,l){"use strict";var f,h,p,g,d;var v=a.usingExtension;var m=a.defineUI5Class;function y(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=b(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var n=0;var a=function(){};return{s:a,n:function(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o=true,i=false,c;return{s:function(){r=r.call(e)},n:function(){var e=r.next();o=e.done;return e},e:function(e){i=true;c=e},f:function(){try{if(!o&&r.return!=null)r.return()}finally{if(i)throw c}}}}function b(e,t){if(!e)return;if(typeof e==="string")return P(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return P(e,t)}function P(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++){n[r]=e[r]}return n}function C(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}function R(e,t,r,n){if(!r)return;Object.defineProperty(e,t,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(n):void 0})}function T(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function _(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;M(e,t)}function M(e,t){M=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return M(e,t)}function H(e,t,r,n,a){var o={};Object.keys(n).forEach(function(e){o[e]=n[e]});o.enumerable=!!o.enumerable;o.configurable=!!o.configurable;if("value"in o||o.initializer){o.writable=true}o=r.slice().reverse().reduce(function(r,n){return n(e,t,r)||r},o);if(a&&o.initializer!==void 0){o.value=o.initializer?o.initializer.call(a):void 0;o.initializer=undefined}if(o.initializer===void 0){Object.defineProperty(e,t,o);o=null}return o}function I(e,t){throw new Error("Decorating class property failed. Please ensure that "+"proposal-class-properties is enabled and runs after the decorators transform.")}var w=(f=m("sap.fe.core.rootView.RootViewBaseController"),h=v(n),f(p=(g=function(t){_(n,t);function n(){var e;for(var r=arguments.length,n=new Array(r),a=0;a<r;a++){n[a]=arguments[a]}e=t.call.apply(t,[this].concat(n))||this;R(e,"oPlaceholder",d,T(e));e.bIsComputingTitleHierachy=false;return e}var a=n.prototype;a.onInit=function e(){o.init();this._aHelperModels=[]};a.getPlaceholder=function e(){return this.oPlaceholder};a.attachRouteMatchers=function e(){this.oPlaceholder.attachRouteMatchers();this.getAppComponent().getRoutingService().attachAfterRouteMatched(this._onAfterRouteMatched,this)};a.onExit=function e(){this.getAppComponent().getRoutingService().detachAfterRouteMatched(this._onAfterRouteMatched,this);this.oRouter=undefined;o.exit();this._aHelperModels.forEach(function(e){e.destroy()})};a.getResourceBundle=function e(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()};a.getRouter=function e(){if(!this.oRouter){this.oRouter=this.getAppComponent().getRouter()}return this.oRouter};a._createHelperModel=function e(){var t=new s;this._aHelperModels.push(t);return t};a.waitForRightMostViewReady=function e(t){return new Promise(function(e){var r=t.getParameter("views"),n=[];r.forEach(function(e){var t=e;if(e&&e.getComponentInstance){var r=e.getComponentInstance();t=r.getRootControl()}if(t&&t.getController()&&t.getController().pageReady){n.push(t)}});var a=n[n.length-1];if(a&&a.getController().pageReady.isPageReady()){e(a)}else if(a){a.getController().pageReady.attachEventOnce("pageReady",function(){e(a)})}})};a._onAfterRouteMatched=function t(r){var n=this;if(!this._oRouteMatchedPromise){this._oRouteMatchedPromise=this.waitForRightMostViewReady(r).then(function(e){var t=n.getView().getContent()[0];if(t&&t.getAutoFocus&&!t.getAutoFocus()){t.setProperty("autoFocus",true,true)}var r=n.getAppComponent();n._scrollTablesToLastNavigatedItems();if(r.getEnvironmentCapabilities().getCapabilities().UShell){n._computeTitleHierarchy(e)}var a=r.getRouterProxy().isFocusForced();r.getRouterProxy().setFocusForced(false);if(e.getController()&&e.getController().onPageReady&&e.getParent().onPageReady){e.getParent().onPageReady({forceFocus:a})}if(n.onContainerReady){n.onContainerReady()}}).catch(function(t){e.error("An error occurs while computing the title hierarchy and calling focus method",t)}).finally(function(){n._oRouteMatchedPromise=null})}};a._getTitleHierarchyCache=function e(){if(!this.oTitleHierarchyCache){this.oTitleHierarchyCache={}}return this.oTitleHierarchyCache};a._computeTitleInfo=function e(t,r,n){var a=n.split("/");n=l.decode(n);if(a[a.length-1].indexOf("?")===-1){n+="?restoreHistory=true"}else{n+="&restoreHistory=true"}return{title:t,subtitle:r,intent:n,icon:""}};a._formatTitle=function e(t,r,n){var a="";switch(t){case"Value":a="".concat(r);break;case"ValueDescription":a="".concat(r," (").concat(n,")");break;case"DescriptionValue":a="".concat(n," (").concat(r,")");break;case"Description":a="".concat(n);break;default:}return a};a._fetchTitleValue=function t(n){try{var a=false;var o=this;var c=o.getAppComponent(),s=o.getView().getModel(),l=c.getMetaModel(),f=l.getMetaPath(n),h=s.createBindingContext(n),p=u.format(l.getObject("".concat(f,"/@com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value")),{context:l.createBindingContext("/")});if(!p){return Promise.resolve("")}var g=u.format(l.getObject("".concat(f,"/@com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value/$Path@com.sap.vocabularies.Common.v1.Text")),{context:l.createBindingContext("/")}),d=l.getObject("".concat(f,"/@com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value/$Path@")),v=[],m=i.complexParser(p),y=new Promise(function(e){var t=r.computeDisplayMode(d);e(t)});v.push(y);var b=m.parts?m.parts[0].path:m.path,P=m.formatter,R=s.bindProperty(b,h);R.initialize();var T=new Promise(function(e){var t=function(r){var n=P?P(r.getSource().getValue()):r.getSource().getValue();R.detachChange(t);e(n)};R.attachChange(t)});v.push(T);if(g){var _=i.complexParser(g);var M=_.parts?_.parts[0].path:_.path;M=b.lastIndexOf("/")>-1?"".concat(b.slice(0,b.lastIndexOf("/")),"/").concat(M):M;var H=_.formatter,I=s.bindProperty(M,h);I.initialize();var w=new Promise(function(e){var t=function(r){var n=H?H(r.getSource().getValue()):r.getSource().getValue();I.detachChange(t);e(n)};I.attachChange(t)});v.push(w)}var A=C(function(){return Promise.resolve(Promise.all(v)).then(function(e){var t="";if(typeof e!=="string"){t=o._formatTitle(e[0],e[1],e[2])}a=true;return t})},function(t){e.error("Error while fetching the title from the header info :"+t)});return Promise.resolve(A&&A.then?A.then(function(e){return a?e:""}):a?A:"")}catch(e){return Promise.reject(e)}};a._getAppSpecificHash=function e(){return c.getInstance().hrefForAppSpecificHash?c.getInstance().hrefForAppSpecificHash(""):""};a._getHash=function e(){return c.getInstance().getHash()};a.getTitleInfoFromPath=function e(t){var r=this;var n=this._getTitleHierarchyCache();if(n[t]){return Promise.resolve(n[t])}var a=this.getAppComponent().getMetaModel();var o=a.getMetaPath(t);var i=a.getObject("".concat(o,"/@com.sap.vocabularies.UI.v1.HeaderInfo/TypeName"));var c=this._getAppSpecificHash();var s=c+t.slice(1);return this._fetchTitleValue(t).then(function(e){var a=r._computeTitleInfo(i,e,s);n[t]=a;return a})};a._ensureHierarchyElementsAreStrings=function e(t){var r=[];for(var n in t){var a=t[n];var o={};for(var i in a){o[i]=typeof a[i]!=="string"?String(a[i]):a[i]}r.push(o)}return r};a._getTargetTypeFromHash=function e(t){var r=this.getAppComponent();var n="";var a=r.getManifestEntry("/sap.ui5/routing/routes");var o=y(a),i;try{for(o.s();!(i=o.n()).done;){var c=i.value;var s=r.getRouter().getRoute(c.name);if(s.match(t)){var u=Array.isArray(c.target)?c.target[0]:c.target;n=r.getRouter().getTarget(u)._oOptions.name;break}}}catch(e){o.e(e)}finally{o.f()}return n};a._computeTitleHierarchy=function t(r){var n=this;var a=this.getAppComponent(),o=r.getBindingContext(),i=r.getParent(),c=[],s=this._getAppSpecificHash(),u=a.getMetadata().getManifestEntry("sap.app").title||"",l=a.getMetadata().getManifestEntry("sap.app").appSubTitle||"";var f,h;if(i&&i._getPageTitleInformation){if(o){if(this._getTargetTypeFromHash("")==="sap.fe.templates.ListReport"){c.push(Promise.resolve(this._computeTitleInfo(u,l,s)))}h=o.getPath();var p=h.split("/");var g="";p.shift();p.pop();p.forEach(function(e){g+="/".concat(e);var t=a.getMetaModel(),r=t.getMetaPath(g),o=t.getObject("".concat(r,"/@com.sap.vocabularies.Common.v1.ResultContext"));if(!o){c.push(n.getTitleInfoFromPath(g))}})}f=i._getPageTitleInformation();f=this._computeTitleInfo(f.title,f.subtitle,s+this._getHash());if(o){this._getTitleHierarchyCache()[h]=f}else{this._getTitleHierarchyCache()[s]=f}}else{c.push(Promise.reject("Title information missing in HeaderInfo"))}return Promise.all(c).then(function(e){var t=n._ensureHierarchyElementsAreStrings(e),r=f.title;t.reverse();a.getShellServices().setHierarchy(t);a.getShellServices().setTitle(r)}).catch(function(t){e.error(t)}).finally(function(){n.bIsComputingTitleHierachy=false}).catch(function(t){e.error(t)})};a.calculateLayout=function e(t,r,n){var a=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;return null};a.onContextBoundToView=function e(t){if(t){var r=this.getView().getModel("internal").getProperty("/deepestPath"),n=t.getPath();if(!r||r.indexOf(n)!==0){this.getView().getModel("internal").setProperty("/deepestPath",n,undefined,true)}}};a.displayMessagePage=function e(t,r){return Promise.resolve(true)};a.updateUIStateForView=function e(t,r){};a.getInstancedViews=function e(){return[]};a._scrollTablesToLastNavigatedItems=function e(){};a.getAppContentContainer=function e(t){var r=this.getAppComponent();var n=r.getManifestEntry("/sap.ui5/routing/config/controlId")||"appContent";return t.byId(n)};return n}(t),d=H(g.prototype,"oPlaceholder",[h],{configurable:true,enumerable:true,writable:true,initializer:null}),g))||p);return w},false);
//# sourceMappingURL=RootViewBaseController.js.map
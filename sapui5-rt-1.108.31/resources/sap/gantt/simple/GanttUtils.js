/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/core/Core","sap/ui/core/CalendarType","sap/gantt/misc/Utility","sap/ui/core/format/DateFormat","sap/ui/core/Locale","sap/m/OverflowToolbar","sap/ui/core/theming/Parameters","sap/ui/Device","./CoordinateUtils","sap/gantt/misc/Format","sap/gantt/library"],function(jQuery,e,t,r,a,n,i,s,o,l,g,c,u){"use strict";var f={};var p={};var h=false;var d=false;var m={SHAPE_ID_DATASET_KEY:"data-sap-gantt-shape-id",ROW_ID_DATASET_KEY:"data-sap-gantt-row-id",CONNECTABLE_DATASET_KEY:"data-sap-gantt-connectable",SELECT_FOR_DATASET_KEY:"sap-gantt-select-for",SHAPE_CONNECT_FOR_DATASET_KEY:"sap-gantt-shape-connect-for",SHAPE_CONNECT_INDICATOR_WIDTH:10,oDateFormat:n.getDateInstance({pattern:"yyyyMMddHHmmss",calendarType:r.Gregorian}),shapeElementById:function(e,t){var r=window.document.getElementById(t),a=r.querySelector("g.sapGanttChartShapes");var n=a.querySelectorAll("["+m.SHAPE_ID_DATASET_KEY+"='"+e+"']");var i=n[0];if(i){return jQuery(i).control(0)}return null},getValueX:function(r){var a;var n=r.getMetadata().getProperty("x");if(n){a=r.getProperty(n.name);if(a!==null&&a!==undefined){return a}}var i=t.getConfiguration().getRTL(),s=i?r.getEndTime()||r.getTime():r.getTime();if(s){a=r.getXByTime(s)}if(!jQuery.isNumeric(a)){e.warning("couldn't convert timestamp to x with value: "+s)}return a},getRowInstance:function(e,t){var r=jQuery(e.target).closest("rect.sapGanttBackgroundSVGRow").data("sapUiIndex");if(r!=null){return t.getRows()[r]}},getRowInstancefromShape:function(e){var t=e.getParentRowSettings();if(t!=null){return t.getParentRow()}},_get2dContext:function(e,t,r){if(!f.context){f.context=document.createElement("canvas").getContext("2d")}if(f.fontSize!==e||f.fontFamily!==t||f.fontWeight!==r){f.context.font=r+" "+e+"px "+t;f.fontSize=e;f.fontFamily=t;f.fontWeight=r}return f.context},getShapeTextWidth:function(e,t,r,a){return this._get2dContext(t,r,a).measureText(e).width},getSelectedTableRowSettings:function(e,t){var r=e.getRows(),a=e.getFirstVisibleRow();if(r.length===0){return null}var n=r[0].getIndex();var i=t-a;if(n!==a){i+=Math.abs(n-a)}if(!r[i]){return null}return r[i].getAggregation("_settings")},updateGanttRows:function(e,t,r){var a=e.getParent().getParent();var n=jQuery(document.getElementById(a.getId()+"-svg")),i=n.find("rect.sapGanttBackgroundSVGRow");if(a.getEnableChartSelectionState()){i.eq(r).toggleClass("sapGanttBackgroundSVGRowSelected",!!t[r].selected)}if(a.getEnableChartHoverState()){i.eq(r).toggleClass("sapGanttBackgroundSVGRowHovered",!!t[r].hovered)}},getShapesWithUid:function(e,t){var r=function(t){var r=a.parseUid(t),n=r.shapeId;var i=["[id='",e,"']"," ["+m.SHAPE_ID_DATASET_KEY+"='",n,"']"].join("");return jQuery(i).control().filter(function(e){return e.getShapeUid()===t})[0]};return t.map(r)},getShapeByShapeId:function(e,t){var r=[];t.forEach(function(t){var a=["[id='",e,"']"," ["+m.SHAPE_ID_DATASET_KEY+"='",t,"']"].join("");var n=document.querySelector(a);if(n){var i=sap.ui.getCore().byId(n.id);r.push(i)}});return r},getShapesInRowsById:function(e,t){var r=document.getElementById(e);var a=[];t.forEach(function(e){if(r){var t=r.querySelector("[data-sap-gantt-row-id='"+e+"']");if(t){a=Array.from(t.children).filter(function(e){return e.id!==""}).reduce(function(e,t){return e.concat(sap.ui.getCore().byId(t.id))},a)}}});return a},getShapeIdFromShapeUid:function(e){return e.map(function(e){var t=a.parseUid(e);return t.shapeId})},getTimeFormaterBySmallInterval:function(e){var r=e.getAxisTimeStrategy(),a=r.getTimeLineOption().smallInterval,s=a.unit;var o=r.getCalendarType(),l=r.getLocale()?r.getLocale():new i(t.getConfiguration().getLanguage().toLowerCase());var g="yyyyMMMddhhms";if(!(s===sap.gantt.config.TimeUnit.minute||s===sap.gantt.config.TimeUnit.hour)){g="yyyyMMMdd"}return n.getDateTimeInstance({format:g,style:a.style,calendarType:o},a.locale?new i(a.locale):l)},getFormatedDateByTimeZone:function(e){var t=this.oDateFormat.format(e);return c.abapTimestampToDate(t)},resetStrokeDasharray:function(e){if(!e){return}var t=e.getSimpleAdhocLines().find(function(e){return e._getSelected()});if(t){t._setSelected(false);var r=document.getElementById(t._getHeaderLine().sId);var a=document.getElementById(t._getLine().sId);var n=document.getElementById(t._getMarker().getId());n.style.cursor="pointer";if(a&&r){a.style.strokeDasharray=t.getStrokeDasharray();r.style.strokeDasharray=t.getStrokeDasharray();a.style.strokeWidth=t._getStrokeWidth();r.style.strokeWidth=t._getStrokeWidth()}}var i=e.getDeltaLines().find(function(e){return e._getIsSelected()});if(i){var s=i._getChartDeltaArea();if(s){var l=document.getElementById(s.sId);if(i._getEnableChartDeltaAreaHighlight()===true){l.style.opacity=0}}var g=document.getElementById(i._getForwardMarker().sId);var c=document.getElementById(i._getBackwardMarker().sId);var u=document.getElementById(i._getHeaderDeltaArea().sId);var f=o.get("sapUiChartDataPointBorderColor");if(i.getVisibleDeltaStartEndLines()){var p=document.getElementById(i._getStartLine().sId);var h=document.getElementById(i._getEndLine().sId);var d=document.getElementById(i._getHeaderStartLine().sId);var m=document.getElementById(i._getHeaderEndLine().sId);p.style.strokeDasharray=i.getStrokeDasharray();h.style.strokeDasharray=i.getStrokeDasharray();d.style.strokeDasharray=i.getStrokeDasharray();m.style.strokeDasharray=i.getStrokeDasharray();p.style.strokeWidth=i._getStrokeWidth();h.style.strokeWidth=i._getStrokeWidth();d.style.strokeWidth=i._getStrokeWidth();m.style.strokeWidth=i._getStrokeWidth()}g.style.fillOpacity=0;c.style.fillOpacity=0;u.style.opacity=1;u.style.cursor="pointer";g.style.stroke=null;c.style.stroke=null;if(i._getVisibleMarker()===true){g.style.fillOpacity=1;c.style.fillOpacity=1;g.style.stroke=f;c.style.stroke=f}var S=e._getResizeExtension();S.clearAllDeltaOutline();i._setIsSelected(false)}},adhocLinesPresentAndEnabled:function(e){return e.getSimpleAdhocLines().filter(function(e){return e.MarkerType!=sap.gantt.simple.MarkerType.None}).length>0&&e.getEnableAdhocLine()},addToolbarToTable:function(e,t,r){if(r){if(t.getExtension().length==0){var a=new s;a.addContent(e.oExportTableToExcelButton);t.addExtension(a)}else{t.getExtension()[0].addContent(e.oExportTableToExcelButton)}}},findSpaceInLevel:function(e,t,r,a){for(var n=0;n<p[e].length;n++){if(d){return}if(p[e].length>1){if(n===0&&(t[a]()<=p[e][n][r]()||t[a]()>p[e][n][r]()&&t[a]()-p[e][n][r]()<=1e3)&&!(t[r]().getTime()===p[e][n][r]().getTime()&&t[a]().getTime()===p[e][n][a]().getTime())){p[e].push(t);h=true}else if(p[e][n+1]!==undefined&&(t[r]()>=p[e][n][a]()&&t[a]()<=p[e][n+1][r]()||t[r]()<p[e][n][a]()&&p[e][n][a]()-t[r]()<=1e3&&(t[a]()>p[e][n+1][r]()&&t[a]()-p[e][n+1][r]()<=1e3||t[a]()<=p[e][n+1][r]())||t[a]()>p[e][n+1][r]()&&t[a]()-p[e][n+1][r]()<=1e3&&(t[r]()>=p[e][n][a]()||t[r]()<p[e][n][a]()&&p[e][n][a]()-t[r]()<=1e3))&&!(t[r]().getTime()===p[e][n][r]().getTime()&&t[a]().getTime()===p[e][n][a]().getTime()||t[r]().getTime()===p[e][n+1][r]().getTime()&&t[a]().getTime()===p[e][n+1][a]().getTime())){p[e].push(t);h=true}else if(n===p[e].length-1&&(t[r]()>=p[e][n][a]()||t[r]()<p[e][n][a]()&&p[e][n][a]()-t[r]()<=1e3)&&!(t[r]().getTime()===p[e][n][r]().getTime()&&t[a]().getTime()===p[e][n][a]().getTime())){p[e].push(t);h=true}else if(t[r]().getTime()===p[e][n][r]().getTime()&&t[a]().getTime()===p[e][n][a]().getTime()){if(parseInt(e,10)===Object.keys(p).length-1){p[parseInt(e,10)+1]=[t];h=true}else{h=false}}else{if(n===p[e].length-1&&parseInt(e,10)===Object.keys(p).length-1){p[parseInt(e,10)+1]=[t];h=true}else{h=false}}}else{if((t[r]()>=p[e][n][a]()||t[r]()<p[e][n][a]()&&p[e][n][a]()-t[r]()<=1e3||(t[a]()<=p[e][n][r]()||t[a]()>p[e][n][r]()&&t[a]()-p[e][n][r]()<=1e3))&&!(t[r]().getTime()===p[e][n][r]().getTime()&&t[a]().getTime()===p[e][n][a]().getTime())){p[e].push(t);h=true}else if(t[r]().getTime()===p[e][n][r]().getTime()&&t[a]().getTime()===p[e][n][a]().getTime()){if(parseInt(e,10)===Object.keys(p).length-1){p[parseInt(e,10)+1]=[t];h=true}else{h=false}}else{if(parseInt(e,10)===Object.keys(p).length-1){p[parseInt(e,10)+1]=[t];h=true}else{h=false}}}if(h){n=p[e].length;d=true;p=this.sortShapesByTime(p,e,r)}}},sortShapesByTime:function(e,t,r){var a=e[t].length;var n;do{n=false;for(var i=0;i<a;i++){if(e[t][i+1]!==undefined){if(e[t][i][r]()>e[t][i+1][r]()){var s=e[t][i];e[t][i]=e[t][i+1];e[t][i+1]=s;n=true}}}}while(n);return e},_partitionShapesIntoOverlappingRanges:function(e,t,r){p={};var a="get"+t.charAt(0).toUpperCase()+t.slice(1);var n="get"+r.charAt(0).toUpperCase()+r.slice(1);if(e.length>0){p[0]=[e[0]]}for(var i=1,s=e.length;i<s;i++){d=false;for(var o in p){this.findSpaceInLevel(o,e[i],a,n)}}return p},calculateLevelForShapes:function(e,t,r){var a=function(e){return e.reduce(function(e,t){return e.concat(Array.isArray(t)?a(t):t)},[])};var n=this._partitionShapesIntoOverlappingRanges(e,t,r);var i=0;var s=Object.values(n).map(function(e,t){e.map(function(e){var r=t+1;if(e._setLevel){e._setLevel(r)}e._level=r;if(i<r){i=r}return e});return e});var o=a(s);var l={shapes:o,maxLevel:i};return l},_partitionLinesIntoOverlappingRanges:function(e){e.sort(function(e,t){if(e.getTimeStamp()<t.getTimeStamp()){return-1}if(e.getTimeStamp()>t.getTimeStamp()){return 1}return 0});var t=function(e){if(e.length==0){return false}e.sort(function(e,t){var r;if(e instanceof sap.gantt.simple.AdhocLine){r=e.getTimeStamp()}else{r=e.getEndTimeStamp()}var a;if(t instanceof sap.gantt.simple.AdhocLine){a=t.getTimeStamp()}else{a=t.getEndTimeStamp()}if(r<a){return 1}if(r>a){return-1}return 0});if(e[0]instanceof sap.gantt.simple.AdhocLine){return e[0].getTimeStamp()}else{return e[0].getEndTimeStamp()}};var r=[];var a=0;if(e.length>0){r[a]=[e[0]]}for(var n=1,i=e.length;n<i;n++){if(e[n].getTimeStamp()>=e[n-1].getTimeStamp()&&e[n].getTimeStamp()<t(r[a])){r[a].push(e[n])}else{a++;r[a]=[e[n]]}}return r},calculateLevelForMarkers:function(e,t){var r=function(e){return e.reduce(function(e,t){return e.concat(Array.isArray(t)?r(t):t)},[])};var a=e.concat(t);var n=this._partitionLinesIntoOverlappingRanges(a);var i=0;var s=n.map(function(e){e.map(function(e,t){var r=t+1;e._setLevel(r);if(i<r){i=r}return e});return e});var o=r(s);var l={adhocLines:o.filter(function(e){if(sap.gantt.simple.AdhocLine){return e instanceof sap.gantt.simple.AdhocLine}}),deltaLines:o.filter(function(e){if(sap.gantt.simple.DeltaLine){return e instanceof sap.gantt.simple.DeltaLine}}),maxLevel:i};return l},getShapeSuccessors:function(e,t){var r=[];if(e.getEnableChainSelection()){var a=this._getVisibleRelationships(t);var n=a.filter(function(t){return t.getPredecessor()===e.getShapeId()});n.forEach(function(e){var a=e.getRelatedInRowShapes(t.getId());if(a.successor){r.push(a.successor)}});r=Array.from(new Set(r))}return r},getShapePredeccessors:function(e,t){var r=[];if(e.getEnableChainSelection()){var a=this._getVisibleRelationships(t);var n=a.filter(function(t){return t.getSuccessor()===e.getShapeId()});n.forEach(function(e){var a=e.getRelatedInRowShapes(t.getId());if(a.predecessor){r.push(a.predecessor)}});r=Array.from(new Set(r))}return r},selectAssociatedShapes:function(e,t){var r=e.shape;var a=t._getDragDropExtension();var n=!r.getSelected();if(a.shapeSelectedOnMouseDown&&!a.initiallySelected&&!t.getEnableSelectAndDrag()){n=a.shapeSelectedOnMouseDown}var i=[r];if(r.getEnableChainSelection()){i=this._getShapesToSelect(r,t);i.forEach(function(e){this.oSelection.updateShape(e.getShapeUid(),{selected:n,ctrl:true,draggable:e.getDraggable(),time:e.getTime(),endTime:e.getEndTime()})}.bind(t))}return i},_getShapesToSelect:function(e,t){var r=[e];var a=this._getVisibleRelationships(t);var n=a.filter(function(t){return t.getPredecessor()===e.getShapeId()||t.getSuccessor()===e.getShapeId()});n.forEach(function(e){var a=e.getRelatedInRowShapes(t.getId());if(a.predecessor&&a.predecessor.getSelectableInChainSelection()){r.push(a.predecessor)}if(a.successor&&a.successor.getSelectableInChainSelection()){r.push(a.successor)}});r=Array.from(new Set(r));return r},_getVisibleRelationships:function(e){var t=[];e.getTable().getRows().forEach(function(e){var r=e.getAggregation("_settings").getRelationships();t=t.concat(r)});t=Array.from(new Set(t));return t},rerenderAssociatedRelationships:function(e,r){var a=t.createRenderManager();var n=[];var i=this._getVisibleRelationships(e);i.forEach(function(e){if(e.getSuccessor()===r.getShapeId()||e.getPredecessor()===r.getShapeId()){n.push(e)}});n.forEach(function(t){t.renderElement(a,t,e.getId())})},getFilteredShapeType:function(e){e=Array.from(new Set(e));return e.filter(function(e){return e!=="None"})},getPathCorners:function(e,t){var r=e.replace(/([A-Z])/g," $1");var a=[],n;var i=r.split(/[,\s]/).reduce(function(e,t){var r=t.match("([a-zA-Z])(.+)");if(r){e.push(r[1]);e.push(r[2])}else{e.push(t)}return e},[]);var s=i.reduce(function(e,t){if(parseFloat(t)==t&&e.length){e[e.length-1].push(t)}else{e.push([t])}return e},[]);function o(e,t,r){var a=t.x-e.x;var n=t.y-e.y;var i=Math.sqrt(a*a+n*n);return l(e,t,Math.min(1,r/i))}function l(e,t,r){return{x:e.x+(t.x-e.x)*r,y:e.y+(t.y-e.y)*r}}function g(e,t){if(e.length>2){e[e.length-2]=t.x;e[e.length-1]=t.y}}function c(e){return{x:parseFloat(e[e.length-2]),y:parseFloat(e[e.length-1])}}if(s.length>1){var u=c(s[0]),f=null;if(s[s.length-1][0]=="Z"&&s[0].length>2){f=["L",u.x,u.y];s[s.length-1]=f}a.push(s[0]);for(var p=1;p<s.length;p++){var h=a[a.length-1],d=s[p],m=d==f?s[1]:s[p+1],S=t;if(m&&h&&h.length>2&&d[0]=="L"&&m.length>2&&m[0]=="L"){var v=c(h),y=c(d),T=c(m),E,I,A=Math.abs(v.x-y.x)+Math.abs(v.y-y.y),_=Math.abs(T.x-y.x)+Math.abs(T.y-y.y),x=Math.max(Math.min(S,A,_/2),1);E=o(y,v,x);I=o(y,T,x);g(d,E);d.origPoint=y;a.push(d);var D=l(E,y,.5),L=l(y,I,.5),b=["C",D.x,D.y,L.x,L.y,I.x,I.y];b.origPoint=y;a.push(b)}else{a.push(d)}}if(f){var k=c(a[a.length-1]);a.push(["Z"]);g(a[0],k)}}else{a=s}n=a.reduce(function(e,t){return e+t.join(" ")+" "},"");return n},arrayMove:function(e,t,r){if(r>=e.length){var a=r-e.length+1;while(a--){e.push(undefined)}}e.splice(r,0,e.splice(t,1)[0]);return e},getEdgePoint:function(e){var t=2;var r=["Arrow","None"];var a=this._getVisibleRelationships(e);a.forEach(function(a){if(a.getPredecessor()!==undefined&&a.getSuccessor()!==undefined&&(a.getShapeTypeStart()!=="None"||r.indexOf(a.getShapeTypeEnd())==-1)||e.getRelationshipShapeSize()==sap.gantt.simple.relationshipShapeSize.Large){t=3}});return t},getTimeLabel:function(e,t,r,n){var i=g.getEventSVGPoint(n,e),s=c.dateToAbapTimestamp(t.viewToTime(i.x)),o=c._convertUTCToLocalTime(s,r),l=t.getZoomStrategy();var u=l.getLowerRowFormatter().format(o);return a.getLowerCaseLabel(u)},getVisibleElements:function(e,t,r){return Array.from(e.querySelectorAll(t)).reduce(function(e,t){return e.concat(Array.from(t.querySelectorAll(r)))},[])},isDynamicText:function(){var e=u.simple.horizontalTextAlignment;var r=false;var a=Array.from(document.querySelectorAll(".sapGanttChartSvg .sapGanttChartShapes .baseShapeSelection")).filter(function(e){if(!e.classList.contains("sapGanttTextNoPointerEvents")&&e.tagName!="text"){return e}});a.forEach(function(a){var n=a.closest("[data-sap-ui]").getAttribute("data-sap-ui");var i=t.byId(n);if(i&&!r){if(i instanceof sap.gantt.simple.BaseConditionalShape){var s=i._getActiveShapeElement();if(s instanceof sap.gantt.simple.BaseGroup){s.getShapes().forEach(function(t){if(t.getHorizontalTextAlignment()===e.Dynamic){r=true}})}else{if(i.getHorizontalTextAlignment()===e.Dynamic){r=true}}}else if(i instanceof sap.gantt.simple.MultiActivityGroup){if(i.getTask().getHorizontalTextAlignment()===e.Dynamic){r=true}}else if(i instanceof sap.gantt.simple.BaseGroup){i.getShapes().forEach(function(t){if(t.getHorizontalTextAlignment()===e.Dynamic){r=true}})}else{if(i.getHorizontalTextAlignment()===e.Dynamic){r=true}}}});if(!r){var n=Array.from(document.querySelectorAll(".sapGanttChartSvg .sapGanttChartCalendar .baseShapeSelection")).filter(function(e){if(!e.classList.contains("sapGanttTextNoPointerEvents")&&e.tagName!="text"){return e}});n.forEach(function(a){if(!r){var n=a.closest("[data-sap-ui]").getAttribute("data-sap-ui");var i=t.byId(n);if(i.getHorizontalTextAlignment()===e.Dynamic){r=true}}})}return r},setLmarker:function(e,r,a){var n=r.mAnchors.predecessor.x,i=r.mAnchors.predecessor.y;var s=r.mAnchors.successor.x,o=r.mAnchors.successor.y;r.setProperty("_lMarker","",true);var l=r.getProcessedType();var g=e._edgePoint;if(l===1&&n<=s){if(t.getConfiguration().getRTL()?r.getLShapeForTypeSF():r.getLShapeForTypeFS()){if(g==2&&r.getShapeTypeStart()=="None"||g==3&&Math.abs(n-s)>=g*6){if(i>o){r.setProperty("_lMarker","rightUp",true)}else{r.setProperty("_lMarker","rightDown",true)}}}}else if(l===2&&n>=s){if(t.getConfiguration().getRTL()?r.getLShapeForTypeFS():r.getLShapeForTypeSF()){if(g==2&&r.getShapeTypeStart()=="None"||g==3&&Math.abs(n-s)>=g*6){if(i>o){r.setProperty("_lMarker","leftUp",true)}else{r.setProperty("_lMarker","leftDown",true)}}}}if(a){e.relSet[r.getShapeId()]=r}else{e.relSetFake[r.getShapeId()]=r}},relationexist:function(e,t){t.mRelatedShapes=t.getRelatedInRowShapes(e.getId());var r=t.getProcessedType();t.mAnchors=t.getRlsAnchors(r,t.mRelatedShapes);if(!t.getVisible()){return false}if(!t.mRelatedShapes.predecessor&&!t.mRelatedShapes.successor){return false}var a=function(e){return!isNaN(parseFloat(e.x))&&isFinite(e.x)&&!isNaN(parseFloat(e.y))&&isFinite(e.y)};if(!a(t.mAnchors.predecessor)||!a(t.mAnchors.successor)){return false}return true}};return m},true);
//# sourceMappingURL=GanttUtils.js.map
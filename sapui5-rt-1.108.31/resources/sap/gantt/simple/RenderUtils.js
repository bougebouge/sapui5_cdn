/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["./AggregationUtils","./GanttUtils","sap/ui/core/Core","../library","sap/ui/Device","../misc/Utility","sap/ui/core/theming/Parameters","../misc/Format"],function(e,t,i,a,n,r,l,s){"use strict";var o=13;var g=a.simple.horizontalTextAlignment;var h={apiVersion:2,RENDER_EXTEND_FACTOR:.382,getGanttRenderWidth:function(e){var t=jQuery(document.getElementById(e.getId()+"-gantt")).width();return t*(1+2*h.RENDER_EXTEND_FACTOR)},renderAttributes:function(e,t,i){var a=i.map(function(e){var i=e.split("-").reduce(function(e,t){return e+t.charAt(0).toUpperCase()+t.slice(1)},"get");return{name:e,value:t[i]()}});a.forEach(function(t){if(t.value||t.value===0){if(t.name==="style"){var i=t.value.split(";");i.forEach(function(t){t=t.trim();if(t!=""){var i=t.split(/:(.*)/);if(i[0]==="fill"&&i[1].indexOf(" ")!=-1){i[1]=encodeURI(i[1])}e.style(i[0],i[1])}})}else{e.attr(t.name,t.value)}}})},renderTooltip:function(e,t){if(t.getTooltip()){e.openStart("title").openEnd();e.text(t.getTooltip());e.close("title")}},updateShapeSelections:function(e,i,a){if(e._getResizeExtension==null){return}var n=e._getResizeExtension();var r=e.getId();t.getShapesWithUid(r,a).forEach(function(t){if(t){this._bShapeSelectionProperties=false;this._hasShapeSelectionProperties(t,e);if(this._bShapeSelectionProperties){this._updateShapeStyle(t,false,e,0)}if(t.isA("sap.gantt.simple.shapes.Shape")){t.setSelected(false)}else if(t.getParent().isA("sap.gantt.simple.BaseConditionalShape")){t.getParent().setProperty("selected",false,true)}else{t.setProperty("selected",false,true)}}}.bind(this));n.clearAllOutline(r);t.getShapesWithUid(r,i).forEach(function(t){if(t){if(t.getProperty("selectable")){this._bShapeSelectionProperties=false;this._hasShapeSelectionProperties(t,e);if(this._bShapeSelectionProperties){this._updateShapeStyle(t,true,e,0)}if(t.isA("sap.gantt.simple.shapes.Shape")){t.setSelected(true)}else if(t.getParent().isA("sap.gantt.simple.BaseConditionalShape")){t.getParent().setProperty("selected",true,true);n.toggleOutline(t)}else{t.setProperty("selected",true,true);n.toggleOutline(t)}}e.getSelection().updateProperties(t.getShapeUid(),{draggable:t.getDraggable(),time:t.getTime(),endTime:t.getEndTime()})}}.bind(this))},_hasShapeSelectionProperties:function(e,t){if(!e||e.isA("sap.gantt.simple.Relationship")){return}if(e.isA("sap.gantt.simple.BaseConditionalShape")){e=e._getActiveShapeElement()}if(e&&(e.getSelectedFill()||e.getSelectedTitleColor())){this._bShapeSelectionProperties=true}else if(e instanceof sap.gantt.simple.BaseGroup){if(t.getSelectOnlyGraphicalShape()){e._eachChildOfGroup(e,function(e,i){i.forEach(function(e){if(!this._bShapeSelectionProperties){this._hasShapeSelectionProperties(e,t)}}.bind(this))}.bind(this))}else{e._eachChildOfGroup(e,function(e){if(!this._bShapeSelectionProperties){this._hasShapeSelectionProperties(e,t)}}.bind(this))}}},_updateShapeStyle:function(e,t,i,a,n,r){if(!e||e.isA("sap.gantt.simple.Relationship")||!e.getVisible()){return}if(e.isA("sap.gantt.simple.BaseConditionalShape")&&e._getActiveShapeElement()){this._updateShapeStyle(e._getActiveShapeElement(),t,i,a,n,r)}else if(e.isA("sap.gantt.simple.BaseGroup")){if(i.getSelectOnlyGraphicalShape()){e._eachChildOfGroup(e,function(e,l){l.forEach(function(e){var l=this._updateGroupShapeStyle(e,t,i,a,n,r);a=l}.bind(this))}.bind(this))}else{e._eachChildOfGroup(e,function(e){var l=this._updateGroupShapeStyle(e,t,i,a,n,r);a=l}.bind(this))}}else{this._updateShapeSelectionStyle(e,t,n,r)}},_updateGroupShapeStyle:function(e,t,i,a,n,r){if(!e||e.isA("sap.gantt.simple.Relationship")||!e.getVisible()){return a}r=r||{};var l=e.getParent();var s=l.getFill()||r.fill;var o=l.getTitleColor()||r.titleColor;var g=l.getSelectedFill()||r.selectedFill;var h=l.getSelectedTitleColor()||r.selectedTitleColor;var p=l.getDomRef("nonLabelGroup")?l.getDomRef("nonLabelGroup"):l.getDomRef()||n;if(p){var d=p.children||p.childNodes;while(a<d.length&&d[a].tagName==="title"){a+=1}this._bUpdatedTitle=false;var c=e.isA("sap.gantt.simple.BaseGroup")||e.isA("sap.gantt.simple.BaseConditionalShape")&&e._getActiveShapeElement()&&e._getActiveShapeElement().isA("sap.gantt.simple.BaseGroup");var f=c?0:a;var u={fill:s,titleColor:o,selectedFill:g,selectedTitleColor:h};this._updateShapeStyle(e,t,i,f,p.children[a],u);var S=this._bUpdatedTitle&&!c?2:1;a+=S}return a},_updateShapeSelectionStyle:function(e,t,i,a){a=a||{};var n=e.getFill()||a.fill;var r=e.getTitleColor()||a.titleColor;var s=t?e.getSelectedFill()||a.selectedFill||n:n;var o=l.get("sapUiBaseText");var g=e.isA("sap.gantt.simple.BaseText")?r||n||o:r||o;var h=e.isA("sap.gantt.simple.BaseText")?e.getSelectedFill()||a.selectedFill:null;var p=t?e.getSelectedTitleColor()||a.selectedTitleColor||h||g:g;var d=i?i:document.getElementById(e.getId());if(d){d.style.fill=e.isA("sap.gantt.simple.BaseText")?p:s;var c=d.nextSibling;if(c&&c.tagName==="text"&&e.getShowTitle()&&e.getTitle()){c.style.fill=p;this._bUpdatedTitle=true}}},updateShapeHighlights:function(e,i,a){if(e._getResizeExtension==null){return}var n=e._getResizeExtension();var r=e.getId();t.getShapesWithUid(r,a).forEach(function(e){if(e){if(e.isA("sap.gantt.simple.shapes.Shape")){e.setHighlighted(false)}else if(e.getParent().isA("sap.gantt.simple.BaseConditionalShape")){e.getParent().setProperty("highlighted",false,true)}else{e.setProperty("highlighted",false,true)}}});n.clearAllHighlight(r);t.getShapesWithUid(r,i).forEach(function(t){if(t){if(t.getProperty("highlightable")){if(t.isA("sap.gantt.simple.shapes.Shape")){t.setHighlighted(true)}else if(t.getParent().isA("sap.gantt.simple.BaseConditionalShape")){t.getParent().setProperty("highlighted",true,true);n.toggleHighlight(t)}else{t.setProperty("highlighted",true,true);n.toggleHighlight(t)}}e.getHighlight().updateProperties(t.getShapeUid(),{time:t.getTime(),endTime:t.getEndTime()})}})},updateShapeSelectionByShapeID:function(e,t){if(e._getResizeExtension==null){return}var i=e.getSelection().getSelectedShapeIDS();var a=e.getSelection().getDeSelectedShapeIDS();var n=e.getSelection().getSelectedRowIDS();var r=e.getSelection().getDeSelectedRowIDS();if(i&&i.length>0){this._updateShapeSelection(e,i,true)}if(n&&n.length>0){this._updateRowSelection(e,n,true)}if(a&&a.length>0){this._updateShapeSelection(e,a,false)}if(r&&r.length>0){this._updateRowSelection(e,r,false,t)}},_updateShapeSelection:function(e,i,a){var n=e.getId();if(!a){i.forEach(function(t){e.oSelection.mSelected.deSelectShapeId[t]={selected:a}})}t.getShapeByShapeId(n,i).forEach(function(t){this._updateShapes(t,a,e)}.bind(this))},_updateRowSelection:function(e,i,a,n){var r=e.getId();var l=e.searchTxt;if(!a){l=e.deSelectTxt}if(n){t.getShapesInRowsById(r,i).forEach(function(t){if(t&&(!a||t.getProperty("selectable"))){if(t.mProperties.shapeId){e.getSelection().updateShapeId(t.getShapeId(),a)}this._updateShapes(t,a,e)}}.bind(this))}else if(l!==null&&l!==undefined){t.getShapesInRowsById(r,i).forEach(function(t){if(t){var i=this._selectShapeBySearchText(e,t,a);if(i&&(!a||t.getProperty("selectable"))){if(t.mProperties.shapeId){e.getSelection().updateShapeId(t.getShapeId(),a)}this._updateShapes(t,a,e);if(!a){e.getSelection().clearSelectionByUid(t.getShapeUid())}}}}.bind(this))}},_updateShapes:function(e,t,i){e.setProperty("selected",t,true);if(t){i.getSelection().updateProperties(e.getShapeUid(),{draggable:e.getDraggable(),time:e.getTime(),endTime:e.getEndTime()},true)}else{i.getSelection().clearSelectionByUid(e.getShapeUid())}},updateShapeHighlightByShapeID:function(e,t){if(e._getResizeExtension==null){return}var i=e.getHighlight().getHighlightedShapeID();var a=e.getHighlight().getDeEmphasizedShapeID();if(i&&i.length>0){this._updateShapeHighlight(e,i,true)}if(a&&a.length>0){this._updateShapeHighlight(e,a,false)}},_updateShapeHighlight:function(e,i,a){var n=e.getId();t.getShapeByShapeId(n,i).forEach(function(t){this._updateShapeAttributes(t,a,e)}.bind(this))},_updateShapeAttributes:function(e,t,i){e.setProperty("highlighted",t,true);if(t){i.getHighlight().updateProperties(e.getShapeUid(),{time:e.getTime(),endTime:e.getEndTime()},true)}else{i.getHighlight().clearHighlightByUid(e.getShapeUid())}},_selectShapeBySearchText:function(e,t,i){var a=false;var n=e.getTable().getBindingInfo("rows").model;var r=e.searchProperty;if(!i){r=e.deSelectProperty}function l(t){if(i){e.searchTxt.forEach(function(e){if(t!==undefined&&t!==null&&t.toString().toLowerCase().indexOf(e.toString().toLowerCase())!==-1){a=true}})}else{if(t!==undefined&&t!==null&&t.toString().toLowerCase().indexOf(e.deSelectTxt.toString().toLowerCase())!==-1){a=true}}}if(Array.isArray(r)&&r.length>0){r.forEach(function(e){if(a){return}var i=t.getBindingContext(n).getProperty(e);l(i)})}else if(typeof r==="string"){var s=t.getBindingContext(n).getProperty(r);l(s)}else{var o=t.getBindingContext(n).getObject();if(o){Object.keys(o).forEach(function(e){if(a){return}l(o[e])})}}return a},getShapeElementByTarget:function(e){return jQuery(this.getDraggableDOMElement(e)).control(0,true)},getDraggableDOMElement:function(e){return jQuery(e).closest("["+t.SHAPE_ID_DATASET_KEY+"]").get(0)},addTitleSpacing:function(e,t){if(e.titleSpacing){e.x=t?e.x-e.titleSpacing:e.x+e.titleSpacing}},renderElementTitle:function(e,t,a){if(t.getShowTitle==null||!t.getShowTitle()){return}var n=t.getTitle();if(n){var s=0,h=0,p=0;if(t.getWidth){h=t.getWidth();p=t.getWidth()}if(t.getHeadWidth){s=t.getHeadWidth();h-=s}if(t.getTailWidth){h-=t.getTailWidth()}var d=2+s;var c={text:n,fill:t.getTitleColor()||l.get("sapUiBaseText"),showEllipsis:true,truncateWidth:h-t.getTitleSpacing(),textAnchor:t.getHorizontalTextAlignment().toLowerCase(),verticalTextAlignment:t.getVerticalTextAlignment(),fontWeight:t.getFontWeight(),fontFamily:t.getFontFamily(),fontSize:t.getFontSize()||o};var f=i.getConfiguration().getRTL();if(t.getTitleSpacing()){if(c.textAnchor===g.End.toLowerCase()){c.titleSpacing=-t.getTitleSpacing()}else{c.titleSpacing=t.getTitleSpacing()}}if(c.textAnchor===g.Start.toLowerCase()){c.x=f?t.getX()+t.getWidth()-d:t.getX()+d;this.setVerticalAlignment(t,c)}else if(c.textAnchor===g.End.toLowerCase()){c.x=f?t.getX()+d:t.getX()+t.getWidth()-d;this.setVerticalAlignment(t,c)}else if(c.textAnchor===g.Middle.toLowerCase()){c.x=t.getX()+t.getWidth()/2;this.setVerticalAlignment(t,c)}else if(c.textAnchor===g.Dynamic.toLowerCase()){this.renderDynamicText(t,c,d);this.setVerticalAlignment(t,c)}var u=r.getShapeBias(t);c.x=c.x+u.x;c.y=c.y+u.y;this.addTitleSpacing(c,f);var S=a(c).addStyleClass("sapGanttTextNoPointerEvents");S.setProperty("childElement",true,true);S.renderElement(e,S)}},renderCalenderTitle:function(e,t,a,n){var r=t.title;var s=t.baseCalender;if(r){var h=0,p=0;if(a.width){h=a.width;p=a.width}var d={text:r,fill:s.getTitleColor()||l.get("sapUiBaseText"),showEllipsis:true,truncateWidth:h-s.getTitleSpacing(),textAnchor:s.getHorizontalTextAlignment(),verticalTextAlignment:s.getVerticalTextAlignment(),fontWeight:s.getFontWeight(),fontSize:s.getFontSize()||o,fontFamily:s.getFontFamily()};var c=i.getConfiguration().getRTL();if(s.getTitleSpacing()){if(d.textAnchor.toLowerCase()===g.End.toLowerCase()){d.titleSpacing=-s.getTitleSpacing()}else{d.titleSpacing=s.getTitleSpacing()}}if(d.textAnchor.toLowerCase()===g.Start.toLowerCase()){d.x=c?a.x+a.width:a.x}else if(d.textAnchor.toLowerCase()===g.End.toLowerCase()){d.x=c?a.x:a.x+a.width}else if(d.textAnchor.toLowerCase()===g.Middle.toLowerCase()){d.x=a.x+a.width/2}else if(d.textAnchor.toLowerCase()===g.Dynamic.toLowerCase()){this.renderDynamicText(s,d,0,a)}if(d.verticalTextAlignment==="Top"){d.y=a.height/2-1}else if(d.verticalTextAlignment==="Bottom"){d.y=a.height/2+d.fontSize-1}else{d.y=a.height/2+d.fontSize/2-1}this.addTitleSpacing(d,c);var f=n(d).addStyleClass("sapGanttTextNoPointerEvents");f.setProperty("childElement",true,true);f.renderElement(e,f)}},setVerticalAlignment:function(e,t){if(t.verticalTextAlignment==="Top"){t.y=e.getY()+t.fontSize-1}else if(t.verticalTextAlignment==="Bottom"){t.y=e.getY()+parseInt(e.getHeight(),10)-1}else{t.y=e.getY()+parseInt(e.getHeight()/2,10)+t.fontSize/2.5}},renderDynamicText:function(e,t,a,n){var r=i.getConfiguration().getRTL();var l=s.abapTimestampToDate(e.getAxisTime()._oZoomStrategy.getVisibleHorizon().getStartTime());var o;if(n){t.x=r?n.x+n.width-a:n.x+a;o=t.x;if(n.x<e.getAxisTime().timeToView(l)&&n.x+n.width>e.getAxisTime().timeToView(l)){t.x=r?e.getAxisTime().timeToView(l)-a:e.getAxisTime().timeToView(l)+a;t._shapeCropped=true;t._xBiassed=t.x-o}}else{t.x=r?e.getX()+e.getWidth()-a:e.getX()+a;o=t.x;if(e.getTime()<l&&e.getEndTime()>l){t.x=r?e.getAxisTime().timeToView(l)-a:e.getAxisTime().timeToView(l)+a;t._shapeCropped=true;t._xBiassed=t.x-o}}},renderInlineShapes:function(e,i,a){var n=i.getId()+"-top";var r=i.getId()+"-row";e.openStart("g",i);e.class(n);e.attr("data-sap-ui-related",i.getParent().getId());e.openEnd();e.openStart("g");e.attr(t.ROW_ID_DATASET_KEY,i.getRowId()||"");e.class(r);e.openEnd();this.renderMainRowAllShapes(e,i,a);e.close("g");e.close("g")},renderMainRowAllShapes:function(t,i,a){var n=a.getSyncedControl().getRowStates();var r=this.calcRowDomPosition(i,n),l=r.rowYCenter,s=r.rowHeight;var o=e.getAllNonLazyAggregations(i);var g=Object.keys(o).filter(function(e){return e.indexOf("calendars")===-1&&e!=="relationships"}).map(function(e){return i.getAggregation(e)||[]}.bind(i));var p=i.getRowUid(),d=a.oSelection,c=a.oHighlight,f=a._oExpandModel,u=a.getAxisTime(),S=f.isRowExpanded(p);g.forEach(function(e,n){e.forEach(function(e){if(a.isShapeVisible(e)){h.renderMainRowShape(t,e,{expandModel:f,selectionModel:d,highlightModel:c,axisTime:u,rowSetting:i,rowUid:p,rowExpanded:S,mainRowYCenter:l,rowHeight:s},a.getShowParentRowOnExpand()&&!a.getUseParentShapeOnExpand())}})})},renderMainRowShape:function(e,t,i,a){this.setSpecialProperties(t,i);if(Object.keys(i.expandModel.mExpanded).indexOf(i.rowUid)==-1&&!i.rowExpanded||a){t.renderElement(e,t,null)}if(i.rowExpanded){this.renderExpandShapesIfNecessary(e,t,i,a)}},setSpecialProperties:function(t,i){var a=i.expandModel,n=i.rowUid,r=i.rowSetting.getShapeUid(t),l=t.getParentRowSettings().getParent().getParent(),s=l.getParent();if(!t._iBaseRowHeight){t._iBaseRowHeight=a.getBaseRowHeight();var o=e.getNonLazyAggregations(t);Object.keys(o).filter(function(e){var t=o[e];if(t.appData!==null){return t.appData.sapGanttOrder===1}}).map(function(e){if(e==="utilizationBar"||e==="utilizationLine"){t._iBaseRowHeight=t._iBaseRowHeight-1}})}t.mAxisTime=i.axisTime;t.setProperty("shapeUid",r,true);if(t.getProperty("selectable")){t.setProperty("selected",i.selectionModel.existed(r),true)}if(t.getProperty("highlightable")){t.setProperty("highlighted",i.highlightModel.existed(r),true)}t.setProperty("rowYCenter",a.getRowYCenterByUid(n,i.mainRowYCenter,t.getScheme(),0,s),true)},isValidD:function(e){return!!e&&e.indexOf("NaN")===-1&&e.indexOf("undefined")===-1&&e.indexOf("null")===-1},renderExpandShapesIfNecessary:function(i,a,n,r){var l;var s=a.getParentRowSettings().getParent().getParent(),o=s.getParent();var g=function(e){if(!e||e.length===0){return}var a=e;if(jQuery.isArray(e)===false){a=[e]}t.calculateLevelForShapes(a,"time","endTime");a.forEach(function(e,t){if(e._level){t=e._level-1}var a=r?n.expandModel.getRowYCenterByUid(n.rowUid,null,e.getScheme(),t,o):n.expandModel.getRowYCenterByUid(n.rowUid,null,e.getScheme(),t,o)-n.expandModel.getBaseRowHeight();e.setProperty("rowYCenter",a,true);e._iBaseRowHeight=n.expandModel.getExpandShapeHeightByUid(n.rowUid,e.getScheme(),n.iRowHeight);e.setProperty("shapeUid",n.rowSetting.getShapeUid(e),true);e.renderElement(i,e)})};a._isSubTasks=a.mBindingInfos.hasOwnProperty("subTasks")||typeof a.getSubTasks==="function"&&a.getSubTasks();if(o.getUseParentShapeOnExpand()){var h=a.getParent().getAllExpandableShapes();var p=a.getScheme();var d;var c;h.forEach(function(e,t){if(o.isShapeVisible(e)){l=t}});var f=h[l];if(a===f){var u=[];h.forEach(function(t){var i=e.getNonLazyElementsByScheme(t,p);i.forEach(function(e){if(e instanceof sap.gantt.simple.BaseConditionalShape){var t=e._getActiveShapeElement();if(t instanceof sap.gantt.simple.BaseGroup){d=null;c=null;t.getShapes().forEach(function(e){if(!d&&!c){d=e.getTime();c=e.getEndTime()}else{if(e.getTime()>=d){d=d}else{d=e.getTime()}if(e.getEndTime()>=c){c=e.getEndTime()}else{c=c}}});t.setTime(d);t.setEndTime(c);u=u.concat(t)}else if(t){u=u.concat(t)}}else if(e instanceof sap.gantt.simple.BaseGroup){d=null;c=null;e.getShapes().forEach(function(e){if(!d&&!c){d=e.getTime();c=e.getEndTime()}else{if(e.getTime()>=d){d=d}else{d=e.getTime()}if(e.getEndTime()>=c){c=e.getEndTime()}else{c=c}}});e.setTime(d);e.setEndTime(c);u=u.concat(e)}else{u=u.concat(e)}})});if(u.length!==0){u.forEach(function(e){e.setProperty("childElement",false,true)})}g(u)}}else if(a._isSubTasks){var h=a.getParent().getAllExpandableShapes();var d;var c;h.forEach(function(e,t){if(o.isShapeVisible(e)){l=t}});var f=h[l];if(a===f){var u=[];h.forEach(function(t){var i=e.getLazyElementsByScheme(t,a.getParent().getParentGantt().getShapeSchemes()[1].getKey());i.forEach(function(e){if(e instanceof sap.gantt.simple.BaseConditionalShape){var t=e._getActiveShapeElement();if(t instanceof sap.gantt.simple.BaseGroup){d=null;c=null;t.getShapes().forEach(function(e){if(!d&&!c){d=e.getTime();c=e.getEndTime()}else{if(e.getTime()>=d){d=d}else{d=e.getTime()}if(e.getEndTime()>=c){c=e.getEndTime()}else{c=c}}});t.setTime(d);t.setEndTime(c);u=u.concat(t)}else if(t){u=u.concat(t)}}else if(e instanceof sap.gantt.simple.BaseGroup){d=null;c=null;e.getShapes().forEach(function(e){if(!d&&!c){d=e.getTime();c=e.getEndTime()}else{if(e.getTime()>=d){d=d}else{d=e.getTime()}if(e.getEndTime()>=c){c=e.getEndTime()}else{c=c}}});e.setTime(d);e.setEndTime(c);u=u.concat(e)}else{u=u.concat(e)}})});g(u)}}else if(!a._isSubTasks){var S=e.getLazyAggregations(a);Object.keys(S).forEach(function(e){var t=a.getAggregation(e);g(t)})}},calcRowDomPosition:function(e,t){var i=e._getRow(),a=i.getParent(),n=a.indexOfRow(i);var r=t[n].height;var l=0;for(var s=0;s<=n;s++){l+=t[s].height}l-=r/2;return{rowYCenter:l,rowHeight:r}},pushOrUnshift:function(e,t,i){if(i===true){e.splice(0,0,t)}else{e.push(t)}},createOrderedListOfRenderFunctionsFromTemplate:function(e){var t=[];for(var i=0;i<e.length;i++){this.pushOrUnshift(t,e[i].fnCallback,e[i].bUnshift)}return t},renderElementAnimation:function(e,t){var i=t.getAnimationProperties(t.getAnimationSettings());if(i){e.openStart("animate");e.attr("attributeName","fill");e.attr("values",i.values);e.attr("dur",i.duration);e.attr("repeatCount",i.repeatCount);e.openEnd().close("animate")}}};return h},true);
//# sourceMappingURL=RenderUtils.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/assert","sap/ui/base/ManagedObject","./AggregationUtils","./GanttUtils"],function(jQuery,e,t,a,n){"use strict";var i=t.extend("sap.gantt.simple.ExpandModel",{metadata:{properties:{baseRowHeight:{type:"int",group:"Appearance",defaultValue:null}}},constructor:function(){t.apply(this,arguments);this.mExpanded={}}});i.prototype.isTableRowHeightNeedChange=function(e,t,i,r,s){var o=false;this.rowMaxLevelMap={};var p=s.getKey();for(var u=0;u<i.length;u++){var h=i[u];var d=n.getSelectedTableRowSettings(t,h);var l=t.getParent(),g=l.getUseParentShapeOnExpand();if(!l._bExpandRows&&d==null){break}else if(d!=null){var f=d.getAllExpandableShapes();if(f.length===0&&!e){this.toggle(e,d,r,s,0);o=true;return o}var m=[];var c=[];var v=[];var w=[];var E;var x;f.forEach(function(e){if(g){c=a.getNonLazyElementsByScheme(e,p);c.forEach(function(e){if(e instanceof sap.gantt.simple.BaseConditionalShape){var t=e._getActiveShapeElement();if(t instanceof sap.gantt.simple.BaseGroup){E=null;x=null;t.getShapes().forEach(function(e){if(!E&&!x){E=e.getTime();x=e.getEndTime()}else{if(e.getTime()>=E){E=E}else{E=e.getTime()}if(e.getEndTime()>=x){x=e.getEndTime()}else{x=x}}});t.setProperty("time",E,true);t.setProperty("endTime",x,true);v=v.concat(t)}else if(t){v=v.concat(t)}}else if(e instanceof sap.gantt.simple.BaseGroup){E=null;x=null;e.getShapes().forEach(function(e){if(!E&&!x){E=e.getTime();x=e.getEndTime()}else{if(e.getTime()>=E){E=E}else{E=e.getTime()}if(e.getEndTime()>=x){x=e.getEndTime()}else{x=x}}});e.setProperty("time",E,true);e.setProperty("endTime",x,true);v=v.concat(e)}else{v=v.concat(e)}})}else if(e.mBindingInfos.hasOwnProperty("subTasks")||typeof e.getSubTasks==="function"&&e.getSubTasks()){c=a.getLazyElementsByScheme(e,p);c.forEach(function(e){if(e instanceof sap.gantt.simple.BaseConditionalShape){var t=e._getActiveShapeElement();if(t instanceof sap.gantt.simple.BaseGroup){E=null;x=null;t.getShapes().forEach(function(e){if(!E&&!x){E=e.getTime();x=e.getEndTime()}else{if(e.getTime()>=E){E=E}else{E=e.getTime()}if(e.getEndTime()>=x){x=e.getEndTime()}else{x=x}}});t.setProperty("time",E,true);t.setProperty("endTime",x,true);v=v.concat(t)}else if(t){v=v.concat(t)}}else if(e instanceof sap.gantt.simple.BaseGroup){E=null;x=null;e.getShapes().forEach(function(e){if(!E&&!x){E=e.getTime();x=e.getEndTime()}else{if(e.getTime()>=E){E=E}else{E=e.getTime()}if(e.getEndTime()>=x){x=e.getEndTime()}else{x=x}}});e.setProperty("time",E,true);e.setProperty("endTime",x,true);v=v.concat(e)}else{v=v.concat(e)}})}else{c=a.getLazyElementsByScheme(e,p);w=n.calculateLevelForShapes(c,"time","endTime");m.push(w.maxLevel)}});if(v.length!==0){w=n.calculateLevelForShapes(v,"time","endTime");m.push(w.maxLevel)}w=n.calculateLevelForShapes(v,"time","endTime");m.push(w.maxLevel);var R=Math.max.apply(null,m);if(R>0){this.toggle(e,d,r,s,R,g);this.rowMaxLevelMap["row"+h]=R;o=true}}}return o};i.prototype.refreshRowYAxis=function(e){if(this.hasExpandedRows()===false){return}var t=e.getParent();var a=e.getRows();var n=e.getParent().getTableRowHeights();var i=0;for(var r=0;r<a.length;r++){var s=a[r],o=s.getAggregation("_settings"),p=o.getRowUid();i+=n[r-1]||0;if(!this.isRowExpanded(p)){continue}var u=this.getBaseRowHeight();if(t.getExpandedRowHeight()){u=t.getExpandedRowHeight()}this.calcExpandRowYAxis({uid:o.getRowUid(),rowIndex:r,rowY:i,baseRowHeight:u,allRowHeights:n})}return this.getBaseRowHeight()};i.prototype.toggle=function(e,t,a,n,i,r){if(e){this.expand(t,a,n,i,r)}else{this.collapse(t,n)}};i.prototype.expand=function(t,a,n,i,r){e(typeof i==="number","iMaxNumberOfDetails must be a number");var s=t.getRowUid(),o=a.getKey(),p=a.getRowSpan();var u=n.getKey(),h=n.getRowSpan();var d=this.mExpanded[s];if(r){if(!d||d.length===0){this.mExpanded[s]=[{scheme:u,metadata:{numberOfRows:i,rowSpan:p,useParentOnExpand:true,main:true}}]}}else{if(!d||d.length===0){this.mExpanded[s]=[{scheme:o,metadata:{rowSpan:p,main:true}}]}if(!this.hasExpandScheme(s,u)){this.mExpanded[s].push({scheme:u,metadata:{numberOfRows:i,rowSpan:h}})}}this.updateVisibleRowSpan(s)};i.prototype.collapse=function(e,t){var a=e.getRowUid();if(!a&&!this.mExpanded[a]){return}var n=t.getKey();var i=this.mExpanded[a];for(var r=0;r<i.length;r++){var s=i[r];if(s.scheme===n){i.splice(r,1)}if(this.hasNoExpandRows(a)){delete this.mExpanded[a];break}else{this.updateVisibleRowSpan(a)}}};i.prototype.hasExpandScheme=function(e,t){return this.mExpanded[e].filter(function(e){return e.scheme===t}).length>0};i.prototype.hasExpandedRows=function(){return!jQuery.isEmptyObject(this.mExpanded)};i.prototype.isRowExpanded=function(e){return!this.hasNoExpandRows(e)};i.prototype.hasNoExpandRows=function(e){var t=this.mExpanded[e]||[];return t.every(function(e){return e.metadata.main&&!e.metadata.useParentOnExpand})};i.prototype.updateVisibleRowSpan=function(e){var t=this.mExpanded[e]||[];var a,n,i=0;for(var r=0;r<t.length;r++){var s=t[r];var o=s.scheme;var p=s.metadata;if(p.main){a=o;n=p;if(p.useParentOnExpand){i=p.rowSpan*(p.numberOfRows||1)}}else{i=p.rowSpan*(p.numberOfRows||1)}}n.numberOfSubRows=i;this.mExpanded[e][0]={scheme:a,metadata:n}};i.prototype.getMainRowScheme=function(e){var t=this.mExpanded[e]||[];return t.filter(function(e){return e.metadata.main}).map(function(e){return{key:e.scheme,value:e.metadata}})[0]};i.prototype.getExpandSchemeKeys=function(e){var t=this.mExpanded[e]||[];return t.filter(function(e){return!e.metadata.main}).map(function(e){return e.scheme})};i.prototype.getCalculatedRowHeight=function(e,t,a){var n=t;var i=a.getParent(),r=i.getExpandedRowHeight(),s=i.getShowParentRowOnExpand()&&!i.getUseParentShapeOnExpand();if(this.hasExpandedRows()){var o=e.getRowUid();if(!o){return n}var p=this.mExpanded[o];if(p){var u=this.getMainRowScheme(o);if(!r){n=s?t*(u.value.rowSpan+u.value.numberOfSubRows):t*u.value.numberOfSubRows}else{if(!s){if(r<t&&u.value.numberOfSubRows===1){n=u.value.numberOfSubRows*t}else{n=u.value.numberOfSubRows*r+.5}}else{n=t*u.value.rowSpan+u.value.numberOfSubRows*r+.5}}}}return n};i.prototype.getRowHeightByIndex=function(e,t,a){if(e==null){return a}var n=e.getRows(),i=n[t].getAggregation("_settings");return this.getCalculatedRowHeight(i,a,e)};i.prototype.calcExpandRowYAxis=function(e){var t=e.uid,a=e.baseRowHeight;var n=e.rowY;var i,r,s=[];var o=[];var p=this.mExpanded[t];if(jQuery.isEmptyObject(p)){return}for(var u=0;u<p.length;u++){var h=p[u],d=h.scheme,l=h.metadata;if(l.main){i=l;r=d;if(l.useParentOnExpand){o.push(l);s.push(d)}}else{o.push(l);s.push(d)}}var g=i?i.rowSpan:1;var f={};f[r]=[g];var m=[f];for(var c=0;c<o.length;c++){var v=o[c],w=v.rowSpan,E=v.numberOfRows;var x=[];for(var R=0;R<E;R++){x.push(w)}f={};f[s[c]]=x;m.push(f)}var y=n;for(var S=0;S<m.length;S++){var b=m[S],T=Object.keys(b)[0],O=b[T];if(S===0){this._updateRowYAxis(t,T,{rowYAxis:[y].slice()})}else{var H=[];if(O.length===1){H.push(y+this.getBaseRowHeight());y+=O[0]*a}else{for(var B=0;B<O.length;B++){if(B===0){if(this.getBaseRowHeight()!==a){y=y+O[B]*this.getBaseRowHeight()}else{y=y+O[B]*a}}else{y=y+O[B]*a}H.push(y)}}this._updateRowYAxis(t,T,{rowYAxis:H.slice()})}}};i.prototype._updateRowYAxis=function(e,t,a){var n=a.rowYAxis;var i=this.mExpanded[e]||[];for(var r=0;r<i.length;r++){var s=i[r];if(s.scheme===t){s.metadata.yAxis=n;break}}};i.prototype.getRowYCenterByUid=function(e,t,a,n,i){var r=this.isRowExpanded(e);if(r===false){return t}var s=this.mExpanded[e],o=a||this.getMainRowScheme(e).key;for(var p=0;p<s.length;p++){var u=s[p];if(u.scheme===o){var h=u.metadata.yAxis,d=i.getShowParentRowOnExpand()&&!i.getUseParentShapeOnExpand(),l=i.getExpandedRowHeight(),g=this.getBaseRowHeight();if(l&&!(u.metadata.main&&!u.metadata.useParentOnExpand)){if(h.length===1&&l<g&&!d){g=this.getBaseRowHeight()}else{g=l}}var f=g*u.metadata.rowSpan;var m=h.map(function(e){return e+f/2});var c=n===undefined?0:n;return m[c]}}};i.prototype.getExpandShapeHeightByUid=function(e,t,a){var n=this.mExpanded[e];var i=n.filter(function(e){return e.scheme===t})[0];return i?i.metadata.rowSpan*this.getBaseRowHeight():a};i.prototype.intersectRows=function(e,t){return jQuery.grep(e,function(e){return jQuery.inArray(e,t)>-1})};i.prototype.collectExpandedBgData=function(e,t,a){var n=this.intersectRows(e,Object.keys(this.mExpanded));if(jQuery.isEmptyObject(this.mExpanded)||jQuery.isEmptyObject(e)||jQuery.isEmptyObject(n)){return[]}var i=this.getBaseRowHeight();var r=[];for(var s=0;s<n.length;s++){var o=n[s],p=this.mExpanded[o]||[];for(var u=0;u<p.length;u++){var h=p[u],d=h.metadata.yAxis||[],l=h.metadata.main;if(!l||h.metadata.useParentOnExpand){var g=[];if(t){if(d.length===1&&!a&&t<this.getBaseRowHeight()){i=this.getBaseRowHeight()}else{i=t}}d.forEach(function(e){g.push({x:0,y:e,rowUid:o,rowHeight:i*h.metadata.rowSpan})});r.push(g)}}}return r};return i},true);
//# sourceMappingURL=ExpandModel.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/Device","sap/ui/core/Core","sap/ui/core/IconPool","./GanttUtils","./RenderUtils","./BasePath","sap/ui/core/theming/Parameters","sap/gantt/library","./CoordinateUtils","./BaseShape"],function(e,t,r,s,a,i,o,n,p,h){"use strict";var l=n.simple.connectorType;var c=6,g=20,d=15,u={FinishToFinish:0,FinishToStart:1,StartToFinish:2,StartToStart:3};var S=i.extend("sap.gantt.simple.Relationship",{metadata:{library:"sap.gantt",properties:{type:{type:"sap.gantt.simple.RelationshipType",group:"Appearance"},predecessor:{type:"string",group:"Data"},successor:{type:"string",group:"Data"},selectedStroke:{type:"sap.gantt.ValueSVGPaintServer",defaultValue:"#FF0000"},selectedStrokeWidth:{type:"sap.gantt.SVGLength",defaultValue:2},lShapeForTypeFS:{type:"boolean",defaultValue:true},lShapeForTypeSF:{type:"boolean",defaultValue:true},shapeTypeStart:{type:"sap.gantt.simple.connectorType",defaultValue:l.None},shapeTypeEnd:{type:"sap.gantt.simple.connectorType",defaultValue:l.Arrow},startShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},endShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},selectedStartShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},selectedEndShapeColor:{type:"sap.gantt.ValueSVGPaintServer",group:"Appearance"},enableCurvedEdge:{type:"boolean",defaultValue:false},relationshipOverDivider:{type:"boolean",defaultValue:false},_lMarker:{type:"string"}}},renderer:{apiVersion:2}});S.prototype.applySettings=function(e){e=e||{};i.prototype.applySettings.apply(this,arguments)};S.prototype._getLMarker=function(){return this.getProperty("_lMarker")};S.prototype.onclick=function(e){if(this.getGanttChartBase().getIsConnectorDetailsVisible()){var t=function(){var e=p.getLatestCursorPosition();var t=e.pageX,r=e.pageY;var s=document.elementsFromPoint(t,r),a=[],i=[];for(var o=0;o<s.length;o++){var n=s[o].parentNode;if(s[o].tagName==="path"&&sap.ui.getCore().byId(n.id).isA("sap.gantt.simple.Relationship")&&i.indexOf(n.id)===-1){i.push(n.id);var h=sap.ui.getCore().byId(n.id);a.push(h)}}if(a.length>0){this.getGanttChartBase().fireShapeConnectorList({pageX:t,pageY:r,connectorList:a})}};window.setTimeout(t.bind(this),300)}else{h.prototype.onclick.call(this,e)}};S.prototype.renderElement=function(e,t,r){this.oGantt=sap.ui.getCore().byId(r);var a=t.getProcessedType();if(!t.mRelatedShapes&&!t.mAnchors&&!s.relationexist(this.oGantt,t)){return}this.mRelatedShapes=t.mRelatedShapes;if(this.mRelatedShapes.predecessor){var i=this.mRelatedShapes.predecessor.getParentRowSettings().getParent().getDomRef();var o=i.clientHeight;this.predYTop=i.offsetTop;this.predYBottom=this.predYTop+o}if(this.mRelatedShapes.successor){var p=this.mRelatedShapes.successor.getParentRowSettings().getParent().getDomRef();var h=p.clientHeight;this.sucYTop=p.offsetTop;this.sucYBottom=this.sucYTop+h}if(this.mRelatedShapes.predecessor&&this.mRelatedShapes.successor&&this.predYTop==this.sucYTop&&this.predYBottom==this.sucYBottom){var l=this.mRelatedShapes.successor.getParentRowSettings().getParent().getAggregation("_settings").getRowUid();var c=this.oGantt._oExpandModel.isRowExpanded(l);var g=this.oGantt.getShowParentRowOnExpand()&&!this.oGantt.getUseParentShapeOnExpand();var d=this.mRelatedShapes.predecessor._level;var u=this.mRelatedShapes.successor._level;if(c&&d&&u){var S=this.oGantt._oExpandModel.getBaseRowHeight();var f=this.oGantt.getExpandedRowHeight()?this.oGantt.getExpandedRowHeight():S;var y=g?this.predYTop+S+(d-1)*f:this.predYTop+(d-1)*f;var v=g?this.predYTop+S+d*f:this.predYTop+d*f;var E=g?this.sucYTop+S+(u-1)*f:this.sucYTop+(u-1)*f;var P=g?this.sucYTop+S+u*f:this.sucYTop+u*f;this.predYTop=y;this.predYBottom=v;this.sucYTop=E;this.sucYBottom=P}}switch(this.oGantt.getRelationshipShapeSize()){case n.simple.relationshipShapeSize.Small:this.SHAPE_SIZE=6;break;case n.simple.relationshipShapeSize.Large:this.SHAPE_SIZE=10;break;default:this.SHAPE_SIZE=8;break}this.calcLinePathD(t.mAnchors,a);this.renderRelationship(e,t.mAnchors,a,r)};S.prototype.getRlsAnchors=function(e,t){var r,s,a;var i=this.getShapeAnchors(t);if(t.predecessor&&t.successor){if(e===u.FinishToFinish){r=i.predecessor.tail;s=i.successor.tail}else if(e===u.FinishToStart){r=i.predecessor.tail;s=i.successor.head}else if(e===u.StartToFinish){r=i.predecessor.head;s=i.successor.tail}else if(e===u.StartToStart){r=i.predecessor.head;s=i.successor.head}}else if(t.predecessor&&!t.successor){if(e===u.FinishToFinish||e===u.FinishToStart){r=i.predecessor.tail;s={x:r.x+g,y:r.y};a={x:s.x,y:s.y+d/2}}else if(e===u.StartToFinish||e===u.StartToStart){r=i.predecessor.head;s={x:r.x-g,y:r.y};a={x:s.x-d,y:s.y+d/2}}}else if(!t.predecessor&&t.successor){if(e===u.FinishToFinish||e===u.StartToFinish){s=i.successor.tail;r={x:s.x+g,y:s.y};a={x:r.x,y:r.y+d/2}}else if(e===u.FinishToStart||e===u.StartToStart){s=i.successor.head;r={x:s.x-g,y:s.y};a={x:r.x-d,y:r.y+d/2}}}return{predecessor:r,successor:s,prompter:a}};S.prototype.calcLinePathD=function(e,r){var s=e.predecessor.x,a=e.predecessor.y;var i=e.successor.x,o=e.successor.y;var n,p=[s,a,i,o];var h=this.oGantt._edgePoint;if(a===o){n=this.calcIRlsPathD}else if(a!==o){if(r===u.FinishToFinish){n=this.calcURlsPathD;p.push(false,h)}else if(r===u.FinishToStart){if(s<=i){if(t.getConfiguration().getRTL()?this.getLShapeForTypeSF():this.getLShapeForTypeFS()){if(h==2&&this.getShapeTypeStart()=="None"||h==3&&Math.abs(s-i)>=h*c){n=this.calcLRlsPathD}else{n=this.calcSRlsPathD;p.push(r,h)}}else{if(Math.abs(s-i)>=2*h*c){n=this.calcZRlsPathD;p.push(h)}else{n=this.calcSRlsPathD;p.push(r,h)}}}else if(s>i){n=this.calcSRlsPathD;p.push(r,h)}}else if(r===u.StartToFinish){if(s<i){n=this.calcSRlsPathD;p.push(r,h)}else if(s>=i){if(t.getConfiguration().getRTL()?this.getLShapeForTypeFS():this.getLShapeForTypeSF()){if(h==2&&this.getShapeTypeStart()=="None"||h==3&&Math.abs(s-i)>=h*c){n=this.calcLRlsPathD}else{n=this.calcSRlsPathD;p.push(r,h)}}else{if(Math.abs(s-i)>=2*h*c){n=this.calcZRlsPathD;p.push(h)}else{n=this.calcSRlsPathD;p.push(r,h)}}}}else if(r===u.StartToStart){n=this.calcURlsPathD;p.push(true,h)}}if(n===this.calcLRlsPathD){var l=e.successor.dyTop?e.successor.dyTop:e.successor.dy;var g=e.successor.dyBottom?e.successor.dyBottom:e.successor.dy;p[2]=s<i?i+e.successor.dx:i-e.successor.dx;p[3]=a<o?o-l:o+g}this.setProperty("d",n.apply(this,p),true)};S.prototype.calcIRlsPathD=function(e,t,r,s){return this.getLinePathD([[e,t],[r,s]])};S.prototype.calcLRlsPathD=function(e,t,r,s){return this.getLinePathD([[e,t],[r,t],[r,s]])};S.prototype.calcURlsPathD=function(e,t,r,s,a,i){var o=e<r?r+i*c:e+i*c;var n=e<r?e-i*c:r-i*c;var p=!a?o:n;if(this.getRelationshipOverDivider()){var h=e<r?e+i*c:r+i*c;var l=e<r?r-i*c:e-i*c;var g=!a?h:l;var d=t>s?this.predYTop:this.predYBottom;var u=t<s?this.sucYTop:this.sucYBottom;if(!a&&e<r||a&&e>r){return this.getLinePathD([[e,t],[g,t],[g,d],[p,d],[p,s],[r,s]])}else{return this.getLinePathD([[e,t],[p,t],[p,u],[g,u],[g,s],[r,s]])}}else{return this.getLinePathD([[e,t],[p,t],[p,s],[r,s]])}};S.prototype.calcSRlsPathD=function(e,t,r,s,a,i){var o=a==1?e+i*c:e-i*c;var n=t>s?this.predYTop:this.predYBottom;var p=a==1?r-i*c:r+i*c;return this.getLinePathD([[e,t],[o,t],[o,n],[p,n],[p,s],[r,s]])};S.prototype.calcZRlsPathD=function(e,t,r,s,a){var i=e<r?e+a*c:e-a*c;if(this.getRelationshipOverDivider()){var o=t<s?this.sucYTop:this.sucYBottom;var n=e<r?r-a*c:r+a*c;return this.getLinePathD([[e,t],[i,t],[i,o],[n,o],[n,s],[r,s]])}else{return this.getLinePathD([[e,t],[i,t],[i,s],[r,s]])}};S.prototype.getConnectorEndPath=function(e,t,r){var s=function(e){return Number(e)};var a=e.match(/-?\d+(\.\d+)?/g).map(s);var i=[];var o;var n=this.getEnableCurvedEdge()?a[a.length-4]:a[a.length/2-2];var p=this.getEnableCurvedEdge()?a[a.length-3]:a[a.length/2-1];var h=this.getEnableCurvedEdge()?a[a.length-2]:a[a.length/2+0];var l=this.getEnableCurvedEdge()?a[a.length-1]:a[a.length/2+1];if(n==h){if(p>l){i=this.getCoordinateUpDown(h,l,"up");o=a[0]<h?"rightUp":"leftUp"}else{i=this.getCoordinateUpDown(h,l,"down");o=a[0]<h?"rightDown":"leftDown"}}else if(n!=h){i=n<h?this.getCoordinate(h,l,"rightEnd"):this.getCoordinate(h,l,"leftEnd")}return this.renderSvg(i,"end",t,r,o)};S.prototype.getConnectorStartPath=function(e,t,r){var s=function(e){return Number(e)};var a=e.match(/-?\d+(\.\d+)?/g).map(s);var i=a[0],o=a[1];var n=r==0||r==1?this.getCoordinate(i,o,"rightStart"):this.getCoordinate(i,o,"leftStart");return this.renderSvg(n,"start",t,r)};S.prototype.renderSvg=function(e,t,r,s,a){var i=[];var o=this._checkConnectorOverlap(r,s,t,a);if(o==l.Arrow){if(t=="start"){i.push(e[0],e[1],e[4],e[7])}else{i.push(e[0],e[3],e[5])}return d3.svg.line().interpolate("linear-closed")(i)}else if(o==l.Square){i.push(e[0],e[1],e[3],e[5],e[7]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==l.Diamond){i.push(e[0],e[2],e[4],e[6]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==l.Circle){i.push(e[0],e[1],e[3],e[5],e[7]);return d3.svg.line().interpolate("basis-closed")(i)}else if(o===l.HorizontalRectangle){i.push(e[0],e[15],e[9],e[10],e[16]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==l.VerticalRectangle){i.push(e[0],e[11],e[12],e[13],e[14]);return d3.svg.line().interpolate("linear-closed")(i)}else if(o==l.None){i.push(e[0]);return d3.svg.line().interpolate("linear")(i)}};S.prototype._checkConnectorOverlap=function(e,r,a,i){var o=sap.ui.getCore().byId(e);var n=s._getVisibleRelationships(o);var p=this.getRelatedInRowShapes(e);var h=t.getConfiguration().getRTL();var c,g,d,S=[];var f=function(e){g=[1,2];if(p.predecessor&&p.successor){n.forEach(function(t){if(t.mProperties.successor&&t.mProperties.predecessor){if(p.successor.mProperties.shapeId===t.getSuccessor()&&g.indexOf(u[t.getType()])!==-1&&t._getLMarker()===e){S.push(t.getShapeTypeEnd())}}})}S=s.getFilteredShapeType(S);var t=S.length>1?l.HorizontalRectangle:this.getShapeTypeEnd();if(t==l.VerticalRectangle||t==l.HorizontalRectangle){t=t==l.VerticalRectangle?l.HorizontalRectangle:l.VerticalRectangle}return t}.bind(this);var y=function(e,t){return e===l.Arrow?t:e};if(a=="start"){if(h){g=r==0||r==1?[2,3]:[0,1];d=r==0||r==1?[1,3]:[0,2]}else{g=r==0||r==1?[0,1]:[2,3];d=r==0||r==1?[0,2]:[1,3]}if(p.predecessor&&p.successor){n.forEach(function(e){if(e.mProperties.successor&&e.mProperties.predecessor){if(p.predecessor.mProperties.shapeId==e.getPredecessor()&&g.indexOf(u[e.getType()])!==-1){S.push(y(e.getShapeTypeStart(),"ArrowStart"))}if(p.predecessor.mProperties.shapeId==e.getSuccessor()&&d.indexOf(u[e.getType()])!==-1&&e._getLMarker()==""){S.push(y(e.getShapeTypeEnd(),"ArrowEnd"))}}})}S=s.getFilteredShapeType(S);c=S.length>1?l.HorizontalRectangle:this.getShapeTypeStart()}else{if(i=="rightUp"||i=="rightDown"||i=="leftUp"||i=="leftDown"){c=f(i)}else{if(h){g=r==1||r==3?[0,2]:[1,3];d=r==1||r==3?[0,1]:[2,3]}else{g=r==1||r==3?[1,3]:[0,2];d=r==1||r==3?[2,3]:[0,1]}if(p.predecessor&&p.successor){n.forEach(function(e){if(e.mProperties.successor&&e.mProperties.predecessor){if(p.successor.mProperties.shapeId==e.getSuccessor()&&g.indexOf(u[e.getType()])!==-1&&e._getLMarker()==""){S.push(y(e.getShapeTypeEnd(),"ArrowEnd"))}if(p.successor.mProperties.shapeId==e.getPredecessor()&&d.indexOf(u[e.getType()])!==-1){S.push(y(e.getShapeTypeStart(),"ArrowStart"))}}})}S=s.getFilteredShapeType(S);c=S.length>1?l.HorizontalRectangle:this.getShapeTypeEnd()}}return c};S.prototype.getCoordinate=function(e,t,r){var s=r=="rightStart"||r=="leftEnd"?e+this.SHAPE_SIZE/2:e-this.SHAPE_SIZE/2;var a=r=="rightStart"||r=="leftEnd"?e+this.SHAPE_SIZE:e-this.SHAPE_SIZE;var i=r=="rightStart"||r=="leftEnd"?e+2*c:e-2*c;var o=r=="rightStart"||r=="leftEnd"?e+c:e-c;var n=[[e,t],[e,t-this.SHAPE_SIZE/2],[s,t-this.SHAPE_SIZE/2],[a,t-this.SHAPE_SIZE/2],[a,t],[a,t+this.SHAPE_SIZE/2],[s,t+this.SHAPE_SIZE/2],[e,t+this.SHAPE_SIZE/2],[s,t],[i,t-c/2],[i,t+c/2],[e,t-c],[o,t-c],[o,t+c],[e,t+c],[e,t-c/2],[e,t+c/2]];return n};S.prototype.getCoordinateUpDown=function(e,t,r){var s=r=="up"?t+this.SHAPE_SIZE/2:t-this.SHAPE_SIZE/2;var a=r=="up"?t+this.SHAPE_SIZE:t-this.SHAPE_SIZE;var i=r=="up"?t+2*c:t-2*c;var o=r=="up"?t+c:t-c;var n=[[e,t],[e+this.SHAPE_SIZE/2,t],[e+this.SHAPE_SIZE/2,s],[e+this.SHAPE_SIZE/2,a],[e,a],[e-this.SHAPE_SIZE/2,a],[e-this.SHAPE_SIZE/2,s],[e-this.SHAPE_SIZE/2,t],[e,s],[e+c/2,i],[e-c/2,i],[e+c,t],[e+c,o],[e-c,o],[e-c,t],[e+c/2,t],[e-c/2,t]];return n};S.prototype.getShapeAnchors=function(e){var t={predecessor:null,successor:null};Object.keys(e).forEach(function(r){var s=e[r];if(s==null){return}if(s.getShapeAnchors){t[r]=s.getShapeAnchors()}else{var a,i,o;if(s.getDomRef("nonLabelGroup")){a=s.getDomRef("nonLabelGroup").getBBox();i=3/4;o=1/4}else{a=s.getDomRef().getBBox();i=1/2;o=1/2}var n,p=0;n=window.getComputedStyle(s.getDomRef()).transform.match(/matrix.*\((.+)\)/);if(n){p=n[1].split(", ")[5]}t[r]={head:{x:a.x,y:a.y+a.height*i+parseFloat(p),dx:0,dyTop:a.height*i,dyBottom:a.height*o},tail:{x:a.x+a.width,y:a.y+a.height*i+parseFloat(p),dx:0,dyTop:a.height*i,dyBottom:a.height*o}}}});return t};S.prototype.renderRelationship=function(i,o,n,p){this.writeElementData(i,"g",true);a.renderAttributes(i,this,["style"]);i.openEnd();a.renderTooltip(i,this);i.openStart("path");if(!this.getEnableCurvedEdge()||o.prompter){i.attr("d",this.getD())}else{i.style("fill","none");i.attr("d",s.getPathCorners(this.getD(),5))}i.openEnd().close("path");i.openStart("path");if(!this.getEnableCurvedEdge()||o.prompter){i.attr("d",this.getD());i.style("fill","none")}else{i.style("fill","none");i.attr("d",s.getPathCorners(this.getD(),5))}i.style("stroke-width",8);i.style("stroke","none");i.style("pointer-events","stroke");i.openEnd().close("path");i.openStart("path");i.style("fill",this.getStartShapeColor());i.style("stroke-dasharray","none");i.attr("d",this.getConnectorStartPath(this.getD(),p,n));i.openEnd().close("path");i.openStart("path");i.style("fill",this.getEndShapeColor());i.style("stroke-dasharray","none");i.attr("d",this.getConnectorEndPath(this.getD(),p,n));i.openEnd().close("path");if(o.prompter){i.openStart("text");i.attr("x",o.prompter.x);i.attr("y",o.prompter.y);i.attr("font-size",d);i.attr("font-family","SAP-icons");i.attr("text-anchor",t.getConfiguration().getRTL()&&!e.browser.edge?"end":"start");i.attr("stroke-width",0);i.openEnd();i.text(r.getIconInfo("chain-link").content);i.close("text")}i.close("g")};S.prototype.getStyle=function(){return this.getInlineStyle({fill:this.getStroke()||o.get("sapUiBaseText"),stroke:this.getStroke()||o.get("sapUiBaseText"),"stroke-width":this.getStrokeWidth()||1,"stroke-dasharray":this.getStrokeDasharray(),opacity:this.getStrokeOpacity()})};S.prototype.getLinePathD=function(e){if(this.getEnableCurvedEdge()){return d3.svg.line().interpolate("linear")(e)}else{e=e.concat(e.slice(1,-1).reverse());return d3.svg.line().interpolate("linear-closed")(e)}};S.prototype.getSelectedStyle=function(){return this.getInlineStyle({fill:this.getSelectedStroke(),stroke:this.getSelectedStroke(),"stroke-width":this.getSelectedStrokeWidth(),"stroke-dasharray":this.getStrokeDasharray(),"pointer-events":"none"})};S.prototype.getBaseRowHeight=function(e){return t.byId(e).getTable()._getDefaultRowHeight()};S.prototype.getProcessedType=function(){var e=this.getProperty("type");var r=t.getConfiguration().getRTL();return r?3-u[e]:u[e]};S.prototype.getRelatedInRowShapes=function(e){return{predecessor:s.shapeElementById(this.getPredecessor(),e+"-svg"),successor:s.shapeElementById(this.getSuccessor(),e+"-svg")}};return S},true);
//# sourceMappingURL=Relationship.js.map
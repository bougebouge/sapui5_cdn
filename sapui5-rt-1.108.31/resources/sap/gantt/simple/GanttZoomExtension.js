/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/events/KeyCodes","sap/gantt/config/TimeHorizon","./GanttExtension","./CoordinateUtils","./AggregationUtils"],function(jQuery,e,t,o,i,n,r){"use strict";var a=["mousedown","mousemove","mouseup","wheel","MozMousePixelScroll"];var s=a.reduce(function(e,t){e[t]=t;return e},{});s.keydown="keydown";s.periodZoom="periodZoom";var m=".sapGanttZoom";var g=function(e){return e+m};a=a.map(g);var h=s.periodZoom+m;var l=s.keydown+m;var d={start:"zoomStart",zooming:"zooming",end:"zoomEnd"};var u={dispatch:function(e,t){var o=this._getZoomExtension(),i=e.originalEvent||e;if(o.isMouseWheelZoom(e)){var n=t&&t.suppressSyncEvent;o.performMouseWheelZooming(i,n);return}if(t&&t.which){i.which=t.which}o.performTimePeriodZooming(i)},addEventListeners:function(e){var o=e._getZoomExtension(),i=o.getDomRefs(),n=i.ganttSvg,r=i.gantt,m=i.headerSvg;var g=function(t,o){jQuery(o).bind(t,u.dispatch.bind(e))};u.removeEventListeners(e);a.forEach(function(e){g(e,n);if(e.startsWith(s.wheel)){g(e,m)}});jQuery(r).on(h,u.dispatch.bind(e));jQuery(document).on(l,function(e){if(e.which===t.Z||e.which===t.ESCAPE){jQuery(this).find(".sapGanttChartContentBody").trigger(h,{which:e.which})}});if(n){var d=document.querySelectorAll(".sc-tooltips");if(!e.fnStockChartMouseMoveListener){e.fnStockChartMouseMoveListener=this.fnStockChartMouseMoveHandler.bind(this)}for(var v=0;v<d.length;v++){d[v].removeEventListener("mousemove",e.fnStockChartMouseMoveListener);d[v].addEventListener("mousemove",e.fnStockChartMouseMoveListener)}}},fnStockChartMouseMoveHandler:function(e){function t(e,t){var o=document.elementFromPoint(e,t);var i="";while(o&&o.tagName=="rect"){if(o.children&&o.children.length&&o.children[0].tagName=="title"){if(o.classList.contains("stockChartTooltip")){o.style.pointerEvents="none";o=document.elementFromPoint(e,t)}else{i=o.children[0].innerHTML+"\n"+i;o.style.pointerEvents="none";o=document.elementFromPoint(e,t)}}else{o=undefined}}return i}var o=e.currentTarget;var i=o.querySelectorAll(".sc-tooltips rect");i.forEach(function(e){e.style.pointerEvents="all"});var n=t(e.clientX,e.clientY);for(var r=0;r<o.children.length;r++){var a=o.children[r];if(a.classList.contains("stockChartTooltip")){a.getElementsByTagName("title")[0].innerHTML=n;a.style.pointerEvents="all";a.setAttribute("width",o.getBoundingClientRect().width)}}},removeEventListeners:function(e){var t=e._getZoomExtension(),o=t.getDomRefs(),i=o.ganttSvg,n=o.gantt,r=o.headerSvg;jQuery(i).unbind(m);jQuery(r).unbind(m);jQuery(n).unbind(m);jQuery(document).off(m)}};var v=i.extend("sap.gantt.GanttZoomExtension",{_init:function(e,t){this.bTimePeriodZoomMode=false;this.oZoomStartTime=null;this.iMouseWheelZoomDelayedCallId=undefined;this.iLastMouseWheelZoomTimeInMs=0;return"ZoomExtension"},_attachEvents:function(){var e=this.getGantt();u.removeEventListeners(e);u.addEventListeners(e)},_detachEvents:function(){var e=this.getGantt();u.removeEventListeners(e)}});v.prototype.isMouseWheelZoom=function(e){var t=e.shiftKey&&e.ctrlKey&&(e.type===s.wheel||e.type===s.MozMousePixelScroll);if(t){e.preventDefault();e.stopImmediatePropagation();e.stopPropagation()}return t};i.prototype.performMouseWheelZooming=function(e,t){var o=this._getWheelScrollDelta(e),i=this._getMousePositionX(e);this.decideMouseWheelZoom(e,o,i,t)};v.prototype._getWheelScrollDelta=function(e){var t=e.deltaY||e.deltaX;if(t===0||t===undefined){t=e.detail}var o=e.deltaMode===1?33:1;return t*o};v.prototype._getMousePositionX=function(e){return n.xPosOfSvgElement(e,jQuery(this.getDomRefs().ganttSvg))};v.prototype.decideMouseWheelZoom=function(e,t,o,i){var n=this.getGantt(),r=n.getAxisTimeStrategy();if(r.getMouseWheelZoomType()===sap.gantt.MouseWheelZoomType.None){return}var a=t<0,s=!a;var m=r.getZoomLevel(),g=r.getZoomLevels()-1;if(s&&m>0||a&&m<g){var h=!this.iMouseWheelZoomDelayedCallId&&Date.now()-this.iLastMouseWheelZoomTimeInMs>100?0:700;if(h===0){this.onMouseWheelZooming(e,r,o,t,i)}else{this.iMouseWheelZoomDelayedCallId=this.iMouseWheelZoomDelayedCallId||window.setTimeout(this.onMouseWheelZooming.bind(this),h,e,r,o,t,i)}}};v.prototype.onMouseWheelZooming=function(e,t,o,i,n){this.iLastMouseWheelZoomTimeInMs=Date.now();var r=t.getAxisTime().viewToTime(o);t.updateVisibleHorizonOnMouseWheelZoom(r,i,e,n);window.clearTimeout(this.iMouseWheelZoomDelayedCallId);delete this.iMouseWheelZoomDelayedCallId};v.prototype.performTimePeriodZooming=function(e){var o=this.getGantt()._getPointerExtension();var i=o.isPointerInGanttChart();var n=this.getGantt().getAxisTimeStrategy();if(!n.isTimePeriodZoomEnabled()){return}if(i===false){return}if(e.type===s.periodZoom){if(e.which===t.Z&&o.isPointerInGanttChart()){this.bTimePeriodZoomMode=!this.bTimePeriodZoomMode}if(e.which===t.ESCAPE){this.bTimePeriodZoomMode=false}this.updateCursorStyle(this.bTimePeriodZoomMode)}if(e.type===s.mousedown&&e.button===0){if(this.bTimePeriodZoomMode){this.handleZoomStart(e);this._fireTimePeriodZoomEvent({type:d.start,zoomStartTime:this.oZoomStartTime,zoomEndTime:null,originalEvent:e})}}if(e.type===s.mousemove&&this.bTimePeriodZoomMode){var r=this.timeFromEvent(e);this.handleZooming(e);this._fireTimePeriodZoomEvent({type:d.zooming,zoomStartTime:this.oZoomStartTime,zoomEndTime:r,originalEvent:e})}if(e.type===s.mouseup&&this.bTimePeriodZoomMode){this.bTimePeriodZoomMode=false;var r=this.timeFromEvent(e);this.handleZoomEnd(e);this._fireTimePeriodZoomEvent({type:d.end,zoomStartTime:this.oZoomStartTime,zoomEndTime:r,originalEvent:e})}};v.prototype.timeFromEvent=function(e){var t=jQuery(this.getDomRefs().ganttSvg),o=n.xPosOfSvgElement(e,t);var i=this.getGantt()._getPointerExtension();o+=i._getAutoScrollStep();return this.getGantt().getAxisTime().viewToTime(o)};v.prototype._fireTimePeriodZoomEvent=function(e){this.getGantt().fireEvent("_timePeriodZoomOperation",e)};v.prototype.syncTimePeriodZoomOperation=function(t,o,i){var n=t.getParameter("originalEvent");var r=t.getParameter("type");switch(r){case d.start:this.handleZoomStart(n);break;case d.zooming:this.handleZooming(n);break;case d.end:this.handleZoomEnd(n,true);break;default:e.debug("unknown time period zoom type")}};v.prototype.handleZoomStart=function(e){this.oZoomStartTime=this.timeFromEvent(e);var t=this.getGantt().getAxisTime().timeToView(this.oZoomStartTime);this.updateCursorStyle(this.bTimePeriodZoomMode);this.createZoomingRectangle(t)};v.prototype.handleZooming=function(e){this._isZooming=true;var t=this.oZoomStartTime;var o=this.timeFromEvent(e);var i=this.getGantt().getAxisTime(),n=i.timeToView(t),r=i.timeToView(o);this.updateCursorStyle(this.bTimePeriodZoomMode);if(r>n){this.updateZoomingRectangle(n,r)}else{this.updateZoomingRectangle(r,n)}};v.prototype.isZoomingRectangleNotExisted=function(){var e=d3.select(this.getDomRefs().ganttSvg);return e.selectAll(".sapGanttChartTimePeriodZoomRectangle").size()===0};v.prototype.isTimeZooming=function(){return this._isZooming};v.prototype._handleAutoScroll=function(e){if(this.isTimeZooming()){if(this.isZoomingRectangleNotExisted()){var t=this.oZoomStartTime;var o=this.getGantt().getAxisTime(),i=o.timeToView(t);this.createZoomingRectangle(i)}this.handleZooming(e)}};v.prototype.handleZoomEnd=function(e,t){this._isZooming=false;var i=this.timeFromEvent(e);this.updateCursorStyle(this.bTimePeriodZoomMode);this.destroyZoomingRectangle();var n=this.getGantt().getAxisTime(),r=n.timeToView(this.oZoomStartTime),a=n.timeToView(i);var s=5;if(Math.abs(a-r)>s){var m=this.oZoomStartTime,g=i;if(i.getTime()<m.getTime()){var h=m;m=i;g=h}var l=new o({startTime:m,endTime:g});this.getGantt().syncVisibleHorizon(l,undefined,undefined,t?undefined:"timePeriodZooming")}};v.prototype.updateCursorStyle=function(e){var t=e?"crosshair":"auto";this.getDomRefs().ganttSvg.style.cursor=t;this.getDomRefs().headerSvg.style.cursor=t};v.prototype.createZoomingRectangle=function(e){var t=d3.select(this.getDomRefs().ganttSvg);this.destroyZoomingRectangle();t.append("rect").classed("sapGanttChartTimePeriodZoomRectangle",true).attr("x",e).attr("y",0).attr("height",jQuery(t.node()).height())};v.prototype.updateZoomingRectangle=function(e,t){var o=d3.select(this.getDomRefs().ganttSvg);o.selectAll(".sapGanttChartTimePeriodZoomRectangle").attr("x",e).attr("width",t-e)};v.prototype.destroyZoomingRectangle=function(){var e=d3.select(this.getDomRefs().ganttSvg);e.selectAll(".sapGanttChartTimePeriodZoomRectangle").remove()};v.prototype.doBirdEye=function(e){var t=this.getGantt();var i=this.calculateBirdEyeRange(e);var n=new o(i);t.getAxisTimeStrategy()._setVisibleHorizon(n)};v.prototype.calculateBirdEyeRange=function(e,t){var o=this.getGantt();var i=o.getTable();var n=i.getRows();var r;var a;var s;e=e?e-n[0].getIndex():e;var m=n[e]?true:false;if(e!=null&&e>=0&&m){r=this._getBirdEyeRangeOnRow(e);a=r.startTime;s=r.endTime}else if(e!=null&&e>=0&&!m){return null}else{for(var g=0;g<n.length;g++){r=this._getBirdEyeRangeOnRow(g,t);if(r.startTime&&r.endTime){var h=this._calculateBirdEyeTimeRange(a,s,r.startTime,r.endTime);a=h.startTime;s=h.endTime}}}var l={startTime:a,endTime:s};return l};v.prototype._getBirdEyeRangeOnRow=function(e,t){var o=this.getGantt();var i=o.getTable();var n=i.getBindingInfo("rows"),r=n&&n.model;var a=i.getRows();var s=a[e];var m=s.getBindingContext(r);var g;var h;if(m){var l=s.getAggregation("_settings");var d=[];d=this._getShapeInRow(l,d);var u=this;d.forEach(function(e){if(e instanceof sap.gantt.simple.BaseConditionalShape){e=e._getActiveShapeElement();if(e instanceof sap.gantt.simple.BaseGroup){e.getShapes().forEach(function(e){if(e.getCountInBirdEye&&e.getCountInBirdEye()){var t=e.getTime();var o=e.getEndTime();var i=u._calculateBirdEyeTimeRange(g,h,t,o);g=i.startTime;h=i.endTime}});return}}if(e&&e.getCountInBirdEye&&e.getCountInBirdEye()){var t=e.getTime();var o=e.getEndTime();var i=u._calculateBirdEyeTimeRange(g,h,t,o);g=i.startTime;h=i.endTime}})}if(g&&h){var v=o.getVisibleWidth();var c=(h.getTime()-g.getTime())/v;var f=o.getAxisTime();g=t?new Date(g.getTime()-c*5):f.viewToTime(f.timeToView(g)-5);h=t?new Date(h.getTime()+c*5):f.viewToTime(f.timeToView(h)+5)}var p={startTime:g,endTime:h};return p};v.prototype._getShapeInRow=function(e,t){var o=r.getNonLazyAggregations(e);var i=this;Object.keys(o).forEach(function(o){var n=e.getAggregation(o);if(n){n=jQuery.isArray(n)?n:[n];if(n.length>0){t=t.concat(n);n.forEach(function(e){t=i._getShapeInRow(e,t)})}}}.bind(e));return t};v.prototype._calculateBirdEyeTimeRange=function(e,t,o,i){if(!e||o.getTime()<e.getTime()){e=o}if(!t||t.getTime()<i.getTime()){t=i}return{startTime:e,endTime:t}};return v});
//# sourceMappingURL=GanttZoomExtension.js.map
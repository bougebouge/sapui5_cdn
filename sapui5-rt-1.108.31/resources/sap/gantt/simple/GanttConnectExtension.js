/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","sap/ui/core/Core","sap/gantt/library","./GanttExtension","./CoordinateUtils","./GanttUtils","sap/gantt/misc/Utility"],function(jQuery,t,e,n,o,a,i,s){"use strict";var r=".sapGanttShapeConnect";var h=n.simple.RelationshipType;var c={addEventListeners:function(t){this.removeEventListeners(t);var e=t._getConnectExtension();e.shapeConnectDoms().shapeConnectTriggers.on("mousedown"+r,e.beforeShapeConnect.bind(e))},removeEventListeners:function(t){var e=t._getConnectExtension();e.shapeConnectDoms().shapeConnectTriggers.off(r)},addShapeConnectEventListeners:function(t){this.removeShapeConnectEventListeners(t);var e=t._getConnectExtension();var n=jQuery(document);n.on("mousemove"+r,e.onMousemove.bind(e));n.on("mouseup"+r,e.endShapeConnect.bind(e));n.on("keydown"+r,e.onKeydown.bind(e))},removeShapeConnectEventListeners:function(t){jQuery(document).off(r)}};var p=o.extend("sap.gantt.simple.GanttConnectExtension",{_init:function(t,e){this._initShapeConnectStates();return"ConnectExtension"}});p.prototype.attachShapeConnectEvents=function(){var t=this.getGantt();c.addEventListeners(t);if(this.isShapeConnecting()){c.addShapeConnectEventListeners(t)}};p.prototype._initShapeConnectStates=function(){this.mDom={};this._oStartShape={};this._bShapeConnecting=false;this._oScrollDistance={x:0,y:0};this._bElementConnectable=false};p.prototype.getRlsStartShape=function(){return this._oStartShape};p.prototype.getSvgElement=function(){return this.getDomRefs().ganttSvg};p.prototype._getShapeConnectRootNode=function(){var t=this.shapeConnectDoms().shapeConnect;return d3.select(t.get(0))};p.prototype.setDomSelector=function(){var t=this.shapeConnectDoms();this.mDom.connectLine=t.connectLine;this.mDom.ghostRect=t.shapeConnectGhost};p.prototype.createConnectLine=function(t,e){var n=this.getGantt()._getPointerExtension();var o=e.x+n._getAutoScrollStep();var a={class:"shapeConnectLine",x1:t.x+t.width/2,y1:t.y+t.width/2,x2:o,y2:e.y};if(this.getD3Doms().shapeConnectLine.empty()){var i=this._getShapeConnectRootNode();i.append("line").attr(a)}};p.prototype.createGhostRect=function(t,e){var n=this.getGantt()._getPointerExtension();var o=t.x+n._getAutoScrollStep();var a={class:"shapeConnectGhost",x:o-t.width/2,y:e.y-t.width/2,width:t.width,height:t.width};if(this.getD3Doms().shapeConnectGhost.empty()){var i=this._getShapeConnectRootNode();i.append("rect").attr(a)}};p.prototype.isShapeConnecting=function(){return this._bShapeConnecting};p.prototype.updateShapeConnectEffect=function(t){if(this.isShapeConnecting()){var e=a.getLatestCursorPosition();var n=this.getStartShapeFrame();var o=this.getSvgElement();var i=a.getEventSVGPoint(o,e);this.createConnectLine(n,i);this.createGhostRect(n,i);this.showIndicator();this.setDomSelector();this.attachShapeConnectEvents()}};p.prototype.beforeShapeConnect=function(t){var n=jQuery(t.target);var o=n.parents("g").attr(i.SELECT_FOR_DATASET_KEY);this._bElementConnectable=true;var a=e.getConfiguration().getRTL();var s=t.target.getBBox();var r;if(a){r=n.hasClass("rightTrigger")?"Start":"Finish"}else{r=n.hasClass("leftTrigger")?"Start":"Finish"}this._oScrollDistance={x:0,y:0};this._oStartShape={startTriggerFrame:s,x:s.x+s.width/2,y:s.y+s.width/2,shapeUid:o,isRightTrigger:n.hasClass("rightTrigger"),startPoint:r};c.addShapeConnectEventListeners(this.getGantt())};p.prototype.toggleShapeConnectTrigger=function(){var t=this.getGantt();t._updateShapeSelections(t.getSelectedShapeUid(),[])};p.prototype.getStartShapeFrame=function(){var t={x:0,y:0,width:i.SHAPE_CONNECT_INDICATOR_WIDTH};if(this.isShapeConnecting()){var e=this.shapeConnectDoms().startShapeConnectTrigger;if(e&&e.length===1){return e.get(0).getBBox()}else{t.x=this._oStartShape.x-this._oScrollDistance.x;t.y=this._oStartShape.y-this._oScrollDistance.y}}return t};p.prototype._getAcceptableShapeElements=function(){var t=[];var e=this;this.shapeConnectDoms().connectableShapes.each(function(n,o){var a=jQuery(o).control(0,true);if(a&&e._oStartShape.shapeUid!==a.getShapeUid()&&a.getDomRef()){t.push(a)}});return t};p.prototype.showIndicator=function(){if(!this.isShapeConnecting()){return}var t=[];var e=this;this._getAcceptableShapeElements().forEach(function(n){t.push(e._getIndicatorData(n))});this.getD3Doms().shapeConnectContainers.data(t).enter().append("g").classed("shapeConnectContainer",true).attr("id",function(t){return t.id+"-shape-connect"}).attr(i.SHAPE_CONNECT_FOR_DATASET_KEY,function(t){return t.id}).each(function(t){var e=d3.select(this);e.append("rect").attr(t.left);e.append("rect").attr(t.right)});this.attachEventHandlerToIndicator()};p.prototype.onMousemove=function(t){if(this._bElementConnectable===false){return}if(!this.isShapeConnecting()){this._bShapeConnecting=true;var e=this.getSvgElement();var n=a.getEventSVGPoint(e,t);this.createConnectLine(this._oStartShape.startTriggerFrame,n);this.createGhostRect(this._oStartShape.startTriggerFrame,n);this.showIndicator();this.toggleShapeConnectTrigger();this.setDomSelector()}else{this.onShapeConnecting(t)}};p.prototype.onShapeConnecting=function(t){var e=this.getSvgElement();var n=a.getEventSVGPoint(e,t);var o=this.getGantt()._getPointerExtension();var s=n.x+o._getAutoScrollStep();this.mDom.connectLine.attr({x2:s,y2:n.y});var r=i.SHAPE_CONNECT_INDICATOR_WIDTH;this.mDom.ghostRect.attr({x:s-r/2,y:n.y-r/2})};p.prototype.fireEvent=function(t){var n=jQuery(t.target);var o=n.parents("g").attr(i.SHAPE_CONNECT_FOR_DATASET_KEY);var a=e.getConfiguration().getRTL();var s=(a?n.hasClass("rightIndicator"):n.hasClass("leftIndicator"))?"Start":"Finish";var r=this._oStartShape.startPoint+"To"+s;var c={fromShapeUid:this._oStartShape.shapeUid,toShapeUid:jQuery(document.getElementById(o)).control(0).getShapeUid(),type:h[r]};var p=this.getGantt();p.fireShapeConnect(c)};p.prototype.endShapeConnect=function(t){if(this.isShapeConnecting()){var e=this._getShapeConnectRootNode();e.selectAll("*").remove()}c.removeShapeConnectEventListeners(this.getGantt());this._initShapeConnectStates();this.toggleShapeConnectTrigger()};p.prototype.onKeydown=function(e){if(this.isShapeConnecting()&&e.keyCode===t.ESCAPE){this.endShapeConnect(e)}};p.prototype.toggleGhostRect=function(t){if(this.isShapeConnecting()){this.shapeConnectDoms().shapeConnectGhost.toggleClass("hideShapeConnectGhost");jQuery(t.target).toggleClass("hoverOnShapeConnectIndicator")}};p.prototype.attachEventHandlerToIndicator=function(){var t=this.shapeConnectDoms().indicators;t.off(r);t.on("mouseup"+r,this.fireEvent.bind(this));t.on("mouseover"+r+" mouseout"+r,this.toggleGhostRect.bind(this))};p.prototype._getIndicatorData=function(t){var e=t.getId();var n,o;if(t.getDomRef("nonLabelGroup")){n=t.getDomRef("nonLabelGroup").getBBox();o=3/4}else{n=t.getDomRef().getBBox();o=1/2}var a=n.x,r=n.y,h=n.width,c=n.height,p=false;if(t instanceof sap.gantt.simple.BaseGroup){var g=0,S;S=window.getComputedStyle(t.getDomRef()).transform.match(/matrix.*\((.+)\)/);if(S){g=S[1].split(",")[5];p=true}r=n.y+parseFloat(g)}var C=i.SHAPE_CONNECT_INDICATOR_WIDTH-2;var l=2;var d=s.getShapeBias(t);var v=a-l-C+d.x,f=p?r+c*o-C/2:r+c*o-C/2+d.y;var u=a+h+l+d.x,m=f;var _={width:C,height:C};return{id:e,left:jQuery.extend({x:v,y:f,class:"leftIndicator shapeConnectIndicator"},_),right:jQuery.extend({x:u,y:m,class:"rightIndicator shapeConnectIndicator"},_)}};p.prototype.storeScrollDistance=function(t,e){if(e){this._oScrollDistance.x+=t}else{this._oScrollDistance.y+=t}};p.prototype.shapeConnectDoms=function(){var t=jQuery(this.getSvgElement());var e="g["+i.SELECT_FOR_DATASET_KEY+'="'+this._oStartShape.shapeUid+'"]';var n=".shapeConnectTrigger."+(this._oStartShape.isRightTrigger?"rightTrigger":"leftTrigger");var o=t.find("g.sapGanttChartShapeConnect");var a=t.find("g.sapGanttChartSelection");return{shapeConnect:o,indicators:o.find(".shapeConnectContainer .shapeConnectIndicator"),shapeConnectGhost:o.find(".shapeConnectGhost"),connectLine:o.find(".shapeConnectLine"),connectableShapes:t.find("["+i.CONNECTABLE_DATASET_KEY+"=true]"),shapeConnectTriggers:a.find(".shapeConnectTrigger"),startShapeConnectTrigger:a.find(e+" "+n)}};p.prototype.getD3Doms=function(){var t=this._getShapeConnectRootNode();return{shapeConnectLine:t.selectAll(".shapeConnectLine"),shapeConnectGhost:t.selectAll(".shapeConnectGhost"),shapeConnectContainers:t.selectAll(".shapeConnectContainer")}};return p});
//# sourceMappingURL=GanttConnectExtension.js.map
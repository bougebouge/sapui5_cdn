/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/gantt/library","sap/ui/core/Core","sap/ui/core/Element","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/format/DateFormat","sap/base/util/ObjectPath","../misc/Utility","../misc/Format","../misc/RelativeTimeFormatter","../config/TimeHorizon","../misc/AxisTime"],function(e,t,i,a,o,n,r,s,l,m,p,g,T){"use strict";var u=a.extend("sap.gantt.axistime.AxisTimeStrategyBase",{metadata:{library:"sap.gantt",abstract:true,properties:{timeLineOptions:{type:"object"},timeLineOption:{type:"object"},coarsestTimeLineOption:{type:"object"},finestTimeLineOption:{type:"object"},zoomLevels:{type:"int",defaultValue:10},zoomLevel:{type:"int",defaultValue:0},calendarType:{type:"string",defaultValue:sap.ui.core.CalendarType.Gregorian},locale:{type:"object"},firstDayOfWeek:{type:"int"},mouseWheelZoomType:{type:"sap.gantt.MouseWheelZoomType",defaultValue:t.MouseWheelZoomType.FineGranular},calendarWeekNumbering:{type:"sap.ui.core.date.CalendarWeekNumbering",defaultValue:null}},aggregations:{totalHorizon:{type:"sap.gantt.config.TimeHorizon",multiple:false},visibleHorizon:{type:"sap.gantt.config.TimeHorizon",multiple:false},_axisTime:{type:"sap.gantt.misc.AxisTime",multiple:false,visibility:"hidden"}}}});u.prototype.applySettings=function(e){e=e||{};if(!e.visibleHorizon){e.visibleHorizon=t.config.DEFAULT_INIT_HORIZON.clone()}if(!e.totalHorizon){e.totalHorizon=t.config.DEFAULT_PLAN_HORIZON.clone()}this.checkFirstDayOfWeek(e);a.prototype.applySettings.call(this,e);this.calZoomBase();return this};u.prototype.clone=function(){var e=a.prototype.clone.apply(this,arguments);if(e.hasListeners("_redrawRequest")){e.mEventRegistry._redrawRequest.forEach(function(t){e.detachEvent("_redrawRequest",t.fFunction,t.oListener)})}return e};u.prototype.exit=function(){i.detachLocalizationChanged(this._onLocalizationChanged,this)};u.prototype.isTimePeriodZoomEnabled=function(){return true};u.prototype._setVisibleHorizon=function(e){var t=this._completeTimeHorizon(e);var i=this.getAggregation("visibleHorizon");if(i){i.setStartTime(t.getStartTime(),true);i.setEndTime(t.getEndTime(),true)}else{this.setAggregation("visibleHorizon",t,true)}return this};u.prototype.setVisibleHorizonWithReason=function(e,t,i){this._setVisibleHorizon(e);return this};u.prototype._completeTimeHorizon=function(e){var t=this.getVisibleHorizon(),i=this.getTotalHorizon();if(t===null||i===null){return e}var a=new g({startTime:t.getStartTime(),endTime:t.getEndTime()});if(e){var o=e.getStartTime(),n=e.getEndTime(),r,s=m.abapTimestampToDate(i.getStartTime()),l=m.abapTimestampToDate(i.getEndTime());if(!o&&!n){return a}var p;if(this._oZoom&&this._oZoom.base&&this._oZoom.base.scale!==undefined&&this._nGanttVisibleWidth!==undefined&&this.getAxisTime()){var T=this.getAxisTime().getZoomRate();var u=this._oZoom.base.scale/T;p=this._nGanttVisibleWidth*u}else{p=m.abapTimestampToDate(a.getEndTime()).getTime()-m.abapTimestampToDate(a.getStartTime()).getTime()}if(!o){r=m.abapTimestampToDate(n);r.setTime(r.getTime()-p);if(r<s){r=s;n=m.dateToAbapTimestamp(new Date(s+p))}o=m.dateToAbapTimestamp(r)}else if(!n){r=m.abapTimestampToDate(o);r.setTime(r.getTime()+p);if(r>l){r=l;o=m.dateToAbapTimestamp(new Date(l-p))}n=m.dateToAbapTimestamp(r)}else{r=m.abapTimestampToDate(o);if(r<s){o=this.getTotalHorizon().getStartTime()}r=m.abapTimestampToDate(n);if(r>l){n=this.getTotalHorizon().getEndTime()}}a.setStartTime(o);a.setEndTime(n)}return a};u.prototype.createAxisTime=function(t){var i=this.getTimeLineOption(),a=this.getVisibleHorizon(),o=this.getTotalHorizon();if(!l.judgeTimeHorizonValidity(a,o)){if(this.getVisibleHorizon()){this.getVisibleHorizon().setStartTime(o.getStartTime(),true);this.getVisibleHorizon().setEndTime(o.getEndTime(),true)}else{this.setAggregation("visibleHorizon",o.clone(),true)}e.warning("Visible horizon is not in total horizon, so convert visible horizon to total horizon",null,"sap.gantt.axistime.AxisTimeStrategyBase.createAxisTime()")}var n=m.getTimeStampFormatter().parse(o.getStartTime());var r=m.getTimeStampFormatter().parse(o.getEndTime());var p=r.valueOf()-n.valueOf();var g=m.getTimeStampFormatter().parse("20000101000000");var u=s.get(i.innerInterval.unit).offset(g,i.innerInterval.span).valueOf()-g.valueOf();var f=new T([n,r],[0,Math.ceil(p*i.innerInterval.range/u)],1,null,null,t,this);this.setAggregation("_axisTime",f,true)};u.prototype.syncContext=function(e){var t={zoomLevel:undefined,axisTimeChanged:false};return t};u.prototype.updateStopInfo=function(e){return null};u.prototype._setTotalHorizon=function(e,t){if(typeof t==="undefined"){t=true}if(e){var i=this.getAggregation("totalHorizon");if(i){i.setStartTime(e.getStartTime(),true);i.setEndTime(e.getEndTime(),true)}else{this.setAggregation("totalHorizon",e,t)}}return this};u.prototype.getUpperRowFormatter=function(){var e=this.getTimeLineOption();var t=e.largeInterval;var a;if(t.relativeTime){var n=m.abapTimestampToDate(this.getTotalHorizon().getStartTime());a=new p(n,t.unit,t.relativeTimePrefix)}else{var s=this.getCalendarType(),l=this.getCalendarWeekNumbering(),g=this.getLocale()?this.getLocale():new o(i.getConfiguration().getLanguage().toLowerCase());a=r.getDateTimeWithTimezoneInstance({format:t.format,pattern:t.pattern,style:t.style,calendarType:e.calendarType||s,calendarWeekNumbering:l,showTimezone:false},t.locale?new o(t.locale):g)}return a};u.prototype.getLowerRowFormatter=function(){var e=this.getTimeLineOption();var t=e.smallInterval;var a;if(t.relativeTime){var n=m.abapTimestampToDate(this.getTotalHorizon().getStartTime());a=new p(n,t.unit,t.relativeTimePrefix)}else{var s=this.getCalendarType(),l=this.getCalendarWeekNumbering(),g=this.getLocale()?this.getLocale():new o(i.getConfiguration().getLanguage().toLowerCase());a=r.getDateTimeWithTimezoneInstance({format:t.format,pattern:t.pattern,style:t.style,calendarType:s,calendarWeekNumbering:l,showTimezone:false},t.locale?new o(t.locale):g)}return a};u.prototype.isLowerRowTickHourSensitive=function(){var e=this.getTimeLineOption();var t=e.innerInterval.unit;var i=e.innerInterval.span;var a=m.getTimeStampFormatter().parse("20000101000000");var o=s.get(t).offset(a,i);return o.getTime()-a.getTime()<=60*60*1e3};u.prototype.getAxisTime=function(){return this.getAggregation("_axisTime")};u.prototype.fireRedrawRequest=function(e,t,i,a,o){this.fireEvent("_redrawRequest",{forceUpdate:e,reasonCode:t,valueBeforeChange:i,originEvent:a,subReasonCode:o})};u.prototype.updateGanttVisibleWidth=function(e){this._nGanttVisibleWidth=e};u.prototype.getGanttVisibleWidth=function(){return this._nGanttVisibleWidth};u.prototype.calZoomScale=function(e,t,i){var a=m.getTimeStampFormatter().parse("20000101000000");var o=s.get(e).offset(a,t);return this.calZoomScaleByDate(a,o,i)};u.prototype.calZoomScaleByDate=function(e,t,i){return(t.valueOf()-e.valueOf())/i};u.prototype.calZoomBase=function(){var e=this.getTimeLineOption()||this.getFinestTimeLineOption();if(e){var t=this.calZoomScale(e.innerInterval.unit,e.innerInterval.span,e.innerInterval.range);this._oZoom={base:{timeLineOption:e,rate:1,scale:t}};return true}return false};u.prototype.checkFirstDayOfWeek=function(e){if(typeof e.firstDayOfWeek==="undefined"){e.firstDayOfWeek=n.getInstance(i.getConfiguration().getLocale()).getFirstDayOfWeek();i.attachLocalizationChanged(this._onLocalizationChanged,this)}};u.prototype.updateVisibleHorizonOnMouseWheelZoom=function(e,i,a,o){var n=i<0;var r=Math.round(Math.abs(i)/100);var s=this.getMouseWheelZoomType();if(s===t.MouseWheelZoomType.FineGranular){this.updateVisibleHorizonOnFineGranularMouseWheelZoom(e,n,r,a,o)}else if(s===t.MouseWheelZoomType.Stepwise){this.updateVisibleHorizonOnStepWiseMouseWheelZoom(e,n,r,a,o)}};u.prototype.updateVisibleHorizonOnFineGranularMouseWheelZoom=function(e,t,i,a,o){var n=this.getVisibleHorizon();var r=m.abapTimestampToDate(n.getStartTime());var l=this.getTimeLineOption();var p=s.get(l.innerInterval.unit).offset(r,i*l.innerInterval.span).getTime()-r.getTime();var g=t?-1:1;var T=this.calVisibleHorizonByDelta(g*p,e);var u=o?"syncVisibleHorizon":"mouseWheelZoom";this.setVisibleHorizonWithReason(T,u,a)};u.prototype.updateVisibleHorizonOnStepWiseMouseWheelZoom=function(e,t,i,a,o){var n=t?-1:1;var r=this.getZoomLevel()-n*i;if(r>-1&&r<this.getZoomLevels()){if(this._aZoomRate[r]&&!l.floatEqual(this._aZoomRate[r],this._oZoom.rate)){this.setZoomLevel(r)}}};u.prototype.calVisibleHorizonByRate=function(e,t){var i=0;if(this._oZoom&&this._oZoom.base&&this._oZoom.base.scale!==undefined&&this._nGanttVisibleWidth!==undefined){var a=m.abapTimestampToDate(this.getVisibleHorizon().getStartTime());var o=m.abapTimestampToDate(this.getVisibleHorizon().getEndTime());var n=o.getTime()-a.getTime();var r=this._oZoom.base.scale/e;var s=this._nGanttVisibleWidth*r;i=s-n}return this.calVisibleHorizonByDelta(i,t)};u.prototype.calVisibleHorizonByDelta=function(e,t){var i=this.getVisibleHorizon();e=Math.round(e)||0;if(e!==0){var a=m.abapTimestampToDate(i.getStartTime()).getTime();var o=m.abapTimestampToDate(i.getEndTime()).getTime();var n=o-a;var r=0;var s;var l=m.abapTimestampToDate(this.getTotalHorizon().getStartTime()).getTime();var p=m.abapTimestampToDate(this.getTotalHorizon().getEndTime()).getTime();if(e>0&&a<=l){s=0;r=l}else if(e>0&&o>=p){s=1;r=p}else{if(!t){r=a+n/2}else{r=t.getTime()}s=(r-a)/n}var T=n+e;var u=Math.floor(r-s*T);if(u<=l){u=l}var f=u+T;if(f>=p){u=u-(p-f);f=p;if(u<=l){u=l}}return new g({startTime:new Date(u),endTime:new Date(f)})}return i};u.prototype.calMiddleDate=function(e,t){return new Date(e.getTime()+(t.getTime()-e.getTime())/2)};u.prototype._onLocalizationChanged=function(){this.setFirstDayOfWeek(n.getInstance(i.getConfiguration().getLocale()).getFirstDayOfWeek())};u.prototype._updateZoomControlType=function(e){return null};return u},true);
//# sourceMappingURL=AxisTimeStrategyBase.js.map
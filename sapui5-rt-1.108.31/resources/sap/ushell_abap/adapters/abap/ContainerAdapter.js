// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/System","sap/ushell/User","sap/ushell/utils","sap/ushell_abap/bootstrap/evo/abap.bootstrap.utils","sap/ushell_abap/pbServices/ui2/ODataWrapper","sap/ui/thirdparty/URI","sap/ui/thirdparty/datajs","sap/base/util/ObjectPath","sap/base/Log"],function(jQuery,e,t,a,i,s,r,n,o,l){"use strict";var u=function(d,c,f){var p,m="/sap/public/bc/icf/logoff";this._logoutViaHiddenIFrame=function(e,t){var a=document.createElement("iframe"),i=t.replace(/"/g,'\\"');window.addEventListener("message",function(a){if(a.data===t){e.resolve()}});a.style.visibility="hidden";a.setAttribute("src",t);function s(){parent.postMessage(i,"*")}a.addEventListener("load",s);a.addEventListener("error",s);document.body.appendChild(a)};this.getSystem=function(){return d};this.getUser=function(){return p};this._determineAccessibility=function(e){var t=a.getParameterValueBoolean("sap-accessibility");if(t!==undefined){return t}t=e.accessibility;if(t!==undefined){return t}return false};this._setThemeAccessibilityFlags=function(e){if(e.userProfile&&e.userProfile.length){var t,a;t=e.userProfile.filter(function(e){return e.id&&e.id==="THEME"})[0];if(t&&t.value){e.setThemePermitted=t.editState===3}else{e.oUserProfileDataTheme=false}a=e.userProfile.filter(function(e){return e.id&&e.id==="ACCESSIBILITY"})[0];if(a&&a.id){e.setAccessibilityPermitted=a.editState===3}else{e.setAccessibilityPermitted=false}if(a&&a.value==="true"){e.accessibility=true}if(a&&a.value==="false"){e.accessibility=false}e.accessiblity=this._determineAccessibility(e)}};this._setUserProfileFlags=function(e){if(e.userProfile&&e.userProfile.length&&Array.isArray(e.userProfile)){var t={};e.setContentDensityPermitted=false;e.userProfile.forEach(function(a){if(a.id in t){return}t[a.id]=a.id;if(a.id==="CONTENT_DENSITY"){e.contentDensity=a.value;e.setContentDensityPermitted=a&&a.editState===3||false}if(a.id==="TRACKING_USAGE_ANALYTICS"){if(typeof a.value==="string"){if(a.value.toLowerCase()==="true"||a.value.toLowerCase()==="false"){a.value=a.value.toLowerCase()==="true"||false}else{a.value=undefined}}if(typeof a.value==="undefined"||typeof a.value==="boolean"){e.trackUsageAnalytics=a.value}else{e.trackUsageAnalytics=undefined}}if(a.id==="MYHOME_IMPORT_FROM_CLASSIC"){e.importBookmarks=a.value}if(a.id==="MYHOME_ENABLEMENT"){switch(a.value){case"false":e.showMyHome=false;break;case"true":e.showMyHome=true;break;default:e.showMyHome=undefined;break}}if(a.id==="THEME_DARKMODE_AUTO_DETECTION"){switch(a.value){case"false":e.detectDarkMode=false;break;case"true":e.detectDarkMode=true;break;default:e.detectDarkMode=undefined;break}}})}};this.load=function(){var a=new jQuery.Deferred,i=f.config,r=i.systemProperties;d=new e({alias:d.getAlias(),platform:d.getPlatform(),baseUrl:i.baseUrl,client:i.client,clientRole:i.clientRole,system:i.system,productName:r&&r.productName,systemName:r&&r.systemName,systemRole:r&&r.systemRole,tenantRole:r&&r.tenantRole,productVersion:i.productVersion,isTrialSystem:i.isTrialSystem});this._setThemeAccessibilityFlags(i);this._setUserProfileFlags(i);p=new t(i);s["sap-language"]=i.language;s["sap-client"]=i.client;if(i.target){u.startUpApplication={adjustedInitialTarget:i.adjustedInitialTarget,target:i.target}}this._setUserImage(p);return a.resolve().promise()};this.addFurtherRemoteSystems=function(){var t=new jQuery.Deferred;sap.ushell.Container.getServiceAsync("PageBuilding").then(function(a){a.getFactory().getPageBuildingService().readAllCatalogsForUser("type eq 'H' or type eq 'REMOTE'",function(a){var i="/sap/opu/odata/sap/SM_CATALOG_SRV/";if(a.results){a.results.forEach(function(t){var a=/^\/sap\/hba\//.test(t.baseUrl);if(t.type==="H"||t.baseUrl===i||a){sap.ushell.Container.addRemoteSystem(new e({alias:t.systemAlias,platform:a||t.type==="H"?"hana":"abap",baseUrl:t.type==="H"?"":";o="}))}})}t.resolve()},function(e){l.error("Reading REMOTE catalogs failed: "+e,null,"sap.ushell_abap.adapters.abap.ContainerAdapter");t.reject()})}).catch(t.reject);return t.promise()};this.getCurrentUrl=function(){return window.location.href};this.sessionKeepAlive=function(){var e="/sap/opu/odata/UI2/PAGE_BUILDER_PERS";var t=i.createAndOpenXHR(e,null,"HEAD");t.onreadystatechange=function(){if(this.readyState===4){l.debug("server session was extended")}};t.send()};this.logout=function(e){var t=new jQuery.Deferred,i;if(e){if(a.hasNativeLogoutCapability()){var s=new r(m).absoluteTo(this.getCurrentUrl()).search("").toString();window.external.getPrivateEpcm().doLogOff(s)}else{this.logoutRedirect()}l.info("ABAP system logged out: "+d.getAlias(),null,"sap.ushell_abap.adapters.abap.ContainerAdapter");t.resolve()}else{i=d.adjustUrl(m);l.info("Logging out from system '"+d.getAlias()+"' via hidden iframe");this._logoutViaHiddenIFrame(t,i)}return t.promise()};this.logoutRedirect=function(){var e=d.adjustUrl(m);this._setDocumentLocation(e)};this._setDocumentLocation=function(e){window.document.location=e};this._setUserImage=function(e){function t(){var e=window["sap-ushell-config"],t=o.get("renderers.fiori2.componentData.config.enableUserImage",e);return!!t}if(t()&&e&&e.isJamActive&&e.isJamActive()){n.read("/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData/Self?$format=json",function(t){var a=t.results.Id,i="/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData/Members('"+a+"')/ProfilePhoto/$value";e.setImage(i)},function(){l.error("Could not recieve JAM user data")})}}};return u},true);
//# sourceMappingURL=ContainerAdapter.js.map
// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/util/isPlainObject","sap/base/util/deepExtend","sap/ushell/utils","sap/ushell/utils/UrlParsing","sap/base/Log","sap/ushell_abap/pbServices/ui2/ODataWrapper","sap/ushell_abap/pbServices/ui2/Utils"],function(jQuery,e,t,a,r,i,n,s,o){"use strict";var l="sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter",p=["sap-wd-configId","SAP-WD-CONFIGID","sap-client","SAP-CLIENT","System","SYSTEM","sap-language","SAP-LANGUAGE","sap-wd-htmlrendermode","sap-wd-deltarendering","wdallowvaluesuggest","sap-wd-lightspeed","sap-wd-remotedesktop","sap-wd-flashdebug","sap-accessibility","sap-theme","sap-*","SAP-*","wd*","WD*"];var u=function(e,t,a){var i=this;var o=sap.ushell.Container,l="";if(o){l=o.getLogonSystem().getProductName()||""}this._oLocalSystemAlias={http:{id:"",host:"",port:"",pathPrefix:"/sap/bc/"},https:{id:"",host:"",port:"",pathPrefix:"/sap/bc/"},rfc:{id:"",systemId:"",host:"",service:0,loginGroup:"",sncNameR3:"",sncQoPR3:""},id:"",label:"local",client:"",language:"",properties:{productName:l}};this.hasSegmentedAccess=true;this._oAdapterConfig=a&&a.config;this._wdLengthLimit=1800;this._oODataWrapper=undefined;this._getODataWrapper=function(){if(!this._oODataWrapper){this._oODataWrapper=s.createODataWrapper("/sap/opu/odata/UI2/INTEROP/")}return this._oODataWrapper};this._aTargetMappings=[];this._aInbounds=[];this._aInitialSegment=undefined;this._oSystemAliasBuffer=new r.Map;this._oURLTemplates={};this._storeFromFullStartupResponse=function(e){if(e){if(e.targetMappings){i._aTargetMappings=e.targetMappings}if(e.systemAliases){i._writeUserSystemAliasesToBuffer(e.systemAliases)}if(e.urlTemplates){i._oURLTemplates=e.urlTemplates}}};this._fallbackToFullStartupRequest=function(e,t){n.debug("Falling back to full start_up request from adapter","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");i._requestAllTargetMappings().done(function(t){i._storeFromFullStartupResponse(t);e()}).fail(function(e){t(e)})};this._iTargetMappingsUnusedPromiseRejectCount=0;this._oInitialSegmentPromise=a&&a.config&&a.config.initialSegmentPromise||new Promise(function(e,t){i._iTargetMappingsUnusedPromiseRejectCount++;if(i._iTargetMappingsUnusedPromiseRejectCount===2){i._fallbackToFullStartupRequest(e,t)}});this._oNavTargetPromise=a&&a.config&&a.config.navTargetDataPromise||new Promise(function(e,t){i._iTargetMappingsUnusedPromiseRejectCount++;if(i._iTargetMappingsUnusedPromiseRejectCount===2){i._fallbackToFullStartupRequest(e,t)}});this._oInitialSegmentPromise.then(function(e){if(e===null){n.debug("Initial target mappings segment promise resolved with 'null'","Will not process initial target mappings segments again (mostly likely because this is no longer needed)","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return}if(i._aTargetMappings.length===0){n.debug("Segmented start_up response returned","storing system aliases and inbounds from segment","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");var t=e[0],a=e[1],r=e[2];if(e.length>3){i._oURLTemplates=e[3]}i._aTargetMappings=a;i._writeUserSystemAliasesToBuffer(r);i._aInitialSegment=t}else{n.debug("Segmented start_up response returned","ignoring response because the full target mapping response returned before","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter")}}).catch(function(e){n.error("Initial segment promise was rejected.",e,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter")});this._oNavTargetPromise.then(function(e){n.debug("Full start_up response returned","storing system aliases and inbounds","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");i._storeFromFullStartupResponse(e)})};u.prototype._adjustNavTargetResult=function(e){if(e){var t=e.url,a,r={applicationType:e.applicationType,additionalInformation:e.applicationData},i,s,l,p;if(e.text){r.text=e.text}if(e.applicationType==="URL"||e.applicationType==="SAPUI5"){s=/^SAPUI5\.Component=(.*)/.exec(e.applicationData);i=s&&s[1];if(i||e.applicationDependencies){if(i){r.ui5ComponentName=i}if(e.applicationDependencies){try{l=JSON.parse(e.applicationDependencies);p=l.self;if(!r.ui5ComponentName&&p.name){r.ui5ComponentName=p.name;r.additionalInformation="SAPUI5.Component="+r.ui5ComponentName}if(p&&p.url&&typeof p.url==="string"){var u=sap.ui.require("sap/ui/thirdparty/URI");a=t&&new u(t);if(a){if(p.url.toUpperCase().indexOf(a.path().toUpperCase())!==0){n.debug("Component URL defined in target mapping "+"does not match the URL retrieved from application index. "+"The URL of the application index is used for further processing.","Target mapping URL: "+e.url+"\nApplication index URL: "+p.url,"sap.ushell_abap.bootstrap.abap")}a.path(p.url);t=a.toString();n.debug("ResolveLink result's component url has been replaced with the url specified "+"in Application Dependencies, which includes cache buster token")}else{t=p.url}}r.applicationDependencies=l}catch(e){n.error("Parsing of applicationDependencies attribute in resolveLink result failed for SAPUI5 component '"+i+"'",e,"sap.ushell_abap.bootstrap.abap")}}t=o.addCacheBusterTokenUsingUshellConfig(t)}}r.url=t;return r}};u.prototype.resolveHashFragmentFallback=function(e,t,a){var r=this._constructShellHashForLpdCust(t,a),i=a&&a["sap-system"]&&a["sap-system"][0],n=new jQuery.Deferred;this._resolveHashFragmentBE(r||e).done(function(e){if(e&&i){e["sap-system"]=e["sap-system"]||i}n.resolve(e)}).fail(n.reject.bind(n));return n.promise()};u.prototype.getInbounds=function(e){var t=new jQuery.Deferred,a=this;this._oInitialSegmentPromise.then(function(r){if(r===null){return}if(a._isInSegment(e,a._aInitialSegment)){n.debug("Got inbounds from initial segment","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");a._aInbounds=a._formatDirectStart(a._aTargetMappings);t.resolve(a._aInbounds)}else{n.debug("Did not get inbound in initial segment","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter")}});this._oNavTargetPromise.then(function(){n.debug("Got inbounds from full start_up response","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");a._aInbounds=a._formatDirectStart(a._aTargetMappings);a.getInbounds=function(){return(new jQuery.Deferred).resolve(a._aInbounds).promise()};t.resolve(a._aInbounds)},function(e){t.reject(e)});return t.promise()};u.prototype._isInSegment=function(e,t){if(!Array.isArray(t)||!Array.isArray(e)){return false}return e.every(function(e){return!t.every(function(t){return!(e.semanticObject===t.semanticObject&&e.action===t.action)})})};u.prototype._requestAllTargetMappings=function(){var t=o.getParameterMap();var a=new jQuery.Deferred;var i="/sap/bc/ui2/start_up?so=%2A&action=%2A&",n=e.create("services.targetMappings",this._oAdapterConfig).cacheId&&"&sap-cache-id="+e.create("services.targetMappings",this._oAdapterConfig).cacheId||"";function s(e){var a=t[e];if(a){i+=e+"="+encodeURIComponent(a[0])+"&"}}s("sap-language");s("sap-client");o.get(i+"&shellType="+r.getShellType()+"&depth=0"+n,false,function(e){var t=JSON.parse(e);if(!t){a.reject("Malformed Full TM Result")}a.resolve(t)},function(e){a.reject(e)});return a.promise()};u.prototype._formatDirectStart=function(e){var r=this;if(!e){this._aInitialSegment=undefined;return[]}function i(e,i){var s={};var o=e.match(/^([^-]+)-([^~]+)/);if(!o){n.warning("The target mapping id "+e+" is not valid","this target mapping will be discarded","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return undefined}if(!i.hasOwnProperty("text")){i.text=""}s.semanticObject=o[1];s.action=o[2];s.id=e;s.title=i.text;s.permanentKey="X-SAP-UI2-PAGE:"+i.catalogId+":"+i.tmChipId;s.contentProviderId="";var l={};["applicationType","applicationDependencies","applicationData","postParameters","text","url","systemAlias"].forEach(function(e){l[e]=i[e]});s.resolutionResult=u.prototype._adjustNavTargetResult(l);s.resolutionResult.additionalInformation=s.resolutionResult.additionalInformation||"";s.resolutionResult.appId=s.permanentKey;var p=s.resolutionResult,f=p.applicationType;if(e.indexOf("Shell-startWCF")===0&&f==="URL"){s.resolutionResult.systemAliasSemantics="apply"}s.resolutionResult.applicationType=r._formatApplicationType(e,s.resolutionResult);s.resolutionResult.systemAlias=i.systemAlias||"";s.deviceTypes=i.formfactors;s.resolutionResult["sap.ui"]={};s.resolutionResult["sap.ui"].technology=s.resolutionResult.applicationType;if(s.resolutionResult["sap.ui"].technology==="SAPUI5"){s.resolutionResult["sap.ui"].technology="UI5"}if(s.resolutionResult["sap.ui"].technology==="TR"){s.resolutionResult["sap.ui"].technology="GUI"}if(!s.deviceTypes){s.deviceTypes=i.formFactors||{}}s.deviceTypes.desktop=s.deviceTypes.desktop||false;s.deviceTypes.phone=s.deviceTypes.phone||false;s.deviceTypes.tablet=s.deviceTypes.tablet||false;if(Array.isArray(i.signature)){s.signature={};s.signature.additionalParameters=i.allowParams?"allowed":"ignored";s.signature.parameters={};i.signature.forEach(function(e){var t={};var a;var i=e.name;if(e.defaultValue&&e.defaultValue.value){t.defaultValue={};t.defaultValue.value=e.defaultValue.value;t.defaultValue.format=e.defaultValue.format||"plain";a=r._extractUserDefaultValue(t.defaultValue.value);if(a){t.defaultValue={value:a,format:"reference"}}}if(e.filter&&e.filter.value){t.filter={};t.filter.value=e.filter.value;t.filter.format=e.filter.format||"plain";a=r._extractUserDefaultValue(t.filter.value);if(a){t.filter={value:a,format:"reference"}}}if(e.renameTo){t.renameTo=e.renameTo}t.required=e.required||false;s.signature.parameters[i]=t})}else{s.signature=a({parameters:{}},i.signature);s.signature.additionalParameters=s.signature.additionalParameters||(i.allowParams?"allowed":"ignored");Object.keys(s.signature.parameters).forEach(function(e){var t=s.signature.parameters[e];if(t.filter){t.filter.format=t.filter.format||"plain"}if(t.defaultValue){t.defaultValue.format=t.defaultValue.format||"plain"}t.required=t.required||false;if(t.filter&&t.filter.hasOwnProperty("format")&&!t.filter.hasOwnProperty("value")){delete t.filter}if(t.defaultValue&&t.defaultValue.hasOwnProperty("format")&&!t.defaultValue.hasOwnProperty("value")){delete t.defaultValue}})}var d=s.signature&&s.signature.parameters&&s.signature.parameters["sap-hide-intent-link"];if(d&&d.hasOwnProperty("defaultValue")){s.hideIntentLink=d.defaultValue.value==="true"}if(d&&!d.required&&d.hasOwnProperty("defaultValue")){delete s.signature.parameters["sap-hide-intent-link"]}if(typeof i.parameterMappings==="object"){Object.keys(i.parameterMappings).forEach(function(e){var t=i.parameterMappings[e];if(e&&t.target){s.signature.parameters[e]=s.signature.parameters[e]||{};s.signature.parameters[e].renameTo=t.target}})}if(s.resolutionResult.applicationType==="URL"&&t(i.urlTemplate)){s.templateContext=r.getUrlTemplateContext(i)}return s}var s=[];Object.keys(e).forEach(function(t){var a=i(t,e[t]);if(a){s.push(a)}});return s};u.prototype._formatApplicationType=function(e,t){var a=t.applicationType,r=t.url||"";function i(t,a){n.warning("Cannot detect application type for TargetMapping id '"+e+"', will default to "+a+" application type","TargetMapping URL is '"+r+"'",l)}if(a==="SAPUI5"){return"SAPUI5"}if(a==="URL"&&t.additionalInformation&&t.additionalInformation.indexOf("SAPUI5.Component=")===0){return"SAPUI5"}if(a==="WDA"||a==="TR"||a==="WCF"){return a}if(e.indexOf("Shell-startWCF")===0&&a==="URL"){return"WCF"}if(a==="NWBC"){if(r.indexOf("/~canvas;window=app/wda")>=0){return"WDA"}if(r.indexOf("/~canvas;window=app/transaction")>=0){return"TR"}i(t,"TR");return"TR"}if(a!=="URL"){i(t,"URL")}return"URL"};u.prototype._extractUserDefaultValue=function(e){var t,a=new RegExp("^%%(UserDefault[.].+)%%$"),r=a.exec(e);return r?r[1]:t};u.prototype._formatSignature=function(e,t){var a=this,r={parameters:{},additionalParameters:t===false?"ignored":"allowed"};if(!e.results){return r}e.results.forEach(function(t){var i,s=t.name,o,l;if(Object.prototype.hasOwnProperty.call(r.parameters,s)){n.error("Duplicate property name "+s+" in "+JSON.stringify(e),"ClientSideTargetResolutionAdapter._formatSignature")}r.parameters[s]={required:a._getObjectDefaulting(t,"required",false)};i=r.parameters[s];o=a._getObjectDefaulting(t,"value","");if(t.regexp===true){i.filter={value:o===""?".*":o,format:"regexp"};return}if(t.required===false){l=a._extractUserDefaultValue(o);if(l){i.defaultValue={value:l,format:"reference"};return}if(o!==""){i.defaultValue={value:o}}return}if(t.required===true&&t.value){l=a._extractUserDefaultValue(o);if(l){i.filter={value:l,format:"reference"};return}if(o!==""){i.filter={value:o}}}});return r};u.prototype._mergeParameterMappingsIntoSignature=function(e,t){var a=t.results;if(!a){return}a.forEach(function(t){var a=t.source;var r=t.target;if(r){e.parameters[a]=e.parameters[a]||{};if(e.parameters[a].renameTo){n.warning("duplicate parameter mapping for'"+a+"'","OData Parameter mappings is "+JSON.stringify(t,null,"   "),l)}e.parameters[a].renameTo=r}})};u.prototype._formatDeviceTypes=function(e){var t={},a=this;["desktop","tablet","phone"].forEach(function(r){t[r]=a._getObjectDefaulting(e,r,false)});return t};u.prototype._getObjectDefaulting=function(t,a,r){var i=e.get(a||"",t);return i===undefined?r:i};u.prototype._constructShellHashForLpdCust=function(a,r){var s="",o,l=e.get("resolutionResult._original",a);if(!t(l)){o="the given target mapping is not an object"}if(!o&&!l.hasOwnProperty("id")){o="no id found in target mapping _original object"}if(!o&&typeof l.id!=="string"){o="the target mapping id was not a string"}if(!o&&l.id.length===0){o="the target mapping id was an empty string"}if(o){n.error("Cannot construct Shell Hash for LPD_CUST resolution",o,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return undefined}s+=l.id;var p=i.paramsToString(r);if(p.length>0){s+="?"+p}return s};u.prototype._openBatchQueueUnlessOpen=function(e){if(e.isBatchQueueOpen()){return false}e.openBatchQueue();return true};u.prototype._resolveHashFragmentBE=function(e){var t=new jQuery.Deferred,a=this,i,s=o.getFormFactor();function l(e){return encodeURIComponent(e).replace(/'/g,"''")}i=this._openBatchQueueUnlessOpen(this._getODataWrapper());function p(e,t){if(e){t+=t.indexOf("?")<0?"?":"&";t+=e}return t}this._oODataWrapper.read("ResolveLink?linkId='"+l(e)+"'&shellType='"+r.getShellType()+"'"+(s?"&formFactor='"+l(s)+"'":""),function(r){var i,s="",o;if(r.results.length){if(r.results.length>1){for(i=0;i<r.results.length;i+=1){delete r.results[i].__metadata;s+=(i===0?"used target: ":"\nignored target: ")+JSON.stringify(r.results[i])}n.error("INTEROP service's ResolveLink operation "+"returned "+r.results.length+" targets for hash '#"+e+"', first one is used.",s,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter")}r=r.results[0];o=u.prototype._adjustNavTargetResult(r);o.url=p(r.postParameters,o.url);if(o&&o.applicationType==="SAPUI5"){o.applicationType="URL"}a._compactTooLongWdaUrl(o).done(function(e){t.resolve(e)}).fail(function(a){t.reject("Could not resolve link '"+e+"' due to compactation failure"+a)})}else{t.reject("Could not resolve link '"+e+"'")}},function(e){t.reject(e)});if(i){a._getODataWrapper().submitBatchQueue(function(){},t.reject.bind(t))}return t.promise()};u.prototype._compactTooLongWdaUrl=function(e){var t=new jQuery.Deferred;var a=e&&e.url;if(e&&e.applicationType==="NWBC"&&a&&a.indexOf("/ui2/nwbc/~canvas;window=")===0&&a.length>this._getWDAUrlShorteningLengthLimit()){this._compactUrl(a).done(function(a){e.url=a;t.resolve(e)}).fail(t.reject)}else{t.resolve(e)}return t.promise()};u.prototype._compactUrl=function(e){var t=e.match(/\?.*/);var a=t&&t[0];var r=this._getWDAUrlShorteningLengthLimit()-200;var n=new jQuery.Deferred;if(a&&a.length<r){return n.resolve(e).promise()}var s=i.parseParameters(t[0]);sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(t){t.compactParams(s,p,undefined).done(function(t){var a=e.match(/^[^?]*/)[0]+"?"+i.paramsToString(t);n.resolve(a)}).fail(n.reject)}).catch(n.reject);return n.promise()};u.prototype._getWDAUrlShorteningLengthLimit=function(){var e=r.getParameterValueBoolean("sap-ushell-nowdaurlshortening");if(e){return 6e6}return this._wdLengthLimit};u.prototype.resolveSystemAlias=function(e){var t,a=new jQuery.Deferred,r=this,i;i=this._readSystemAliasFromBuffer(e);if(i){n.debug("System alias '"+e+"' was already buffered","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");window.setTimeout(function(){a.resolve(i)},0)}else{n.debug("System alias '"+e+"' is not in buffer","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");var s=function(){i=r._readSystemAliasFromBuffer(e);if(i){n.debug("System alias '"+e+"' is now in buffer","Skipping INTEROP service call","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");a.resolve(i)}else{n.debug("System alias '"+e+"' still not in buffer","Resolving via INTEROP service","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");r._readSystemAliasViaInterop(e).fail(function(e){a.reject(e)}).done(function(e){i=r._fixSystemAlias(e);if(i&&i.id){r._writeSystemAliasToBuffer(i);a.resolve(i)}else{t="Data returned for system alias is not valid";n.warning("ClientSideTargetResolutionAdapter: "+t);a.reject(t)}})}};this._oInitialSegmentPromise.then(s,s)}return a.promise()};u.prototype._writeUserSystemAliasesToBuffer=function(e){var a=this;if(typeof e==="undefined"){return}if(t(e)){Object.keys(e).forEach(function(t){a._writeSystemAliasToBuffer(a._fixSystemAlias(e[t]))});return}e.forEach(function(e){a._writeSystemAliasToBuffer(a._fixSystemAlias(e))})};u.prototype._readSystemAliasFromBuffer=function(e){var t=this._oSystemAliasBuffer.get(e);if(e===""){if(!t){return this._oLocalSystemAlias}t.properties=a({},this._oLocalSystemAlias.properties,t.properties||{})}return t};u.prototype._writeSystemAliasToBuffer=function(e){if(e&&e.id){this._oSystemAliasBuffer.put(e.id,e)}return e};u.prototype._fixSystemAlias=function(e){e=e||{};delete e.__metadata;var t={};t.id=e.id||"";t.client=e.client||"";t.language=e.language||"";["http","https"].forEach(function(r){if(e.hasOwnProperty(r)){delete e[r].__metadata;if(e[r].id!==""){t[r]=a({id:"",host:"",port:"",pathPrefix:""},e[r])}}});if(e.hasOwnProperty("rfc")&&e.rfc.id){delete e.rfc.__metadata;t.rfc=a({id:"",systemId:"",host:"",service:0,loginGroup:"",sncNameR3:"",sncQoPR3:""},e.rfc)}return t};u.prototype._readSystemAliasViaInterop=function(e){var t=new jQuery.Deferred,a="SystemAliases(id='"+encodeURIComponent(e)+"')?$format=json";this._getODataWrapper().read(a,function(e){t.resolve(e)},function(e){t.reject(e)});return t.promise()};u.prototype.getSystemAliases=function(){return this._oSystemAliasBuffer&&this._oSystemAliasBuffer.entries||{}};u.prototype.getUrlTemplateContext=function(e){var t=this._oURLTemplates[e.urlTemplate.id];if(!t){n.error("No URL template found.");return null}var a={systemAliases:this.getSystemAliases(),urlTemplates:this._oURLTemplates};return{payload:t.payload,site:a,siteAppSection:e}};return u},true);
//# sourceMappingURL=ClientSideTargetResolutionAdapter.js.map
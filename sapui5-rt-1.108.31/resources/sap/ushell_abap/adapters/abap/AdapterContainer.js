// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/ObjectPath","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/core/format/DateFormat","sap/ushell_abap/pbServices/ui2/ODataService"],function(e,t,jQuery,n,r){"use strict";var i="PersContainers",o="yyyyMMddHHmmss",a=new Date(9999,1,1,0,0,0),s=new Date(9999,1,1,0,0,0,0),c="ADMIN#sap-ushell-container-expireUTCTimestamp",u="ADMIN#sap-ushell-container-storageUTCTimestamp",p="ADMIN#sap-ushell-container-scope";function f(e){var n="sap.ushell.personalization#";if(e.substring(0,n.length)!==n){t.error("Unexpected ContainerKey "+e);return e}return e.substring(n.length,n.length+40)}var h=function(t,n,r,i){this._oService=n;this._oScope=r;this["sap-cache-id"]=e.get("_oService._oConfig.services.personalization.cacheId",this);this._sContainerKey=f(t);this._sAppName=i||"";var o=sap.ui.require("sap/ushell_abap/adapters/abap/PersonalizationAdapter");if(o){this._category=o.prototype._determineCategory(r)}this._oJSONContainer={category:this._category,clientExpirationTime:s,appName:this._sAppName,component:"",id:this._sContainerKey,PersContainerItems:[]};this._oPropertyBag={};this._aOperationQueue=[]};h.prototype._reset=function(){this._oJSONContainer.PersContainerItems=[]};h.prototype._obtainODataWrapper=function(){return this._oService._oWrapper};h.prototype.load=function(){var e=new jQuery.Deferred,n=this,o=this._obtainODataWrapper(),a=i+"(category='"+this._category+"',id='"+encodeURIComponent(this._sContainerKey)+"')?$expand=PersContainerItems";if(this._category&&this._category==="P"&&this["sap-cache-id"]){a=a+"&sap-cache-id="+this["sap-cache-id"]}r.call(this,o,function(){return false});o.read(a,function(t){n._oJSONContainer=t;n._oJSONContainer.category=n._category;n._oJSONContainer.id=n._sContainerKey;n._oJSONContainer.appName=n._sAppName;n._oJSONContainer.PersContainerItems=n._oJSONContainer.PersContainerItems&&n._oJSONContainer.PersContainerItems.results||[];e.resolve(n)},function(r){t.warning(r);n._reset();e.resolve(n)});return e.promise()};h.prototype.save=function(){t.debug("[000] save","AdapterContainer");var e=new jQuery.Deferred,n=this,o=this._obtainODataWrapper(),a=i;r.call(this,o,function(){return false});o.create(a,this._oJSONContainer,function(){e.resolve(n)},function(t){e.reject(t)});return e.promise()};h.prototype.del=function(){var e=new jQuery.Deferred,t=this,n=this._obtainODataWrapper(),o=i+"(category='"+this._category+"',id='"+encodeURIComponent(this._sContainerKey)+"')";r.call(this,n,function(){return false});n.del(o,function(n){e.resolve(t)},function(t){e.reject(t)});this._reset();return e.promise()};h.prototype.getItemKeys=function(){var e=[];this._oJSONContainer.PersContainerItems.forEach(function(t){if(t.category==="V"){e.push("VARIANTSET#"+t.id)}else if(t.category==="I"){e.push("ITEM#"+t.id)}});if(this._oJSONContainer.validity>=0){e.push(u);e.push(c);e.push(p)}return e};h.prototype.containsItem=function(e){return this.getItemKeys().indexOf(e)>=0};function l(e){if(e===undefined||e===null){return null}var t=n.getDateInstance({pattern:o});return t.parse(JSON.parse(e),true)}function y(e){var r=n.getDateInstance({pattern:o});if(e===null){e=s}if(typeof e==="string"){if(/\/Date\(([0-9]+)\)\//.exec(e)){e=new Date(parseInt(/\/Date\(([0-9]+)\)\//.exec(e)[1],10))}else{t.error("Expected Date format "+e)}}if(+e===+s){return undefined}return r.format(e,true)}h.prototype._findItemIndex=function(e,t){var n;for(n=0;n<this._oJSONContainer.PersContainerItems.length;n=n+1){if(this._oJSONContainer.PersContainerItems[n].id===e&&this._oJSONContainer.PersContainerItems[n].category===t){return n}}return undefined};h.prototype._locateItem=function(e){var n={index:-1};if(e===c){return{containerProperty:"clientExpirationTime",initialValue:s,convToABAP:l,convFromABAP:y}}if(e===p){return{containerProperty:"validity",initialValue:0,convToABAP:function(e){if(!e){return null}return JSON.parse(e).validity},convFromABAP:function(e,t){if(e<=0){return undefined}t=t||{};t.validity=e;return t}}}if(e===u){return{containerProperty:" ignore",initialValue:a,convToABAP:l,convFromABAP:y}}if(e.indexOf("ITEM#")===0){n.trueItemKey=e.substring("ITEM#".length,"ITEM#".length+40);n.category="I"}else if(e.indexOf("VARIANTSET#")===0){n.trueItemKey=e.substring("VARIANTSET#".length,"VARIANTSET#".length+40);n.category="V"}else if(e.indexOf("ADMIN#")!==0){t.error("Unknown itemkey prefix"+e)}n.index=this._findItemIndex(n.trueItemKey,n.category);return n};h.prototype.getItemValue=function(e){var t="",n,r=this._locateItem(e);if(r.containerProperty===" ignore"){return undefined}if(r.index>=0){t=this._oJSONContainer.PersContainerItems[r.index].value;try{n=JSON.parse(t)}catch(e){if(t==="X"){n=true}else{n=undefined}}}if(r.containerProperty){if(typeof r.convFromABAP==="function"){return r.convFromABAP(this._oJSONContainer[r.containerProperty],n)}return this._oJSONContainer[r.containerProperty]}return n};h.prototype.setItemValue=function(e,t){var n=JSON.stringify(t),r=this._locateItem(e);if(r.containerProperty===" ignore"){return}if(r.containerProperty){if(typeof r.convToABAP==="function"){this._oJSONContainer[r.containerProperty]=r.convToABAP(n)}else{this._oJSONContainer[r.containerProperty]=n}if(!r.trueItemKey){return}}if(r.index>=0){this._oJSONContainer.PersContainerItems[r.index].value=n;return}this._oJSONContainer.PersContainerItems.push({value:n,id:r.trueItemKey,category:r.category,containerId:this._sContainerKey,containerCategory:this._category})};h.prototype.delItem=function(e){var t=this._locateItem(e);if(t.containerProperty===" ignore"){return}if(t.containerProperty){this._oJSONContainer[t.containerProperty]=t.initialValue;return}if(t.index>=0){this._oJSONContainer.PersContainerItems.splice(t.index,1);return}};return h},true);
//# sourceMappingURL=AdapterContainer.js.map
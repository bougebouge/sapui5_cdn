/*
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/FlexAnalysis",["sap/sac/df/types/SystemType","sap/ui/core/Control","sap/base/Log","sap/ui/model/json/JSONModel","jquery.sap.global","sap/sac/df/olap/MultiDimModel","sap/sac/df/firefly/library","sap/sac/df/fa/FlexAnalysisContextMenuProvider"],function(e,t,i,r,jQuery,a,n,s){"use strict";var o="GalaxyDataStudio";var u=t.extend("sap.sac.df.FlexAnalysis",{metadata:{properties:{autoUpdate:{type:"boolean",defaultValue:true},configurationURI:{type:"string"},configObject:{type:"object"},width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},hideDesignPanel:{type:"boolean",defaultValue:true},hideMenuBar:{type:"boolean",defaultValue:true},hideStatusBar:{type:"boolean",defaultValue:true},hideToolBar:{type:"boolean",defaultValue:true},hideFilterLine:{type:"boolean",defaultValue:false},hideSideNavigation:{type:"boolean",defaultValue:false},environment:{type:"string[]",defaultValue:[]},systemName:{type:"string"},dataSource:{type:"string",defaultValue:"$datasource"},systemType:{type:"sap.sac.df.types.SystemType",defaultValue:e.BW},keepAliveInterval:{type:"int",defaultValue:0},clientIdentifier:{type:"string"},dataProvider:{type:"any",bindable:true},multiDimModelId:{type:"string",defaultValue:"om"},implicitVariableHandling:{type:"boolean",defaultValue:true,bindable:false}},events:{},aggregations:{customPanels:{type:"sap.sac.df.FlexAnalysisPanel",multiple:true}},defaultAggregation:"customPanels"},init:function(){var e=this.getId()+"--program";this.programContainer=jQuery('<div id="'+e+'"/>');this.contextMenuProvider=new s(this)},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);e.style("flex","auto");e.style("width",t.getWidth());e.style("height",t.getHeight());e.openEnd();e.close("div")}},onAfterRendering:function(){if(t.prototype.onAfterRendering){t.prototype.onAfterRendering.apply(this,arguments)}var e=this.$();this.programContainer.appendTo(e);if(!this.isProgramRunning){this.runProgram()}e.css("position","relative")},updateProgramSettings:function(){var e=this.program.getProcess().getApplication();e.setClientInfo(null,this.getClientIdentifier(),null);this.program.getActiveDocument().setAutoUpdatesEnabled(this.getAutoUpdate());this.program.getActiveDocument().setFilterLineVisible(!this.getHideFilterLine());this.program.getActiveDocument().setDesignerPanelVisible(!this.getHideDesignPanel());this.program.setShowToolbar(!this.getHideToolBar());this.program.registerDynamicMenuActionsProvider("UI5ContextMenuProvider",this.contextMenuProvider);this.program.getActiveDocument().setSideNavigationVisible(!this.getHideSideNavigation())},registerCustomPanels:function(){var e=this.getCustomPanels();e.forEach(function(e){this.program.registerCustomPanel(e)}.bind(this))},onUiStateChange:function(e){var t=n.PrSerializerFactory.newSerializer(false,false,0);var i=t.serialize(e);var r=JSON.parse(i);if(r){var a=r[n.AuGdsQbConstants.QD_UI_STATE_OPEN_PANELS];if(a){this.setProperty("hideDesignPanel",a.indexOf(n.AuGdsPanelType.DESIGNER.getName())===-1)}}},registerUiStateChange:function(){var e=this.program.getActiveDocument();if(e&&e.addUiStateChangeCallback){e.addUiStateChangeCallback(this.onUiStateChange.bind(this))}},runProgram:function(){this.isProgramRunning=true;return this._initSacTable().then(this._initModel.bind(this)).then(this._initQuery.bind(this)).then(function(){var e=this.getMultiDimModelId();var t=this.getParent().getModel(e);this.programInstance=n.ProgramRunner.createRunner(t.getSession(),o);this._setClientArgs();this._setClientEnvironment(this.programInstance);this.programInstance.setNativeAnchorId(this.getId()+"--program");var r=this.dataProvider.getQueryManager();if(r){this.programInstance.setObjectArgument("queryManager",r)}else{i.error("The dataProvider '"+this.dataProvider+"' in the model '"+this.getModelId()+"' doesn't have a query manager")}return this._processConfigURI().then(function(){this.programInstance.runProgram().then(function(e){this.program=e;this.updateProgramSettings();this.registerCustomPanels();this.registerUiStateChange()}.bind(this)).onCatch(function(e){throw new Error(e)})}.bind(this))}.bind(this))},exit:function(){if(this.programInstance){this._cleanUpProgram()}},getProgram:function(){return this.program},setPanelVisible:function(e,t){if(this.program){var i=this.program.getActiveDocument();if(i&&i.setPanelVisible){var r=n.AuGdsPanelType.lookup(e);if(r){i.setPanelVisible(r,t)}else{throw new Error("Cannot resolve panel type to adjust visibility!")}}}},setDataProvider:function(e){var t=this;t.setProperty("dataProvider",e);if(t.program){t._initQuery().then(function(){t.program.getActiveDocument().setExternalQueryManager(t.dataProvider.getQueryManager())})}},addContextMenuAction:function(e,t){this.contextMenuProvider.registerAction(e,t)},setDataSource:function(e){var t=this;if(e&&e.startsWith("$")){e=this.getUrlParams("datasource")}t.setProperty("dataSource",e);t.setProperty("dataProvider",undefined);if(t.program){t._initQuery().then(function(){t.program.getActiveDocument().setExternalQueryManager(t.dataProvider.getQueryManager())})}},setHideFilterLine:function(e){this.setProperty("hideFilterLine",e);if(this.program){this.program.getActiveDocument().setFilterLineVisible(!e)}},setAutoUpdate:function(e){this.setProperty("autoUpdate",e);if(this.program){this.program.getActiveDocument().setAutoUpdatesEnabled(e)}},setHideToolBar:function(e){this.setProperty("hideToolBar",e);if(this.program){this.program.setShowToolbar(!e)}},setHideSideNavigation:function(e){this.setProperty("hideSideNavigation",e);if(this.program){this.program.getActiveDocument().setSideNavigationVisible(!e)}},setHideDesignPanel:function(e){this.setProperty("hideDesignPanel",e);if(this.program){this.program.getActiveDocument().setDesignerPanelVisible(!e)}},_cleanUpProgram:function(){n.XObjectExt.release(this.programInstance);this.programInstance.releaseObject();this.programInstance=null;this.isProgramRunning=false},_initSacTable:function(){return Promise.resolve().then(function(){window.sactable=window.SACGridRendering})},_initModel:function(){var e=this;return Promise.resolve().then(function(){var t=e.getMultiDimModelId();var i=e.getParent().getModel(t);if(!i){var r={masterSystem:e._getSystemName(),systemType:e.getSystemType(),keepAliveInterval:e.getKeepAliveInterval()||-1};i=new a(r);e.getParent().setModel(i,t)}i.attachEvent("queryAdded",null,function(e){var t=e.getParameter("dataProviderName");if(this.dataProvider&&this.dataProvider.Name===t){this.dataProvider=i.getDataProvider(t);this.program.getActiveDocument().getQueryController().initWithExistingQueryManager(this.dataProvider.getQueryManager())}},e);return i.loaded()})},_parseDataSource:function(){var t=n.QFactory.createDataSource();var i=this.getDataSource();if(i.indexOf(":[")>0){t.setFullQualifiedName(i)}else{t.setObjectName(i);t.setType(this.getSystemType()===e.BW?n.MetaObjectType.QUERY:n.MetaObjectType.DBVIEW)}return t},_initQuery:function(){var e=this.getParent().getModel(this.getMultiDimModelId());return Promise.resolve().then(function(){if(this.getDataProvider()){var t=this.getDataProvider();this.dataProvider=e.getProperty("/DataProvider/"+t);if(!this.dataProvider){throw new Error("Data Provider "+t+" doesn't exist in the model "+e.getId())}}else if(this.getDataSource()){var i=this._parseDataSource();var r=i.getObjectName();this.dataProvider=e.getDataProvider(r);if(this.dataProvider){return}return e.addQuery(r,r,this._getSystemName(),i.getPackageName(),i.getSchemaName(),i.getType()).then(function(e){this.dataProvider=e;this.setProperty("dataProvider",r)}.bind(this))}else{throw new Error("A dataProvider or dataSource must be specified")}}.bind(this))},_setClientArgs:function(){this.programInstance.setArgument(n.AuGdsConstants.GDF_FILE_DOC_TYPE,this.getDocType());this.programInstance.setArgument(n.AuGdsConstants.PARAM_SYSTEM,this._getSystemName());this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_MULTI_DOCUMENTS,false);this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_HIDE_STATUS_BAR,this.getHideStatusBar());this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_HIDE_MENU_BAR,this.getHideMenuBar());this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_HIDE_TOOLBAR,this.getHideToolBar());this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_QUERY_BUILDER_MULTI_VIEWS,false);this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_QUERY_BUILDER_AUTO_OPEN_DATA_SOURCE_PICKER,false);this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_IMPLICIT_VARIABLE_HANDLING,this.getImplicitVariableHandling());this.programInstance.setArgument(n.AuGdsConstants.PARAM_INTEGRATION,"ui5");this.programInstance.setArgument(n.AuGdsConstants.PARAM_MODE,"ga")},isEqualTo:function(){return false},onQueryExecuted:function(){if(this.getParent().getModel(this.getModelId())){this.getParent().getModel(this.getModelId()).fireRequestCompleted({infoObject:this.getDataProvider()})}this.fireQueryExecuted()},getDocType:function(){return"QueryBuilder"},_getSystemName:function(){var e=this.getSystemName();if(e&&e.startsWith("$")){e=this.getUrlParams("system")}return e?e:"local"+this.getSystemType()},_updateSupportedPanelsConfiguration:function(e){var t=this.getCustomPanels();if(t.length){var i=t.map(function(e){return e.getPanelId()}),r="/QueryBuilder/SideNavigation/SupportedPanels",a=e.getProperty(r);if(a){a=a.concat(i)}else{a=i}e.setProperty(r,a)}},_processConfigURI:function(){var e=this.programInstance;return new Promise(function(e){var t=this.getConfigObject();if(t){e(JSON.stringify(t))}else{var i=this.getConfigurationURI();if(!i){i=sap.ui.require.toUrl("sap/sac/df/fa/sap-ui5-config.json")}var a=new r(i);a.attachRequestCompleted(function(t){var i=t.getSource();this._updateSupportedPanelsConfiguration(i);e(JSON.stringify(i.getData()))}.bind(this))}}.bind(this)).then(function(t){if(t){e.setArgument(n.AuGdsConstants.PARAM_CONFIGURATION,t)}})},getUrlParams:function(e){return(window.location.href.split(e+"=")[1]||"").split("&")[0]},_setClientEnvironment:function(e){var t=this.getEnvironment();t.forEach(function(t){var i=t.split("=");e.setEnvironmentVariable(i[0],i[1])}.bind(this))}});return u});
//# sourceMappingURL=FlexAnalysis.js.map
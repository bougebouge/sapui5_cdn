/*!
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/olap/MultiDimDataProvider",["sap/base/Log","sap/ui/core/format/DateFormat","sap/sac/grid/Format","sap/sac/df/types/Axis","sap/sac/grid/CellType","sap/sac/df/types/DimensionType","sap/sac/df/types/DisplayType","sap/sac/df/types/ComparisonOperator","sap/sac/df/utils/SyncActionHelper","sap/sac/df/utils/ListHelper","sap/sac/df/utils/TokenHelper","sap/sac/df/utils/ResultSetHelper","sap/sac/df/utils/ResourceBundle","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library"],function(e,t,r,n,i,a,o,s,u,l,g,c,m,f,p){"use strict";var d=function(e,s,g,d){var D=this;var v;var S=g.getQueryModel();var N;D.OffsetCol=0;D.Messages=[];D.Name=d;D.OffsetRow=0;D.SuppressRepetition=true;D.Variables={};var T={};var h=r.ExcelStyle;g.attachQueryExecutedListener({onQueryExecuted:function(t,r){if(t.hasErrors()){D._addMessagesToModel(t);e.fireRequestFailed({})}else{s.getSession().notifyInterruptStep(p.XInterruptStep.create(),true);N=r.getClassicResultSet();var n=function(){var t=p.FioriGridFactory.createFioriGrid(N);if(D.getSuppressedUnit()){t.setSuppressUnit(D.getSuppressedUnit())}f.map(e.getSemanticStyles(),function(e,r){t.addSemanticStyle(r,e)});return t.exportToFireflyGrid(D.SuppressRepetition)}();D.ClassicGrid=p.ReferenceGridFactory.createReferenceGridSimple(N).exportToAscii(50);D.Grid=n.convertToNative();D.Grid.format=h;D.Grid.virtualOffsetCol=D.virtualOffsetCol;D.Grid.virtualOffsetRow=D.virtualOffsetRow;if(!D.Grid.Cells||D.Grid.Cells.length===0){D.Grid.Cells=[{Column:0,Row:0,DisplayValue:m.getText("no_data"),CellType:i.EMPTY}]}D.Grid.fixedRows=n.getIntegerByKey("FixedRows");D.Grid.fixedColumns=n.getIntegerByKey("FixedColumns");var a=N.getAxis(p.AxisType.ROWS).getTuplesCountTotal();if(a===-1){a=N.getAxis(p.AxisType.ROWS).getTuplesCount()}D.Grid.virtualRows=a;a=N.getAxis(p.AxisType.COLUMNS).getTuplesCountTotal();if(a===-1){a=N.getAxis(p.AxisType.COLUMNS).getTuplesCount()}D.Grid.virtualColumns=a;b(c.flatten(N,D));D._addMessagesToModel(N);e.checkUpdate();e.fireRequestCompleted({infoObject:D.Name})}},isEqualTo:function(e){return this===e}});D.setFormat=function(t){h=t;if(D.Grid){D.Grid.format=h}e.checkUpdate()};D.setOffsetCol=function(e){D.virtualOffsetCol=e;return D};D.setOffsetRow=function(e){D.virtualOffsetRow=e;return D};D.getStructureMembers=function(e){var t=S.getDimensionByName(D.Dimensions[e].TechName);var r=t.getDisplayKeyField();var n=f.reduce(D.getFilterOfDim(e),function(e,t){e[t.Low]=true;return e},{});return f.map(l.arrayFromList(t.getAllStructureMembers()),function(e){return{Name:e.getFieldValue(r)?e.getFieldValue(r).getValue().getString():e.getName(),TechName:e.getName(),Description:e.getText(),isInFilter:!!n[e.getName()]}})};b();(function(){var e=null;D.suppressUnit=function(t){e=t};D.getSuppressedUnit=function(){return e}})();D.openCellDialog=function(e,t,r,n){var i=D.Dimensions[e];if(!i||!i.IsStructure){throw new Error("Dimension is not a structure:"+e)}var a=S.getDimensionByName(i.TechName).getDisplayKeyField();var o=f.find(l.arrayFromList(g.getQueryModel().getDimensionByName(D.Dimensions[e].TechName).getAllStructureMembers()),function(e){var r=e.getFieldValue(a);var n=r?r.getString():e.getName();return n===t});if(!o){throw new Error("Member "+t+" not found in structure: "+e)}var s;if(r){var u=D.Dimensions[r];if(!u||!u.IsStructure){throw new Error("Dimension is not a structure:"+r)}var c=S.getDimensionByName(D.Dimensions[r].TechName).getDisplayKeyField();s=f.find(l.arrayFromList(g.getQueryModel().getDimensionByName(D.Dimensions[r].TechName).getAllStructureMembers()),function(e){var t=e.getFieldValue(c);var r=t?t.getString():e.getName();return r===n});if(!s){throw new Error("Member "+n+" not found in structure: "+r)}}var d;function y(e){d=e}var v=new Promise(y);var N=p.DataCellDialogDragonflyEntryPoint.createEntryPoint(g);N.setI18nProvider(m,null);N.openDataCellPropertiesDialog({onDataCellOk:function(){var e=d;d=null;return e(true)},onDataCellClose:function(){if(d){d(false)}N.close()}},g,o.getName(),s?s.getName():null);return v};D.openDimDialog=function(e){return new Promise(function(t){var r=p.ProgramRunner.createRunner(s.getProcess(),p.OuDimensionDialog2.DEFAULT_PROGRAM_NAME);r.setObjectArgument(p.DfOuDialogProgram.PARAM_QUERY_MANAGER,g);r.setArgument(p.OuDimensionDialog2.PARAM_DIMENSION_NAME,D.Dimensions[e].TechName);r.setObjectArgument(p.DfOuDialogProgram.PARAM_OK_PROCEDURE,{execute:function(){t(true)}});r.setObjectArgument(p.DfOuDialogProgram.PARAM_CANCEL_PROCEDURE,{execute:function(){t(false)}});return r.runProgram(null)})};D.setResultVisibility=function(e,t){S.getDimensionByName(D.Dimensions[e].TechName).setResultVisibility(p.ResultVisibility[t]);return D.getResultSet()};D.setDimensionDisplay=function(e,t){var r=S.getDimensionByName(D.Dimensions[e].TechName);var n=r.getDisplayKeyField()||r.getKeyField();var i=r.getTextField();var a=r.getResultSetFields();var s=f.filter(l.arrayFromList(a).map(function(e){return e}),function(e){return e!==r.getKeyField()&&e!==r.getTextField()&&e!==r.getDisplayKeyField()});a.clear();switch(t){case o.Key:a.add(n);break;case o.Text:a.add(i);break;case o.KeyText:a.add(n);a.add(i);break;case o.TextKey:a.add(i);a.add(n);break}f.forEach(s,function(e){a.add(e)});return D.getResultSet()};D.isVariableInputEnabled=function(e){var t=T[e];if(!t){return false}var r=S.getVariable(t);return!!r&&r.isInputEnabled&&r.isInputEnabled()};D.hasVariableValueHelp=function(e){var t=S.getVariable(e);return!!t&&t.supportsValueHelp&&t.supportsValueHelp()};function M(e,t,r){if(t!=null&&r!=null){e.addSupplementValue(t.getName(),r)}}function C(e,t,r){var n=e.getKeyField();var i=e.getDisplayKeyField()!==n?e.getDisplayKeyField():null;var a=e.getTextField();t.addSupplementField(i);t.addSupplementField(a);for(var o=0;o<r.size();o++){var s=r.get(o);var u=t.addNewCartesianElement();u.setComparisonOperator(p.ComparisonOperator.EQUAL);u.setField(n);var l=u.getLow();l.setValue(p.XValueUtil.getValueFromString(s.getKey(),n.getValueType()));M(l,i,s.getDisplayKey());M(l,a,s.getText())}}function E(e){var t=T[e];if(!t){return false}return S.getVariable(t)}D.applySelectionToVariable=function(e,t){var r=function(e){if(!e){return}if(e.getVariableType().isTypeOf(p.VariableType.DIMENSION_MEMBER_VARIABLE)){var r=e.getDimension();var n=e.getMemberFilter();n.clear();C(r,n,t)}else{if(!t.isEmpty()){e.setValueByStringExt(t.get(0).getKey(),true)}}};return new Promise(function(t,r){var n=E(e);if(!n||!n.isInputEnabled()){t(null)}if(n&&n.isInputEnabled()){if(g.isReinitNeeded()){g.reInitVariablesAfterSubmit(p.SyncType.NON_BLOCKING,function(e){return e.hasErrors()?r(u.reject(e.getErrors())):t(n)})}else{t(n)}}else{r(new Error("Variable is not input enabled"))}}).then(r)};D.openVariableSelector=function(e){var t=E(e);if(!(t&&t.supportsValueHelp&&t.supportsValueHelp())){throw new Error("No Value help for variable "+e)}if(g.isReinitNeeded()){g.reInitVariablesAfterSubmit(p.SyncType.BLOCKING,null,null)}var r=p.FdEntryPoint.createEntryPoint(s,m.getText("SELECTOR",[t.getText()]));r.setI18nProvider(m,null);var n=r.getConfiguration();n.setAlwaysShowSelectionContainer(true);n.setMultiSelection(t.supportsMultipleValues());n.setDetermineSelectionFromContext(true);var i;function a(e){i=e}r.openWithVariable(t,{onFilterDialogOk:function(e){i(e)},onFilterDialogCancel:function(){i(null)}});var o=new Promise(a);return o.then(function(e){if(!e){return false}return e}).then(function(t){if(t){return D.applySelectionToVariable(e,t).then(function(){w();return t})}return t})};D.openCurrencyTranslationDialog=function(){return new Promise(function(e){var t=p.ProgramRunner.createRunner(s.getProcess(),p.OuCurrencyConversionDialog.DEFAULT_PROGRAM_NAME);t.setObjectArgument(p.DfOuDialogProgram.PARAM_QUERY_MANAGER,g);t.setObjectArgument(p.DfOuDialogProgram.PARAM_OK_PROCEDURE,{execute:function(){e(true)}});t.setObjectArgument(p.DfOuDialogProgram.PARAM_CANCEL_PROCEDURE,{execute:function(){e(false)}});return t.runProgram(null)})};D.getFilterOfDim=function(e){var t=S.getDimensionByName(D.Dimensions[e].TechName);function r(e){var r=t.getKeyField();var n=t.getDisplayKeyField()!==r?t.getDisplayKeyField():null;var i=t.getTextField();var a=e.getLow();var o=null;if(n!=null){o=a.getSupplementValueString(n.getName())}if(!o&&i){o=a.getSupplementValueString(i.getName())}return o}return f.map(l.arrayFromList(S.getFilter().getDynamicFilter().getCartesianListByField(t.getKeyField())),function(e){return{ComparisonOperator:y(e.getComparisonOperator()),Text:r(e),Low:e.getLow().getString(),High:e.getHigh().getString(),IsExcluding:e.getSetSign()===p.SetSign.EXCLUDING}})};D.openSelector=function(e){var t=S.getDimensionByName(D.Dimensions[e].TechName);if(!S.getFilter().getDynamicFilter().isCartesianProduct()){throw new Error("Filter to complex")}var r;function n(e){r=e}return Promise.resolve(null).then(function(){var e=p.FdEntryPoint.createEntryPoint(s,m.getText("SELECTOR",[t.getText()]));var i=e.getConfiguration();i.setMultiSelection(true);i.setDetermineSelectionFromContext(true);e.setI18nProvider(m,null);e.openWithDimension(t,{onFilterDialogOk:function(e){r(e)},onFilterDialogCancel:function(){r(false)}});var a=new Promise(n);return a.then(function(e){if(!e){return false}var r=t.getFilter();if(r!=null){r.clear()}else{var n=t.getQueryModel().getFilter().getDynamicFilter();r=n.getCartesianListWithDefault(t)}C(t,r,e);return true})})};D.setAxesLayout=function(e){f.forEach(f.map(D.Dimensions,"Name"),function(e){S.getAxis(p.AxisType.FREE).add(S.getDimensionByName(D.Dimensions[e].TechName))});f.forEach(e.rows,function(e){A(p.AxisType.ROWS,e,false)});f.forEach(e.columns,function(e){A(p.AxisType.COLUMNS,e,false)});return D};D.removeDrilldown=function(e){S.getAxis(p.AxisType.FREE).add(S.getDimensionByName(D.Dimensions[e].TechName));I();return D.getResultSet()};D.drilldown=function(e,t){var r=S;if(e){var n=r.getDimensionByName(D.Dimensions[e].TechName);var i=r.getAxesManager().getRowsAxis().getDimensionCount()?n.getAxis():r.getAxesManager().getRowsAxis();var a=!i.getDimensionCount()?0:n.getDimension().getAxis().getDimensionIndex(n.getName())+1;i.insert(a,r.getDimensionByName(D.Dimensions[t].TechName))}else{r.getAxesManager().getRowsAxis().insert(r.getAxesManager().getRowsAxis().getDimensionCount(),r.getDimensionByName(D.Dimensions[t].TechName))}I();return D.getResultSet()};D.moveUp=function(e){var t=S;var r=t.getDimensionByName(D.Dimensions[e].TechName);var n=r.getAxis();var i=n.getDimensionIndex(r.getName())-1;n.insert(i,r);I();return D};D.moveDown=function(e){var t=S;var r=t.getDimensionByName(D.Dimensions[e].TechName);var n=r.getAxis();var i=n.getDimensionIndex(r.getName())+1;n.insert(i,r);I();return D};D.setDisplayHierarchy=function(e,t,r,n){var i=S;var a=i.getDimensionByName(D.Dimensions[e].TechName);if(r){a.setHierarchyName(r);if(n){a.setHierarchyVersion(n)}}a.setHierarchyActive(t);I();return D};D.getScalingFactor=function(e,t){var r=D.Dimensions.MeasureStructure;if(!r){throw new Error("No measure Structure")}var n=t?D.Dimensions.NonMeasureStructure:null;var i=r.TechName;var a=l.arrayFromList(S.getDimensionByName(i).getAllStructureMembers());var o=S.getDimensionByName(i).getDisplayKeyField();var s=function(){var t=f.find(a,function(t){var r=t.getFieldValue(o);var n=r?r.getString():t.getName();return n===e});if(!t){throw new Error("Member "+e+" not found in structure: "+i)}return t}();if(!n){return s.getNumericShift()?-1*s.getNumericShift().getInteger():0}else{var u=n.TechName;var c=l.arrayFromList(S.getDimensionByName(u).getAllStructureMembers());var m=S.getDimensionByName(u).getDisplayKeyField();var p=function(){var r=f.find(c,function(e){var r=e.getFieldValue(m);var n=r?r.getString():e.getName();return n===t});if(!r){throw new Error("Member "+e+" not found in structure: "+i)}return r}();var d=l.arrayFromIter(g.getQueryModel().getQueryDataCells().getIterator());var y=f.find(d,function(e){return e.hasMemberReference(s)&&e.hasMemberReference(p)});if(!y){throw new Error("Invalid Query Cell")}return y.getScalingFactor()}};D.setScalingFactor=function(e,t,r){var n=D.Dimensions.MeasureStructure;if(!n){throw new Error("No measure Structure")}var i=r?D.Dimensions.NonMeasureStructure:null;var a=n.TechName;var o=l.arrayFromList(S.getDimensionByName(a).getAllStructureMembers());var s=S.getDimensionByName(a).getDisplayKeyField();var u=function(){var e=f.find(o,function(e){var r=e.getFieldValue(s);var n=r?r.getString():e.getName();return n===t});if(!e){throw new Error("Member "+t+" not found in structure: "+a)}return e}();if(!i){u.setNumericShift(-1*e);return D}else{var c=i.TechName;var m=l.arrayFromList(S.getDimensionByName(c).getAllStructureMembers());s=S.getDimensionByName(c).getDisplayKeyField();var p=function(){var e=f.find(m,function(e){var t=e.getFieldValue(s);var n=t?t.getString():e.getName();return n===r});if(!e){throw new Error("Member "+r+" not found in structure: "+c)}return e}();var d=l.arrayFromIter(g.getQueryModel().getQueryDataCells().getIterator());d=f.filter(d,function(e){return e.hasMemberReference(u)&&e.hasMemberReference(p)});if(!d||d.length<1){throw new Error("Invalid Query Cell")}return f.forEach(d,function(t){t.setScalingFactor(e)})}};D.setDecimalPlaces=function(e,t,r){var n=D.Dimensions.MeasureStructure;if(!n){throw new Error("No measure Structure")}var i=r?D.Dimensions.NonMeasureStructure:null;var a=n.TechName;var o=l.arrayFromList(S.getDimensionByName(a).getAllStructureMembers());var s=S.getDimensionByName(a).getDisplayKeyField();var u=function(){var e=f.find(o,function(e){var r=e.getFieldValue(s);var n=r?r.getString():e.getName();return n===t});if(!e){throw new Error("Member "+t+" not found in structure: "+a)}return e}();if(!i){u.setNumericScale(e);return D}else{var c=i.TechName;var m=l.arrayFromList(S.getDimensionByName(c).getAllStructureMembers());s=S.getDimensionByName(c).getDisplayKeyField();var p=function(){var e=f.find(m,function(e){var t=e.getFieldValue(s);var n=t?t.getString():e.getName();return n===r});if(!e){throw new Error("Member "+r+" not found in structure: "+c)}return e}();var d=l.arrayFromIter(g.getQueryModel().getQueryDataCells().getIterator());d=f.filter(d,function(e){return e.hasMemberReference(u)&&e.hasMemberReference(p)});if(!d||d.length<1){throw new Error("Invalid Query Cell")}return f.forEach(d,function(t){t.setDecimalPlaces(e)})}};D.getDecimalPlaces=function(e,t){var r=D.Dimensions.MeasureStructure;if(!r){throw new Error("No measure Structure")}var n=t?D.Dimensions.NonMeasureStructure:null;var i=r.TechName;var a=l.arrayFromList(S.getDimensionByName(i).getAllStructureMembers());var o=S.getDimensionByName(i).getDisplayKeyField();var s=function(){var t=f.find(a,function(t){var r=t.getFieldValue(o);var n=r?r.getString():t.getName();return n===e});if(!t){throw new Error("Member "+e+" not found in measureDim: "+i)}return t}();if(!n){return s.getNumericScale()}else{var u=n.TechName;var c=l.arrayFromList(S.getDimensionByName(u).getAllStructureMembers());var m=S.getDimensionByName(u).getDisplayKeyField();var p=function(){var e=f.find(c,function(e){var r=e.getFieldValue(m);var n=r?r.getString():e.getName();return n===t});if(!e){throw new Error("Member "+t+" not found in measureDim: "+u)}return e}();var d=l.arrayFromIter(g.getQueryModel().getQueryDataCells().getIterator());var y=f.find(d,function(e){return e.hasMemberReference(s)&&e.hasMemberReference(p)});if(!y){throw new Error("Invalid Query Cell")}return y.getDecimalPlaces()}};D.setFilter=function(e,t){var r=D.Dimensions[e];var n=[];if(typeof t==="string"){n.push(t)}else{n=t}p.QFilterUtil.clearSelectionsInContainerByDimension(D.Dimensions[e].TechName,S.getFilter().getDynamicFilter());var i=D.Dimensions[e].TechName;var a=S.getDimensionByName(i);var o=r.IsStructure?l.arrayFromList(a.getAllStructureMembers()):[];var s=r.IsStructure?a.getDisplayKeyField():null;f.forEach(n,function(e){var t=r.IsStructure?function(){var t=f.find(o,function(t){var r=t.getFieldValue(s);var n=r?r.getString():t.getName();return n===e});if(!t){throw new Error("Member "+e+" not found in structure: "+i)}return t.getName()}():e;S.getFilter().getDynamicFilter().addSingleMemberFilterByName(i,t,p.ComparisonOperator.EQUAL)});I();return D};D.removeFilter=function(e){p.QFilterUtil.clearSelectionsInContainerByDimension(D.Dimensions[e].TechName,S.getFilter().getDynamicFilter());I();return D};D.sort=function(e,t,r,n){var i=S.getDimensionByName(D.Dimensions[e].TechName);if(D.Dimensions[e].IsStructure){var a=g.getConvenienceCommands();a.clearSort(null,null);a.sortByMeasure(f.find(D.Dimensions[e].Members,function(e){return e.Name===n}).TechName,p.XSortDirection[t])}else{i.getResultSetSorting().setDirection(p.XSortDirection[t]);if(r){i.getResultSetSorting().setSortType(p.SortType[r])}}return D};function A(e,t,r){var n=r===undefined||r;var i=S;var a=D.Dimensions[t].TechName;var o=i.getQueryModel().getDimensionByName(a);i.getAxis(e).add(o);var s=c.getFields(o);var u=o.getResultSetFields();var l=s.oTextField;if(l&&!u.contains(l)){u.add(l);l.setObtainability(p.ObtainabilityType.USER_INTERFACE)}var g=s.oDisplayKeyField;if(!u.contains(g)){u.add(g);g.setObtainability(p.ObtainabilityType.USER_INTERFACE)}if(n){I()}}D.toRows=function(e){A(p.AxisType.ROWS,e);return D};D.toColumns=function(e){A(p.AxisType.COLUMNS,e);return D};D.drill=function(e,t,r){var n=S.getDimensionByName(D.Dimensions[e].TechName);var i=N.getAxis(n.getAxisType()).getTupleAt(t).getTupleElementByDimension(n);i.setNextDrillState(i.getDrillState()!==p.DrillState.COLLAPSED?p.DrillState.COLLAPSED:p.DrillState.EXPANDED);return D.getResultSet(r)};D.submitVariables=function(){return u.syncActionToPromise(g.submitVariables,g,[]).then(function(t){b();if(t&&t.getMessages().length){e.addMessages(l.arrayFromList(t.getMessages()).map(function(e){var t=e.getSeverity().getName();if(t==="Info"){t="Information"}return{Text:e.getText(),Severity:t,Code:e.getCode(),MessageClass:e.getMessageClass(),LongTextUri:e.getMessageClass()?["/sap/opu/odata/iwbep/message_text;o=LOCAL/T100_longtexts(MSGID='",encodeURIComponent(e.getMessageClass()),"',MSGNO='",encodeURIComponent(e.getCode()),",',MESSAGE_V1='',MESSAGE_V2='',MESSAGE_V3='',MESSAGE_V4='')/$value"].join(""):null}}))}}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);if(!t.getMessages){throw t}D.Grid=null})};D.getResultSet=function(t){if(!t){D.setOffsetCol(0);D.setOffsetRow(0)}if(g.hasChangedCells()){g.transferNewValues()}g.setOffsetColumns(D.virtualOffsetCol);g.setOffsetRows(D.virtualOffsetRow);g.setMaxRows(e.getLimit().RowLimit);g.setMaxColumns(e.getLimit().ColLimit);return F().then(function(){return e.propagateVariableGroupValues(D.Name)}).then(function(){e.fireRequestSent({infoObject:D.Name});return u.syncActionToPromise(g.processQueryExecution,g,[]).then(function(){return D}).catch(function(t){if(!t.getMessages){throw t}e.fireRequestFailed({infoObject:D.Name});return D})})};D.getRRITargets=function(e,t){var r=g.getRriTargetManager();if(!r){return Promise.resolve([])}r.setResultSetContext(e,t);var n,i;function a(e,t){n=e;i=t}r.processRriTargetResolution(p.SyncType.NON_BLOCKING,{onRriTargetResolution:function(e){if(e.hasErrors()){i(e.getMessages())}else{var t=sap.ushell?sap.ushell.Container.getService("URLParsing"):{isIntentUrl:f.constant(false)};n(f.filter(e.getData().getListFromImplementation().map(function(e){return e.getParameters().getMapFromImplementation()}),function(e){return t.isIntentUrl(e.URL)||!!e.URL.match(/#/)}).map(function(e){e.URL=e.URL.split("#")[1];return e}))}}});return new Promise(a)};D.synchronize=function(t){e.clearMessages();return D.getResultSet(t)};D.getColumnSelection=function(e){return c.tupleToObject(N.getColumnsAxis().getTupleAt(e))};D.getRowSelection=function(e){return c.tupleToObject(N.getRowsAxis().getTupleAt(e))};D.getSelection=function(e,t){return f.assign(e>=0&&e<N.getRowsAxis().getTuplesCount()?c.tupleToObject(N.getRowsAxis().getTupleAt(e)):{},t>=0&&t<N.getColumnsAxis().getTuplesCount()?c.tupleToObject(N.getColumnsAxis().getTupleAt(t)):{})};D.readHierarchy=function(e,t){var r=g.getValueHelpProvider();var n=S.getDimensionByName(D.Dimensions[e].TechName);var i=n.getInitialDrillLevel();n.setSelectorInitialDrillLevel(t);var a=new Promise(function(e,t){r.processValueHelp(n,p.SyncType.NON_BLOCKING,{onValuehelpExecuted:function(r){return r.hasErrors()?t(u.reject(r.getErrors())):e(r.getData())}},null,null)});return a.then(function(e){function t(e){if(!e){return{}}var r=e.getChildren();return{Name:e.getName(),Text:e.getDimensionMember().getText()||e.getDimensionMember(e.getDimension().getHierarchyDisplayKeyField()).getValue().getString(),hierNodes:r?f.map(r.getListFromImplementation(),t):null}}n.setSelectorInitialDrillLevel(i);var r=f.filter(e.getListFromImplementation(),function(e){return!e.getParentNode()});return r.length===1?t(r[0]):{Name:"$Root",Text:m.getText("ARTIFICIAL_ROOT"),hierNodes:f.map(r,t)}})};function F(){if(v){return v}v=new Promise(function(e,t){g.reInitVariablesAfterSubmit(p.SyncType.NON_BLOCKING,{onVariableProcessorExecuted:function(r){return r.hasErrors()?t(u.reject(r.getErrors())):e()}})});return v.then(function(){v=null})}D.setVariableValue=function(e,t){var r=E(e);if(!r&&!r.isInputEnabled()){return Promise.reject(new Error("Variable is not input enabled"))}return F().then(function(){return new Promise(function(e){r.clear();if(t){var n=r.getMemberFilter?r.getMemberFilter():null;f.forEach(t,function(e){if(n){var t=n.addNewCartesianElement();var i=p.XValueAccess.createWithType(r.getValueType());i.parseString(e.Low);t.getLow().setValue(i.getValue());if(e.High){i=p.XValueAccess.createWithType(r.getValueType());i.parseString(e.High);t.getHigh().setValue(i.getValue())}t.setComparisonOperator(p.ComparisonOperator[e.Comparison]);var a=p.SetSign[e.IsExcluding]||p.SetSign[e.IsExcluding?"EXCLUDING":"INCLUDING"];t.setSetSign(a);var o=r.getDimension().getFirstFieldByType(p.PresentationType.KEY_NOT_COMPOUND);o=o||r.getDimension().getKeyField(p.PresentationType.KEY);if(o){t.setField(o)}}else{r.setValueByStringExt(e.Low,true)}})}w();e()})})};function x(e,t,r){var n=e.getDimensionMember();var i={Key:n.getName(),Text:n.getText()};if(t){var a=e.getChildren();if(a&&a.hasElements()){var o=l.arrayFromList(a).map(function(e){return x(e,t,r)}).filter(function(e){return e!==null});if(o.length!==0){i.Children=o}}}if(r&&!i.Children){if(i.Key!==r&&i.Text!==r){return null}}return i}D.searchVariableValues=function(e,t,r,n,i){if(n===undefined){n=true}if(i===undefined){i=true}var a=E(e);if(!a){return Promise.reject(new Error("Variable "+e+" is not known"))}var o=p.XList.create();var s=p.XList.create();var u=a.getDimension();var l=u.getTextField();if(l){s.add(l);if(n){o.add(l)}}if(u.getDisplayKeyField()&&i){o.add(u.getDisplayKeyField())}return F().then(function(){return new Promise(function(e,n){p.OlapUiValueHelpVariable.create(a).processSearch(t,o,s,20,true,p.OlapUiReadMode.BOOKED,{onValuehelpExecuted:function(i){if(i.hasErrors()){n(R(i))}else{var o=a.getVariableType();var s=o!=null&&o.isTypeOf(p.VariableType.HIERARCHY_NODE_VARIABLE)?a.getHierarchyName():null;var u=i.getData().getIterator();var l=[];while(u.hasNext()){var g=u.next();if(!s||g.getDisplayLevel()===0){var c=x(g,s,!r?t:null);if(c){l.push(c)}}}e(l)}}})})})};function R(e){return l.arrayFromList(e.getMessages()).map(function(e){var t=e.getSeverity().getName();if(t==="Info"){t="Information"}return{Text:e.getText(),Severity:t,Code:e.getCode(),MessageClass:e.getMessageClass(),LongTextUri:e.getMessageClass()?["/sap/opu/odata/iwbep/message_text;o=LOCAL/T100_longtexts(MSGID='",encodeURIComponent(e.getMessageClass()),"',MSGNO='",encodeURIComponent(e.getCode()),",',MESSAGE_V1='',MESSAGE_V2='',MESSAGE_V3='',MESSAGE_V4='')/$value"].join(""):null}})}D._addMessagesToModel=function(t){if(t&&t.getMessages().length){e.addMessages(R(t))}};D.createDocumentId=function(t,r){var n=g.getResultsetContainer().getDocumentIdManager();var i=p.RsCellIndexInfo.create();i.initialize(t,r);return u.syncActionToPromise(n.createCellDocumentId,n,i).then(function(e){D._addMessagesToModel(e);return e.getData().getCellDocumentId()}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);return Promise.reject(t)})};D.getDocumentId=function(t,r){var n=g.getResultsetContainer().getDocumentIdManager();var i=p.RsCellIndexInfo.create();i.initialize(t,r);return u.syncActionToPromise(n.getCellDocumentId,n,i).then(function(e){D._addMessagesToModel(e);return e.getData().getCellDocumentId()}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);return Promise.reject(t)})};D.deleteDocumentId=function(t,r){var n=g.getResultsetContainer().getDocumentIdManager();var i=p.RsCellIndexInfo.create();i.initialize(t,r);return u.syncActionToPromise(n.deleteCellDocumentId,n,i).then(function(e){D._addMessagesToModel(e);return e.getData().isCellDocumentIdDeleted()}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);return Promise.reject(t)})};D._extractProperties=function(e){if(e){var t=e.getContent();var r=e.getTimeStamp();return{version:e.getVersion(),owner:e.getOwner(),timestamp:r?r.toString():null,content:t?t.getStringContentExt():null}}return null};D.createDocument=function(e,t){if(!e){throw new Error("Cannot create document without document ID")}try{return D.updateDocument(e,t)}catch(e){return Promise.reject(e)}};D.retrieveDocument=function(t,r){if(!t){throw new Error("Cannot retrieve document without document ID")}var n=D.getQueryManager().getQueryModel().getDocumentsInfo();if(n){var i=n.getSupportsDocuments();if(i&&i.getName()!=="None"){var a=n.getOrCreateDocumentsStoreService(false);a.addToFetchList(t);return u.syncActionToPromise(a.performRequests,a,[null,null]).then(function(){var e=[];if(!r){var n=a.getDocumentVersionsForFile(t);if(n){n.forEach(function(t){var r=D._extractProperties(t);if(r){e.push(r)}})}}else{var i=a.getDocumentVersionForFileAndVersion(t,r);var o=D._extractProperties(i);if(o){e.push(o)}}return Promise.resolve({documentId:t,versions:e})}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);return Promise.reject(t)})}else{throw new Error("No document support. Unable to retrieve document.")}}};D.retrieveMultipleDocuments=function(t){if(!t){throw new Error("Cannot retrieve documents without document IDs array")}else if(!Array.isArray(t)){t=[t]}var r=D.getQueryManager().getQueryModel().getDocumentsInfo();if(r){var n=r.getSupportsDocuments();if(n&&n.getName()!=="None"){var i=r.getOrCreateDocumentsStoreService(false);t.forEach(function(e){i.addToFetchList(e)});return u.syncActionToPromise(i.performRequests,i,[null,null]).then(function(){var e=[];t.forEach(function(t){var r=[];var n=i.getDocumentVersionsForFile(t);if(n){n.forEach(function(e){var t=D._extractProperties(e);if(t){r.push(t)}})}e.push({documentId:t,versions:r})});return Promise.resolve(e)}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);return Promise.reject(t)})}else{throw new Error("No document support. Unable to retrieve documents.")}}};D.updateDocument=function(t,r){if(!t){throw new Error("Cannot update document without document ID")}var n=D.getQueryManager().getQueryModel().getDocumentsInfo();if(n){var i=n.getSupportsDocuments();if(i&&i.getName()==="ReadWrite"){var a=n.getOrCreateDocumentsStoreService(false);a.addToPutList(t,p.XContent.createStringContent(p.ContentType.TEXT_PLAIN,r));a.addToFetchList(t);return u.syncActionToPromise(a.performRequests,a,[null,null]).then(function(){var e=a.getContentForFile(t);return Promise.resolve(e?e.getStringContentExt()===r:e===r)}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);return Promise.reject(t)})}else{throw new Error("No 'ReadWrite' document support. Unable to update document.")}}};D.deleteDocument=function(t){if(!t){throw new Error("Cannot delete document without document ID")}var r=D.getQueryManager().getQueryModel().getDocumentsInfo();if(r){var n=r.getSupportsDocuments();if(n&&n.getName()==="ReadWrite"){var i=r.getOrCreateDocumentsStoreService(false);i.addToDeleteList(t);return u.syncActionToPromise(i.performRequests,i,[null,null]).then(function(){i.evictAllDocuments();return Promise.resolve(true)}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);return Promise.reject(t)})}else{throw new Error("No 'ReadWrite' document support. Unable to delete document.")}}};D.deserialize=function(e){return F().then(function(){S.deserializeExt(p.QModelFormat.INA_REPOSITORY,e);b()})};D.serialize=function(){return S.serializeToContentExt(p.QModelFormat.INA_REPOSITORY,null).getString()};D.getResultRequest=function(){return g.getResultsetContainer().getResultSetManager().getDataRequest().convertToNative()};D.getQueryView=function(){return S.serializeToElement(p.QModelFormat.INA_DATA).convertToNative()};D.getQueryManager=function(){return g};D.callUpdateDimensionData=function(){I()};D.addCondition=function(e){return Promise.resolve(null).then(function(){var t=["COND_",Date.now()].join("");var r=S.getConditionManager().addNewCondition(t);r.setDescription(e.Description);r.setText(e.Description);var n=S.getDimensionByName(D.Dimensions[e.Structure1Key].TechName);var i=f.find(D.Dimensions[e.Structure1Key].Members,function(t){return e.measure1===t.Name}).TechName;if(!i){throw new Error("Invalid measure")}r.setDimensionEvaluationType(p.ConditionDimensionEvaluationType.ALL_IN_DRILL_DOWN);var a=r.createThreshold();var o=n.getStructureMember(i);if(!o){throw new Error("Invalid measure")}a.addMeasureCoordinate(o);a.setComparisonOperator(p.ConditionComparisonOperator[e.operator]);a.getLow().setString(e.Value);return D})};D.resetToDefault=function(){return F().then(function(){g.getConvenienceCommands().resetToDefault();b()})};D.logoff=function(){return new Promise(function(e){g.processShutdown(p.SyncType.NON_BLOCKING,{onQueryManagerRelease:function(t,r){p.XObjectExt.release(r);e()}})})};function w(){var e=f.map(l.arrayFromList(S.getVariables()),L).filter(function(e){return e.InputEnabled});D.Variables=f.reduce(e,function(e,t){e[t.Name]=t;return e},D.Variables);T=f.reduce(l.arrayFromIter(S.getVariables().getIterator()),function(e,t){e[t.getNameExternal()||t.getName()]=t.getName();return e},T)}function I(){function e(e){var t=S.getSortingManager();if(t.supportsDimensionSorting(e,null)){return e.getResultSetSorting().getDirection().getName()}else{return null}}D.Dimensions=f.reduce(l.arrayFromList(S.getDimensions()),function(t,r){var n=r.getAxisType();if(n!=p.AxisType.COLUMNS&&n!=p.AxisType.ROWS&&n!=p.AxisType.FREE){return t}var i=r.getAxis();if(r.getDimensionType().getName()===a.MeasureStructure){r.getExternalName=f.constant("MeasureStructure")}else if(r.getDimensionType().getName()===a.SecondaryStructure){r.getExternalName=f.constant("NonMeasureStructure")}if(!r.getExternalName()||r.getExternalName().trim()===""){r.getExternalName=r.getName}t[r.getExternalName()]={Name:r.getExternalName(),TechName:r.getName(),Description:r.getText(),Axis:i.getName(),Type:r.getDimensionType().getName(),HierarchyActive:r.isHierarchyActive(),HasFilter:!!r.getFilter(),SortDirection:e(r),Position:i.getDimensionIndex(r.getName()),LastPosition:i.getDimensionCount()-1,IsStructure:r.getDimensionType().getName()===a.MeasureStructure||r.getDimensionType().getName()===a.SecondaryStructure,IsMeasureStructure:r.getDimensionType().getName()===a.MeasureStructure||r.getDimensionType().getName()===a.SecondaryStructure};if(r.getDimensionType().getName()===a.MeasureStructure||r.getDimensionType().getName()===a.SecondaryStructure){var o=r.getDisplayKeyField();t[r.getExternalName()].Members=f.map(l.arrayFromList(r.getAllStructureMembers()),function(e){return{Name:e.getFieldValue(r.getDisplayKeyField())?e.getFieldValue(o).getValue().getString():e.getName(),TechName:e.getName(),Description:e.getText()}})}return t},{});D.FreeAxis={};D.FreeAxis.Dimensions=f.sortBy(f.filter(D.Dimensions,{Axis:n.Free}),"Description");D.ColumnsAxis={};D.ColumnsAxis.Dimensions=f.sortBy(f.filter(D.Dimensions,{Axis:n.Columns}),"Position");D.RowsAxis={};D.RowsAxis.Dimensions=f.sortBy(f.filter(D.Dimensions,{Axis:n.Rows}),"Position");D.UsedDimensions=f.filter(f.concat(D.RowsAxis.Dimensions,D.ColumnsAxis.Dimensions),function(e){return!e.IsMeasureStructure})}function b(e){O();w();D.HasVariables=S.getVariableContainer().hasVariables();I();var t=S.getMeasureDimension();var r=t?t.getExternalName():null;var n=t?D.Dimensions[r]:null;var i=t&&n.Members||[];if(e){D.FlatResultSet=e.FlatResultSet}else{D.Measures=i}D.Conditions=f.map(S.getConditionManager()?l.arrayFromList(g.getQueryModel().getConditionManager()):[],function(e){return{Name:e.getName(),Description:e.getText(),StatusText:m.getText(e.isActive()?"ACTIVE":"INACTIVE"),active:e.isActive()}});D.Exceptions=f.map(g.getQueryModel().getExceptionManager()?l.arrayFromList(g.getQueryModel().getExceptionManager()):[],function(e){return{Name:e.getName(),Description:e.getText(),StatusText:m.getText(e.isActive()?"ACTIVE":"INACTIVE"),active:e.isActive()}})}function O(){var e={};D.QueryInfo=e;e.QueryTitle=S.getText()||S.getDataSource().getName();e.QueryName=S.getDataSource().getName();e.QueryType=S.getDataSource().getType().getName();e.SystemName=g.getSystemDescription().getName();if(S.getCubeInfo()){e.CreatedBy=S.getCubeInfo().getCreatedBy();e.CreatedOn=function(){var e=S.getCubeInfo().getCreatedOn();return e?new Date([e.getYear(),e.getMonthOfYear(),e.getDayOfMonth()].join("-")):new Date}();e.CreatedOnText=e.QueryDueDateText=t.getDateInstance({style:"medium"}).format(e.CreatedOn);e.QueryDueDate=function(){var e=S.getCubeInfo().getDueDate();return e?new Date([e.getYear(),e.getMonthOfYear(),e.getDayOfMonth()].join("-")):new Date}();e.QueryDueDateText=t.getDateInstance({style:"medium"}).format(e.QueryDueDate);if(S.getResultAlignment()){e.ResultAlignmentRows=S.getResultAlignment().getName();e.ResultAlignmentColumns=S.getResultAlignment().getName()}e.LastUpdated=function(){var e=S.getCubeInfo().getUpdatedOn();return e?new Date([e.getYear(),e.getMonthOfYear(),e.getDayOfMonth()].join("-")):new Date}();e.LastUpdatedBy=S.getCubeInfo().getUpdatedBy();e.LastUpdatedText=t.getDateInstance({style:"medium"}).format(e.LastUpdated)}}function V(e){var t=e.getDimension();var r=t&&t.getTextField()&&e.getLow().getSupplementValueString(e.getDimension().getTextField().getName())?e.getLow().getSupplementValueString(e.getDimension().getTextField().getName()):e.getLow().getString();var n=t&&t.getTextField()&&e.getHigh().getSupplementValueString(e.getDimension().getTextField().getName())?e.getHigh().getSupplementValueString(e.getDimension().getTextField().getName()):e.getHigh().getString();var i=n?[r,n].join(" - "):r;if(e.getSetSign()===p.SetSign.EXCLUDING){i="!( "+i+")"}return{Low:e.getLow().getString(),High:e.getHigh().getString(),ComparisonOperator:e.getComparisonOperator().getName(),Text:i,IsExcluding:e.getSetSign().getName()}}function L(e){return{Name:e.getNameExternal()||e.getName(),Dimension:e.getDimension&&e.getDimension()&&(e.getDimension().getExternalName()||e.getDimension().getName()),ValueType:e.getValueType().getName(),VariableType:e.getVariableType().getName(),Description:e.getText(),Mandatory:e.isMandatory(),SupportsMultipleValues:e.supportsMultipleValues(),TechName:e.getName(),InputEnabled:e.isInputEnabled(),Position:e.getVariableOrder(),SupportsValueHelp:e.supportsValueHelp&&e.supportsValueHelp(),DataProviderName:d,MemberFilter:e.getMemberFilter?f.map(l.arrayFromList(e.getMemberFilter()),V):function(){var t=e.getValueByString();if(!t){return[]}return[{Low:t,ComparisionOperator:"EQUAL",Text:t,IsExcluding:false}]}()}}};function y(e){switch(e){case p.ComparisonOperator.EQUAL:return"EQ";case p.ComparisonOperator.LESS_THAN:return"LT";case p.ComparisonOperator.LESS_EQUAL:return"LE";case p.ComparisonOperator.GREATER_THAN:return"GT";case p.ComparisonOperator.GREATER_EQUAL:return"GE";case p.ComparisonOperator.BETWEEN:return"BT";case p.ComparisonOperator.NOT_EQUAL:return"NE";default:throw new Error("Invalid Operator: "+e.getName())}}d.prototype.hasVariable=function(){};d.prototype.setAxesLayout=function(){};d.prototype.openCellDialog=function(){};d.prototype.openAxisDialog=function(){};d.prototype.openCurrencyTranslationDialog=function(){};d.prototype.openDimDialog=function(){};d.prototype.openSelector=function(){};d.prototype.setFilter=function(){};d.prototype.removeFilter=function(){};d.prototype.sort=function(){};d.prototype.toRows=function(){};d.prototype.toColumns=function(){};d.prototype.drill=function(){};d.prototype.submitVariables=function(){};d.prototype.getResultSet=function(){};d.prototype.getRRITargets=function(){};d.prototype.addCondition=function(){};d.prototype.moveUp=function(){};d.prototype.moveDown=function(){};d.prototype.setDisplayHierarchy=function(){};d.prototype.getFilterOfDim=function(){};d.prototype.synchronize=function(){};d.prototype.setFormat=function(){};d.prototype.getScalingFactor=function(){};d.prototype.setScalingFactor=function(){};d.prototype.getDecimalPlaces=function(){};d.prototype.setDecimalPlaces=function(){};d.prototype.suppressUnit=function(){};d.prototype.createDocumentId=function(){};d.prototype.getDocumentId=function(){};d.prototype.deleteDocumentId=function(){};d.prototype.createDocument=function(){};d.prototype.retrieveDocument=function(){};d.prototype.retrieveMultipleDocuments=function(){};d.prototype.updateDocument=function(){};d.prototype.deleteDocument=function(){};return d});
//# sourceMappingURL=MultiDimDataProvider.js.map
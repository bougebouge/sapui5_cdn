/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(e,jQuery){"use strict";sap.apf.modeler.core.ConfigurationEditor=function(e,t,r,n){var i=this;var a;var o;var s=t.instances.configurationHandler;var f=t.instances.persistenceProxy;var l=t.instances.messageHandler;var c=t.instances.metadataFactory;var u=true;var g,v,d,m,h,p;var y;var E=new t.constructors.ConfigurationObjects(t);var C=new t.constructors.ConfigurationFactory({instances:{messageHandler:l},constructors:{RegistryProbe:t.constructors.RegistryProbe}});if(!n){g=new t.constructors.ElementContainer("Step",t.constructors.Step,t);v=new t.constructors.ElementContainer("Category",undefined,t);d=new t.constructors.ElementContainer("FacetFilter",t.constructors.FacetFilter,t);m=new t.constructors.ElementContainer("NavigationTarget",t.constructors.NavigationTarget,t);h=new t.constructors.ElementContainer("CategoryStepAssignment",t.constructors.ElementContainer,t);p=[];a={smartFilterBar:true}}else{g=n.stepContainer;v=n.categoryContainer;y=n.smartFilterBar;d=n.facetFilterContainer;m=n.navigationTargetContainer;h=n.categoryStepAssignmentContainer;p=n.serviceList;o=n.applicationTitle;a=n.filterOption}this.registerServiceAsPromise=function(e){var t=jQuery.Deferred();var r;if(p.indexOf(e)===-1){r=c.getMetadata(e);r.done(function(){if(p.indexOf(e)===-1){p.push(e)}t.resolve(true)});r.fail(function(){t.resolve(false)})}else{t.resolve(true)}return t.promise()};this.getAllServices=function(){return p};this.getAllEntitySetsOfServiceAsPromise=function(e){return c.getEntitySets(e)};this.getAllHierarchicalEntitySetsOfServiceAsPromise=function(e){var t=jQuery.Deferred();c.getMetadata(e).done(function(e){if(e){t.resolve(e.getHierarchicalEntitySets())}t.resolve([])}).fail(function(){t.resolve([])});return t.promise()};this.checkIfHierarchicalEntitySetIsAvailableAsPromise=function(e){var t=jQuery.Deferred();this.getAllHierarchicalEntitySetsOfServiceAsPromise(e).done(function(e){if(e.length>0){t.resolve(true)}else{t.resolve(false)}});return t};this.getHierarchicalPropertiesOfEntitySetAsPromise=function(e,t){var r=jQuery.Deferred();c.getMetadata(e).done(function(e){if(e){r.resolve(e.getHierarchicalPropertiesOfEntitySet(t))}else{r.resolve([])}}).fail(function(){r.resolve([])});return r};this.getHierarchyNodeIdAsPromise=function(e,t,r){var n;var i=jQuery.Deferred();c.getMetadata(e).done(function(e){if(e){n=e.getHierarchyAnnotationsForProperty(t,r);if(n&&n.hierarchyNodeFor){i.resolve(n.hierarchyNodeFor)}else{i.resolve(null)}}else{i.resolve(null)}}).fail(function(){i.resolve(null)});return i};this.getNonHierarchicalPropertiesOfEntitySet=function(e,t){var r;var n=jQuery.Deferred();c.getMetadata(e).then(function(e){r=e.getNonHierarchicalPropertiesOfEntitySet(t);n.resolve(r)},function(){n.resolve([])});return n};this.getAllEntitySetsExceptParameterEntitySets=function(e){return c.getAllEntitySetsExceptParameterEntitySets(e)};this.getAllEntitySetsOfServiceWithGivenPropertiesAsPromise=function(e,t){var r=[];var n=jQuery.Deferred();this.getAllEntitySetsOfServiceAsPromise(e).done(function(i){if(!t||t.length===0){n.resolve(i);return}c.getMetadata(e).done(function(e){i.forEach(function(n){var i=e.getFilterableProperties(n);var a=true;for(var o=0;o<t.length;o++){if(i.indexOf(t[o])<=-1){a=false;break}}if(a){r.push(n)}});n.resolve(r)})});return n.promise()};this.getAllPropertiesOfEntitySetAsPromise=function(e,t){var r=jQuery.Deferred();c.getMetadata(e).done(function(e){r.resolve(e.getAllPropertiesOfEntitySet(t))}).fail(function(){r.resolve([])});return r.promise()};this.getAllKnownPropertiesAsPromise=function(){var e=jQuery.Deferred();var t=[];var r=p.length;p.forEach(function(n){c.getMetadata(n).done(function(n){t=t.concat(n.getAllProperties());r--;if(r===0){t=sap.apf.utils.eliminateDuplicatesInArray(l,t);e.resolve(t)}})});return e.promise()};this.getFilterablePropertiesAndParametersAsPromise=function(){var e=jQuery.Deferred();var t=[];var r=p.length;p.forEach(function(n){c.getMetadata(n).done(function(n){t=t.concat(n.getFilterablePropertiesAndParameters());if(--r===0){e.resolve(sap.apf.utils.eliminateDuplicatesInArray(l,t))}})});if(r===0){e.resolve([])}return e.promise()};this.setApplicationTitle=function(e){u=false;o=e};this.getApplicationTitle=function(){return o};this.getConfigurationName=function(){return s.getConfiguration(e.id||e).AnalyticalConfigurationName};this.getCategoryStepAssignments=function(e){var t=[];if(!this.getCategory(e)){return false}var r=h.getElement(e);if(r){r.getElements().forEach(function(e){t.push(e.stepId)})}return t};this.addCategoryStepAssignment=function(e,t){if(!this.getCategory(e)||!this.getStep(t)){return false}var r=h.getElement(e);if(!r){h.createElementWithProposedId({},e);r=h.getElement(e)}if(!r.getElement(t)){r.createElementWithProposedId({stepId:t},t);return true}return false};this.removeCategoryStepAssignment=function(e,t){var r;if(!t){var n=this.getCategoryStepAssignments(e);r=h.removeElement(e);if(r){S(n)}return!!r}var i=h.getElement(e);if(!i){return false}r=i.removeElement(t);if(i.getElements().length===0){h.removeElement(e)}if(r){S([t])}return!!r};function S(e){if(!e){return}e.forEach(function(e){if(i.getCategoriesForStep(e).length===0){g.removeElement(e)}})}this.moveCategoryStepAssignmentBefore=function(e,t,r){var n=h.getElement(e);if(!n){return null}return n.moveBefore(t,r)};this.moveCategoryStepAssignmentToEnd=function(e,t){var r=h.getElement(e);if(!r){return null}return r.moveToEnd(t)};this.moveCategoryStepAssignmentUpOrDown=function(e,t,r){var n=h.getElement(e);if(!n){return null}return n.moveUpOrDown(t,r)};this.getCategory=v.getElement;this.setCategory=function(e,t){u=false;return v.setElement(e,t)};this.createCategoryWithId=function(e,t){u=false;return v.createElementWithProposedId(e,t).getId()};this.removeCategory=function(e){var t=i.getCategoryStepAssignments(e);if(t){t.forEach(function(e){var t=i.getCategoriesForStep(e);if(!t||t.length<2){g.removeElement(e)}})}v.removeElement(e)};this.getCategories=v.getElements;this.copyCategory=function(e){var t=v.copyElement(e);if(!t){return}i.getCategoryStepAssignments(e).forEach(function(e){A(e,t)});return t};this.moveCategoryBefore=function(e,t){return v.moveBefore(e,t)};this.moveCategoryToEnd=function(e){return v.moveToEnd(e)};this.moveCategoryUpOrDown=function(e,t){return v.moveUpOrDown(e,t)};this.serialize=function(){return E.serializeConfiguration(i)};this.isSaved=function(){return u};this.setIsUnsaved=function(){u=false};this.save=function(t){var r;function n(n,i,a){if(!a){u=true;s.replaceConfigurationId(e.id||e,n.AnalyticalConfiguration);s.updateConfigurationName(e.id||e,r);e=n.AnalyticalConfiguration}t(e,i,a)}function i(n,i){if(!i){u=true}s.updateConfigurationName(e.id||e,r);t(e.id||e,n,i)}r=s.getConfiguration(e.id||e).AnalyticalConfigurationName;var a={AnalyticalConfiguration:"",AnalyticalConfigurationName:r,Application:s.getApplicationId(),SerializedAnalyticalConfiguration:JSON.stringify(this.serialize()),CreatedByUser:"",CreationUTCDateTime:null,LastChangeUTCDateTime:null,LastChangedByUser:""};if(typeof e==="string"){if(e.indexOf("apf1972-")===0){f.create("configuration",a,n)}else{a.AnalyticalConfiguration=e;f.update("configuration",a,i,[{name:"AnalyticalConfiguration",value:e}])}}else{if(e.id.indexOf("apf1972-")===0){a.AnalyticalConfiguration="";a.CreationUTCDateTime=null;a.LastChangeUTCDateTime=null}else{a.AnalyticalConfiguration=e.id;a.CreationUTCDateTime=e.creationDate;a.LastChangeUTCDateTime=e.lastChangeDate}if(e.updateExisting){f.update("configuration",a,i,[{name:"AnalyticalConfiguration",value:e.id}])}else{f.create("configuration",a,n)}}};this.getFilterOption=function(){return Object.assign({},a)};this.setFilterOption=function(e){if(e.none===true){y=null;t.call(this);r()}if(e.smartFilterBar===true){t.call(this);n()}if(e.facetFilter===true){y=null;i()}function t(){this.getFacetFilters().forEach(function(e){this.removeFacetFilter(e.getId())}.bind(this))}function r(){delete a.smartFilterBar;delete a.facetFilter;a.none=true}function n(){a.smartFilterBar=true;delete a.facetFilter;delete a.none}function i(){delete a.smartFilterBar;a.facetFilter=true;delete a.none}};this.isDataLostByFilterOptionChange=function(){if(a.smartFilterBar===true){if(y&&(y.getService()||y.getEntitySet())){return true}}if(a.facetFilter===true){if(d.getElements().length>0){return true}}return false};this.getSmartFilterBar=function(){if(a.smartFilterBar===true){if(!y){y=new t.constructors.SmartFilterBar("SmartFilterBar-1")}return y}return null};this.createFacetFilterWithId=function(e){if(a.facetFilter===true){return d.createElementWithProposedId(undefined,e).getId()}return null};this.createFacetFilter=function(){if(a.facetFilter===true){return d.createElement().getId()}return null};this.removeFacetFilter=d.removeElement;this.getFacetFilter=d.getElement;this.getFacetFilters=d.getElements;this.copyFacetFilter=d.copyElement;this.moveFacetFilterBefore=function(e,t){return d.moveBefore(e,t)};this.moveFacetFilterToEnd=function(e){return d.moveToEnd(e)};this.moveFacetFilterUpOrDown=function(e,t){return d.moveUpOrDown(e,t)};this.createNavigationTargetWithId=function(e){return m.createElementWithProposedId(undefined,e).getId()};this.createNavigationTarget=function(){return m.createElement().getId()};this.removeNavigationTarget=function(e){var t=m.getElement(e);if(!t){return}m.removeElement(e);if(t.isStepSpecific()){var r=this.getStepsAssignedToNavigationTarget(e);var n,i;for(n=0;n<r.length;n++){i=this.getStep(r[n]);i.removeNavigationTarget(e)}}};this.getNavigationTarget=m.getElement;this.getNavigationTargets=m.getElements;this.copyNavigationTarget=function(e){var t=m.copyElement(e);var r=m.getElement(t);if(r.isStepSpecific()){var n=this.getStepsAssignedToNavigationTarget(e);var i,a;for(i=0;i<n.length;i++){a=this.getStep(n[i]);a.addNavigationTarget(t)}}return t};this.moveNavigationTargetBefore=function(e,t){return m.moveBefore(e,t)};this.moveNavigationTargetToEnd=function(e){return m.moveToEnd(e)};this.moveNavigationTargetUpOrDown=function(e,t){return m.moveUpOrDown(e,t)};this.createStepWithId=function(e){return g.createElementWithProposedId(undefined,e).getId()};this.createStep=function(e){if(!this.getCategory(e)){return}var t=g.createElement().getId();this.addCategoryStepAssignment(e,t);return t};this.createHierarchicalStepWithId=function(e){return g.createElementWithProposedId(undefined,e,t.constructors.HierarchicalStep).getId()};this.createHierarchicalStep=function(e){if(!this.getCategory(e)){return}var r=g.createElement(undefined,t.constructors.HierarchicalStep).getId();this.addCategoryStepAssignment(e,r);return r};this.getStep=g.getElement;this.getSteps=g.getElements;this.getStepsNotAssignedToCategory=function(e){var t=this.getCategoryStepAssignments(e);var r=[];i.getSteps().forEach(function(e){var n=e.getId();if(t.indexOf(n)===-1){r.push(n)}});return r};this.copyStep=function(e){var t=A(e);var r=this.getCategoriesForStep(e);if(!t){return false}if(r){r.forEach(function(e){i.addCategoryStepAssignment(e,t)})}return t};function A(e,t){if(t&&!i.getCategory(t)){return false}var r=g.copyElement(e);if(!r){return false}if(t){i.addCategoryStepAssignment(t,r)}return r}this.getCategoriesForStep=function e(t){var r=[];var n=i.getCategories();if(n){n.forEach(function(e){var n=e.getId();var a=i.getCategoryStepAssignments(n);if(a&&a.indexOf(t)>-1){r.push(n)}})}return r};this.getAssignableStepsForNavigationTarget=function(e){var t=[];i.getSteps().forEach(function(r){var n=false;r.getNavigationTargets().forEach(function(t){if(e===t){n=true}});if(!n){t.push(r.getId())}});return t};this.getStepsAssignedToNavigationTarget=function(e){var t=[];i.getSteps().forEach(function(r){var n=false;r.getNavigationTargets().forEach(function(t){if(e===t){n=true}});if(n){t.push(r.getId())}});return t};this.copy=function(e){var r={stepContainer:g,categoryContainer:v,facetFilterContainer:d,navigationTargetContainer:m,categoryStepAssignmentContainer:h,applicationTitle:o,serviceList:p,filterOption:a};var n=sap.apf.modeler.core.ConfigurationObjects.deepDataCopy(r);if(a.smartFilterBar===true&&y){n.smartFilterBar=i()}return new sap.apf.modeler.core.ConfigurationEditor(e,t,undefined,n);function i(){var e=new t.constructors.SmartFilterBar(y.getId());e.setService(y.getService());e.setEntitySet(y.getEntitySet(),!y.isEntityTypeConverted());return e}};if(typeof e==="string"){if(e.indexOf("apf1972-")===0){u=false;if(r){r(i,undefined)}}else if(!n){F(e,f,function(e,t){if(!t){var n=JSON.parse(e.SerializedAnalyticalConfiguration);i.setApplicationTitle(n.applicationTitle);C.loadConfig(n,true);E.mapToDesignTimeAsPromise(C.getRegistry(),i).then(function(){u=true;r(i,undefined)})}else{r(undefined,t)}})}}else{C.loadConfig(e.content,true);E.mapToDesignTimeAsPromise(C.getRegistry(),this).then(function(){if(r){r(i,undefined)}})}function F(e,t,r){t.readEntity("configuration",function(e,t,n){r(e,n)},[{name:"AnalyticalConfiguration",value:e}],undefined,s.getApplicationId())}}});
//# sourceMappingURL=configurationEditor.js.map
sap.ui.define(["sap/apf/modeler/ui/utils/sortDataHandler","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/viewValidator","sap/apf/modeler/ui/utils/stepPropertyMetadataHandler","sap/apf/modeler/ui/utils/textPoolHelper"],function(e,t,i,a,r,n){"use strict";var o,d,s,l,p,u,g,c,f,S,I,T;var v=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_TITLE;var b=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_LONG_TITLE;function y(e){e.byId("idStepBasicData").setText(d("stepBasicData"));e.byId("idStepTitleLabel").setText(d("stepTitle"));e.byId("idStepTitle").setPlaceholder(d("newStep"));e.byId("idStepLongTitleLabel").setText(d("stepLongTitle"));e.byId("idStepLongTitle").setPlaceholder(d("stepLongTitle"));e.byId("idCategoryTitleLabel").setText(d("categoryAssignments"));e.byId("idGlobalLabel").setText(d("globalNavigationTarget"));e.byId("idStepSpecificLabel").setText(d("stepSpecificNavTargets"));e.byId("idDataRequest").setText(d("dataRequest"));e.byId("idFilterMapping").setText(d("filterMap"));e.byId("idFilterMapKeepSourceLabel").setText(d("filterMapKeepSource"));e.byId("idNavigationTarget").setText(d("navigationTargetAssignments"));e.byId("idDataReduction").setText(d("dataReduction"));e.byId("idDataReductionLabel").setText(d("dataReductionType"));e.byId("idNoDataReduction").setText(d("noDataReduction"));e.byId("idTopN").setText(d("topN"));e.byId("idNumberOfRecordsLabel").setText(d("recordNumber"));e.byId("idAriaPropertyForDataReduction").setText(d("dataReductionType"))}function N(e,t){var i=d(I?"hierarchicalStepTitle":"step")+": "+t;e.getView().getViewData().updateTitleAndBreadCrumb(i);m(e,t)}function m(e,t){var i=d(I?"hierarchicalStepTitle":"step")+": "+t;e.getView().getViewData().oTitleBreadCrumbController.byId("IdFormTitle").setText(i)}function h(e,t){var i={id:g.getId(),icon:g.getType()==="hierarchicalStep"?"sap-icon://drill-down":"sap-icon://step"};if(t){i.name=t}e.getView().getViewData().updateSelectedNode(i)}function V(e){var i,a;if(o&&o.arguments&&o.arguments.stepId){g=l.getStep(o.arguments.stepId);I=g&&g.getType()==="hierarchicalStep"?true:false}if(!t.checkIsNotUndefined(g)){a=o.arguments.categoryId;I=o.bIsHierarchicalStep;if(I){i=l.createHierarchicalStep(a)}else{i=l.createStep(a)}g=l.getStep(i);h(e)}}function C(e){var t=this;var i=e.getParameter("bShowFilterMappingLayout");t.byId("idStepFilterMappingVBox").setVisible(i);t.byId("idFilterMapKeepSourceLabel").setVisible(i);t.byId("idFilterKeepSourceCheckBox").setVisible(i);if(!i){t.byId("idFilterMapping").setText("");t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS)}else{t.byId("idFilterMapping").setText(d("filterMap"))}}function E(e){e.byId("idDataReductionForm").setVisible(!I)}function O(e,t,i,a,r){sap.ui.view({viewName:a,type:sap.ui.core.mvc.ViewType.XML,id:e.createId(r),viewData:i,controller:t})}function R(e){var t,i,a,r,n,o,u;t={oTextReader:d,oConfigurationEditor:l,oTextPool:p,oParentObject:g,oStepPropertyMetadataHandler:T,oCoreApi:e.getView().getViewData().oCoreApi};i=new sap.ui.controller("sap.apf.modeler.ui.controller.stepCornerTexts");O(e,i,t,"sap.apf.modeler.ui.view.cornerTexts","idStepCornerTextView");n=e.byId("idStepCornerTextView");e.byId("idStepCornerTextVBox").insertItem(n);t.oConfigurationHandler=s;t.getCalatogServiceUri=e.getView().getViewData().getCalatogServiceUri;if(I){a=new sap.ui.controller("sap.apf.modeler.ui.controller.hierarchicalStepRequest")}else{a=new sap.ui.controller("sap.apf.modeler.ui.controller.stepRequest")}O(e,a,t,"sap.apf.modeler.ui.view.requestOptions","idStepRequestView");o=e.byId("idStepRequestView");e.byId("idStepRequestVBox").insertItem(o);r=new sap.ui.controller("sap.apf.modeler.ui.controller.stepFilterMapping");O(e,r,t,"sap.apf.modeler.ui.view.requestOptions","idStepFilterMappingView");u=e.byId("idStepFilterMappingView");e.byId("idStepFilterMappingVBox").insertItem(u);o.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETDATAREDUCTIONSECTION,e.setDataReductionSection.bind(e));o.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,C.bind(e));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,C.bind(e));o.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.UPDATEFILTERMAPPINGFIELDS,u.getController().updateFilterMappingFields.bind(u.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS,u.getController().resetFilterMappingFields.bind(u.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,n.getController().updateSubViewInstancesOnReset.bind(n.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,o.getController().updateSubViewInstancesOnReset.bind(o.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,u.getController().updateSubViewInstancesOnReset.bind(u.getController()));o.addStyleClass("formTopPadding");o.addStyleClass("formBottomPadding");u.addStyleClass("formTopPadding");u.addStyleClass("formBottomPadding")}function w(e){if(!t.checkIsNotNullOrUndefinedOrBlank(l.getStep(o.arguments.stepId))){return}e.byId("idStepTitle").setValue(g.getId());if(t.checkIsNotNullOrUndefinedOrBlank(g.getTitleId())&&p.get(g.getTitleId())){e.byId("idStepTitle").setValue(p.get(g.getTitleId()).TextElementDescription)}}function F(e){if(!t.checkIsNotNullOrUndefinedOrBlank(l.getStep(o.arguments.stepId))){return}e.byId("idStepLongTitle").setValue("");if(t.checkIsNotNullOrUndefinedOrBlank(g.getLongTitleId())&&p.get(g.getLongTitleId())){e.byId("idStepLongTitle").setValue(p.get(g.getLongTitleId()).TextElementDescription)}}function x(e){var a=[];var r=l.getCategories();r.forEach(function(e){var t={};t.CategoryId=e.getId();t.CategoryTitle=p.get(e.labelKey)?p.get(e.labelKey).TextElementDescription:e.labelKey;a.push(t)});var n=i.prepareModel(a,a.length);e.byId("idCategorySelect").setModel(n);var o=l.getCategoriesForStep(g.getId());if(t.checkIsNotNullOrUndefinedOrBlank(o)){e.byId("idCategorySelect").setSelectedKeys(o)}}function D(e){e.byId("idNumberOfRecordsValue").setValue("");e.byId("idNumberOfRecordsValue").setValueState("None");if(g.getTopN()){e.byId("idNumberOfRecordsValue").setValue(g.getTopN().top)}L(e)}function P(e){e.byId("idDataReductionRadioGroup").setSelectedButton(e.byId("idNoDataReduction"));M(e);if(g.getTopN()){e.byId("idDataReductionRadioGroup").setSelectedButton(e.byId("idTopN"))}}function L(e){var t=e.byId("idDataReductionRadioGroup").getSelectedButton()===e.byId("idTopN")?true:false;e.byId("idNumberOfRecordsLabel").setVisible(t);e.byId("idNumberOfRecordsValue").setVisible(t);if(t){c.addField("idNumberOfRecordsValue")}else{c.removeField("idNumberOfRecordsValue")}}function A(e){if(g.getTopN()){f.instantiateStepSortData();if(g.getTopN().orderby.length===0){e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);var t=S.createMessageObject({code:"11523"});S.putMessage(t)}}else{f.destroySortData()}}function M(e){var t=g.getSelectProperties().length!==0?true:false;e.byId("idDataReductionRadioGroup").setEnabled(t)}function B(e){var t=g.getFilterProperties().length!==0?true:false;e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,{bShowFilterMappingLayout:t})}function U(e){if(t.checkIsNotNullOrUndefinedOrBlank(g.getFilterMappingKeepSource())){e.byId("idFilterKeepSourceCheckBox").setSelected(g.getFilterMappingKeepSource())}}function k(e,t,a,r){var n=[];if(t.length!==0){a.setBusy(true)}t.forEach(function(e){var o={};o.navTargetKey=e.getId();u(e.getId()).then(function(e){o.navTargetName=e;n.push(o);if(n.length===t.length){var d=i.prepareModel(n,n.length);a.setModel(d);a.setSelectedKeys(r);a.setBusy(false)}})})}function K(e){var t=l.getNavigationTargets();var i=g.getNavigationTargets();var a=t.filter(function(e){return e.isStepSpecific()});k(e,a,e.byId("idStepSpecificCombo"),i)}function G(e){var t=l.getNavigationTargets();var i=t.filter(function(e){return e.isGlobal()});var a=i.map(function(e){return e.getId()});k(e,i,e.byId("idGlobalCombo"),a)}sap.ui.controller("sap.apf.modeler.ui.controller.step",{onInit:function(){var t=this,i;var r=t.getView().getViewData();S=r.oCoreApi;d=S.getText;o=r.oParams;s=r.oConfigurationHandler;p=s.getTextPool();l=r.oConfigurationEditor;u=r.getNavigationTargetName;c=new a(t.getView());y(t);V(t);T=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(S,g);f=new e(t.getView(),g,T,d);R(t);t.setDetailData();i=t.byId("idStepTitle").getValue().trim();if(i===""){i="< "+d("newStep")+" >"}m(t,i);c.addFields(["idStepTitle","idCategorySelect"])},setDetailData:function(){var e=this;w(e);F(e);x(e);e.setDataReductionSection();E(e);B(e);U(e);K(e);G(e)},onAfterRendering:function(){var e=this;if(e.byId("idStepTitle").getValue().length===0){e.byId("idStepTitle").focus()}},updateSubViewInstancesOnReset:function(e){var t=this;l=e;g=l.getStep(g.getId());t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,{oConfigurationEditor:l,oParentObject:g})},setDataReductionSection:function(){var e=this;P(e);D(e);A(e)},handleChangeForStepTitle:function(){var e=this;var i=l.getCategoriesForStep(g.getId());var a=e.byId("idStepTitle").getValue().trim();if(t.checkIsNotNullOrUndefinedOrBlank(a)){p.setTextAsPromise(a,v).done(function(t){g.setTitleId(t);if(i.length>1){e.getView().getViewData().updateTree()}else{h(e,a)}N(e,a);l.setIsUnsaved()})}else{l.setIsUnsaved()}},handleSuggestionsForStepTitle:function(e){var t=new sap.apf.modeler.ui.utils.SuggestionTextHandler(p);t.manageSuggestionTexts(e,v)},handleChangeForStepLongTitle:function(){var e=this;var i=e.byId("idStepLongTitle").getValue().trim();if(t.checkIsNotNullOrUndefined(i)){p.setTextAsPromise(i,b).done(function(e){g.setLongTitleId(e);l.setIsUnsaved()})}else{l.setIsUnsaved()}},handleSuggestionsForStepLongTitle:function(e){var t=new sap.apf.modeler.ui.utils.SuggestionTextHandler(p);t.manageSuggestionTexts(e,b)},handleChangeForCategory:function(){var e=this;var t=g.getId();var i=o.arguments.categoryId;var a=l.getCategoriesForStep(g.getId());var r=e.byId("idCategorySelect").getSelectedKeys();var n=r.indexOf(i);var d=[];var s=[];var p,u;for(p=0;p<a.length;p++){var c=false;for(u=0;u<r.length;u++){if(a[p]===r[u]){c=true;break}}if(!c){s.push(a[p])}}if(r.length!==0){r.forEach(function(e){l.addCategoryStepAssignment(e,t);var a={oldContext:{name:o.name,arguments:{configId:o.arguments.configId,categoryId:i,stepId:t}},newContext:{arguments:{configId:o.arguments.configId,categoryId:e}}};if(e!==i){d.push(a)}});a.forEach(function(e){if(r.indexOf(e)===-1){l.removeCategoryStepAssignment(e,g.getId())}});if(s.length!==0){s.forEach(function(e){var a={oldContext:{name:o.name,arguments:{configId:o.arguments.configId,categoryId:i,stepId:t}},newContext:{arguments:{configId:o.arguments.configId,categoryId:e}},removeStep:true};if(n===-1&&e===i){var s={arguments:{appId:o.arguments.appId,configId:o.arguments.configId,categoryId:r[0],stepId:t}};a.categoryChangeContext=s;a.changeCategory=true}d.push(a)})}}if(d.length!==0){e.getView().getViewData().updateTree(d)}l.setIsUnsaved()},handleChangeForDataReductionType:function(){var e=this;if(e.byId("idDataReductionRadioGroup").getSelectedButton()===e.byId("idNoDataReduction")){g.resetTopN();e.setDataReductionSection()}else{f.instantiateStepSortData()}L(e);l.setIsUnsaved()},handleValidationForNumberOfRecords:function(e){var t=e.getSource();var i=t.getValue().trim();var a=i.indexOf("E")!==-1||i.indexOf("e")!==-1||i.indexOf(".")!==-1||i<=0||i>1e4?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.None;t.setValueState(a);l.setIsUnsaved()},handleChangeForNoOfRecords:function(e){var i=this;var a=e.getSource().getValue().trim();if(e.getSource().getValueState()===sap.ui.core.ValueState.Error){return}if(t.checkIsNotNullOrUndefinedOrBlank(a)){if(g.getTopN()===undefined){i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES)}g.setTopNValue(a)}l.setIsUnsaved()},handleFilterMapKeepSource:function(){var e=this;var t=e.byId("idFilterKeepSourceCheckBox").getSelected();g.setFilterMappingKeepSource(t);l.setIsUnsaved()},handleChangeForStepSpecificNavTargets:function(){var e=this;var t=e.byId("idStepSpecificCombo").getSelectedKeys();var i=g.getNavigationTargets();i.forEach(function(e){if(t.indexOf(e)===-1){g.removeNavigationTarget(e)}});t.forEach(function(e){if(i.indexOf(e)===-1){g.addNavigationTarget(e)}});l.setIsUnsaved()},getValidationState:function(){var e=this;return c.getValidationState()&&e.byId("idStepRequestView").getController().getValidationState()&&e.byId("idStepFilterMappingView").getController().getValidationState()},onExit:function(){var e=this;e.byId("idStepCornerTextView").destroy();e.byId("idStepRequestView").destroy();e.byId("idStepFilterMappingView").destroy()}})});
//# sourceMappingURL=step.controller.js.map
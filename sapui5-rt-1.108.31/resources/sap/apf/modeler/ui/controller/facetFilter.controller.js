/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/modeler/ui/utils/textPoolHelper","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/viewValidator","sap/apf/modeler/ui/utils/textManipulator"],function(e,t,i,l,a){"use strict";var n,s,o,d,r,u,c;var t=sap.apf.modeler.ui.utils.nullObjectChecker;var i=sap.apf.modeler.ui.utils.optionsValueModelBuilder;var a=sap.apf.modeler.ui.utils.textManipulator;var f=sap.apf.modeler.ui.utils.TranslationFormatMap.FACETFILTER_LABEL;function I(e){e.byId("idFacetFilterBasicData").setText(s("basicData"));e.byId("idFFLabel").setText(s("ffLabel"));e.byId("idLabel").setPlaceholder(s("newFacetFilter"));e.byId("idFFPropertyLabel").setText(s("ffProperty"));e.byId("idDoNotShowAtRuntimeLabel").setText(s("doNotShowAtRuntime"));e.byId("idSelectionModeLabel").setText(s("ffSelectionMode"));e.byId("idValueHelpLabel").setText(s("valueHelpMode"));e.byId("idVHNone").setText(s("none"));e.byId("idValueHelpRequest").setText(s("valueHelpRequest"));e.byId("idConfigListOfValues").setText(s("configListOfValues"));e.byId("idConfigListOfValuesLabel").setText(s("configListOfValuesLabel"));e.byId("idSingleSelectionMode").setText(s("singleSelection"));e.byId("idMultiSelectionMode").setText(s("multipleSelection"));e.byId("idDefaultValuesTitle").setText(s("vhDefaultValues"));e.byId("idPreselectionModeLabel").setText(s("vhDefaultValueMode"));e.byId("idNoneSelection").setText(s("none"));e.byId("idAutomaticSelection").setText(s("automaticValue"));e.byId("idFixedValue").setText(s("fixedValues"));e.byId("idFunction").setText(s("function"));e.byId("idPreselectionDefaultsLabel").setText(s("vhDefaultValues"));e.byId("idPreselectionFunctionLabel").setText(s("function"));e.byId("idValueHelpTitle").setText(s("valueHelp"));e.byId("idFilterResolutionTitle").setText(s("contextResolution"));e.byId("idUseVHRAsFRRCheckBoxLabel").setText(s("vhCheckBoxLabel"));e.byId("idAriaPropertyForSelection").setText(s("ffSelectionMode"));e.byId("idAriaPropertyForDefaultMode").setText(s("vhDefaultValueMode"));e.byId("idAriaPropertyForVHR").setText(s("valueHelpMode"))}function b(e,t){var i=u.isVisible()?"sap-icon://filter":"sap-icon://hide";var l={id:u.getId(),icon:i};if(t){delete l.icon;l.name=t}e.getView().getViewData().updateSelectedNode(l)}function V(e,t){var i=s("facetFilter")+": "+t;e.getView().getViewData().updateTitleAndBreadCrumb(i)}function p(e){var i;if(n&&n.arguments&&n.arguments.facetFilterId){u=d.getFacetFilter(n.arguments.facetFilterId)}if(!t.checkIsNotUndefined(u)){i=d.createFacetFilter();u=d.getFacetFilter(i);b(e)}}function S(e){var t,i,l,a;var n={oTextReader:s,oConfigurationHandler:o,oConfigurationEditor:d,oParentObject:u,getCalatogServiceUri:e.getView().getViewData().getCalatogServiceUri,oCoreApi:e.getView().getViewData().oCoreApi};t=new sap.ui.controller("sap.apf.modeler.ui.controller.facetFilterVHR");l=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.requestOptions",type:sap.ui.core.mvc.ViewType.XML,id:e.createId("idVHRView"),viewData:n,controller:t});i=new sap.ui.controller("sap.apf.modeler.ui.controller.facetFilterFRR");a=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.requestOptions",type:sap.ui.core.mvc.ViewType.XML,id:e.createId("idFRRView"),viewData:n,controller:i});l.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.UPDATEPROPERTIES,e.setFFProperty.bind(e));a.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.UPDATEPROPERTIES,e.setFFProperty.bind(e));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR,a.getController().handleCopy.bind(a.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS,a.getController().enableOrDisableView.bind(a.getController()));l.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR,a.getController().handleCopy.bind(a.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,l.getController().updateSubViewInstancesOnReset.bind(l.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,a.getController().updateSubViewInstancesOnReset.bind(a.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME,l.getController().clearVHRFields.bind(l.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.CLEARVHRFIELDSIFVALUELIST,l.getController().clearVHRFields.bind(l.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME,a.getController().clearFRRFields.bind(a.getController()));l.addStyleClass("formTopPadding");l.addStyleClass("formBottomPadding");a.addStyleClass("formTopPadding")}function g(e,t){e.byId("idSelectionMode").setVisible(t);e.byId("idSelectionModeLabel").setVisible(t);e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idMultiSelectionMode"));e.byId("idValueHelp").setVisible(t);e.byId("idValueHelpLabel").setVisible(t);e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idVHNone"));e.byId("idFFForm1").setVisible(t);if(t){e.byId("idValueHelpTitle").setText(s("valueHelp"));e.byId("idFRRVBox").insertItem(e.byId("idFRRView"));e.byId("idDoNotShowAtRuntimeCheckBox").setSelected(false)}else{e.byId("idValueHelpTitle").setText("");O(e,t);P(e,t);e.byId("idFRRVBox").removeItem(e.byId("idFRRView"))}}function y(e){if(!u.isVisible()){e.byId("idDoNotShowAtRuntimeCheckBox").setSelected(true)}g(e,u.isVisible())}function F(e){if(!t.checkIsNotNullOrUndefinedOrBlank(d.getFacetFilter(n.arguments.facetFilterId))){return}if(t.checkIsNotNullOrUndefinedOrBlank(u.getLabelKey())&&r.get(u.getLabelKey())){e.byId("idLabel").setValue(r.get(u.getLabelKey()).TextElementDescription)}else{e.byId("idLabel").setValue(u.getId())}}function v(e){if(!t.checkIsNotNullOrUndefinedOrBlank(d.getFacetFilter(n.arguments.facetFilterId))){u.setMultiSelection(true)}if(u.isMultiSelection()){e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idMultiSelectionMode"))}else{e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idSingleSelectionMode"))}}function T(e){e.byId("idPreselectionFunction").setValue("");if(t.checkIsNotNullOrUndefinedOrBlank(u.getPreselectionFunction())){e.byId("idPreselectionFunction").setValue(u.getPreselectionFunction())}}function R(e){var i=false,l=false;if(u.getNoneSelection()){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idNoneSelection"))}else if(t.checkIsNotNullOrUndefinedOrBlank(u.getPreselectionFunction())){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idFunction"));T(e);i=true}else if(t.checkIsNotNullOrUndefinedOrBlank(u.getPreselectionDefaults())){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idFixedValue"));N(e);l=true}else if(u.getAutomaticSelection()){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idAutomaticSelection"))}h(e,i);m(e,l)}function h(e,t){e.byId("idPreselectionFunctionLabel").setVisible(t);e.byId("idPreselectionFunction").setVisible(t);if(t){c.addField("idPreselectionFunction")}else{e.byId("idPreselectionFunction").setValue("");c.removeField("idPreselectionFunction")}}function m(e,t){e.byId("idPreselectionDefaultsLabel").setVisible(t);e.byId("idPreselectionDefaults").setVisible(t);if(t){c.addField("idPreselectionDefaults")}else{c.removeField("idPreselectionDefaults")}}function N(e){e.byId("idPreselectionDefaults").setTokens([]);var i=u.getPreselectionDefaults();if(t.checkIsNotNullOrUndefinedOrBlank(i)){i.forEach(function(t){e.byId("idPreselectionDefaults").addToken(new sap.m.Token({text:t}))})}}function C(e){e.byId("idConfigListOfValuesMultiInput").setTokens([]);var i=u.getValueList();if(t.checkIsNotNullOrUndefinedOrBlank(i)){i.forEach(function(t){e.byId("idConfigListOfValuesMultiInput").addToken(new sap.m.Token({text:t}))})}}function P(e,t){e.byId("idConfigListOfValuesLabel").setVisible(t);e.byId("idConfigListOfValuesMultiInput").setVisible(t);if(t){c.addField("idConfigListOfValuesMultiInput")}else{c.removeField("idConfigListOfValuesMultiInput")}}function O(e,t){e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);E(e,t);if(t){e.byId("idVHRVBox").insertItem(e.byId("idVHRView"))}else{e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.CLEARVHRFIELDSIFVALUELIST);e.byId("idVHRVBox").removeItem(e.byId("idVHRView"))}}function A(e){if(u.getUseSameRequestForValueHelpAndFilterResolution()){e.byId("idUseVHRAsFRRCheckBox").setSelected(true);e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS)}}function L(e){var i=false,l=false;if(t.checkIsNotNullOrUndefinedOrBlank(u.getServiceOfValueHelp())){i=true;e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idValueHelpRequest"))}else if(t.checkIsNotNullOrUndefinedOrBlank(u.getValueList())){C(e);l=true;e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idConfigListOfValues"))}else{e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idVHNone"))}P(e,l);O(e,i)}function E(e,t){if(t===false){e.byId("idUseVHRAsFRRCheckBox").setSelected(false)}e.byId("idUseVHRAsFRRCheckBox").setVisible(t);e.byId("idUseVHRAsFRRCheckBoxLabel").setVisible(t)}function D(e,t){t.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.Warning);t.byId("idPreselectionDefaults").setValueStateText(s(e));t.byId("idPreselectionDefaults").focus()}function x(e,t){var i=new sap.m.Token({text:e});t.addToken(i);d.setIsUnsaved()}function w(e,t){if(e.mEventRegistry.tokenChange===undefined){e.attachTokenChange(t)}}sap.ui.controller("sap.apf.modeler.ui.controller.facetFilter",{onInit:function(){var e=this;var t=e.getView().getViewData();s=t.getText;n=t.oParams;o=t.oConfigurationHandler;r=o.getTextPool();d=t.oConfigurationEditor;if(!d){o.loadConfiguration(n.arguments.configId,function(e){d=e})}c=new sap.apf.modeler.ui.utils.ViewValidator(e.getView());I(e);p(e);S(e);e.setDetailData();c.addFields(["idFFProperty","idLabel"])},onAfterRendering:function(){var e=this;if(e.byId("idLabel").getValue().length===0){e.byId("idLabel").focus()}w(e.byId("idConfigListOfValuesMultiInput"),e.handleTokenChangeForConfigListOfValues.bind(e));w(e.byId("idPreselectionDefaults"),e.handleTokenChangeForPreselectionDefaults.bind(e))},setDetailData:function(){var e=this;y(e);e.setFFProperty();F(e);v(e);R(e);L(e);A(e)},updateSubViewInstancesOnReset:function(e){var t=this;d=e;u=d.getFacetFilter(u.getId());t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,{oConfigurationEditor:d,oParentObject:u})},validateSelectedValues:function(e,t,i){var l={},n=[],o=[],d=[],r=[],u;l=sap.apf.utils.validateSelectedValues(t,i);n=l.invalid;o=l.valid;d=a.addPrefixText(n,s);r=d.concat(i).length!==0?d.concat(i):i;u=d.concat(o).length!==0?d.concat(o):t;return{aValues:r,aSelectedValues:u}},setFFProperty:function(){var e=this;var l=[],a,n;d.getFilterablePropertiesAndParametersAsPromise().done(function(s){l=s;n=u.getProperty();if(t.checkIsNotNullOrUndefinedOrBlank(n)){a=e.validateSelectedValues(e,[n],l);l=a.aValues;n=a.aSelectedValues[0]}var o=i.convert(l);e.byId("idFFProperty").setModel(o);e.byId("idFFProperty").setSelectedKey(n)})},handleChangeForVisibilityAtRuntime:function(){var e=this,t=true;if(e.byId("idDoNotShowAtRuntimeCheckBox").getSelected()){t=false;u.setInvisible();u.setUseSameRequestForValueHelpAndFilterResolution(false);e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME);u.setValueList([]);C(e)}else{u.setVisible()}u.setMultiSelection(true);d.setIsUnsaved();b(e);g(e,t)},handleChangeForProperty:function(){var e=this;var i=e.byId("idFFProperty").getSelectedKey().trim();i=a.removePrefixText(i,s(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));if(t.checkIsNotNullOrUndefinedOrBlank(i)){u.setProperty(i)}d.setIsUnsaved()},handleChangeForLabel:function(){var e=this;var i=e.byId("idLabel").getValue().trim();if(t.checkIsNotNullOrUndefinedOrBlank(i)){r.setTextAsPromise(i,f).done(function(t){u.setLabelKey(t);b(e,i);V(e,i);d.setIsUnsaved()})}else{d.setIsUnsaved()}},handleSuggestions:function(e){var t=new sap.apf.modeler.ui.utils.SuggestionTextHandler(r);t.manageSuggestionTexts(e,f)},handleChangeForSelectionMode:function(){var e=this,t,i;var l=e.byId("idSelectionModeRadioGroup").getSelectedButton();if(l===e.byId("idSingleSelectionMode")){u.setMultiSelection(false);if(e.byId("idPreselectionDefaultsLabel").getVisible()){t=u.getPreselectionDefaults();if(t&&t.length>1){u.setPreselectionDefaults([t[0]]);i=new sap.m.Token({text:t[0]});e.byId("idPreselectionDefaults").setTokens([i]);D("singleToMultipleSelectionWarningMessage",e)}}}else{e.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);u.setMultiSelection(true)}d.setIsUnsaved()},handleChangeForPreselectionMode:function(){var e=this,t=false,i=false,l=false,a=false;switch(e.byId("idPreselectionModeRadioGroup").getSelectedButton()){case e.byId("idAutomaticSelection"):t=true;break;case e.byId("idFunction"):i=true;u.removePreselectionDefaults();break;case e.byId("idFixedValue"):l=true;u.removePreselectionFunction();break;default:a=true}u.setAutomaticSelection(t);u.setNoneSelection(a);N(e);T(e);m(e,l);h(e,i);d.setIsUnsaved()},handleChangeForPreselectionDefaults:function(e){var t=this;t.byId("idPreselectionDefaults").setValue("");t.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);if(!u.isMultiSelection()){if(t.byId("idPreselectionDefaults").getTokens().length<1){t.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);x(e.getParameter("value"),t.byId("idPreselectionDefaults"))}else{D("singleSelectionWarningMessage",t)}}else{x(e.getParameter("value"),t.byId("idPreselectionDefaults"))}},handleTokenChangeForPreselectionDefaults:function(e){var t=this;var i,l=[];var a=t.byId("idPreselectionDefaults").getTokens();t.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);if(e.getParameters().type==="removed"||e.getParameters().type==="added"){for(i=0;i<a.length;i++){l[i]=a[i].getText()}if(u.isMultiSelection()){u.setPreselectionDefaults(l)}else{u.setPreselectionDefaults([l[0]])}if(e.getParameters().type==="removed"){d.setIsUnsaved()}}},handleChangeForPreselectionFunction:function(){var e=this;var i=e.byId("idPreselectionFunction").getValue().trim();u.removePreselectionFunction();if(t.checkIsNotNullOrUndefinedOrBlank(i)){u.setPreselectionFunction(i)}d.setIsUnsaved()},handleChangeForUseVHRAsFRRCheckBox:function(){var e=this;if(e.byId("idUseVHRAsFRRCheckBox").getSelected()){u.setUseSameRequestForValueHelpAndFilterResolution(true)}else{u.setUseSameRequestForValueHelpAndFilterResolution(false)}e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR);d.setIsUnsaved()},handleChangeForValueHelpOption:function(){var e=this,t=false,i=false;switch(e.byId("idValueHelpRadioGroup").getSelectedButton()){case e.byId("idValueHelpRequest"):t=true;u.setValueList([]);break;case e.byId("idConfigListOfValues"):i=true;u.setAlias(undefined);break;default:u.setAlias(undefined);u.setValueList([])}if(u.getUseSameRequestForValueHelpAndFilterResolution()===true){u.setUseSameRequestForValueHelpAndFilterResolution(false);e.byId("idUseVHRAsFRRCheckBox").setSelected(false)}C(e);P(e,i);O(e,t);d.setIsUnsaved()},handleChangeForConfigListOfValues:function(e){var t=this;t.byId("idConfigListOfValuesMultiInput").setValue("");x(e.getParameter("value"),t.byId("idConfigListOfValuesMultiInput"))},handleTokenChangeForConfigListOfValues:function(e){var t=this;var i,l=[];var a=t.byId("idConfigListOfValuesMultiInput").getTokens();if(e.getParameters().type==="removed"||e.getParameters().type==="added"){for(i=0;i<a.length;i++){l[i]=a[i].getText()}u.setValueList(l);if(e.getParameters().type==="removed"){d.setIsUnsaved()}}},getValidationState:function(){var e=this;return c.getValidationState()&&e.byId("idVHRView").getController().getValidationState()&&e.byId("idFRRView").getController().getValidationState()},onExit:function(){var e=this;e.byId("idVHRView").destroy();e.byId("idFRRView").destroy()}})});
//# sourceMappingURL=facetFilter.controller.js.map
/*!
/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/utils/trace"],function(e){"use strict";function t(t){this.type="path";var r=t.instances.messageHandler;var a=t.instances.coreApi;var i=[];var n=[];var s=0;this.destroy=function(){n=[];i.forEach(function(e){e.destroy()});i=[]};this.getFilterInformation=function(){var e=false;var t=[];var r=n[0];i.forEach(function(a,i){if(!e){if(this.stepIsActive(a)){e=true}else{t.push(a.getFilterInformation(r,i))}}}.bind(this));return Promise.all(t).then(function(e){return[].concat.apply([],e)})};this.getSteps=function(){return jQuery.extend(true,[],i)};this.addStep=function(t,r){e.logCall("Path.addStep");i.push(t);this.update(r);e.logReturn("addStep")};this.makeStepActive=function(t){var a=this.stepIsInPath(t);e.log("makeStepActive",", bStepIsInPath",a);r.check(a,"An unknown step can't be an active step.",sap.apf.core.constants.message.code.errorCheckWarning);if(a){if(this.stepIsActive(t)===false){n.push(t)}}};this.makeStepInactive=function(t){var a=this.stepIsActive(t);e.log("makeStepInactive",", bStepIsActive",a);r.check(a,"Only an active step can be removed from the active steps.",sap.apf.core.constants.message.code.errorCheckWarning);if(a){var i=jQuery.inArray(t,n);n.splice(i,1)}};this.stepIsActive=function(e){var t=jQuery.inArray(e,n);return t>=0};this.stepIsInPath=function(e){var t=jQuery.inArray(e,i);return t>=0};this.getActiveSteps=function(){return jQuery.extend(true,[],n)};this.getCumulativeFilterUpToActiveStep=function(){var e=jQuery.Deferred();var t=this;l().done(function(t){if(i.length===0){e.resolve(t)}else{r(0,t,function(t){e.resolve(t)})}});return e.promise();function r(e,a,n){i[e].determineFilter(a.copy(),function(s,o){if(o){a=o}a.addAnd(s);if(t.stepIsActive(i[e])||!i[e+1]){n(a);return}r(++e,a,n)})}};this.moveStepToPosition=function(e,t,a){var n=jQuery.inArray(e,i);var s=t;r.check(typeof t==="number"&&t>=0&&t<i.length,"Path: moveStepToPosition invalid argument for nPosition");r.check(n>=0&&n<i.length,"Path: moveStepToPosition invalid step");if(n===t){return}i.splice(n,1);i.splice(s,0,e);this.update(a)};this.removeStep=function(t,a){e.logCall("Path.removeStep");var n=this.stepIsInPath(t);var s=this.stepIsActive(t);var o=jQuery.inArray(t,i);r.check(n,"Path: remove step - invalid step");i.splice(o,1);if(s){this.makeStepInactive(t)}this.update(a);t.destroy();e.logReturn("removeStep")};this.update=function(t,n){e.logCall("Path.update");if(!i[0]){if(n){e.log("update - fnUpdatePathFinished <<< ");n()}e.logReturn("update");return}var o;var u=i[0];l().done(function(c){e.log("update - @ getContextFilter().done(oContextFilter)");s++;o=s;u.update(c,f);function f(a,n){var f=jQuery.inArray(u,i);e.logCall("Path.update.callbackAfterRequest"," nIndexOfCurrentStep=",f,", nCurrentUpdateCount="+o);var p;if(o===s){if(a instanceof Error){var d=f+1;p=r.createMessageObject({code:"5002",aParameters:[d],callingObject:u});p.setPrevious(a);r.putMessage(p);u.setData({data:[],metadata:undefined},c);t(u,true);f++;u=i[f];while(u){u.setData({data:[],metadata:undefined},c);t(u,true);f++;u=i[f]}e.logReturn("update-callbackAfterRequest");return}if(n){u.setData(a,c)}e.log("update - before fnStepProcessedCallback");t(u,n);if(o!==s){e.logReturn("update-callbackAfterRequest");return}u.determineFilter(c.copy(),l)}e.logReturn("update-callbackAfterRequest")}function l(e,t){if(t){c=t}c=p(c,e,u.getContextInfo());var r=jQuery.inArray(u,i);c.addAnd(e);u=i[r+1];if(u){u.update(c,f)}else{a.storeApfState();c=undefined;if(n){n()}}}});e.logReturn("update")};this.serialize=function(){return{path:{steps:u(),indicesOfActiveSteps:o()}}};this.deserialize=function(e){c(e.path.steps,this);f(e.path.indicesOfActiveSteps,this)};function o(){var e=[];for(var t=0;t<i.length;t++){for(var r=0;r<n.length;r++){if(i[t]===n[r]){e.push(t)}}}return e}function u(){var e=[];for(var t=0;t<i.length;t++){e.push(i[t].serialize())}return e}function c(e,t){var r=t.update;t.update=function(){};var n;for(n=0;n<e.length;n++){a.createStep(e[n].stepId)}for(n=0;n<i.length;n++){i[n].deserialize(e[n])}t.update=r}function f(e,t){for(var r=0;r<e.length;r++){var a=e[r];t.makeStepActive(i[a])}}this.checkAddStep=function(e){var t=jQuery.Deferred();var n=a.getConfigurationObjectById(e);var s=a.getConfigurationObjectById(n.binding).requiredFilters;if(n.type==="hierarchicalStep"&&s&&s.length===1){var o=a.getConfigurationObjectById(n.request);a.getMetadata(o.service).done(function(e){var u=e.getPropertyMetadata(o.entityType,s[0]);if(u["hierarchy-node-for"]===n.hierarchyProperty){i.forEach(function(e){if(e.type==="hierarchicalStep"){var i=e.getBinding().getRequiredFilters();if(i.length===1&&i[0]===s[0]){t.resolve(false,r.createMessageObject({code:5234,aParameters:[n.hierarchyProperty,a.getTextNotHtmlEncoded(e.getAdditionalConfigurationProperties().title.key)],enrichInfoInMessageObject:true}))}}})}if(t.state()==="pending"){t.resolve(true)}})}else{t.resolve(true)}return t.promise()};function l(){var e=jQuery.Deferred();jQuery.when(a.getCumulativeFilter(),a.getSmartFilterBarAsPromise()).done(function(t,a){var i,n,s;var o=t.copy();if(a){i=a.getFilters();i.forEach(function(e){o.addAnd(sap.apf.core.utils.Filter.transformUI5FilterToInternal(r,e))});s=a.getAnalyticalParameters();if(s&&s.length>0){for(n=0;n<s.length;n++){var u=s[n].fieldName;var c=s[n].fieldNameOData;var f=a.getFilters([u]);var l=undefined;if(f&&f.length){if(f[0].oValue1!==undefined){l=f[0].oValue1}else{l=f[0].aFilters[0].oValue1}o.addAnd(new sap.apf.core.utils.Filter(r,c,"EQ",l))}}}}e.resolve(o)});return e}function p(e,r,a){if(t.exits&&t.exits.path&&t.exits.path.beforeAddingToCumulatedFilter){return t.exits.path.beforeAddingToCumulatedFilter(e,r,a)}return e}}sap.apf.core.Path=t;return{constructor:t}},true);
//# sourceMappingURL=path.js.map
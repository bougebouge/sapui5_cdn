/*
 * Copyright(c) 2015 SAP SE
 */
sap.ui.define(["sap/apf/core/utils/filter","sap/apf/core/utils/filterTerm","sap/apf/core/constants","sap/apf/core/messageHandler"],function(r,t,e,i){"use strict";var s={};s.FilterReduction=function(){var i=this;var n=false;this.transformFilter=function(e){var i=[];var n;var o;if(e){e.forEach(function(e){if(e instanceof t){i.push({property:e.getProperty(),values:[e.getValue()]})}else if(e instanceof r){n=e.getProperties();o=new s.CollectPropertiesAndValuesVisitor;o.process(e);i.push({property:n[0],values:o.getValues()})}})}return i};this.intersection=function(r,t){var e={};var i=r.values;var s=t.values;var n=[];var o={};var u,c=i.length;var a,f=s.length;for(u=0;u<c;u++){o[i[u]]=i[u]}for(a=0;a<f;a++){if(o[s[a]]!==undefined&&n.indexOf(s[a])<0){n.push(s[a])}}e.property=r.property;e.values=n;return e};function o(t){this.reducers=[];this.disjunctions=[];this.processTerm=function(i){var s=new r(t,i);if(i.getOp()===e.FilterOperators.EQ){this.disjunctions.push(s)}else{this.reducers.push(s)}};this.processOr=function(r,t,e){var i=new s.CollectPropertiesAndValuesVisitor;i.process(e);if(i.isWellFormed()){this.disjunctions.push(e)}else{this.reducers.push(e)}};this.processAnd=function(r,e,s){var n=i.filterSeparation(s,t);this.disjunctions=this.disjunctions.concat(n.disjunctions);this.reducers=this.reducers.concat(n.reducers)};this.processEmptyFilter=function(){};this.process=function(r){r.traverse(this)}}this.filterSeparation=function(r,t){var e=new s.CollectChildrenOfAndNodeVisitor;var i=e.process(r);var n;if(!i){return{reducers:[],disjunctions:[]}}n=new o(t);i.forEach(function(r){r.traverse(n)});return{reducers:n.reducers,disjunctions:n.disjunctions}};this.simplifyTransforms=function(r){var t=[];var e;var s=[];var n=r.length;var o;r.forEach(function(u,c){var a;o=u.property;if(s.indexOf(o)===-1){s.push(o);e=u;for(a=c+1;a<n;++a){if(o===r[a].property){e=i.intersection(e,r[a])}}t.push(e)}});return t};this.applyStartFilter=function(r,t){var e=[];var i=r.getProperties();t.forEach(function(t){var s=[];var n;var o=t.values.length;var u;if(i.indexOf(t.property)>-1){for(n=0;n<o;n++){u=t.values[n];if(r.isConsistentWithFilter(t.property,u)){s.push(u)}}e.push({property:t.property,values:s})}else{e.push(t)}});return e};this.simplifyInStartFilter=function(r,t){var e=r;t.forEach(function(r){if(e){e=e.removeTermsByProperty(r.property)}});if(e.isEmpty()){return undefined}return e};this.containsContradiction=function(r,t){var e=false;t.forEach(function(r){if(r.values.length===0){e=true}});if(e){return e}return e};this.rebuildDisjunction=function(i,s){var n=new r(i);var o=s.property;var u=s.values;u.forEach(function(r){var s=new t(i,o,e.FilterOperators.EQ,r);n.addOr(s)});return n};this.reduceFilter=function(t,e){var s=this;function o(r){var e=[];r.forEach(function(r){e.push(i.rebuildDisjunction(t,r))});return e}function u(r,t){t.forEach(function(t){r.addAnd(t)})}function c(r,i){var n;var o=i;var u=[];var c;for(n=0;n<r.length;++n){o=s.applyStartFilter(r[n],i);if(s.containsContradiction(t,o)){return{contradiction:e}}c=s.simplifyInStartFilter(r[n],i);if(c){u.push(c)}}return{reducedTransforms:o,simplifiedReducers:u}}var a;var f;var p;var h;var l;var v;if(e.isFilterTerm()||e.isOr()||e.isEmpty()){return e}a=this.filterSeparation(e,t);f=a.disjunctions;p=this.transformFilter(f);h=this.simplifyTransforms(p);if(this.containsContradiction(t,h)){n=true;return e}v=c(a.reducers,h);if(v.contradiction){n=true;return v.contradiction}l=new r(t);u(l,v.simplifiedReducers);u(l,o(v.reducedTransforms));return l};this.isContradicted=function(){return n}};s.CollectPropertiesAndValuesVisitor=function(){var r=this;var i=[];var s=[];var n=true;var o=true;var u=0;var c=0;var a=0;var f=0;function p(r){var t,e=i.length;for(t=0;t<e;t++){if(i[t]===r){return}}i.push(r)}this.getProperties=function(){return i.slice(0)};this.getValues=function(){return s.slice(0)};this.isWellFormed=function(){return n&&o&&i.length<=1};this.isEmptyFilter=function(){return u===0&&c===0&&a>0&&f===0};this.processEmptyFilter=function(){a++};this.processAnd=function(r,t){u++;o=false;this.process(r);this.processAndArray(t)};this.processAndArray=function(t){t.forEach(function(t){r.process(t)})};this.processOr=function(r,t){c++;this.process(r);this.processOrArray(t)};this.processOrArray=function(t){t.forEach(function(t){r.process(t)})};this.processTerm=function(r){f++;var t=r.getProperty();p(t);switch(r.getOp()){case e.FilterOperators.EQ:s.push(r.getValue());return;default:n=false;return}};this.process=function(r){if(r instanceof t){this.processTerm(r)}else{r.traverse(this)}}};s.CollectChildrenOfAndNodeVisitor=function(){this.processEmptyFilter=function(){return null};this.processTerm=function(r){return[r]};this.processAnd=function(r,t){var e=[];e.push(r);t.forEach(function(r){e.push(r)});return e};this.processOr=function(){return null};this.process=function(r){if(r instanceof t){this.processTerm(r)}else{return r.traverse(this)}}};sap.apf.core.utils.FilterReduction=s.FilterReduction;return s},true);
//# sourceMappingURL=filterSimplify.js.map
/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/step","sap/apf/core/utils/uriGenerator","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Sorter","sap/ui/thirdparty/jquery"],function(e,t,r,i,jQuery){"use strict";sap.apf.core.HierarchicalStep=function(e,t,i,a,o){sap.apf.core.Step.call(this,e,t,i,a,o);var n;var s;var p;this.type="hierarchicalStep";var u=i.getConfigurationById(t.request).service;var c=i.getConfigurationById(t.request).entityType;var d=o.getAnnotationsForService(u);var l=t.hierarchyProperty;var g=jQuery.Deferred();var f=i.getConfigurationById(t.binding).requiredFilters;var h=o.getStartParameterFacade().getSapSystem();if(h){u=sap.ui.model.odata.ODataUtils.setOrigin(u,{force:true,alias:h})}jQuery.when(o.getMetadata(u),o.getEntityTypeMetadata(u,c)).then(function(t,r){var a=t.getHierarchyAnnotationsForProperty(c,l);if(a.type==="messageObject"){e.putMessage(a)}else{s=m(l,a)}n=i.createRequest({service:u,entityType:c,selectProperties:y(f[0],t,a),type:"request",id:"SelectionValidationRequest"});g.resolve(t,a,r)});var v=new r(u,{annotationURI:d});function y(e,t,r){var i=[e];var a=t.getPropertyMetadata(c,e)["sap:text"];if(a){i.push(a)}if(r.hierarchyNodeExternalKeyFor){i.push(r.hierarchyNodeExternalKeyFor)}return i}function m(e,r){var a=[e];for(var o in r){a.push(r[o])}a=a.concat(i.getConfigurationById(t.request).selectProperties);return sap.apf.core.utils.uriGenerator.getSelectString(a)}this.update=function(t,r){g.done(function(i,a,o){var u=t.restrictToProperties(i.getFilterablePropertiesAndParameters(c));var d=!u.isEqual(p);p=u.copy();var l="/"+sap.apf.core.utils.uriGenerator.generateOdataPath(e,i,c,t,i.getUriComponents(c).navigationProperty);var g={};g.path=l;var h=t.restrictToProperties(i.getFilterableProperties(c));if(!h.isEmpty()){g.filters=[h.mapToSapUI5FilterExpression()]}g.parameters={select:s,operationMode:sap.ui.model.odata.OperationMode.Server,useServerSideApplicationFilters:true,treeAnnotationProperties:a};g.sorter=this.getSorter();this.getBinding().updateTreetable(g,v,o,d);if(!this.getFilter().isEmpty()&&d){var y=h.removeTermsByProperty(f[0]);n.sendGetInBatch(y.addAnd(this.getFilter()),function(e){var t=e.data;var i=this.getFilter().getFilterTerms();var a=[];i.forEach(function(e){t.forEach(function(t){if(t[f[0]]===e.getValue()){a.push(t)}})});this.getBinding().setFilterValues(a);r({},true)}.bind(this))}else{r({},d)}}.bind(this))};this.getSorter=function(){var e=[];var t=this.getBinding().getRequestOptions();if(t&&t.orderby&&t.orderby.length>0){t.orderby.forEach(function(t){e.push(new sap.ui.model.Sorter(t.property,!t.ascending))})}if(e.length===0){return}return e};this.setData=function(){};this.adjustCumulativeFilter=function(e){if(f[0]&&!this.getFilter().isEmpty()){return e.removeTermsByProperty(f[0])}return e}}});
//# sourceMappingURL=hierarchicalStep.js.map
/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/apf/utils/hashtable","sap/ui/model/odata/v2/ODataModel","sap/ui/model/odata/ODataUtils"],function(e,t,r,a){"use strict";var n=function(t,r){this.type="metadata";var a=this;var n=jQuery.Deferred();var i=[];var s=t&&t.constructors&&t.constructors.Hashtable||s;var o=new s(t.instances.messageHandler);var f=new s(t.instances.messageHandler);var c=new s(t.instances.messageHandler);var u=new s(t.instances.messageHandler);var l=new s(t.instances.messageHandler);var y=new s(t.instances.messageHandler);var h=new s(t.instances.messageHandler);var p=new s(t.instances.messageHandler);var d=new s(t.instances.messageHandler);var v=new s(t.instances.messageHandler);var g=new s(t.instances.messageHandler);var m=new s(t.instances.messageHandler);var E=t.constructors.ODataModel||sap.ui.model.odata.v2.ODataModel;var P=false;if(t.deactivateFatalError){P=true}var I;var S;var O;var H;var b=M(r);function M(e){var r=t.functions.getSapSystem();if(r){return sap.ui.model.odata.ODataUtils.setOrigin(e,{force:true,alias:r})}return e}function D(e){var t;function r(e){if(!t.dataType){t.dataType={}}t.dataType[e]=t[e]}function a(e,r){if(jQuery.isArray(t[r])===true){t[r].forEach(function(e){t[e.name]=e.value})}else if(r!=="dataType"&&typeof t[r]==="object"){if(Object.keys(t[r]).length===0){t[e]="true"}if(r!==e){jQuery.each(t[r],function(r,a){t[e]=a})}}else{t[e]=t[r]}}if(e===null){return{}}t=jQuery.extend(true,{},e);jQuery.each(t,function(e){switch(e){case"type":r(e);break;case"maxLength":r(e);break;case"precision":r(e);break;default:var t=e.split(".").pop();if(t.search("ISO")===0){a(t,e)}else{a(t.replace(/^./,t[0].toLowerCase()),e)}break}});return t}function k(e,t){if(u.hasItem(e)!==true){var r;var a={};var n={allParameters:[],keyParameters:[]};if(C(e)){r=R(e);if(r.key&&r.key.propertyRef){r.key.propertyRef.forEach(function(e){a[e.name]=null})}r.property.forEach(function(e){var t=D(e);t.isKey=a.hasOwnProperty(t.name);n.allParameters.push(t);if(t.isKey){n.keyParameters.push(t)}})}u.setItem(e,n)}if(!t){return u.getItem(e).allParameters}return u.getItem(e).keyParameters}function A(e){var t=[];var r;if(C(e)){e=x(e)}r=R(e);r.property.forEach(function(e){t.push(e.name)});return t}function w(e){var t;if(c.hasItem(e)===true){return c.getItem(e)}var r;var a=[];var n=[];var i=x(e);if(i&&U(i)){var s=R(i);s.property.forEach(function(e){a.push(e.name)})}var o=k(e,false);for(t=0;t<o.length;t++){n.push(o[t].name)}r=a.concat(n);c.setItem(e,r);return r}function T(e){return y.getItem(e)}function j(e){var t=T(e);t=t||T(e+"Results");if(!t&&R(e)){t=e}return t}function F(e){if(f.hasItem(e)===false){var t=[];var r=R(e);r.property.forEach(function(e){if(!(e["sap:filterable"]==="false"||e.filterable&&e.filterable==="true")){t.push(e.name)}});f.setItem(e,t)}return f.getItem(e)}function C(e){return N(e)==="parameters"}function U(e){return N(e)==="aggregate"}function N(e){if(!p.hasItem(e)){var t=R(e);var r=t&&t["sap:semantics"]||"undefined";p.setItem(e,r)}return p.getItem(e)}function q(e,t){if(o.hasItem(e+t)===false){var r=C(e);var a=R(e);var n=I.getODataProperty(a,t);if(!n&&r){var i=x(e);a=R(i);n=I.getODataProperty(a,t)}o.setItem(e+t,D(n))}return o.getItem(e+t)}function x(e){var t=v.getItem(e);if(t){return T(t.toAggregateEntitySet)}return e}function R(e){if(!e){return undefined}if(!m.hasItem(e)){var t=I.getODataEntityType(O+e);if(!t){return t}m.setItem(e,t)}return m.getItem(e)}function K(){var e;S=u();S.attachMetadataLoaded(function(){I=S.getMetaModel();I.loaded().then(function(){if(!S.getServiceMetadata()){e="5018";if(P){e="11013"}t.instances.messageHandler.putMessage(t.instances.messageHandler.createMessageObject({code:e,aParameters:[r],oCallingObject:a}));n.reject();return}s();o();f(S);c();n.resolve(this)}.bind(this))}.bind(this));S.attachMetadataFailed(function(){e="5018";if(P){e="11013"}t.instances.messageHandler.putMessage(t.instances.messageHandler.createMessageObject({code:e,aParameters:[r],oCallingObject:a}));n.reject();return});function s(){var e={};var n=I.getODataEntityContainer()&&I.getODataEntityContainer().entitySet;if(!n){t.instances.messageHandler.putMessage(t.instances.messageHandler.createMessageObject({code:"5041",aParameters:[r],oCallingObject:a}));return}n.forEach(function(t){var r=t.entityType.split(/[. ]+/).pop();y.setItem(t.name,r);h.setItem(r,t.name);if(!e.hasOwnProperty(r)){e[r]=true;i.push(r)}})}function o(){var e=I.getODataEntityContainer()&&I.getODataEntityContainer().entitySet;if(!e){return}var t=e[0].entityType.split(".");t.pop();O=t.join(".")+"."}function f(e){var t=e&&e.getServiceAnnotations();if(t&&t.aliasDefinitions&&t.aliasDefinitions.Capabilities){H=t.aliasDefinitions.Capabilities+"."}}function c(){var e=I.getODataEntityContainer();if(!e||!e.associationSet){return}e.associationSet.forEach(function(e){var t=e.end[0].entitySet,r=e.end[1].entitySet,a,n;if(C(T(t))){a=t}else if(U(T(t))){n=t}if(C(T(r))){a=r}else if(U(T(r))){n=r}if(!a||!n){return}var i;var s=R(T(a));var o;s.navigationProperty.forEach(function(t){if(!o&&t.relationship===e.association){i=t.name;o=true}});if(!i){return}var f={navigationProperty:i,fromParameterEntitySet:a,toAggregateEntitySet:n,fromIsUnique:undefined,toIsUnique:undefined};if(d.hasItem(a)){f.fromIsUnique=false;d.getItem(a).fromIsUnique=false}else{f.fromIsUnique=true;d.setItem(a,f);v.setItem(T(a),f)}if(g.hasItem(n)){g.getItem(n).toIsUnique=false}else{f.toIsUnique=true;g.setItem(n,f)}})}function u(){var e=t.instances.annotationHandler.getAnnotationsForService(r);var a={annotationURI:e,json:true};return new E(b,a)}}this.getEntityTypes=function(){return i};this.getPropertyMetadata=function(e,r){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect EntityType name or type");t.instances.messageHandler.check(r!==undefined&&typeof r==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect sPropertyName name or type");var a=j(e);if(!a){return{}}return q(a,r)};this.getUriComponents=function(e){if(!T(e)){if(T(e+"Results")){return{entitySet:e+"Results",navigationProperty:""}}return null}var r;switch(N(T(e))){case"undefined":return{entitySet:e,navigationProperty:""};case"parameters":r=d.getItem(e);if(!r||r.fromIsUnique===false){return{entitySet:e,navigationProperty:undefined}}return{entitySet:e,navigationProperty:r.navigationProperty};case"aggregate":r=g.getItem(e);if(!r){return{entitySet:e,navigationProperty:""}}if(r.toIsUnique===false){return{entitySet:undefined,navigationProperty:undefined}}return{entitySet:r.fromParameterEntitySet,navigationProperty:r.navigationProperty};default:t.instances.messageHandler.check(false,"metadata : getUriComponents - not handled return value for sap semantics")}};this.getFilterableProperties=function(e){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getFilterableProperties incorrect EntityType name or type");var r=j(e);if(!r){return[]}r=x(r);return F(r)};this.getAllPropertiesOfEntitySet=function(e){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getAllPropertiesOfEntitySet incorrect EntitySet name or type");var r=j(e);if(!r){return[]}return A(r)};this.getAllProperties=function(){var r=[];var a;this.getEntityTypes().forEach(function(e){a=w(e);if(a.length===0){a=A(e)}r=r.concat(a)});r=e.eliminateDuplicatesInArray(t.instances.messageHandler,r);return r};this.getFilterablePropertiesAndParameters=function(){var r=[];var a;var n=this.getEntityTypes();n.forEach(function(e){var t=R(e);t.property.forEach(function(e){if(!(e["sap:filterable"]==="false")&&e["sap:aggregation-role"]==="dimension"){r.push(e.name)}});a=k(e,false);a.forEach(function(e){r.push(e.name)})});return e.eliminateDuplicatesInArray(t.instances.messageHandler,r)};this.getParameterEntitySetKeyPropertiesForService=function(){var r=[];this.getEntityTypes().forEach(function(e){k(e,true).forEach(function(e){r.push(e.name)})});r=e.eliminateDuplicatesInArray(t.instances.messageHandler,r);return r};this.getAllKeys=function(){var r=[];var a=[];this.getEntityTypes().forEach(function(e){var t=R(e);a=[];if(t.key&&t.key.propertyRef){t.key.propertyRef.forEach(function(e){a.push(e.name)})}r=r.concat(a)});r=e.eliminateDuplicatesInArray(t.instances.messageHandler,r);return r};this.getAttributes=function(e){var t=false;var r={};this.getEntityTypes().forEach(function(a){if(!t){r=q(a,e);if(r.name){t=true}}});return r};this.getParameterEntitySetKeyProperties=function(e){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getParameterEntitySetKeyProperties incorrect EntityType name or type");var r=j(e);if(!r){return[]}return k(r,true)};this.getEntityTypeAnnotations=function(e){var r=j(e);t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getEntityTypeAnnotations incorrect EntityType name or type");if(l.hasItem(r)===true){return l.getItem(r)}var a={};i(r,a);var n=x(r);if(n!==r){i(n,a)}l.setItem(r,a);return l.getItem(r);function i(e,t){var r;var a;var n;var i=R(e);for(r in i){if(i.hasOwnProperty(r)){if(r.indexOf(H)!==0){continue}a=r.split(".").pop();a=a.replace(/^./,a[0].toLowerCase());for(n in i[r]){if(i[r].hasOwnProperty(n)){t[a]=i[r][n]}}}}}};this.getEntitySets=function(){var e={};var t=[];var r=I.getODataEntityContainer();if(!r){return[]}if(r.associationSet){r.associationSet.forEach(function(t){var r,a,n;r=j(t.end[0].entitySet);if(!C(r)){return}n=t.end[1].entitySet;a=j(n);if(!C(a)){e[n]=true}})}if(r.entitySet){r.entitySet.forEach(function(r){if(!e[r.name]){t.push(r.name)}})}return t};this.getAllEntitySetsExceptParameterEntitySets=function(){var e=I.getODataEntityContainer();var t=[];if(!e){return[]}if(e.entitySet){e.entitySet.forEach(function(e){var r=T(e.name);if(!C(r)){t.push(e.name)}})}return t};this.getEntitySetByEntityType=function(e){return h.getItem(e)};this.getHierarchyAnnotationsForProperty=function(e,a){var n={};var i=this.getAllPropertiesOfEntitySet(e);if(i.length===0){return t.instances.messageHandler.createMessageObject({code:5072,aParameters:[e,r]})}var s=T(e);var o=x(s);i.forEach(function(e){var t=q(o,e);if(t["hierarchy-node-for"]===a){n.hierarchyNodeFor=e}});if(!n.hierarchyNodeFor){return t.instances.messageHandler.createMessageObject({code:5073,aParameters:[e,r,a]})}i.forEach(function(e){var t=q(o,e);if(t["hierarchy-level-for"]===n.hierarchyNodeFor){n.hierarchyLevelFor=e}else if(t["hierarchy-parent-node-for"]===n.hierarchyNodeFor){n.hierarchyParentNodeFor=e}else if(t["hierarchy-drill-state-for"]===n.hierarchyNodeFor){n.hierarchyDrillStateFor=e}else if(t["hierarchy-node-external-key-for"]===n.hierarchyNodeFor){n.hierarchyNodeExternalKeyFor=e}});return n};this.getHierarchicalEntitySets=function(){var e=[];var t=this.getEntitySets();t.forEach(function(t){var r=L.call(this,t);if(r.entitySet){e.push(r.entitySet)}}.bind(this));return e};this.getHierarchicalPropertiesOfEntitySet=function(e){return L.call(this,e).hierarchyProperties};function L(e){var t={};t.hierarchyProperties=[];var r=T(e);if(!r){return t}var a=x(r);var n=this.getAllPropertiesOfEntitySet(e);n.forEach(function(r){var i=q(a,r);var s=false;var o=false;var f=false;if(i["hierarchy-node-for"]!==undefined){var c=i["hierarchy-node-for"];var u=r;n.forEach(function(e){var t=q(a,e);if(t["hierarchy-level-for"]===u){s=true}else if(t["hierarchy-parent-node-for"]===u){o=true}else if(t["hierarchy-drill-state-for"]===u){f=true}});if(s&&o&&f){t.entitySet=e;t.hierarchyProperties.push(c)}}});return t}this.getNonHierarchicalPropertiesOfEntitySet=function(e){var t=[];var r=T(e);if(!r){return t}var a=x(r);var n=this.getAllPropertiesOfEntitySet(e);var i=L.call(this,e).hierarchyProperties;n.forEach(function(e){var r=q(a,e);if(r["hierarchy-node-for"]===undefined&&r["hierarchy-node-external-key-for"]===undefined&&r["hierarchy-parent-node-for"]===undefined&&r["hierarchy-level-for"]===undefined&&r["hierarchy-drill-state-for"]===undefined&&r["hierarchy-node-descendant-count-for"]===undefined&&i.indexOf(e)===-1){var n=r.name;t.push(n)}});return t};this.getODataModel=function(){return S};this.isInitialized=function(){return n.promise()};K.call(this)};sap.apf.core.Metadata=n;return n},true);
//# sourceMappingURL=metadata.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2013 SAP AG. All rights reserved
 */
sap.ui.define(["sap/landvisz/library","sap/ui/thirdparty/jquery"],function(t,jQuery){"use strict";var n=t.ConnectionLine;var e=function(){};e.init=function(){this.setting={showLog:true,animationSpeed:10};this.initialized=false;this.initialRow=0;this.initialCol=0;this.allConnections=[];this.clvConnections=[];this.sourceDoneList={};this.targetDoneList={};this.nodeDoneList={};this.sourceConnectionMatrix={};this.targetConnectionMatrix={};this.connectionMatrix={};this.topPostions={};this.connectedNodesLayout={};this.svgForConnections=null;this.isConnectionEntity=false;this.isSystemEntity=false};e.hideConnections=function(){if(this.svgForConnections){jQuery(this.svgForConnections.canvas).hide()}};e.getConnectedNodesLayoutTrack=function(t){if(t.length>0){this.allConnections=t;if(jQuery.isEmptyObject(this.connectedNodesLayout)){for(var n=0;n<this.allConnections.length;n++){this.getAllTargets(this.allConnections[n].getSource());this.getAllSources(this.allConnections[n].getSource())}}var e={};e.row=this.initialRow;e.col=this.initialCol;var i;var o;var s=true;for(var r in this.sourceConnectionMatrix){this.connectionMatrix[r]=[];this.connectionMatrix[r].sources=this.sourceConnectionMatrix[r];this.connectionMatrix[r].targets=this.targetConnectionMatrix[r];if(!this.connectedNodesLayout[r]&&s==true){this.connectedNodesLayout[r]=e;i=this.connectionMatrix[r];o=r;s=false}}this.assignIndexToConnectedNodes(i,o)}return this.connectedNodesLayout};e.assignIndexToConnectedNodes=function(t,n){if(t.targets.length>0)this.assignTargetIndex(n);if(t.sources.length>0)this.assignSourceIndex(n)};e.assignTargetIndex=function(t){var n=this.connectionMatrix[t];var e=this.connectedNodesLayout[t].row;var i=this.connectedNodesLayout[t].col;var o;for(var s=0;s<n.targets.length;s++){o=this.connectionMatrix[n.targets[s]];if(s==0)i++;else{e++;if(o&&o.targets.length>0)i=i+o.targets.length-1}var r={};r.row=e;r.col=i;if(!this.connectedNodesLayout[n.targets[s]])this.connectedNodesLayout[n.targets[s]]=r;if(o)this.assignIndexToConnectedNodes(o,n.targets[s])}};e.assignSourceIndex=function(t){var n=this.connectionMatrix[t];var e=this.connectedNodesLayout[t].row;var i=this.connectedNodesLayout[t].col;for(var o=0;o<n.sources.length;o++){if(!this.connectedNodesLayout[n.sources[o]]){i--;e++;var s={};s.row=e;s.col=i;this.connectedNodesLayout[n.sources[o]]=s;if(this.connectionMatrix[n.targets[o]])this.assignIndexToConnectedNodes(this.connectionMatrix[n.targets[o]],n.targets[o])}}};e.getAllTargets=function(t){var n=[];if(!this.sourceDoneList[t]){this.sourceDoneList[t]=true;for(var e=0;e<this.allConnections.length;e++){if(t==this.allConnections[e].getSource()){n.push(this.allConnections[e].getTarget())}}this.targetConnectionMatrix[t]=n}};e.getAllSources=function(t){var n=[];if(!this.targetDoneList[t]){this.targetDoneList[t]=true;for(var e=0;e<this.allConnections.length;e++){if(t==this.allConnections[e].getTarget()){n.push(this.allConnections[e].getSource())}}this.sourceConnectionMatrix[t]=n}};e.getConnectedNodesLayout=function(t){if(t.length>0){this.allConnections=t;if(jQuery.isEmptyObject(this.connectedNodesLayout)){for(var n=0;n<this.allConnections.length;n++){this.getSourceTargetConnections(this.allConnections[n].getSource());this.getTargetSourceConnections(this.allConnections[n].getTarget())}for(var e in this.sourceConnectionMatrix){this.connectionMatrix[e]=jQuery.merge(jQuery.merge([],this.sourceConnectionMatrix[e]),this.targetConnectionMatrix[e])}var i={};i.row=this.initialRow;i.col=this.initialCol;for(var e in this.connectionMatrix){if(this.connectionMatrix[e].length==1){this.connectedNodesLayout[e]=i;this.nodeDoneList[e]=true;if(!this.topPostions[this.initialRow]){this.topPostions[this.initialRow]=[]}this.topPostions[this.initialRow].push(this.initialCol);this.findConnectedNodes(e);break}}}}return this.connectedNodesLayout};e.getAllConnections=function(){if(this.allConnections.length==0){jQuery(this.connectionsData).find("CONNECTION").each(function(){var t=this.parseSingleConnection(jQuery(this));this.allConnections.push(t)})}return this.allConnections};e.parseSingleConnection=function(t){var n={};jQuery(t).children("DATA").each(function(){var t=jQuery(this).attr("property");var e=typeof jQuery(this).attr("value")==="string"?jQuery(this).attr("value").trim():jQuery(this).attr("value")!=null?String(jQuery(this).attr("value")).trim():"";switch(t.toUpperCase()){case"CONNECTION-UUID":n.uuid=e;break;case"CONNECTION-TYPE":n.type=e;break;case"TEXT":n.text=e;break;case"SOURCE-ENTITY-UUID":n.source=e;break;case"TARGET-ENTITY-UUID":n.target=e;break}});return n};e.getSourceTargetConnections=function(t){var n=[];if(!this.sourceDoneList[t]){this.sourceDoneList[t]=true;for(var e=0;e<this.allConnections.length;e++){if(t==this.allConnections[e].getSource()){n.push(this.allConnections[e].getTarget());this.getSourceTargetConnections(this.allConnections[e].getTarget())}}this.sourceConnectionMatrix[t]=n}};e.getTargetSourceConnections=function(t){var n=[];if(!this.targetDoneList[t]){this.targetDoneList[t]=true;for(var e=0;e<this.allConnections.length;e++){if(t==this.allConnections[e].getTarget()){n.push(this.allConnections[e].getSource());this.getTargetSourceConnections(this.allConnections[e].getSource())}}this.targetConnectionMatrix[t]=n}};e.findConnectedNodes=function(t){var n=this.connectionMatrix[t];var e=0;var i=this.connectedNodesLayout[t].row;var o=this.connectedNodesLayout[t].col;var s=[];for(var r=0;r<n.length;r++){if(!this.nodeDoneList[n[r]]){s[e]=n[r];e++}}e=n.length-s.length;for(var r=0;r<s.length;r++){e++;if(e==1){o++}else{if(e==2){if(i!=0){var a=o;var c=i-1;if(n.length>2&&!this.inTopPosition(c,a)){i--}}o++}else if(e>=3){i++}}var l={};l.row=i;l.col=o;this.connectedNodesLayout[s[r]]=l;this.nodeDoneList[s[r]]=true;if(!this.topPostions[i]){this.topPostions[i]=[]}this.topPostions[i].push(o);var h=this.findConnectedNodes(s[r]);i=h}return i};e.inTopPosition=function(t,n){if(this.topPostions[t]){for(var e=0;e<this.topPostions[t].length;e++){if(this.topPostions[t][e]==n){return true}}}return false};e.renderConnections=function(t,n,e){for(var i=0;i<this.allConnections.length;i++){var o=this.allConnections[i];o.sourceEntity=this.getEntity(t,n,this.allConnections[i].getSource());o.targetEntity=this.getEntity(t,n,this.allConnections[i].getTarget());this.clvConnections.push(o)}if(this.clvConnections.length==0)return;var s=this.svgForConnections.append("marker").attr("id","endMarker").attr("viewBox","0 0 10 10").attr("markerWidth",10).attr("markerHeight",3).attr("refX",7).attr("refY",4).attr("orient","auto").attr("markerUnits","strokeWidth");s.append("path").attr("d","M0,0 L10,4 L0,8 z");for(var i=0;i<this.clvConnections.length;i++){this.drawConnection(this.clvConnections[i],e)}};e.getEntity=function(t,n,e){var i;this.isConnectionEntity=false;this.isSystemEntity=false;for(var o=0;o<n.length;o++){i=n[o].getConnectionId();if(e==i)return n[o].$()}for(var o=0;o<t.length;o++){i=t[o].getSystemId();if(e==i)return t[o].$()}};e.drawConnection=function(t,e){var i=t.sourceEntity;var o=t.targetEntity;var s=this.getX(i);var r=this.getY(i);var a=this.getX(o);var c=this.getY(o);var l=t.getSource();var h=t.getTarget();var u=this.connectedNodesLayout[l];var g=this.connectedNodesLayout[h];var d=null;if(g.row==u.row){d=this.svgForConnections.append("line");if(e==n.Arrow){s=s+122;a=a-122;d.attr("marker-end","url(#endMarker)")}d.attr("x1",s);d.attr("y1",r);d.attr("x2",a);d.attr("y2",c);d.attr("stroke","#999");d.attr("stroke-width",2);d.transition().duration(1500).delay(1e3)}else if(g.col==u.col){d=this.svgForConnections.append("line");if(e==n.Arrow){r=r+95;c=c-95;d.attr("marker-end","url(#endMarker)")}d.attr("x1",s);d.attr("y1",r);d.attr("x2",a);d.attr("y2",c);d.attr("stroke","#999");d.attr("stroke-width",2);d.transition().duration(1500).delay(1e3)}else if(g.col>u.col){if(g.row<u.row){d=this.svgForConnections.append("line");if(e==n.Arrow){s=s+95;d.attr("marker-end","url(#endMarker)")}d.attr("x1",s);d.attr("y1",r);d.attr("x2",a);d.attr("y2",r);d.attr("stroke","#999");d.attr("stroke-width",2);d.transition().duration(1500).delay(1e3);d=this.svgForConnections.append("line");if(e==n.Arrow){c=c+95;d.attr("marker-end","url(#endMarker)")}d.attr("x1",a);d.attr("y1",r);d.attr("x2",a);d.attr("y2",c);d.attr("stroke","#999");d.attr("stroke-width",2);d.transition().duration(1500).delay(1e3)}else{d=this.svgForConnections.append("line");if(e==n.Arrow){r=r+95;d.attr("marker-end","url(#endMarker)")}d.attr("x1",s);d.attr("y1",r);d.attr("x2",s);d.attr("y2",c);d.attr("stroke","#999");d.attr("stroke-width",2);d.transition().duration(1500).delay(1e3);d=this.svgForConnections.append("line");if(e==n.Arrow){a=a-122;d.attr("marker-end","url(#endMarker)")}d.attr("x1",s);d.attr("y1",c);d.attr("x2",a);d.attr("y2",c);d.attr("stroke","#999");d.attr("stroke-width",2);d.transition().duration(1500).delay(1e3)}}else{d=this.svgForConnections.append("line");d.transition();d.attr("x1",s);d.attr("y1",r);d.attr("x2",a);d.attr("y2",r);d.attr("marker-end","url(#endMarker)");d.attr("stroke","#999");d.attr("stroke-width",2);d.transition().duration(1500).delay(1e3);d.attr("x1",s);d=this.svgForConnections.append("line");d.transition();d.attr("x1",a);d.attr("y1",r);d.attr("x2",a);d.attr("y2",c);d.attr("marker-end","url(#endMarker)");d.attr("stroke","#999");d.attr("stroke-width",2);d.transition().duration(1500).delay(1e3)}};e.getX=function(t){var n=parseInt(t.css("left"));var e=t[0].clientWidth;return n+e/2};e.getY=function(t){var n=parseInt(t.css("top"));var e=t[0].clientHeight;return n+e/2};e.getTargetXMiddle=function(t){var n=parseInt(t.css("left"));var e=t.outerWidth();if(t.hasClass("clv_entity_container")){return n+26+(e-26)/2}else if(t.hasClass("networkConnectionEntity")){var i=parseInt(t.parent().css("left"));return i+n+e/2}else{return null}};e.getTargetYCenter=function(t){var n=parseInt(t.css("top"));var e=t.outerHeight();if(t.hasClass("clv_entity_container")){return n+32+(e-32)/2}else if(t.hasClass("networkConnectionEntity")){var i=parseInt(t.parent().css("top"));return i+n+e/2}else{return null}};e.showConnections=function(){if(this.svgForConnections){jQuery(this.svgForConnections.canvas).show()}};e.destroyConnections=function(){if(this.svgForConnections){this.svgForConnections.canvas.remove();this.svgForConnections=null}};e.getConnectedNodes=function(t){var n=[];for(var e=0;e<this.allConnections.length;e++){if(t==this.allConnections[e].source){n.push(this.allConnections[e].target)}else if(t==this.allConnections[e].target){n.push(this.allConnections[e].source)}}return n};e.deinitialize=function(){if(this.initialized){if(this.svgForConnections){this.svgForConnections.canvas.remove();this.svgForConnections=null}this.allConnections=[];this.clvConnections=[];this.sourceDoneList={};this.targetDoneList={};this.nodeDoneList={};this.sourceConnectionMatrix={};this.targetConnectionMatrix={};this.connectionMatrix={};this.topPostions={};this.connectedNodesLayout={};this.initialized=false}};e.getBoxViewConnectedNodesLayout=function(t){var n={};var e=[];var i={};if(t.length>0){this.allConnections=t;for(var o=0;o<this.allConnections.length;o++){var s=false;for(var r in n){if(this.allConnections[o].getSource()==r){s=true;break}}if(!s){n[this.allConnections[o].getSource()]={}}}for(var r in n){var a=[];for(var c=0;c<this.allConnections.length;c++){if(r==this.allConnections[c].getSource()){var l=[];for(var h=0;h<this.allConnections.length;h++){if(this.allConnections[c].getTarget()==this.allConnections[h].getTarget())l.push(this.allConnections[h].getSource())}var u={};if(l.length>1){if(e.length>0){var g=false;for(var o=0;o<e.length;o++){for(var d in e[o]){if(this.allConnections[c].getTarget()==d){g=true}}if(g){break}}if(!g){u[this.allConnections[c].getTarget()]=l;e.push(u)}}else{u[this.allConnections[c].getTarget()]=l;e.push(u)}}else{u[this.allConnections[c].getTarget()]={};a.push(u)}}}n[r].secondLevelEntities=a}i.maxColumnCount=0;for(var r in n){var a=n[r].secondLevelEntities;i[r]={};i[r].row=this.initialRow;i[r].col=this.initialCol;i[r].colspan=a.length>0?a.length:1;for(var o=0;o<a.length;o++){for(var d in a[o]){i[d]={};i[d].row=this.initialRow+1;i[d].col=this.initialCol+o}}this.initialCol+=i[r].colspan}i.thirdLevelEntitiesCount=e.length;for(var o=0;o<e.length;o++){for(var r in e[o]){i[r]={};i[r].row=this.initialRow+2;i[r].col=0;if(e[o][r].length==2){var f=i[e[o][r][0]].col;var C=i[e[o][r][0]].col+i[e[o][r][0]].colspan-1;var v=i[e[o][r][1]].col;var p=i[e[o][r][1]].col+i[e[o][r][1]].colspan-1;if(f<v){i[r].col=(C+v)/2}else{i[r].col=(p+f)/2}}else{for(var c=0;c<e[o][r].length;c++){var y=i[e[o][r][c]].col+i[e[o][r][c]].colspan-1;if(i[r].col<y)i[r].col=y}i[r].col=i[r].col/2}}}i.maxColumnCount=this.initialCol}return i};return e},true);
//# sourceMappingURL=Connection.js.map
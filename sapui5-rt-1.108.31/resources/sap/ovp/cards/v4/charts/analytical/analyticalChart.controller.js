sap.ui.define(["sap/ovp/cards/v4/generic/Card.controller","sap/ovp/cards/v4/charts/VizAnnotationManager","sap/viz/ui5/data/FlattenedDataset","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/app/resources","sap/base/util/each","sap/ovp/cards/ovpLogger","sap/ovp/cards/Filterhelper","sap/ovp/cards/v4/charts/Utils","sap/ovp/filter/FilterUtils","sap/ui/core/Fragment","sap/ui/core/Core","sap/ui/Device","sap/ui/dom/units/Rem","sap/ovp/cards/charts/OVPChartFormatter"],function(t,e,a,i,r,s,o,n,d,l,h,g,p,u,v){"use strict";var c=new o("OVP.v4.analytical.analyticalChart");return t.extend("sap.ovp.cards.charts.v4.analytical.analyticalChart",{onInit:function(){t.prototype.onInit.apply(this,arguments);var e=this;this.eventhandler=function(t,a,i){l.applyFiltersToV4AnalyticalCard(i,e)};this.GloabalEventBus=g.getEventBus();if(this.oMainComponent&&(this.oMainComponent.isMacroFilterBar||this.oMainComponent.oGlobalFilter)){this.GloabalEventBus.subscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",e.eventhandler)}v.registerCustomFormatters();this.iPreviousRowSpan=0},onBeforeRendering:function(){if(this.bCardProcessed){return}e.validateCardConfiguration(this);var t=this.getView().byId("analyticalChart");var i=this.getOwnerComponent().getComponentData();if(t){t.setHeight("21rem")}if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"&&i&&i.appComponent){var r=i.appComponent.getDashboardLayoutUtil();var s=r.dashboardLayoutModel.getCardById(i.cardId);if(s.dashboardLayout.autoSpan&&t){t.setHeight("21rem")}}var o=this.getView().byId("vbLayout");var n;var d=false;var l=new a({data:{path:"/"}});this.isVizPropSet=d;this.oDataSet=l;this.vizFrame=t;this.vbLayout=o;if(!t){c.error(e.constants.ERROR_NO_CHART+": ("+this.getView().getId()+")")}else{this.vbLayout.setBusy(true);n=t.getModel("ovpCardProperties").getProperty("/navigation");if(n===undefined||n=="datapointNav"||n!="headerNav"){e.getSelectedDataPoint(t,this)}t.destroyDataset();var g=t.getParent().getBinding("data");this._handleKPIHeader();if(g&&g.getPath()){g.attachDataReceived(this.onDataReceived.bind(this));g.attachDataRequested(this.onDataRequested.bind(this))}else{h.load("sap.ovp.cards.charts.generic.noData").then(function(t){var e=this.getCardContentContainer();e.removeAllItems();e.addItem(t)}.bind(this))}t.addEventDelegate({onmouseover:function(){var e=t._oOvpVizFrameTooltip;if(e){e._oPopup.close()}}})}this.bCardProcessed=true},onAfterRendering:function(){t.prototype.onAfterRendering.apply(this,arguments);if(!i.checkIfAPIIsUsed(this)&&this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var e=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var a=this.oDashboardLayoutUtil.getCardDomId(this.cardId);var r=document.getElementById(a);var s=this.getHeaderHeight();if(!e.dashboardLayout.autoSpan){if(r){var o=r.getElementsByClassName("sapOvpWrapper")[0];if(o){o.style.height=e.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(s+2*this.oDashboardLayoutUtil.CARD_BORDER_PX)+"px"}}}if(e.dashboardLayout.showOnlyHeader){r.classList.add("sapOvpMinHeightContainer")}var d=this.getView().byId("analyticalChart");if(d){d.setHeight(this._calculateVizFrameHeight()+"px");this._calculateWidth()}}if(!i.checkIfAPIIsUsed(this)){var h=this.getCardPropertiesModel();var g=this.getOwnerComponent().getModel("ui").getData().cards;var p=this.getEntitySet()&&this.getEntitySet()["$Type"];var u=p&&this.getMetaModel().getContext("/"+p);if(u){this.selectionVaraintFilter=n.getSelectionVariantFilters(g,h,this.getEntityType())}var v=this.oCardComponentData.mainComponent;var c=[];if(v.getGlobalFilter()){c=v.oGlobalFilter.getFilters()}if(v.getMacroFilterBar()){c=v.aFilters}l.applyFiltersToV4AnalyticalCard(c,this)}},onDataReceived:function(t){if(d.checkIfDataExistInEvent(t)){var a=this;var i=this.getView().byId("analyticalChart");var o=this.getView().byId("bubbleText");var n=this.getView().byId("ovpCT");var l=r.getText("BUBBLESIZE");var h=a.getMetaModel().getData()["$Annotations"];this.oDataSet.bindData("analyticalmodel>/","");i.setDataset(this.oDataSet);var g=i.getParent();if(!this.isVizPropSet){e.buildVizAttributes(i,g,n,this);this.isVizPropSet=true;if(o!=undefined){var u=i.getFeeds();s(u,function(t,e){if(u[t].getUid()=="bubbleWidth"){o.setText(l+" "+u[t].getValues())}})}e.hideDateTimeAxis(i)}if(this.getCardPropertiesModel()&&this.getCardPropertiesModel().getData()&&this.getCardPropertiesModel().getData().colorPalette&&i.getVizType()==="stacked_column"){var v=i.getDataset().getDimensions(),c=i.getFeeds(),y,b;for(var f=0;f<c.length;f++){if(c[f].getUid()==="color"){y=c[f].getValues()[0];break}}for(var C=0;C<v.length;C++){if(v[C].getName()===y){b=v[C];break}}if(y&&b){var V={};V["bDescending"]=true;b.setSorter(V)}}var P=this.getView().byId("ovpUoMTitle");var m=t?t.getSource().getCurrentContexts().map(function(t){return t&&t.getObject()}):null;e.setChartUoMTitle(i,m,P,h);if(this.bFlag==true){this.bFlag=false;this.vbLayout.setBusy(false)}else{setTimeout(function(){a.vbLayout.setBusy(false)},0)}e.checkNoData(t,this.getCardContentContainer(),i);if(p.system.phone){if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var D=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var I=Math.max(D.dashboardLayout.rowSpan,this.iPreviousRowSpan);this.iPreviousRowSpan=I}if(d.isDataSetEmpty(t)){i.setHeight(50+"px")}else{var L=this._calculateVizFrameHeight();if(L!==undefined&&typeof L==="number"){i.setHeight(L+"px")}}}}},onDataRequested:function(){this.vbLayout.setBusy(true)},getCardItemsBinding:function(){var t=this.getView().byId("analyticalChart");if(t&&t.getParent()){return t.getParent().getBinding("data")}return null},resizeCard:function(t){var a=this.getCardPropertiesModel();this.newCardLayout=t;a.setProperty("/cardLayout/rowSpan",t.rowSpan);a.setProperty("/cardLayout/colSpan",t.colSpan);var i=this.getCardPropertiesModel().getProperty("/cardLayout");var o=this.getHeaderHeight();var n=this.getView().getDomRef().querySelectorAll(".sapOvpWrapper");for(var d=0;d<n.length;d++){n[d].style.height=t.rowSpan*i.iRowHeightPx+2-(o+2*i.iCardBorderPx)+"px"}var l=this.getView().byId("analyticalChart");var h=this.getView().byId("bubbleText");var g=this.getView().byId("ovpCT");if(l){if(l.getVizType()==="timeseries_bubble"||l.getVizType()==="bubble"){if(i.colSpan>1){h.setVisible(false)}else{h.setVisible(true)}}l.setHeight(this._calculateVizFrameHeight()+"px");this._calculateWidth()}var p=this.getView().byId("ovpCardContentContainer").getDomRef();if(p){if(!t.showOnlyHeader){p.classList.remove("sapOvpContentHidden")}else{p.classList.add("sapOvpContentHidden")}}var u=r.getText("BUBBLESIZE");this.oDataSet.bindData("analyticalmodel>/","");this.vizFrame.setDataset(this.oDataSet);var v=l.getParent();if(!this.isVizPropSet){e.buildVizAttributes(l,v,g,this);this.isVizPropSet=true;if(h!=undefined){var c=l.getFeeds();s(c,function(t,e){if(c[t].getUid()=="bubbleWidth"){h.setText(u+" "+c[t].getValues())}})}e.hideDateTimeAxis(l)}e.reprioritizeContent(this.newCardLayout,l)},_calculateVizFrameHeight:function(){var t;if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var e=this.getView().byId("analyticalChart");var a=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var i=this.getView().getController();var r=this.getItemHeight(i,"toolbar");var s=this.getHeaderHeight();var o=this.getView().byId("ovpCT")?24:0;var n=(e.getVizType()==="timeseries_bubble"||e.getVizType()==="bubble")&&a.dashboardLayout.colSpan===1?43:0;var d=p.system.phone&&this.iPreviousRowSpan>0?this.iPreviousRowSpan:a.dashboardLayout.rowSpan;t=d*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(s+2*this.oDashboardLayoutUtil.CARD_BORDER_PX+r+o+n+30);var l=e.getVizType();var h=e.sId;if(l==="donut"){var g=this._calculateVizLegendGroupHeight(t);var v=this.getView().byId(h);if(v){v.setVizProperties(g)}}}else{t=u.toPx(21)}return t},_calculateVizLegendGroupHeight:function(t){var e;if(t<=300){e=.1}else if(t>=400){e=.4}else{e=.3}var a={legendGroup:{layout:{height:e}}};return a},_calculateWidth:function(){var t=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var e=this.getView().byId("analyticalChart");if(t){var a=parseInt(t.dashboardLayout.width,10);var i=e.getVizType();var r=e.sId;if(i==="donut"){var s=this._calculateVizLegendGroupWidth(a);var o=this.getView().byId(r);if(o){o.setVizProperties(s)}}}},_calculateVizLegendGroupWidth:function(t){var e;if(t<=600){e=.25}else if(t<=900){e=.55}else if(t>=1200){e=.7}else{e=.65}var a={legendGroup:{layout:{maxWidth:e}}};return a},refreshCard:function(){this.getView().rerender()}})});
//# sourceMappingURL=analyticalChart.controller.js.map
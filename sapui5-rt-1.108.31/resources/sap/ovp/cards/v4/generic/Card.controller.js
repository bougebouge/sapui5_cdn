sap.ui.define(["sap/ui/core/mvc/Controller","sap/ovp/cards/ActionUtils","sap/fe/navigation/SelectionVariant","sap/fe/navigation/PresentationVariant","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/ResizeHandler","sap/ui/core/format/NumberFormat","sap/ovp/cards/v4/V4AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/m/MessageBox","sap/ui/generic/app/navigation/service/NavError","sap/ui/core/CustomData","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/generic/app/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/ui/events/KeyCodes","sap/base/util/isPlainObject","sap/base/util/merge","sap/ovp/cards/ovpLogger","sap/ovp/cards/jUtils","sap/base/util/isEmptyObject","sap/ovp/cards/Filterhelper","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/util/openWindow","sap/ui/core/Component","sap/ovp/placeholder/placeholderHelper","sap/ui/core/library"],function(e,t,a,i,r,n,o,s,l,d,p,c,v,g,h,f,u,m,C,jQuery,y,b,P,I,S,D,N,w,O,k,T,A,E,V){"use strict";var F=V.TextDirection;var x=new D("OVP.generic.Card");return e.extend("sap.ovp.cards.v4.generic.Card",{initKeyboardNavigation:function(){var e=function(e){this.init(e)};e.prototype.layoutItemFocusHandler=function(){var e=jQuery(document.activeElement);if(e){var t=e.find("[aria-label]");var a,i="";if(e.find(".valueStateText").length==1){var r=e.find(".valueStateText").find(".sapMObjectNumberText").text();var n=e.find(".valueStateText").find(".sapUiInvisibleText").text();e.find(".valueStateText").attr("aria-label",r+" "+n);e.find(".valueStateText").attr("aria-labelledby","")}e.find("[role='listitem']").attr("aria-label","");if(e.hasClass("sapOvpCardHeader")&&!e.hasClass("sapOvpStackCardContent")){var o="";var s=e.find(".cardHeaderType");if(s.length===0){var l=y.getText("CardHeaderType");o="cardHeaderType_"+(new Date).getTime();var d='<div id="'+o+'" class="cardHeaderType" aria-label="'+l+'" hidden></div>';e.append(d)}else{o=s[0].id}i+=o+" "}for(a=0;a<t.length;a++){if(t[a].getAttribute("role")==="heading"){i+=t[a].id+" "}}if(e.hasClass("sapOvpCardHeader")){var p=e.find(".cardHeaderText");if(p.length!==0){for(var a=0;a<p.length;a++){if(i.indexOf(p[a].id)===-1){i+=p[a].id+" "}}}}if(i.length){e.attr("aria-labelledby",i)}if(e.prop("nodeName")==="LI"&&e.find(".linkListHasPopover").length!==0){if(e.find("#hasDetails").length===0){e.append("<div id='hasDetails' hidden>"+y.getText("HAS_DETAILS")+"</div>");e.attr("aria-describedby","hasDetails")}}var c=e.attr("id");if(c&&c.indexOf("ovpTable")!=-1&&e.find("[role='Link']")&&!e.hasClass("sapUiCompSmartLink")){var v=e.closest("td").attr("data-sap-ui-column"),g=e.closest("tbody").siblings().children().filter("tr").children();for(var a=0;a<g.length;a++){if(g[a].getAttribute("data-sap-ui")==v&&g[a].hasChildNodes("span")){var h=g[a].firstElementChild.getAttribute("id");e.attr("aria-labelledby",h)}}}}};e.prototype.init=function(e){this.cardLayout=e;this.keyCodes=P;this.jqElement=jQuery(e.getView().$());this.jqElement=this.jqElement.parent().parent().parent();this.jqElement.on("focus.keyboardNavigation",this.layoutItemFocusHandler.bind(this))};this.keyboardNavigation=new e(this)},onInit:function(){this.oCardComponent=this.getOwnerComponent();this.oCardComponentData=this.oCardComponent&&this.oCardComponent.getComponentData();this.oMainComponent=this.oCardComponentData&&this.oCardComponentData.mainComponent;this.sCardId=this.oCardComponentData.cardId;var e=this.getView().mPreprocessors.xml[0].ovpCardProperties.oData.state;if(e!=="Error"){var t=this.getView().byId("ovpCardHeader");if(!!t){t.attachBrowserEvent("click",this.onHeaderClick.bind(this));t.addEventDelegate({onkeydown:function(e){if(!e.shiftKey&&e.keyCode==13){e.preventDefault();this.onHeaderClick(e)}else if(!e.shiftKey&&e.keyCode==32){e.preventDefault()}}.bind(this)});t.addEventDelegate({onkeyup:function(e){if(!e.shiftKey&&e.keyCode==32){e.preventDefault();this.onHeaderClick(e)}}.bind(this)})}}var a=this.getView().byId("kpiNumberValue");if(a){a.addEventDelegate({onAfterRendering:function(){var e=a.$();var t=e.find(".sapMNCValueScr");var i=e.find(".sapMNCScale");t.attr("aria-label",t.text());i.attr("aria-label",i.text());var r=this.getView().byId("ovpCardHeader").getDomRef();var n=this.getOwnerComponent().getComponentData();if(!!n&&!!n.appComponent){var o=n.appComponent;if(!!o.getModel("ui")){var s=o.getModel("ui");if(!!s.getProperty("/containerLayout")&&s.getProperty("/containerLayout")==="resizable"){var l=n.appComponent.getDashboardLayoutUtil();if(!!l){l.setKpiNumericContentWidth(r)}}}}}.bind(this)})}},exit:function(){if(this.resizeHandlerId){o.deregister(this.resizeHandlerId)}},onExit:function(){var e=this;this.GloabalEventBus.unsubscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",e.eventhandler)},onAfterRendering:function(){var e=this.getView().byId("ovpCardHeader");var t=e&&e.getDomRef();var a=this.getView().byId("ovpHeaderTitle"),i=this.getView().byId("ovpQuickviewCardHeader");if(t&&!t.getAttribute("ariaLabelledBy")){if(a&&a.getText()){var r=a.getDomRef().getAttribute("id");t.setAttribute("arialabelledby",r)}else if(i&&i.getText()){var s=i.getDomRef().getAttribute("id");t.setAttribute("arialabelledby",s)}}var l=this.getCardPropertiesModel();this.enableClick=true;var d=l.getProperty("/contentFragment");var p=this.getOwnerComponent().getComponentData();var c=l.getProperty("/selectedKey");var v=this.getCardItemsBinding();if(!v&&E.hidePlaceholderNeeded()){E.hidePlaceholder()}if(c&&l.getProperty("/state")!=="Loading"){var g=this.getView().byId("ovp_card_dropdown");if(g){g.setSelectedKey(c)}}try{var p=this.getOwnerComponent().getComponentData();if(p&&p.appComponent){var h=p.appComponent;if(h.getModel("ui")){var f=h.getModel("ui");if(f.getProperty("/containerLayout")==="resizable"){var u=h.getDashboardLayoutUtil();if(u){this.oDashboardLayoutUtil=u;this.cardId=p.cardId;if(u.isCardAutoSpan(p.cardId)){this.resizeHandlerId=o.register(this.getView(),function(e){x.info("DashboardLayout autoSize:"+e.target.id+" -> "+e.size.height);u.setAutoCardSpanHeight(e)})}}}}}}catch(e){x.error("DashboardLayout autoSpan check failed.")}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var m=jQuery("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>m.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height())}}var C=0;if(p&&p.mainComponent){var y=p.mainComponent;if(y.bGlobalFilterLoaded){C=!this.checkHeaderNavForChart()&&this.checkNavigation()}}else if(n.checkIfAPIIsUsed(this)){C=this.checkAPINavigation()}var b=this.getCardPropertiesModel();var P=b.getProperty("/state");if(P!=="Loading"&&P!=="Error"){var I=b.getProperty("/template");if(I==="sap.ovp.cards.stack"){if(!C){var S=this.getView().byId("ViewAll");if(S){S=S.getDomRef();S.parentNode.removeChild(S)}}}}var D=false;if(C){if(d?d!=="sap.ovp.cards.quickview.Quickview":true){if(d==="sap.ovp.cards.stack.Stack"){var w=this.getView().getDomRef();var O=w.querySelectorAll(".sapOvpCardContentRightHeader");if(O.length!==0){N.addClassToAllElements(O,"sapOvpCardNavigable")}}else{this.getView().addStyleClass("sapOvpCardNavigable")}}if(d&&d==="sap.ovp.cards.quickview.Quickview"){var k=this.byId("ovpCardHeader");if(k){k.addStyleClass("sapOvpCardNavigable")}}D=true}else{if(d){this.getView().addStyleClass("ovpNonNavigableItem");var k=this.byId("ovpCardHeader");if(k){k.$().removeAttr("role");k.addStyleClass("ovpNonNavigableItem")}var T=this.checkLineItemNavigation();if(!T){switch(d){case"sap.ovp.cards.v4.list.List":var A=this.getView().byId("listItem");if(A){A.setType("Inactive")}break;case"sap.ovp.cards.v4.table.Table":var A=this.getView().byId("tableItem");if(A){A.setType("Inactive")}break;case"sap.ovp.cards.v4.linklist.LinkList":if(!this.checkNavigationForLinkedList()){var A=this.getView().byId("ovpCLI");if(A){A.setType("Inactive")}}break}}else if(T&&(d==="sap.ovp.cards.list.List"||d==="sap.ovp.cards.table.Table")){D=true}if(d==="sap.ovp.cards.charts.analytical.analyticalChart"&&this.checkNavigation()){D=true}}}if(!D){var V=this.getView().byId("sapOvpCardInsights");if(V&&V.getVisible()){V.setVisible(false)}}var F=this.getView().byId("ovp_card_dropdown");var L=this.getView().byId("ovp_card_dropdown_label");if(F){F.addAriaLabelledBy(L.getId())}if(n.checkIfAPIIsUsed(this)){this.initKeyboardNavigation()}this._handleCountHeader();this._handleKPIHeader()},checkNavigation:function(){var e=this.getCardPropertiesModel();var t=this.getEntityType();if(t){if(e){var a=e.getProperty("/identificationAnnotationPath");var i=a;var r=e.getProperty("/contentFragment");if(r&&(r==="sap.ovp.cards.stack.Stack"||r==="sap.ovp.cards.quickview.Quickview")){var n=a?a.split(","):[];if(n&&n.length>1){if(r==="sap.ovp.cards.stack.Stack"){i=n[0]}else{i=n[1]}}}var o=t["@"+i];if(this.isNavigationInAnnotation(o)){return 1}if(e&&e.getProperty("/template")==="sap.ovp.cards.charts.analytical"){var s=e.getProperty("/kpiAnnotationPath");if(t&&s){var l=t[s];if(l&&l.Detail){var d=l.Detail.SemanticObject&&l.Detail.SemanticObject.String;var p=l.Detail.Action&&l.Detail.Action.String;if(d&&p){return 1}}}}}}else if(e&&e.getProperty("/template")==="sap.ovp.cards.v4.linklist"&&e.getProperty("/staticContent")&&e.getProperty("/targetUri")){return 1}return 0},checkNavigationForLinkedList:function(){if(this.getEntityType()){var e=this.getEntityType();var t=e["com.sap.vocabularies.UI.v1.LineItem"];if(t&&(t[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||t[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl")){return true}}return false},checkLineItemNavigation:function(){if(this.getEntityType()){var e=this.getEntityType();var t=this.getCardPropertiesModel();if(t){var a=t.getProperty("/annotationPath");var i=e["@"+a];return this.isNavigationInAnnotation(i)}}},isNavigationInAnnotation:function(e){if(e&&e.length){for(var t=0;t<e.length;t++){var a=e[t];if(a.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||a.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"||a.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return 1}}}return 0},checkAPINavigation:function(){var e=this.getOwnerComponent().getComponentData(),t=e.fnCheckNavigation&&typeof e.fnCheckNavigation==="function",a=t?e.fnCheckNavigation:null;if(a){if(a()){return true}}else{if(!this.checkHeaderNavForChart()&&this.checkNavigation()){return true}}return false},onHeaderClick:function(e){var t=e.ctrlKey||e.metaKey?b.constants.explace:b.constants.inplace;if(n.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){r.onHeaderClicked()}}else{var a=this.getCardPropertiesModel();var i=a.getProperty("/template");var o=a.getProperty("/targetUri");if(i=="sap.ovp.cards.v4.linklist"&&a.getProperty("/staticContent")!==undefined&&o){window.location.href=o}else if(a.getProperty("/staticContent")!==undefined&&o===""){return}else if(this.checkHeaderNavForChart()){return}else{this.doNavigation(this.getView().getBindingContext(),null,t)}}},checkHeaderNavForChart:function(){var e=this.getCardPropertiesModel();var t=e.getProperty("/template");var a=e.getProperty("/navigation");if(a=="noHeaderNav"&&(t=="sap.ovp.cards.charts.analytical"||"sap.ovp.cards.charts.smart.chart")){return true}else{return false}},resizeCard:function(e){x.info(e);if(this.resizeHandlerId){o.deregister(this.resizeHandlerId);this.resizeHandlerId=null}},_handleCountHeader:function(){var e=this.getView().byId("ovpCountHeader");if(e){var t=this.getCardItemsBinding();if(t){if(t.getLength()>0){this.setHeaderCounter(t,e)}t.attachDataReceived(function(){if(E.hidePlaceholderNeeded()){E.hidePlaceholder()}this.setHeaderCounter(t,e)}.bind(this));t.attachChange(function(){this.setHeaderCounter(t,e)}.bind(this))}}else{var t=this.getCardItemsBinding();if(t){t.attachDataReceived(function(){if(E.hidePlaceholderNeeded()){E.hidePlaceholder()}})}}},setHeaderCounter:function(e,t){var a=e.getLength();var i=e.getCurrentContexts().length;var r,n="";var o=s.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});i=parseFloat(i,10);var l=this.getOwnerComponent().getComponentData();if(l&&l.appComponent){var d=l.appComponent;if(d.getModel("ui")){var p=d.getModel("ui");if(p.getProperty("/containerLayout")!=="resizable"){if(a!==0){a=o.format(Number(a))}if(i!==0){i=o.format(Number(i))}}else{r=d.getDashboardLayoutUtil().dashboardLayoutModel.getCardById(l.cardId)}}}if(i===0){n=""}else if(r&&r.dashboardLayout.showOnlyHeader){n=y.getText("Count_Header_Total",[a])}else if(a!=i){n=y.getText("Count_Header",[i,a])}t.setText(n);t.addEventDelegate({onAfterRendering:function(){var e=t.$();e.attr("aria-label",n)}})},_handleKPIHeader:function(){var e,t;if(this.getView()&&this.getView().getDomRef()){e=this.getView().getDomRef().getElementsByClassName("numericContentHbox");t=this.getView().getDomRef().getElementsByClassName("noDataSubtitle")}else{return}if(e||t){var a=this.getKPIBinding();if(a){a.attachDataReceived(function(i){var r=i.getParameter("data")&&i.getParameter("data").results&&i.getParameter("data").results[0];var n=a.getLength();if(e[0]){e[0].style.visibility=null;if(n===0){e[0].style.visibility="hidden"}else{this._setSubTitleWithUnitOfMeasure(r);e[0].style.visibility="visible"}}if(t.length!==0){t[0].style.display="none";if(n===0){t[0].style.display="flex"}}}.bind(this))}}},getKPIBinding:function(){var e=this.byId("kpiHBoxNumeric"),t=e&&e.getBindingInfo("items")&&e.getBindingInfo("items").binding;return t},_setSubTitleWithUnitOfMeasure:function(e){var t=this.getCardPropertiesModel();if(!!t){var a=t.getData();var i=this.getView().byId("SubTitle-Text");if(!!i){i.setText(a.subTitle);if(!!a&&!!a.entityType&&!!a.dataPointAnnotationPath){var n=t.getData().entityType;var o=a.dataPointAnnotationPath.split("/");var s=o.length===1?n[a.dataPointAnnotationPath]:n[o[0]][o[1]];var l;if(s&&s.Value&&s.Value.Path){l=s.Value.Path}else if(s&&s.Description&&s.Description.Value&&s.Description.Value.Path){l=s.Description.Value.Path}if(!!l){var d=r.getUnitColumn(l,n);var p;if(!!d&&!!e){p=e[d]}else{p=r.getUnitColumn(l,n,true)}var c=y.getText("SubTitle_IN");if(!!a.subTitle&&!!c&&!!p){i.setText(a.subTitle+" "+c+" "+p);var v=i.getAggregation("customData");if(v){var g;for(g in v){var h=v[g];if(h.getKey()==="aria-label"){h.setValue(a.subTitle+" "+c+" "+p);break}}}}}}}}},getCardItemsBinding:function(){},onActionPress:function(e){var t=e.getSource(),a=this._getActionObject(t),i=t.getBindingContext();if(a.type.indexOf("DataFieldForAction")!==-1){this.doAction(i,a)}else{this.doNavigation(i,a)}},_getActionObject:function(e){var t=e.getCustomData();var a={};for(var i=0;i<t.length;i++){a[t[i].getKey()]=t[i].getValue()}return a},doNavigation:function(e,t,a){if(!a){a=b.constants.inplace}if(!this.enableClick){return}this.enableClick=false;setTimeout(function(){this.enableClick=true}.bind(this),1e3);if(!this.oMainComponent){return}if(!t){t=this.getEntityNavigationEntries(e)[0]}var i=S({},e);var r=S({},t);var n=this.oMainComponent.doCustomNavigation&&this.oMainComponent.doCustomNavigation(this.sCardId,i,r);var o=this.oMainComponent.templateBaseExtension&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation(this.sCardId,i,r);var s;if(n){s=n}if(o){s=o}if(s){var l=s.type;if(l&&typeof l==="string"&&l.length>0){l=l.split(".").pop().split("/").pop().toLowerCase();switch(l){case"datafieldwithurl":s.type="com.sap.vocabularies.UI.v1.DataFieldWithUrl";break;case"datafieldforintentbasednavigation":s.type="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";break}t=s}}function d(a){if(!a){a=b.constants.inplace}if(t){switch(t.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(e,t,a);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(e,t,false,a);break;case"com.sap.vocabularies.UI.v1.KPIDetailType":this.doIntentBasedNavigation(e,t,false,a);break}}}if(!this.oMainComponent.oAppStatePromise){d.call(this,a)}else{this.oMainComponent.oAppStatePromise.then(d.bind(this,a))}},doNavigationWithUrl:function(e,t,a){if(!a){a=b.constants.inplace}if(!(sap.ushell&&sap.ushell.Container)){if(t&&t.url){T(t.url,"newWindow")}return}var i=sap.ushell.Container.getService("URLParsing");if(!i.isIntentUrl(t.url)){T(t.url,"newWindow")}else{var r=i.parseShellHash(t.url);var n=r.appSpecificRoute?true:false;this.doIntentBasedNavigation(e,r,n,a)}},fnHandleError:function(e){if(e instanceof c){if(e.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){p.show(y.getText("OVP_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:y.getText("OVP_GENERIC_ERROR_TITLE")})}else{p.show(e.getErrorCode(),{title:y.getText("OVP_GENERIC_ERROR_TITLE")})}}},doCrossApplicationNavigation:function(e,t){var a="#"+e.semanticObject+"-"+e.action;if(e.params){var i=this.oCardComponent&&this.oCardComponent.getComponentData();var r=i&&i.appComponent;if(r){var n=r._formParamString(e.params);a=a+n}}var o=this;if(!sap.ushell.Container){return}sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported([a]).done(function(e){if(e[a].supported===true){if(!!t.params){if(typeof t.params=="string"){try{t.params=JSON.parse(t.params)}catch(e){x.error("Could not parse the Navigation parameters");return}}}var i=o.getOwnerComponent().getComponentData();var r=i?i.globalFilter:undefined;var n=r&&r.getUiState({allFilters:false});var s=n?JSON.stringify(n.getSelectionVariant()):"{}";r=JSON.parse(s);var l=o._getFilterPreference();r=o._removeFilterFromGlobalFilters(l,r);if(!t.params){t.params={}}if(!!r&&!!r.SelectOptions){for(var d=0;d<r.SelectOptions.length;d++){var p=r.SelectOptions[d].Ranges;if(!!p){var v=[];for(var g=0;g<p.length;g++){if(p[g].Sign==="I"&&p[g].Option==="EQ"){v.push(p[g].Low)}}t.params[r.SelectOptions[d].PropertyName]=v}}}sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(t)}else{var h=new c("NavigationHandler.isIntentSupported.notSupported");o.fnHandleError(h)}}).then(function(){x.error("Could not get authorization from isIntentSupported")})},doIntentBasedNavigation:function(e,t,a,i){if(!i){i=b.constants.inplace}var n=this.oCardComponent&&this.oCardComponent.getComponentData();if(n&&n.appComponent&&n.appComponent.ovpConfig&&n.appComponent.ovpConfig.isTeamsModeActive){i=b.constants.explace}if(sap.ushell&&!sap.ushell.Container){return}var o,s,l,d=e?e.getObject():null;var p=this.getCardPropertiesModel(),c=p.getProperty("/customParams");if(e&&typeof e.getAllData==="function"&&c){l=e.getAllData()}else if(p.getProperty("/staticContent")){l={iStaticLinkListIndex:t.iStaticLinkListIndex,bStaticLinkListIndex:true}}if(d&&d.__metadata){delete d.__metadata}var v=r.getNavigationHandler();if(v){if(t){o=this._getEntityNavigationParameters(d,l,e);s={target:{semanticObject:t.semanticObject,action:t.action},appSpecificRoute:t.appSpecificRoute,params:o.sNavSelectionVariant};var g={};if(o.sNavPresentationVariant){g.presentationVariant=o.sNavPresentationVariant}if(a){if(t&&t.semanticObject&&t.action){var h=this.getCardPropertiesModel().getProperty("/staticParameters");s.params=!!h?h:{};this.doCrossApplicationNavigation(t,s)}}else{v.navigate(s.target.semanticObject,s.target.action,s.params,null,this.fnHandleError,g,i)}}}},doAction:function(e,a){this.actionData=t.getActionInfo(e,a,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm()}else{this._callFunction()}},getEntityNavigationEntries:function(e,t){var a=[];var i=this.getEntityType();var r=this.getCardPropertiesModel();var n=r.getProperty("/template");if(!i){return a}if(!t&&!e){if(!this.oCardComponentData.settings.identificationAnnotationPath){var o=r.getProperty("/kpiAnnotationPath");if(o&&n==="sap.ovp.cards.charts.analytical"){t=o;var s=i[t];var d=s&&s.Detail;var p=d.SemanticObject&&d.SemanticObject.String;var c=d.Action&&d.Action.String;if(d.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){if(p&&c){a.push({type:d.RecordType,semanticObject:p,action:c,label:""})}else{x.error("Invalid Semantic object and action configured for annotation "+d.RecordType)}}}}}if(!t){var g=r.getProperty("/identificationAnnotationPath");var h=g?g.split(","):[];if(h&&h.length>1){t=h[0]}else{t=g}}var f=i["@"+t];if(Array.isArray(f)){f=l.sortCollectionByImportance(f);for(var u=0;u<f.length;u++){if(f[u].$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){a.push({type:f[u].$Type,semanticObject:f[u].SemanticObject,action:f[u].Action,label:f[u].Label?f[u].Label:null})}if(f[u].$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!f[u].Url.UrlRef){var m=this.getView().getModel();var C=m.getMetaModel();var y;if(e){y=e.getInterface(0).getPath()}else{y="/"+r.getInterface().getData().entitySet}var b=C.createBindingContext(y);var P=k.format(f[u].Url,{context:b});var I=new v({key:"url",value:P});if(e&&n==="sap.ovp.cards.charts.analytical"){m=e.getModel()}I.setModel(m);I.setBindingContext(e);var S=I.getValue();a.push({type:f[u].$Type,url:S,value:f[u].Value,label:f[u].Label?f[u].Label:null})}}}return a},getModel:function(){if(this.getView()){return this.getView().getModel()}},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel()}},getCardPropertiesModel:function(){if(!this.oCardPropertiesModel||w(this.oCardPropertiesModel)){this.oCardPropertiesModel=this.getView().getModel("ovpCardProperties")}return this.oCardPropertiesModel},getEntitySet:function(){if(!this.entitySet){var e=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel()&&this.getMetaModel().getObject("/"+e)}return this.entitySet},getEntityType:function(){if(!this.entityType){var e=this.getMetaModel();var t=this.getEntitySet();if(e&&t){var a=e.getData().$Annotations[t.$Type];var i={property:e.getObject("/"+t.$Type+"/")};this.entityType=b.merge(true,{},a,i)}}return this.entityType},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer")}return this.cardContentContainer},_processCustomParameters:function(e,t,a){var i=this.getCardPropertiesModel();if(!this.oMainComponent||!i){return}var r;if(e&&e.bStaticLinkListIndex){var n=i.getProperty("/staticContent");r=n[e.iStaticLinkListIndex]["customParams"];e=null}else{r=i.getProperty("/customParams")}if(!r||!this.oMainComponent.templateBaseExtension.provideCustomParameter||!this.oMainComponent.onCustomParams){return}var o=this.oMainComponent.templateBaseExtension.provideCustomParameter(r)?this.oMainComponent.templateBaseExtension.provideCustomParameter(r):this.oMainComponent.onCustomParams(r);if(!o||!N.checkIfFunction(o)){return}var s=S({},e);var l=S({},t);var d=o(s,l);if(!d||!Array.isArray(d)&&!I(d)){return}var p=I(d);if(p&&w(d)){return}var c=p&&(d.bIgnoreEmptyString||d.ignoreEmptyString);var v=p?d.aSelectionVariant||d.selectionVariant:d;if(!Array.isArray(v)){return}var g,h,f,u,m,C;h=v.length;for(g=0;g<h;g++){f=v[g];if(!f){continue}u=f.path;m=f.value1;C=f.value2;if(!u||typeof u!=="string"||u===""){x.error("Custom Variant property path '"+u+"' should be valid string");continue}if(!(m||m===0||m===false||m===""||m===""&&c)){continue}m=m.toString();C=C&&C.toString();if(m===""&&c){t.removeSelectOption(u)}if(e){delete e[u]}if(a){delete a[u]}t.addSelectOption(u,f.sign,f.operator,m,C)}if(c){this._removeEmptyStringsFromSelectionVariant(t)}return c},_getEntityNavigationParameters:function(e,t,n){var o={};var s,d,p;var c=this.getOwnerComponent().getComponentData();var v=c?c.globalFilter:undefined;var h=this.getCardPropertiesModel();var f=h&&h.getProperty("/staticContent");if(!f){var u=l.getCardSelections(this.getCardPropertiesModel());var m=u.filters;var y=u.parameters;var b=this.getEntityType();m&&m.forEach(function(e){e.path=e.path.replace("/",".");switch(e.operator){case g.NE:e.operator=g.EQ;e.sign="E";break;case g.Contains:e.operator="CP";var t=e.value1;e.value1="*"+t+"*";break;case g.EndsWith:e.operator="CP";var t=e.value1;e.value1="*"+t;break;case g.StartsWith:e.operator="CP";var t=e.value1;e.value1=t+"*"}});u.filters=m;if(n&&e&&e.hasOwnProperty("$isOthers")){var P=n.getOtherNavigationDimensions();for(var I in P){var S=P[I];for(var D=0;D<S.length;D++){u.filters.push({path:I,operator:"EQ",value1:S[D],sign:"E"})}}}y&&y.forEach(function(e){e.path=e.path.replace("/",".")});u.parameters=y;var N=l.getCardSorters(this.getCardPropertiesModel());if(e){var I,w=b&&b.property&&Object.keys(b.property);for(var D=0;D<w.length;D++){if(w[D].startsWith("$")){continue}I=w[D];var O=e[I];if(e.hasOwnProperty(I)){if(Array.isArray(e[I])&&e[I].length===1){o[I]=e[I][0]}else if(jQuery.type(O)!=="object"){o[I]=O}}}}var k=h&&h.getProperty("/kpiAnnotationPath");var T=h&&h.getProperty("/template");if(k&&T==="sap.ovp.cards.charts.analytical"){var A=b[k];var E=A&&A.Detail;if(E&&E.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){o["kpiID"]=A.ID.String}}d=N&&new i(N);s=this._buildSelectionVariant(v,u);p=h&&h.getProperty("/staticParameters")}else{var V=v&&v.getUiState({allFilters:false});var F=V?JSON.stringify(V.getSelectionVariant()):"{}";s=new a(F);var x=this._getFilterPreference();s=this._removeFilterFromGlobalFilters(x,s);if(f[t.iStaticLinkListIndex].params){p=f[t.iStaticLinkListIndex].params}else if(f[t.iStaticLinkListIndex].staticParameters){p=f[t.iStaticLinkListIndex].staticParameters}}var L;if(t&&!t.bStaticLinkListIndex){L=this._processCustomParameters(t,s,o)}else if(t&&t.bStaticLinkListIndex){L=this._processCustomParameters(t,s)}else{L=this._processCustomParameters(o,s)}var M=L?C.navigation.service.SuppressionBehavior.ignoreEmptyString:undefined;if(p){for(var I in p){if(!o.hasOwnProperty(I)){o[I]=p[I]}}}var _=r.getNavigationHandler();var H=_&&_.mixAttributesAndSelectionVariant(o,s.toJSONString(),M);if(!f){this._removeSensitiveAttributesFromNavSelectionVariant(b,H)}return{sNavSelectionVariant:H?H.toJSONString():null,sNavPresentationVariant:d?d.toJSONString():null}},_removeSensitiveAttributesFromNavSelectionVariant:function(e,t){for(var a=0;a<e.property.length;a++){if(e.property[a]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]&&e.property[a]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]){delete t._mSelectOptions[e.property[a].name]}}},_removeEmptyStringsFromSelectionVariant:function(e){var t=e.getParameterNames();for(var a=0;a<t.length;a++){if(e.getParameter(t[a])===""){e.removeParameter(t[a])}}var i=e.getSelectOptionsPropertyNames();for(a=0;a<i.length;a++){var r=e.getSelectOption(i[a]);for(var n=0;n<r.length;n++){if(r[n].Low===""&&!r[n].High){r.splice(n,1);n--}}if(r.length===0){e.removeSelectOption(i[a])}}return e},_checkIfCardFiltersAreValid:function(e,t){var a=true;if(e&&e.filterAll==="global"){a=false}else if(e&&e.globalFilter){if(e.globalFilter.indexOf(t)>=0){a=false}}return a},_getFilterPreference:function(){var e=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;var t;if(e&&e.mainComponent){t=e.mainComponent._getFilterPreference(e.cardId)}return t},_removeFilterFromGlobalFilters:function(e,t){var a=[];if(e&&e.filterAll==="card"){a=t.getSelectOptionsPropertyNames()}else if(e&&e.cardFilter){a=e.cardFilter}a.forEach(function(e){if(e!=="$.basicSearch"){t.removeSelectOption(e)}});return t},_buildSelectionVariant:function(e,t){var i=e&&e.getUiState({allFilters:false});var r=i?JSON.stringify(i.getSelectionVariant()):"{}";var n=new a(r);var o,s,l,d;var p=this._getFilterPreference();n=this._removeFilterFromGlobalFilters(p,n);var c=t.filters;var v=t.parameters;for(var g=0;g<c.length;g++){o=c[g];if(o.path&&o.operator&&typeof o.value1!=="undefined"){s=o.value1.toString();l=typeof o.value2!=="undefined"?o.value2.toString():undefined;if(this._checkIfCardFiltersAreValid(p,o.path)){n.addSelectOption(o.path,o.sign,o.operator,s,l)}}}var h,f,u;for(var m=0;m<v.length;m++){d=v[m];if(!d.path||!d.value){continue}h=d.path.split("/").pop();h=h.split(".").pop();if(h.indexOf("P_")===0){f=h;u=h.substr(2)}else{f="P_"+h;u=h}if(n.getParameter(f)){continue}if(n.getParameter(u)){continue}n.addParameter(h,d.value)}return n},_loadParametersForm:function(){var e=new h;e.setData(this.actionData.parameterData);var a=this;var i=new f("ovpCardActionDialog",{title:this.actionData.sFunctionLabel,afterClose:function(){i.destroy()}}).addStyleClass("sapUiNoContentPadding");var r=new u({text:this.actionData.sFunctionLabel,press:function(e){var r=t.getParameters(e.getSource().getModel(),a.actionData.oFunctionImport);i.close();a._callFunction(r,a.actionData.sFunctionLabel)}});var n=new u({text:"Cancel",press:function(){i.close()}});i.setBeginButton(r);i.setEndButton(n);var o=function(e){var i=t.mandatoryParamsMissing(e.getSource().getModel(),a.actionData.oFunctionImport);r.setEnabled(!i)};var s=t.buildParametersForm(this.actionData,o);i.addContent(s);i.setModel(e);i.open()},_callFunction:function(e,t){var a={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:e,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var i=this;var n=new Promise(function(e,r){var n=i.actionData.oContext.getModel();var o;o="/"+a.functionImport.name;n.callFunction(o,{method:a.functionImport.httpMethod,urlParameters:a.urlParameters,batchGroupId:a.batchGroupId,changeSetId:a.changeSetId,headers:a.headers,success:function(t,a){e(a)},error:function(e){e.actionText=t;r(e)}})});n.then(function(e){return m.show(y.getText("Toast_Action_Success"),{duration:1e3})},function(e){var t=r.showODataErrorMessages(e);if(t===""&&e.actionText){t=y.getText("Toast_Action_Error")+' "'+e.actionText+'"'+"."}return p.error(t,{title:y.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:F.Inherit})})},setErrorState:function(){var e=this.getOwnerComponent();if(!e||!e.oContainer){return}var t=e.oContainer;var a=this.getCardPropertiesModel();var i={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:a.getProperty("/category"),title:a.getProperty("/title"),description:a.getProperty("/description"),entitySet:a.getProperty("/entitySet"),state:b.loadingState.ERROR,template:a.getProperty("/template")}}};A.create(i).then(function(a){t.setComponent(a);setTimeout(function(){e.destroy()},0)})},changeSelection:function(e,t,a){if(!t){var i=this.getView().byId("ovp_card_dropdown");e=parseInt(i.getSelectedKey(),10)}var r={};if(!t){r=this.getCardPropertiesModel().getProperty("/tabs")[e-1]}else{r=a.tabs[e-1]}var o={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:e};for(var s in r){o[s]=r[s]}if(n.checkIfAPIIsUsed(this)){n.recreateCard(o,this.getOwnerComponent().getComponentData())}else{this.getOwnerComponent().getComponentData().mainComponent.recreateCard(o);this.getOwnerComponent().getComponentData().mainComponent.setOrderedCardsSelectedKey(this.getOwnerComponent().getComponentData().cardId,e)}},getItemHeight:function(e,t,a){if(!!e){var i=e.getView().byId(t);var r=0;if(!!i){if(a){if(i.getItems()[0]&&i.getItems()[0].getDomRef()){r=N.getOuterHeight(i.getItems()[0].getDomRef())}}else{if(i.getDomRef()){r=N.getOuterHeight(i.getDomRef())}}}return r}},getHeaderHeight:function(){var e=this.getItemHeight(this,"ovpCardHeader"),t=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;if(t&&t.appComponent){var a=t.appComponent.getDashboardLayoutUtil(),i=a.getDashboardLayoutModel().getCardById(t.cardId);if(e!==0){i.dashboardLayout.headerHeight=e}}return e},refreshCardContent:function(){if(this.getKPIBinding()){this.getKPIBinding().refresh()}if(this.getCardItemsBinding()){this.getCardItemsBinding().refresh()}}})});
//# sourceMappingURL=Card.controller.js.map
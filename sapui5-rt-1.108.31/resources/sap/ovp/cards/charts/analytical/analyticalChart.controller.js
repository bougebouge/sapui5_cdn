sap.ui.define(["sap/ovp/cards/generic/Card.controller","sap/ovp/cards/charts/VizAnnotationManager","sap/viz/ui5/data/FlattenedDataset","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/app/resources","sap/base/util/each","sap/ovp/cards/ovpLogger","sap/ovp/app/FilterHelper","sap/ui/core/Fragment","sap/ovp/filter/FilterUtils","sap/ui/core/Core","sap/ovp/cards/Integration/IntegrationCard","sap/ui/Device","sap/ovp/cards/charts/Utils","sap/ui/dom/units/Rem","sap/ovp/cards/charts/OVPChartFormatter"],function(t,e,a,i,r,s,o,n,d,h,l,p,u,g,v,c){"use strict";var y=new o("OVP.analytical.analyticalChart");return t.extend("sap.ovp.cards.charts.analytical.analyticalChart",{onInit:function(){t.prototype.onInit.apply(this,arguments);c.registerCustomFormatters();var e=this;this.eventhandler=function(t,a,i){h.applyFiltersToV2Card(i,e)};this.GloabalEventBus=l.getEventBus();if(this.oMainComponent&&this.oMainComponent.isMacroFilterBar){this.GloabalEventBus.subscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",e.eventhandler)}this.iPreviousRowSpan=0},onBeforeRendering:function(){if(this.bCardProcessed){return}e.validateCardConfiguration(this);var t=this.getView().byId("analyticalChart");var i=this.getOwnerComponent().getComponentData();if(t){t.setHeight("21rem")}if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"&&i&&i.appComponent){var r=i.appComponent.getDashboardLayoutUtil();var s=r.dashboardLayoutModel.getCardById(i.cardId);if(s.dashboardLayout.autoSpan&&t){t.setHeight("21rem")}}var o=this.getView().byId("vbLayout");var n;var h=false;var l=new a({data:{path:"/"}});this.isVizPropSet=h;this.oDataSet=l;this.vizFrame=t;this.vbLayout=o;if(!t){y.error(e.constants.ERROR_NO_CHART+": ("+this.getView().getId()+")")}else{this.vbLayout.setBusy(true);n=t.getModel("ovpCardProperties").getProperty("/navigation");if(n===undefined||n=="datapointNav"||n!="headerNav"){e.getSelectedDataPoint(t,this)}t.destroyDataset();var p=t.getParent().getBinding("data");this._handleKPIHeader();if(p&&p.getPath()){p.attachDataReceived(this.onDataReceived.bind(this));p.attachDataRequested(this.onDataRequested.bind(this))}else{d.load("sap.ovp.cards.charts.generic.noData").then(function(t){var e=this.getCardContentContainer();e.removeAllItems();e.addItem(t)}.bind(this))}t.addEventDelegate({onmouseover:function(){var e=t._oOvpVizFrameTooltip;if(e){e._oPopup.close()}}})}this.bCardProcessed=true},onAfterRendering:function(){t.prototype.onAfterRendering.apply(this,arguments);if(!i.checkIfAPIIsUsed(this)&&this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var e=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var a=this.oDashboardLayoutUtil.getCardDomId(this.cardId);var r=document.getElementById(a);var s=this.getHeaderHeight();if(!e.dashboardLayout.autoSpan){if(r){var o=r.getElementsByClassName("sapOvpWrapper")[0];if(o){o.style.height=e.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(s+2*this.oDashboardLayoutUtil.CARD_BORDER_PX)+"px"}}}if(e.dashboardLayout.showOnlyHeader){r.classList.add("sapOvpMinHeightContainer")}var n=this.getView().byId("analyticalChart");if(n){n.setHeight(this._calculateVizFrameHeight()+"px");this._calculateWidth()}}},onDataReceived:function(t){var a=this;var i=this.getView().byId("analyticalChart");var o=this.getView().byId("bubbleText");var n=this.getView().byId("ovpCT");var d=r.getText("BUBBLESIZE");this.oDataSet.bindData("analyticalmodel>/","");i.setDataset(this.oDataSet);var h=i.getParent();if(!this.isVizPropSet){e.buildVizAttributes(i,h,n,this);this.isVizPropSet=true;if(o!=undefined){var l=i.getFeeds();s(l,function(t,e){if(l[t].getUid()=="bubbleWidth"){o.setText(d+" "+l[t].getValues())}})}e.hideDateTimeAxis(i)}if(this.getCardPropertiesModel()&&this.getCardPropertiesModel().getData()&&this.getCardPropertiesModel().getData().colorPalette&&i.getVizType()==="stacked_column"){var p=i.getDataset().getDimensions(),v=i.getFeeds(),c,y;for(var b=0;b<v.length;b++){if(v[b].getUid()==="color"){c=v[b].getValues()[0];break}}for(var f=0;f<p.length;f++){if(p[f].getName()===c){y=p[f];break}}if(c&&y){var C={};C["bDescending"]=true;y.setSorter(C)}}var V=this.getView().byId("ovpUoMTitle");var m=t?t.getParameter("data"):null;e.setChartUoMTitle(i,m,V);if(this.bFlag==true){this.bFlag=false;this.vbLayout.setBusy(false)}else{setTimeout(function(){a.vbLayout.setBusy(false);if(a.getView()&&a.getView().byId("sapOvpCardInsights")){a.getView().byId("sapOvpCardInsights").setEnabled(true)}},0)}e.checkNoData(t,this.getCardContentContainer(),i);if(u.system.phone){if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var P=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var I=Math.max(P.dashboardLayout.rowSpan,this.iPreviousRowSpan);this.iPreviousRowSpan=I}if(g.isDataSetEmpty(t)){i.setHeight(50+"px")}else{var D=this._calculateVizFrameHeight();if(D!==undefined&&typeof D==="number"){i.setHeight(D+"px")}}}},onDataRequested:function(){this.vbLayout.setBusy(true)},getCardItemsBinding:function(){var t=this.getView().byId("analyticalChart");if(t&&t.getParent()){return t.getParent().getBinding("data")}return null},resizeCard:function(t){var a=this.getCardPropertiesModel();this.newCardLayout=t;a.setProperty("/cardLayout/rowSpan",t.rowSpan);a.setProperty("/cardLayout/colSpan",t.colSpan);var i=this.getCardPropertiesModel().getProperty("/cardLayout");var o=this.getHeaderHeight();var n=this.getView().getDomRef().querySelectorAll(".sapOvpWrapper");for(var d=0;d<n.length;d++){n[d].style.height=t.rowSpan*i.iRowHeightPx+2-(o+2*i.iCardBorderPx)+"px"}var h=this.getView().byId("analyticalChart");var l=this.getView().byId("bubbleText");var p=this.getView().byId("ovpCT");if(h){if(h.getVizType()==="timeseries_bubble"||h.getVizType()==="bubble"){if(i.colSpan>1){l.setVisible(false)}else{l.setVisible(true)}}h.setHeight(this._calculateVizFrameHeight()+"px");this._calculateWidth()}var u=this.getView().byId("ovpCardContentContainer").getDomRef();if(u){if(!t.showOnlyHeader){u.classList.remove("sapOvpContentHidden")}else{u.classList.add("sapOvpContentHidden")}}var g=r.getText("BUBBLESIZE");this.oDataSet.bindData("analyticalmodel>/","");this.vizFrame.setDataset(this.oDataSet);var v=h.getParent();if(!this.isVizPropSet){e.buildVizAttributes(h,v,p,this);this.isVizPropSet=true;if(l!=undefined){var c=h.getFeeds();s(c,function(t,e){if(c[t].getUid()=="bubbleWidth"){l.setText(g+" "+c[t].getValues())}})}e.hideDateTimeAxis(h)}e.reprioritizeContent(this.newCardLayout,h)},_calculateVizFrameHeight:function(){var t;if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var e=this.getView().byId("analyticalChart");var a=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var i=this.getView().getController();var r=this.getItemHeight(i,"toolbar");var s=this.getHeaderHeight();var o=this.getView().byId("ovpCT")?24:0;var n=(e.getVizType()==="timeseries_bubble"||e.getVizType()==="bubble")&&a.dashboardLayout.colSpan===1?43:0;var d=u.system.phone&&this.iPreviousRowSpan>0?this.iPreviousRowSpan:a.dashboardLayout.rowSpan;t=d*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(s+2*this.oDashboardLayoutUtil.CARD_BORDER_PX+r+o+n+30);var h=e.getVizType();var l=e.sId;if(h==="donut"){var p=this._calculateVizLegendGroupHeight(t);var g=this.getView().byId(l);if(g){g.setVizProperties(p)}}}else{t=v.toPx(21)}return t},_calculateVizLegendGroupHeight:function(t){var e;if(t<=300){e=.1}else if(t>=400){e=.4}else{e=.3}var a={legendGroup:{layout:{height:e}}};return a},_calculateWidth:function(){var t=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var e=this.getView().byId("analyticalChart");if(t){var a=parseInt(t.dashboardLayout.width,10);var i=e.getVizType();var r=e.sId;if(i==="donut"){var s=this._calculateVizLegendGroupWidth(a);var o=this.getView().byId(r);if(o){o.setVizProperties(s)}}}},_calculateVizLegendGroupWidth:function(t){var e;if(t<=600){e=.25}else if(t<=900){e=.55}else if(t>=1200){e=.7}else{e=.65}var a={legendGroup:{layout:{maxWidth:e}}};return a},refreshCard:function(){this.getView().rerender()},onShowInsightCardPreview:function(t){var e=t.getSource()&&t.getSource().getParent();if(e){e.close()}var a=this.getView();var i=a.getController();var r=i.oCardComponentData;var s=this;p.showCard({vizFrame:i.vizFrame,entitySet:i.entitySet,entityType:i.entityType,cardComponentName:"Analytical",cardComponentData:r,cardComponent:i.oCardComponent,view:a}).then(function(t){s.saveGeneratedCardManifest(t)})}})});
//# sourceMappingURL=analyticalChart.controller.js.map
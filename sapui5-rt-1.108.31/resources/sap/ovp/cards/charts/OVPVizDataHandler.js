sap.ui.define(["sap/ui/core/Control","sap/ui/model/json/JSONModel","sap/ovp/cards/charts/Utils","sap/ovp/cards/AnnotationHelper","sap/ovp/app/resources","sap/base/util/each","sap/base/util/merge","sap/ovp/cards/Integration/Helpers/AnalyticalCard"],function(e,t,a,r,s,n,i,o){"use strict";return e.extend("sap.ovp.cards.charts.OVPVizDataHandler",{metadata:{aggregations:{data:{type:"sap.ui.core.Element"},aggregateData:{type:"sap.ui.core.Element"},content:{multiple:false}},properties:{chartType:{defaultValue:false},dependentDataReceived:{defaultValue:false},scale:{defaultValue:""},entitySet:{}}},renderer:function(e,t){e.openStart("div",t).openEnd();if(t.getContent()){e.renderControl(t.getContent())}e.close("div")},mergeDatasets:function(e,a,r){var l=this;var p=this.getModel();var u=e.mParameters;var d=i({},this.dataSet);if(u){var g=u.select.split(",")}var c=e.getPath().substring(1);var v=-1;if(c){v=c.indexOf("Parameters")}if(v>=0){c=c.substr(0,c.indexOf("Parameters"))}var f=p.getMetaModel();var h=this.getEntitySet();var y=f.getODataEntitySet(h);var m=f.getODataEntityType(y.entityType);var D=[];var b=[];for(var P=0;P<m.property.length;P++){if(m.property[P]["com.sap.vocabularies.Analytics.v1.Measure"]||m.property[P].hasOwnProperty("sap:aggregation-role")&&m.property[P]["sap:aggregation-role"]==="measure"){if(g&&g.indexOf(m.property[P].name)!==-1){D.push(m.property[P].name)}}else{if(g&&g.indexOf(m.property[P].name)!==-1){b.push(m.property[P].name)}}}if(d&&d.results){for(var P=0;P<d.results.length-2;P++){for(var S=0;S<D.length;S++){d.results[0][D[S]]=Number(d.results[0][D[S]])+Number(d.results[P+1][D[S]])}}var C=d.__count-d.results.length;var A={};A.results=[];A.results[0]=d.results[0];var O;if(d.__count>d.results.length){var x=i({},this.aggregateSet);if(x&&x.results&&d.results.length<d.__count){n(D,function(e){x.results[0][D[e]]=String(Number(l.aggregateSet.results[0][D[e]])-Number(A.results[0][D[e]]))});n(b,function(e){x.results[0][b[e]]=s.getText("OTHERS_DONUT",[C+1])});x.results[0].$isOthers=true;O=x.results[0]}}if(O){a.results.push(O)}var T=r.getModel("ovpCardProperties");var E=T&&T.getProperty("/bEnableStableColors");var k=T&&T.getProperty("/colorPalette");var I=m[T&&T.getProperty("/chartAnnotationPath")];if(I.DimensionAttributes.length===1&&E&&r.getVizType()==="donut"&&k&&k instanceof Object&&Object.keys(k).length<=10){var w=I.DimensionAttributes[0].Dimension.PropertyPath;if(k instanceof Array){var M=k.map(function(e){return e.color});var R=M.slice()}else{var V=JSON.parse(JSON.stringify(k))}var B=r.getVizProperties();if(!B){var N={plotArea:{dataPointStyle:{rules:[]}}};B=N}else if(B&&!B.plotArea){B.plotArea={dataPointStyle:{rules:[]}}}if(r&&B&&B.plotArea){if(!B.plotArea.dataPointStyle){B.plotArea.dataPointStyle={rules:[]}}else{B.plotArea.dataPointStyle.rules=[]}var _=f.getODataProperty(m,w);if(_){var j=_["com.sap.vocabularies.Common.v1.Label"]?_["com.sap.vocabularies.Common.v1.Label"].String:w;var z;if(_["com.sap.vocabularies.Common.v1.Text"]){z=_["com.sap.vocabularies.Common.v1.Text"]["Path"]}else if(_["sap:text"]){z=_["sap:text"]}else{z=_}var U=function(e,t,r,s){return{callback:function(e){if(e&&e[j]===r.dimensionValue||r.hasOwnProperty(e[j])){return true}},properties:{color:M&&M[e]||r&&r[s]},displayName:a.results[t][z]}};var H=[];if(k instanceof Array){n(k,function(e,t){for(var r=0;r<a.results.length;r++){if(a.results[r][w]===t.dimensionValue){var s=U(e,r,t);B.plotArea.dataPointStyle["rules"].push(s);R.splice(e,1);if(T&&T.getProperty("/bInsightEnabled")){var n=i({},s);delete n.callback;n.dataContext={};n.dataContext[j]=J;H.push(n)}}}})}else{for(var F=0;F<a.results.length;F++){if(k.hasOwnProperty(a.results[F][w])){var J=a.results[F][w];var L={};L[J]=k[J];var q=U(P,F,L,J);B.plotArea.dataPointStyle["rules"].push(q);delete V[J];if(T&&T.getProperty("/bInsightEnabled")){var Y=i({},q);delete Y.callback;Y.dataContext={};Y.dataContext[j]=J;H.push(Y)}}}}if(x&&x.results&&Array.isArray(x.results)){B.plotArea.dataPointStyle["rules"].push({callback:function(e){if(e&&e[j].lastIndexOf("Others")!=-1){return true}},properties:{color:R&&R.length?M[M.length-1]:Object.keys(V).length&&V[Object.keys(V)[0]]},displayName:x.results[0][w]})}}}r.setVizProperties(B);if(T&&T.getProperty("/bInsightEnabled")){var $=r.getId();var G=i({},B);if(H.length>0){G.plotArea.dataPointStyle={rules:H}}o.setVizPropertyMap($,G)}}}var K=new t;K.setData(a.results);r.setModel(K,"analyticalmodel")},updateBindingContext:function(){var s=this.getBinding("data");var o=this.getBinding("aggregateData");var l=this;if(this.chartBinding==s){return}else{this.chartBinding=s;if(s){var l=this;s.attachEvent("dataReceived",function(e){l.dataSet=e&&e.getParameter("data");l.oDataClone=i({},l.dataSet);if(l.getChartType()=="donut"&&l.getBinding("aggregateData")!==undefined){if(l.getDependentDataReceived()===true||l.getDependentDataReceived()==="true"){l.mergeDatasets(s,l.oDataClone,l.getContent());l.setDependentDataReceived(false)}else{l.setDependentDataReceived(true)}}else{var o=new t;if(l.dataSet){var p=l.getEntitySet();var u=s.getModel();var d=a.cacheODataMetadata(u);var g=d[p];var c=a.getSemanticProperties(g);var v=c&&c.aTimeAxisProperties||[];var f=c&&c.oTimeAxisPropertiesAndSemantics||{};if(v&&v.length){if(l.dataSet.results&&l.dataSet.results.length){n(l.dataSet.results,function(e,t){n(v,function(e,a){if(t.hasOwnProperty(a)){var s=t[a];var n,i,o,l,p,u,d;switch(f[a]["sap:semantics"]){case"yearmonth":n=parseInt(s.substr(0,4),10);i=s.substr(4);p=parseInt(i,10)-1;t[a]=new Date(Date.UTC(n,p));break;case"yearquarter":n=parseInt(s.substr(0,4),10);o=s.substr(4);l=parseInt(o,10)*3-2;p=l-1;t[a]=new Date(Date.UTC(n,p));break;case"yearweek":n=parseInt(s.substr(0,4),10);u=s.substr(4);var d=1+(parseInt(u,10)-1)*7;t[a]=new Date(Date.UTC(n,0,d));break;case"fiscalyearperiod":var g="com.sap.vocabularies.Common.v1.IsFiscalYearPeriod";var c=r.getFormattedFiscalData(s,g);t[a]=c;break;default:break}}})})}}o.setData(l.dataSet.results);l.oDataClone=i({},l.dataSet)}l.getContent().setModel(o,"analyticalmodel");l.mergeDatasets(s,l.oDataClone,l.getContent())}})}e.prototype.updateBindingContext.apply(this,arguments)}if(this.chartAggrBinding==o){return}else{this.chartAggrBinding=o;if(o){var l=this;o.attachEvent("dataReceived",function(e){l.aggregateSet=e&&e.getParameter("data");if(l.getChartType()=="donut"){if(l.getDependentDataReceived()===true||l.getDependentDataReceived()==="true"){l.oDataClone=i({},l.dataSet);l.mergeDatasets(s,l.oDataClone,l.getContent());l.setDependentDataReceived(false)}else{l.setDependentDataReceived(true)}}else{var a=new t;a.setData(l.aggregateSet.results);l.getContent().setModel(a,"analyticalmodel")}})}e.prototype.updateBindingContext.apply(this,arguments)}}})});
//# sourceMappingURL=OVPVizDataHandler.js.map
sap.ui.define(["sap/ui/integration/widgets/Card","sap/ovp/cards/Integration/Helpers/IntegrationCardPersonalization","sap/ovp/cards/ovpLogger","sap/ovp/cards/AnnotationHelper","sap/ui/model/FilterOperator","sap/ovp/app/NavigationHelper","sap/ovp/cards/Integration/Helpers/AnalyticalCard","sap/ovp/cards/Integration/Helpers/i18n","sap/ovp/cards/Integration/Helpers/Batch","sap/ovp/cards/Integration/Helpers/Filters","sap/ovp/app/resources","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ovp/cards/MetadataAnalyser","sap/ovp/cards/Integration/Helpers/CardHeader","sap/fe/navigation/SelectionVariant","sap/ovp/cards/CommonUtils","sap/ui/core/Core","sap/ovp/cards/Integration/Helpers/ListContentHelper","sap/ovp/cards/Integration/Helpers/ContentHelper","sap/ovp/cards/Integration/Helpers/TableContentHelper","sap/m/MessageBox","sap/insights/CardHelper","sap/m/MessageToast"],function(e,t,a,r,n,i,o,s,l,p,c,d,u,v,f,g,m,h,y,P,b,C,S,T){"use strict";var O=new a("sap.ovp.cards.Integration.IntegrationCard");var w="module:sap/insights/CardExtension";var I="";var D=function(e,t,a,r,n){var i=e&&e.getBinding(t);var o,s,l,p,c,d;var u,v,f;var g=r&&n!="sap.ovp.cards.charts.analytical"&&n!="sap.ovp.cards.charts.smart.chart";if(i){o=i.aApplicationFilters;s=i.getPath();l=i.mParameters.select;p=_(l&&l.split(","));l=p&&p.join();c=i.sSortParams;d=i.sRangeParams;u=i&&i.sCustomParams;v=u&&u.split("&");v=v&&v.filter(function(e){return e.indexOf("$expand")>-1});f=v&&v[0]}var m=d&&d.split("&")||[];var h,y;for(var P=0;P<m.length;P++){var b=m[P];if(b.indexOf("$skip")>-1){h=b.split("&")[0]}if(b.indexOf("$top")>-1){y=b.split("&")[0]}}if(g&&a&&a.length){var C=l&&l.split(",")||[];a.forEach(function(e){if(!C.includes(e)){C.push(e)}});l=C.join(",")}return{sBindingPath:s,aApplicationFilters:o,sSelect:l?"$select="+l:"",sSortParameters:c?c:"",skip:h?h:"",top:y?y:"",sExpandParam:f||""}};var x=function(e){var t=[],a=new g;if(e&&e.SelectOptions){t=e.SelectOptions}else{t=e}var i,o,s;if(t){for(var l=0;l<t.length;l++){i=t[l];o=i.PropertyName.PropertyPath;for(var p=0;p<i.Ranges.length;p++){s=i.Ranges[p];if(s.Sign.EnumMember){var c={Option:s.Option.EnumMember.split("/")[1],Low:r.getPrimitiveValue(s.Low),High:r.getPrimitiveValue(s.High),Sign:s.Sign.EnumMember==="com.sap.vocabularies.UI.v1.SelectionRangeSignType/I"?"I":"E"};if(c.Low!==undefined&&c.Low!==null&&typeof c.Low!=="string"){c.Low=c.Low.toString()}if(c.High!==undefined&&c.High!==null&&typeof c.High!=="string"){c.High=c.High.toString()}if(c.Sign==="E"&&c.Option!==n.EQ){O.error("Exclude sign is supported only with EQ operator");continue}if(c.Sign==="E"&&c.Option===n.EQ){c.Option=n.NE;c.Sign="I"}if(c.Option==="CP"&&c.Sign==="I"){var d=n.Contains;var u=c.Low;if(u){var v=u.indexOf("*");var f=u.lastIndexOf("*");if(v>-1){if(v===0&&f!==u.length-1){d=n.EndsWith;u=u.substring(1,u.length)}else if(v!==0&&f===u.length-1){d=n.StartsWith;u=u.substring(0,u.length-1)}else{u=u.substring(1,u.length-1)}}}c.Option=d;c.Low=u}if(c.Option==="Contains"){c.Option="CP"}a.massAddSelectOption(o,[c])}}}}return a};var N=function(e,t,a,r,n){var i=n.view.getModel(),o=n&&n.entityType,s=o&&o.property;var l,p=[],c,d,u=o&&o.name,f=t&&t.name;var g=i.oMetadata._getEntityTypeByName(u);var m=a&&a.oMetadata._getEntityTypeByName(f);if(!g&&!m){return}else if(g&&!m){p=[g.property]}else if(g&&m){p=[g.property,m.property]}for(var h=0;h<p.length;h++){s=JSON.parse(JSON.stringify(p[h]));for(var y=0;y<s.length;y++){if(s[y].name===e){l=s[y];return l}if("P_"+s[y].name===e||s[y].name==="P_"+e||"$Parameter.P_"+s[y].name===e||s[y].name==="$Parameter.P_"+e){l=s[y];if(l&&v.checkAnalyticalParameterisedEntitySet(i,n.entitySet.name)){c=r.length&&E(e,r)}return c&&c.length?c[0]:l}}}if(v.checkAnalyticalParameterisedEntitySet(i,n.entitySet.name)){d=r.length&&E(e,r);if((!d||!d.length)&&e.includes("/")){var P=e.split("/");d=P.length&&E(P[P.length-1],r)}}if(d&&d.length){return d[0]}return undefined};var M=function(e,t){var a;if(e&&e[t]){return e[t]}else if(e&&e.extensions){a=e.extensions;for(var r=0;r<a.length;r++){if(a[r].name===t){return a[r].value}}}return undefined};var E=function(e,t){return t.filter(function(t){if(t.name===e||"P_"+t.name===e||t.name==="P_"+e||"$Parameter.P_"+t.name===e||t.name==="$Parameter.P_"+e||t.name==="$Parameter."+e||"$Parameter."+t.name===e){return t}})};var V=function(e){return e["sap:filterable"]?e["sap:filterable"]!=="false":true};var A=function(e,t,a){var r=e.filter(function(e){var a=t.some(function(t){return t.name===e.name});return V(e)&&a})||[];if(a&&a.length>0){e.forEach(function(e){var t="P_"+e.name;if(a.includes(t)){r.push(e)}})}return r};var R=function(e){var t=[];if(e&&e.extensions){t=e.extensions;for(var a=0;a<t.length;a++){if(t[a].name==="parameter"&&t[a].value==="mandatory"){return e.name}else if(t[a].name==="required-in-filter"&&t[a].value==="true"){return e.name}}}};var F=function(e,t,a,r,n,i,o){var s=o.cardComponentData.mainComponent.oGlobalFilter,l=o.view.getModel("ovpCardProperties"),c=l&&l.getProperty("/bInsightRTEnabled");if(e["PropertyName"]&&e["PropertyName"]["PropertyPath"]){var d=e["PropertyName"]["PropertyPath"];if(e["PropertyValue"]&&e["PropertyValue"]["String"]){var u=N(d,undefined,undefined,a,o);d=u&&u.name?u.name:d;var v=R(u);var f=p.getParameterActualValue(d,s);if(v&&r.includes(v)){n.push(v);t[d]={value:c&&f?f:e["PropertyValue"]["String"],type:p.getPropertyType(u),description:u&&u.description?u.description:null,label:p.getLabelForConfigParams(d,s,t,o,e["PropertyValue"]["String"])};t[d]["description"]=M(u,"description")}else if(v){i.push(v);var m=new g;var h=p.getLabelForConfigParams(d,s,t,o,e["PropertyValue"]["String"])||[];var y="";if(c&&f){y=p.getRelatedTextToRange({Low:f},h,s,d);m.addSelectOption(d,"I","EQ",f,null,y)}else{y=p.getRelatedTextToRange({Low:e["PropertyValue"]["String"]},h,s,d);m.addSelectOption(d,"I","EQ",e["PropertyValue"]["String"],null,y)}t[d]={value:m.toJSONString(),type:p.getPropertyType(u),description:u&&u.description?u.description:null};t[d].value=p.enhanceVariant(t[d].value);t[d]["description"]=M(u,"description")}}}};var _=function(e){return e&&e.filter(function(t,a){return e.indexOf(t)===a})};var k=function(e){var t={filters:{}};var a=t.filters;var r=e.cardComponentData.mainComponent.oGlobalFilter;var n=r&&r.getModel();var i=r&&r.getEntityType();var o=e.view.getModel();var s=e.entityType,l,c=[];var d=[],u=[],f=[],m=[],h,y,P=[];var b=r&&r.getModel().getMetaModel().getODataEntityType(i);var C=[];var S=n&&n.getMetaModel();var T=S&&S.getODataEntityContainer();var O=T&&T.entitySet&&T.entitySet.filter(function(e){return e.entityType===i});var w=O&&O.length>0?O[0]:{};var I=[];if(n){var D=v.checkAnalyticalParameterisedEntitySet(n,w&&w.name);if(D){var E=v.getParametersByEntitySet(n,w&&w.name);if(E.entitySetName){I=E.parameters||[]}}}var V=v.getParametersByEntitySet(o,e.entitySet.name,true).parameters;var k=e.view.getModel("ovpCardProperties");var L=k&&k.getProperty("/bInsightRTEnabled");var H="";V.forEach(function(t){var i=R(t);var s=p.getParameterDefaultValue(n,w,i,e);var l=p.getParameterDefaultValue(o,e.entitySet,i,e);var d=s||l||t.defaultValue||"";var u=p.getParameterActualValue(t.name,r);H=p.getLabelForConfigParams(t.name,r,a,e,d);var v=p.IsSemanticDateRangeValid(e,t);if(v){p.setFilterRestrictionToSemanticDateRange(t,true);d=p.getDateRangeDefaultValue(e,t.name)||d;u=p.getDateRangeValue(u,t,true)||u;if(L&&H&&typeof H==="string"){H=H.substring(0,H.indexOf("(")-1)}else if(d){H=d;p.getLabelForConfigParams(t.name,r,a,e,d,true)}}if(i){f.push(t.name)}a[t.name]={value:L&&u?u:d,type:p.getPropertyType(t),description:t&&t.description,label:H};a[t.name]["description"]=M(t,"description");c.push(t.name);P.push(t.name)});I=I.filter(function(e){return!P.includes(e)});if(s&&s.property&&b&&b.property){C=A(s.property,b.property,I)}for(var j=0;j<C.length;j++){var J=C[j],$="";var Q=R(J);var U=p.getFilterDefaultValue(J.name,b,s)||J.defaultValue||"";var B=p.getParameterActualValue(J.name,r);if(P.includes(J.name)){H=p.getLabelForConfigParams(J.name,r,a,e,U);var q=p.IsSemanticDateRangeValid(e,J);if(q){p.setFilterRestrictionToSemanticDateRange(J,true);U=p.getDateRangeDefaultValue(e,J.name)||U;B=p.getDateRangeValue(B,J,true)||B;if(L&&H&&typeof H==="string"){H=H.substring(0,H.indexOf("(")-1)}else if(U){H=U;p.getLabelForConfigParams(J.name,r,a,e,U,true)}}a[J.name]={value:L&&B?B:U,type:p.getPropertyType(J),description:J&&J.description,label:H};if(Q){f.push(Q)}c.push(J.name)}else{h=new g;var W=p.getLabelForConfigParams(J.name,r,a,e,U);var B;var q=p.IsSemanticDateRangeValid(e,J);if(q){p.setFilterRestrictionToSemanticDateRange(J,false);p.addDateRangeValueToSV(e,J,U,h,W)}else{if(L){p.addFiltervalues(r,J.name,h,W)}else if(U){var K=p.getRelatedTextToRange({Low:U},W,r,J.name);h.addSelectOption(J.name,"I","EQ",U,null,K)}else{h.addSelectOption(J.name,"I","EQ",$)}}a[J.name]={value:h.toJSONString(),type:p.getPropertyType(J),description:J&&J.description};a[J.name].value=p.enhanceVariant(a[J.name].value);if(Q){m.push(Q)}d.push(J.name)}a[J.name]["description"]=M(J,"description")}var z=e.cardComponentData.settings["selectionAnnotationPath"];var X=e.entityType[z]&&JSON.parse(JSON.stringify(e.entityType[z]));var G=[],Y;for(var Z in X){if(X.hasOwnProperty(Z)){Y="";var ee=Array.isArray(X[Z])&&X[Z];if(Z==="Parameters"){for(var te=0;ee&&te<ee.length;te++){if(ee[te]["PropertyName"][["PropertyPath"]].includes("/")){var ae=ee[te]["PropertyName"][["PropertyPath"]].split("/");c.push(ae[ae.length-1])}else{c.push(ee[te]["PropertyName"][["PropertyPath"]])}Y=ee[te];F(Y,a,V,P,f,m,e)}}else if(Z==="SelectOptions"){G=X["SelectOptions"];for(var re=0;ee&&re<ee.length;re++){if(G[re].Ranges){u.push(X["SelectOptions"][re]["PropertyName"]["PropertyPath"])}d.push(X["SelectOptions"][re]["PropertyName"]["PropertyPath"]);Y=ee[re];F(Y,a,V,P,f,m,e)}y=x(X)}}}if(y){y=p.removeExtraInfoVariant(y.toJSONObject());var G=y&&y.SelectOptions||[];G.forEach(function(t){var i=t&&t.PropertyName;var o=p.getLabelForConfigParams(i,r,a,e)||[];var s=t&&t.Ranges||[];s.forEach(function(e){var t=p.getRelatedTextToRange(e,o,r,i);if(t){e.Text=t}});var c={Parameters:[],SelectOptions:[t]};var d=N(i,b,n,V,e);if(d){i=d.name}a[i]={value:JSON.stringify(c),type:p.getPropertyType(d),description:d&&d.description};a[i]["description"]=M(l,"description");var u=R(d);if(u&&P.includes(u)){f.push(u)}else if(u){m.push(u)}})}var ne=_(d);var ie=_(c);var oe=_(f);var se=_(m);p.updateRangeValue(a);a["_relevantODataFilters"]={value:ne};a["_relevantODataParameters"]={value:ie};a["_mandatoryODataParameters"]={value:oe};a["_mandatoryODataFilters"]={value:se};return t};var L=function(e,t,a){var r="";if(t){for(var n=0;n<e.length;n++){r=r+"${"+e[n]+"},"}}if(a){if(t){return"{= extension.formatters.formatValueColor("+r+JSON.stringify(t)+")}"}else if(e.length){return"{= extension.formatters.kpiValueCriticality(${"+e[0]+"})}"}}else{return"{= extension.formatters.formatTrendIcon("+r+JSON.stringify(t)+")}"}};var H=function(e,t,a){var r=e.view.getModel("ovpCardProperties");var n=e.entityType[r.getProperty("/presentationAnnotationPath")];var i=p.getRequestAtLeastFields(n);var o=r.getProperty("/addODataSelect");var s=r.getProperty("/template");if(e){var l,c="";switch(e.cardComponentName){case"Analytical":var d=e.vizFrame;l=d&&d.getParent();c="data";break;case"List":l=e.view.byId("ovpList");c="items";break;case"Table":l=e.view.byId("ovpTable");c="items";break}var u=D(l,c,i,o,s);a["_contentSkipQuery"]={value:u.skip};a["_contentTopQuery"]={value:u.top};a["_contentSortQuery"]={value:u.sSortParameters};a["_contentSelectQuery"]={value:u.sSelect};a["_contentExpandQuery"]={value:u.sExpandParam}}if(t==="Numeric"){var v=e.view.byId("kpiHBoxNumeric");var f=D(v,"items",i,o,s);a["_headerSkipQuery"]={value:f.skip};a["_headerTopQuery"]={value:f.top};a["_headerSortQuery"]={value:f.sSortParameters};a["_headerSelectQuery"]={value:f.sSelect};a["_headerExpandQuery"]={value:f.sExpandParam}}};var j=function(e,t){var a=e.cardComponentData.settings;var r=e.view;var n=r&&r.getController();var o=n._getEntityNavigationParameters().sNavSelectionVariant;o=o?JSON.parse(o):"";var s=o&&o.SelectOptions;var l=a.requireAppAuthorization;var p={},c={},d={},u={};if(l){p=i.getNavigationIntentFromAuthString(l);d=p.parameters}var v=Object.keys(d);if(v.length>0){for(var f=0;f<v.length;f++){if(!Array.isArray(d[v[f]])){c[v[f]]={defaultValue:{value:d[v[f]]}}}}}if(s&&s.length){s.forEach(function(e){var a=e["PropertyName"];var r=t.filters._relevantODataFilters.value.includes(a),n=t.filters._relevantODataParameters.value.includes(e["PropertyName"]);var i;if(e&&a&&!c[a]&&e.Ranges.length&&e.Ranges[0].Option==="EQ"&&!(r||n)){i=e.Ranges[0].Low;if(i!==undefined||i!==null){try{i=JSON.parse(e.Ranges[0].Low)}catch(e){}if(!Array.isArray(i)){c[a]=i}}}})}u={inbounds:{intent:{signature:{additionalParameters:"allowed"}}}};U(u.inbounds.intent,p.semanticObject,"semanticObject");U(u.inbounds.intent,p.action,"action");U(u.inbounds.intent.signature,c&&Object.keys(c).length?c:null,"parameters");return u};var J=function(e,t){var a={header:{enabled:false,actions:[]},content:{enabled:false,actions:[]}};var r=false,n=false;var o=e.view;var s=o.getController();var l={};if(e.cardComponentName==="Analytical"){n=!s.checkHeaderNavForChart()}r=i.bCheckNavigationForCard(s);if(!r){return a}else{if(e.cardComponentName==="List"||e.cardComponentName==="Table"){n=true}}l=i.getNavigationParameters(s,e);if(l===undefined){return a}var p={parameters:{ibnTarget:{},ibnParams:{}}};var c={type:"Navigation"};var d={type:"Navigation"};if(l&&l.type==="url"){p={type:"Navigation",parameters:{target:"_self"}};U(p.parameters,l.url,"url")}else{if(l.semanticObject||l.action||l.staticParams){p.parameters.ibnTarget={semanticObject:l.semanticObject,action:l.action};if(!t.configuration.parameters.state){t.configuration.parameters.state={value:""}}var u={};if(l.staticParams.navSelectionVariant){u.selectionVariant=l.staticParams.navSelectionVariant}if(l.staticParams.sNavPresentationVariant){u.presentationVariant=l.staticParams.sNavPresentationVariant}if(l.staticParams.sensitiveProperties){var v=l.staticParams.sensitiveProperties;var f={};v&&v.forEach(function(e){f[e]=e});u.sensitiveProps=f}p.parameters.ibnParams=u;var g=l.staticParams.staticPropertyMap;var m=g&&Object.keys(g);for(var h=0;h<m.length;h++){if(m[h]&&g[m[h]]){p.parameters.ibnParams[m[h]]=g[m[h]]}}}}a.content.enabled=true;a.content.actions.push(d);if(n){a.header.enabled=true;a.header.actions.push(c)}if(e.cardComponentName==="Analytical"){U(c,"{= extension.formatters.getNavigationContext(${parameters>/state/value})}","parameters");U(d,"{= extension.formatters.getNavigationContext(${parameters>/state/value}, ${})}","parameters");t.configuration.parameters.state.value=JSON.stringify(p)}else{U(c,"{= extension.formatters.getNavigationContext(${parameters>/headerState/value})}","parameters");t.configuration.parameters.headerState={value:""};t.configuration.parameters.headerState.value=JSON.stringify(p);U(d,"{= extension.formatters.getNavigationContext(${parameters>/lineItemState/value}, ${})}","parameters");t.configuration.parameters.lineItemState={value:""};if(l["lineItemSemanticObject"]&&l["lineItemAction"]){p.parameters.ibnTarget["semanticObject"]=l["lineItemSemanticObject"];p.parameters.ibnTarget["action"]=l["lineItemAction"]}t.configuration.parameters.lineItemState.value=JSON.stringify(p)}return a};var $=function(e,t){if(!e||!t){return}var a=e.getMetaModel();var r=a&&a.getODataEntityContainer();var n=r&&r.entitySet;if(!n||!Array.isArray(n)){return}var i=n.length;for(var o=0;o<i;o++){if(n[o].entityType===t){return n[o].name}}};var Q=function(e,t,a){if(e.startsWith("/sap/opu/odata")&&!e.endsWith(".xml")){return{uri:e,type:"ODataAnnotation"}}else if((!e.startsWith("/sap/opu/odata")||e.startsWith("/sap/opu/odata"))&&e.endsWith(".xml")){if(t&&a["sap.platform.abap"]){var r=a["sap.platform.abap"].uri;if(e.indexOf("./")===0){e=e.replace("./","")}else if(e.indexOf("/")===0){e=e.replace("/","")}else if(e.indexOf("../")===0){e=e.replace("../","")}e=r+"/"+e}return{uri:e,type:"XML"}}};var U=function(e,t,a){if(e&&t&&a){if(a==="unitOfMeasurement"){e["unitOfMeasurement"]="{"+t+"}"}else if(Array.isArray(t)&&t.length){e[a]=t}else if(!Array.isArray(t)){e[a]=t}}};var B=function(e,t){var a=e.cardComponentData.model.sServiceUrl;var r={};var n=l.getBatchObject(e,t["configuration"]);r["request"]={url:"{{destinations.service}}"+a+"/$batch",method:"POST",headers:{"X-CSRF-Token":"{{csrfTokens.token1}}"},batch:n};if(r.request.batch.header){r.request.batch.header.url="{{parameters._headerDataUrl}}"}r.request.batch.content.url="{{parameters._contentDataUrl}}";if(!n.header){var i=r["request"].batch.content;i.headers["X-CSRF-Token"]="{{csrfTokens.token1}}";i.url="{{destinations.service}}"+a+"/"+i.url;r["request"]=i}return r};var q=function(e){var t=e.cardComponentData.model.sServiceUrl;var a={};a["parameters"]=k(e)["filters"];a["destinations"]={service:{name:"(default)",defaultUrl:"/"}};a["csrfTokens"]={token1:{data:{request:{url:"{{destinations.service}}"+t,method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}}}};return a};var W=function(e,t,a){var r=f.getHeaderDetails(e),n=e.cardComponentData.cardId,i=e.cardComponentData.appComponent.getManifestObject().getRawJson(),l=i["sap.ovp"]["cards"][n].settings,p=e.cardComponentData.settings,c=p&&p.selectedKey,d;H(e,r,t["configuration"]["parameters"]);var u=t.extension&&r==="Numeric"?f.mainIndicatorDetails(e):"";var v=u&&u.path&&u.path.length?f.mainIndicatorNumberPath(u.path,u.ovpProp):"";s.createKeysFromText(n,l.title,"Title","card Title","header.title");s.createKeysFromText(n,l.subTitle,"Title","card subTitle","header.subTitle");var g=u&&u.valueColor?L(u.valueColor.path,u.valueColor.ovpProp,true):null;var m=u&&u.indicator?L(u.indicator.path,u.indicator.ovpProp,false):null;var h=u&&u.target?u.target:null;var y=u&&u.deviation?u.deviation:null;var b="",C,S="",T,O=[],w={},I={};if(h&&h.parts.length){b=f.targetDeviationValuePath(h,e.view.getModel("ovpCardProperties"),"targetValueFormatter");C=e.view.getModel("ovpCardProperties").getProperty("/bPercentageAvailableForTarget")?"%":null;if(b){U(I,u.target.text,"title");U(I,b,"number");U(I,C,"unit");O.push(I)}}if(u&&u.ovpProp){T=f.mainIndicatorNumberPath(u.path,u.ovpProp,true)}if(y&&y.parts.length){S=f.targetDeviationValuePath(y,e.view.getModel("ovpCardProperties"),"returnPercentageChange");I={};if(S){U(I,u.deviation.text,"title");U(I,S,"number");O.push(I)}}var D=o.getUoMForSubTitle(n);if(r!=="Default"){w={type:r,title:l.title,subTitle:l.subTitle,details:f.generateDetailsExpression(t,l,n,c)};U(w,D,"unitOfMeasurement");U(w,O,"sideIndicators");if(v){w["mainIndicator"]={};U(w.mainIndicator,v,"number");U(w.mainIndicator,g,"state");U(w.mainIndicator,m,"trend");U(w.mainIndicator,T,"unit")}d=w}else{d={type:r,title:l.title,subTitle:l.subTitle,details:f.generateDetailsExpression(t,l,n,c)}}if(a){d.data={path:"/header/d/results/0"}}if(d.details){d.type="Numeric"}if(t["type"]==="List"||t["type"]==="Table"){d.status=P.getHeaderStatus(a)}return d};var K=function(e,t){var a=e.cardComponentData.settings;var r;switch(t["type"]){case"Analytical":r=o.createChartContent(e,a.chartAnnotationPath,t);r.chartProperties["title"]=r.title;delete r.title;break;case"List":r=y.getListContent(e,t);break;case"Table":r=b.getTableContent(e,t);break;default:r={};break}return r};var z=function(e){var t={},a=e.cardComponentData.cardId;t["extension"]=w;t["type"]=e.cardComponentName;t["configuration"]=q(e);t["data"]=B(e,t);t["header"]=W(e,t,t["data"].request.batch);t["content"]=K(e,t);var r=p.getSemanticDateConfiguration(e)||{};if(Object.keys(r).length){t["configuration"]["parameters"]["_semanticDateRangeSetting"]={value:JSON.stringify(r)}}s.replaceStringsWithKeys(t,a);var n=e.view.getModel("ovpCardProperties");var i=n&&n.getProperty("/bInsightDTEnabled");if(i){l.updateBatchObject(e,t["configuration"],true)}return t};var X=function(e){var t=e.cardComponentData.appComponent.getManifest()["sap.app"],a=t.id,r=e.cardComponentData.settings,n=e.cardComponentData.cardId,i=e.cardComponentData.appComponent.getManifestObject().getRawJson(),o=i["sap.app"].i18n&&i["sap.app"].i18n.bundleUrl||i["sap.app"].i18n,l=i["sap.platform.abap"]&&i["sap.platform.abap"].uri,p=r&&r.selectedKey,c=e.view.getModel("ovpCardProperties"),d=c&&c.getProperty("/bInsightRTEnabled");var u=i["sap.fiori"]&&i["sap.fiori"].registrationIds&&i["sap.fiori"].registrationIds[0]||a,v=p?u+".cards."+n+".tab_"+p:u+".cards."+n;var f=p?"../../../":"../../";I=f+o;if(l){if(l.startsWith("/")){l=l.substring(1)}o=l+"/"+o}if(d){v="user."+v+"."+Date.now()}var g;if(d){g={title:t&&t.title||"",subtitle:t&&(t.subtitle||t.description)||""}}else{g=s.getKeysForAppProperties(t,i,e)}var m=g&&g.title,h=g&&g.subtitle,y=k(e),P={id:v,type:"card",embeddedBy:f,i18n:f+o,tags:{keywords:["Analytical","Card","Line","Sample"]},crossNavigation:j(e,y),dataSources:{}};if(m){P.title=m}if(h){P.subTitle=h}var b=e.cardComponentData.appComponent.getManifest()["sap.ovp"];var C=b.globalFilterModel;var S=e.cardComponentData.appComponent.getManifest()["sap.ui5"].models[C].dataSource;var T=t.dataSources;var O=T[S];var w={},D=[],x="",N;if(O&&O.settings){var M=O.settings.annotations,E;M.length&&M.forEach(function(e){for(var t in T){E=T[e].uri;if(t===e&&E){D.push(t);w[t]=Q(E,d,i);break}}});if(O&&O.uri){N=Q(O.uri,d,i)}x=O.settings&&O.settings["odataVersion"]}P.dataSources=w;P.dataSources["filterService"]={uri:O&&O.uri,settings:{annotations:D,odataVersion:x?x:"2.0"},type:N&&N.type};return P};var G=function(e){var t=e.cardComponentData.appComponent.getManifest()["sap.app"],a=t.id,r=e.cardComponentData.appComponent.getManifest()["sap.ovp"],n=e.view.getModel("ovpCardProperties"),i=n&&n.getProperty("/bInsightRTEnabled"),o="",s=e.cardComponentData.mainComponent.oGlobalFilter,l=s&&s.getEntityType(),p=e.cardComponentData.mainComponent.getOwnerComponent(),c=p.oOvpConfig.sapUICoreVersionInfo;if(!r.globalFilterEntitySet){o=$(s&&s.getModel(),l)}return{templateName:"OVP",parentAppId:a,filterEntitySet:r.globalFilterEntitySet?r.globalFilterEntitySet:o,cardType:i?"RT":"DT",versions:{ui5:c.version+"-"+c.buildTimestamp}}};var Y=function(e){var t={};t["sap.card"]=z(e);t["sap.app"]=X(e);t["sap.insights"]=G(e);var a=J(e,t["sap.card"]);if(a.header.enabled){t["sap.card"].header.actions=a.header.actions}if(a.content.enabled){switch(e.cardComponentName){case"Analytical":t["sap.card"].content.actions=a.content.actions;break;case"List":t["sap.card"].content.item.actions=a.content.actions;break;case"Table":t["sap.card"].content.row.actions=a.content.actions;break}}return t};var Z=function(e,t,a){var r=e["sap.card"]["header"][a];if(r&&r.startsWith("{{")){var n=r.split("{{")[1].split("}}")[0];var i=t.view.getModel("@i18n")?t.view.getModel("@i18n"):t.view.getModel("i18n");r=i?i.getProperty(n):undefined}return r?r:""};var ee=function(e,t,a,r){r.valueState=t;r.valueStateText=a;e.setValueState(r.valueState);e.setValueStateText(r.valueStateText)};var te={createManifestFor:Y,saveCardManifest:function(e,a){t.create().then(function(t){if(!a){var r=e["sap.app"].id;t.writeManifest(r,e)}})},downloadCardManifest:function(e){},createCard:function(t){var a=Y(t),r=window.location.origin,n=r+"/resources",i=new e({height:"533px",width:"314px",manifest:a,baseUrl:n});return i},UpdateManifestDeltaChanges:function(e,t,a,r){var n={_version:"1.1.0",contentDensities:{compact:true,cozy:true},dependencies:{libs:{"sap.insights":{lazy:false}}}};e["sap.ui5"]=n;if(e["sap.app"]["i18n"]!==I){e["sap.app"]["i18n"]=I}l.enhanceHeaderAndContentURLForSemanticDate(e["sap.card"]);l.enhanceHeaderAndContentURL(e["sap.card"]);var i=t.view.getModel("ovpCardProperties");var o=i&&i.getProperty("/bInsightRTEnabled");var p=i&&i.getProperty("/bInsightDTEnabled");if(p){var c=Z(e,t,"title");var d=Z(e,t,"subTitle");var u=h.byId(a+"--titleTextInput");if(u&&u.getValue()){var v=h.byId(a+"--subTitleTextInput");var f=t.cardComponentData.cardId;if(this.titleChanged&&u.getValue()!==c){s.createKeysFromText(f,u.getValue(),"Title","card Title","header.title");this.titleChanged=false}var g=v.getValue();var m=v&&g&&this.subTitleChanged&&g!==d;if(m){s.createKeysFromText(f,g,"Title","card subTitle","header.subTitle");this.subTitleChanged=false}else if(v&&!g){this.subTitleChanged=false;delete e["sap.card"].header.subTitle}}s.inserti18nKeysManifest(e["sap.card"]);s.writei18nPayload();l.updateBatchObject(t,e["sap.card"]["configuration"],true);if(r==="Create"){this.saveCardManifest(e,o)}else if(r==="Download"){this.downloadCardManifest(e)}s.reseti18nProperties()}else if(o){var y=t.view.getModel("@i18n");if(e["sap.card"].type==="Analytical"){e["sap.card"]["content"].chartProperties.title.text=s.getI18nValueOrDefaultString(e["sap.card"]["content"].chartProperties.title.text,y)}else if(e["sap.card"].type==="Table"){var P=e["sap.card"].content.row.columns;if(Array.isArray(P)&&P.length){P.forEach(function(e,t){P[t].title=s.getI18nValueOrDefaultString(e.title,y)})}}s.fnReplacei18nKeysWithText(e,y)}},checkIfActionExistsForCard:function(e,t){var a=e["sap.card"].content.actions||[],r=e["sap.card"].header.actions||[],n=e["sap.card"].content.item&&e["sap.card"].content.item.actions||[],i=e["sap.card"].content.row&&e["sap.card"].content.row.actions||[],o=a.length>0||r.length>0||n.length>0||i.length>0;if(!o){t.close();t.destroy();C.error(c.getText("INT_Preview_Action_ValidationText"))}return o},showCard:function(e){var t=e.view.getModel("ovpCardProperties"),a=t&&t.getProperty("/bInsightRTEnabled"),r=t&&t.getProperty("/bInsightDTEnabled"),n=this.createCard(e),i=n.getManifest();if(a){this.UpdateManifestDeltaChanges(i,e);return S.getServiceAsync("UIService").then(function(e){return e.showCardPreview(i).then(function(){return Promise.resolve(i)})}).catch(function(e){T.show(e.message)})}else if(r){return new Promise(function(t,a){var r=c.oResourceModel,o=Z(i,e,"title"),l=Z(i,e,"subTitle"),p={draggable:true,cardTitle:o,cardSubTitle:l,valueState:o?"None":"Error",valueStateText:o?"":c.getText("INT_Preview_Title_ValueStateText")},v=new u({dialogSettings:p}),f=m.getApp().getOwnerComponent(),g=f.createId("integrationCardPreview");this.handleCancel=function(){this.previewDialogPromise.then(function(e){e.close();s.reseti18nProperties();e.destroy();this.titleChanged=false;this.subTitleChanged=false}.bind(this))};this.handleTitleLiveChange=function(e){var t=e.getSource();var a=t.getValue();this.previewDialogPromise.then(function(){if(a&&n.getCardHeader().getTitle()!==a){ee(t,"None","",p);n.getCardHeader().setTitle(a);this.titleChanged=true}else if(!a){this.titleChanged=true;ee(t,"Error",c.getText("INT_Preview_Title_ValueStateText"),p)}else{ee(t,"None","",p)}}.bind(this))};this.handleSubTitleLiveChange=function(e){var t=e.getSource();var a=t.getValue();this.previewDialogPromise.then(function(){if(n.getCardHeader().getSubtitle()!==a){n.getCardHeader().setSubtitle(a);this.subTitleChanged=true}}.bind(this))};this.confirmActionHandler=function(){this.previewDialogPromise.then(function(a){if(!this.checkIfActionExistsForCard(i,a)){return}this.UpdateManifestDeltaChanges(i,e,g,"Create");a.close();a.destroy();t(i)}.bind(this))};this.downloadCardManifestHandler=function(){this.previewDialogPromise.then(function(a){if(!this.checkIfActionExistsForCard(i,a)){return}this.UpdateManifestDeltaChanges(i,e,g,"Download");a.close();a.destroy();t(i)}.bind(this))};this.previewDialogPromise=d.load({id:g,type:"XML",name:"sap.ovp.cards.Integration.Preview",controller:this}).then(function(t){t.setModel(v);t.setModel(e.view.getModel("i18n"),"i18n");t.setModel(r,"ovpResourceModel");var a=h.byId(g+"--subFlexBoxNew");a.addItem(n);this.titleChanged=false;this.subTitleChanged=false;if(e.cardComponentName!=="Analytical"){h.byId(g+"--ovpIntPreviewOverflowLayer").setVisible(true)}t.open();return t}.bind(this)).catch(function(e){O.error("Integration card preview fragment failed to load, "+e)})}.bind(this))}}};return te},true);
//# sourceMappingURL=IntegrationCard.js.map
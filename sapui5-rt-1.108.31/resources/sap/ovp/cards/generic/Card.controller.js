sap.ui.define(["sap/ui/core/mvc/Controller","sap/ovp/cards/ActionUtils","sap/fe/navigation/SelectionVariant","sap/fe/navigation/PresentationVariant","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/ResizeHandler","sap/ui/core/format/NumberFormat","sap/ovp/cards/AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/m/MessageBox","sap/ui/generic/app/navigation/service/NavError","sap/ui/core/CustomData","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/generic/app/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/ui/events/KeyCodes","sap/base/util/isPlainObject","sap/base/util/merge","sap/ovp/cards/ovpLogger","sap/ovp/cards/jUtils","sap/base/util/isEmptyObject","sap/ui/util/openWindow","sap/ovp/placeholder/placeholderHelper","sap/ovp/cards/Integration/Helpers/AnalyticalCard","sap/ui/core/Component","sap/ui/core/library","sap/insights/CardHelper","sap/ui/core/Fragment"],function(t,e,a,i,r,n,o,s,l,d,p,c,g,v,h,f,u,m,C,jQuery,y,b,P,I,S,D,N,w,O,T,k,A,E,M,V){"use strict";var F=E.TextDirection;var L=new D("OVP.generic.Card");return t.extend("sap.ovp.cards.generic.Card",{initKeyboardNavigation:function(){var t=function(t){this.init(t)};t.prototype.layoutItemFocusHandler=function(){var t=jQuery(document.activeElement);if(t){var e=t.find("[aria-label]");var a,i="";if(t.find(".valueStateText").length==1){var r=t.find(".valueStateText").find(".sapMObjectNumberText").text();var n=t.find(".valueStateText").find(".sapUiInvisibleText").text();t.find(".valueStateText").attr("aria-label",r+" "+n);t.find(".valueStateText").attr("aria-labelledby","")}t.find("[role='listitem']").attr("aria-label","");if(t.hasClass("sapOvpCardHeader")&&!t.hasClass("sapOvpStackCardContent")){var o="";var s=t.find(".cardHeaderType");if(s.length===0){var l=y.getText("CardHeaderType");o="cardHeaderType_"+(new Date).getTime();var d='<div id="'+o+'" class="cardHeaderType" aria-label="'+l+'" hidden></div>';t.append(d)}else{o=s[0].id}i+=o+" "}for(a=0;a<e.length;a++){if(e[a].getAttribute("role")==="heading"){i+=e[a].id+" "}}if(t.hasClass("sapOvpCardHeader")){var p=t.find(".cardHeaderText");if(p.length!==0){for(var a=0;a<p.length;a++){if(i.indexOf(p[a].id)===-1){i+=p[a].id+" "}}}}if(i.length){t.attr("aria-labelledby",i)}if(t.prop("nodeName")==="LI"&&t.find(".linkListHasPopover").length!==0){if(t.find("#hasDetails").length===0){t.append("<div id='hasDetails' hidden>"+y.getText("HAS_DETAILS")+"</div>");t.attr("aria-describedby","hasDetails")}}var c=t.attr("id");if(c&&c.indexOf("ovpTable")!=-1&&t.find("[role='Link']")&&!t.hasClass("sapUiCompSmartLink")){var g=t.closest("td").attr("data-sap-ui-column"),v=t.closest("tbody").siblings().children().filter("tr").children();for(var a=0;a<v.length;a++){if(v[a].getAttribute("data-sap-ui")==g&&v[a].hasChildNodes("span")){var h=v[a].firstElementChild.getAttribute("id");t.attr("aria-labelledby",h)}}}}};t.prototype.init=function(t){this.cardLayout=t;this.keyCodes=P;this.jqElement=jQuery(t.getView().$());this.jqElement=this.jqElement.parent().parent().parent();this.jqElement.on("focus.keyboardNavigation",this.layoutItemFocusHandler.bind(this))};this.keyboardNavigation=new t(this)},onInit:function(){this.oCardComponent=this.getOwnerComponent();this.oCardComponentData=this.oCardComponent&&this.oCardComponent.getComponentData();this.oMainComponent=this.oCardComponentData&&this.oCardComponentData.mainComponent;this.sCardId=this.oCardComponentData.cardId;var t=this.getView().mPreprocessors.xml[0].ovpCardProperties.oData.state;if(t!=="Error"){var e=this.getView().byId("ovpCardHeader");if(!!e){e.attachBrowserEvent("click",this.onHeaderClick.bind(this));e.addEventDelegate({onkeydown:function(t){if(!t.shiftKey&&t.keyCode==13){t.preventDefault();this.onHeaderClick(t)}else if(!t.shiftKey&&t.keyCode==32){t.preventDefault()}}.bind(this)});e.addEventDelegate({onkeyup:function(t){if(!t.shiftKey&&t.keyCode==32){t.preventDefault();this.onHeaderClick(t)}}.bind(this)})}}var a=this.getView().byId("kpiNumberValue");if(a){a.addEventDelegate({onAfterRendering:function(){var t=a.$();var e=t.find(".sapMNCValueScr");var i=t.find(".sapMNCScale");e.attr("aria-label",e.text());i.attr("aria-label",i.text());var r=this.getView().byId("ovpCardHeader").getDomRef();var n=this.getOwnerComponent().getComponentData();if(!!n&&!!n.appComponent){var o=n.appComponent;if(!!o.getModel("ui")){var s=o.getModel("ui");if(!!s.getProperty("/containerLayout")&&s.getProperty("/containerLayout")==="resizable"){var l=n.appComponent.getDashboardLayoutUtil();if(!!l){l.setKpiNumericContentWidth(r)}}}}}.bind(this)})}},exit:function(){if(this.resizeHandlerId){o.deregister(this.resizeHandlerId)}},onAfterRendering:function(){var t=this.getView().byId("ovpCardHeader");var e=t&&t.getDomRef();var a=this.getView().byId("ovpHeaderTitle"),i=this.getView().byId("ovpQuickviewCardHeader");if(e&&!e.getAttribute("ariaLabelledBy")){if(a&&a.getText()){var r=a.getDomRef().getAttribute("id");e.setAttribute("arialabelledby",r)}else if(i&&i.getText()){var s=i.getDomRef().getAttribute("id");e.setAttribute("arialabelledby",s)}}var l=this.getCardPropertiesModel();this.enableClick=true;var d=l.getProperty("/contentFragment"),p=this.getOwnerComponent().getComponentData(),c=this.getCardItemsBinding();if(!c&&T.hidePlaceholderNeeded()){T.hidePlaceholder()}this._handleCountHeader();this._handleKPIHeader();var g=l.getProperty("/selectedKey");if(g&&l.getProperty("/state")!=="Loading"){var v=this.getView().byId("ovp_card_dropdown");if(v){v.setSelectedKey(g)}}try{var p=this.getOwnerComponent().getComponentData();if(p&&p.appComponent){var h=p.appComponent;if(h.getModel("ui")){var f=h.getModel("ui");if(f.getProperty("/containerLayout")==="resizable"){var u=h.getDashboardLayoutUtil();if(u){this.oDashboardLayoutUtil=u;this.cardId=p.cardId;if(u.isCardAutoSpan(p.cardId)){this.resizeHandlerId=o.register(this.getView(),function(t){L.info("DashboardLayout autoSize:"+t.target.id+" -> "+t.size.height);u.setAutoCardSpanHeight(t)})}}}}}}catch(t){L.error("DashboardLayout autoSpan check failed.")}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var m=jQuery("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>m.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height())}}var C=0;if(p&&p.mainComponent){var y=p.mainComponent;if(y.bGlobalFilterLoaded){C=!this.checkHeaderNavForChart()&&this.checkNavigation()}}else if(n.checkIfAPIIsUsed(this)){C=this.checkAPINavigation()}var b=l.getProperty("/state");if(b!=="Loading"&&b!=="Error"){var P=l.getProperty("/template");if(P==="sap.ovp.cards.stack"){if(!C){var I=this.getView().byId("ViewAll");if(I){I=I.getDomRef();I.parentNode.removeChild(I)}}}}if(d==="sap.ovp.cards.stack.Stack"){var S=this.getView().getDomRef();var D=S&&S.querySelector(".sapOvpCardContentContainer");if(D){D.style.borderTop="none"}}var w=false;if(C){if(d?d!=="sap.ovp.cards.quickview.Quickview":true){if(d==="sap.ovp.cards.stack.Stack"){var S=this.getView().getDomRef();var O=S.querySelectorAll(".sapOvpCardContentRightHeader");if(O.length!==0){N.addClassToAllElements(O,"sapOvpCardNavigable")}}else{this.getView().addStyleClass("sapOvpCardNavigable")}}if(d&&d==="sap.ovp.cards.quickview.Quickview"){var k=this.byId("ovpCardHeader");if(k){k.addStyleClass("sapOvpCardNavigable")}}w=true}else{if(d){this.getView().addStyleClass("ovpNonNavigableItem");var k=this.byId("ovpCardHeader");if(k){k.$().removeAttr("role");k.addStyleClass("ovpNonNavigableItem")}var A=this.checkLineItemNavigation();if(!A){switch(d){case"sap.ovp.cards.list.List":var E=this.getView().byId("listItem");if(E){E.setType("Inactive")}break;case"sap.ovp.cards.table.Table":var E=this.getView().byId("tableItem");if(E){E.setType("Inactive")}break;case"sap.ovp.cards.linklist.LinkList":if(!this.checkNavigationForLinkedList()){var E=this.getView().byId("ovpCLI");if(E){E.setType("Inactive")}}break}}else if(A&&(d==="sap.ovp.cards.list.List"||d==="sap.ovp.cards.table.Table")){w=true}if(d==="sap.ovp.cards.charts.analytical.analyticalChart"&&this.checkNavigation()){w=true}}}if(!w){var M=this.getView().byId("sapOvpCardInsights");if(M&&M.getVisible()){M.setVisible(false)}}var V=this.getView().byId("ovp_card_dropdown");var F=this.getView().byId("ovp_card_dropdown_label");if(V){V.addAriaLabelledBy(F.getId())}if(n.checkIfAPIIsUsed(this)){this.initKeyboardNavigation()}},checkNavigation:function(){var t=this.getCardPropertiesModel();var e=this.getEntityType();if(e){if(t){var a=t.getProperty("/identificationAnnotationPath");var i=a;var r=t.getProperty("/contentFragment");if(r&&(r==="sap.ovp.cards.stack.Stack"||r==="sap.ovp.cards.quickview.Quickview")){var n=a?a.split(","):[];if(n&&n.length>1){if(r==="sap.ovp.cards.stack.Stack"){i=n[0]}else{i=n[1]}}}var o=e[i];if(this.isNavigationInAnnotation(o)){return 1}if(t&&t.getProperty("/template")==="sap.ovp.cards.charts.analytical"){var s=t.getProperty("/kpiAnnotationPath");if(e&&s){var l=e[s];if(l&&l.Detail){var d=l.Detail.SemanticObject&&l.Detail.SemanticObject.String;var p=l.Detail.Action&&l.Detail.Action.String;if(d&&p){return 1}}}}}}else if(t&&t.getProperty("/template")==="sap.ovp.cards.linklist"&&t.getProperty("/staticContent")&&t.getProperty("/targetUri")){return 1}return 0},checkNavigationForLinkedList:function(){if(this.getEntityType()){var t=this.getEntityType();var e=t["com.sap.vocabularies.UI.v1.LineItem"];if(e&&(e[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||e[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl")){return true}}return false},checkLineItemNavigation:function(){if(this.getEntityType()){var t=this.getEntityType();var e=this.getCardPropertiesModel();if(e){var a=e.getProperty("/annotationPath");var i=t[a];return this.isNavigationInAnnotation(i)}}},isNavigationInAnnotation:function(t){if(t&&t.length){for(var e=0;e<t.length;e++){var a=t[e];if(a.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||a.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||a.RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return 1}}}return 0},checkAPINavigation:function(){var t=this.getOwnerComponent().getComponentData(),e=t.fnCheckNavigation&&typeof t.fnCheckNavigation==="function",a=e?t.fnCheckNavigation:null;if(a){if(a()){return true}}else{if(!this.checkHeaderNavForChart()&&this.checkNavigation()){return true}}return false},onHeaderClick:function(t){var e=t&&t.target&&t.target.id;if(e&&e.indexOf("sapOvpCardInsights")>-1){return}var a=t.ctrlKey||t.metaKey?b.constants.explace:b.constants.inplace;if(n.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){r.onHeaderClicked()}}else{var i=this.getCardPropertiesModel();var o=i.getProperty("/template");var s=i.getProperty("/targetUri");if(o=="sap.ovp.cards.linklist"&&i.getProperty("/staticContent")!==undefined&&s){window.location.href=s}else if(i.getProperty("/staticContent")!==undefined&&s===""){return}else if(this.checkHeaderNavForChart()){return}else{this.doNavigation(this.getView().getBindingContext(),null,a)}}},checkHeaderNavForChart:function(){var t=this.getCardPropertiesModel();var e=t.getProperty("/template");var a=t.getProperty("/navigation");if(a=="noHeaderNav"&&(e=="sap.ovp.cards.charts.analytical"||"sap.ovp.cards.charts.smart.chart")){return true}else{return false}},resizeCard:function(t){L.info(t);if(this.resizeHandlerId){o.deregister(this.resizeHandlerId);this.resizeHandlerId=null}},_handleCountHeader:function(){var t=this.getView().byId("ovpCountHeader");if(t){var e=this.getCardItemsBinding();if(e){if(e.isLengthFinal()&&e.getLength()>0){this.setHeaderCounter(e,t)}e.attachDataReceived(function(a){if(T.hidePlaceholderNeeded()){T.hidePlaceholder()}this.setHeaderCounter(e,t,a)}.bind(this));e.attachChange(function(a){this.setHeaderCounter(e,t,a)}.bind(this))}}else{var e=this.getCardItemsBinding();if(e){e.attachDataReceived(function(){if(T.hidePlaceholderNeeded()){T.hidePlaceholder()}})}}},setHeaderCounter:function(t,e,a){var i;if(t.isLengthFinal()){i=t.getLength()}else{if(a&&a.getParameters().data&&a.getParameters().data.results){i=a.getParameters().data.results.length}}var r=t.getCurrentContexts().length;var n,o="";var l=s.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});r=parseFloat(r,10);var d=this.getOwnerComponent().getComponentData();if(d&&d.appComponent){var p=d.appComponent;if(p.getModel("ui")){var c=p.getModel("ui");if(c.getProperty("/containerLayout")!=="resizable"){if(i!==0){i=l.format(Number(i))}if(r!==0){r=l.format(Number(r))}}else{n=p.getDashboardLayoutUtil().dashboardLayoutModel.getCardById(d.cardId)}}}if(r===0){o=""}else if(n&&n.dashboardLayout.showOnlyHeader){o=y.getText("Count_Header_Total",[i])}else if(i!=r){o=y.getText("Count_Header",[r,i])}e.setText(o);e.addEventDelegate({onAfterRendering:function(){var t=e.$();t.attr("aria-label",o)}})},_handleKPIHeader:function(){var t,e;if(this.getView()&&this.getView().getDomRef()){t=this.getView().getDomRef().getElementsByClassName("numericContentHbox");e=this.getView().getDomRef().getElementsByClassName("noDataSubtitle")}else{return}if(t||e){var a=this.getKPIBinding();if(a){a.attachDataReceived(function(i){var r=i.getParameter("data")&&i.getParameter("data").results&&i.getParameter("data").results[0];var n=a.getLength();if(t[0]){t[0].style.visibility=null;if(n===0){this._setSubTitleWithUnitOfMeasure(r,false);t[0].style.visibility="hidden"}else{this._setSubTitleWithUnitOfMeasure(r,true);t[0].style.visibility="visible"}}if(e.length!==0){e[0].style.display="none";if(n===0){e[0].style.display="flex"}}}.bind(this))}}},getKPIBinding:function(){var t=this.byId("kpiHBoxNumeric"),e=t&&t.getBindingInfo("items")&&t.getBindingInfo("items").binding;return e},_setSubTitleWithUnitOfMeasure:function(t,e){var a=this.getCardPropertiesModel();if(!!a){var i=a.getData();var n=this.getView().byId("SubTitle-Text");var o="";if(!!n){n.setText(i.subTitle);if(!!i&&!!i.entityType&&!!i.dataPointAnnotationPath&&e){var s=a.getData().entityType;var l=i.dataPointAnnotationPath.split("/");var d=l.length===1?s[i.dataPointAnnotationPath]:s[l[0]][l[1]];var p;if(d&&d.Value&&d.Value.Path){p=d.Value.Path}else if(d&&d.Description&&d.Description.Value&&d.Description.Value.Path){p=d.Description.Value.Path}if(!!p){var c=r.getUnitColumn(p,s);var g;if(!!c&&!!t){o=c;g=t[c]}else{g=r.getUnitColumn(p,s,true);o=g}if(a.getProperty("/bInsightEnabled")){k.setUoMForSubTitle(a.getData().cardId,o)}var v=y.getText("SubTitle_IN");if(!!i.subTitle&&!!v&&!!g){n.setText(i.subTitle+" "+v+" "+g);var h=n.getAggregation("customData");if(h){var f;for(f in h){var u=h[f];if(u.getKey()==="aria-label"){u.setValue(i.subTitle+" "+v+" "+g);break}}}}}}}}},getCardItemsBinding:function(){},onActionPress:function(t){var e=t.getSource(),a=this._getActionObject(e),i=e.getBindingContext();if(a.type.indexOf("DataFieldForAction")!==-1){this.doAction(i,a)}else{this.doNavigation(i,a)}},_getActionObject:function(t){var e=t.getCustomData();var a={};for(var i=0;i<e.length;i++){a[e[i].getKey()]=e[i].getValue()}return a},doNavigation:function(t,e,a){if(!a){a=b.constants.inplace}if(!this.enableClick){return}this.enableClick=false;setTimeout(function(){this.enableClick=true}.bind(this),1e3);if(!this.oMainComponent){return}if(!e){e=this.getEntityNavigationEntries(t)[0]}var i=S({},t);var r=S({},e);var n=this.oMainComponent.doCustomNavigation&&this.oMainComponent.doCustomNavigation(this.sCardId,i,r);var o=this.oMainComponent.templateBaseExtension&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation(this.sCardId,i,r);var s;if(n){s=n}if(o){s=o}if(s){var l=s.type;if(l&&typeof l==="string"&&l.length>0){l=l.split(".").pop().split("/").pop().toLowerCase();switch(l){case"datafieldwithurl":s.type="com.sap.vocabularies.UI.v1.DataFieldWithUrl";break;case"datafieldforintentbasednavigation":s.type="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";break}e=s}}function d(a){if(!a){a=b.constants.inplace}if(e){switch(e.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(t,e,a);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(t,e,false,a);break;case"com.sap.vocabularies.UI.v1.KPIDetailType":this.doIntentBasedNavigation(t,e,false,a);break}}}if(!this.oMainComponent.oAppStatePromise){d.call(this,a)}else{this.oMainComponent.oAppStatePromise.then(d.bind(this,a))}},doNavigationWithUrl:function(t,e,a){if(!a){a=b.constants.inplace}if(!(sap.ushell&&sap.ushell.Container)){if(e&&e.url){O(e.url,"newWindow")}return}var i=sap.ushell.Container.getService("URLParsing");if(!i.isIntentUrl(e.url)){O(e.url,"newWindow")}else{var r=i.parseShellHash(e.url);var n=r.appSpecificRoute?true:false;this.doIntentBasedNavigation(t,r,n,a)}},fnHandleError:function(t){if(t instanceof c){if(t.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){p.show(y.getText("OVP_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:y.getText("OVP_GENERIC_ERROR_TITLE")})}else{p.show(t.getErrorCode(),{title:y.getText("OVP_GENERIC_ERROR_TITLE")})}}},doCrossApplicationNavigation:function(t,e){var a="#"+t.semanticObject+"-"+t.action;if(t.params){var i=this.oCardComponent&&this.oCardComponent.getComponentData();var r=i&&i.appComponent;if(r){var n=r._formParamString(t.params);a=a+n}}var o=this;if(!sap.ushell.Container){return}sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported([a]).done(function(t){if(t[a].supported===true){if(!!e.params){if(typeof e.params=="string"){try{e.params=JSON.parse(e.params)}catch(t){L.error("Could not parse the Navigation parameters");return}}}var i=o.getOwnerComponent().getComponentData();var r=i?i.globalFilter:undefined;var n=r&&r.getUiState({allFilters:false});var s=n?JSON.stringify(n.getSelectionVariant()):"{}";r=JSON.parse(s);var l=o._getFilterPreference();r=o._removeFilterFromGlobalFilters(l,r);if(!e.params){e.params={}}if(!!r&&!!r.SelectOptions){for(var d=0;d<r.SelectOptions.length;d++){var p=r.SelectOptions[d].Ranges;if(!!p){var g=[];for(var v=0;v<p.length;v++){if(p[v].Sign==="I"&&p[v].Option==="EQ"){g.push(p[v].Low)}}e.params[r.SelectOptions[d].PropertyName]=g}}}sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(e)}else{var h=new c("NavigationHandler.isIntentSupported.notSupported");o.fnHandleError(h)}}).then(function(){L.error("Could not get authorization from isIntentSupported")})},doIntentBasedNavigation:function(t,e,a,i){if(!i){i=b.constants.inplace}var n=this.oCardComponent&&this.oCardComponent.getComponentData();if(n&&n.appComponent&&n.appComponent.ovpConfig&&n.appComponent.ovpConfig.isTeamsModeActive){i=b.constants.explace}if(sap.ushell&&!sap.ushell.Container){return}var o,s,l,d=t?t.getObject():null;var p=this.getCardPropertiesModel(),c=p.getProperty("/customParams");if(t&&typeof t.getAllData==="function"&&c){l=t.getAllData()}else if(p.getProperty("/staticContent")){l={iStaticLinkListIndex:e.iStaticLinkListIndex,bStaticLinkListIndex:true}}if(d&&d.__metadata){delete d.__metadata}var g=r.getNavigationHandler();if(g){if(e){o=this._getEntityNavigationParameters(d,l,t);s={target:{semanticObject:e.semanticObject,action:e.action},appSpecificRoute:e.appSpecificRoute,params:o.sNavSelectionVariant};var v={};if(o.sNavPresentationVariant){v.presentationVariant=o.sNavPresentationVariant}if(a){if(e&&e.semanticObject&&e.action){var h=this.getCardPropertiesModel().getProperty("/staticParameters");s.params=!!h?h:{};this.doCrossApplicationNavigation(e,s)}}else{g.navigate(s.target.semanticObject,s.target.action,s.params,null,this.fnHandleError,v,i)}}}},doAction:function(t,a){this.actionData=e.getActionInfo(t,a,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm()}else{this._callFunction()}},getEntityNavigationEntries:function(t,e){var a=[];var i=this.getEntityType();var r=this.getCardPropertiesModel();var n=r.getProperty("/template");if(!i){return a}if(!e&&!t){if(!this.oCardComponentData.settings.identificationAnnotationPath){var o=r.getProperty("/kpiAnnotationPath");if(o&&n==="sap.ovp.cards.charts.analytical"){e=o;var s=i[e];var p=s&&s.Detail;var c=p.SemanticObject&&p.SemanticObject.String;var v=p.Action&&p.Action.String;if(p.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){if(c&&v){a.push({type:p.RecordType,semanticObject:c,action:v,label:""})}else{L.error("Invalid Semantic object and action configured for annotation "+p.RecordType)}}}}}if(!e){var h=r.getProperty("/identificationAnnotationPath");var f=h?h.split(","):[];if(f&&f.length>1){e=f[0]}else{e=h}}var u=i[e];if(Array.isArray(u)){u=l.sortCollectionByImportance(u);for(var m=0;m<u.length;m++){if(u[m].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){a.push({type:u[m].RecordType,semanticObject:u[m].SemanticObject.String,action:u[m].Action.String,label:u[m].Label?u[m].Label.String:null})}if(u[m].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!u[m].Url.UrlRef){var C=this.getView().getModel();var y=C.oMetaModel;var b=y.createBindingContext(i.$path);var P=d.format(b,u[m].Url);var I=new g({key:"url",value:P});if(t&&n==="sap.ovp.cards.charts.analytical"){C=t.getModel()}I.setModel(C);I.setBindingContext(t);var S=I.getValue();a.push({type:u[m].RecordType,url:S,value:u[m].Value.String,label:u[m].Label?u[m].Label.String:null})}}}return a},getModel:function(){if(this.getView()){return this.getView().getModel()}},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel()}},getCardPropertiesModel:function(){if(!this.oCardPropertiesModel||w(this.oCardPropertiesModel)){this.oCardPropertiesModel=this.getView().getModel("ovpCardProperties")}return this.oCardPropertiesModel},getEntitySet:function(){if(!this.entitySet){var t=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel().getODataEntitySet&&this.getMetaModel().getODataEntitySet(t)}return this.entitySet},getEntityType:function(){if(!this.entityType){if(this.getMetaModel()&&this.getEntitySet()){this.entityType=this.getMetaModel().getODataEntityType(this.getEntitySet().entityType)}}return this.entityType},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer")}return this.cardContentContainer},_processCustomParameters:function(t,e,a){var i=this.getCardPropertiesModel();if(!this.oMainComponent||!i){return}var r;if(t&&t.bStaticLinkListIndex){var n=i.getProperty("/staticContent");r=n[t.iStaticLinkListIndex]["customParams"];t=null}else{r=i.getProperty("/customParams")}if(!r||!this.oMainComponent.templateBaseExtension.provideCustomParameter||!this.oMainComponent.onCustomParams){return}var o=this.oMainComponent.templateBaseExtension.provideCustomParameter(r)?this.oMainComponent.templateBaseExtension.provideCustomParameter(r):this.oMainComponent.onCustomParams(r);if(!o||!N.checkIfFunction(o)){return}var s=S({},t);var l=S({},e);var d=o(s,l);if(!d||!Array.isArray(d)&&!I(d)){return}var p=I(d);if(p&&w(d)){return}var c=p&&(d.bIgnoreEmptyString||d.ignoreEmptyString);var g=p?d.aSelectionVariant||d.selectionVariant:d;if(!Array.isArray(g)){return}var v,h,f,u,m,C;h=g.length;for(v=0;v<h;v++){f=g[v];if(!f){continue}u=f.path;m=f.value1;C=f.value2;if(!u||typeof u!=="string"||u===""){L.error("Custom Variant property path '"+u+"' should be valid string");continue}if(!(m||m===0||m===false||m===""||m===""&&c)){continue}m=m.toString();C=C&&C.toString();if(m===""&&c){e.removeSelectOption(u)}if(t){delete t[u]}if(a){delete a[u]}e.addSelectOption(u,f.sign,f.operator,m,C)}if(c){this._removeEmptyStringsFromSelectionVariant(e)}return c},_getEntityNavigationParameters:function(t,e,n){var o={};var s,d,p;var c=this.getOwnerComponent().getComponentData();var g=c?c.globalFilter:undefined;var h=this.getCardPropertiesModel();var f=h&&h.getProperty("/staticContent");if(!f){var u=l.getCardSelections(this.getCardPropertiesModel());var m=u.filters;var y=u.parameters;var b=this.getEntityType();m&&m.forEach(function(t){t.path=t.path.replace("/",".");switch(t.operator){case v.NE:t.operator=v.EQ;t.sign="E";break;case v.Contains:t.operator="CP";var e=t.value1;t.value1="*"+e+"*";break;case v.EndsWith:t.operator="CP";var e=t.value1;t.value1="*"+e;break;case v.StartsWith:t.operator="CP";var e=t.value1;t.value1=e+"*"}});u.filters=m;if(n&&t&&t.hasOwnProperty("$isOthers")){var P=n.getOtherNavigationDimensions();for(var I in P){var S=P[I];for(var D=0;D<S.length;D++){u.filters.push({path:I,operator:"EQ",value1:S[D],sign:"E"})}}}y&&y.forEach(function(t){t.path=t.path.replace("/",".")});u.parameters=y;var N=l.getCardSorters(this.getCardPropertiesModel());if(t){var I;for(var D=0;b.property&&D<b.property.length;D++){I=b.property[D].name;var w=t[I];if(t.hasOwnProperty(I)){if(Array.isArray(t[I])&&t[I].length===1){o[I]=t[I][0]}else if(jQuery.type(w)!=="object"){o[I]=w}}}}var O=h&&h.getProperty("/kpiAnnotationPath");var T=h&&h.getProperty("/template");if(O&&T==="sap.ovp.cards.charts.analytical"){var k=b[O];var A=k&&k.Detail;if(A&&A.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){o["kpiID"]=k.ID.String}}d=N&&new i(N);s=this._buildSelectionVariant(g,u);p=h&&h.getProperty("/staticParameters")}else{var E=g&&g.getUiState({allFilters:false});var M=E?JSON.stringify(E.getSelectionVariant()):"{}";s=new a(M);var V=this._getFilterPreference();s=this._removeFilterFromGlobalFilters(V,s);if(f[e.iStaticLinkListIndex].params){p=f[e.iStaticLinkListIndex].params}else if(f[e.iStaticLinkListIndex].staticParameters){p=f[e.iStaticLinkListIndex].staticParameters}}var F;if(e&&!e.bStaticLinkListIndex){F=this._processCustomParameters(e,s,o)}else if(e&&e.bStaticLinkListIndex){F=this._processCustomParameters(e,s)}else{F=this._processCustomParameters(o,s)}var L=F?C.navigation.service.SuppressionBehavior.ignoreEmptyString:undefined;if(p){for(var I in p){if(!o.hasOwnProperty(I)){o[I]=p[I]}}}var x=r.getNavigationHandler();var _=x&&x.mixAttributesAndSelectionVariant(o,s.toJSONString(),L);if(!f){this._removeSensitiveAttributesFromNavSelectionVariant(b,_)}return{sNavSelectionVariant:_?_.toJSONString():null,sNavPresentationVariant:d?d.toJSONString():null}},_removeSensitiveAttributesFromNavSelectionVariant:function(t,e){for(var a=0;a<t.property.length;a++){if(t.property[a]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]&&t.property[a]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"].Bool){delete e._mSelectOptions[t.property[a].name]}}},_removeEmptyStringsFromSelectionVariant:function(t){var e=t.getParameterNames();for(var a=0;a<e.length;a++){if(t.getParameter(e[a])===""){t.removeParameter(e[a])}}var i=t.getSelectOptionsPropertyNames();for(a=0;a<i.length;a++){var r=t.getSelectOption(i[a]);for(var n=0;n<r.length;n++){if(r[n].Low===""&&!r[n].High){r.splice(n,1);n--}}if(r.length===0){t.removeSelectOption(i[a])}}return t},_checkIfCardFiltersAreValid:function(t,e){var a=true;if(t&&t.filterAll==="global"){a=false}else if(t&&t.globalFilter){if(t.globalFilter.indexOf(e)>=0){a=false}}return a},_getFilterPreference:function(){var t=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;var e;if(t&&t.mainComponent){e=t.mainComponent._getFilterPreference(t.cardId)}return e},_removeFilterFromGlobalFilters:function(t,e){var a=[];if(t&&t.filterAll==="card"){a=e.getSelectOptionsPropertyNames()}else if(t&&t.cardFilter){a=t.cardFilter}a.forEach(function(t){if(t!=="$.basicSearch"){e.removeSelectOption(t)}});return e},_buildSelectionVariant:function(t,e){var i=t&&t.getUiState({allFilters:false});var r=i?JSON.stringify(i.getSelectionVariant()):"{}";var n=new a(r);var o,s,l,d;var p=this._getFilterPreference();n=this._removeFilterFromGlobalFilters(p,n);var c=e.filters;var g=e.parameters;for(var v=0;v<c.length;v++){o=c[v];if(o.path&&o.operator&&typeof o.value1!=="undefined"){s=o.value1.toString();l=typeof o.value2!=="undefined"?o.value2.toString():undefined;if(this._checkIfCardFiltersAreValid(p,o.path)){n.addSelectOption(o.path,o.sign,o.operator,s,l)}}}var h,f,u;for(var m=0;m<g.length;m++){d=g[m];if(!d.path||!d.value){continue}h=d.path.split("/").pop();h=h.split(".").pop();if(h.indexOf("P_")===0){f=h;u=h.substr(2)}else{f="P_"+h;u=h}if(n.getParameter(f)){continue}if(n.getParameter(u)){continue}n.addParameter(h,d.value)}return n},_loadParametersForm:function(){var t=new h;t.setData(this.actionData.parameterData);var a=this;var i=new f("ovpCardActionDialog",{title:this.actionData.sFunctionLabel,afterClose:function(){i.destroy()}}).addStyleClass("sapUiNoContentPadding");var r=new u({text:this.actionData.sFunctionLabel,press:function(t){var r=e.getParameters(t.getSource().getModel(),a.actionData.oFunctionImport);i.close();a._callFunction(r,a.actionData.sFunctionLabel)}});var n=new u({text:"Cancel",press:function(){i.close()}});i.setBeginButton(r);i.setEndButton(n);var o=function(t){var i=e.mandatoryParamsMissing(t.getSource().getModel(),a.actionData.oFunctionImport);r.setEnabled(!i)};var s=e.buildParametersForm(this.actionData,o);i.addContent(s);i.setModel(t);i.open()},_callFunction:function(t,e){var a={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:t,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var i=this;var n=new Promise(function(t,r){var n=i.actionData.oContext.getModel();var o;o="/"+a.functionImport.name;n.callFunction(o,{method:a.functionImport.httpMethod,urlParameters:a.urlParameters,batchGroupId:a.batchGroupId,changeSetId:a.changeSetId,headers:a.headers,success:function(e,a){t(a)},error:function(t){t.actionText=e;r(t)}})});n.then(function(t){return m.show(y.getText("Toast_Action_Success"),{duration:1e3})},function(t){var e=r.showODataErrorMessages(t);if(e===""&&t.actionText){e=y.getText("Toast_Action_Error")+' "'+t.actionText+'"'+"."}return p.error(e,{title:y.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:F.Inherit})})},setErrorState:function(){var t=this.getOwnerComponent();if(!t||!t.oContainer){return}var e=t.oContainer;var a=this.getCardPropertiesModel();var i={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:a.getProperty("/category"),title:a.getProperty("/title"),description:a.getProperty("/description"),entitySet:a.getProperty("/entitySet"),state:b.loadingState.ERROR,template:a.getProperty("/template")}}};A.create(i).then(function(a){e.setComponent(a);setTimeout(function(){t.destroy()},0)})},changeSelection:function(t,e,a){if(!e){var i=this.getView().byId("ovp_card_dropdown");t=parseInt(i.getSelectedKey(),10)}var r={};if(!e){r=this.getCardPropertiesModel().getProperty("/tabs")[t-1]}else{r=a.tabs[t-1]}var o={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:t};for(var s in r){o[s]=r[s]}if(n.checkIfAPIIsUsed(this)){n.recreateCard(o,this.getOwnerComponent().getComponentData())}else{this.getOwnerComponent().getComponentData().mainComponent.recreateCard(o);this.getOwnerComponent().getComponentData().mainComponent.setOrderedCardsSelectedKey(this.getOwnerComponent().getComponentData().cardId,t)}},getItemHeight:function(t,e,a){if(!!t){var i=t.getView().byId(e);var r=0;if(!!i){if(a){if(i.getItems()[0]&&i.getItems()[0].getDomRef()){r=N.getOuterHeight(i.getItems()[0].getDomRef())}}else{if(i.getDomRef()){r=N.getOuterHeight(i.getDomRef())}}}return r}},getHeaderHeight:function(){var t=this.getItemHeight(this,"ovpCardHeader"),e=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;if(e&&e.appComponent){var a=e.appComponent.getDashboardLayoutUtil(),i=a.getDashboardLayoutModel().getCardById(e.cardId);if(t!==0){i.dashboardLayout.headerHeight=t}}return t},onShowAdditionalCardActions:function(t){var e=t.getSource();t.cancelBubble();if(!this.additionalCardActionsPopover){this.additionalCardActionsPopover=V.load({id:this.getView().getId(),name:"sap.ovp.cards.generic.HeaderActions",controller:this}).then(function(t){this.getView().addDependent(t);return t}.bind(this))}this.additionalCardActionsPopover.then(function(t){t.openBy(e)})},saveGeneratedCardManifest:function(t){var e=this.oCardComponentData.cardId,a=this.oCardComponentData.settings.selectedKey,i=this.getView(),r=i.getModel("ovpCardProperties"),n=r&&r.getProperty("/bInsightDTEnabled");if(n){var o=a?e+"/tab_"+a:e;jQuery.ajax({type:"POST",url:"/editor/card/"+o+"/manifest",headers:{"Content-Type":"application/json"},data:JSON.stringify(t),success:function(t){L.info("Success:",t)},error:function(t){L.error("Error:",t)}})}},refreshCardContent:function(){if(this.getKPIBinding()){this.getKPIBinding().refresh()}if(this.getCardItemsBinding()){this.getCardItemsBinding().refresh()}}})});
//# sourceMappingURL=Card.controller.js.map
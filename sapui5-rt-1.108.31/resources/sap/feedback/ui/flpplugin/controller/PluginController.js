/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/base/Log","../utils/Constants","../utils/Utils","../utils/ScopeCheck","../utils/UI5Utils","./ContextDataController","../push/config/trigger/TriggerType","../push/DynamicPushTrigger","../ui/ShellBarButton","../ui/PopOverVisual","./WebAppFeedbackLoader","../utils/Storage","../survey/RequestDispatcher","../survey/SurveyFactory"],function(t,e,i,n,o,a,r,s,u,h,l,_,c,d,g){"use strict";return t.extend("sap.feedback.ui.flpplugin.controller.PluginController",{_oStartupConfig:null,_oCentralConfig:null,_oContextDataController:null,_oShellButton:null,_oWebAppFeedbackLoader:null,_fnRendererPromise:null,_oResourceBundle:null,_oLocalStorage:null,_sLastThemeId:null,_sCurrentThemeId:null,_oRequestDispatcher:null,_oDynamicPushTrigger:null,constructor:function(t,e,i){this._oStartupConfig=t;this._fnRendererPromise=e;this._oResourceBundle=i},init:function(){if(this._initStorage()){this._initLastTheme();return new Promise(function(t,n){if(this._oStartupConfig){this._initAndGetCentralConfiguration().then(function(o){if(o){this._initContextData();this._initRequestDispatcher(o);this._initUI();this._initWebAppFeedback();this._initDynamicPushTrigger(o);this._updateInitialContextData().then(function(){t()}).catch(function(n){e.error("Fiori Feedback Plug-in error occured on updating context data on init.",n.message,i.S_PLUGIN_PLGCTRL_NAME);t()})}else{n()}}.bind(this))}else{n()}}.bind(this))}else{return Promise.reject()}},_initStorage:function(){if(n.isLocalStorageAvailable()){this._oLocalStorage=new c;this._oLocalStorage.init();return true}return false},_initLastTheme:function(){var t=a.getTheme();var e=t;if(this._oLocalStorage){e=this._oLocalStorage.getLastTheme();if(!e){e=t}}this._updateThemeState(e,t,true)},_initContextData:function(){this._oContextDataController=new r(this._oStartupConfig);return this._oContextDataController.init()},_initRequestDispatcher:function(t){if(this._oLocalStorage){if(o.isFeaturePushAvailable(this._oStartupConfig)||o.isDynamicPushAvailable(this._oStartupConfig)){if(!this._oRequestDispatcher){this._oRequestDispatcher=new d;this._oRequestDispatcher.init(this._oStartupConfig,t,this._oContextDataController,this._oResourceBundle,this._oLocalStorage)}}}},_initAndGetCentralConfiguration:function(){var t=g.createCentralConfiguration();var e=g.createConfigurationLoader();e.init(this._oStartupConfig);return e.getPushConfiguration().then(function(e){t.setPushConfig(e);this._oCentralConfig=t;return t}.bind(this)).catch(function(){return null})},_initUI:function(){this._oVisual=new l;if(this._oVisual){this._oShellButton=new h(this._fnRendererPromise,this._onSurveyShow.bind(this),this._oResourceBundle);this._oShellButton.init()}},_initWebAppFeedback:function(){this._oWebAppFeedbackLoader=new _(this._oStartupConfig);this._oWebAppFeedbackLoader.init(this._onAPILoadedCallback.bind(this));this._oWebAppFeedbackLoader.loadAPI()},_initDynamicPushTrigger:function(t){if(o.isDynamicPushAvailable(this._oStartupConfig)&&this._oRequestDispatcher){this._oDynamicPushTrigger=new u(t,this._oLocalStorage);this._oDynamicPushTrigger.init(this._oRequestDispatcher.handleDynamicPush.bind(this._oRequestDispatcher))}},_initGenericFeaturePushTriggers:function(){if(o.isFeaturePushAvailable(this._oStartupConfig)){sap.ui.getCore().attachThemeChanged(function(t){this._onThemeChanged(t)}.bind(this))}},_updateInitialContextData:function(){return this._oContextDataController.updateContextData(i.E_CLIENT_ACTION.init)},_onAPILoadedCallback:function(){return this._oContextDataController.updateContextData(i.E_CLIENT_ACTION.init).then(function(){a.getAppLifeCycleService().attachAppLoaded({},this._onAppLoaded,this);this._initGenericFeaturePushTriggers()}.bind(this)).catch(function(t){e.error("Fiori Feedback Plug-in error occured on updating context data on load.",t.message,i.S_PLUGIN_PLGCTRL_NAME)})},_openSurvey:function(t,e){if(this._oContextDataController){this._oContextDataController.setClientAction(t);this._oContextDataController.setLastTheme(this._sLastThemeId);this._oContextDataController.setFollowUpCount(e)}QSI.API.unload();QSI.API.load().then(function(){QSI.API.run()})},_onSurveyShow:function(){return new Promise(function(t,n){if(this._oWebAppFeedbackLoader.getIsAPILoaded()){this._oContextDataController.updateContextData(i.E_CLIENT_ACTION.navBarClick,null).then(function(){this._oVisual.show();t()}.bind(this)).catch(function(t){e.error("Fiori Feedback Plug-in error occured on updating context data on show.",t.message,i.S_PLUGIN_PLGCTRL_NAME);n()})}}.bind(this))},_onAppLoaded:function(){return this._oContextDataController.updateContextData(i.E_CLIENT_ACTION.appLoaded).then(function(){if(o.isFeaturePushAvailable(this._oStartupConfig)){sap.ui.getCore().getEventBus().publish("sap.feedback","inapp.feature",{areaId:i.S_GENERIC_TRIGGER_AREAID,triggerName:s.E_TRIGGER_TYPE.recurring})}}.bind(this)).catch(function(t){e.error("Fiori Feedback Plug-in error occured on updating context data.",t.message,i.S_PLUGIN_PLGCTRL_NAME)})},_onThemeChanged:function(t){var n=t.getParameters().theme;if(this._sCurrentThemeId!==n){this._updateThemeState(this._sCurrentThemeId,n,false);return this._oContextDataController.updateContextData(i.E_CLIENT_ACTION.themeChanged).then(function(){sap.ui.getCore().getEventBus().publish("sap.feedback","inapp.feature",{areaId:i.S_GENERIC_TRIGGER_AREAID,triggerName:s.E_TRIGGER_TYPE.themeChanged})}).catch(function(t){e.error("Fiori Feedback Plug-in error occured on updating context data.",t.message,i.S_PLUGIN_PLGCTRL_NAME)})}},_updateThemeState:function(t,e,i){if(this._oLocalStorage){if(!i){this._updateThemeToggleStart(t,e)}this._oLocalStorage.updateLastTheme(t);this._sLastThemeId=t;this._oLocalStorage.updateCurrentTheme(e);this._sCurrentThemeId=e}else{this._sCurrentThemeId=e}},_updateThemeToggleStart:function(t,e){if(this._oLocalStorage){if(n.isHorizonTheme(e)){this._oLocalStorage.setThemeToggleStart(Date.now())}else if(n.isHorizonTheme(t)){this._oLocalStorage.deleteThemeToggleStart()}}}})});
//# sourceMappingURL=PluginController.js.map
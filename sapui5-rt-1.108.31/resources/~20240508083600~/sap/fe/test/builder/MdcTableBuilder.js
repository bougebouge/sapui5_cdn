/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/test/Opa5","sap/ui/test/OpaBuilder","./FEBuilder","./MacroFieldBuilder","./OverflowToolbarBuilder","./DialogBuilder","sap/fe/test/Utils","sap/fe/test/api/APIHelper","sap/ui/test/matchers/Interactable","sap/ui/core/SortOrder","sap/ui/test/actions/EnterText"],function(e,t,n,r,s,o,a,i,c,u,l){"use strict";var p={Custom:"Custom",Navigation:"Navigation",Delete:"Delete"};var h=function(){return n.apply(this,arguments).hasType("sap.ui.mdc.Table")};function f(e){return e.getType().isA("sap.ui.mdc.table.GridTableType")}function d(e){return f(e)?"rows":"items"}function g(e,t){var n=Number(e);return Number.isNaN(n)?t.getColumns().findIndex(function(t){return t.getHeader()===e||t.getDataProperty()===e}):n}function m(e){var t=e;while(t&&!t.isA("sap.ui.mdc.Table")){t=t._feMdcTableWrapper||t.getParent()}return t}function M(e,t){var n=m(t);return n?g(e,n):-1}function y(e,t){var n;if(!e){return null}if(e.isA("sap.ui.mdc.table.CreationRow")){n=e._oInnerCreationRow._getCell(t)}else if(e.isA("sap.ui.table.CreationRow")){n=e._getCell(t)}else{n=e.getCells()[t]}if(n.isA("sap.fe.macros.MacroAPI")){n=n.getContent()}return n}function T(e,r){if(e.isA("sap.fe.macros.MacroAPI")){e=e.getContent()}var s={controlType:"sap.m.Button"},o;if(r){s.text=r}o=n.Matchers.states(s);return o(e)?[e]:t.Matchers.children(o)(e)}function A(e,t){var n=Number(e);if(Number.isNaN(n)){return t.getCells().reduce(function(t,n){return t.concat(T(n,e))},[])}return T(y(t,n))}function C(e){var t=e.getRowAction();return t.getItems().reduce(function(e,n,r){if(!e&&n.getType()===p.Navigation){e=t.getAggregation("_icons")[r]}return e},null)}function w(e){var t=[new c,n.Matchers.bound()];if(a.isOfType(e,Object)){e=h.Row.Matchers.cellValues(e)}if(e){t=t.concat(e)}return t}function b(e){return e&&e._oTable}function O(e,n,r,s){s=s||"sap.m.Button";return e.doOpenOverflow().success(function(e){return t.create().hasType(s).hasId(RegExp(a.formatMessage("-{0}$",n))).has(t.Matchers.ancestor(e)).doConditional(!!r,r).execute()})}function v(e,t){return{getHeader:function(){return t?e.getLabel()&&e.getLabel().getText()||e.getName():e.getHeader()&&e.getHeader().getText()},getDataProperty:function(){return"$data property not available$"}}}function I(e){var t=e.isA("sap.ui.table.Table"),n={_oTable:e,isA:function(e){return e==="sap.ui.mdc.Table"},getType:function(){return{isA:function(e){return e===(t?"sap.ui.mdc.table.GridTableType":"sap.ui.mdc.table.ResponsiveTableType")}}},getColumns:function(){return e.getColumns().map(function(e){return v(e,t)})},getRowBinding:function(){return e.getBinding(d(n))}};e._feMdcTableWrapper=n;return n}function S(e){var r;if(e!==undefined){r=e?"showDetails":"hideDetails"}t.create().hasType("sap.m.SegmentedButton").hasId(/-showHideDetails$/).check(function(t){if(e===undefined){r=t[0].getSelectedKey()==="showDetails"?"hideDetails":"showDetails"}return true}).success(function(e){return n.create().hasType("sap.m.SegmentedButton").hasId(/-showHideDetails$/).doOnAggregation("items",t.Matchers.properties({key:r}),t.Actions.press()).execute()}).execute()}function R(r){var s=e.getWindow().sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc"),o;if(r!==undefined){o=r?s.getText("table.SHOWDETAILS_TEXT"):s.getText("table.HIDEDETAILS_TEXT")}return t.create().hasType("sap.m.Select").hasId(/-showHideDetails-select$/).check(function(e){if(r===undefined){o=e[0].getSelectedItem().getText()===s.getText("table.SHOWDETAILS_TEXT")?s.getText("table.HIDEDETAILS_TEXT"):s.getText("table.SHOWDETAILS_TEXT")}return true}).doPress().success(function(e){return n.create().hasType("sap.m.SelectList").isDialogElement(true).has(function(e){return true}).has(i.createMenuAndListActionMatcher(o,true)).doPress().description(a.formatMessage("Executing action '{0}' from currently open selection list",o)).execute()}).execute()}h.create=function(e){return new h(e)};h.createWrapper=function(e,t,n){var r=new h(e).hasType(t);if(n){r.has(n)}return r.has(function(e){return I(e)})};h.prototype=Object.create(n.prototype);h.prototype.constructor=h;h.prototype.getStatesMatcher=function(e){return h.Matchers.states(e)};h.prototype.hasColumns=function(e,t){if(!e||Object.keys(e).length===0){return this}return this.has(h.Matchers.columnsMatcher(e,t))};h.prototype.hasTitle=function(e){return this.hasChildren(n.create(this).hasType("sap.m.Title").hasProperties({text:e}))};h.prototype.hasSearchField=function(e,r){var s=a.parseArguments([String,Object],arguments);r=s[1];var o=new h(this.getOpaInstance(),this.build()).hasConditional(r&&r.visible===false,t.Matchers.not(n.Matchers.deepAggregationMatcher("actions/action",n.Matchers.id(/BasicSearch$/))),t.Matchers.childrenMatcher(n.create(this).hasType("sap.fe.macros.table.BasicSearch").checkNumberOfMatches(1).hasProperties(r).hasAggregation("filter",t.Matchers.properties(s[0]?{value:e}:{}))));return this.doOpenOverflow().success(o)};h.prototype.hasRows=function(e,t){e=w(e);return t?this.has(h.Matchers.rows(e)):this.has(h.Matchers.rowsMatcher(e))};h.prototype.doOnRows=function(e,n){if(arguments.length===1){n=e;e=undefined}if(!n){return this}return this.hasRows(e,true).do(t.Actions.executor(n))};h.prototype.doClickOnCell=function(e,n){return this.doOnRows(e,h.Row.Actions.onCell(n,t.Actions.press()))};h.prototype.doClickOnRow=function(e){return this.doOnRows(e,function(e){if(e.getMetadata().getName()==="sap.ui.table.Row"){var n=e.getParent(),r=n.indexOfRow(e);return t.Actions.press("rows-row"+r+"-col0").executeOn(n)}return t.Actions.press().executeOn(e.getMultiSelectControl()||e.getSingleSelectControl())})};h.prototype.doScroll=function(e){return this.do(function(t){switch(e){case"up":t.scrollToIndex(0);break;case"down":default:t.scrollToIndex(-1);break}})};h.prototype.doPressKeyboardShortcut=function(e,t,r){if(t&&r){return this.doOnRows(t,h.Row.Actions.onCell(r,n.Actions.keyboardShortcut(e,"input")))}return this.do(n.Actions.keyboardShortcut(e,true))};h.prototype.doEditValues=function(e,t,n){if(arguments.length===1){t=e;e=undefined}return this.hasColumns(t,true).doOnRows(e,h.Row.Actions.editCells(t,n))};h.prototype.doEditCreationRowValues=function(e,n){return this.hasColumns(e,true).has(t.Matchers.aggregation("creationRow")).do(h.Row.Actions.editCells(e,n))};h.prototype.doSelect=function(e){return this.doOnRows(e,function(e){if(e.getMetadata().getName()==="sap.ui.table.Row"){var n=e.getParent(),r=n.indexOfRow(e);return t.Actions.press("rowsel"+r).executeOn(n)}return t.Actions.press().executeOn(e.getMultiSelectControl()||e.getSingleSelectControl())})};h.prototype.doSelectAll=function(){return this.do(function(e){var n=f(e);if(n){return t.Actions.press("selall").executeOn(e.getAggregation("_content"))}return t.Actions.press("sa").executeOn(e.getAggregation("_content"))})};h.prototype.doNavigate=function(e){return this.doOnRows(e,function(e){if(e.getMetadata().getName()==="sap.ui.table.Row"){return t.Actions.press().executeOn(C(e))}return t.Actions.press("imgNav").executeOn(e)})};h.prototype.doPressColumnHeader=function(e){return this.has(h.Matchers.columnControl(e)).has(n.Matchers.singleElement()).doPress()};h.prototype.doColumnHeaderAction=function(e,n,r){var s=t.create().isDialogElement().hasType(r?"sap.m.ToggleButton":"sap.m.Button").hasProperties({icon:n}).doPress();if(r){s.success(t.create().isDialogElement().hasType("sap.m.StandardListItem").hasProperties({title:r}).doPress())}return this.doPressColumnHeader(e).success(s)};h.prototype.doSortByColumn=function(e,t,n){var r="sap-icon://sort-ascending";if(n){r="sap-icon://sort-descending"}return this.doColumnHeaderAction(e,r,t)};h.prototype.doGroupByColumn=function(e,t){return this.doColumnHeaderAction(e,"sap-icon://group-2",t)};h.prototype.doAggregateByColumn=function(e,t){return this.doColumnHeaderAction(e,"sap-icon://sum",t)};h.prototype.doChangeSearch=function(e){var n=new h(this.getOpaInstance(),this.build()).doOnChildren(t.create(this).hasType("sap.fe.macros.table.BasicSearch").checkNumberOfMatches(1).doOnAggregation("filter",t.Actions.press(),t.Actions.enterText(e||"")));return this.doOpenOverflow().success(n)};h.prototype.doResetSearch=function(){var e=new h(this.getOpaInstance(),this.build()).doOnChildren(t.create(this).hasType("sap.fe.macros.table.BasicSearch").checkNumberOfMatches(1).doOnAggregation("filter",t.Actions.press(),t.Actions.press("reset")));return this.doOpenOverflow().success(e)};h.prototype.checkColumnHeaderAction=function(e,n,r,s){var o;if(!r){if(s===undefined){o=t.create().isDialogElement().hasProperties({icon:n}).checkNumberOfMatches(1)}else if(s===1){o=t.create().isDialogElement().hasType("sap.m.Button").hasProperties({icon:n}).checkNumberOfMatches(1)}else{o=t.create().isDialogElement().hasType("sap.m.ToggleButton").hasProperties({icon:n}).doPress();o.success(t.create().isDialogElement().hasType("sap.m.StandardListItem").checkNumberOfMatches(s).success(t.create().isDialogElement().hasType("sap.m.Button").hasProperties({icon:"sap-icon://decline"}).doPress()))}}else{if(s===undefined){s=1}o=t.create().isDialogElement().hasType("sap.m.ToggleButton").hasProperties({icon:n}).doPress();o.success(t.create().isDialogElement().hasType("sap.m.StandardListItem").hasProperties({title:r}).checkNumberOfMatches(s).success(t.create().isDialogElement().hasType("sap.m.Button").hasProperties({icon:"sap-icon://decline"}).doPress()))}return this.doPressColumnHeader(e).success(o)};h.prototype.hasGroupByColumn=function(e,t,n){return this.checkColumnHeaderAction(e,"sap-icon://group-2",t,n)};h.prototype.hasAggregationColumn=function(e,t,n){return this.checkColumnHeaderAction(e,"sap-icon://sum",t,n)};h.prototype.doExpand=function(e){return this.doOnRows(e,function(e){if(e.getMetadata().getName()==="sap.ui.table.Row"){e.expand()}})};h.prototype.doCollapse=function(e){return this.doOnRows(e,function(e){if(e.getMetadata().getName()==="sap.ui.table.Row"){e.collapse()}})};h.prototype.hasOverlay=function(e){return this.has(h.Matchers.overlay(e))};h.prototype.hasNumberOfRows=function(e){return this.has(function(t){var n=t.getRowBinding(),r=h.Matchers.overlay(true)(t);return n&&!r&&(e===undefined?n.getLength()!==0:n.getLength()===e)||(!n||r)&&e===0})};h.prototype.hasHeaderFocused=function(){return this.has(function(t){var n=e.getWindow().sap.ui.getCore(),r=n.getCurrentFocusedControlId(),s=b(t);if(f(t)){return s.getColumns()[0].getId()===r}else{return s.getId()===r}})};h.prototype.hasFocusOnRow=function(t){return this.has(function(n){var r=e.getWindow().sap.ui.getCore(),s=r.getCurrentFocusedControlId(),o=b(n);if(f(n)){return s.includes(o.getRows()[t].getId())}else{return s===o.getItems()[t].getId()}})};h.prototype.hasQuickFilterItems=function(e){return this.has(function(t){var n=t.getQuickFilter();if(n){var r=n.getSelector().getItems();if(a.isOfType(r,Array)){return r.length===e}return false}return false})};h.prototype.doSelectQuickFilter=function(e){return this.has(function(e){return e.getQuickFilter().getSelector()}).doConditional(n.Matchers.state("controlType","sap.m.Select"),t.Actions.press()).success(function(r){return n.create(this).hasId([].concat(r)[0].getId()).doOnAggregation("items",e,t.Actions.press()).execute()}.bind(this))};h.prototype.doPressMore=function(){return this.do(function(e){return n.create(this).hasId(e._oTable.getId("trigger")).do(t.Actions.press()).execute()}.bind(this))};h.prototype.doOpenOverflow=function(){return s.openOverflow(this,"toolbar")};h.prototype.doCloseOverflow=function(){return s.closeOverflow(this,"toolbar")};h.prototype.doExecuteAction=function(e,r){var s=new h(this.getOpaInstance(),this.build()),o=function(e){return!!e.getText},a=n.Matchers.deepAggregation("actions/action",[o,e]),i=function(e){return e.getAggregation("_button")?e.getAggregation("_button").getAggregation("_textButton"):null},c=function(){s.has(function(e){return a(e).length===1}).do(function(e){var n=a(e)[0],s=n.getMetadata().getName()==="sap.m.MenuButton"?i(n)||n:n;t.Actions.executor(r||t.Actions.press())(s)}).execute()};return this.doOpenOverflow().success(c)};h.prototype.doClickOnMessageStripFilter=function(){return this.do(function(e){var n=e.getDataStateIndicator()._oLink;return t.create().hasType("sap.m.Link").hasId(n.getId()).description("Press the messageStrip filter on Table").doPress().execute()})};h.prototype.hasShowHideDetails=function(){return O(this,"showHideDetails",false)};h.prototype.doShowHideDetails=function(e){return this.doOpenOverflow().success(function(n){if(f(n)){return}t.create().hasType("sap.m.SegmentedButton").hasId(/-showHideDetails$/).doConditional(t.Matchers.childrenMatcher(t.create(this).hasType("sap.m.Select"),true),function(t){R(e);return true},function(t){S(e);return true}).execute()})};h.prototype.hasColumnAdaptation=function(){return O(this,"settings",false)};h.prototype.doOpenColumnAdaptation=function(){return O(this,"settings",t.Actions.press())};h.prototype.hasColumnSorting=function(){return O(this,"settings",false)};h.prototype.doOpenColumnSorting=function(){return O(this,"settings",t.Actions.press()).success(t.create(this.getOpaInstance()).isDialogElement().hasType("sap.m.IconTabBar").has(t.Matchers.aggregation("items",t.Matchers.resourceBundle("text","sap.ui.mdc","p13nDialog.TAB_Sort"))).has(n.Matchers.singleElement()).doPress().description("Selecting Icon Tab Sort"))};h.prototype.hasColumnFiltering=function(){return O(this,"filter",false)};h.prototype.doOpenColumnFiltering=function(){return O(this,"settings",t.Actions.press()).success(t.create(this.getOpaInstance()).isDialogElement().hasType("sap.m.IconTabBar").has(t.Matchers.aggregation("items",t.Matchers.resourceBundle("text","sap.ui.mdc","p13nDialog.TAB_Filter"))).has(n.Matchers.singleElement()).doPress().description("Selecting Icon Tab Filter"))};h.prototype.hasColumnExport=function(){return O(this,"export",false,"sap.m.MenuButton")};h.prototype.hasPaste=function(){return O(this,"paste",false,"sap.m.MenuButton")};h.prototype.doExecuteInlineAction=function(e,t){return this.doOnRows(e,h.Row.Actions.pressInlineAction(t))};h.prototype.doPasteData=function(e){return this.do(function(t){t.firePaste({data:e})})};h.createAdaptationDialogBuilder=function(e){return o.create(e).hasSome(t.Matchers.resourceBundle("title","sap.ui.mdc","table.SETTINGS_COLUMN"),t.Matchers.resourceBundle("title","sap.ui.mdc","p13nDialog.VIEW_SETTINGS"))};h.createSortingDialogBuilder=function(e){return o.create(e).has(t.Matchers.resourceBundle("title","sap.ui.mdc","p13nDialog.VIEW_SETTINGS")).hasChildren(t.create(e).hasType("sap.m.IconTabFilter").has(t.Matchers.resourceBundle("text","sap.ui.mdc","p13nDialog.TAB_Sort")))};h.createFilteringDialogBuilder=function(e){return o.create(e).has(t.Matchers.resourceBundle("title","sap.ui.mdc","p13nDialog.VIEW_SETTINGS")).hasChildren(t.create(e).hasType("sap.m.IconTabFilter").has(t.Matchers.resourceBundle("text","sap.ui.mdc","p13nDialog.TAB_Filter")))};h.Cell={Matchers:{state:function(e,t){switch(e){case"editor":case"editors":return function(e){return r.Matchers.states(t)(e)};default:return n.Matchers.state(e,t)}},states:function(e){return n.Matchers.states(e,h.Cell.Matchers.state)}}};h.Column={Matchers:{state:function(e,t){switch(e){case"sortOrder":return h.Column.Matchers.sortOrder(t);case"template":case"creationTemplate":return function(n){return r.Matchers.states(t)(n.getAggregation(e))};default:return n.Matchers.state(e,t)}},states:function(e){return n.Matchers.states(e,h.Column.Matchers.state)},sortOrder:function(e){return function(t){var r=t.getParent(),s=f(r),o={};if(s){o.sorted=e===u.None?false:true;if(e!==u.None){o.sortOrder=e}}else{o.sortIndicator=e}return n.controlsExist(n.create().hasId(t.getId()+"-innerColumn").hasProperties(o))}}}};h.Row={Matchers:{cell:function(e){return function(t){var n=M(e,t);return y(t,n)}},cellValue:function(e,t){return function(n){if(n.isA("sap.m.GroupHeaderListItem")){return null}var s=h.Row.Matchers.cell(e)(n);while(s.isA("sap.fe.macros.MacroAPI")){s=s.getContent()}return r.Matchers.value(t)(s)}},cellValues:function(e){if(!e){return t.Matchers.TRUE}return n.Matchers.match(Object.keys(e).map(function(t){return h.Row.Matchers.cellValue(t,e[t])}))},emptyCell:function(e){return function(t){var n=h.Row.Matchers.cell(e)(t);while(n.isA("sap.fe.macros.MacroAPI")){n=n.getContent()}return r.Matchers.empty(n)}},emptyCells:function(e){if(!e||e.length===0){return t.Matchers.TRUE}return n.Matchers.match(e.map(function(e){return h.Row.Matchers.emptyCell(e)}))},cellProperty:function(e,t){return function(n){var r=h.Row.Matchers.cell(e)(n);while(r.isA("sap.fe.macros.MacroAPI")){r=r.getContent()}return h.Cell.Matchers.states(t)(r)}},cellProperties:function(e){if(!e){return t.Matchers.TRUE}return n.Matchers.match(Object.keys(e).map(function(t){return h.Row.Matchers.cellProperty(t,e[t])}))},selected:function(e){return function(t){var n=t.getParent(),r=n.getParent(),s=f(r),o=s?r.getSelectedContexts().includes(t.getBindingContext()):t.getSelected();return e?o:!o}},navigated:function(e){return function(t){var n;if(t.getMetadata().getName()==="sap.ui.table.Row"){n=t.getAggregation("_settings").getNavigated()}else{n=t.getNavigated()}return e?n:!n}},focused:function(){return function(e){var n=[e];if(e.getMetadata().getName()==="sap.ui.table.Row"){n.push(C(e))}return n.some(t.Matchers.focused(true))}},highlighted:function(e){return function(t){var n;if(t.getMetadata().getName()==="sap.ui.table.Row"){n=t.getAggregation("_settings").getHighlight()}else{n=t.getHighlight()}return e===n}},isDraft:function(e){var n=t.Matchers.childrenMatcher(function(e){return e.isA("sap.m.ObjectMarker")},false);if(e){return n}else{return t.Matchers.not(n)}},states:function(e){if(!a.isOfType(e,Object)){return t.Matchers.TRUE}return n.Matchers.match(Object.keys(e).map(function(t){switch(t){case"selected":return h.Row.Matchers.selected(e.selected);case"focused":return h.Row.Matchers.focused();case"navigated":return h.Row.Matchers.navigated(e.navigated);case"highlight":return h.Row.Matchers.highlighted(e.highlight);case"isDraft":return h.Row.Matchers.isDraft(e.isDraft);default:return n.Matchers.state(t,e[t])}}))},visualGroup:function(e,t){return function(n){if(n.getMetadata().getName()==="sap.ui.table.Row"){return n.getLevel()===e&&n.getTitle()===t}else{return false}}}},Actions:{onCell:function(e,t){return function(n){var r=M(e,n),s=y(n,r);if(s.isA("sap.fe.core.controls.FieldWrapper")){s=s.getEditMode()==="Display"?s.getContentDisplay():s.getContentEdit()[0]}if(s.isA("sap.m.VBox")){s=s.getItems()[0].getContent().getEditMode()==="Display"?s.getItems()[0].getContent().getContentDisplay():s.getItems()[0].getContent().getContentEdit()[0]}if(s.isA("sap.fe.core.controls.ConditionalWrapper")){s=s.getCondition()?s.getContentTrue():s.getContentFalse()}if(t.executeOn){t.executeOn(s)}else{t(s)}}},editCell:function(e,t,n){return h.Row.Actions.onCell(e,new l({text:t,clearTextFirst:true,keepFocus:n?true:false,idSuffix:null,pressEnterKey:n?false:true}))},editCells:function(e,t){return Object.keys(e).map(function(n){return h.Row.Actions.editCell(n,e[n],t)})},onCellInlineAction:function(e,n){return function(r){var s=A(e,r);return t.Actions.executor(n)(s)}},pressInlineAction:function(e){return h.Row.Actions.onCellInlineAction(e,t.Actions.press())}}};h.Matchers={isGridTable:function(){return f},rows:function(e){return function(n){if(h.Matchers.overlay(true)(n)){return[]}return t.Matchers.aggregation(d(n),e)(n._oTable)}},rowsMatcher:function(e){var t=h.Matchers.rows(e);return function(e){return t(e).length>0}},columnControl:function(e){return function(t){var n=g(e,t),r=b(t);return r.getColumns()[n]}},column:function(e,t){return function(r){var s=g(e,r),o=a.getAggregation(r,"columns");if(s===-1){if(t&&t.visible===false){return true}}else{var i=o[s];if(!t||n.Matchers.match(h.Column.Matchers.states(t))(i)){return i}}return false}},columns:function(e,t){return function(n){return Object.keys(e).reduce(function(r,s){var o=h.Matchers.column(s,t?undefined:e[s])(n);if(o){r.push(o===true?null:o)}return r},[])}},columnsMatcher:function(e,t){var n=h.Matchers.columns(e,t);return function(t){return n(t).length===Object.keys(e).length}},overlay:function(e){if(e===undefined){e=true}return function(t){t=t._feMdcTableWrapper||t;return t&&t._oTable.getShowOverlay()===e}},state:function(e,t){switch(e){case"overlay":return h.Matchers.overlay(t);default:return n.Matchers.state(e,t)}},states:function(e){return n.Matchers.states(e,h.Matchers.state)}};h.Actions={};return h});
//# sourceMappingURL=MdcTableBuilder.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["@sap/cds-compiler","fs","@prettier/plugin-xml","path","prettier","sap/base/Log","sap/base/util/merge","sap/fe/core/buildingBlocks/BuildingBlockRuntime","sap/fe/core/converters/ConverterContext","sap/fe/core/services/SideEffectsServiceFactory","sap/fe/core/TemplateModel","sap/ui/base/BindingParser","sap/ui/core/Component","sap/ui/core/InvisibleText","sap/ui/core/util/serializer/Serializer","sap/ui/core/util/XMLPreprocessor","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/preprocessors/XmlPreprocessor","sap/ui/fl/initial/_internal/Storage","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/lib/_MetadataRequestor","sap/ui/model/odata/v4/ODataMetaModel","xpath"],function(e,t,r,n,o,a,i,c,s,u,l,f,m,p,d,v,g,y,h,b,x,P,w,j){"use strict";var S={};var C=c.registerBuildingBlock;var O=o.format;function M(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=k(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var n=0;var o=function(){};return{s:o,n:function(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,i=false,c;return{s:function(){r=r.call(e)},n:function(){var e=r.next();a=e.done;return e},e:function(e){i=true;c=e},f:function(){try{if(!a&&r.return!=null)r.return()}finally{if(i)throw c}}}}function A(e){return I(e)||B(e)||k(e)||T()}function T(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function B(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function I(e){if(Array.isArray(e))return D(e)}function F(e,t){return R(e)||L(e,t)||k(e,t)||E()}function E(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function k(e,t){if(!e)return;if(typeof e==="string")return D(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return D(e,t)}function D(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++){n[r]=e[r]}return n}function L(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,a,i,c=[],s=!0,u=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;s=!1}else for(;!(s=(n=a.call(r)).done)&&(c.push(n.value),c.length!==t);s=!0){}}catch(e){u=!0,o=e}finally{try{if(!s&&null!=r.return&&(i=r.return(),Object(i)!==i))return}finally{if(u)throw o}}return c}}function R(e){if(Array.isArray(e))return e}function X(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function N(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?X(Object(r),!0).forEach(function(t){z(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):X(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function z(e,t,r){t=V(t);if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}function V(e){var t=H(e,"string");return typeof t==="symbol"?t:String(t)}function H(e,t){if(typeof e!=="object"||e===null)return e;var r=e[Symbol.toPrimitive];if(r!==undefined){var n=r.call(e,t||"default");if(typeof n!=="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}var q=function(e,t){try{var r='<root><core:Fragment fragmentName="'.concat(e,'" type="XML" xmlns:core="sap.ui.core" /></root>');var n=new window.DOMParser;var o=n.parseFromString(r,"text/xml");var a={models:{},bindingContexts:{}};for(var i in t){var c=new x;c.setData(t[i]);a.models[i]=c;a.bindingContexts[i]=a.models[i].createBindingContext("/")}return Promise.resolve(v.process(o.firstElementChild,{name:e},a)).then(function(e){var t=e.getElementsByTagName("core:Fragment");if((t===null||t===void 0?void 0:t.length)>0){var r=M(t),n;try{for(r.s();!(n=r.n()).done;){var o=n.value;o.innerHTML=""}}catch(e){r.e(e)}finally{r.f()}}var a=e.children.length>1?e.outerHTML:e.innerHTML;return _(a,{filter:function(e){return e.type!=="Comment"}})})}catch(e){return Promise.reject(e)}};S.processFragment=q;var _=require("xml-formatter");a.setLevel(1,"sap.ui.core.util.XMLPreprocessor");jest.setTimeout(4e4);var J={macros:"sap.fe.macros",macro:"sap.fe.macros",macroField:"sap.fe.macros.field",macrodata:"http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1",log:"http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1",unittest:"http://schemas.sap.com/sapui5/preprocessorextension/sap.fe.unittesting/1",control:"sap.fe.core.controls",core:"sap.ui.core",m:"sap.m",f:"sap.ui.layout.form",internalMacro:"sap.fe.macros.internal",mdc:"sap.ui.mdc",mdcat:"sap.ui.mdc.actiontoolbar",mdcField:"sap.ui.mdc.field",mdcTable:"sap.ui.mdc.table",u:"sap.ui.unified",macroMicroChart:"sap.fe.macros.microchart",microChart:"sap.suite.ui.microchart",macroTable:"sap.fe.macros.table"};var U=j.useNamespaces(J);var W=function(e){C(e)};S.registerMacro=W;var K=function(e){v.plugIn(null,e.namespace,e.name);if(e.publicNamespace){v.plugIn(null,e.publicNamespace,e.name)}};S.unregisterMacro=K;var Q=function(e,t){return U(e,t)};expect.extend({toHaveControl:function(e,t){var r=Q("/root".concat(t),e);return{message:function(){var r=Y(e);return"did not find controls matching ".concat(t," in generated xml:\n ").concat(r)},pass:r&&r.length>=1}},toNotHaveControl:function(e,t){var r=Q("/root".concat(t),e);return{message:function(){var r=Y(e);return"There is a control matching ".concat(t," in generated xml:\n ").concat(r)},pass:r&&r.length===0}}});S.runXPathQuery=Q;var $=function(e){if(Array.isArray(e)){e=e.join("")}var t=Z(e);t=t.replace(/uid--id-[0-9]{13}-[0-9]{1,2}/g,"uid--id");return t};S.formatBuildingBlockXML=$;var G=function(e,t,r){var n="string(/root".concat(e,"/@").concat(t,")");return Q(n,r)};S.getControlAttribute=G;var Y=function(e){var t=new window.XMLSerializer;var r=t.serializeToString(e);return Z(r)};S.serializeXML=Y;var Z=function(e){return O(e,{parser:"xml",xmlWhitespaceSensitivity:"ignore",plugins:[r]})};S.formatXML=Z;var ee=function(e){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:n.basename(e).replace(".cds",".xml");var a=t.readFileSync(e,"utf-8");var i=te(a,"sap.fe.test.JestService",r);var c=n.resolve(e,"..","gen");var s=n.resolve(c,o);t.mkdirSync(c,{recursive:true});t.writeFileSync(s,i);return s};S.compileCDS=ee;function te(r){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"sap.fe.test.JestService";var o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var a={"source.cds":r};if(r.includes("'@sap/cds/common'")){a["common.cds"]=t.readFileSync(require.resolve("@sap/cds/common.cds"),"utf-8")}var i=e.compileSources(a,{});var c=N(N({odataForeignKeys:true,odataFormat:"structured",odataContainment:false},o),{},{service:n});var s=e.to.edmx(i,c);if(!s){throw new Error("Compilation failed. Hint: Make sure that the CDS model defines service ".concat(n,"."))}return s}S.cds2edmx=te;var re=function(e){try{var t={scopeObject:{},scopeType:"",settings:{}};return Promise.resolve((new u).createInstance(t).then(function(t){var r=t.getInterface();r.getContext=function(){return{scopeObject:{getModel:function(){return{getMetaModel:function(){return e}}}}}};return r}))}catch(e){return Promise.reject(e)}};S.getFakeSideEffectsService=re;var ne=function(){var e=[];return{addIssue:function(t,r,n){e.push({issueCategory:t,issueSeverity:r,details:n})},getIssues:function(){return e},checkIfIssueExists:function(t,r,n){return e.find(function(e){return e.issueCategory===t&&e.issueSeverity===r&&e.details===n})}}};S.getFakeDiagnostics=ne;var oe=function(e,t){var r=e.entitySets.find(function(e){return e.name===t.entitySet});var n=ce(r,e,r);return new s(e,t,ne(),i,n)};S.getConverterContextForTest=oe;var ae={};var ie=function(e){try{function n(){return ae[e]}var t=P.create({},"4.0",{});var r=function(){if(!ae[e]){var r=new w(t,e,undefined,null);return Promise.resolve(r.fetchEntityContainer()).then(function(){ae[e]=r})}}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(o){return Promise.reject(o)}};S.getMetaModel=ie;var ce=function(e,t,r){var n={startingEntitySet:e,navigationProperties:[],targetObject:r,targetEntitySet:e,targetEntityType:e.entityType,convertedTypes:t};n.contextLocation=n;return n};S.getDataModelObjectPathForProperty=ce;var se=function(e){var t=f.complexParser(e);for(var r=arguments.length,n=new Array(r>1?r-1:0),o=1;o<r;o++){n[o-1]=arguments[o]}return t.formatter.apply(undefined,n)};S.evaluateBinding=se;function ue(e,t,r){var n=f.complexParser(e);var o=new p;o.bindProperty("text",n);var a=new x(t);o.setModel(a);o.setBindingContext(a.createBindingContext("/"));if(r){for(var i=0,c=Object.entries(r);i<c.length;i++){var s=F(c[i],2),u=s[0],l=s[1];var m=new x(l);o.setModel(m,u);o.setBindingContext(m.createBindingContext("/"),u)}}return o.getText()}S.evaluateBindingWithModel=ue;var le="testViewId";var fe=function(e,t,r,n){try{var o=n(le,e);var a="someComponent";var i={"sap.app":{id:a,type:"application",crossNavigation:{outbounds:[]}}};var c={getDiagnostics:jest.fn().mockReturnValue(ne()),getModel:jest.fn().mockReturnValue({getMetaModel:jest.fn().mockReturnValue(t)}),getComponentData:jest.fn().mockReturnValue({}),getManifestObject:jest.fn().mockReturnValue({getEntry:function(e){return i[e]}})};jest.spyOn(h,"loadFlexData").mockReturnValue(Promise.resolve(o));jest.spyOn(m,"get").mockReturnValue(c);jest.spyOn(b,"getAppComponentForControl").mockReturnValue(c);return Promise.resolve(g.initialize({componentId:a})).then(function(){return Promise.resolve(y.process(r,{name:"Test Fragment",componentId:a,id:le})).then(function(e){r=e;return r})})}catch(e){return Promise.reject(e)}};S.applyFlexChanges=fe;var me=function(e){return A(e.querySelectorAll("*")).flatMap(function(e){return A(e.attributes).map(function(e){return e.name})}).filter(function(e){return e.includes("sap.ui.fl.appliedChanges")})};S.getChangesFromXML=me;var pe=function(e,t,r,n,o,a){try{var i="<root>".concat(e,"</root>");var c=new window.DOMParser;var s=c.parseFromString(i,"text/xml");return Promise.resolve(ie(t)).then(function(e){if(!n.hasOwnProperty("converterContext")){n=Object.assign(n,{converterContext:new l({},e)})}Object.keys(n).forEach(function(t){if(n[t]&&n[t].isTemplateModel){n[t]=new l(n[t].data,e)}});var t={models:Object.assign({metaModel:e},n),bindingContexts:{}};Object.keys(r).forEach(function(o){expect(typeof e.getObject(r[o])).toBeDefined();var a=n[o]||e;t.bindingContexts[o]=a.createBindingContext(r[o]);t.models[o]=a});if(t.models["this"]){t.bindingContexts["this"]=t.models["this"].createBindingContext("/")}return Promise.resolve(v.process(s.firstElementChild,{name:"Test Fragment"},t)).then(function(t){var r=function(){if(o&&a){A(t.querySelectorAll("[id]")).forEach(function(e){e.id="".concat(le,"--").concat(e.id)});return Promise.resolve(fe(o,e,t,a)).then(function(e){t=e;var r=me(t);expect(r.length).toBe(o.length)})}}();return r&&r.then?r.then(function(){return t}):t})})}catch(e){return Promise.reject(e)}};S.getTemplatingResult=pe;var de=function(e,t,r,n,o,a){try{return Promise.resolve(pe(e,t,r,n,o,a)).then(Y)}catch(e){return Promise.reject(e)}};S.getTemplatedXML=de;function ve(e){var t=0;function r(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var r="";for(var n=0;n<t+e;n++){r+="\t"}return r}var n={start:function(e,t){var n="";if(t){if(e.getParent()){var o,a;var i=(o=e.getParent().getAggregation(t))===null||o===void 0?void 0:(a=o.indexOf)===null||a===void 0?void 0:a.call(o,e);if(i>0){n+=",\n".concat(r())}}}n+="".concat(e.getMetadata().getName(),"(");return n},end:function(){return"})"},middle:function(e){var t="{id: ".concat(e.getId());for(var n in e.mProperties){if(e.mProperties.hasOwnProperty(n)){t+=",\n".concat(r()," ").concat(n,": ").concat(e.mProperties[n])}else if(e.mBindingInfos.hasOwnProperty(n)){var o=e.mBindingInfos[n];t+=",\n".concat(r()," ").concat(n,": formatter(").concat(o.parts.map(function(e){return"\n".concat(r(1)).concat(e.model?e.model:"",">").concat(e.path)}),")")}}for(var a in e.mAssociations){if(e.mAssociations.hasOwnProperty(a)){t+=",\n".concat(r()," ").concat(a,": ").concat(e.mAssociations[a][0])}}t+="";return t},startAggregation:function(e,n){var o=",\n".concat(r()).concat(n);t++;if(e.mBindingInfos[n]){o+="={ path:'".concat(e.mBindingInfos[n].path,"', template:\n").concat(r())}else{o+="=[\n".concat(r())}return o},endAggregation:function(e,n){t--;if(e.mBindingInfos[n]){return"\n".concat(r(),"}")}else{return"\n".concat(r(),"]")}}};if(Array.isArray(e)){return e.map(function(e){return new d(e,n).serialize()})}else{return new d(e,n).serialize()}}S.serializeControl=ve;function ge(){var e;var t=new Promise(function(t){e=t});return{promise:t,resolve:e}}S.createAwaiter=ge;return S},false);
//# sourceMappingURL=JestTemplatingHelper.js.map
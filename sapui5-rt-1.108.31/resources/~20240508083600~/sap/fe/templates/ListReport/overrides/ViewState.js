/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/library","sap/fe/core/templating/PropertyFormatters","sap/fe/macros/DelegateUtil","sap/fe/macros/filter/FilterUtils","sap/fe/navigation/library","sap/ui/Device","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/p13n/StateUtil"],function(e,t,a,r,i,n,o,l,s,f,u,d,g){"use strict";var c=f.system;var p=s.NavType,h=i.VariantManagement,v=i.TemplateContentView,V=i.InitialLoadMode;var C=t.FilterRestrictions,y=/\+|\*/g;var _={_bSearchTriggered:false,applyInitialStateOnly:function(){return true},onBeforeStateApplied:function(e){var t=this.getView(),a=t.getController(),r=a._getFilterBarControl(),i=a._getControls("table");if(r){r.setSuspendSelection(true);e.push(r.waitForInitialization())}i.forEach(function(t){e.push(t.initialized())});delete this._bSearchTriggered},onAfterStateApplied:function(){var e=this.getView().getController();var t=e._getFilterBarControl();if(t){t.setSuspendSelection(false)}else if(e._isFilterBarHidden()){var a=e.getView().getBindingContext("internal");a.setProperty("hasPendingFilters",false);if(e._isMultiMode()){e._getMultiModeControl().setCountsOutDated(true)}}},adaptBindingRefreshControls:function(e){var t=this.getView(),r=t.getController(),i=r._getControls(),n=a.getControlsForRefresh(t,i);Array.prototype.push.apply(e,n)},adaptStateControls:function(e){var t=this.getView(),a=t.getController(),r=t.getViewData(),i=r.variantManagement===h.Control;var n=this._getFilterBarVM(t);if(n){e.push(n)}if(a._isMultiMode()){e.push(a._getMultiModeControl())}a._getControls("table").forEach(function(t){var a=t.getQuickFilter();if(a){e.push(a)}if(i){e.push(t.getVariant())}e.push(t)});if(a._getControls("Chart")){a._getControls("Chart").forEach(function(t){e.push(t)})}if(a._hasMultiVisualizations()){e.push(a._getSegmentedButton(v.Chart));e.push(a._getSegmentedButton(v.Table))}var o=a._getFilterBarControl();if(o){e.push(o)}e.push(t.byId("fe::ListReport"))},retrieveAdditionalStates:function(e){var t=this.getView(),a=t.getController(),r=t.getBindingContext("internal").getProperty("hasPendingFilters");e.dataLoaded=!r||!!this._bSearchTriggered;if(a._hasMultiVisualizations()){var i=t.getBindingContext("internal").getProperty("alpContentView");e.alpContentView=i}delete this._bSearchTriggered},applyAdditionalStates:function(e){var t=this.getView(),a=t.getController(),r=a._getFilterBarControl();if(e){if(e.dataLoaded===false&&r){r._bSearchTriggered=false}else if(e.dataLoaded===true){if(r){r.triggerSearch()}this._bSearchTriggered=true}if(a._hasMultiVisualizations()){var i=t.getBindingContext("internal");if(!c.desktop&&e.alpContentView==v.Hybrid){e.alpContentView=v.Chart}i.getModel().setProperty("".concat(i.getPath(),"/alpContentView"),e.alpContentView)}}},_applyNavigationParametersToFilterbar:function(t,a){var r=this;var i=this.getView();var n=i.getController();var o=n.getAppComponent();var l=o.getComponentData();var s=l&&l.startupParameters||{};var f=this.handleVariantIdPassedViaURLParams(s);var u;a.push(f.then(function(e){if(e&&e.length>0){if(e[0]===true||e[1]===true){u=true}}return r._applySelectionVariant(i,t,u)}).then(function(){var e=n._getDynamicListReportControl();var a=false;var o=r._getFilterBarVM(i);var l=n._getFilterBarControl();if(l){if(t.navigationType!==p.initial&&t.requiresStandardVariant||!o&&i.getViewData().initialLoad===V.Enabled||n._shouldAutoTriggerSearch(o)){l.triggerSearch()}else{a=r._preventInitialSearch(o)}l.setSuspendSelection(false);r._bSearchTriggered=!a;e.setHeaderExpanded(c.desktop||a)}}).catch(function(){e.error("Variant ID cannot be applied")}))},handleVariantIdPassedViaURLParams:function(e){var t=e["sap-ui-fe-variant-id"],a=e["sap-ui-fe-filterbar-variant-id"],r=e["sap-ui-fe-table-variant-id"];var i;if(t||a||r){i={sPageVariantId:t&&t[0],sFilterBarVariantId:a&&a[0],sTableVariantId:r&&r[0]}}return this._handleControlVariantId(i)},_handleControlVariantId:function(e){var t=this;var a;var r=this.getView(),i=[];var n=r.getViewData().variantManagement;if(e&&e.sPageVariantId&&n==="Page"){a=r.byId("fe::PageVariantManagement");a.getVariants().forEach(function(r){if(r.key===e.sPageVariantId){i.push(t._applyControlVariant(a,e.sPageVariantId,true))}})}else if(e&&n==="Control"){if(e.sFilterBarVariantId){a=r.getController()._getFilterBarVariantControl();if(a){a.getVariants().forEach(function(r){if(r.key===e.sFilterBarVariantId){i.push(t._applyControlVariant(a,e.sFilterBarVariantId,true))}})}}if(e.sTableVariantId){var o=r.getController(),l=o._getControls("table");l.forEach(function(a){var r=a.getVariant();if(a&&r){r.getVariants().forEach(function(a){if(a.key===e.sTableVariantId){i.push(t._applyControlVariant(r,e.sTableVariantId))}})}})}}return Promise.all(i)},_applyControlVariant:function(e,t,a){var r=this._checkIfVariantIdIsAvailable(e,t)?t:e.getStandardVariantKey();var i=u.activateVariant({element:e,variantReference:r});return i.then(function(){return a})},_getFilterBarVM:function(e){var t=e.getViewData();switch(t.variantManagement){case h.Page:return e.byId("fe::PageVariantManagement");case h.Control:return e.getController()._getFilterBarVariantControl();case h.None:return null;default:throw new Error("unhandled variant setting: ".concat(t.variantManagement))}},_preventInitialSearch:function(e){if(!e){return true}var t=e.getVariants();var a=t.find(function(t){return t.key===e.getCurrentVariantKey()});return!a.executeOnSelect},_applySelectionVariant:function(e,a,r){var i=e.getController()._getFilterBarControl(),n=a.selectionVariant,o=a.selectionVariantDefaults;if(!i||!n){return Promise.resolve()}var l={};var s=e.getModel().getMetaModel();var f=e.getViewData();var u=f.contextPath||"/".concat(f.entitySet);var d=t.getMandatoryFilterFields(s,u);var g=i.data("useSemanticDateRange");var c;switch(f.variantManagement){case h.Page:c=e.byId("fe::PageVariantManagement");break;case h.Control:c=e.getController()._getFilterBarVariantControl();break;case h.None:default:break}var p=a.requiresStandardVariant;var v=o&&o.getSelectOptionsPropertyNames().length>0&&c.getDefaultVariantKey()===c.getStandardVariantKey()&&a.bNavSelVarHasDefaultsOnly;if(r||v){l=i.getConditions()}t.addDefaultDisplayCurrency(d,n,o);t.addSelectionVariantToConditions(n,l,s,u,v,g,f);return this._activateSelectionVariant(i,l,c,p,r,v)},_activateSelectionVariant:function(e,t,a,r,i,n){var o=this;var l;if(a&&!i){var s=r?a.getStandardVariantKey():a.getDefaultVariantKey();if(s===null){s=a.getId()}l=u.activateVariant({element:a,variantReference:s}).then(function(){return r||a.getDefaultVariantKey()===a.getStandardVariantKey()})}else{l=Promise.resolve(true)}return l.then(function(a){if(a){return o._fnApplyConditions(e,t,n)}})},_fnClearStateBeforexAppNav:function(t){try{return Promise.resolve(g.retrieveExternalState(t).then(function(e){var t=e.filter;for(var a in t){if(a!=="$editState"&&a!=="$search"&&t[a]){t[a].forEach(function(e){e["filtered"]=false})}}return Promise.resolve(t)}).catch(function(t){e.error("Error while retrieving the external state",t)}))}catch(e){return Promise.reject(e)}},_fnApplyConditions:function(e,a,i){try{var s=this;var f={},u=[],c=function(e){e.validated=d.Validated;if(e.operator==="Empty"){e.operator="EQ";e.values=[""]}else if(e.operator==="NotEmpty"){e.operator="NE";e.values=[""]}delete e.isEmpty};var p=function(e,a){var i=r.getEntitySetPath(a),o=e.getModel().getMetaModel(),s=t.getFilterRestrictionsByPath(i,o),f=s[C.NON_FILTERABLE_PROPERTIES],u=l.getConvertedFilterFields(e,a),d=[];Object.keys(u).forEach(function(e){var t=u[e];var a=t.conditionPath.replace(y,"");if(f.indexOf(a)===-1){var r=t.annotationPath;var i=o.createBindingContext(r);d.push({path:t.conditionPath,hiddenFilter:t.availability==="Hidden",hasValueHelp:!r?false:n.hasValueHelp(i.getObject(),{context:i})})}});return d};return Promise.resolve(e.waitForInitialization().then(function(){try{function n(){var r=p(e,t);r.filter(function(e){return e.path!=="$editState"&&e.path!=="$search"}).forEach(function(e){if(e.path in a){f[e.path]=a[e.path];if(!e.hiddenFilter){u.push({name:e.path})}if(e.hasValueHelp){f[e.path].forEach(c)}else{f[e.path].forEach(function(e){e.validated=e.filtered?d.NotValidated:e.validated})}}else{f[e.path]=[]}});return g.applyExternalState(e,{filter:f,items:u})}var t=o.getCustomData(e,"entityType");var r=function(){if(!i){return Promise.resolve(s._fnClearStateBeforexAppNav(e)).then(function(t){return Promise.resolve(g.applyExternalState(e,{filter:t,items:u})).then(function(){})})}}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(l){return Promise.reject(l)}}))}catch(e){return Promise.reject(e)}}};return _},false);
//# sourceMappingURL=ViewState.js.map
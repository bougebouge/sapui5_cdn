/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/controls/Common/Table","sap/fe/core/converters/controls/ListReport/VisualFilters","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/converters/helpers/Key","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/ModelHelper","../../ManifestSettings","../Common/DataVisualization"],function(e,t,i,r,n,a,o,l,v){"use strict";var u={};var s=v.getSelectionVariant;var d=l.AvailabilityType;var c=a.getExpressionFromAnnotation;var f=a.compileExpression;var p=n.KeyHelper;var y=r.IssueType;var g=r.IssueSeverity;var m=r.IssueCategory;var h=i.Placement;var b=i.insertCustomElements;var P=t.getVisualFilters;var F=e.isFilteringCaseSensitive;var S=e.getTypeConfig;var E=e.getSelectionVariantConfiguration;function T(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,r)}return i}function O(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?T(Object(i),!0).forEach(function(t){x(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):T(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function x(e,t,i){t=D(t);if(t in e){Object.defineProperty(e,t,{value:i,enumerable:true,configurable:true,writable:true})}else{e[t]=i}return e}function D(e){var t=I(e,"string");return typeof t==="symbol"?t:String(t)}function I(e,t){if(typeof e!=="object"||e===null)return e;var i=e[Symbol.toPrimitive];if(i!==undefined){var r=i.call(e,t||"default");if(typeof r!=="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}var C;(function(e){e["Default"]="Default";e["Slot"]="Slot"})(C||(C={}));var j="Edm.String";var A="sap.ui.model.odata.type.String";function w(e){var t={};e.Data.forEach(function(i){if(i.$Type==="com.sap.vocabularies.UI.v1.DataField"){var r,n;t[i.Value.path]={group:e.fullyQualifiedName,groupLabel:f(c(e.Label||((r=e.annotations)===null||r===void 0?void 0:(n=r.Common)===null||n===void 0?void 0:n.Label)||e.qualifier))||e.qualifier}}});return t}function N(e){return e.reduce(function(e,t){t.propertyNames.forEach(function(t){e[t]=true});return e},{})}function R(e,t){if(t&&e.length>0){return e.every(function(e){return e.enableAnalytics&&t===e.annotation.collection})}return false}function V(e,t){var i=[];return e.map(function(e){var r=e.control.filters;var n=[];for(var a in r){if(Array.isArray(r[a].paths)){var o=r[a].paths;o.forEach(function(e){if(e&&e.annotationPath&&i.indexOf(e.annotationPath)===-1){i.push(e.annotationPath);var r=E(e.annotationPath,t);if(r){n.push(r)}}})}}return n}).reduce(function(e,t){return e.concat(t)},[])}var L=function(e,t){var i=t.split("/");var r;var n="";while(i.length){var a=i.shift();r=r?"".concat(r,"/").concat(a):a;var o=e.resolvePath(r);if(o._type==="NavigationProperty"&&o.isCollection){a+="*"}n=n?"".concat(n,"/").concat(a):a}return n};var M=function(e,t,i,r,n){var a,o,l;if(t!==undefined&&t.targetType===undefined&&(r||((a=t.annotations)===null||a===void 0?void 0:(o=a.UI)===null||o===void 0?void 0:(l=o.Hidden)===null||l===void 0?void 0:l.valueOf())!==true)){var v,u,s,y,g,m,h,b;var P=n.getAnnotationEntityType(t);return{key:p.getSelectionFieldKeyFromPath(i),annotationPath:n.getAbsoluteAnnotationPath(i),conditionPath:L(e,i),availability:((v=t.annotations)===null||v===void 0?void 0:(u=v.UI)===null||u===void 0?void 0:(s=u.HiddenFilter)===null||s===void 0?void 0:s.valueOf())===true?d.Hidden:d.Adaptation,label:f(c(((y=t.annotations.Common)===null||y===void 0?void 0:(g=y.Label)===null||g===void 0?void 0:g.valueOf())||t.name)),group:P.name,groupLabel:f(c((P===null||P===void 0?void 0:(m=P.annotations)===null||m===void 0?void 0:(h=m.Common)===null||h===void 0?void 0:(b=h.Label)===null||b===void 0?void 0:b.valueOf())||P.name))}}return undefined};function U(e){var t={"Edm.Boolean":{modelType:"Bool"},"Edm.Byte":{modelType:"Int"},"Edm.Date":{modelType:"Date"},"Edm.DateTime":{modelType:"Date"},"Edm.DateTimeOffset":{modelType:"DateTimeOffset"},"Edm.Decimal":{modelType:"Decimal"},"Edm.Double":{modelType:"Float"},"Edm.Float":{modelType:"Float"},"Edm.Guid":{modelType:"Guid"},"Edm.Int16":{modelType:"Int"},"Edm.Int32":{modelType:"Int"},"Edm.Int64":{modelType:"Int"},"Edm.SByte":{modelType:"Int"},"Edm.Single":{modelType:"Float"},"Edm.String":{modelType:"String"},"Edm.Time":{modelType:"TimeOfDay"},"Edm.TimeOfDay":{modelType:"TimeOfDay"},"Edm.Stream":{}};return e&&e in t&&t[e].modelType}u.getModelType=U;var k=function(e,t,i,r,n){var a={};if(i){i.forEach(function(i){var o=i.name;var l=(t?"".concat(t,"/"):"")+o;var v=M(e,i,l,r,n);if(v){a[l]=v}})}return a};var q=function(e,t,i,r){var n={};if(t){t.forEach(function(t){var a;var o=e.resolvePath(t);if(o===undefined){return}if(o._type==="NavigationProperty"){a=k(e,t,o.targetType.entityProperties,i,r)}else if(o.targetType!==undefined&&o.targetType._type==="ComplexType"){a=k(e,t,o.targetType.properties,i,r)}else{var l=t.includes("/")?t.split("/").splice(0,1).join("/"):"";a=k(e,l,[o],i,r)}n=O(O({},n),a)})}return n};var $=function(e,t,i,r){var n=e[t];if(n){delete e[t]}else{n=M(r,r.resolvePath(t),t,true,i)}if(n){var a,o;n.availability=n.availability===d.Hidden?d.Hidden:d.Default;n.isParameter=!!((a=r.annotations)!==null&&a!==void 0&&(o=a.Common)!==null&&o!==void 0&&o.ResultContext)}else{var l;(l=i.getDiagnostics())===null||l===void 0?void 0:l.addIssue(m.Annotation,g.High,y.MISSING_SELECTIONFIELD)}return n};var B=function(e,t,i,r,n){var a=[];var o={};var l=t.entityProperties;n===null||n===void 0?void 0:n.forEach(function(e){o[e.value]=true});if(e&&e.length>0){e===null||e===void 0?void 0:e.forEach(function(e){var o=e.PropertyName;var l=o.value;var v={};n===null||n===void 0?void 0:n.forEach(function(e){v[e.value]=true});if(!(l in r)){if(!(l in v)){var u=W(l,i,t);if(u){a.push(u)}}}})}else if(l){l.forEach(function(e){var n,l;var v=(n=e.annotations)===null||n===void 0?void 0:(l=n.Common)===null||l===void 0?void 0:l.FilterDefaultValue;var u=e.name;if(!(u in r)){if(v&&!(u in o)){var s=W(u,i,t);if(s){a.push(s)}}}})}return a};function H(e){var t,i;var r=e.getDataModelObjectPath();var n=r.startingEntitySet.entityType;var a=!!((t=n.annotations)!==null&&t!==void 0&&(i=t.Common)!==null&&i!==void 0&&i.ResultContext)&&!r.targetEntitySet;var o=a&&e.getConverterContextFor("/".concat(r.startingEntitySet.name));return o?n.entityProperties.map(function(e){return $({},e.name,o,n)}):[]}var K=function(e,t,i){var r=t.length===0||t.every(function(e){return!e.applySupported.enableSearch});var n=e.length===0||e.every(function(e){return e.enableAnalytics&&!e.enableAnalyticsSearch});var a=i.getContextPath();if(a&&r&&n){return true}else{return false}};u.getFilterBarhideBasicSearch=K;var J=function(e,t){var i=t.getManifestWrapper().getFilterConfiguration();var r=(i===null||i===void 0?void 0:i.filterFields)||{};var n=q(e,Object.keys(r).map(function(e){return p.getPathFromSelectionFieldKey(e)}),true,t);var a={};for(var o in r){var l=r[o];var v=p.getPathFromSelectionFieldKey(o);var u=n[v];var s=l.type==="Slot"?C.Slot:C.Default;var c=l&&l!==null&&l!==void 0&&l.visualFilter?P(e,t,o,r):undefined;a[o]={key:o,type:s,annotationPath:u===null||u===void 0?void 0:u.annotationPath,conditionPath:(u===null||u===void 0?void 0:u.conditionPath)||v,template:l.template,label:l.label,position:l.position||{placement:h.After},availability:l.availability||d.Default,settings:l.settings,visualFilter:c,required:l.required}}return a};u.getManifestFilterFields=J;var W=function(e,t,i){return $({},e,t,i)};u.getFilterField=W;var G=function(e,t){if(t==="RequiredProperties"||t==="NonFilterableProperties"){var i=[];if(e&&e[t]){i=e[t].map(function(e){return e.$PropertyPath||e.value})}return i}else if(t==="FilterAllowedExpressions"){var r={};if(e&&e.FilterExpressionRestrictions){e.FilterExpressionRestrictions.forEach(function(e){if(r[e.Property.value]){r[e.Property.value].push(e.AllowedExpressions)}else{r[e.Property.value]=[e.AllowedExpressions]}})}return r}return e};u.getFilterRestrictions=G;var _=function(){return{name:"$search",path:"$search",dataType:A,maxConditions:1}};var z=function(){return{name:"$editState",path:"$editState",groupLabel:"",group:"",dataType:A,hiddenFilter:false}};var Q=function(e){var t;if(!o.isSingleton(e.getEntitySet())){var i,r;var n=(i=e.getEntitySet())===null||i===void 0?void 0:(r=i.annotations)===null||r===void 0?void 0:r.Capabilities;t=n===null||n===void 0?void 0:n.SearchRestrictions}return t};var X=function(e,t){var i,r,n;var a=(i=e.getEntitySet())===null||i===void 0?void 0:(r=i.annotations)===null||r===void 0?void 0:(n=r.Capabilities)===null||n===void 0?void 0:n.NavigationRestrictions;var o=a&&a.RestrictedProperties;return o&&o.find(function(e){return e&&e.NavigationProperty&&(e.NavigationProperty.$NavigationPropertyPath===t||e.NavigationProperty.value===t)})};u.getNavigationRestrictions=X;var Y=function(e){return{key:e.key,annotationPath:e.annotationPath,conditionPath:e.conditionPath,name:e.conditionPath,label:e.label,hiddenFilter:e.availability==="Hidden",display:"Value",isParameter:e.isParameter,caseSensitive:e.caseSensitive,availability:e.availability,position:e.position,type:e.type,template:e.template,menu:e.menu,required:e.required}};var Z=function(e){var t=["SingleValue","MultiValue","SingleRange","MultiRange","SearchExpression","MultiRangeOrSearchExpression"];e.sort(function(e,i){return t.indexOf(e)-t.indexOf(i)});return e[0]};u.getSpecificAllowedExpression=Z;var ee=function(e,t){var i,r,n,a,o,l;var v=e===null||e===void 0?void 0:(i=e.Common)===null||i===void 0?void 0:i.Text,u=v&&(e&&(e===null||e===void 0?void 0:(r=e.Common)===null||r===void 0?void 0:(n=r.Text)===null||n===void 0?void 0:(a=n.annotations)===null||a===void 0?void 0:(o=a.UI)===null||o===void 0?void 0:o.TextArrangement)||t&&(t===null||t===void 0?void 0:(l=t.UI)===null||l===void 0?void 0:l.TextArrangement));if(u){if(u.valueOf()==="UI.TextArrangementType/TextOnly"){return"Description"}else if(u.valueOf()==="UI.TextArrangementType/TextLast"){return"ValueDescription"}return"DescriptionValue"}return v?"DescriptionValue":"Value"};u.displayMode=ee;var te=function(e,t,i){var r;var n=Y(t);var a=t.annotationPath;if(!a){return n}var o=e.getConverterContextFor(a).getDataModelObjectPath().targetObject;var l=o===null||o===void 0?void 0:o.annotations;var v=e===null||e===void 0?void 0:(r=e.getDataModelObjectPath().targetObject)===null||r===void 0?void 0:r.annotations;var u=i.formatOptions;var s=i.constraints;n=Object.assign(n,{formatOptions:u,constraints:s,display:ee(l,v)});return n};u.fetchPropertyInfo=te;var ie=function(e){var t=true;switch(e.filterExpression){case"SearchExpression":case"SingleRange":case"SingleValue":t=false;break;default:break}if(e.type&&e.type.indexOf("Boolean")>0){t=false}return t};u.isMultiValue=ie;var re=function(e){return(e.$Type==="com.sap.vocabularies.UI.v1.DataField"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath")&&e.Value.path.includes("/")};var ne=function(e){var t,i,r;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";var o=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var l=arguments.length>4?arguments[4]:undefined;var v=V(n,e);var u=N(v);var d=e.getEntityType();var c=a&&((t=e.getEntityTypeAnnotation(a))===null||t===void 0?void 0:t.annotation)||((i=d.annotations)===null||i===void 0?void 0:(r=i.UI)===null||r===void 0?void 0:r.SelectionFields)||[];var f=[];if(n.length===0&&!!l){var p;(p=e.getEntityTypeAnnotation(l).annotation)===null||p===void 0?void 0:p.forEach(function(e){if(re(e)){var t=e.Value.path.slice(0,e.Value.path.lastIndexOf("/"));if(!f.includes(t)){f.push(t)}}})}var y=O(O(O({},k(d,"",d.entityProperties,o,e)),q(d,f,false,e)),q(d,e.getManifestWrapper().getFilterConfiguration().navigationProperties,o,e));var g=[];var m=s(d,e);if(m){g=m.SelectOptions}var h=(c===null||c===void 0?void 0:c.reduce(function(t,i){var r=i.value;if(!(r in u)){var n;if(a.startsWith("@com.sap.vocabularies.UI.v1.SelectionFields")){n=""}else{n=a.split("/@com.sap.vocabularies.UI.v1.SelectionFields")[0]}var o=n?n+"/"+r:r;var l=$(y,o,e,d);if(l){l.group="";l.groupLabel="";t.push(l)}}return t},[]))||[];var b=B(g,d,e,u,c);return{excludedFilterProperties:u,entityType:d,annotatedSelectionFields:c,filterFields:y,propertyInfoFields:h,defaultFilterFields:b}};var ae=function(e){var t=S(e,e===null||e===void 0?void 0:e.type);if((e===null||e===void 0?void 0:e.type)===j&&(t.constraints.nullable===undefined||t.constraints.nullable===true)){t.formatOptions.parseKeepsEmptyString=false}return t};u.fetchTypeConfig=ae;var oe=function(e,t,i,r){var n=te(t,e,r[e.key]),a="";if(e.conditionPath){a=e.conditionPath.replace(/\+|\*/g,"")}if(n){var o;n=Object.assign(n,{maxConditions:!n.isParameter&&ie(n)?-1:1,required:(o=e.required)!==null&&o!==void 0?o:n.isParameter||i.indexOf(a)>=0,caseSensitive:F(t),dataType:r[e.key].type})}return n};u.assignDataTypeToPropertyInfo=oe;var le=function(e,t,i){var r=[];var n={};if(i){e=e.concat(i)}e.forEach(function(e){if(e.annotationPath){var i=t.getConverterContextFor(e.annotationPath);var a=i.getDataModelObjectPath().targetObject;r.push(a===null||a===void 0?void 0:a.type);var o=ae(a);n[e.key]=o}else{r.push(j);n[e.key]={type:A}}});var a;if(!o.isSingleton(t.getEntitySet())){var l,v,u;a=(l=t.getEntitySet())===null||l===void 0?void 0:(v=l.annotations)===null||v===void 0?void 0:(u=v.Capabilities)===null||u===void 0?void 0:u.FilterRestrictions}var s=a;var d={};d["RequiredProperties"]=G(s,"RequiredProperties")||[];d["NonFilterableProperties"]=G(s,"NonFilterableProperties")||[];d["FilterAllowedExpressions"]=G(s,"FilterAllowedExpressions")||{};var c=t.getContextPath();var f=c.split("/");if(f.length>2){var p=f[f.length-1];f.splice(-1,1);var y=X(t,p);var g=y&&y.FilterRestrictions;d.RequiredProperties.concat(G(g,"RequiredProperties")||[]);d.NonFilterableProperties.concat(G(g,"NonFilterableProperties")||[]);d.FilterAllowedExpressions=O(O({},G(g,"FilterAllowedExpressions")||{}),d.FilterAllowedExpressions)}var m=d.RequiredProperties;var h=d.NonFilterableProperties;var b=[];e.forEach(function(e){var i;if(h.indexOf(i)===-1){var r=oe(e,t,m,n);b.push(r)}});var P=t.getDataModelObjectPath();if(o.isObjectPathDraftSupported(P)){b.push(z())}var F=Q(t);var S=Boolean(F&&!F.Searchable);if(c&&S!==true){if(!F||F!==null&&F!==void 0&&F.Searchable){b.push(_())}}return b};u.processSelectionFields=le;var ve=function(e,t,i){return b(e,J(t,i),{availability:"overwrite",label:"overwrite",type:"overwrite",position:"overwrite",template:"overwrite",settings:"overwrite",visualFilter:"overwrite",required:"overwrite"})};u.insertCustomManifestElements=ve;var ue=function(e){var t,i;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";var a=arguments.length>3?arguments[3]:undefined;var o=arguments.length>4?arguments[4]:undefined;var l=ne(e,r,n,a,o);var v=H(e);var u=JSON.parse(JSON.stringify(l.propertyInfoFields));var s=l.entityType;u=v.concat(u);u=ve(u,s,e);var d=le(u,e,l.defaultFilterFields);d.sort(function(e,t){if(e.groupLabel===undefined||e.groupLabel===null){return-1}if(t.groupLabel===undefined||t.groupLabel===null){return 1}return e.groupLabel.localeCompare(t.groupLabel)});var c=JSON.stringify(d);c=c.replace(/\{/g,"\\{");c=c.replace(/\}/g,"\\}");var f=c;var p=JSON.parse(JSON.stringify(l.propertyInfoFields));p=v.concat(p);var y=l.excludedFilterProperties;var g=s===null||s===void 0?void 0:(t=s.annotations)===null||t===void 0?void 0:(i=t.UI)===null||i===void 0?void 0:i.FilterFacets;var m={};var h=e.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.FieldGroup");if(g===undefined||g.length<0){for(var b in h){m=O(O({},m),w(h[b]))}}else{m=g.reduce(function(e,t){for(var i=0;i<(t===null||t===void 0?void 0:(r=t.Target)===null||r===void 0?void 0:(n=r.$target)===null||n===void 0?void 0:(a=n.Data)===null||a===void 0?void 0:a.length);i++){var r,n,a,o,l,v,u,s,d;e[t===null||t===void 0?void 0:(o=t.Target)===null||o===void 0?void 0:(l=o.$target)===null||l===void 0?void 0:(v=l.Data[i])===null||v===void 0?void 0:(u=v.Value)===null||u===void 0?void 0:u.path]={group:t===null||t===void 0?void 0:(s=t.ID)===null||s===void 0?void 0:s.toString(),groupLabel:t===null||t===void 0?void 0:(d=t.Label)===null||d===void 0?void 0:d.toString()}}return e},{})}var P=l.filterFields;var S=p.concat(Object.keys(P).filter(function(e){return!(e in y)}).map(function(e){return Object.assign(P[e],m[e])}));var E=e.getContextPath();if(R(r,E)){var T=r[0].aggregates;if(T){var x=Object.keys(T).map(function(e){return T[e].relativePath});S=S.filter(function(e){return x.indexOf(e.key)===-1})}}var D=ve(S,s,e);var I=F(e);D.forEach(function(e){e.caseSensitive=I});return{selectionFields:D,sPropertyInfo:f}};u.getSelectionFields=ue;var se=function(e,t,i){var r=G(t,"RequiredProperties");var n=Q(e);var a=Boolean(n&&!n.Searchable);var o=i.getObject();if(r.length>0||a||(o===null||o===void 0?void 0:o.FetchValues)===2){return true}return false};u.getExpandFilterFields=se;return u},false);
//# sourceMappingURL=FilterBar.js.map
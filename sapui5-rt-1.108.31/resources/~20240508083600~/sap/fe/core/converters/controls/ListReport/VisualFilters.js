/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/helpers/Aggregation","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/FilterTemplating"],function(e,t,i,o,n,a){"use strict";var r={};var l=a.isPropertyFilterable;var v=a.getIsRequired;var u=n.checkFilterExpressionRestrictions;var d=i.compileExpression;var s=t.IssueType;var f=t.IssueSeverity;var g=t.IssueCategory;var c=e.AggregationHelper;function p(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=y(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var o=0;var n=function(){};return{s:n,n:function(){if(o>=e.length)return{done:true};return{done:false,value:e[o++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,r=false,l;return{s:function(){i=i.call(e)},n:function(){var e=i.next();a=e.done;return e},e:function(e){r=true;l=e},f:function(){try{if(!a&&i.return!=null)i.return()}finally{if(r)throw l}}}}function y(e,t){if(!e)return;if(typeof e==="string")return h(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return h(e,t)}function h(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,o=new Array(t);i<t;i++){o[i]=e[i]}return o}var m=function(e,t,i){var o,n,a,r;var l,v,u;var d;var s=i.getCustomAggregateDefinitions();var f=i.getTransAggregations();var g=[];if(t!==null&&t!==void 0&&(o=t.$target)!==null&&o!==void 0&&o.Measures){var c,y,h;g=s.filter(function(e){var i,o,n;return e.qualifier===(t===null||t===void 0?void 0:(i=t.$target)===null||i===void 0?void 0:(o=i.Measures)===null||o===void 0?void 0:(n=o[0])===null||n===void 0?void 0:n.value)});d=g.length>0?g[0].qualifier:t===null||t===void 0?void 0:(c=t.$target)===null||c===void 0?void 0:(y=c.Measures)===null||y===void 0?void 0:(h=y[0])===null||h===void 0?void 0:h.value}if(!g[0]&&t!==null&&t!==void 0&&(n=t.$target)!==null&&n!==void 0&&n.DynamicMeasures){var m,P;d=e.getConverterContextFor(e.getAbsoluteAnnotationPath((m=t.$target.DynamicMeasures)===null||m===void 0?void 0:(P=m[0])===null||P===void 0?void 0:P.value)).getDataModelObjectPath().targetObject.Name;f=i.getAggregatedProperties("AggregatedProperty")}else{f=i.getAggregatedProperties("AggregatedProperties")[0]}var A=t===null||t===void 0?void 0:(a=t.$target)===null||a===void 0?void 0:(r=a.Dimensions[0])===null||r===void 0?void 0:r.value;if(s.some(function(e){return e.qualifier===d})){l=d}else if(f&&f[0]){f.some(function(e){if(e.Name===d){l=e===null||e===void 0?void 0:e.AggregatableProperty.value}})}var b=i.getAggregatableProperties();var I=i.getGroupableProperties();if(b&&b.length){var E=p(b),C;try{for(E.s();!(C=E.n()).done;){var S;var L=C.value;if((L===null||L===void 0?void 0:(S=L.Property)===null||S===void 0?void 0:S.value)===l){u=true}}}catch(e){E.e(e)}finally{E.f()}}if(I&&I.length){var D=p(I),O;try{for(D.s();!(O=D.n()).done;){var T=O.value;if((T===null||T===void 0?void 0:T.value)===A){v=true}}}catch(e){D.e(e)}finally{D.f()}}return u&&v};function P(e,t,i,n){var a;var r={};var y=n[i];if(y!==null&&y!==void 0&&(a=y.visualFilter)!==null&&a!==void 0&&a.valueList){var h,P;var A=y===null||y===void 0?void 0:(h=y.visualFilter)===null||h===void 0?void 0:h.valueList;var b=A.split("#");var I=b.length>1?"ValueList#".concat(b[1]):b[0];var E=e.resolvePath(i);var C=E===null||E===void 0?void 0:(P=E.annotations)===null||P===void 0?void 0:P.Common[I];if(C){var S,L;var D=C===null||C===void 0?void 0:C.CollectionPath;var O=t.getConverterContextFor("/".concat(D||((S=t.getEntitySet())===null||S===void 0?void 0:S.name)));var T=C===null||C===void 0?void 0:C.Parameters;var M;var F=[];var V=[];var R=O.getParameterEntityType();V=R?R.keys.map(function(e){return e.name}):[];if(t.getContextPath()===O.getContextPath()){V.forEach(function(e){F.push({localDataProperty:e,valueListProperty:e})})}if(T){var $=p(T),w;try{for($.s();!(w=$.n()).done;){var x;var N=w.value;var U=(x=N.LocalDataProperty)===null||x===void 0?void 0:x.value;var j=N.ValueListProperty;if(((N===null||N===void 0?void 0:N.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||(N===null||N===void 0?void 0:N.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterOut")&&i===U){M=N}if(((N===null||N===void 0?void 0:N.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||(N===null||N===void 0?void 0:N.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterIn")&&i!==U){var H=l(O,j);if(!H){F.push({localDataProperty:U,valueListProperty:j})}}}}catch(e){$.e(e)}finally{$.f()}}if(F&&F.length){F.forEach(function(e){var o=d(u(t.getConverterContextFor(t.getAbsoluteAnnotationPath(e===null||e===void 0?void 0:e.localDataProperty)).getDataModelObjectPath(),["SingleValue"]));var n=d(u(O.getConverterContextFor(O.getAbsoluteAnnotationPath(e===null||e===void 0?void 0:e.valueListProperty)).getDataModelObjectPath(),["SingleValue"]));if(n==="true"&&o==="false"){throw new Error("FilterRestrictions of ".concat(i," in MainEntitySet and ValueListEntitySet are different"))}})}var q=C===null||C===void 0?void 0:C.PresentationVariantQualifier;var k=C===null||C===void 0?void 0:C.SelectionVariantQualifier;var Q=O===null||O===void 0?void 0:(L=O.getEntityTypeAnnotation("@UI.PresentationVariant#".concat(q)))===null||L===void 0?void 0:L.annotation;var _=new c(O.getEntityType(),O);if(!_.isAnalyticsSupported()){return}if(Q){var z;var B=Q===null||Q===void 0?void 0:Q.Visualizations;var G="/".concat(C===null||C===void 0?void 0:C.CollectionPath)||"/".concat(O===null||O===void 0?void 0:(z=O.getEntitySet())===null||z===void 0?void 0:z.name);r.contextPath=G;var J;var K=p(B),W;try{for(K.s();!(W=K.n()).done;){var X;var Y=W.value;if(((X=Y.$target)===null||X===void 0?void 0:X.term)==="com.sap.vocabularies.UI.v1.Chart"){J=Y;break}}}catch(e){K.e(e)}finally{K.f()}if(J){var Z,ee,te,ie,oe,ne,ae,re,le,ve,ue,de,se,fe;var ge=m(O,J,_);if(!ge){return}var ce=(Z=J)===null||Z===void 0?void 0:(ee=Z.$target)===null||ee===void 0?void 0:(te=ee.Dimensions[0])===null||te===void 0?void 0:(ie=te.$target)===null||ie===void 0?void 0:(oe=ie.annotations)===null||oe===void 0?void 0:(ne=oe.UI)===null||ne===void 0?void 0:(ae=ne.Hidden)===null||ae===void 0?void 0:ae.valueOf();var pe=(re=J)===null||re===void 0?void 0:(le=re.$target)===null||le===void 0?void 0:(ve=le.Dimensions[0])===null||ve===void 0?void 0:(ue=ve.$target)===null||ue===void 0?void 0:(de=ue.annotations)===null||de===void 0?void 0:(se=de.UI)===null||se===void 0?void 0:(fe=se.HiddenFilter)===null||fe===void 0?void 0:fe.valueOf();if(ce===true||pe===true){return}else if(B&&B.length){var ye,he,me,Pe,Ae,be,Ie,Ee;r.chartAnnotation=J?O===null||O===void 0?void 0:O.getAbsoluteAnnotationPath("".concat(J.fullyQualifiedName,"/$AnnotationPath/")):undefined;r.presentationAnnotation=Q?O===null||O===void 0?void 0:O.getAbsoluteAnnotationPath("".concat(Q.fullyQualifiedName,"/")):undefined;r.outParameter=(ye=M)===null||ye===void 0?void 0:(he=ye.LocalDataProperty)===null||he===void 0?void 0:he.value;r.inParameters=F;var Ce=u(t.getConverterContextFor(t.getAbsoluteAnnotationPath(i)).getDataModelObjectPath(),["SingleRange","MultiRange"]);if(d(Ce)==="true"){throw new Error("Range AllowedExpression is not supported for visual filters")}var Se=u(t.getConverterContextFor(t.getAbsoluteAnnotationPath(i)).getDataModelObjectPath(),["SingleValue"]);r.multipleSelectionAllowed=d(!Se.value);r.required=v(t,i);var Le;if(k){var De;Le=O===null||O===void 0?void 0:(De=O.getEntityTypeAnnotation("@UI.SelectionVariant#".concat(k)))===null||De===void 0?void 0:De.annotation;r.selectionVariantAnnotation=Le?O===null||O===void 0?void 0:O.getAbsoluteAnnotationPath("".concat(Le.fullyQualifiedName,"/")):undefined}var Oe=[];if(R){var Te,Me,Fe,Ve,Re;var $e=D.split("/")[0];var we=D.split("/")[1];var xe=t.getConverterContextFor("/".concat($e));var Ne=xe===null||xe===void 0?void 0:(Te=xe.getDataModelObjectPath().startingEntitySet)===null||Te===void 0?void 0:(Me=Te.annotations)===null||Me===void 0?void 0:(Fe=Me.Capabilities)===null||Fe===void 0?void 0:(Ve=Fe.NavigationRestrictions)===null||Ve===void 0?void 0:Ve.RestrictedProperties;var Ue=Ne===null||Ne===void 0?void 0:Ne.find(function(e){var t;if(((t=e.NavigationProperty)===null||t===void 0?void 0:t.type)==="NavigationPropertyPath"){return e.NavigationProperty.value===we}});Oe=Ue===null||Ue===void 0?void 0:(Re=Ue.FilterRestrictions)===null||Re===void 0?void 0:Re.RequiredProperties}else{var je;var He=(je=O.getEntitySet())===null||je===void 0?void 0:je.annotations;if(!o.isSingleton(O.getEntitySet())){var qe,ke;Oe=He===null||He===void 0?void 0:(qe=He.Capabilities)===null||qe===void 0?void 0:(ke=qe.FilterRestrictions)===null||ke===void 0?void 0:ke.RequiredProperties}}var Qe=[];if((me=Oe)!==null&&me!==void 0&&me.length){Oe.forEach(function(e){Qe.push(e.value)})}Qe=Qe.concat(V);r.requiredProperties=Qe;if((Pe=r.requiredProperties)!==null&&Pe!==void 0&&Pe.length){if(!r.inParameters||!r.inParameters.length){if(!r.selectionVariantAnnotation){r.showOverlayInitially=true}else{var _e,ze,Be,Ge;var Je=((_e=Le)===null||_e===void 0?void 0:(ze=_e.SelectOptions)===null||ze===void 0?void 0:ze.map(function(e){return e.PropertyName.value}))||[];var Ke=((Be=Le)===null||Be===void 0?void 0:(Ge=Be.Parameters)===null||Ge===void 0?void 0:Ge.map(function(e){return e.PropertyName.value}))||[];Je=Je.concat(Ke);Qe=Qe.sort();Je=Je.sort();r.showOverlayInitially=Qe.some(function(e){return Je.indexOf(e)===-1})}}else{r.showOverlayInitially=false}}else{r.showOverlayInitially=false}var We=(Ae=J)===null||Ae===void 0?void 0:(be=Ae.$target)===null||be===void 0?void 0:(Ie=be.Dimensions[0])===null||Ie===void 0?void 0:(Ee=Ie.$target)===null||Ee===void 0?void 0:Ee.type;if(!(We==="Edm.DateTimeOffset"||We==="Edm.Date"||We==="Edm.TimeOfDay")&&J.$target.ChartType==="UI.ChartType/Line"){r.renderLineChart=false}else{r.renderLineChart=true}}}else{t.getDiagnostics().addIssue(g.Annotation,f.High,s.MALFORMED_VISUALFILTERS.CHART)}}else{t.getDiagnostics().addIssue(g.Annotation,f.High,s.MALFORMED_VISUALFILTERS.PRESENTATIONVARIANT)}}else{t.getDiagnostics().addIssue(g.Annotation,f.High,s.MALFORMED_VISUALFILTERS.VALUELIST)}}else{t.getDiagnostics().addIssue(g.Manifest,f.High,s.MALFORMED_VISUALFILTERS.VALUELIST)}if(Object.keys(r).length>1){return r}}r.getVisualFilters=P;return r},false);
//# sourceMappingURL=VisualFilters.js.map
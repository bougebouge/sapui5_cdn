/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/controls/Common/Action","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/helpers/BindingToolkit","../controls/Common/DataVisualization","../controls/Common/KPI","../helpers/ID","../ManifestSettings"],function(t,e,a,n,r,i,o,l){"use strict";var s={};var u=l.VisualizationType;var v=l.VariantManagementType;var f=l.TemplateType;var c=o.getTableID;var d=o.getIconTabBarID;var p=o.getFilterVariantManagementID;var y=o.getFilterBarID;var h=o.getDynamicListReportID;var g=o.getCustomTabID;var m=o.getChartID;var b=i.getKPIDefinitions;var C=r.isSelectionPresentationCompliant;var I=r.isPresentationCompliant;var P=r.getSelectionVariant;var T=r.getSelectionPresentationVariant;var V=r.getDefaultPresentationVariant;var S=r.getDefaultLineItem;var E=r.getDefaultChart;var z=r.getDataVisualizationConfiguration;var w=n.getExpressionFromAnnotation;var A=n.compileExpression;var M=a.insertCustomElements;var k=e.getSelectionFields;var D=e.getManifestFilterFields;var F=e.getFilterBarhideBasicSearch;var L=t.getActionsFromManifest;function x(t){return j(t)||R(t)||H(t)||B()}function B(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function R(t){if(typeof Symbol!=="undefined"&&t[Symbol.iterator]!=null||t["@@iterator"]!=null)return Array.from(t)}function j(t){if(Array.isArray(t))return O(t)}function W(t,e){var a=typeof Symbol!=="undefined"&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=H(t))||e&&t&&typeof t.length==="number"){if(a)t=a;var n=0;var r=function(){};return{s:r,n:function(){if(n>=t.length)return{done:true};return{done:false,value:t[n++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i=true,o=false,l;return{s:function(){a=a.call(t)},n:function(){var t=a.next();i=t.done;return t},e:function(t){o=true;l=t},f:function(){try{if(!i&&a.return!=null)a.return()}finally{if(o)throw l}}}}function H(t,e){if(!t)return;if(typeof t==="string")return O(t,e);var a=Object.prototype.toString.call(t).slice(8,-1);if(a==="Object"&&t.constructor)a=t.constructor.name;if(a==="Map"||a==="Set")return Array.from(t);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return O(t,e)}function O(t,e){if(e==null||e>t.length)e=t.length;for(var a=0,n=new Array(e);a<e;a++){n[a]=t[a]}return n}function N(t){var e=[];t.forEach(function(t){if(!t.type){var a=t.secondaryVisualization?t.secondaryVisualization.visualizations:t.presentation.visualizations;a.forEach(function(t){if(t.type===u.Table){e.push(t)}})}});return e}function Q(t){var e=[];t.forEach(function(t){if(!t.type){var a=t.primaryVisualization?t.primaryVisualization.visualizations:t.presentation.visualizations;a.forEach(function(t){if(t.type===u.Chart){e.push(t)}})}});return e}var U=function(t){var e={};for(var a in t){var n,r,i;if((n=t[a])!==null&&n!==void 0&&(r=n.settings)!==null&&r!==void 0&&(i=r.defaultValues)!==null&&i!==void 0&&i.length){var o,l;e[a]=(o=t[a])===null||o===void 0?void 0:(l=o.settings)===null||l===void 0?void 0:l.defaultValues}}return e};function K(t,e,a){var n=e.getManifestWrapper().getDefaultTemplateAnnotationPath();var r=T(t,n,e);if(n&&r){var i=r.PresentationVariant;if(!i){throw new Error("Presentation Variant is not configured in the SPV mentioned in the manifest")}var o=I(r.PresentationVariant);if(!o){return undefined}if(C(r,a)){return r}}if(r){if(C(r,a)){return r}}var l=V(t);if(l){if(I(l,a)){return l}}if(!a){var s=S(t);if(s){return s}}return undefined}var q=function(t){var e=t;if(e.converterContext){var a,n;var r=e.converterContext;e=e;var i=z(e.annotation?r.getRelativeAnnotationPath(e.annotation.fullyQualifiedName,r.getEntityType()):"",true,r,e);var o="";var l="";var s="";var v="";var d=function(t){return t.key!==undefined};var p=function(t,e){var a;var n=W(t.visualizations),r;try{for(n.s();!(r=n.n()).done;){var i=r.value;if(e&&i.type===u.Chart){a=i;break}if(!e&&i.type===u.Table){a=i;break}}}catch(t){n.e(t)}finally{n.f()}var o=Object.assign({},t);if(a){o.visualizations=[a]}return o};var y=function(t){var a=r.getEntityTypeAnnotation(t.annotationPath);var n=a.annotation;r=a.converterContext;var o=n;i=z(o?r.getRelativeAnnotationPath(o.fullyQualifiedName,r.getEntityType()):"",true,r,e);return i};var h=function(t,a){var n=p(t[0],true);l=(n===null||n===void 0?void 0:n.visualizations[0]).id;var r=p(t[1]?t[1]:t[0]);o=(r===null||r===void 0?void 0:r.visualizations[0]).annotation.id;if(n&&r){e=e;var i=e.visible;var s={primaryVisualization:n,secondaryVisualization:r,tableControlId:o,chartControlId:l,defaultPath:a,visible:i};return s}};if(((a=i)===null||a===void 0?void 0:(n=a.visualizations)===null||n===void 0?void 0:n.length)===2&&r.getTemplateType()===f.AnalyticalListPage){var b=h([i],"both");if(b){return b}}else if(r.getManifestWrapper().hasMultipleVisualizations(e)||r.getTemplateType()===f.AnalyticalListPage){var C=e,I=C.primary,P=C.secondary;if(I&&I.length&&P&&P.length){var T=h([y(I[0]),y(P[0])],e.defaultPath);if(T){return T}}else{throw new Error("SecondaryItems in the Views is not present")}}else if(d(e)){var V=r.getEntityTypeAnnotation(e.annotationPath);var S=V.annotation;r=V.converterContext;s=A(w(S.Text));i.visualizations.forEach(function(t,a){switch(t.type){case u.Table:var n=i.visualizations[a];var r=n.control.filters||{};r.hiddenFilters=r.hiddenFilters||{paths:[]};if(!e.keepPreviousPersonalization){n.annotation.id=c(e.key||"","LineItem")}e=e;if(e&&e.annotation&&e.annotation.term==="com.sap.vocabularies.UI.v1.SelectionPresentationVariant"){v="@".concat(e.annotation.SelectionVariant.fullyQualifiedName.split("@")[1])}else{v=e.annotationPath}r.hiddenFilters.paths.push({annotationPath:v});n.control.filters=r;break;case u.Chart:var o=i.visualizations[a];o.id=m(e.key||"","Chart");o.multiViews=true;break;default:break}})}i.visualizations.forEach(function(t){if(t.type===u.Table){o=t.annotation.id}else if(t.type===u.Chart){l=t.id}});e=e;var E=e.visible;return{presentation:i,tableControlId:o,chartControlId:l,title:s,selectionVariantPath:v,visible:E}}else{e=e;var M=e.label,k=e.template,D=e.type,F=g(e.key||""),L=e.visible;return{title:M,fragment:k,type:D,customTabId:F,visible:L}}};var $=function(t,e){var a=[];if(e){e.paths.forEach(function(n){if(t.getManifestWrapper().hasMultipleVisualizations(n)){if(e.paths.length>1){throw new Error("ALP flavor cannot have multiple views")}else{n=n;a.push({converterContext:t,primary:n.primary,secondary:n.secondary,defaultPath:n.defaultPath})}}else if(n.template){n=n;a.push({key:n.key,label:n.label,template:n.template,type:"Custom",visible:n.visible})}else{n=n;var r=t.getConverterContextFor(n.contextPath||n.entitySet&&"/".concat(n.entitySet)||t.getContextPath()),i=r.getEntityType();if(i&&r){var o;var l=r.getEntityTypeAnnotation(n.annotationPath);var s=l.annotation;if(s){o=s.term==="com.sap.vocabularies.UI.v1.SelectionVariant"?K(i,r,false):s;a.push({converterContext:r,annotation:o,annotationPath:n.annotationPath,keepPreviousPersonalization:n.keepPreviousPersonalization,key:n.key,visible:n.visible})}}else{}}})}else{var n=t.getEntityType();if(t.getTemplateType()===f.AnalyticalListPage){a=J(t,a)}else{a.push({annotation:K(n,t,false),converterContext:t})}}return a.map(function(t){return q(t)})};var G=function(t,e){var a=t.getManifestWrapper();var n=a.getViewConfiguration();if(e.length>1&&!X(t)){return{showTabCounts:n?(n===null||n===void 0?void 0:n.showCounts)||a.hasMultipleEntitySets():undefined,id:d()}}return undefined};function J(t,e){var a=t.getEntityType();var n=K(a,t,true);var r,i;if(n){e.push({annotation:n,converterContext:t})}else{r=E(a);i=S(a);if(r&&i){var o=[{annotationPath:r.term}];var l=[{annotationPath:i.term}];e.push({converterContext:t,primary:o,secondary:l,defaultPath:"both"})}}return e}function X(t){return t.getManifestWrapper().hasMultipleVisualizations()||t.getTemplateType()===f.AnalyticalListPage}var Y=function(t){var e=t.getManifestWrapper();return M([],L(e.getHeaderActions(),t).actions)};s.getHeaderActions=Y;var Z=function(t,e){t.forEach(function(t){if(!t.type){var a=t.presentation;a.visualizations.forEach(function(t){if(t.type===u.Chart&&t.filterId!==e){t.filterId=e}})}})};s.checkChartFilterBarId=Z;var _=function(t){var e=t.getEntityType();var a=t.getContextPath();if(!a){throw new Error("An EntitySet is required to be able to display a ListReport, please adjust your `entitySet` property to point to one.")}var n=t.getManifestWrapper();var r=n.getViewConfiguration();var i=n.hasMultipleEntitySets();var o=$(t,r);var l=N(o);var s=Q(o);var u=l.some(function(t){return t.control.type==="ResponsiveTable"});var f="";var c="";var d=h();var g=y(a);var m=p(g);var C=n.getFilterConfiguration();var I=(C===null||C===void 0?void 0:C.initialLayout)!==undefined?C===null||C===void 0?void 0:C.initialLayout.toLowerCase():"compact";var T=(C===null||C===void 0?void 0:C.layout)!==undefined?C===null||C===void 0?void 0:C.layout.toLowerCase():"compact";var V=C.useSemanticDateRange!==undefined?C.useSemanticDateRange:true;var S=tt(t,o);if(S){c=S.chartId;f=S.tableId}var E=n.isFilterBarHidden()&&c==="";var z=k(t,l);var w=z.selectionFields;var A=z.sPropertyInfo;var M=F(l,s,t);var L=G(t,o);var B=L?undefined:P(e,t);var R=V?U(D(e,t)):{};var j=Y(t);if(i){Z(o,g)}var W=l.map(function(t){return t.annotation.id}).concat(s.map(function(t){return t.id}));var H=[].concat(x(E?[]:[g]),x(n.getVariantManagement()!==v.Control?W:[]),x(L?[L.id]:[]));var O=L&&n.getStickyMultiTabHeaderConfiguration()?L.id:undefined;return{mainEntitySet:a,mainEntityType:"".concat(a,"/"),multiViewsControl:L,stickySubheaderProvider:O,singleTableId:f,singleChartId:c,dynamicListReportId:d,headerActions:j,showPinnableToggle:u,filterBar:{propertyInfo:A,selectionFields:w,hideBasicSearch:M},views:o,filterBarId:E?"":g,filterConditions:{selectionVariant:B,defaultSemanticDates:R},variantManagement:{id:m,targetControlIds:H.join(",")},hasMultiVisualizations:X(t),templateType:n.getTemplateType(),useSemanticDateRange:V,filterInitialLayout:I,filterLayout:T,kpiDefinitions:b(t),hideFilterBar:E}};s.convertPage=_;function tt(t,e){var a="",n="";if(t.getManifestWrapper().hasMultipleVisualizations()||t.getTemplateType()===f.AnalyticalListPage){var r=W(e),i;try{for(r.s();!(i=r.n()).done;){var o=i.value;o=o;if(o.chartControlId&&o.tableControlId){n=o.chartControlId;a=o.tableControlId;break}}}catch(t){r.e(t)}finally{r.f()}}else{var l=W(e),s;try{for(l.s();!(s=l.n()).done;){var u=s.value;u=u;if(!a&&u.tableControlId){a=u.tableControlId||""}if(!n&&u.chartControlId){n=u.chartControlId||""}if(n&&a){break}}}catch(t){l.e(t)}finally{l.f()}}if(a||n){return{chartId:n,tableId:a}}return undefined}return s},false);
//# sourceMappingURL=ListReportConverter.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/controllerextensions/Placeholder","sap/fe/core/helpers/AppStartupHelper","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/EditState","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/suite/ui/commons/collaboration/CollaborationHelper","sap/ui/base/BindingParser","sap/ui/base/EventProvider","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/model/odata/v4/ODataUtils"],function(e,t,r,n,a,o,i,s,u,c,h,l,f,g,v){"use strict";var p,d,m,P,C,R,_;var M={};var y=o.event;var b=o.defineUI5Class;function x(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}function L(e,t,r,n){if(!r)return;Object.defineProperty(e,t,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(n):void 0})}function T(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function S(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;w(e,t)}function w(e,t){w=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return w(e,t)}function E(e,t,r,n,a){var o={};Object.keys(n).forEach(function(e){o[e]=n[e]});o.enumerable=!!o.enumerable;o.configurable=!!o.configurable;if("value"in o||o.initializer){o.writable=true}o=r.slice().reverse().reduce(function(r,n){return n(e,t,r)||r},o);if(a&&o.initializer!==void 0){o.value=o.initializer?o.initializer.call(a):void 0;o.initializer=undefined}if(o.initializer===void 0){Object.defineProperty(e,t,o);o=null}return o}function I(e,t){throw new Error("Decorating class property failed. Please ensure that "+"proposal-class-properties is enabled and runs after the decorators transform.")}var A=(p=b("sap.fe.core.services.RoutingServiceEventing"),d=y(),m=y(),p(P=(C=function(e){S(t,e);function t(){var t;for(var r=arguments.length,n=new Array(r),a=0;a<r;a++){n[a]=arguments[a]}t=e.call.apply(e,[this].concat(n))||this;L(t,"routeMatched",R,T(t));L(t,"afterRouteMatched",_,T(t));return t}return t}(l),R=E(C.prototype,"routeMatched",[d],{configurable:true,enumerable:true,writable:true,initializer:null}),_=E(C.prototype,"afterRouteMatched",[m],{configurable:true,enumerable:true,writable:true,initializer:null}),C))||P);var O=function(o){S(l,o);function l(){var e;for(var t=arguments.length,r=new Array(t),n=0;n<t;n++){r[n]=arguments[n]}e=o.call.apply(o,[this].concat(r))||this;e.navigationInfoQueue=[];return e}M.RoutingService=l;var f=l.prototype;f.init=function e(){var t=this.getContext();if(t.scopeType==="component"){this.oAppComponent=t.scopeObject;this.oModel=this.oAppComponent.getModel();this.oMetaModel=this.oModel.getMetaModel();this.oRouter=this.oAppComponent.getRouter();this.oRouterProxy=this.oAppComponent.getRouterProxy();this.eventProvider=new A;var r=this.oAppComponent.getManifestEntry("/sap.ui5/routing");var n=this.oAppComponent.getManifestEntry("/sap.ui5/rootView");this._parseRoutingConfiguration(r,n);var a=this.oAppComponent.getManifestEntry("/sap.app");this.outbounds=a&&a.crossNavigation&&a.crossNavigation.outbounds}this.initPromise=Promise.resolve(this)};f.beforeExit=function e(){this.oRouter.detachRouteMatched(this._fnOnRouteMatched,this);this.eventProvider.fireEvent("routeMatched",{})};f.exit=function e(){this.eventProvider.destroy()};f._parseRoutingConfiguration=function t(r,n){var a=this;var o=(n===null||n===void 0?void 0:n.viewName)==="sap.fe.core.rootView.Fcl"||(n===null||n===void 0?void 0:n.viewName)==="sap.fe.templates.RootContainer.view.Fcl";this._mTargets={};Object.keys(r.targets).forEach(function(e){a._mTargets[e]=Object.assign({targetName:e},r.targets[e]);if(a._mTargets[e].contextPattern!==undefined){a._mTargets[e].viewLevel=a._getViewLevelFromPattern(a._mTargets[e].contextPattern,0)}});this._mRoutes={};for(var i in r.routes){var s=r.routes[i],u=Array.isArray(s.target)?s.target:[s.target],c=Array.isArray(r.routes)?s.name:i,h=s.pattern;if(h.length<8||h.indexOf(":?query:")!==h.length-8){e.warning("Pattern for route ".concat(c," doesn't end with ':?query:' : ").concat(h))}var l=this._getViewLevelFromPattern(h,0);this._mRoutes[c]={name:c,pattern:h,targets:u,routeLevel:l};for(var f=0;f<u.length;f++){var g=this._mTargets[u[f]].parent;if(g){u.push(g)}}if(!o){if(this._mTargets[u[0]].viewLevel===undefined||this._mTargets[u[0]].viewLevel<l){this._mTargets[u[0]].viewLevel=l}this._mTargets[u[0]].FCLLevel=-1}else if(u.length===1&&this._mTargets[u[0]].controlAggregation!=="beginColumnPages"){this._mTargets[u[0]].FCLLevel=3}else{u.forEach(function(e){switch(a._mTargets[e].controlAggregation){case"beginColumnPages":a._mTargets[e].FCLLevel=0;break;case"midColumnPages":a._mTargets[e].FCLLevel=1;break;default:a._mTargets[e].FCLLevel=2}})}}Object.keys(this._mTargets).forEach(function(e){while(a._mTargets[e].parent){var t=a._mTargets[e].parent;a._mTargets[t].viewLevel=a._mTargets[t].viewLevel||a._mTargets[e].viewLevel;a._mTargets[t].contextPattern=a._mTargets[t].contextPattern||a._mTargets[e].contextPattern;a._mTargets[t].FCLLevel=a._mTargets[t].FCLLevel||a._mTargets[e].FCLLevel;a._mTargets[t].controlAggregation=a._mTargets[t].controlAggregation||a._mTargets[e].controlAggregation;e=t}});var v=[];var p=[];var d;for(var m in this._mRoutes){var P=this._mRoutes[m].routeLevel;if(P===0){v.push(m)}else if(P===1){p.push(m)}}if(v.length===1){d=v[0]}else if(p.length===1){d=p[0]}if(d){var C=this._mRoutes[d].targets.slice(-1)[0];this.sContextPath="";if(this._mTargets[C].options&&this._mTargets[C].options.settings){var R=this._mTargets[C].options.settings;this.sContextPath=R.contextPath||"/".concat(R.entitySet)}if(!this.sContextPath){e.warning("Cannot determine default contextPath: contextPath or entitySet missing in default target: ".concat(C))}}else{e.warning("Cannot determine default contextPath: no default route found.")}Object.keys(this._mTargets).map(function(e){return a._mTargets[e]}).sort(function(e,t){return e.viewLevel<t.viewLevel?-1:1}).forEach(function(e){if(e.options){var t=e.options.settings;var r=t.contextPath||(t.entitySet?"/".concat(t.entitySet):"");if(!t.fullContextPath&&r){t.fullContextPath="".concat(r,"/")}Object.keys(t.navigation||{}).forEach(function(r){var n=a._mRoutes[t.navigation[r].detail.route];if(n&&n.targets){n.targets.forEach(function(n){if(a._mTargets[n].options&&a._mTargets[n].options.settings&&!a._mTargets[n].options.settings.fullContextPath){if(e.viewLevel===0){a._mTargets[n].options.settings.fullContextPath="".concat((r.startsWith("/")?"":"/")+r,"/")}else{a._mTargets[n].options.settings.fullContextPath="".concat(t.fullContextPath+r,"/")}}})}})}})};f._getViewLevelFromPattern=function e(t,r){t=t.replace(":?query:","");var n=new RegExp("/[^/]*$");if(t&&t[0]!=="/"&&t[0]!=="?"){t="/".concat(t)}if(t.length){t=t.replace(n,"");if(this.oRouter.match(t)||t===""){return this._getViewLevelFromPattern(t,++r)}else{return this._getViewLevelFromPattern(t,r)}}else{return r}};f._getRouteInformation=function e(t){return this._mRoutes[t]};f._getTargetInformation=function e(t){return this._mTargets[t]};f._getComponentId=function e(t,r){if(r.indexOf("".concat(t,"---"))===0){return r.substr(t.length+3)}return r};f.getTargetInformationFor=function e(t){var r=this;var n=this._getComponentId(t._sOwnerId,t.getId());var a=null;Object.keys(this._mTargets).forEach(function(e){if(r._mTargets[e].id===n||r._mTargets[e].viewId===n){a=e}});return this._getTargetInformation(a)};f.getLastSemanticMapping=function e(){return this.oLastSemanticMapping};f.setLastSemanticMapping=function e(t){this.oLastSemanticMapping=t};f.navigateTo=function e(t,r,n,a){var o=this;var i,c;if(t.getModel()&&t.getModel().getMetaModel&&t.getModel().getMetaModel()){c=s.isStickySessionSupported(t.getModel().getMetaModel())}if(!n){i=Promise.resolve(u.getSemanticPath(t))}else{i=this.prepareParameters(n,r,t).then(function(e){return o.oRouter.getURL(r,e)})}return i.then(function(e){o.oRouterProxy.navToHash(e,a,false,false,!c)})};f.prepareParameters=function t(r,n,a){var o=this;var i;try{var s=a.getPath();var u=a.getModel().getMetaModel();var c=s.split("/");var l=Object.keys(r).map(function(e){var t=r[e];var n=h.complexParser(t);var i=n.parts||[n];var s=i.map(function(e){var t=e.path.split("../");var r=c.slice(0,c.length-t.length+1);var n=r.join("/");var o=n===a.getPath()?a:a.getModel().bindContext(n).getBoundContext();var i=u.getMetaContext(n+"/"+t[t.length-1]);return o.requestProperty(t[t.length-1]).then(function(e){var t=i.getObject();var r=t.$Type;return v.formatLiteral(e,r)})});return Promise.all(s).then(function(t){var r=n.formatter?n.formatter.apply(o,t):t.join("");return{key:e,value:r}})});i=Promise.all(l).then(function(e){var t={};e.forEach(function(e){t[e.key]=e.value});return t})}catch(t){e.error("Could not parse the parameters for the navigation to route ".concat(n));i=Promise.resolve(undefined)}return i};f._fireRouteMatchEvents=function e(t){this.eventProvider.fireEvent("routeMatched",t);this.eventProvider.fireEvent("afterRouteMatched",t);i.cleanProcessedEditState()};f.navigateToContext=function e(t,n,a,o){var i=this;var u="",c,h=false;if(t.getModel()&&t.getModel().getMetaModel){h=s.isStickySessionSupported(t.getModel().getMetaModel())}if(n&&n.targetPath&&a&&a.navigation){var l=a.navigation[n.targetPath].detail;u=l.route;if(l.parameters){c=this.prepareParameters(l.parameters,u,t)}}var f=this._getPathFromContext(t,n);if(f.length===0&&this.bExitOnNavigateBackToRoot){this.oRouterProxy.exitFromApp();return Promise.resolve(true)}if(n!==null&&n!==void 0&&n.asyncContext||n!==null&&n!==void 0&&n.bDeferredContext){f+="(...)"}var g=this._calculateLayout(f,n);if(g){f+="?layout=".concat(g)}var v={oAsyncContext:n===null||n===void 0?void 0:n.asyncContext,bDeferredContext:n===null||n===void 0?void 0:n.bDeferredContext,bTargetEditable:n===null||n===void 0?void 0:n.editable,bPersistOPScroll:n===null||n===void 0?void 0:n.bPersistOPScroll,useContext:(n===null||n===void 0?void 0:n.updateFCLLevel)===-1||n!==null&&n!==void 0&&n.bRecreateContext?undefined:t,bDraftNavigation:n===null||n===void 0?void 0:n.bDraftNavigation,bShowPlaceholder:(n===null||n===void 0?void 0:n.showPlaceholder)!==undefined?n===null||n===void 0?void 0:n.showPlaceholder:true};if(n!==null&&n!==void 0&&n.checkNoHashChange){var p=this.oRouterProxy.getHash().replace(/[&?]{1}sap-iapp-state=[A-Z0-9]+/,"");if(f===p){var d=this.oRouter.getRouteInfoByHash(this.oRouterProxy.getHash());if(d){d.navigationInfo=v;d.routeInformation=this._getRouteInformation(this.sCurrentRouteName);d.routePattern=this.sCurrentRoutePattern;d.views=this.aCurrentViews}this.oRouterProxy.setFocusForced(!!n.bForceFocus);this._fireRouteMatchEvents(d);return Promise.resolve(true)}}if(n!==null&&n!==void 0&&n.transient&&n.editable==true&&f.indexOf("(...)")===-1){if(f.indexOf("?")>-1){f+="&i-action=create"}else{f+="?i-action=create"}}if(o&&o.name==="sap.fe.templates.ListReport"){var m=this.oRouter.getRouteInfoByHash(f);if(m){var P=this._getRouteInformation(m.name);if(P&&P.targets&&P.targets.length>0){var C=P.targets[P.targets.length-1];var R=this._getTargetInformation(C);if(R&&R.name==="sap.fe.templates.ObjectPage"){r.removeUnboundTransitionMessages()}}}}this.navigationInfoQueue.push(v);if(u&&c){return c.then(function(e){e.bIsStickyMode=h;i.oRouter.navTo(u,e);return Promise.resolve(true)})}return this.oRouterProxy.navToHash(f,false,n===null||n===void 0?void 0:n.noPreservationCache,n===null||n===void 0?void 0:n.bForceFocus,!h).then(function(e){if(!e){i.navigationInfoQueue.pop()}return e})};f.navigateToRoute=function e(t,r){var n=this.oRouter.getURL(t,r);return this.oRouterProxy.navToHash(n,undefined,undefined,undefined,!r.bIsStickyMode)};f.isCurrentStateImpactedBy=function e(t){var r=t.getPath();if(this.oRouterProxy.isCurrentStateImpactedBy(r)){return true}else if(/^[^\(\)]+\([^\(\)]+\)$/.test(r)){var n;if(this.oLastSemanticMapping&&this.oLastSemanticMapping.technicalPath===r){n=this.oLastSemanticMapping.semanticPath}else{n=u.getSemanticPath(t)}return n!=r?this.oRouterProxy.isCurrentStateImpactedBy(n):false}else{return false}};f._findPathToNavigate=function e(t){var r=new RegExp("/[^/]*$");t=t.replace(r,"");if(this.oRouter.match(t)||t===""){return t}else{return this._findPathToNavigate(t)}};f._checkIfContextSupportsSemanticPath=function e(t){var r=t.getPath();if(!/^\/[^\(]+\([^\)]+\)$/.test(r)){return false}var n=t.getModel().getMetaModel();var a=n.getMetaContext(t.getPath()).getObject("@sapui.name");if(!u.getSemanticKeys(n,a)){return false}return s.isDraftSupported(n,r)};f._getPathFromContext=function e(t,r){var n;if(t.isA("sap.ui.model.odata.v4.ODataListBinding")&&t.isRelative()){n=t.getHeaderContext().getPath()}else{n=t.getPath()}if(r.updateFCLLevel===-1){n=this._findPathToNavigate(n);if(this.oLastSemanticMapping&&this.oLastSemanticMapping.technicalPath===n){n=this.oLastSemanticMapping.semanticPath}}else if(this._checkIfContextSupportsSemanticPath(t)){var a=u.getSemanticPath(t,true);if(!a){this.setLastSemanticMapping(undefined)}else if(a!==n){this.setLastSemanticMapping({technicalPath:n,semanticPath:a});n=a}}if(n[0]==="/"){n=n.substring(1)}return n};f._calculateLayout=function e(t,r){var n=r.FCLLevel;if(r.updateFCLLevel){n+=r.updateFCLLevel;if(n<0){n=0}}return this.oAppComponent.getRootViewController().calculateLayout(n,t,r.sLayout,r.keepCurrentLayout)};f._beforeRouteMatched=function e(){var r=(new n).isPlaceholderEnabled();if(!r){var a=this.oAppComponent.getRootControl();t.lock(a)}};f._onRouteMatched=function r(a){var o=this;var i=this.oAppComponent.getAppStateHandler(),s=this.oAppComponent.getRootControl();var u=(new n).isPlaceholderEnabled();if(t.isLocked(s)&&!u){t.unlock(s)}var c=a.getParameters();if(this.navigationInfoQueue.length){c.navigationInfo=this.navigationInfoQueue[0];this.navigationInfoQueue=this.navigationInfoQueue.slice(1)}else{c.navigationInfo={}}if(i.checkIfRouteChangedByIApp()){c.navigationInfo.bReasonIsIappState=true;i.resetRouteChangedByIApp()}this.sCurrentRouteName=a.getParameter("name");this.sCurrentRoutePattern=c.config.pattern;this.aCurrentViews=a.getParameter("views");c.routeInformation=this._getRouteInformation(this.sCurrentRouteName);c.routePattern=this.sCurrentRoutePattern;this._fireRouteMatchEvents(c);if(!history.state||history.state.feLevel===undefined){this.oRouterProxy.restoreHistory().then(function(){o.oRouterProxy.resolveRouteMatch()}).catch(function(t){e.error("Error while restoring history",t)})}else{this.oRouterProxy.resolveRouteMatch()}};f.attachRouteMatched=function e(t,r,n){this.eventProvider.attachEvent("routeMatched",t,r,n)};f.detachRouteMatched=function e(t,r){this.eventProvider.detachEvent("routeMatched",t,r)};f.attachAfterRouteMatched=function e(t,r,n){this.eventProvider.attachEvent("afterRouteMatched",t,r,n)};f.detachAfterRouteMatched=function e(t,r){this.eventProvider.detachEvent("afterRouteMatched",t,r)};f.getRouteFromHash=function e(t,r){var n=t.getHashChanger().hash;var a=t.getRouteInfoByHash(n);return r.getMetadata().getManifestEntry("/sap.ui5/routing/routes").filter(function(e){return e.name===a.name})[0]};f.getTargetsFromRoute=function e(t){var r=this;var n=t.target;if(typeof n==="string"){return[this._mTargets[n]]}else{var a=[];n.forEach(function(e){a.push(r._mTargets[e])});return a}};f.initializeRouting=function t(){try{var r=this;return Promise.resolve(c.processAndExpandHash()).then(function(){r._fnOnRouteMatched=r._onRouteMatched.bind(r);r.oRouter.attachRouteMatched(r._fnOnRouteMatched,r);var t=(new n).isPlaceholderEnabled();if(!t){r.oRouter.attachBeforeRouteMatched(r._beforeRouteMatched.bind(r))}r.navigationInfoQueue=[];i.resetEditState();r.bExitOnNavigateBackToRoot=!r.oRouter.match("");var a=r.oRouter.getHashChanger().getHash().indexOf("sap-iapp-state")!==-1;var o=x(function(){return Promise.resolve(r.oAppComponent.getStartupParameters()).then(function(e){var t=e!==undefined&&Object.keys(e).length!==0;var n=r.oRouter.getHashChanger().getHash();var o=function(){if(!a&&t&&!n){var o=function(){if(e.preferredMode&&e.preferredMode[0].toUpperCase().indexOf("CREATE")!==-1){return Promise.resolve(r._manageCreateStartup(e)).then(function(){})}else{return Promise.resolve(r._manageDeepLinkStartup(e)).then(function(){})}}();if(o&&o.then)return o.then(function(){})}}();if(o&&o.then)return o.then(function(){})})},function(t){e.error("Error during routing initialization",t)});if(o&&o.then)return o.then(function(){})})}catch(e){return Promise.reject(e)}};f.getDefaultCreateHash=function e(t){return a.getDefaultCreateHash(t,this.getContextPath(),this.oRouter)};f._manageCreateStartup=function e(t){var r=this;return a.getCreateStartupHash(t,this.getContextPath(),this.oRouter,this.oMetaModel).then(function(e){if(e){r.oRouter.getHashChanger().replaceHash(e);if(t!==null&&t!==void 0&&t.preferredMode&&t.preferredMode[0].toUpperCase().indexOf("AUTOCREATE")!==-1){r.oAppComponent.setStartupModeAutoCreate()}else{r.oAppComponent.setStartupModeCreate()}r.bExitOnNavigateBackToRoot=true}})};f._manageDeepLinkStartup=function e(t){var r=this;return a.getDeepLinkStartupHash(this.oAppComponent.getManifest()["sap.ui5"].routing,t,this.oModel).then(function(e){var t;if(e.context){var n=e.context.getPath();var a=r._checkIfContextSupportsSemanticPath(e.context)?u.getSemanticPath(e.context):n;if(a!==n){r.setLastSemanticMapping({technicalPath:n,semanticPath:a})}t=a.substring(1)}else if(e.hash){t=e.hash}if(t){r.oRouter.getHashChanger().replaceHash(t);r.oAppComponent.setStartupModeDeeplink()}})};f.getOutbounds=function e(){return this.outbounds};f.getContextPath=function e(){return this.sContextPath};f.getInterface=function e(){return this};return l}(f);M.RoutingService=O;var k=function(e){S(t,e);function t(){return e.apply(this,arguments)||this}var r=t.prototype;r.createInstance=function e(t){var r=new O(t);return r.initPromise};return t}(g);return k},false);
//# sourceMappingURL=RoutingServiceFactory.js.map
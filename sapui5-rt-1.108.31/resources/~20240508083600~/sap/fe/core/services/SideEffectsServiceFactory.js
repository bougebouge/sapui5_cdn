/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/converters/MetaModelConverter","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory"],function(t,e,r,i){"use strict";var n={};var o=e.convertTypes;function a(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,i)}return r}function c(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?a(Object(r),!0).forEach(function(e){f(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function f(t,e,r){e=s(e);if(e in t){Object.defineProperty(t,e,{value:r,enumerable:true,configurable:true,writable:true})}else{t[e]=r}return t}function s(t){var e=u(t,"string");return typeof e==="symbol"?e:String(e)}function u(t,e){if(typeof t!=="object"||t===null)return t;var r=t[Symbol.toPrimitive];if(r!==undefined){var i=r.call(t,e||"default");if(typeof i!=="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function p(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;v(t,e)}function v(t,e){v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){e.__proto__=r;return e};return v(t,e)}var l=function(e){p(r,e);function r(){return e.apply(this,arguments)||this}n.SideEffectsService=r;var i=r.prototype;i.init=function t(){this._oSideEffectsType={oData:{entities:{},actions:{}},control:{}};this._bInitialized=false;this.initPromise=Promise.resolve(this)};i.addControlSideEffects=function t(e,r){if(r.sourceControlId){var i=c(c({},r),{},{fullyQualifiedName:"".concat(e,"/SideEffectsForControl/").concat(r.sourceControlId)});var n=this._oSideEffectsType.control[e]||{};n[i.sourceControlId]=i;this._oSideEffectsType.control[e]=n}};i.executeAction=function t(e,r,i){var n=r.getModel().bindContext("".concat(e,"(...)"),r);return n.execute(i||r.getBinding().getUpdateGroupId())};i.getConvertedMetaModel=function t(){var e=this.getContext();var r=e.scopeObject;var i=r.getModel().getMetaModel();return o(i,this._oCapabilities)};i.getEntityTypeFromContext=function t(e){var r=e.getModel().getMetaModel(),i=r.getMetaPath(e.getPath()),n=r.getObject(i)["$Type"];return n};i.getODataEntitySideEffects=function t(e){return this._oSideEffectsType.oData.entities[e]||{}};i.getGlobalODataEntitySideEffects=function t(e){var r=this.getODataEntitySideEffects(e);var i=[];for(var n in r){var o=r[n];if(!o.SourceEntities&&!o.SourceProperties){i.push(o)}}return i};i.getODataActionSideEffects=function t(e,r){if(r){var i=this.getEntityTypeFromContext(r);if(i){var n;return(n=this._oSideEffectsType.oData.actions[i])===null||n===void 0?void 0:n[e]}}return undefined};i.initializeSideEffects=function t(e){var r=this;this._oCapabilities=e;if(!this._bInitialized){var i=this.getConvertedMetaModel();i.entityTypes.forEach(function(t){r._oSideEffectsType.oData.entities[t.fullyQualifiedName]=r._retrieveODataEntitySideEffects(t);r._oSideEffectsType.oData.actions[t.fullyQualifiedName]=r._retrieveODataActionsSideEffects(t)});this._bInitialized=true}};i.removeControlSideEffects=function t(e){var r=this;Object.keys(this._oSideEffectsType.control).forEach(function(t){if(r._oSideEffectsType.control[t][e]){delete r._oSideEffectsType.control[t][e]}})};i.requestSideEffects=function t(e,r,i){this._logRequest(e,r);var n;try{n=r.requestSideEffects(e,i)}catch(t){n=Promise.reject(t)}return n};i.requestSideEffectsForODataAction=function t(e,r){var i,n=this,o;var a;if((i=e.triggerActions)!==null&&i!==void 0&&i.length){a=e.triggerActions.map(function(t){return n.executeAction(t,r)})}else{a=[]}if((o=e.pathExpressions)!==null&&o!==void 0&&o.length){a.push(this.requestSideEffects(e.pathExpressions,r))}return a.length?Promise.all(a):Promise.resolve()};i.requestSideEffectsForNavigationProperty=function e(r,i){var n=this;var o=this.getEntityTypeFromContext(i);if(o){var a="".concat(r,"/");var c=this.getODataEntitySideEffects(o);var f=[];Object.keys(c).filter(function(t){var e=c[t];return(e.SourceProperties||[]).some(function(t){var e=t.value;return e.startsWith(a)&&e.replace(a,"").indexOf("/")===-1})||(e.SourceEntities||[]).some(function(t){return t.value===r})}).forEach(function(t){var e=c[t];if(e.TriggerAction){n.executeAction(e.TriggerAction,i)}(e.TargetEntities||[]).concat(e.TargetProperties||[]).forEach(function(t){return f.push(t)})});f=this._removeDuplicateTargets(f);if(f.length>0){return this.requestSideEffects(f,i).catch(function(e){return t.error("SideEffects - Error while processing SideEffects for Navigation Property ".concat(r),e)})}}return Promise.resolve()};i.getControlEntitySideEffects=function t(e){return this._oSideEffectsType.control[e]||{}};i._addRequiredTextProperties=function e(r,i){var n=r.TargetProperties||[],o=(r.TargetEntities||[]).map(function(t){return t.$NavigationPropertyPath});var a=[];n.forEach(function(e){var r=e.endsWith("*"),n=e.substring(0,e.lastIndexOf("/")),c=n?"".concat(n,"/"):"",f=i.resolvePath(n)||i;if(f){var s;var u=f.entityProperties||((s=f.targetType)===null||s===void 0?void 0:s.properties)||f.targetType.entityProperties;if(u){if(r){o.push(n);a=a.concat(u.map(function(t){return{navigationPath:c,property:t}}))}else{a.push({property:u.find(function(t){return t.name===e.split("/").pop()}),navigationPath:c})}}else{t.info("SideEffects - The entity type associated to property path ".concat(e," cannot be resolved"))}}else{t.info("SideEffects - The property path ".concat(e," cannot be resolved"))}});a.forEach(function(t){if(t.property){var e,a,c;var f=(e=t.property.annotations)===null||e===void 0?void 0:(a=e.Common)===null||a===void 0?void 0:(c=a.Text)===null||c===void 0?void 0:c.path,s=t.navigationPath+f,u=s.substring(0,s.lastIndexOf("/"));if(f&&o.indexOf(u)===-1&&n.indexOf(s)===-1){var p;if(f.lastIndexOf("/")>-1&&((p=i.resolvePath(u))===null||p===void 0?void 0:p._type)==="NavigationProperty"){r.TargetEntities.push({$NavigationPropertyPath:u});o.push(u)}else{r.TargetProperties.push(s)}}}});return r};i._convertSideEffects=function t(e,r,i){var n=this._removeBindingParameter(this._convertTargetsFormat(e),i);return this._addRequiredTextProperties(n,r)};i._convertTargetsFormat=function e(r){var i=(r.TargetProperties||[]).reduce(function(e,i){var n=typeof i==="string"&&i||i.type==="PropertyPath"&&i.value;if(n){e.push(n)}else{t.error("SideEffects - Error while processing TargetProperties for SideEffects".concat(r.fullyQualifiedName))}return e},[]),n=(r.TargetEntities||[]).map(function(t){return{$NavigationPropertyPath:t.$NavigationPropertyPath||t.value||""}});return c(c({},r),{TargetProperties:i,TargetEntities:n})};i._getSideEffectsFromSource=function t(e){var r=this;var i=[];var n=["EntityType","Action"];if(e._type&&n.indexOf(e._type)>-1){var o=e._type==="EntityType"?e:e.sourceEntityType;if(o){var a;var c=((a=e.annotations)===null||a===void 0?void 0:a.Common)||{};var f=(e.parameters||[]).find(function(t){return t.type===o.fullyQualifiedName});var s=f?f.fullyQualifiedName.split("/")[1]:"";Object.keys(c).filter(function(t){return c[t].$Type==="com.sap.vocabularies.Common.v1.SideEffectsType"}).forEach(function(t){i.push(r._convertSideEffects(c[t],o,s))})}}return i};i._logRequest=function e(r,i){var n=r.reduce(function(t,e){return"".concat(t,"\n\t\t").concat(e.$NavigationPropertyPath||e||"")},"");t.debug("SideEffects - Request:\n\tContext path : ".concat(i.getPath(),"\n\tProperty paths :").concat(n))};i._removeBindingParameter=function t(e,r){if(r){var i=["TargetProperties","TargetEntities"];i.forEach(function(t){var i=e[t];if(i){i=i.map(function(t){var e=t.$NavigationPropertyPath!==undefined;var i=(e?t.$NavigationPropertyPath:t).replace(new RegExp("^".concat(r,"/?")),"");return e?{$NavigationPropertyPath:i}:i})}e[t]=i})}return e};i._removeDuplicateTargets=function t(e){return e.filter(function(t,e,r){return r.findIndex(function(e){return e===t||t.$NavigationPropertyPath&&e.$NavigationPropertyPath===t.$NavigationPropertyPath})===e})};i._retrieveODataActionsSideEffects=function t(e){var r=this;var i={};var n=e.actions;if(n){Object.keys(n).forEach(function(t){var n=e.actions[t];var o=[];var a=[];var c=[];r._getSideEffectsFromSource(n).forEach(function(t){var e=t.TriggerAction;c=c.concat(t.TargetEntities||[]).concat(t.TargetProperties||[]);if(e&&o.indexOf(e)===-1){o.push(e)}});a=r._removeDuplicateTargets(c);i[t]={pathExpressions:a,triggerActions:o}})}return i};i._retrieveODataEntitySideEffects=function t(e){var r={};this._getSideEffectsFromSource(e).forEach(function(t){r[t.fullyQualifiedName]=t});return r};i.getInterface=function t(){return this};return r}(r);n.SideEffectsService=l;var d=function(t){p(e,t);function e(){return t.apply(this,arguments)||this}var r=e.prototype;r.createInstance=function t(e){var r=new l(e);return r.initPromise};return e}(i);return d},false);
//# sourceMappingURL=SideEffectsServiceFactory.js.map
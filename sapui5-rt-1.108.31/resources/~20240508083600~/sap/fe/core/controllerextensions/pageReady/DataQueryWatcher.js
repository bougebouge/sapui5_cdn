/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/macros/table/Utils"],function(e,t){"use strict";function i(e,t){try{var i=e()}catch(e){return t(e)}if(i&&i.then){return i.then(void 0,t)}return i}var n=function(){function n(e,t){this._aBindingRegistrations=[];this._aOtherEventSources=[];this._isSearchPending=false;this._aMDCTables=[];this._aMDCCharts=[];this._oEventProvider=e;this._fnOnFinished=t}var r=n.prototype;r.isSearchPending=function e(){return this._isSearchPending};r.isDataReceived=function e(){return this._isDataReceived};r.resetDataReceived=function e(){this._isDataReceived=undefined};r.reset=function e(){var t=this;this._aBindingRegistrations.forEach(function(e){e.binding.detachEvent("dataRequested",t.onDataRequested,t);e.binding.detachEvent("dataReceived",t.onDataReceived,t)});this._aOtherEventSources.forEach(function(e){e.detachEvent("search",t.onSearch,t);e.detachEvent("bindingUpdated",t.register,t)});this._aBindingRegistrations=[];this._aOtherEventSources=[];this._aMDCTables=[];this._aMDCCharts=[];this._isSearchPending=false;this._isDataReceived=undefined};r.onDataReceived=function t(i,n){var r=i.getSource();var a=this._aBindingRegistrations.find(function(e){return e.binding===r});if(!a){e.error("PageReady - data received on an unregistered binding");return}switch(r.getGroupId()){case"$auto.Workers":this._oEventProvider.fireEvent("workersBatchReceived");break;case"$auto.Heroes":this._oEventProvider.fireEvent("heroesBatchReceived");break;default:}a.receivedCount++;if(a.receivedCount<a.requestedCount){r.attachEventOnce("dataReceived",{triggeredBySearch:n.triggeredBySearch},this.onDataReceived,this);return}var s=this._aBindingRegistrations.some(function(e){return e.requestedCount!==0})&&this._aBindingRegistrations.every(function(e){return e.requestedCount===0||e.receivedCount>=e.requestedCount});if(n.triggeredBySearch||a.receivedCount>=a.requestedCount){this._isSearchPending=false}if(s){this._isDataReceived=true;this._fnOnFinished()}};r.onDataRequested=function t(i,n){var r=i.getSource();var a=this._aBindingRegistrations.find(function(e){return e.binding===r});if(!a){e.error("PageReady - data requested on an unregistered binding");return}a.requestedCount++;this._isDataReceived=false;if(a.requestedCount-a.receivedCount===1){r.attachEventOnce("dataReceived",{triggeredBySearch:n.triggeredBySearch},this.onDataReceived,this)}};r.onSearch=function t(n){var r=this;var a=this;var s=this._aMDCTables.filter(function(e){var t;return n.getSource().sId===e.getFilter()&&e.getVisible()&&!((t=e.getParent())!==null&&t!==void 0&&t.getProperty("bindingSuspended"))});var d=this._aMDCCharts.filter(function(e){return n.getSource().sId===e.getFilter()&&e.getVisible()});if(s.length>0||d.length>0){this._isSearchPending=true}s.forEach(function(e){a.registerTable(e,true)});d.forEach(function(t){try{var n=i(function(){function e(){r.registerChart(t,true)}var i=function(){if(t.innerChartBoundPromise){return Promise.resolve(t.innerChartBoundPromise).then(function(){})}}();return i&&i.then?i.then(e):e(i)},function(t){e.error("Cannot find a inner bound chart",t)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})};r.register=function e(t,i){var n,r;var a=i.binding||((n=i.table)===null||n===void 0?void 0:n.getRowBinding())||((r=i.chart)===null||r===void 0?void 0:r.getControlDelegate().getInnerChart(i.chart).getBinding("data"));var s=i.table||i.chart;if(!a){return}var d=this._aBindingRegistrations.find(function(e){return e.binding===a});if(d){if(s){d.boundControl=s}if(d.requestedCount>0){a.detachEvent("dataRequested",this.onDataRequested,this);a.attachEventOnce("dataRequested",{triggeredBySearch:i.triggeredBySearch},this.onDataRequested,this)}return}if(s){d=this._aBindingRegistrations.find(function(e){return e.boundControl===s});if(d&&d.binding!==a){d.binding=a;d.requestedCount=0;d.receivedCount=0}}if(!d){d={binding:a,boundControl:s,requestedCount:0,receivedCount:0};this._aBindingRegistrations.push(d)}a.detachEvent("dataRequested",this.onDataRequested,this);a.attachEventOnce("dataRequested",{triggeredBySearch:i.triggeredBySearch},this.onDataRequested,this)};r.registerBinding=function e(t){this.register(null,{binding:t,triggeredBySearch:false})};r.registerTable=function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(this._aMDCTables.indexOf(t)<0){this._aMDCTables.push(t)}var n=t.getRowBinding();if(n){this.register(null,{table:t,triggeredBySearch:i})}if(this._aOtherEventSources.indexOf(t)===-1){t.attachEvent("bindingUpdated",{table:t,triggeredBySearch:i},this.register,this);this._aOtherEventSources.push(t)}};r.registerChart=function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(this._aMDCCharts.indexOf(t)<0){this._aMDCCharts.push(t)}var n=t.getControlDelegate().getInnerChart(t);var r=n===null||n===void 0?void 0:n.getBinding("data");if(r){this.register(null,{chart:t,triggeredBySearch:i})}if(this._aOtherEventSources.indexOf(t)===-1){t.attachEvent("bindingUpdated",{chart:t,triggeredBySearch:i},this.register,this);this._aOtherEventSources.push(t)}};r.registerTableOrChart=function n(r){try{var a=this;if(!r.isA("sap.ui.mdc.Table")&&!r.isA("sap.ui.mdc.Chart")){return Promise.resolve()}var s=i(function(){return Promise.resolve(r.initialized()).then(function(){var e=function(){if(r.isA("sap.ui.mdc.Table")){a.registerTable(r);var e=function(){if(r.getAutoBindOnInit()&&r.getDomRef()){return Promise.resolve(t.whenBound(r)).then(function(){})}}();if(e&&e.then)return e.then(function(){})}else{a.registerChart(r)}}();if(e&&e.then)return e.then(function(){})})},function(t){e.error("PageReady - Cannot register a table or a chart",t)});return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};r.registerFilterBar=function e(t){t.attachEvent("search",this.onSearch,this);this._aOtherEventSources.push(t)};return n}();return n},false);
//# sourceMappingURL=DataQueryWatcher.js.map
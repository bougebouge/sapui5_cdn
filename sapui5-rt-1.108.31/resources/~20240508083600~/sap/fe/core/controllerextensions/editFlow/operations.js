/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/core/message/Message","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","../../operationsHelper"],function(e,t,n,r,a,o,i,l,s,c,u,f,d,g,v,m,p,h,P){"use strict";var M=g.MessageType;var x=i.generate;function C(e,t){var n=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=y(e))||t&&e&&typeof e.length==="number"){if(n)e=n;var r=0;var a=function(){};return{s:a,n:function(){if(r>=e.length)return{done:true};return{done:false,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o=true,i=false,l;return{s:function(){n=n.call(e)},n:function(){var e=n.next();o=e.done;return e},e:function(e){i=true;l=e},f:function(){try{if(!o&&n.return!=null)n.return()}finally{if(i)throw l}}}}function y(e,t){if(!e)return;if(typeof e==="string")return b(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return b(e,t)}function b(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,r=new Array(t);n<t;n++){r[n]=e[n]}return r}function A(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}function E(e,t){try{var n=e()}catch(e){return t(true,e)}if(n&&n.then){return n.then(t.bind(null,false),t.bind(null,true))}return t(false,n)}var O=function(e,t,n,r,a,o,i){try{return Promise.resolve(K(e,t,n,r)).then(function(e){var n;if(e!==null&&e!==void 0&&e.some(function(e){return e.status==="rejected"})){throw e}var l=f.getMessageManager().getMessageModel().getData();if(t.internalModelContext&&t.internalModelContext.getProperty("412Executed")&&(n=t.internalModelContext.getProperty("strictHandlingFails"))!==null&&n!==void 0&&n.length){if(!i){t.internalModelContext.setProperty("DelayMessages",t.internalModelContext.getProperty("DelayMessages").concat(l))}else{f.getMessageManager().addMessages(t.internalModelContext.getProperty("DelayMessages"));if(l.length){r.showMessageDialog({onBeforeShowMessage:function(e,n){return R(t,a,o,e,n)}})}}}else if(l.length){r.showMessageDialog({isActionParameterDialogOpen:t===null||t===void 0?void 0:t.oDialog.isOpen(),onBeforeShowMessage:function(e,n){return R(t,a,o,e,n)}})}return e})}catch(e){return Promise.reject(e)}};var I=l.Constants,S=l.InvocationGrouping;var T=u.Action;function $(e,t,n,r,a){if(!t||t.length===0){return Promise.reject("Bound actions always requires at least one context")}var o=Array.isArray(t);a.aContexts=o?t:[t];var i=n.getMetaModel(),l="".concat(i.getMetaPath(a.aContexts[0].getPath()),"/").concat(e),s=i.createBindingContext("".concat(l,"/@$ui5.overload/0"));a.isCriticalAction=G(i,l,a.aContexts,s);var c=function(e){if(e[0].status==="fulfilled"){return e[0].value}else{throw e[0].reason||e}};return w(e,n,s,r,a).then(function(e){if(o){return e}else{return c(e)}},function(e){if(o){throw e}else{return c(e)}})}function N(e,t,n,r){if(!t){return Promise.reject("Action expects a model/context for execution")}var a=t.getMetaModel(),o=t.bindContext("/".concat(e)).getPath(),i=a.createBindingContext("/".concat(a.createBindingContext(o).getObject("$Action"),"/0"));r.isCriticalAction=G(a,"".concat(o,"/@$ui5.overload"));return w(e,t,i,n,r)}function B(e,t,n){if(!t){return Promise.reject("Bound functions always requires a context")}var r=n.getMetaModel(),a="".concat(r.getMetaPath(t.getPath()),"/").concat(e),o=r.createBindingContext(a);return D(e,n,o,t)}function j(e,t){if(!e){return Promise.resolve()}var n=t.getMetaModel(),r=t.bindContext("/".concat(e)).getPath(),a=n.createBindingContext("/".concat(n.createBindingContext(r).getObject("$Function"),"/0"));return D(e,t,a)}function D(e,t,n,r){var a;if(!n||!n.getObject()){return Promise.reject(new Error("Function ".concat(e," not found")))}if(r){n=t.bindContext("".concat(e,"(...)"),r);a="functionGroup"}else{n=t.bindContext("/".concat(e,"(...)"));a="functionImport"}var o=n.execute(a);t.submitBatch(a);return o.then(function(){return n.getBoundContext()})}function w(e,t,n,r,a){return new Promise(function(o,i){try{var l={};var s;var c;var u=a.label;var d=a.skipParameterDialog;var g=a.aContexts;var v=a.bIsCreateAction;var m=a.isCriticalAction;var p;var h;var P;var M;var x;var C;var y;var b=n.getObject();if(!n||!n.getObject()){return Promise.resolve(i(new Error("Action ".concat(e," not found"))))}var O=V(n);var I=O.length>0&&!(O.length===1&&O[0].$Name==="ResultIsActiveEntity");var T=a.parameterValues;var $=r.getComponentData();var N=$&&$.startupParameters||{};if(I&&d){y=J(v,O,T,N)}s=null;if(I){if(!(d&&y)){s=H}}else if(m){s=_}l={fnOnSubmitted:a.onSubmitted,fnOnResponse:a.onResponse,actionName:e,model:t,aActionParameters:O,bGetBoundContext:a.bGetBoundContext,defaultValuesExtensionFunction:a.defaultValuesExtensionFunction,label:a.label,selectedItems:a.selectedItems};if(n.getObject("$IsBound")){if(a.additionalSideEffect&&a.additionalSideEffect.pathExpressions){p=t.getMetaModel();h=p.getMetaPath(g[0].getPath());P=p.getObject("".concat(h,"/@com.sap.vocabularies.Common.v1.Messages/$Path"));if(P){M=a.additionalSideEffect.pathExpressions.findIndex(function(e){return typeof e==="string"&&e===P});C=n.getObject("$ReturnType");x=C&&!C.$isCollection&&n.getModel().getObject(h).$Type===C.$Type;if(M>-1||x){a.mBindingParameters=a.mBindingParameters||{};if(n.getObject("$ReturnType/$Type/".concat(P))&&(!a.mBindingParameters.$select||a.mBindingParameters.$select.split(",").indexOf(P)===-1)){a.mBindingParameters.$select=a.mBindingParameters.$select?"".concat(a.mBindingParameters.$select,",").concat(P):P;if(M===-1){a.additionalSideEffect.pathExpressions.push("*")}if(a.additionalSideEffect.triggerActions.length===0&&M>-1){a.additionalSideEffect.pathExpressions.splice(M,1)}}}}}l.aContexts=g;l.mBindingParameters=a.mBindingParameters;l.additionalSideEffect=a.additionalSideEffect;l.bGrouped=a.invocationGrouping===S.ChangeSet;l.internalModelContext=a.internalModelContext;l.operationAvailableMap=a.operationAvailableMap;l.isCreateAction=v;l.bObjectPage=a.bObjectPage;if(a.controlId){l.control=a.parentControl.byId(a.controlId)}else{l.control=a.parentControl}}if(v){l.bIsCreateAction=v}var B=(b.$Parameter||[]).some(function(e){return(b.$EntitySetPath&&b.$EntitySetPath===e.$Name||b.$IsBound)&&e.$isCollection});l.isStatic=B;return Promise.resolve(function(){if(s){c=s(e,r,u,l,O,T,n,a.parentControl,a.entitySetName,a.messageHandler);return c.then(function(e){F(a,l,b);o(e)}).catch(function(e){i(e)})}else{if(T){var t=function(e){var t;l.aActionParameters[e].value=T===null||T===void 0?void 0:(t=T.find(function(t){return t.name===l.aActionParameters[e].$Name}))===null||t===void 0?void 0:t.value};for(var d in l.aActionParameters){t(d)}}else{for(var g in l.aActionParameters){var v;l.aActionParameters[g].value=(v=N[l.aActionParameters[g].$Name])===null||v===void 0?void 0:v[0]}}var m;var p=E(function(){return A(function(){var e,t;(e=l)===null||e===void 0?void 0:(t=e.internalModelContext)===null||t===void 0?void 0:t.setProperty("412Executed",false);return Promise.resolve(K(r,l,a.parentControl,a.messageHandler)).then(function(e){var t;m=e;var n=f.getMessageManager().getMessageModel().getData();if(l.internalModelContext&&l.internalModelContext.getProperty("412Executed")&&(t=l.internalModelContext.getProperty("strictHandlingFails"))!==null&&t!==void 0&&t.length){l.internalModelContext.setProperty("DelayMessages",l.internalModelContext.getProperty("DelayMessages").concat(n))}F(a,l,b);o(m)})},function(){i(m)})},function(e,t){function n(){var n;a===null||a===void 0?void 0:(n=a.messageHandler)===null||n===void 0?void 0:n.showMessageDialog();if(e)throw t;return t}var s=function(){var e;if(l.internalModelContext&&l.internalModelContext.getProperty("412Executed")&&(e=l.internalModelContext.getProperty("strictHandlingFails"))!==null&&e!==void 0&&e.length){var t=A(function(){var e=l.internalModelContext.getProperty("strictHandlingFails");var t=[];e.forEach(function(e){t.push(e.oAction.getContext())});l.aContexts=t;return Promise.resolve(K(r,l,a.parentControl,a.messageHandler)).then(function(e){f.getMessageManager().addMessages(l.internalModelContext.getProperty("DelayMessages"));l.internalModelContext.setProperty("strictHandlingFails",[]);l.internalModelContext.setProperty("processedMessageIds",[]);F(a,l,b);o(e)})},function(e){i(e)});if(t&&t.then)return t.then(function(){})}}();return s&&s.then?s.then(n):n(s)});if(p&&p.then)return p.then(function(){})}}())}catch(e){return Promise.reject(e)}})}function _(e,t,r,a,o,i,l,s,c,f){return new Promise(function(r,o){var i=e?e:null;i=i.indexOf(".")>=0?i.split(".")[i.split(".").length-1]:i;var l=i&&c?"".concat(c,"|").concat(i):"";var d=s.getController().oResourceBundle;var g=n.getTranslatedText("C_OPERATIONS_ACTION_CONFIRM_MESSAGE",d,null,l);u.confirm(g,{onClose:function(e){try{var n=function(){if(e===T.OK){var n=A(function(){return Promise.resolve(K(t,a,s,f)).then(function(e){r(e)})},function(e){var t=A(function(){return Promise.resolve(f.showMessageDialog()).then(function(){o(e)})},function(){o(e)});return t&&t.then?t.then(function(){}):void 0});if(n&&n.then)return n.then(function(){})}else{r()}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}})})}function F(e,n,r){if(n.internalModelContext&&n.operationAvailableMap&&n.aContexts&&n.aContexts.length&&r.$IsBound){var a=n.isStatic;if(!a){t.setActionEnablement(n.internalModelContext,JSON.parse(n.operationAvailableMap),e.selectedItems,"table")}else if(n.control){var o=n.control;if(o.isA("sap.ui.mdc.Table")){var i=o.getSelectedContexts();t.setActionEnablement(n.internalModelContext,JSON.parse(n.operationAvailableMap),i,"table")}}}}function R(e,t,n,r,o){var i=o.showMessageBox,l=o.showMessageDialog;var s=e.control;var c=r.filter(function(e){return e.getTarget()===""});var u=r.filter(function(t){return t.getTarget&&t.getTarget().indexOf(e.actionName)!==-1&&e.aActionParameters.some(function(e){return t.getTarget().indexOf(e.$Name)!==-1})});u.forEach(function(e){e.isAPDTarget=true});var f=u.length?true:false;if(n.isOpen()&&t.length!==0&&!e.isStatic){if(!e.bGrouped){if(t.length>1||!f){n.close();e===null||e===void 0?void 0:e.onAfterAPDClose()}}else if(!f){n.close();e===null||e===void 0?void 0:e.onAfterAPDClose()}}var d=[];var g=n.isOpen();if(r.length===1&&r[0].getTarget&&r[0].getTarget()!==undefined&&r[0].getTarget()!==""){if(s&&s.getModel("ui").getProperty("/isEditable")===false||!s){i=!f;l=false}else if(s&&s.getModel("ui").getProperty("/isEditable")===true){i=false;l=false}}else if(s){if(s.getModel("ui").getProperty("/isEditable")===false){if(g&&f){l=false}}else if(s.getModel("ui").getProperty("/isEditable")===true){if(!g&&f){l=true;d=c.concat(u)}else if(!g&&c.length===0){l=false}}}return{showMessageBox:i,showMessageDialog:l,filteredMessages:d.length?d:r,fnGetMessageSubtitle:s&&s.isA("sap.ui.mdc.Table")&&a.setMessageSubtitle.bind({},s,t)}}function H(t,a,i,l,g,P,M,y,b,S){var T=U(M,t),$=M.getModel().oModel.getMetaModel(),N=$.createBindingContext(T),j=M.getObject("$IsBound")?M.getPath().split("/@$ui5.overload/0")[0]:M.getPath().split("/0")[0],D=$.createBindingContext(j),w=l.isCreateAction,_="sap/fe/core/controls/ActionParameterDialog";return new Promise(function(T,$){try{var j;var F=f.getMessageManager();var H=function(e){F.addMessages(e.map(function(e){var t=e.actionParameterInfo.field.getBinding(e.actionParameterInfo.isMultiValue?"items":"value");return new v({message:e.message,type:"Error",processor:t===null||t===void 0?void 0:t.getModel(),persistent:true,target:t===null||t===void 0?void 0:t.getResolvedPath()})}))};var V=function(e){var t=F.getMessageModel().getData();var n=x(["APD_",e.$Name]);var r=t.filter(function(e){return e.getControlIds().some(function(e){return n.split("-").includes(e)})});F.removeMessages(r)};var G=function(e){try{return Promise.resolve(Promise.allSettled(j.map(function(e){return e.validationPromise}))).then(function(){var t=j.filter(function(e){return e.field.getRequired()});var r=t.filter(function(e){if(e.isMultiValue){return e.value===undefined||!e.value.length}else{var t=e.field.getValue();return t===undefined||t===null||t===""}});H(r.map(function(t){var r;return{actionParameterInfo:t,message:n.getTranslatedText("C_OPERATIONS_ACTION_PARAMETER_DIALOG_MISSING_MANDATORY_MSG",e,[((r=t.field.getParent())===null||r===void 0?void 0:r.getAggregation("label")).getText()])}}));var a=j.find(function(e){return e.field.getValueState()==="Error"||r.includes(e)});if(a){a.field.focus();return false}else{return true}})}catch(e){return Promise.reject(e)}};var L={handleChange:function(e){try{var t=e.getSource();var n=j.find(function(e){return e.field===t});V(n.parameter);n.validationPromise=e.getParameter("promise");var r=A(function(){return Promise.resolve(n.validationPromise).then(function(e){n.value=e})},function(e){delete n.value;H([{actionParameterInfo:n,message:e.message}])});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}};var q=p.loadTemplate(_,"fragment");var K=new h({$displayMode:{}});var U=A(function(){return Promise.resolve(m.process(q,{name:_},{bindingContexts:{action:M,actionName:D,entitySet:N},models:{action:M.getModel(),actionName:D.getModel(),entitySet:N.getModel(),metaModel:N.getModel()}})).then(function(v){var m=l.aContexts||[];var p=[];var N;return Promise.resolve(n.setUserDefaults(a,g,K,true)).then(function(){return Promise.resolve(d.load({definition:v,controller:L})).then(function(d){var v=d;j=g.map(function(e){var t=f.byId(x(["APD_",e.$Name]));var n=t.isA("sap.ui.mdc.MultiValueField");return{parameter:e,field:t,isMultiValue:n}});var D=y.getController().oResourceBundle;var _={dialogCancelled:true,result:undefined};var F=function(){g.forEach(V);L.destroy();H=false;if(_.dialogCancelled){$(I.CancelActionDialog)}else{T(_.result)}};var H=false;var L=new c(undefined,{title:i||n.getTranslatedText("C_OPERATIONS_ACTION_PARAMETER_DIALOG_TITLE",D),content:[v],escapeHandler:function(){L.close()},beginButton:new s(x(["fe","APD_",t,"Action","Ok"]),{text:w?n.getTranslatedText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE_BUTTON",D):k(D,i,t,b),type:"Emphasized",press:function(){try{var e=false;return Promise.resolve(E(function(){var t=false;if(H===true){return}H=true;return Promise.resolve(G(D)).then(function(t){if(!t){H=false;e=true;return}r.lock(L);return A(function(){S.removeTransitionMessages();var e;var t=N&&N.getParameterContext();for(var n in g){if(g[n].$isCollection){var o=L.getModel("mvfview").getProperty("/".concat(g[n].$Name)),s=[];for(var c in o){s.push(o[c].Key)}e=s}else{e=t.getProperty(g[n].$Name)}g[n].value=e;e=undefined}l.label=i;l.onAfterAPDClose=F;return E(function(){return A(function(){var e;l===null||l===void 0?void 0:(e=l.internalModelContext)===null||e===void 0?void 0:e.setProperty("412Executed",false);return Promise.resolve(O(a,l,y,S,m,L,false)).then(function(e){_={dialogCancelled:false,result:e};L.close()})},function(e){var t;var n=sap.ui.getCore().getMessageManager().getMessageModel().getData();if(l.internalModelContext&&l.internalModelContext.getProperty("412Executed")&&(t=l.internalModelContext.getProperty("strictHandlingFails"))!==null&&t!==void 0&&t.length){l.internalModelContext.setProperty("DelayMessages",l.internalModelContext.getProperty("DelayMessages").concat(n))}throw e})},function(e,t){function n(){if(r.isLocked(L)){r.unlock(L)}if(e)throw t;return t}var o=function(){var e;if(l.internalModelContext&&l.internalModelContext.getProperty("412Executed")&&(e=l.internalModelContext.getProperty("strictHandlingFails"))!==null&&e!==void 0&&e.length){var t=A(function(){var e=l.internalModelContext.getProperty("strictHandlingFails");var t=[];e.forEach(function(e){t.push(e.oAction.getContext())});l.aContexts=t;return Promise.resolve(O(a,l,y,S,m,L,true)).then(function(e){l.internalModelContext.setProperty("strictHandlingFails",[]);l.internalModelContext.setProperty("processedMessageIds",[]);_={dialogCancelled:false,result:e}})},function(){var e;if(l.internalModelContext&&l.internalModelContext.getProperty("412Executed")&&(e=l.internalModelContext.getProperty("strictHandlingFails"))!==null&&e!==void 0&&e.length){f.getMessageManager().addMessages(l.internalModelContext.getProperty("DelayMessages"))}return Promise.resolve(S.showMessageDialog({isActionParameterDialogOpen:L.isOpen(),onBeforeShowMessage:function(e,t){return R(l,m,L,e,t)}})).then(function(){})});if(t&&t.then)return t.then(function(){})}}();return o&&o.then?o.then(n):n(o)})},function(e){var t=true;return Promise.resolve(S.showMessages({context:l.aContexts&&l.aContexts[0],isActionParameterDialogOpen:L.isOpen(),messagePageNavigationCallback:function(){L.close()},onBeforeShowMessage:function(e,n){var r=R(l,m,L,e,n);t=r.showMessageDialog;return r}})).then(function(){H=false;if(t){$(e)}})})})},function(e,t){if(r.isLocked(L)){r.unlock(L)}if(e)throw t;return t}))}catch(e){return Promise.reject(e)}}}),endButton:new s(x(["fe","APD_",t,"Action","Cancel"]),{text:n.getTranslatedText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL",D),press:function(){L.close()}}),beforeOpen:function(t){try{var r=Object.assign({},t);S.removeTransitionMessages();var a=function(){var e=L.getModel().getMetaModel(),t=M.sPath&&M.sPath.split("/@")[0],n=e.getObject("".concat(t,"@com.sap.vocabularies.Common.v1.DefaultValuesFunction"));return n};var i=function(t){try{var i=a();var s=function(r,a){try{if(a!==undefined){if(m.length>0&&a.$Path){return Promise.resolve(A(function(){return Promise.resolve(n.requestSingletonProperty(a.$Path,N.getModel())).then(function(e){function n(){if(m.length>1){var n=a.$Path;if(n.indexOf("".concat(t,"/"))===0){n=n.replace("".concat(t,"/"),"")}for(var o=1;o<m.length;o++){if(m[o].getProperty(n)!==e){return{paramName:r,value:undefined,bNoPossibleValue:true}}}}return{paramName:r,value:e}}var o=function(){if(e===null){return Promise.resolve(N.getParameterContext().requestProperty(a.$Path)).then(function(t){e=t})}}();return o&&o.then?o.then(n):n(o)})},function(){e.error("Error while reading default action parameter",r,l.actionName);return{paramName:r,value:undefined,bLatePropertyError:true}}))}else{return Promise.resolve({paramName:r,value:a})}}else if(K&&K.oData[r]){return Promise.resolve({paramName:r,value:K.oData[r]})}else{return Promise.resolve({paramName:r,value:undefined})}}catch(e){return Promise.reject(e)}};var c=function(e){var t=L.getModel().getMetaModel(),r=n.getParameterPath(M.getPath(),e)+"@",a=t.getObject(r),o=a&&a["@com.sap.vocabularies.UI.v1.ParameterDefaultValue"];return o};var f=[];var d,v;for(var h in g){d=g[h].$Name;v=c(d);f.push(s(d,v))}if(M.getObject("$IsBound")&&m.length>0){if(i&&i.length>0&&typeof i==="string"){for(var x in m){p.push(B(i,m[x],l.model))}}}var C=Promise.all(f);var y=Promise.resolve([]);var b;if(p&&p.length>0){y=Promise.all(p)}if(l.defaultValuesExtensionFunction){var E=l.defaultValuesExtensionFunction.substring(0,l.defaultValuesExtensionFunction.lastIndexOf(".")||-1).replace(/\./gi,"/"),O=l.defaultValuesExtensionFunction.substring(l.defaultValuesExtensionFunction.lastIndexOf(".")+1,l.defaultValuesExtensionFunction.length);b=o.actionWrapper(r,E,O,{contexts:m})}var I=A(function(){return Promise.resolve(Promise.all([C,y,b])).then(function(e){var t=e[0];var r=e[1];var a=e[2];var o;var l=function(e){var n;o=g[e].$Name;var l=P===null||P===void 0?void 0:(n=P.find(function(t){return t.name===g[e].$Name}))===null||n===void 0?void 0:n.value;if(l){N.setParameter(g[e].$Name,l)}else if(a&&a.hasOwnProperty(o)){N.setParameter(g[e].$Name,a[o])}else if(t[e]&&t[e].value!==undefined){N.setParameter(g[e].$Name,t[e].value)}else if(i&&!t[e].bNoPossibleValue){if(m.length>1){var s=0;while(s<m.length-1){if(r[s]&&r[s+1]&&r[s].getObject(o)===r[s+1].getObject(o)){s++}else{break}}if(s===m.length-1){N.setParameter(g[e].$Name,r[s].getObject(o))}}else if(r[0]&&r[0].getObject(o)){N.setParameter(g[e].$Name,r[0].getObject(o))}}};for(var s in g){l(s)}var c=t.some(function(e){if(e.bLatePropertyError){return e.bLatePropertyError}});if(c){var f=n.getTranslatedText("C_APP_COMPONENT_SAPFE_ETAG_LATE_PROPERTY",D);u.warning(f,{contentWidth:"25em"})}})},function(t){e.error("Error while retrieving the parameter",t)});return Promise.resolve(I&&I.then?I.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};var s=function(){try{var t=function(){if(M.getObject("$IsBound")&&m.length>0){var t=M.getObject("$Parameter");var n=t[0]&&t[0].$Name;var r=A(function(){return Promise.resolve(m[0].requestObject()).then(function(e){if(e){N.setParameter(n,e)}return Promise.resolve(i(n)).then(function(){})})},function(t){e.error("Error while retrieving the parameter",t)});if(r&&r.then)return r.then(function(){})}else{return Promise.resolve(i()).then(function(){})}}();return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};return Promise.resolve(s()).then(function(){var e=C(j),t;try{for(e.s();!(t=e.n()).done;){var n=t.value;var r=n.isMultiValue?n.field.getItems():n.field.getValue();n.value=r;n.validationPromise=Promise.resolve(r)}}catch(t){e.e(t)}finally{e.f()}})}catch(e){return Promise.reject(e)}},afterClose:F});l.oDialog=L;L.setModel(M.getModel().oModel);L.setModel(K,"paramsModel");L.bindElement({path:"/",model:"paramsModel"});var q=new h({});L.setModel(q,"mvfview");var U=C(j),J;try{var W=function(){var e=J.value;if(e.isMultiValue){var t,n;e===null||e===void 0?void 0:(t=e.field)===null||t===void 0?void 0:(n=t.getBinding("items"))===null||n===void 0?void 0:n.attachChange(function(){V(e.parameter)})}else{var r,a;e===null||e===void 0?void 0:(r=e.field)===null||r===void 0?void 0:(a=r.getBinding("value"))===null||a===void 0?void 0:a.attachChange(function(){V(e.parameter)})}};for(U.s();!(J=U.n()).done;){W()}}catch(e){U.e(e)}finally{U.f()}var X="".concat(t,"(...)");if(!m.length){X="/".concat(X)}L.bindElement({path:X});if(y){y.addDependent(L)}if(m.length>0){L.setBindingContext(m[0])}N=L.getObjectBinding();L.open()})})})},function(e){$(e)});return Promise.resolve(U&&U.then?U.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})}function V(e){var t=e.getObject("$Parameter")||[];if(t&&t.length){if(e.getObject("$IsBound")){return t.slice(1,t.length)||[]}}return t}function G(e,t,n,r){var a=e.getObject("".concat(t,"@com.sap.vocabularies.Common.v1.IsActionCritical"));var o=a&&a.$Path;if(!o){return!!a}var i=r&&r.getObject("$Parameter"),l=o&&o.split("/"),s=i&&i.length&&typeof i==="object"&&o&&n&&n.length;if(s){i.filter(function(e){var t=l&&l.indexOf(e.$Name);if(t>-1){l.splice(t,1)}});o=l.join("/");return n[0].getObject(o)}else if(o){return n[0].getObject(o)}}function k(e,t,r,a){var o=r?r:null;var i=o.split(".");o=o.indexOf(".")>=0?i[i.length-1]:o;var l=o&&a?"".concat(a,"|").concat(o):"";var s="ACTION_PARAMETER_DIALOG_ACTION_NAME";var c=e&&n.checkIfResourceKeyExists(e.aCustomBundles,"".concat(s,"|").concat(l));if(t){if(c){return n.getTranslatedText(s,e,null,l)}else if(e&&n.checkIfResourceKeyExists(e.aCustomBundles,"".concat(s,"|").concat(a))){return n.getTranslatedText(s,e,null,"".concat(a))}else if(e&&n.checkIfResourceKeyExists(e.aCustomBundles,"".concat(s))){return n.getTranslatedText(s,e)}else{return t}}else{return n.getTranslatedText("C_COMMON_DIALOG_OK",e)}}function L(e,t,n,r,a,o,i){var l;if(e.aContexts.length>1){var s;var c=sap.ui.getCore().getMessageManager().getMessageModel().getData();var u=e.internalModelContext.getProperty("processedMessageIds");var f=c.filter(function(t){var n=u.find(function(e){return t.getId()===e});if(!n){u.push(t.getId());if(t.getType()===M.Success){e.internalModelContext.setProperty("DelayMessages",e.internalModelContext.getProperty("DelayMessages").concat(t))}}return t.getPersistent()===true&&t.getType()!==M.Success&&!n});e.internalModelContext.setProperty("processedMessageIds",u);if(f.length){if(e.internalModelContext){s=e.internalModelContext.getProperty("strictHandlingFails");s.push({oAction:t,groupId:n});e.internalModelContext.setProperty("strictHandlingFails",s)}}}if(r===a&&e.internalModelContext&&(l=e.internalModelContext.getProperty("412Messages"))!==null&&l!==void 0&&l.length){P.renderMessageView(e,i,o,e.internalModelContext.getProperty("412Messages"),true)}}function q(e,t,n,r,a,o,i,l){var s,c=true;if(n){var u;var f=e.getBoundContext().getPath();var d=e.getModel().getMetaModel().getMetaPath(f);var g=e.getModel().getMetaModel().getObject(d);if(g&&((u=g[0])===null||u===void 0?void 0:u.$kind)!=="Action"){c=false}}if(!c){s=n?e.execute(r).then(function(){return e.getBoundContext()}):e.execute(r)}else{s=n?e.execute(r,undefined,P.fnOnStrictHandlingFailed.bind(X,r,t,a,l,e.getContext(),i,o)).then(function(){L(t,e,r,l,i,o,a);return Promise.resolve(e.getBoundContext())}).catch(function(){L(t,e,r,l,i,o,a);return Promise.reject()}):e.execute(r,undefined,P.fnOnStrictHandlingFailed.bind(X,r,t,a,l,e.getContext(),i,o)).then(function(n){L(t,e,r,l,i,o,a);return Promise.resolve(n)}).catch(function(){L(t,e,r,l,i,o,a);return Promise.reject()})}return s.catch(function(){throw I.ActionExecutionFailed})}function K(e,t,n,r){var a=t.aContexts||[];var o=t.model;var i=t.aActionParameters||[];var l=t.actionName;var s=t.fnOnSubmitted;var c=t.fnOnResponse;var u=n&&n.isA("sap.ui.core.mvc.View")&&n.getController().oResourceBundle;var f;function d(){if(i&&i.length){for(var e=0;e<i.length;e++){if(!i[e].value){switch(i[e].$Type){case"Edm.String":i[e].value="";break;case"Edm.Boolean":i[e].value=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":i[e].value=0;break;default:break}}f.setParameter(i[e].$Name,i[e].value)}}}if(a.length){return new Promise(function(n){var i=function(e){try{function n(e,n,r){f=o.bindContext("".concat(l,"(...)"),e,c);return x(f,n,{context:e,pathExpressions:t.additionalSideEffect&&t.additionalSideEffect.pathExpressions,triggerActions:t.additionalSideEffect&&t.additionalSideEffect.triggerActions},r)}(s||function e(){})(m);return Promise.resolve(e.reduce(function(e,t,r){try{return Promise.resolve(e).then(function(){return Promise.resolve(n(t,r+1,a.length)).then(function(){})})}catch(e){return Promise.reject(e)}},Promise.resolve())).then(function(){C()})}catch(r){return Promise.reject(r)}};var c=t.mBindingParameters;var g=t.bGrouped;var v=t.bGetBoundContext;if(t.internalModelContext&&!t.internalModelContext.getProperty("412Executed")){t.internalModelContext.setProperty("strictHandlingPromises",[]);t.internalModelContext.setProperty("strictHandlingFails",[]);t.internalModelContext.setProperty("412Messages",[]);t.internalModelContext.setProperty("processedMessageIds",[]);t.internalModelContext.setProperty("DelayMessages",[])}var m=[];var p;var h;var P;var M=function(n,a,o,i){d();P=!g?"$auto.".concat(a):n.getUpdateGroupId();t.requestSideEffects=W.bind(X,e,o,t);p=q(n,t,v,P,u,r,i,a);m.push(p);W(e,o,t,P)};var x=function(n,a,i,l){var s=[];d();P="apiMode".concat(a);t.requestSideEffects=W.bind(X,e,i,t,P,s);p=q(n,t,v,P,u,r,l,a);m.push(p);s.push(p);W(e,i,t,P,s);o.submitBatch(P);return Promise.allSettled(s)};if(!g){i(a)}else{for(h=0;h<a.length;h++){f=o.bindContext("".concat(l,"(...)"),a[h],c);M(f,a.length<=1?null:h,{context:a[h],pathExpressions:t.additionalSideEffect&&t.additionalSideEffect.pathExpressions,triggerActions:t.additionalSideEffect&&t.additionalSideEffect.triggerActions},a.length)}(s||function e(){})(m);C()}function C(){return Promise.allSettled(m).then(n)}}).finally(function(){(c||function e(){})()})}else{f=o.bindContext("/".concat(l,"(...)"));d();var g="actionImport";var v=f.execute(g,undefined,P.fnOnStrictHandlingFailed.bind(X,g,{label:t.label,model:o},u,null,null,null,r));o.submitBatch(g);(s||function e(){})(v);return v.finally(function(){(c||function e(){})()})}}function U(e,t){var n=e.getPath();n=e.getObject("$IsBound")?n.split("@$ui5.overload")[0]:n.split("/0")[0];return n.split("/".concat(t))[0]}function J(e,t,n,r){if(n){var a=C(t),o;try{var i=function(){var e=o.value;if(e.$Name!=="ResultIsActiveEntity"&&!(n!==null&&n!==void 0&&n.find(function(t){return t.name===e.$Name}))){return{v:false}}};for(a.s();!(o=a.n()).done;){var l=i();if(typeof l==="object")return l.v}}catch(e){a.e(e)}finally{a.f()}}else if(e&&r){var s=C(t),c;try{for(s.s();!(c=s.n()).done;){var u=c.value;if(!r[u.$Name]){return false}}}catch(e){s.e(e)}finally{s.f()}}return true}function W(n,r,a,o,i){var l=n.getSideEffectsService();var s;if(r&&r.triggerActions&&r.triggerActions.length){r.triggerActions.forEach(function(e){if(e){s=l.executeAction(e,r.context,o);if(i){i.push(s)}}})}if(r&&r.pathExpressions&&r.pathExpressions.length>0){s=l.requestSideEffects(r.pathExpressions,r.context,o);if(i){i.push(s)}s.then(function(){if(a.operationAvailableMap&&a.internalModelContext){t.setActionEnablement(a.internalModelContext,JSON.parse(a.operationAvailableMap),a.selectedItems,"table")}}).catch(function(t){e.error("Error while requesting side effects",t)})}}var X={callBoundAction:$,callActionImport:N,callBoundFunction:B,callFunctionImport:j,executeDependingOnSelectedContexts:q,valuesProvidedForAllParameters:J,getActionParameterActionName:k,actionParameterShowMessageCallback:R,afterActionResolution:F};return X},false);
//# sourceMappingURL=operations.js.map
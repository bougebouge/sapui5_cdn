/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/navigation/library","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/p13n/StateUtil"],function(e,t,r,n,o,i,a,p,l,s,c){"use strict";var f,u,d,y,v,g,h,S,b,m,P,w,O,A,C,I,j,R,B,E,_,x,D,K,V,H,N,k,M,F,T,$,z,U,L,q,G,Q,J,W,X,Y,Z,ee,te,re,ne,oe,ie;var ae=n.publicExtension;var pe=n.privateExtension;var le=n.finalExtension;var se=n.extensible;var ce=n.defineUI5Class;function fe(e,t){try{var r=e()}catch(e){return t(true,e)}if(r&&r.then){return r.then(t.bind(null,false),t.bind(null,true))}return t(false,r)}function ue(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;de(e,t)}function de(e,t){de=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return de(e,t)}function ye(e,t,r,n,o){var i={};Object.keys(n).forEach(function(e){i[e]=n[e]});i.enumerable=!!i.enumerable;i.configurable=!!i.configurable;if("value"in i||i.initializer){i.writable=true}i=r.slice().reverse().reduce(function(r,n){return n(e,t,r)||r},i);if(o&&i.initializer!==void 0){i.value=i.initializer?i.initializer.call(o):void 0;i.initializer=undefined}if(i.initializer===void 0){Object.defineProperty(e,t,i);i=null}return i}function ve(e){return be(e)||Se(e)||he(e)||ge()}function ge(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function he(e,t){if(!e)return;if(typeof e==="string")return me(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return me(e,t)}function Se(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function be(e){if(Array.isArray(e))return me(e)}function me(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++){n[r]=e[r]}return n}function Pe(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}var we="#additionalStates",Oe=a.NavType;var Ae={"sap.ui.fl.variants.VariantManagement":{retrieve:function(e){return{variantId:e.getCurrentVariantKey()}},apply:function(e,t){if(t&&t.variantId!==undefined&&t.variantId!==e.getCurrentVariantKey()){var r=this._checkIfVariantIdIsAvailable(e,t.variantId)?t.variantId:e.getStandardVariantKey();return s.activateVariant({element:e,variantReference:r})}}},"sap.m.IconTabBar":{retrieve:function(e){return{selectedKey:e.getSelectedKey()}},apply:function(e,t){if(t&&t.selectedKey){var r=e.getItems().find(function(e){return e.getKey()===t.selectedKey});if(r){e.setSelectedItem(r)}}}},"sap.ui.mdc.FilterBar":{retrieve:function(e){return c.retrieveExternalState(e).then(function(t){var r=e.getPropertyInfoSet(),n=t.filter||{};r.filter(function(e){return n[e.path]&&(e.removeFromAppState||n[e.path].length===0)}).forEach(function(e){delete n[e.path]});return t})},apply:function(t,r){try{return Promise.resolve(function(){if(r){var n=t.getPropertyInfoSet();return Pe(function(){return Promise.resolve(c.retrieveExternalState(t)).then(function(e){Object.keys(e.filter).forEach(function(t){for(var o=0;o<n.length;o++){var i=n[o];if(t!=="$editState"&&t!=="$search"&&i["key"]===t&&i["maxConditions"]<=1){e.filter[t].forEach(function(e){e.filtered=false});if(r.filter[t]){r.filter[t]=[].concat(ve(r.filter[t]),ve(e.filter[t]))}else{r.filter[t]=e.filter[t]||[]}}}});return c.applyExternalState(t,r)})},function(t){e.error("Filterbar apply failed because of StateUtil.retrieveExternalState: "+t)})}}())}catch(e){return Promise.reject(e)}}},"sap.ui.mdc.Table":{retrieve:function(e){return c.retrieveExternalState(e)},apply:function(e,t){if(t){if(!t.supplementaryConfig){t.supplementaryConfig={}}return c.applyExternalState(e,t)}},refreshBinding:function(t){var r=t.getRowBinding();if(r){var n=r.getRootBinding();if(n===r){r.refresh()}else{var o=r.getHeaderContext();var i=r.getGroupId();if(o){o.requestSideEffects([{$NavigationPropertyPath:""}],i)}}}else{e.info("Table: ".concat(t.getId()," was not refreshed. No binding found!"))}}},"sap.ui.mdc.Chart":{retrieve:function(e){return c.retrieveExternalState(e)},apply:function(e,t){if(t){return c.applyExternalState(e,t)}}},"sap.uxap.ObjectPageLayout":{retrieve:function(e){return{selectedSection:e.getSelectedSection()}},apply:function(e,t){if(t){e.setSelectedSection(t.selectedSection)}},refreshBinding:function(t){var n=t.getBindingContext();var a=n&&n.getBinding();if(a){var p=i.getMetaPathForContext(n);var l=o.getControlRefreshStrategyForContextPath(t,p);if(l==="self"){var s=n.getModel(),c=s.getMetaModel(),f=r.getContextPathProperties(c,p,{$kind:"NavigationProperty"})||{},u=Object.keys(f).reduce(function(e,t){if(f[t].$isCollection!==true){e.push({$NavigationPropertyPath:t})}return e},[]),d=[{$PropertyPath:"*"}],y=a.getGroupId();n.requestSideEffects(d.concat(u),y)}else if(l==="includingDependents"){a.refresh()}}else{e.info("ObjectPage: ".concat(t.getId()," was not refreshed. No binding found!"))}}},"sap.fe.macros.table.QuickFilterContainer":{retrieve:function(e){return{selectedKey:e.getSelectorKey()}},apply:function(e,t){if(t){e.setSelectorKey(t.selectedKey)}}},"sap.m.SegmentedButton":{retrieve:function(e){return{selectedKey:e.getSelectedKey()}},apply:function(e,t){if(t){e.setSelectedKey(t.selectedKey)}}},"sap.m.Select":{retrieve:function(e){return{selectedKey:e.getSelectedKey()}},apply:function(e,t){if(t){e.setSelectedKey(t.selectedKey)}}},"sap.f.DynamicPage":{retrieve:function(e){return{headerExpanded:e.getHeaderExpanded()}},apply:function(e,t){if(t){e.setHeaderExpanded(t.headerExpanded)}}},"sap.ui.core.mvc.View":{retrieve:function(e){var t=e.getController();if(t&&t.viewState){return t.viewState.retrieveViewState(t.viewState)}return{}},apply:function(e,t,r){var n=e.getController();if(n&&n.viewState){return n.viewState.applyViewState(t,r)}},refreshBinding:function(e){var t=e.getController();if(t&&t.viewState){return t.viewState.refreshViewBindings()}}},"sap.ui.core.ComponentContainer":{retrieve:function(e){var t=e.getComponentInstance();if(t){return this.retrieveControlState(t.getRootControl())}return{}},apply:function(e,t,r){var n=e.getComponentInstance();if(n){return this.applyControlState(n.getRootControl(),t,r)}}}};var Ce=(f=ce("sap.fe.core.controllerextensions.ViewState"),u=ae(),d=le(),y=ae(),v=se(l.After),g=pe(),h=le(),S=pe(),b=le(),m=ae(),P=se(l.After),w=ae(),O=se(l.After),A=ae(),C=se(l.After),I=pe(),j=le(),R=ae(),B=se(l.After),E=pe(),_=le(),x=ae(),D=se(l.After),K=ae(),V=le(),H=ae(),N=le(),k=ae(),M=se(l.After),F=pe(),T=le(),$=ae(),z=se(l.Instead),U=ae(),L=le(),q=pe(),G=ae(),Q=se(l.After),J=ae(),W=se(l.After),X=ae(),Y=se(l.After),Z=pe(),ee=ae(),te=se(l.After),re=pe(),ne=le(),f(oe=(ie=function(r){ue(n,r);function n(){var e;e=r.call(this)||this;e._iRetrievingStateCounter=0;e._pInitialStateApplied=new Promise(function(t){e._pInitialStateAppliedResolve=t});return e}var o=n.prototype;o.refreshViewBindings=function e(){try{var t=this;return Promise.resolve(t.collectResults(t.base.viewState.adaptBindingRefreshControls)).then(function(e){var r=Promise.resolve();e.filter(function(e){return e&&e.isA&&e.isA("sap.ui.base.ManagedObject")}).forEach(function(e){r=r.then(t.refreshControlBinding.bind(t,e))});return r})}catch(e){return Promise.reject(e)}};o.adaptBindingRefreshControls=function e(t){};o.refreshControlBinding=function t(r){var n=this.getControlRefreshBindingHandler(r);var o=Promise.resolve();if(typeof n.refreshBinding!=="function"){e.info("refreshBinding handler for control: ".concat(r.getMetadata().getName()," is not provided"))}else{o=o.then(n.refreshBinding.bind(this,r))}return o};o.getControlRefreshBindingHandler=function e(t){var r={};if(t){for(var n in Ae){if(t.isA(n)){r["refreshBinding"]=Ae[n].refreshBinding||{};break}}}this.base.viewState.adaptBindingRefreshHandler(t,r);return r};o.adaptBindingRefreshHandler=function e(t,r){};o.onSuspend=function e(){};o.onRestore=function e(){};o.destroy=function e(){delete this._pInitialStateAppliedResolve;r.prototype.destroy.call(this)};o.collectResults=function e(t){var r=[];for(var n=arguments.length,o=new Array(n>1?n-1:0),i=1;i<n;i++){o[i-1]=arguments[i]}o.push(r);t.apply(this,o);return Promise.all(r)};o.adaptControlStateHandler=function e(t,r){};o.getControlStateHandler=function e(t){var r=[],n=[];if(t){for(var o in Ae){if(t.isA(o)){r.push(Object.assign({},Ae[o]));break}}}this.base.viewState.adaptControlStateHandler(t,n);return r.concat(n)};o.adaptStateControls=function e(t){};o.getStateKey=function e(t){return this.getView().getLocalId(t.getId())||t.getId()};o.retrieveViewState=function e(){try{var r=this;function i(){return r._iRetrievingStateCounter===0?n:undefined}++r._iRetrievingStateCounter;var n;var o=fe(function(){return Promise.resolve(r._pInitialStateApplied).then(function(){return Promise.resolve(r.collectResults(r.base.viewState.adaptStateControls)).then(function(e){return Promise.resolve(Promise.all(e.filter(function(e){return e&&e.isA&&e.isA("sap.ui.base.ManagedObject")}).map(function(e){return r.retrieveControlState(e).then(function(t){return{key:r.getStateKey(e),value:t}})}))).then(function(e){n=e.reduce(function(e,r){var n={};n[r.key]=r.value;return t(e,n)},{});return Promise.resolve(Promise.resolve(r._retrieveAdditionalStates())).then(function(e){if(e&&Object.keys(e).length){n[we]=e}})})})})},function(e,t){--r._iRetrievingStateCounter;if(e)throw t;return t});return Promise.resolve(o&&o.then?o.then(i):i(o))}catch(a){return Promise.reject(a)}};o.retrieveAdditionalStates=function e(t){};o._retrieveAdditionalStates=function e(){var t={};this.base.viewState.retrieveAdditionalStates(t);return t};o.retrieveControlState=function e(r){var n=this;var o=this.getControlStateHandler(r);return Promise.all(o.map(function(e){if(typeof e.retrieve!=="function"){throw new Error("controlStateHandler.retrieve is not a function for control: ".concat(r.getMetadata().getName()))}return e.retrieve.call(n,r)})).then(function(e){return e.reduce(function(e,r){return t(e,r)},{})})};o.applyInitialStateOnly=function e(){return true};o.applyViewState=function t(r,n){try{var o=this;if(o.base.viewState.applyInitialStateOnly()&&o._getInitialStateApplied()){return Promise.resolve()}var i=fe(function(){return Promise.resolve(o.collectResults(o.base.viewState.onBeforeStateApplied)).then(function(){return Promise.resolve(o.collectResults(o.base.viewState.adaptStateControls)).then(function(e){var t=Promise.resolve();e.filter(function(e){return e&&e.isA&&e.isA("sap.ui.base.ManagedObject")}).forEach(function(e){var i=o.getStateKey(e);t=t.then(o.applyControlState.bind(o,e,r?r[i]:undefined,n))});return Promise.resolve(t).then(function(){var e=function(){if(n.navigationType===Oe.iAppState){return Promise.resolve(o.collectResults(o.base.viewState.applyAdditionalStates,r?r[we]:undefined)).then(function(){})}else{return Promise.resolve(o.collectResults(o.base.viewState.applyNavigationParameters,n)).then(function(){return Promise.resolve(o.collectResults(o.base.viewState._applyNavigationParametersToFilterbar,n)).then(function(){})})}}();if(e&&e.then)return e.then(function(){})})})})},function(t,r){function n(){if(t)throw r;return r}var i=Pe(function(){return Promise.resolve(o.collectResults(o.base.viewState.onAfterStateApplied)).then(function(){o._setInitialStateApplied()})},function(t){e.error(t)});return i&&i.then?i.then(n):n(i)});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};o._checkIfVariantIdIsAvailable=function e(t,r){var n=t.getVariants();var o=false;n.forEach(function(e){if(e.key===r){o=true}});return o};o._setInitialStateApplied=function e(){if(this._pInitialStateAppliedResolve){var t=this._pInitialStateAppliedResolve;delete this._pInitialStateAppliedResolve;t()}};o._getInitialStateApplied=function e(){return!this._pInitialStateAppliedResolve};o.onBeforeStateApplied=function e(t){};o.onAfterStateApplied=function e(t){};o.applyAdditionalStates=function e(t,r){};o._applyNavigationParametersToFilterbar=function e(t,r){};o.applyNavigationParameters=function e(t,r){};o.applyControlState=function e(t,r,n){var o=this;var i=this.getControlStateHandler(t);var a=Promise.resolve();i.forEach(function(e){if(typeof e.apply!=="function"){throw new Error("controlStateHandler.apply is not a function for control: ".concat(t.getMetadata().getName()))}a=a.then(e.apply.bind(o,t,r,n))});return a};o.getInterface=function e(){return this};return n}(p),ye(ie.prototype,"refreshViewBindings",[u,d],Object.getOwnPropertyDescriptor(ie.prototype,"refreshViewBindings"),ie.prototype),ye(ie.prototype,"adaptBindingRefreshControls",[y,v],Object.getOwnPropertyDescriptor(ie.prototype,"adaptBindingRefreshControls"),ie.prototype),ye(ie.prototype,"refreshControlBinding",[g,h],Object.getOwnPropertyDescriptor(ie.prototype,"refreshControlBinding"),ie.prototype),ye(ie.prototype,"getControlRefreshBindingHandler",[S,b],Object.getOwnPropertyDescriptor(ie.prototype,"getControlRefreshBindingHandler"),ie.prototype),ye(ie.prototype,"adaptBindingRefreshHandler",[m,P],Object.getOwnPropertyDescriptor(ie.prototype,"adaptBindingRefreshHandler"),ie.prototype),ye(ie.prototype,"onSuspend",[w,O],Object.getOwnPropertyDescriptor(ie.prototype,"onSuspend"),ie.prototype),ye(ie.prototype,"onRestore",[A,C],Object.getOwnPropertyDescriptor(ie.prototype,"onRestore"),ie.prototype),ye(ie.prototype,"collectResults",[I,j],Object.getOwnPropertyDescriptor(ie.prototype,"collectResults"),ie.prototype),ye(ie.prototype,"adaptControlStateHandler",[R,B],Object.getOwnPropertyDescriptor(ie.prototype,"adaptControlStateHandler"),ie.prototype),ye(ie.prototype,"getControlStateHandler",[E,_],Object.getOwnPropertyDescriptor(ie.prototype,"getControlStateHandler"),ie.prototype),ye(ie.prototype,"adaptStateControls",[x,D],Object.getOwnPropertyDescriptor(ie.prototype,"adaptStateControls"),ie.prototype),ye(ie.prototype,"getStateKey",[K,V],Object.getOwnPropertyDescriptor(ie.prototype,"getStateKey"),ie.prototype),ye(ie.prototype,"retrieveViewState",[H,N],Object.getOwnPropertyDescriptor(ie.prototype,"retrieveViewState"),ie.prototype),ye(ie.prototype,"retrieveAdditionalStates",[k,M],Object.getOwnPropertyDescriptor(ie.prototype,"retrieveAdditionalStates"),ie.prototype),ye(ie.prototype,"retrieveControlState",[F,T],Object.getOwnPropertyDescriptor(ie.prototype,"retrieveControlState"),ie.prototype),ye(ie.prototype,"applyInitialStateOnly",[$,z],Object.getOwnPropertyDescriptor(ie.prototype,"applyInitialStateOnly"),ie.prototype),ye(ie.prototype,"applyViewState",[U,L],Object.getOwnPropertyDescriptor(ie.prototype,"applyViewState"),ie.prototype),ye(ie.prototype,"_checkIfVariantIdIsAvailable",[q],Object.getOwnPropertyDescriptor(ie.prototype,"_checkIfVariantIdIsAvailable"),ie.prototype),ye(ie.prototype,"onBeforeStateApplied",[G,Q],Object.getOwnPropertyDescriptor(ie.prototype,"onBeforeStateApplied"),ie.prototype),ye(ie.prototype,"onAfterStateApplied",[J,W],Object.getOwnPropertyDescriptor(ie.prototype,"onAfterStateApplied"),ie.prototype),ye(ie.prototype,"applyAdditionalStates",[X,Y],Object.getOwnPropertyDescriptor(ie.prototype,"applyAdditionalStates"),ie.prototype),ye(ie.prototype,"_applyNavigationParametersToFilterbar",[Z],Object.getOwnPropertyDescriptor(ie.prototype,"_applyNavigationParametersToFilterbar"),ie.prototype),ye(ie.prototype,"applyNavigationParameters",[ee,te],Object.getOwnPropertyDescriptor(ie.prototype,"applyNavigationParameters"),ie.prototype),ye(ie.prototype,"applyControlState",[re,ne],Object.getOwnPropertyDescriptor(ie.prototype,"applyControlState"),ie.prototype),ie))||oe);return Ce},false);
//# sourceMappingURL=ViewState.js.map
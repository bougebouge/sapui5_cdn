/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/collaboration/ActivitySync","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/EditState","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/fe/core/library","sap/fe/templates/Feedback","sap/fe/core/converters/MetaModelConverter","sap/ui/core/Core","sap/ui/core/library","sap/ui/core/message/Message","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/ui/model/odata/v4/ODataListBinding","../ActionRuntime"],function(e,t,r,n,o,i,a,s,c,l,u,g,f,d,v,h,p,m,y,P){"use strict";var b,_,C,w,M,D,S,x,E,A,k,O,F,B,R,I,V,j,T,H,N,L,$,K,q,U,G,z,W,J,Q,X,Y,Z,ee,te;var re=f.getInvolvedDataModelObjects;var ne=g.TriggerType;var oe=g.triggerConfiguredSurvey;var ie=g.StandardActions;var ae=a.publicExtension;var se=a.finalExtension;var ce=a.extensible;var le=a.defineUI5Class;var ue=o.shareObject;var ge=o.Activity;var fe=n.send;function de(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}function ve(e,t){try{var r=e()}catch(e){return t(true,e)}if(r&&r.then){return r.then(t.bind(null,false),t.bind(null,true))}return t(false,r)}function he(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;pe(e,t)}function pe(e,t){pe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,r){t.__proto__=r;return t};return pe(e,t)}function me(e,t,r,n,o){var i={};Object.keys(n).forEach(function(e){i[e]=n[e]});i.enumerable=!!i.enumerable;i.configurable=!!i.configurable;if("value"in i||i.initializer){i.writable=true}i=r.slice().reverse().reduce(function(r,n){return n(e,t,r)||r},i);if(o&&i.initializer!==void 0){i.value=i.initializer?i.initializer.call(o):void 0;i.initializer=undefined}if(i.initializer===void 0){Object.defineProperty(e,t,i);i=null}return i}var ye=u.CreationMode,Pe=u.ProgrammingModel,be=u.Constants,_e=u.DraftStatus,Ce=u.EditMode,we=u.StartupMode,Me=v.MessageType;var De=(b=le("sap.fe.core.controllerextensions.EditFlow"),_=ae(),C=se(),w=ae(),M=se(),D=ae(),S=se(),x=ae(),E=se(),A=ae(),k=ce(m.After),O=ae(),F=ce(m.After),B=ae(),R=ce(m.After),I=ae(),V=ce(m.After),j=ae(),T=ce(m.After),H=ae(),N=se(),L=ae(),$=se(),K=ae(),q=se(),U=ae(),G=se(),z=ae(),W=se(),J=ae(),Q=se(),X=ae(),Y=se(),Z=ae(),b(ee=(te=function(n){he(o,n);function o(){return n.apply(this,arguments)||this}var a=o.prototype;a.editDocument=function t(r){try{var n=this;var o=true;var i=n._getTransactionHelper();var a=n._getRootViewController();var s=r.getModel();var l;var u=de(function(){return Promise.resolve(n.base.editFlow.onBeforeEdit({context:r})).then(function(){return Promise.resolve(i.editDocument(r,n.getView(),n._getMessageHandler())).then(function(e){var t=n._getProgrammingModel(r);n._setStickySessionInternalProperties(t,s);var i=function(){if(e){n._setEditMode(Ce.Editable,false);n._getMessageHandler().showMessageDialog();var i=function(){if(e!==r){function g(){return Promise.resolve(n._handleNewContext(i,true,false,o,true)).then(function(){var r=function(){if(t===Pe.Sticky){n._handleStickyOn(e)}else{var r=function(){if(c.isCollaborationDraftSupported(s.getMetaModel())){return Promise.resolve(ue(e)).then(function(){})}}();if(r&&r.then)return r.then(function(){})}}();if(r&&r.then)return r.then(function(){})})}var i=e;var u=function(){if(n._isFclEnabled()){l=a.getRightmostContext();return Promise.resolve(n._computeSiblingInformation(r,l,t,true)).then(function(t){var o;t=(o=t)!==null&&o!==void 0?o:n._createSiblingInfo(r,e);n._updatePathsInHistory(t.pathMapping);if(t.targetContext.getPath()!=e.getPath()){i=t.targetContext}})}}();return u&&u.then?u.then(g):g(u)}}();if(i&&i.then)return i.then(function(){})}}();if(i&&i.then)return i.then(function(){})})})},function(t){e.error("Error while editing the document",t)});return Promise.resolve(u&&u.then?u.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};a.deleteMultipleDocuments=function e(t,r){if(r){r.beforeDeleteCallBack=this.base.editFlow.onBeforeDelete}else{r={beforeDeleteCallBack:this.base.editFlow.onBeforeDelete}}return this.base.getView().getController()._editFlow.deleteMultipleDocuments(t,r)};a.updateDocument=function t(r,n){var o=this;var i=this._getTransactionHelper();var a=this.getView().getBindingContext();var c=this._getProgrammingModel(r)===Pe.Draft;this._getMessageHandler().removeTransitionMessages();return this._syncTask(function(){try{if(a){i.handleDocumentModifications();if(!o._isFclEnabled()){s.setEditStateDirty()}if(c){o._setDraftStatus(_e.Saving)}}var t=ve(function(){return de(function(){return Promise.resolve(n).then(function(){var e=o.getView().getBindingContext();var t=function(){if(c&&e&&e===a){var t=e.getModel().getMetaModel(),r=t.getMetaContext(e.getPath()).getObject("@sapui.name"),n=l.getSemanticKeys(t,r);var i=function(){if(n&&n.length){var t=o._getSemanticMapping(),r=t&&t.semanticPath,i=l.getSemanticPath(e,true);var a=function(){if(r&&r!==i){return Promise.resolve(o._handleNewContext(e,true,false,true)).then(function(){o._setDraftStatus(_e.Saved)})}else{o._setDraftStatus(_e.Saved)}}();if(a&&a.then)return a.then(function(){})}else{o._setDraftStatus(_e.Saved)}}();if(i&&i.then)return i.then(function(){})}}();if(t&&t.then)return t.then(function(){})})},function(t){e.error("Error while updating the document",t);if(c&&a){o._setDraftStatus(_e.Clear)}})},function(e,t){return Promise.resolve(o._getMessageHandler().showMessages()).then(function(){if(e)throw t;return t})});return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})};a.createDocument=function n(o,i){try{var a=false;var l=this;function C(n){if(a)return n;if(v.creationMode===ye.CreationRow&&v.creationRow){var i=v.creationRow.getBindingContext().getObject();delete i["@$ui5.context.isTransient"];f=v.creationRow.getParent();P=u.validateDocument(f.getBindingContext(),{data:i,customValidationFunction:f.getCreationRow().data("customValidationFunction")},l.base.getView());if(f.getCreationRow().data("disableAddRowButtonForEmptyData")==="true"){var _=f.getBindingContext("internal");_.setProperty("creationRowFieldValidity",{})}}if(v.creationMode===ye.Inline&&v.tableId){f=l.getView().byId(v.tableId)}if(f&&f.isA("sap.ui.mdc.Table")){var C=v.creationMode===ye.Inline?f.focusRow.bind(f):f.scrollToIndex.bind(f);f.getRowBinding().attachEventOnce("change",function(){C(v.createAtEnd?f.getRowBinding().getLength():0,true)})}var w=function(r,n){try{var o=de(function(){return Promise.resolve(n).then(function(e){return Promise.resolve(e.created()).then(function(){var e=l.getView().getBindingContext();if(!t.hasTransientContext(r)){var n=t.getAppComponent(l.getView());n.getSideEffectsService().requestSideEffectsForNavigationProperty(r.getPath(),e)}})})},function(t){e.error("Error while creating the document",t)});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};var M=function(e){var t;var r=f&&f.getCreationRow().data("customValidationFunction");var n=f&&((t=f.getBindingContext("internal"))===null||t===void 0?void 0:t.getProperty("creationRowCustomValidity"));var o=d.getMessageManager();var i=[];var a;var s;o.getMessageModel().getData().forEach(function(e){if(e.code===r){o.removeMessages(e)}});e.forEach(function(e){if(e.messageTarget){var t;a=d.getControl(n[e.messageTarget].fieldId);s="".concat((t=a.getBindingContext())===null||t===void 0?void 0:t.getPath(),"/").concat(a.getBindingPath("value"));if(o.getMessageModel().getData().filter(function(e){return e.target===s}).length===0){o.addMessages(new h({message:e.messageText,processor:l.getView().getModel(),type:Me.Error,code:r,technical:false,persistent:false,target:s}))}var c=o.getMessageModel().getData().filter(function(e){return e.target===s});c[0].addControlId(n[e.messageTarget].fieldId)}else{i.push({code:r,text:e.messageText,persistent:true,type:Me.Error})}});if(i.length>0){l._getMessageHandler().showMessageDialog({customMessages:i})}};var D=function(e,r,n,o){if(e&&e!==ye.NewPage){return e}else{if(!n.isRelative()){var i=n.getPath(),a=r===Pe.Draft?o.getObject("".concat(i,"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction")):o.getObject("".concat(i,"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction"));if(a){var s=o.getObject("/".concat(a,"/@$ui5.overload/0/$Parameter"))||[];if(s.length>1){return ye.Deferred}}}var c=o.getMetaPath(n.getHeaderContext().getPath());var u=t.getNonComputedVisibleFields(o,c,l.getView());if(u.length>0){return ye.Deferred}return ye.Async}};if(m){r.lock(g)}return ve(function(){return Promise.resolve(l._syncTask(P)).then(function(t){function n(){var t;switch(h){case ye.Deferred:t=A.navigateForwardToContext(i,{bDeferredContext:true,editable:true,bForceFocus:true});break;case ye.Async:t=A.navigateForwardToContext(i,{asyncContext:m,editable:true,bForceFocus:true});break;case ye.Sync:P={editable:true,bForceFocus:true};if(g==Pe.Sticky||v.createAction){P.transient=true}t=m.then(function(e){if(!e){var t=d.getLibraryResourceBundle("sap.fe.core");return A.navigateToMessagePage(t.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:t.getText("C_COMMON_SAPFE_ERROR"),description:t.getText("C_EDITFLOW_SAPFE_CREATION_FAILED_DESCRIPTION")})}else{return v.bFromDeferred?A.navigateToContext(e,P):A.navigateForwardToContext(e,P)}});break;case ye.Inline:w(i,m);l._syncTask(m);break;case ye.CreationRow:try{var n=C.getBinding();if(!v.bSkipSideEffects){w(i,m)}var o=n.create();_.setBindingContext(o);o.created().catch(function(){e.trace("transient fast creation context deleted")});t=C.delete("$direct")}catch(t){if(r.isLocked(l.getView().getModel("ui"))){r.unlock(l.getView().getModel("ui"))}e.error("CreationRow navigation error: ",t)}break;default:t=Promise.reject("Unhandled creationMode ".concat(h));break}var u=v.creationMode!==ye.CreationRow&&v.creationMode!==ye.Inline;return function(){if(m){return de(function(){return Promise.resolve(Promise.all([m,t])).then(function(e){l._setStickySessionInternalProperties(g,a);if(u){l._setEditMode(Ce.Editable,u)}else{l._setEditMode(Ce.Editable)}var t=e[0];var r=function(){if(t){if(!l._isFclEnabled()){s.setEditStateDirty()}l._sendActivity(ge.Create,t);var e=function(){if(g===Pe.Sticky){l._handleStickyOn(t)}else{var e=function(){if(c.isCollaborationDraftSupported(a.getMetaModel())){return Promise.resolve(ue(t)).then(function(){})}}();if(e&&e.then)return e.then(function(){})}}();if(e&&e.then)return e.then(function(){})}}();if(r&&r.then)return r.then(function(){})})},function(e){if(e===be.CancelActionDialog||e===be.ActionExecutionFailed||e===be.CreationFailed){if(h===ye.Sync||h===ye.Deferred||h===ye.Async){A.navigateBackFromTransientState()}}throw e})}}()}if(t.length>0){M(t);e.error("Custom Validation failed");return}var i;v=v||{};if(o&&typeof o==="object"){i=o}else if(typeof o==="string"){i=new y(l.getView().getModel(),o);v.creationMode=ye.Sync;delete v.createAtEnd}else{throw new Error("Binding object or path expected")}var a=i.getModel();var g=l._getProgrammingModel(i);var h=D(v.creationMode,g,i,a.getMetaModel());var m;var P;var _=v.creationRow;var C;var S;var x;var E=a.getMetaModel();var A=l._getRoutingListener();var k=function(){if(h!==ye.Deferred){function t(){if(h===ye.CreationRow||h===ye.Inline){var e,t,r;v.keepTransientContextOnFailed=false;v.busyMode="Local";v.busyId=(e=f)===null||e===void 0?void 0:(t=e.getParent())===null||t===void 0?void 0:(r=t.getTableDefinition())===null||r===void 0?void 0:r.annotation.id;l._handleCreateEvents(i)}if(!v.parentControl){v.parentControl=l.getView()}v.beforeCreateCallBack=l.base.editFlow.onBeforeCreate;v.skipParameterDialog=b.getStartupMode()===we.AutoCreate;m=u.createDocument(i,v,p,l._getMessageHandler(),false,l.getView())}var e=function(){if(h===ye.CreationRow){C=_.getBindingContext();x=E.getMetaPath(C.getPath());S=C.getObject();v.data={};Object.keys(S).forEach(function(e){var t=E.getObject("".concat(x,"/").concat(e));if(t&&t.$kind==="NavigationProperty"){return}v.data[e]=S[e]});return Promise.resolve(l._checkForValidationErrors()).then(function(){})}}();return e&&e.then?e.then(t):t(e)}}();return k&&k.then?k.then(n):n(k)})},function(e,t){if(m){r.unlock(g)}if(e)throw t;return t})}var u=l._getTransactionHelper(),g=l._getGlobalUIModel();var f;var v=i;var p=l._getResourceBundle();var m=!v||v.creationMode!==ye.Inline&&v.creationMode!==ye.CreationRow&&v.creationMode!==ye.External;var P=Promise.resolve([]);var b=t.getAppComponent(l.getView());b.getRouterProxy().removeIAppStateKey();var _=function(){if(v.creationMode===ye.External){return Promise.resolve(l._syncTask()).then(function(){var e=l.getView().getController();var t=c.getAbsoluteMetaPathForListBinding(l.getView(),o);e.handlers.onChevronPressNavigateOutBound(e,v.outbound,undefined,t);a=true})}}();return Promise.resolve(_&&_.then?_.then(C):C(_))}catch(w){return Promise.reject(w)}};a.onBeforeSave=function e(t){return Promise.resolve()};a.onBeforeCreate=function e(t){return Promise.resolve()};a.onBeforeEdit=function e(t){return Promise.resolve()};a.onBeforeDiscard=function e(t){return Promise.resolve()};a.onBeforeDelete=function e(t){return Promise.resolve()};a.saveDocument=function t(r,n){try{var o=this;n=n||{};var i=n.bExecuteSideEffectsOnError||undefined;var a=true;var s=o._getTransactionHelper();var c=o._getResourceBundle();var l=n.bindings;return Promise.resolve(de(function(){return Promise.resolve(o._syncTask()).then(function(){return Promise.resolve(o._submitOpenChanges(r)).then(function(){return Promise.resolve(o._checkForValidationErrors()).then(function(){return Promise.resolve(o.base.editFlow.onBeforeSave({context:r})).then(function(){function e(){return Promise.resolve(s.saveDocument(r,c,i,l,o._getMessageHandler())).then(function(e){o._removeStickySessionInternalProperties(t);o._sendActivity(ge.Activate,e);o._triggerConfiguredSurvey(ie.save,ne.standardAction);o._setEditMode(Ce.Display,false);o._getMessageHandler().showMessageDialog();var i=function(){if(e!==r){var t=e;if(n.isFclEnabled()){var i;u=(i=u)!==null&&i!==void 0?i:o._createSiblingInfo(r,e);o._updatePathsInHistory(u.pathMapping);if(u.targetContext.getPath()!==e.getPath()){t=u.targetContext}}return Promise.resolve(o._handleNewContext(t,false,false,a,true)).then(function(){})}}();if(i&&i.then)return i.then(function(){})})}var t=o._getProgrammingModel(r);var n=o._getRootViewController();var u;var g=function(){if((t===Pe.Sticky||r.getProperty("HasActiveEntity"))&&n.isFclEnabled()){return Promise.resolve(o._computeSiblingInformation(r,n.getRightmostContext(),t,true)).then(function(e){u=e})}}();return g&&g.then?g.then(e):e(g)})})})})},function(t){if(!(t&&t.canceled)){e.error("Error while saving the document",t)}return Promise.reject(t)}))}catch(e){return Promise.reject(e)}};a.toggleDraftActive=function e(t){try{var r=this;var n=t.getObject();var o;var i=t&&r._getProgrammingModel(t)===Pe.Draft;if(!i||!(!n.IsActiveEntity&&n.HasActiveEntity||n.IsActiveEntity&&n.HasDraftEntity)){return Promise.resolve()}if(!n.IsActiveEntity&&n.HasActiveEntity){o=false}else{o=true}return Promise.resolve(de(function(){var e=r._getRootViewController();var n=e.isFclEnabled()?e.getRightmostContext():t;return Promise.resolve(r._computeSiblingInformation(t,n,Pe.Draft,false)).then(function(i){function a(){return function(){if(i){r._setEditMode(o?Ce.Editable:Ce.Display,false);if(e.isFclEnabled()){var n=r._getSemanticMapping();if((n===null||n===void 0?void 0:n.technicalPath)===t.getPath()){var a=i.pathMapping[i.pathMapping.length-1].newPath;i.pathMapping.push({oldPath:n.semanticPath,newPath:a})}r._updatePathsInHistory(i.pathMapping)}return Promise.resolve(r._handleNewContext(i.targetContext,o,true,true,true)).then(function(){})}else{return Promise.reject("Error in EditFlow.toggleDraftActive - Cannot find sibling")}}()}var s=function(){if(!i&&t!==n){return Promise.resolve(r._computeSiblingInformation(t,t,Pe.Draft,false)).then(function(e){i=e})}}();return s&&s.then?s.then(a):a(s)})},function(e){return Promise.reject("Error in EditFlow.toggleDraftActive:".concat(e))}))}catch(e){return Promise.reject(e)}};a.cancelDocument=function t(r,n){try{var o=this;var i=o._getTransactionHelper();var a=o._getResourceBundle();var c=n;var l;c.cancelButton=n.control||c.cancelButton;c.beforeCancelCallBack=o.base.editFlow.onBeforeDiscard;return Promise.resolve(de(function(){return Promise.resolve(o._syncTask()).then(function(){function e(){return Promise.resolve(i.cancelDocument(r,c,a,o._getMessageHandler())).then(function(e){var n=true;o._removeStickySessionInternalProperties(t);o._setEditMode(Ce.Display,false);o._setDraftStatus(_e.Clear);s.setEditStateDirty();return function(){if(!e){o._sendActivity(ge.Discard,undefined);var i=function(){if(!c.skipBackNavigation){return Promise.resolve(o._getRoutingListener().navigateBackFromContext(r)).then(function(){})}}();if(i&&i.then)return i.then(function(){})}else{var a=e;o._sendActivity(ge.Discard,a);var s=a;if(o._isFclEnabled()){var u;l=(u=l)!==null&&u!==void 0?u:o._createSiblingInfo(r,a);o._updatePathsInHistory(l.pathMapping);if(l.targetContext.getPath()!==a.getPath()){s=l.targetContext}}return function(){if(t===Pe.Draft){return Promise.resolve(o._fetchSemanticKeyValues(a)).then(function(){return function(){if(!c.skipBindingToView){return Promise.resolve(o._handleNewContext(s,false,true,n,true)).then(function(){})}else{return a}}()})}else{return Promise.resolve(o._handleNewContext(s,false,false,n,true)).then(function(){})}}()}}()})}var t=o._getProgrammingModel(r);var n=function(){if((t===Pe.Sticky||r.getProperty("HasActiveEntity"))&&o._isFclEnabled()){var e=o._getRootViewController();return Promise.resolve(o._computeSiblingInformation(r,e.getRightmostContext(),t,true)).then(function(e){l=e})}}();return n&&n.then?n.then(e):e(n)})},function(t){e.error("Error while discarding the document",t)}))}catch(e){return Promise.reject(e)}};a.isDraftRoot=function e(t){var r=t.getModel().getMetaModel();var n=r.getMetaContext(t.getPath());return c.isDraftRoot(re(n).targetEntitySet)};a.deleteDocument=function r(n,o){try{var i=this;var a=t.getAppComponent(i.getView());var c=o;if(!c){c={bFindActiveContexts:false}}else{c.bFindActiveContexts=false}c.beforeDeleteCallBack=i.base.editFlow.onBeforeDelete;var l=de(function(){if(i._isFclEnabled()&&i.isDraftRoot(n)&&n.getIndex()===undefined&&n.getProperty("IsActiveEntity")===true&&n.getProperty("HasDraftEntity")===true){c.beforeDeleteCallBack=function(t){try{return Promise.resolve(i.base.editFlow.onBeforeDelete(t)).then(function(){var t=de(function(){var e=n.getModel();var t=e.bindContext("".concat(n.getPath(),"/SiblingEntity")).getBoundContext();return Promise.resolve(t.requestCanonicalPath()).then(function(t){var r=e.getKeepAliveContext(t);r===null||r===void 0?void 0:r.replaceWith(n)})},function(t){e.error("Error while replacing the draft instance in the LR ODLB",t)});if(t&&t.then)return t.then(function(){})})}catch(e){return Promise.reject(e)}}}return Promise.resolve(i._deleteDocumentTransaction(n,c)).then(function(){if(!i._isFclEnabled()){s.setEditStateDirty()}i._sendActivity(ge.Delete,n);if(a){a.getShellServices().setBackNavigation()}if((a===null||a===void 0?void 0:a.getStartupMode())===we.Deeplink&&!i._isFclEnabled()){a.getRouterProxy().exitFromApp()}else{i._getRoutingListener().navigateBackFromContext(n)}})},function(t){e.error("Error while deleting the document",t)});return Promise.resolve(l&&l.then?l.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};a.applyDocument=function e(t){try{var n=this;var o=n._getGlobalUIModel();r.lock(o);var i=ve(function(){return Promise.resolve(n._syncTask()).then(function(){return Promise.resolve(n._submitOpenChanges(t)).then(function(){return Promise.resolve(n._checkForValidationErrors()).then(function(){return Promise.resolve(n._getMessageHandler().showMessageDialog()).then(function(){return Promise.resolve(n._getRoutingListener().navigateBackFromContext(t)).then(function(){})})})})})},function(e,t){if(r.isLocked(o)){r.unlock(o)}if(e)throw t;return t});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};a.invokeAction=function t(r,n,o){try{var i=this;var a;var c=i._getTransactionHelper();var l;var u;var g;var f=i.getView();var d=n||{};if(d.isA&&d.isA("sap.ui.model.odata.v4.Context")||Array.isArray(d)||o!==undefined){var v=d;d=o||{};if(v){d.contexts=v}else{d.model=i.getView().getModel()}}d.isNavigable=d.requiresNavigation||d.isNavigable;if(!d.parentControl){d.parentControl=i.getView()}if(d.controlId){a=i.getView().byId(d.controlId);if(a){d.internalModelContext=a.getBindingContext("internal")}}else{d.internalModelContext=f.getBindingContext("internal")}if(r&&r.indexOf("(")>-1){l=r.split("(");r=l[0];u=l[l.length-1].replaceAll(")","")}if(d.bStaticAction){if(a.isTableBound()){d.contexts=a.getRowBinding().getHeaderContext()}else{var h=a.data("rowsBindingInfo").path,p=new y(i.getView().getModel(),h);d.contexts=p.getHeaderContext()}if(u&&a.getBindingContext()){d.contexts=i._getActionOverloadContextFromMetadataPath(a.getBindingContext(),a.getRowBinding(),u)}if(d.enableAutoScroll){g=i._createActionPromise(r,a.sId)}}d.bGetBoundContext=i._getBoundContext(f,d);d.bObjectPage=f.getViewData().converterType==="ObjectPage";return Promise.resolve(de(function(){return Promise.resolve(i._syncTask()).then(function(){return Promise.resolve(c.callAction.bind(c,r,d,i.getView(),i._getMessageHandler())()).then(function(t){function n(){i._sendActivity(ge.Action,d.contexts);i._triggerConfiguredSurvey(r,ne.action);if(g){g.fResolver(t)}if(d.contexts){if(!i._isFclEnabled()){s.setEditStateDirty()}i._getInternalModel().setProperty("/sCustomAction",r)}if(d.isNavigable){var n=t;if(Array.isArray(n)&&n.length===1){n=n[0].value}if(n&&!Array.isArray(n)){var o=f.getModel().getMetaModel();var a=o.getMetaPath(n.getPath());var c=function(e,t){return e.filter(function(e){if(t){return t.indexOf(e)>-1}return true})};var l=Array.isArray(d.contexts)?c(d.contexts,d.applicableContext)[0]:d.contexts;var u=l&&o.getMetaPath(l.getPath());if(a!=undefined&&a===u){if(l.getPath()!==n.getPath()){i._getRoutingListener().navigateForwardToContext(n,{checkNoHashChange:true,noHistoryEntry:false})}else{e.info("Navigation to the same context is not allowed")}}}}return t}var o=function(){if(d.contexts){return Promise.resolve(i._refreshListIfRequired(i._getActionResponseDataAndKeys(r,t),d.contexts[0])).then(function(){})}}();return o&&o.then?o.then(n):n(o)})})},function(e){if(g){g.fRejector()}if(e===be.CancelActionDialog){throw new Error("Dialog cancelled")}else if(!(e&&(e.canceled||e.rejectedItems&&e.rejectedItems[0].canceled))){throw new Error("Error in EditFlow.invokeAction:".concat(e))}}))}catch(e){return Promise.reject(e)}};a.securedExecution=function e(t,n){var o=this;var i=n&&n.busy&&n.busy.set!==undefined?n.busy.set:true,a=n&&n.busy&&n.busy.check!==undefined?n.busy.check:true,c=n&&n.updatesDocument||false,l=this._getGlobalUIModel(),u=this.base.getView().getBindingContext(),g=u&&this._getProgrammingModel(u)===Pe.Draft;if(a&&r.isLocked(l)){return Promise.reject("Application already busy therefore execution rejected")}if(i){r.lock(l)}if(c&&g){this._setDraftStatus(_e.Saving)}this._getMessageHandler().removeTransitionMessages();return this._syncTask(t).then(function(){if(c){o._getTransactionHelper().handleDocumentModifications();if(!o._isFclEnabled()){s.setEditStateDirty()}if(g){o._setDraftStatus(_e.Saved)}}}).catch(function(e){if(c&&g){o._setDraftStatus(_e.Clear)}return Promise.reject(e)}).finally(function(){if(i){r.unlock(l)}o._getMessageHandler().showMessageDialog()})};a.handlePatchSent=function e(t){var r,n,o=this;if(!((r=this.base.getView())!==null&&r!==void 0&&(n=r.getBindingContext("internal"))!==null&&n!==void 0&&n.getProperty("skipPatchHandlers"))){var i=new Promise(function(e,r){t.getSource().attachEventOnce("patchCompleted",function(n){if(t.getSource().isA("sap.ui.model.odata.v4.ODataListBinding")){var i;P.setActionEnablementAfterPatch(o.base.getView(),t.getSource(),(i=o.base.getView())===null||i===void 0?void 0:i.getBindingContext("internal"))}var a=n.getParameter("success");if(a){e()}else{r()}})});this.updateDocument(t.getSource(),i)}};a.handleCreateActivate=function e(t){var r=t.getSource();var n=this._getTransactionHelper();var o=true;var i=true;var a=this._getResourceBundle();var s={creationMode:ye.Inline,createAtEnd:o,inactive:i,keepTransientContextOnFailed:false,busyMode:"None"};n.createDocument(r,s,a,this._getMessageHandler(),false,this.getView())};a._setEditMode=function e(t,r){this.base.getView().getController()._editFlow.setEditMode(t,r)};a._setDraftStatus=function e(t){this.base.getView().getController()._editFlow.setDraftStatus(t)};a._getRoutingListener=function e(){return this.base.getView().getController()._editFlow.getRoutingListener()};a._getGlobalUIModel=function e(){return this.base.getView().getController()._editFlow.getGlobalUIModel()};a._syncTask=function e(t){return this.base.getView().getController()._editFlow.syncTask(t)};a._getProgrammingModel=function e(t){return this.base.getView().getController()._editFlow.getProgrammingModel(t)};a._deleteDocumentTransaction=function e(t,r){return this.base.getView().getController()._editFlow.deleteDocumentTransaction(t,r)};a._handleCreateEvents=function e(t){this.base.getView().getController()._editFlow.handleCreateEvents(t)};a._getTransactionHelper=function e(){return this.base.getView().getController()._editFlow.getTransactionHelper()};a._getInternalModel=function e(){return this.base.getView().getController()._editFlow.getInternalModel()};a._getRootViewController=function e(){return this.base.getAppComponent().getRootViewController()};a._getResourceBundle=function e(){return this.getView().getController().oResourceBundle};a._getSemanticMapping=function e(){return this.base.getAppComponent().getRoutingService().getLastSemanticMapping()};a._createActionPromise=function e(t,r){return this.base.getView().getController()._editFlow.createActionPromise(t,r)};a._getCurrentActionPromise=function e(){return this.base.getView().getController()._editFlow.getCurrentActionPromise()};a._deleteCurrentActionPromise=function e(){return this.base.getView().getController()._editFlow.deleteCurrentActionPromise()};a._getMessageHandler=function e(){return this.base.getView().getController()._editFlow.getMessageHandler()};a._sendActivity=function e(t,r){var n=Array.isArray(r)?r.map(function(e){return e.getPath()}):r===null||r===void 0?void 0:r.getPath();fe(this.getView(),t,n)};a._triggerConfiguredSurvey=function e(t,r){oe(this.getView(),t,r)};a._getActionResponseDataAndKeys=function e(t,r){return this.base.getView().getController()._editFlow.getActionResponseDataAndKeys(t,r)};a._submitOpenChanges=function e(t){try{var n=this;var o=t.getModel(),i=n._getGlobalUIModel();return Promise.resolve(ve(function(){return Promise.resolve(o.submitBatch("$auto")).then(function(){return Promise.resolve(o.oRequestor.waitForRunningChangeRequests("$auto")).then(function(){if(o.hasPendingChanges("$auto")){throw new Error("submit of open changes failed")}})})},function(e,t){if(r.isLocked(i)){r.unlock(i)}if(e)throw t;return t}))}catch(e){return Promise.reject(e)}};a._handleStickyOn=function e(t){return this.base.getView().getController()._editFlow.handleStickyOn(t)};a._handleStickyOff=function e(){return this.base.getView().getController()._editFlow.handleStickyOff()};a._onBackNavigationInSession=function e(){return this.base.getView().getController()._editFlow.onBackNavigationInSession()};a._discardStickySession=function e(t){return this.base.getView().getController()._editFlow.discardStickySession(t)};a._setStickySessionInternalProperties=function e(t,r){if(t===Pe.Sticky){var n=this._getInternalModel();n.setProperty("/sessionOn",true);n.setProperty("/stickySessionToken",r.getHttpHeaders(true)["SAP-ContextId"])}};a._removeStickySessionInternalProperties=function e(t){if(t===Pe.Sticky){var r=this._getInternalModel();r.setProperty("/sessionOn",false);r.setProperty("/stickySessionToken",undefined);this._handleStickyOff()}};a._handleNewContext=function e(t,r,n,o){var i=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;try{var a=this;if(!a._isFclEnabled()){s.setEditStateDirty()}return Promise.resolve(a._getRoutingListener().navigateToContext(t,{checkNoHashChange:true,editable:r,bPersistOPScroll:true,bRecreateContext:n,bDraftNavigation:o,showPlaceholder:false,bForceFocus:i,keepCurrentLayout:true})).then(function(){})}catch(e){return Promise.reject(e)}};a._getBoundContext=function e(t,r){var n=t.getViewData().viewLevel;var o=n>1||n===1&&r.controlId;return!r.isNavigable||!!o};a._checkForValidationErrors=function e(){var t=this;return this._syncTask().then(function(){var e=t.base.getView().getId();var r=sap.ui.getCore().getMessageManager().getMessageModel().getData();var n;var o;if(!r.length){return Promise.resolve("No validation errors found")}for(var i=0;i<r.length;i++){o=r[i];if(o.validation){n=d.byId(o.getControlId());while(n){if(n.getId()===e){return Promise.reject("validation errors exist")}n=n.getParent()}}}})};a._refreshListIfRequired=function r(n,o){var i=this;if(!o||!n||!n.oData){return Promise.resolve()}var a=o.getBinding();if(a&&a.isA("sap.ui.model.odata.v4.ODataListBinding")){var s=n.oData;var c=n.keys;var l=o.getObject();var u=true;if(Object.keys(s).length){u=c.every(function(e){return l[e]===s[e]});if(!u){return new Promise(function(r){if(a.isRoot()){a.attachEventOnce("dataReceived",function(){r()});a.refresh()}else{var n=t.getAppComponent(i.getView());n.getSideEffectsService().requestSideEffects([{$NavigationPropertyPath:a.getPath()}],a.getContext()).then(function(){r()},function(){e.error("Error while refreshing the table");r()}).catch(function(t){e.error("Error while refreshing the table",t)})}})}}}return Promise.resolve()};a._fetchSemanticKeyValues=function e(t){var r=t.getModel().getMetaModel(),n=r.getMetaContext(t.getPath()).getObject("@sapui.name"),o=l.getSemanticKeys(r,n);if(o&&o.length){var i=o.map(function(e){return t.requestObject(e.$PropertyPath)});return Promise.all(i)}else{return Promise.resolve()}};a._getActionOverloadContextFromMetadataPath=function e(t,r,n){var o=t.getModel();var i=o.getMetaModel();var a=r.getPath().split("/");var s=t;a.pop();if(a.length===0){a=[""]}if(a[0]!==""){a.unshift("")}var c=a.map(function(e){if(e!==""){s=o.bindContext(e,s).getBoundContext()}else{s=t}return s}).reverse();var l=c.find(function(e){return i.getMetaContext(e.getPath()).getObject("$Type")===n});return l||r.getHeaderContext()};a._createSiblingInfo=function e(t,r){return{targetContext:r,pathMapping:[{oldPath:t.getPath(),newPath:r.getPath()}]}};a._updatePathsInHistory=function e(t){var r=this.base.getAppComponent();r.getRouterProxy().setPathMapping(t);var n=this._getSemanticMapping();if(t.length&&(n===null||n===void 0?void 0:n.technicalPath)===t[t.length-1].oldPath){n.technicalPath=t[t.length-1].newPath}};a._computeSiblingInformation=function t(r,n,o,a){try{var s;n=(s=n)!==null&&s!==void 0?s:r;if(!n.getPath().startsWith(r.getPath())){e.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}if(a&&n.getPath()===r.getPath()){return Promise.resolve(undefined)}var c=r.getModel();if(o===Pe.Draft){return Promise.resolve(i.computeSiblingInformation(r,n))}else{return Promise.resolve({targetContext:c.bindContext(n.getPath()).getBoundContext(),pathMapping:[]})}}catch(e){return Promise.reject(e)}};a._isFclEnabled=function e(){return t.getAppComponent(this.getView())._isFclEnabled()};return o}(p),me(te.prototype,"editDocument",[_,C],Object.getOwnPropertyDescriptor(te.prototype,"editDocument"),te.prototype),me(te.prototype,"deleteMultipleDocuments",[w,M],Object.getOwnPropertyDescriptor(te.prototype,"deleteMultipleDocuments"),te.prototype),me(te.prototype,"updateDocument",[D,S],Object.getOwnPropertyDescriptor(te.prototype,"updateDocument"),te.prototype),me(te.prototype,"createDocument",[x,E],Object.getOwnPropertyDescriptor(te.prototype,"createDocument"),te.prototype),me(te.prototype,"onBeforeSave",[A,k],Object.getOwnPropertyDescriptor(te.prototype,"onBeforeSave"),te.prototype),me(te.prototype,"onBeforeCreate",[O,F],Object.getOwnPropertyDescriptor(te.prototype,"onBeforeCreate"),te.prototype),me(te.prototype,"onBeforeEdit",[B,R],Object.getOwnPropertyDescriptor(te.prototype,"onBeforeEdit"),te.prototype),me(te.prototype,"onBeforeDiscard",[I,V],Object.getOwnPropertyDescriptor(te.prototype,"onBeforeDiscard"),te.prototype),me(te.prototype,"onBeforeDelete",[j,T],Object.getOwnPropertyDescriptor(te.prototype,"onBeforeDelete"),te.prototype),me(te.prototype,"saveDocument",[H,N],Object.getOwnPropertyDescriptor(te.prototype,"saveDocument"),te.prototype),me(te.prototype,"toggleDraftActive",[L,$],Object.getOwnPropertyDescriptor(te.prototype,"toggleDraftActive"),te.prototype),me(te.prototype,"cancelDocument",[K,q],Object.getOwnPropertyDescriptor(te.prototype,"cancelDocument"),te.prototype),me(te.prototype,"deleteDocument",[U,G],Object.getOwnPropertyDescriptor(te.prototype,"deleteDocument"),te.prototype),me(te.prototype,"applyDocument",[z,W],Object.getOwnPropertyDescriptor(te.prototype,"applyDocument"),te.prototype),me(te.prototype,"invokeAction",[J,Q],Object.getOwnPropertyDescriptor(te.prototype,"invokeAction"),te.prototype),me(te.prototype,"securedExecution",[X,Y],Object.getOwnPropertyDescriptor(te.prototype,"securedExecution"),te.prototype),me(te.prototype,"handlePatchSent",[Z],Object.getOwnPropertyDescriptor(te.prototype,"handlePatchSent"),te.prototype),te))||ee);return De},false);
//# sourceMappingURL=EditFlow.js.map
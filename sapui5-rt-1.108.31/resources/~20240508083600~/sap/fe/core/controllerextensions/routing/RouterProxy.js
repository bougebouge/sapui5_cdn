/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/Synchronization","sap/ui/base/Object","sap/ui/core/Core","sap/ui/thirdparty/URI"],function(e,t,a,s,i,r){"use strict";var n,o;var h=t.defineUI5Class;function u(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;c(e,t)}function c(e,t){c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,a){t.__proto__=a;return t};return c(e,t)}var l={EQUAL:0,COMPATIBLE:1,ANCESTOR:2,DIFFERENT:3};var f={LAYOUTPARAM:"layout",IAPPSTATEPARAM:"sap-iapp-state"};function d(e){return{_guardHash:e.replace(/\?[^\?]*$/,""),check:function(e){return e.indexOf(this._guardHash)===0}}}function g(e){var t=e.match(new RegExp("\\?.*".concat(f.IAPPSTATEPARAM,"=([^&]*)")));return t&&t.length>1?t[1]:null}function p(e){return e.replace(new RegExp("[&?]*".concat(f.IAPPSTATEPARAM,"=[^&]*")),"")}function y(e,t){var a;if(e.indexOf(f.IAPPSTATEPARAM)>=0){a=e.replace(new RegExp("".concat(f.IAPPSTATEPARAM,"=[^&]*")),"".concat(f.IAPPSTATEPARAM,"=").concat(t))}else{if(e.indexOf("?")<0){a="".concat(e,"?")}else{a="".concat(e,"&")}a+="".concat(f.IAPPSTATEPARAM,"=").concat(t)}return a}var _=(n=h("sap.fe.core.RouterProxy"),n(o=function(t){u(s,t);function s(){var e;for(var a=arguments.length,s=new Array(a),i=0;i<a;i++){s[i]=arguments[i]}e=t.call.apply(t,[this].concat(s))||this;e.bIsRebuildHistoryRunning=false;e.bIsComputingTitleHierachy=false;e.bIsGuardCrossAllowed=false;e.sIAppStateKey=null;e._bActivateRouteMatchSynchro=false;e._bApplyRestore=false;e._bDelayedRebuild=false;e._pathMappings=[];return e}var n=s.prototype;n.init=function t(a,s){var i=this;a.getService("shellServices").then(function(){i._oShellServices=a.getShellServices();i.initRaw(a.getRouter());i.waitForRouteMatchBeforeNavigation();history.replaceState(Object.assign({feLevel:0},history.state),"",window.location);i.fclEnabled=s;i._fnBlockingNavFilter=i._blockingNavigationFilter.bind(i);i._oShellServices.registerNavigationFilter(i._fnBlockingNavFilter)}).catch(function(t){e.error("Cannot retrieve the shell services",t)});this._fnHashGuard=this.hashGuard.bind(this);window.addEventListener("popstate",this._fnHashGuard);this._bDisableOnHashChange=false;this._bIgnoreRestore=false;this._bForceFocus=true};n.destroy=function e(){if(this._oShellServices){this._oShellServices.unregisterNavigationFilter(this._fnBlockingNavFilter)}window.removeEventListener("popstate",this._fnHashGuard)};n.initRaw=function e(t){this._oRouter=t;this._oManagedHistory=[];this._oNavigationGuard=null;var a=this.getHash();this._oManagedHistory.push(this._extractStateFromHash(a));this.sIAppStateKey=g(a)};n.getHash=function e(){return this._oRouter.getHashChanger().getHash()};n.isFocusForced=function e(){return this._bForceFocus};n.setFocusForced=function e(t){this._bForceFocus=t};n.removeIAppStateKey=function e(){this.sIAppStateKey=null};n.navToHash=function e(t,a,s,i,r){var n=this;if(r!==false){this._oShellServices.setBackNavigation()}if(this._oRouteMatchSynchronization){return this._oRouteMatchSynchronization.waitFor().then(function(){n._oRouteMatchSynchronization=undefined;return n._internalNavToHash(t,a,s,i)})}else{if(this._bActivateRouteMatchSynchro){this.waitForRouteMatchBeforeNavigation()}return this._internalNavToHash(t,a,s,i)}};n._internalNavToHash=function e(t,a,s,r){if(this.fclEnabled&&this.sIAppStateKey&&!g(t)){t=y(t,this.sIAppStateKey)}if(!this.checkHashWithGuard(t)){if(!this.oResourceBundle){this.oResourceBundle=i.getLibraryResourceBundle("sap.fe.core")}if(!confirm(this.oResourceBundle.getText("C_ROUTER_PROXY_SAPFE_EXIT_NOTSAVED_MESSAGE"))){return Promise.resolve(false)}this.bIsGuardCrossAllowed=true}var n=this._extractStateFromHash(t);if(!this._bForceFocus){var o=this._extractEntitySetsFromHash(this.getHash());this._bForceFocus=r||o.length<n.keys.length&&o.every(function(e,t){return e===n.keys[t]})}var h=this._pushNewState(n,false,a,s);return this._rebuildBrowserHistory(h,false)};n.restoreHistory=function e(){if(this._bApplyRestore){this._bApplyRestore=false;var t=this.getHash();t=t.replace(/(\?|&)restoreHistory=true/,"");var a=this._extractStateFromHash(t);var s=this._pushNewState(a,true,false,true);return this._rebuildBrowserHistory(s,true)}else{return Promise.resolve()}};n.navBack=function e(){var t=this.getHash();var a;for(var s=this._oManagedHistory.length-1;s>0;s--){if(this._oManagedHistory[s].hash===t){a=this._oManagedHistory[s-1].hash;break}}if(a){return this.navToHash(a)}else{window.history.back();return Promise.resolve()}};n.navTo=function e(t,a){var s=this._oRouter.getURL(t,a);return this.navToHash(s,false,a.noPreservationCache,false,!a.bIsStickyMode)};n.exitFromApp=function e(){return this._oShellServices.backToPreviousApp()};n.isCurrentStateImpactedBy=function e(t){if(t[0]==="/"){t=t.substring(1)}var a=d(t);return a.check(this.getHash())};n.isNavigationFinalized=function e(){return!this.bIsRebuildHistoryRunning&&!this._bDelayedRebuild};n.setNavigationGuard=function e(t){this._oNavigationGuard=d(t);this.bIsGuardCrossAllowed=false};n.discardNavigationGuard=function e(){this._oNavigationGuard=null};n.hasNavigationGuard=function e(){return this._oNavigationGuard!==null};n.checkHashWithGuard=function e(t){return this._oNavigationGuard===null||this._oNavigationGuard.check(t)};n.isGuardCrossAllowedByUser=function e(){return this.bIsGuardCrossAllowed};n.activateRouteMatchSynchronization=function e(){this._bActivateRouteMatchSynchro=true};n.resolveRouteMatch=function e(){if(this._oRouteMatchSynchronization){this._oRouteMatchSynchronization.resolve()}};n.waitForRouteMatchBeforeNavigation=function e(){this._oRouteMatchSynchronization=new a;this._bActivateRouteMatchSynchro=false};n._extractEntitySetsFromHash=function e(t){if(t===undefined){t=""}var a=t.split("?")[0];var s=a.split("/");var i=[];s.forEach(function(e){if(e.length){i.push(e.split("(")[0])}});return i};n._extractStateFromHash=function e(t){if(t===undefined){t=""}var a={keys:this._extractEntitySetsFromHash(t)};var s=t.match(new RegExp("\\?.*".concat(f.LAYOUTPARAM,"=([^&]*)")));a.sLayout=s&&s.length>1?s[1]:null;if(a.sLayout==="MidColumnFullScreen"){a.screenMode=1}else if(a.sLayout==="EndColumnFullScreen"){a.screenMode=2}else{a.screenMode=0}a.hash=t;return a};n._pushNewState=function e(t,a,s,i){var r=this.getHash();var n=this._oManagedHistory.length-1;var o=a?1:0;if(!a){while(n>=0&&this._oManagedHistory[n].hash!==r){this._oManagedHistory.pop();n--}if(this._oManagedHistory.length===0){this._oManagedHistory.push(this._extractStateFromHash(r));history.replaceState(Object.assign({feLevel:0},history.state),"")}}if(s&&!i){this._oManagedHistory[this._oManagedHistory.length-1].preserved=true}var h;while(this._oManagedHistory.length>0){var u=this._oManagedHistory[this._oManagedHistory.length-1];if((i||!u.preserved)&&this._compareCacheStates(u,t)!==l.ANCESTOR){h=this._oManagedHistory.pop();o++}else if(u.preserved&&p(u.hash)===p(t.hash)){h=this._oManagedHistory.pop();o++;t.preserved=true;break}else{break}}this.sIAppStateKey=g(t.hash);if(!this.fclEnabled&&h){var c=g(h.hash);var f=this._compareCacheStates(h,t);if(!this.sIAppStateKey&&c&&(f===l.EQUAL||f===l.COMPATIBLE)){t.hash=y(t.hash,c)}}var d=h&&t.hash===h.hash;if(this._oManagedHistory.length===0||this._oManagedHistory[this._oManagedHistory.length-1].hash!==t.hash){this._oManagedHistory.push(t)}if(o===0){return{type:"append"}}else if(o===1){return d?{type:"none"}:{type:"replace"}}else{return d?{type:"back",steps:o-1}:{type:"back-replace",steps:o-1}}};n._blockingNavigationFilter=function e(){return this._bDisableOnHashChange?"Custom":"Continue"};n._disableEventOnHashChange=function e(){this._bDisableOnHashChange=true;this._oRouter.stop()};n._enableEventOnHashChange=function e(t){this._bDisableOnHashChange=false;this._oRouter.initialize(t)};n._rebuildBrowserHistory=function e(t,a){var s=this;var i=this;return new Promise(function(e){s.bIsRebuildHistoryRunning=true;var r=s._oManagedHistory[s._oManagedHistory.length-1],n=s._oManagedHistory.length-1;function o(){if(!a){i._enableEventOnHashChange(true)}i._oRouter.getHashChanger().replaceHash(r.hash);history.replaceState(Object.assign({feLevel:n},history.state),"");if(a){setTimeout(function(){i._enableEventOnHashChange(true)},0)}i.bIsRebuildHistoryRunning=false;e(true)}function h(){window.removeEventListener("popstate",h);setTimeout(function(){o()},0)}function u(){window.removeEventListener("popstate",u);i.bIsRebuildHistoryRunning=false;e(true)}i._bIgnoreRestore=true;switch(t.type){case"replace":i._oRouter.getHashChanger().replaceHash(r.hash);history.replaceState(Object.assign({feLevel:n},history.state),"");i.bIsRebuildHistoryRunning=false;e(true);break;case"append":i._oRouter.getHashChanger().setHash(r.hash);history.replaceState(Object.assign({feLevel:n},history.state),"");i.bIsRebuildHistoryRunning=false;e(true);break;case"back":window.addEventListener("popstate",u);history.go(-t.steps);break;case"back-replace":s._disableEventOnHashChange();window.addEventListener("popstate",h);history.go(-t.steps);break;default:s.bIsRebuildHistoryRunning=false;e(false)}})};n.getLastHistoryEntry=function e(){return this._oManagedHistory[this._oManagedHistory.length-1]};n.setPathMapping=function e(t){this._pathMappings=t.filter(function(e){return e.oldPath!==e.newPath})};n.hashGuard=function e(){var t=this;var a=window.location.hash;if(a.indexOf("restoreHistory=true")!==-1){this._bApplyRestore=true}else if(!this.bIsRebuildHistoryRunning){var s=this._pathMappings.find(function(e){return a.indexOf(e.oldPath)>=0});if(s){a=a.replace(s.oldPath,s.newPath);history.replaceState(Object.assign({},history.state),"",a)}else{var i=a.split("&/");var r=i[1]?i[1]:"";if(this.checkHashWithGuard(r)){this._bDelayedRebuild=true;var n=this._extractStateFromHash(r);this._pushNewState(n,false,false,true);setTimeout(function(){t._bDelayedRebuild=false},0)}}}};n._compareCacheStates=function e(t,a){if(t.keys.length>a.keys.length){return l.DIFFERENT}var s=true;var i;for(i=0;s&&i<t.keys.length;i++){if(t.keys[i]!==a.keys[i]){s=false}}if(!s){return l.DIFFERENT}if(t.keys.length<a.keys.length||t.screenMode<a.screenMode){return l.ANCESTOR}if(t.screenMode>a.screenMode){return l.DIFFERENT}return t.sLayout===a.sLayout?l.EQUAL:l.COMPATIBLE};n.checkIfBackIsOutOfGuard=function e(t){var a;var s;if(t===undefined){var i=this._oShellServices.splitHash(window.location.hash);if(i&&i.appSpecificRoute){s=i.appSpecificRoute;if(s.indexOf("&/")===0){s=s.substring(2)}}else{s=window.location.hash.substring(1);if(s[0]==="/"){s=s.substring(1)}}}else{s=t}t=r.decode(s);if(this._oNavigationGuard){for(var n=this._oManagedHistory.length-1;n>0;n--){if(this._oManagedHistory[n].hash===t){a=this._oManagedHistory[n-1].hash;break}}return!a||!this.checkHashWithGuard(a)}return false};n.checkIfBackHasSameContext=function e(){if(this._oManagedHistory.length<2){return false}var t=this._oManagedHistory[this._oManagedHistory.length-1];var a=this._oManagedHistory[this._oManagedHistory.length-2];return t.hash.split("?")[0]===a.hash.split("?")[0]};return s}(s))||o);return _},false);
//# sourceMappingURL=RouterProxy.js.map
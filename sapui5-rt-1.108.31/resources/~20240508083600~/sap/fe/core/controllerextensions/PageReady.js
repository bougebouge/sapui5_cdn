/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/controllerextensions/pageReady/DataQueryWatcher","sap/fe/core/services/TemplatedViewServiceFactory","sap/ui/base/EventProvider","sap/ui/core/Component","sap/ui/core/Core","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","../CommonUtils","../helpers/ClassSupport"],function(e,t,i,r,o,n,a,s,c,p){"use strict";var h,d,u,g,f,l,y,v,b,P,m,R,_,E,O,C,w,D,T,A,x,W,j;var B=p.publicExtension;var I=p.privateExtension;var F=p.methodOverride;var k=p.finalExtension;var U=p.extensible;var S=p.defineUI5Class;function q(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;V(e,t)}function V(e,t){V=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,i){t.__proto__=i;return t};return V(e,t)}function M(e,t,i,r,o){var n={};Object.keys(r).forEach(function(e){n[e]=r[e]});n.enumerable=!!n.enumerable;n.configurable=!!n.configurable;if("value"in n||n.initializer){n.writable=true}n=i.slice().reverse().reduce(function(i,r){return r(e,t,i)||i},n);if(o&&n.initializer!==void 0){n.value=n.initializer?n.initializer.call(o):void 0;n.initializer=undefined}if(n.initializer===void 0){Object.defineProperty(e,t,n);n=null}return n}var z=(h=S("sap.fe.core.controllerextensions.PageReady"),d=F(),u=F(),g=B(),f=k(),l=F("_routing"),y=F("_routing"),v=F("_routing"),b=B(),P=k(),m=B(),R=k(),_=B(),E=k(),O=B(),C=k(),w=B(),D=k(),T=I(),A=U(s.Instead),x=B(),h(W=(j=function(a){q(s,a);function s(){var e;for(var t=arguments.length,i=new Array(t),r=0;r<t;r++){i[r]=arguments[r]}e=a.call.apply(a,[this].concat(i))||this;e.pageReadyTimeoutDefault=7e3;return e}var p=s.prototype;p.onInit=function e(){var i,n,a=this;this._nbWaits=0;this._oEventProvider=this._oEventProvider?this._oEventProvider:new r;this._oView=this.getView();this._oAppComponent=c.getAppComponent(this._oView);this._oPageComponent=o.getOwnerComponentFor(this._oView);var s=this._oAppComponent.getManifest();this.pageReadyTimeout=(i=(n=s["sap.ui5"])===null||n===void 0?void 0:n.pageReadyTimeout)!==null&&i!==void 0?i:this.pageReadyTimeoutDefault;if(this._oPageComponent&&this._oPageComponent.attachContainerDefined){this._oPageComponent.attachContainerDefined(function(e){return a.registerContainer(e.getParameter("container"))})}else{this.registerContainer(this._oView)}var p=this._oAppComponent.getRootControl().getController();var h=(p===null||p===void 0?void 0:p.getPlaceholder)&&p.getPlaceholder();if(h!==null&&h!==void 0&&h.isPlaceholderDebugEnabled()){this.attachEvent("pageReady",null,function(){h.getPlaceholderDebugStats().iPageReadyEventTimestamp=Date.now()},this);this.attachEvent("heroesBatchReceived",null,function(){h.getPlaceholderDebugStats().iHeroesBatchReceivedEventTimestamp=Date.now()},this)}this.queryWatcher=new t(this._oEventProvider,this.checkPageReadyDebounced.bind(this))};p.onExit=function e(){delete this._oAppComponent;if(this._oContainer){this._oContainer.removeEventDelegate(this._fnContainerDelegate)}};p.waitFor=function e(t){var i=this;this._nbWaits++;t.finally(function(){setTimeout(function(){i._nbWaits--},0)}).catch(null)};p.onRouteMatched=function e(){this._bIsPageReady=false};p.onRouteMatchedFinished=function e(){try{var t=this;return Promise.resolve(t.onAfterBindingPromise).then(function(){t.checkPageReadyDebounced()})}catch(e){return Promise.reject(e)}};p.registerAggregatedControls=function e(t){var i=this;if(t){var r=t.getBinding();this.queryWatcher.registerBinding(r)}var o=[];var n=this.getView().findAggregatedObjects(true);n.forEach(function(e){var t=e.getObjectBinding();if(t){i.queryWatcher.registerBinding(t)}else{var r=Object.keys(e.mBindingInfos);r.forEach(function(t){var r=e.mBindingInfos[t].binding;if(r&&r.isA("sap.ui.model.odata.v4.ODataListBinding")){i.queryWatcher.registerBinding(r)}})}if(e.isA("sap.ui.mdc.Table")||e.isA("sap.ui.mdc.Chart")){i.bTablesChartsLoaded=false;o.push(i.queryWatcher.registerTableOrChart(e))}else if(e.isA("sap.fe.core.controls.FilterBar")){i.queryWatcher.registerFilterBar(e)}});return o};p.onAfterBinding=function t(i){var r=this;var o=this;if(this.pageReadyTimeoutTimer){clearTimeout(this.pageReadyTimeoutTimer)}this.pageReadyTimeoutTimer=setTimeout(function(){e.error("The PageReady Event was not fired within the ".concat(o.pageReadyTimeout," ms timeout . It has been forced."));o._oEventProvider.fireEvent("pageReady")},this.pageReadyTimeout);if(this._bAfterBindingAlreadyApplied){return}this._bAfterBindingAlreadyApplied=true;if(this.isContextExpected()&&i===undefined){this.bHasContext=false;return}else{this.bHasContext=true}this.attachEventOnce("pageReady",null,function(){clearTimeout(o.pageReadyTimeoutTimer);o.pageReadyTimeoutTimer=undefined;o._bAfterBindingAlreadyApplied=false;o.queryWatcher.reset()},null);this.onAfterBindingPromise=new Promise(function(e){try{var t=r.registerAggregatedControls(i);var o=function(){if(t.length>0){return Promise.resolve(Promise.all(t)).then(function(){r.bTablesChartsLoaded=true;r.checkPageReadyDebounced();e()})}else{r.checkPageReadyDebounced();e()}}();return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})};p.isPageReady=function e(){return this._bIsPageReady};p.waitPageReady=function e(){var t=this;return new Promise(function(e){if(t.isPageReady()){e()}else{t.attachEventOnce("pageReady",null,function(){e()},t)}})};p.attachEventOnce=function e(t,i,r,o){return this._oEventProvider.attachEventOnce(t,i,r,o)};p.attachEvent=function e(t,i,r,o){return this._oEventProvider.attachEvent(t,i,r,o)};p.detachEvent=function e(t,i){return this._oEventProvider.detachEvent(t,i)};p.registerContainer=function e(t){var i=this;this._oContainer=t;this._fnContainerDelegate={onBeforeShow:function(){i.bShown=false;i._bIsPageReady=false},onBeforeHide:function(){i.bShown=false;i._bIsPageReady=false},onAfterShow:function(){var e;i.bShown=true;(e=i.onAfterBindingPromise)===null||e===void 0?void 0:e.then(function(){i._checkPageReady(true)})}};this._oContainer.addEventDelegate(this._fnContainerDelegate,this)};p.isContextExpected=function e(){return false};p.checkPageReadyDebounced=function e(){var t=this;if(this.pageReadyTimer){clearTimeout(this.pageReadyTimer)}this.pageReadyTimer=setTimeout(function(){t._checkPageReady()},200)};p._checkPageReady=function e(){var t=this;var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var o=function(){if(!n.getUIDirty()){n.detachEvent("UIUpdated",o);t._bWaitingForRefresh=false;setTimeout(function(){t._checkPageReady()},20)}};var a=function(){if(n.getUIDirty()){setTimeout(a,500)}else if(t._bWaitingForRefresh){t._bWaitingForRefresh=false;n.detachEvent("UIUpdated",o);t._checkPageReady()}};if(this.bShown&&this.queryWatcher.isDataReceived()!==false&&this.bTablesChartsLoaded!==false&&(!this.isContextExpected()||this.bHasContext)){if(this.queryWatcher.isDataReceived()===true&&!r&&!this._bWaitingForRefresh&&n.getUIDirty()){this.queryWatcher.resetDataReceived();this._bWaitingForRefresh=true;n.attachEvent("UIUpdated",o);setTimeout(a,500)}else if(!this._bWaitingForRefresh&&n.getUIDirty()||this._nbWaits!==0||i.getNumberOfViewsInCreationState()>0||this.queryWatcher.isSearchPending()){this._bWaitingForRefresh=true;n.attachEvent("UIUpdated",o);setTimeout(a,500)}else if(!this._bWaitingForRefresh){this._bIsPageReady=true;this._oEventProvider.fireEvent("pageReady")}}};return s}(a),M(j.prototype,"onInit",[d],Object.getOwnPropertyDescriptor(j.prototype,"onInit"),j.prototype),M(j.prototype,"onExit",[u],Object.getOwnPropertyDescriptor(j.prototype,"onExit"),j.prototype),M(j.prototype,"waitFor",[g,f],Object.getOwnPropertyDescriptor(j.prototype,"waitFor"),j.prototype),M(j.prototype,"onRouteMatched",[l],Object.getOwnPropertyDescriptor(j.prototype,"onRouteMatched"),j.prototype),M(j.prototype,"onRouteMatchedFinished",[y],Object.getOwnPropertyDescriptor(j.prototype,"onRouteMatchedFinished"),j.prototype),M(j.prototype,"onAfterBinding",[v],Object.getOwnPropertyDescriptor(j.prototype,"onAfterBinding"),j.prototype),M(j.prototype,"isPageReady",[b,P],Object.getOwnPropertyDescriptor(j.prototype,"isPageReady"),j.prototype),M(j.prototype,"waitPageReady",[m,R],Object.getOwnPropertyDescriptor(j.prototype,"waitPageReady"),j.prototype),M(j.prototype,"attachEventOnce",[_,E],Object.getOwnPropertyDescriptor(j.prototype,"attachEventOnce"),j.prototype),M(j.prototype,"attachEvent",[O,C],Object.getOwnPropertyDescriptor(j.prototype,"attachEvent"),j.prototype),M(j.prototype,"detachEvent",[w,D],Object.getOwnPropertyDescriptor(j.prototype,"detachEvent"),j.prototype),M(j.prototype,"isContextExpected",[T,A],Object.getOwnPropertyDescriptor(j.prototype,"isContextExpected"),j.prototype),M(j.prototype,"checkPageReadyDebounced",[x],Object.getOwnPropertyDescriptor(j.prototype,"checkPageReadyDebounced"),j.prototype),j))||W);return z},false);
//# sourceMappingURL=PageReady.js.map
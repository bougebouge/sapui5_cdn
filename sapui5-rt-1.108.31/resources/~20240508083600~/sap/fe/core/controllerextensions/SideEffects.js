/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/macros/field/FieldRuntime","sap/ui/core/Core","sap/ui/core/mvc/ControllerExtension","../CommonUtils","../helpers/ClassSupport"],function(e,t,i,r,o,n){"use strict";var f,s,a,c,d,u,p,l,v,g,m,E,S,y,h,F,_,P,C,O,x,b,I,j,w,T,D,G;var Q=n.publicExtension;var q=n.privateExtension;var A=n.methodOverride;var M=n.finalExtension;var R=n.defineUI5Class;function B(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;N(e,t)}function N(e,t){N=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,i){t.__proto__=i;return t};return N(e,t)}function z(e,t,i,r,o){var n={};Object.keys(r).forEach(function(e){n[e]=r[e]});n.enumerable=!!n.enumerable;n.configurable=!!n.configurable;if("value"in n||n.initializer){n.writable=true}n=i.slice().reverse().reduce(function(i,r){return r(e,t,i)||i},n);if(o&&n.initializer!==void 0){n.value=n.initializer?n.initializer.call(o):void 0;n.initializer=undefined}if(n.initializer===void 0){Object.defineProperty(e,t,n);n=null}return n}var V=(f=R("sap.fe.core.controllerextensions.SideEffects"),s=A(),a=Q(),c=M(),d=Q(),u=M(),p=Q(),l=M(),v=Q(),g=M(),m=Q(),E=M(),S=Q(),y=M(),h=Q(),F=M(),_=Q(),P=M(),C=Q(),O=M(),x=q(),b=M(),I=Q(),j=M(),w=Q(),T=M(),f(D=(G=function(r){B(n,r);function n(){return r.apply(this,arguments)||this}var f=n.prototype;f.onInit=function e(){this._oView=this.base.getView();this._oAppComponent=o.getAppComponent(this._oView);this._oSideEffectsService=this._oAppComponent.getSideEffectsService();this._mFieldGroupQueue={};this._aSourcePropertiesFailure=new Set;this._mFailedSideEffects={}};f.clearPropertiesStatus=function e(){this._aSourcePropertiesFailure.clear()};f.getRegisteredFailedRequests=function e(){return this._mFailedSideEffects};f.deleteFailedRequestsForAContext=function e(t){delete this._mFailedSideEffects[t]};f.handleFieldChange=function t(i,r){var o=this;var n=this._getFieldProperties(i),f=this._initializeFieldSideEffects(n,r);var s=false;return this._generateImmediatePromise(n).then(function(){s=true;return Promise.all(f.map(function(e){return o.requestSideEffects(e.sideEffects,e.context)})||[])}).catch(function(t){if(s){e.debug("Error while processing Field SideEffects",t)}else{f.filter(function(e){return e.previouslyFailed===true}).forEach(function(e){o._addFailedSideEffects(e.sideEffects,e.context)})}})};f.handleFieldGroupChange=function t(i){var r=this,o=[],n=i.getParameter("fieldGroupIds");var f=function(t){var i=false;var o=t.sideEffectProperty;var n=o.context;var f=n.getPath();var s=r._oSideEffectsService.getEntityTypeFromContext(n);var a=r._getEntityTypeFromFQN(s);return Promise.all(t.promises).then(function(){i=true;if(a&&o.sideEffects.SourceProperties.every(function(e){if(e.type==="PropertyPath"){var t=r._generateStatusIndex(a,e.value,n);if(t){return!r._aSourcePropertiesFailure.has(t)}}return true})){return r.requestSideEffects(o.sideEffects,o.context)}return null}).catch(function(t){if(i){e.debug("Error while processing FieldGroup SideEffects on context ".concat(f),t)}}).finally(function(){delete r._mFieldGroupQueue[o.name][f]})};n.forEach(function(e){var t;var i=e.replace("$$ImmediateRequest","");var n=(t=r._mFieldGroupQueue)===null||t===void 0?void 0:t[i];if(n){Object.keys(n).forEach(function(e){var t=n[e];if(!t.processStarted){t.processStarted=true;o.push(t)}})}});return Promise.all(o.map(function(e){return f(e)}))};f.addControlSideEffects=function e(t,i){this._oSideEffectsService.addControlSideEffects(t,i)};f.removeFailedSideEffects=function e(){this._mFailedSideEffects={}};f.requestSideEffects=function e(t,i,r,o){try{var n=this;function c(){if(s){n._oSideEffectsService.executeAction(s,i,r)}return f.length?n._oSideEffectsService.requestSideEffects(f,i,r).catch(function(e){n._addFailedSideEffects(t,i);return Promise.reject(e)}):Promise.resolve()}var f,s;var a=function(){if(o){return Promise.resolve(o(t)).then(function(e){f=e["aTargets"];s=e["TriggerAction"]})}else{f=(t.TargetEntities||[]).concat(t.TargetProperties||[]);s=t.TriggerAction}}();return Promise.resolve(a&&a.then?a.then(c):c(a))}catch(d){return Promise.reject(d)}};f.removeControlSideEffects=function e(t){var i=t&&t.isA&&t.isA("sap.ui.base.ManagedObject")&&t.getId();if(i){this._oSideEffectsService.removeControlSideEffects(i)}};f._addFailedSideEffects=function e(t,i){var r=i.getPath();this._mFailedSideEffects[r]=this._mFailedSideEffects[r]||[];var o=this._mFailedSideEffects[r].every(function(e){return t.fullyQualifiedName!==e.fullyQualifiedName});if(o){this._mFailedSideEffects[r].push(t)}};f._generateFieldGroupPromise=function e(t){var i=this;var r=true;return t.promise.then(function(){return r}).catch(function(){r=false;return r}).finally(function(){i._saveFieldPropertiesStatus(t.field,r)})};f._generateImmediatePromise=function e(t){var r=t.promise;return r.then(function(){var e=t.field;var r=e.getFieldHelp&&e.getFieldHelp();if(r){var o=i.byId(r);if(o&&o.getOutParameters){return Promise.all(o.getOutParameters().map(function(e){var t=e.getBinding("value");return t?t.requestValue():Promise.resolve()}))}}return Promise.all([])})};f._generateStatusIndex=function e(t,i,r){var o=r===null||r===void 0?void 0:r.getPath();var n=t.resolvePath(i);if(n){if(n&&n._type==="Property"){return[n.fullyQualifiedName,o].join("__")}}return undefined};f.getContextForSideEffects=function e(t,i){var r=t,o=this._oSideEffectsService.getEntityTypeFromContext(t);if(i!==o){r=t.getBinding().getContext();if(r){o=this._oSideEffectsService.getEntityTypeFromContext(r);if(i!==o){r=r.getBinding().getContext();if(r){o=this._oSideEffectsService.getEntityTypeFromContext(r);if(i!==o){return undefined}}}}}return r||undefined};f._getEntityTypeFromFQN=function e(t){return this._oSideEffectsService.getConvertedMetaModel().entityTypes.find(function(e){return e.fullyQualifiedName===t})};f._getFieldPromise=function e(i){var r=i.getParameter("promise")||Promise.resolve();var o=t.getFieldStateOnChange(i).state.validity;return r.then(function(){return new Promise(function(e,t){if(!o){t()}else{e(true)}})})};f._getFieldProperties=function e(t){var i=t.getSource();return{promise:this._getFieldPromise(t),field:i,sideEffectsMap:this._getFieldSideEffectsMap(i)}};f._getFieldSideEffectsMap=function e(t){var i={};var r=t.getFieldGroupIds(),o=this._oView.getViewData().entitySet,n=this._oSideEffectsService.getConvertedMetaModel().entitySets.find(function(e){return e.name===o});i=this.generateSideEffectsMapFromSideEffectId(r,t);if(o&&n){var f=n.entityType.fullyQualifiedName,s=t.getAggregation("customData").find(function(e){return e.getKey()==="sourcePath"}),a=this.getContextForSideEffects(t.getBindingContext(),f);if(s&&a){var c=s.getValue().replace("/".concat(o,"/"),""),d=this._oSideEffectsService.getControlEntitySideEffects(f);Object.keys(d).forEach(function(e){var t=d[e];if(t.SourceProperties.includes(c)){var r="".concat(e,"::").concat(f);i[r]={name:r,immediate:true,sideEffects:t,context:a}}})}}return i};f._getDataToGenerateSideEffectsMapFromSideEffectId=function e(t){var i;var r=t.indexOf("$$ImmediateRequest")!==-1,o=t.replace("$$ImmediateRequest",""),n=o.split("#"),f=n[0],s="".concat(f,"@com.sap.vocabularies.Common.v1.SideEffects").concat(n.length===2?"#".concat(n[1]):""),a=(i=this._oSideEffectsService.getODataEntitySideEffects(f))===null||i===void 0?void 0:i[s];return{sName:o,bIsImmediate:r,oSideEffect:a,sSideEffectEntityType:f}};f.generateSideEffectsMapFromSideEffectId=function e(t,i){var r=this;var o={};t.forEach(function(e){var t=r._getDataToGenerateSideEffectsMapFromSideEffectId(e),n=t.sName,f=t.bIsImmediate,s=t.oSideEffect,a=t.sSideEffectEntityType;var c=i?r.getContextForSideEffects(i.getBindingContext(),a):undefined;if(s&&(!i||i&&c)){o[n]={name:n,immediate:f,sideEffects:s};if(i){o[n].context=c}}});return o};f._initializeFieldSideEffects=function e(t,i){var r=this;var o=t.sideEffectsMap,n=this._generateFieldGroupPromise(t),f={},s=[];i=i||Promise.resolve();Object.keys(o).forEach(function(e){var t;var a=o[e],c=(t=a.context)===null||t===void 0?void 0:t.getPath();if(c){var d=r._mFailedSideEffects[c];if(d){delete r._mFailedSideEffects[c];f[c]={};d.forEach(function(t){f[c][t.fullyQualifiedName]=true;s.push({name:e,previouslyFailed:true,sideEffects:t,context:a.context})})}if(a.immediate){var u;if(!((u=f[c])!==null&&u!==void 0&&u[a.sideEffects.fullyQualifiedName])){s.push({name:e,sideEffects:a.sideEffects,context:a.context})}}else{r._mFieldGroupQueue[e]=r._mFieldGroupQueue[e]||{};var p=r._mFieldGroupQueue[e][c]||{promises:[],sideEffectProperty:a,processStarted:false};p.promises=p.promises.concat([n,i]);r._mFieldGroupQueue[e][c]=p}}});return s};f._saveFieldPropertiesStatus=function e(t,i){var r=this;var o=t.getBindingContext();var n=this._oSideEffectsService.getEntityTypeFromContext(o);var f=this._getEntityTypeFromFQN(n);if(f){var s=this._getBindingForField(t);var a=s.isA("sap.ui.model.CompositeBinding")?(s.getBindings()||[]).map(function(e){return e.sPath}):[s.getPath()];a.forEach(function(e){var t=r._generateStatusIndex(f,e,o);if(t){r._aSourcePropertiesFailure[i?"delete":"add"](t)}})}};f._getBindingForField=function e(t){var i="value";if(t.isA("sap.m.CheckBox")){i="selected"}else if(t.isA("sap.fe.core.controls.FileWrapper")){i="uploadUrl"}return t.getBinding(i)};return n}(r),z(G.prototype,"onInit",[s],Object.getOwnPropertyDescriptor(G.prototype,"onInit"),G.prototype),z(G.prototype,"clearPropertiesStatus",[a,c],Object.getOwnPropertyDescriptor(G.prototype,"clearPropertiesStatus"),G.prototype),z(G.prototype,"getRegisteredFailedRequests",[d,u],Object.getOwnPropertyDescriptor(G.prototype,"getRegisteredFailedRequests"),G.prototype),z(G.prototype,"deleteFailedRequestsForAContext",[p,l],Object.getOwnPropertyDescriptor(G.prototype,"deleteFailedRequestsForAContext"),G.prototype),z(G.prototype,"handleFieldChange",[v,g],Object.getOwnPropertyDescriptor(G.prototype,"handleFieldChange"),G.prototype),z(G.prototype,"handleFieldGroupChange",[m,E],Object.getOwnPropertyDescriptor(G.prototype,"handleFieldGroupChange"),G.prototype),z(G.prototype,"addControlSideEffects",[S,y],Object.getOwnPropertyDescriptor(G.prototype,"addControlSideEffects"),G.prototype),z(G.prototype,"removeFailedSideEffects",[h,F],Object.getOwnPropertyDescriptor(G.prototype,"removeFailedSideEffects"),G.prototype),z(G.prototype,"requestSideEffects",[_,P],Object.getOwnPropertyDescriptor(G.prototype,"requestSideEffects"),G.prototype),z(G.prototype,"removeControlSideEffects",[C,O],Object.getOwnPropertyDescriptor(G.prototype,"removeControlSideEffects"),G.prototype),z(G.prototype,"_addFailedSideEffects",[x,b],Object.getOwnPropertyDescriptor(G.prototype,"_addFailedSideEffects"),G.prototype),z(G.prototype,"getContextForSideEffects",[I,j],Object.getOwnPropertyDescriptor(G.prototype,"getContextForSideEffects"),G.prototype),z(G.prototype,"generateSideEffectsMapFromSideEffectId",[w,T],Object.getOwnPropertyDescriptor(G.prototype,"generateSideEffectsMapFromSideEffectId"),G.prototype),G))||D);return V},false);
//# sourceMappingURL=SideEffects.js.map
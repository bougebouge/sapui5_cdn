/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/m/Bar","sap/m/Button","sap/m/Dialog","sap/m/FormattedText","sap/m/MessageBox","sap/m/MessageItem","sap/m/MessageToast","sap/m/MessageView","sap/m/Text","sap/ui/core/Core","sap/ui/core/format/DateFormat","sap/ui/core/IconPool","sap/ui/core/library","sap/ui/core/message/Message","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel"],function(e,t,r,a,n,s,o,i,c,g,u,l,p,f,_,E,d){"use strict";var m=p.MessageType;var S=[];var h=[];var M=[];var A;var v;var T;function y(){var e;function t(e){return e.property?"( ${"+e.property+'} ? ("<p>'+e.property.substr(Math.max(e.property.lastIndexOf("/"),e.property.lastIndexOf("."))+1)+' : " + '+"${"+e.property+'} + "</p>") : "" )':""}function r(t){var r="";if(t.groupName&&t.property&&t.groupName!==e){r+="( ${"+t.property+'} ? "<br><h3>'+t.groupName+'</h3>" : "" ) + ';e=t.groupName}return r}function a(){var e="technicalDetails";return[{groupName:"",property:"".concat(e,"/status")},{groupName:"",property:"".concat(e,"/statusText")},{groupName:"Application",property:"".concat(e,"/error/@SAP__common.Application/ComponentId")},{groupName:"Application",property:"".concat(e,"/error/@SAP__common.Application/ServiceId")},{groupName:"Application",property:"".concat(e,"/error/@SAP__common.Application/ServiceRepository")},{groupName:"Application",property:"".concat(e,"/error/@SAP__common.Application/ServiceVersion")},{groupName:"ErrorResolution",property:"".concat(e,"/error/@SAP__common.ErrorResolution/Analysis")},{groupName:"ErrorResolution",property:"".concat(e,"/error/@SAP__common.ErrorResolution/Note")},{groupName:"ErrorResolution",property:"".concat(e,"/error/@SAP__common.ErrorResolution/DetailedNote")},{groupName:"ErrorResolution",property:"".concat(e,"/error/@SAP__common.ExceptionCategory")},{groupName:"ErrorResolution",property:"".concat(e,"/error/@SAP__common.TimeStamp")},{groupName:"ErrorResolution",property:"".concat(e,"/error/@SAP__common.TransactionId")},{groupName:"Messages",property:"".concat(e,"/error/code")},{groupName:"Messages",property:"".concat(e,"/error/message")}]}var n="Object.keys("+"${technicalDetails}"+').length > 0 ? "<h2>Technical Details</h2>" : "" ';a().forEach(function(e){n="".concat(n+r(e)).concat(t(e)," + ")});return n}function N(){return"(${"+'description} ? ("<h2>Description</h2>" + ${'+'description}) : "")'}function R(e){var t=m.None;var r=e.length;var a={Error:0,Warning:0,Success:0,Information:0};for(var n=0;n<r;n++){++a[e[n].getType()]}if(a[m.Error]>0){t=m.Error}else if(a[m.Warning]>0){t=m.Warning}else if(a[m.Success]>0){t=m.Success}else if(a[m.Information]>0){t=m.Information}return t}function C(e,t,r){var a=e.getMessageModel().getObject("/");var n=false;var s="";a.forEach(function(o,i){var c=o.getTechnicalDetails&&o.getTechnicalDetails();if(c&&c.httpStatus===412){if(c.isConcurrentModification&&r){s=s||t.getText("C_APP_COMPONENT_SAPFE_ETAG_TECHNICAL_ISSUES_CONCURRENT_MODIFICATION")}else{s=s||t.getText("C_APP_COMPONENT_SAPFE_ETAG_TECHNICAL_ISSUES")}e.removeMessages(a[i]);o.setMessage(s);o.target="";e.addMessages(o);n=true}});return n}function D(){A.close();v.setVisible(false);S=[];var e=T.getModel();if(e){e.setData({})}O()}function I(e,t){var r=new Date;var a=e.getTechnicalDetails();var n=g.getLibraryResourceBundle("sap.fe.core");var s;if(a&&a.httpStatus===503&&a.retryAfter){var o=a.retryAfter;var i;if(r.getFullYear()!==o.getFullYear()){i=u.getDateTimeInstance({pattern:"MMMM dd, yyyy 'at' hh:mm a"});s=n.getText("C_MESSAGE_HANDLING_SAPFE_503_ERROR",[i.format(o)])}else if(r.getFullYear()==o.getFullYear()){if(t){s="".concat(n.getText("C_MESSAGE_HANDLING_SAPFE_503_TITLE")," ").concat(n.getText("C_MESSAGE_HANDLING_SAPFE_503_DESC"))}else if(r.getMonth()!==o.getMonth()||r.getDate()!==o.getDate()){i=u.getDateTimeInstance({pattern:"MMMM dd 'at' hh:mm a"});s=n.getText("C_MESSAGE_HANDLING_SAPFE_503_ERROR",[i.format(o)])}else{i=u.getDateTimeInstance({pattern:"hh:mm a"});s=n.getText("C_MESSAGE_HANDLING_SAPFE_503_ERROR_DAY",[i.format(o)])}}}if(a&&a.httpStatus===503&&!a.retryAfter){s=n.getText("C_MESSAGE_HANDLING_SAPFE_503_ERROR_NO_RETRY_AFTER")}return s}function P(e,r,a){var n;if(!r){n=new s(undefined,{counter:{path:"counter"},title:"{message}",subtitle:"{additionalText}",longtextUrl:"{descriptionUrl}",type:{path:"type"},description:"{= ${"+"description} || ${technicalDetails} ? "+'"<html><body>" + '+N()+" + "+y()+'"</body></html>"'+' : "" }',markupDescription:true})}else if(a){n=new s(undefined,{counter:{path:"counter"},title:"{message}",subtitle:"{additionalText}",longtextUrl:"{descriptionUrl}",type:{path:"type"},description:"{description}",markupDescription:true})}else{n=new s({title:"{message}",type:{path:"type"},longtextUrl:"{descriptionUrl}"})}T=new i({showDetailsPageHeader:false,itemSelect:function(){v.setVisible(true)},items:{path:"/",template:n}});v=v||new t({icon:l.getIconURI("nav-back"),visible:false,press:function(){T.navigateBack();this.setVisible(false)}});T.setModel(e);return{oMessageView:T,oBackButton:v}}function x(s,i,u,l,p,y){var N=this.getMessages();var C=g.getMessageManager();var x;var w;var L=[new _({path:"persistent",operator:E.NE,value1:false})];var B=false,H=false;if(u){N=N.concat(F(true,true));L.push(new _({path:"persistent",operator:E.EQ,value1:true}));var U=function(e){var t=Infinity,a=g.byId(e[0]);var n=g.byId(e[0]);while(a){var s=a instanceof r?n.getParent().findElements(true).indexOf(n):Infinity;if(a instanceof r){if(t>s){t=s;n.focus()}return false}a=a.getParent()}return true};L.push(new _({path:"controlIds",test:U,caseSensitive:true}))}else{L.push(new _({path:"target",operator:E.EQ,value1:""}))}if(s&&s.length){s.forEach(function(e){var t=e.code?e.code:"";C.addMessages(new f({message:e.text,type:e.type,target:"",persistent:true,code:t}))})}var j=T&&T.getModel()||new d;var V=this.modifyETagMessagesOnly(C,g.getLibraryResourceBundle("sap.fe.core"),l);if(N.length===1&&N[0].getCode()==="503"){H=true}else if(N.length!==0){B=true}var $;var k=[];if(B||!H&&!y){var W=C.getMessageModel().bindList("/",undefined,undefined,L),Y=W.getCurrentContexts();if(Y&&Y.length>0){B=true;var z=[];Y.forEach(function(e){var t=e.getObject();z.push(t);h=z});var K=[];if(Array.isArray(j.getData())){K=j.getData()}var Q={};k=h.concat(K).filter(function(e){return!Q[e.id]&&(Q[e.id]=true)})}}if(y){$={showMessageBox:H,showMessageDialog:B};$=y(N,$);H=$.showMessageBox;B=$.showMessageDialog;if(B){k=$.filteredMessages?$.filteredMessages:k}}if(N.length===0&&!s&&!V){return Promise.resolve(true)}else if(N.length===1&&N[0].getType()===m.Success&&!s){return new Promise(function(e){o.show(N[0].message);if(j){j.setData({})}C.removeMessages(N);e()})}else if(B){j.setData(k);M=M||[];return new Promise(function(a,n){M.push(a);g.getLibraryResourceBundle("sap.fe.core",true).then(function(n){var s=false;if($&&$.fnGetMessageSubtitle){j.getData().forEach(function(e){$.fnGetMessageSubtitle(e)})}var o=P(j,s);A=A&&A.isOpen()?A:new r({resizable:true,endButton:new t({press:function(){D();C.removeMessages(k)},text:n.getText("C_COMMON_SAPFE_CLOSE")}),customHeader:new e({contentMiddle:[new c({text:n.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE")})],contentLeft:[v]}),contentWidth:"37.5em",contentHeight:"21.5em",verticalScrolling:false,afterClose:function(){for(var e=0;e<M.length;e++){M[e].call()}M=[]}});A.removeAllContent();A.addContent(o.oMessageView);if(V){sap.ui.require(["sap/m/ButtonType"],function(e){A.setBeginButton(new t({press:function(){D();if(i.hasPendingChanges()){i.getBinding().resetChanges()}i.refresh()},text:n.getText("C_COMMON_SAPFE_REFRESH"),type:e.Emphasized}))})}else{A.destroyBeginButton()}x=R(T.getItems());w=G(x);A.setState(x);A.getCustomHeader().getContentMiddle()[0].setText(w);T.navigateBack();A.open();if(p){a(A)}}).catch(n)})}else if(H){return new Promise(function(e){var t=N[0];if(t.technicalDetails&&S.indexOf(t.technicalDetails.originalMessage.message)===-1){S.push(t.technicalDetails.originalMessage.message);var r="<html><body>";var s=I(t,true);if(s){r="<h6>".concat(s,"</h6><br>")}if($&&$.fnGetMessageSubtitle){$.fnGetMessageSubtitle(t)}if(t.getCode()!=="503"&&t.getAdditionalText()!==undefined){r="".concat(r+t.getAdditionalText(),": ").concat(t.getMessage(),"</html></body>")}else{r="".concat(r+t.getMessage(),"</html></body>")}var o=new a({htmlText:r});n.error(o,{onClose:function(){S=[];if(u){b()}O();e(true)}})}})}else{return Promise.resolve(true)}}function G(e){var t=g.getLibraryResourceBundle("sap.fe.core");switch(e){case"Error":return t.getText("C_COMMON_SAPFE_ERROR_MESSAGES_PAGE_TITLE_ERROR");case"Information":return t.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_INFO");case"Success":return t.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_SUCCESS");case"Warning":return t.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_WARNING");default:return t.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE")}}function O(){L(false)}function b(e){L(true,e)}function w(e,t){if(t===undefined){return e.getObject("/")}var r=e.bindList("/");r.filter(new _({path:"target",operator:E.StartsWith,value1:t}));return r.getCurrentContexts().map(function(e){return e.getObject()})}function F(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var r=arguments.length>2?arguments[2]:undefined;var a;var n=g.getMessageManager(),s=n.getMessageModel(),o=g.getLibraryResourceBundle("sap.fe.core"),i=[];var c=[];if(e&&t&&r){c=w(s,r)}else{c=s.getObject("/")}for(a=0;a<c.length;a++){if((!t||c[a].persistent)&&(e&&c[a].target!==""||!e&&(!c[a].target||c[a].target===""))){i.push(c[a])}}for(a=0;a<i.length;a++){if(i[a].code==="503"&&i[a].message!==""&&i[a].message.indexOf(o.getText("C_MESSAGE_HANDLING_SAPFE_503_BACKEND_PREFIX"))===-1){i[a].message="\n".concat(o.getText("C_MESSAGE_HANDLING_SAPFE_503_BACKEND_PREFIX")).concat(i[a].message)}}var u=[];for(a=0;a<i.length;a++){if(i[a].technicalDetails&&(i[a].technicalDetails.originalMessage!==undefined&&i[a].technicalDetails.originalMessage!==null||i[a].technicalDetails.httpStatus!==undefined&&i[a].technicalDetails.httpStatus!==null)||i[a].code){u.push(i[a])}}return u}function L(e,t){var r=F(e,true,t);if(r.length>0){g.getMessageManager().removeMessages(r)}}function B(e,t,r){var a=e.getParent().getIdentifierColumn();var n=t.find(function(e){return r.getTarget().indexOf(e.getPath())!==-1});r.additionalText=n?n.getObject()[a]:undefined}var H={getMessages:F,showUnboundMessages:x,removeUnboundTransitionMessages:O,removeBoundTransitionMessages:b,modifyETagMessagesOnly:C,getRetryAfterMessage:I,prepareMessageViewForDialog:P,setMessageSubtitle:B};return H},false);
//# sourceMappingURL=messageHandling.js.map
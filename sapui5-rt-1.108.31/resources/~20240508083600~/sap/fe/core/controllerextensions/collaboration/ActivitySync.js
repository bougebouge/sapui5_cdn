/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/ActivityBase","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/m/MessageBox"],function(e,t,r,n){"use strict";var o={};var i=r.CollaborationUtils;var a=r.Activity;var l=t.isCollaborationConnected;var c=t.initializeCollaboration;var s=t.endCollaboration;var u=t.broadcastCollaborationMessage;function v(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function f(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?v(Object(r),!0).forEach(function(t){g(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):v(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function g(e,t,r){t=d(t);if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}function d(e){var t=p(e,"string");return typeof t==="symbol"?t:String(t)}function p(e,t){if(typeof e!=="object"||e===null)return e;var r=e[Symbol.toPrimitive];if(r!==undefined){var n=r.call(e,t||"default");if(typeof n!=="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}var C="/collaboration/myActivity";var b="/collaboration/activeUsers";var y="/collaboration/activities";var P=function(e){var t=e.getModel("internal");return l(t)};o.isConnected=P;var m=function(e,t,r){if(P(e)){var n=e.getModel("internal");var o=Array.isArray(r)?r.join("|"):r;if(t===a.LiveChange){var i=n.getProperty(C);if(i===o){return}else{n.setProperty(C,o)}}else{n.setProperty(C,null)}u(t,o,n)}};o.send=m;var O=function(e){return e.getModel().getMetaModel().getObject("/@com.sap.vocabularies.Common.v1.WebSocketBaseURL")};var h=function(e){var t=(e===null||e===void 0?void 0:e.getBindingContext)&&e.getBindingContext();return!!(t&&O(t))};o.isCollaborationEnabled=h;var A=function(e){try{var t=e.getModel("internal");var r=i.getMe(e);if(!r){return Promise.resolve()}var n=e.getBindingContext();var o=O(n);var a=n.getModel().getServiceUrl();if(!o){return Promise.resolve()}return Promise.resolve(n.requestProperty("DraftAdministrativeData/DraftUUID")).then(function(n){if(!n){return}c(r,o,n,a,t,function(t){D(t,e)})})}catch(e){return Promise.reject(e)}};o.connect=A;var M=function(e){var t=e.getModel("internal");s(t)};o.disconnect=M;function D(e,t){var r,o;var l=t.getModel("internal");var c=l.getProperty(b);var s;var v;var g=e.clientContent&&t.getModel().getMetaModel().getMetaPath(e.clientContent);e.userAction=e.userAction||e.clientAction;var d={id:e.userID,name:e.userDescription,initials:i.formatInitials(e.userDescription),color:i.getUserColor(e.userID,c,[])};var p=d;switch(e.userAction){case a.Join:case a.JoinEcho:if(c.findIndex(function(e){return e.id===d.id})===-1){c.unshift(d);l.setProperty(b,c)}if(e.userAction===a.Join){u(a.JoinEcho,l.getProperty(C),l)}if(e.userAction===a.JoinEcho){if(e.clientContent){e.userAction=a.LiveChange;D(e,t)}}break;case a.Leave:c=c.filter(function(e){return e.id!==d.id||e.me});l.setProperty(b,c);var P=l.getProperty(y)||{};var m=function(e){if(Array.isArray(e)){return e.filter(function(e){return e.id!==d.id})}else{for(var t in e){e[t]=m(e[t])}return e}};m(P);l.setProperty(y,P);break;case a.Change:var O=e===null||e===void 0?void 0:(r=e.clientContent)===null||r===void 0?void 0:r.split("|").map(function(e){return t.getModel().getMetaModel().getMetaPath(e)});O.forEach(function(r,n){var o,i;var c=f(f({},e),{},{clientContent:e===null||e===void 0?void 0:(o=e.clientContent)===null||o===void 0?void 0:o.split("|")[n]});var s=l.getProperty(y+r)||[];v=k(c.clientContent);s=((i=s)===null||i===void 0?void 0:i.filter)&&s.filter(function(e){return e.key!==v});if(s){l.setProperty(y+r,s);x(t,c,r,a.Change)}});break;case a.Create:x(t,e,g,a.Create);break;case a.Delete:x(t,e,g,a.Delete);break;case a.Activate:M(t);n.information(i.getText("C_COLLABORATIONDRAFT_ACTIVATE",d.name));E(e.clientContent,t);break;case a.Discard:M(t);n.information(i.getText("C_COLLABORATIONDRAFT_DISCARD",d.name));E(e.clientContent,t);break;case a.LiveChange:p=d;p.key=k(e.clientContent);var h="";var A=g.split("/");for(var j=1;j<A.length-1;j++){h+="/".concat(A[j]);if(!l.getProperty(y+h)){l.setProperty(y+h,{})}}s=l.getProperty(y+g);s=(o=s)!==null&&o!==void 0&&o.slice?s.slice():[];s.push(p);l.setProperty(y+g,s);break;case a.Undo:s=l.getProperty(y+g);v=k(e.clientContent);l.setProperty(y+g,s.filter(function(e){return e.key!==v}));break}}function x(e,t,r,o){var l=i.getAppComponent(e);var c=e.getModel().getMetaModel();var s=j(e);var u=l.getSideEffectsService();var v=s.getBindingContext();var f=v.getPath();var g=c.getMetaPath(f);var d=t.clientContent;if(o===a.Delete){var p=t.clientContent.split("|");var C=p.findIndex(function(e){return f.startsWith(e)});if(C>-1){n.information(i.getText("C_COLLABORATIONDRAFT_DELETE",t.userDescription),{onClose:function(){var t=e.getModel().bindContext(p[C]).getBoundContext();s.getController()._routing.navigateBackFromContext(t)}})}d=p[0]}if(d.startsWith(f)){var b=r.replace(g,"").slice(1);if(b){(function(){var e=[{$PropertyPath:b}];var t=u.getEntityTypeFromContext(v);var r=u.getODataEntitySideEffects(t);var n=Object;var o=n.fromEntries(n.entries(r).filter(function(e){var t;return((t=e[1].SourceProperties)===null||t===void 0?void 0:t.findIndex(function(e){return e.value===b}))>-1}));for(var i in o){o[i].TargetProperties.forEach(function(t){e.push({$PropertyPath:t})})}u.requestSideEffects(e,v,"$auto")})()}}s.getController().editFlow.updateDocument(v,Promise.resolve())}function E(e,t){var r=j(t);var n=t.getModel().bindContext(e).getBoundContext();r.getController().routing.navigate(n)}function j(t){var r=i.getAppComponent(t);return e.getCurrentPageView(r)}function k(e){return e.substring(e.lastIndexOf("(")+1,e.lastIndexOf(")"))}return{connect:A,disconnect:M,isConnected:P,isCollaborationEnabled:h,send:m}},false);
//# sourceMappingURL=ActivitySync.js.map
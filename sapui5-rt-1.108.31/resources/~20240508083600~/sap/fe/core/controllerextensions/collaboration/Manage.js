/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/m/MessageToast","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/library"],function(e,t,r,n,o){"use strict";var a={};var i=e.UserStatus;var s=e.UserEditingState;var c=e.shareObject;var l=e.getText;var u=e.CollaborationUtils;var d=function(e){try{var t=n.load({id:"manageCollaborationDraft",name:"sap.fe.core.controllerextensions.collaboration.UserDetails"});return Promise.resolve(t.then(function(t){e.addDependent(t);return t}).catch(function(){throw"not this time"}))}catch(e){return Promise.reject(e)}};var v=function(e,t){try{function a(){n.setBindingContext(r.getBindingContext("internal"),"internal");n.openBy(r,false)}var r=e.getSource();var n=p("userDetails");var o=function(){if(!n){return Promise.resolve(d(t)).then(function(e){n=e})}}();return Promise.resolve(o&&o.then?o.then(a):a(o))}catch(i){return Promise.reject(i)}};a.showUserDetails=v;var g=function(e){try{var t=e.getModel();var r={$select:"UserID,UserDescription,UserEditingState"};var n=t.bindList("DraftAdministrativeData/DraftAdministrativeUser",e.getBindingContext(),[],[],r);var o=e.getBindingContext("internal");return Promise.resolve(n.requestContexts(0,100).then(function(t){var r=[];var n=e.getModel("internal").getProperty("/collaboration/activeUsers")||[];var a=u.getMe(e);var c;if((t===null||t===void 0?void 0:t.length)>0){t.forEach(function(e){var t=e.getObject();var o=(a===null||a===void 0?void 0:a.id)===t.UserID;var l=n.find(function(e){return e.id===t.UserID});var d=t.UserDescription||t.UserID;var v=u.formatInitials(d);d+=o?" (".concat(u.getText("C_COLLABORATIONDRAFT_YOU"),")"):"";switch(t.UserEditingState){case s.NoChanges:c=l?i.CurrentlyEditing:i.NoChangesMade;break;case s.InProgress:c=l?i.CurrentlyEditing:i.ChangesMade;break;default:c=i.NotYetInvited}var g={id:t.UserID,name:d,status:c,color:u.getUserColor(t.UserID,n,r),initials:v,me:o};r.push(g)})}else{r.push(a)}o.setProperty("collaboration/UserID","");o.setProperty("collaboration/UserDescription","");o.setProperty("collaboration/invitedUsers",r)}).catch(function(){}))}catch(e){return Promise.reject(e)}};a.readInvitedUsers=g;var f=function(e){try{var t=e.getController().getExtensionAPI().loadFragment({name:"sap.fe.core.controllerextensions.collaboration.ManageDialog",id:"manageCollaborationDraft",controller:{share:O,addUser:U,removeUser:m,close:A,addUserChanged:I,formatUserStatus:T,formatUserStatusColor:P}});return Promise.resolve(t.then(function(t){e.addDependent(t);return t}).catch(function(){throw"not this time"}))}catch(e){return Promise.reject(e)}};var C=o.ValueState;var h=function(e){try{function n(){return Promise.resolve(g(e)).then(function(){t.open()})}var t=p("dialog");var r=function(){if(!t){return Promise.resolve(f(e)).then(function(e){t=e})}}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(o){return Promise.reject(o)}};a.openManageDialog=h;function U(e){var t=e.getSource();var r=t.getBindingContext("internal");var n=r.getProperty("invitedUsers")||[];var o=t.getModel("internal").getProperty("/collaboration/activeUsers");var a={id:r===null||r===void 0?void 0:r.getProperty("UserID"),name:r===null||r===void 0?void 0:r.getProperty("UserDescription")};if(!(n.findIndex(function(e){return e.id===a.id})>-1||a.id===a.name&&a.id==="")){a.name=a.name||a.id;a.initials=u.formatInitials(a.name);a.color=u.getUserColor(a.id,o,n);a.transient=true;a.status=i.NotYetInvited;n.unshift(a);r.setProperty("invitedUsers",n);r.setProperty("UserID","");r.setProperty("UserDescription","")}}function I(e){var t=e.getSource();e.getParameter("promise").then(function(e){var r=t.getBindingContext("internal");var n=r.getProperty("invitedUsers")||[];if(n.findIndex(function(t){return t.id===e})>-1){t.setValueState("Error");t.setValueStateText(l("C_COLLABORATIONDRAFT_INVITATION_USER_ERROR"))}else{t.setValueState("None");t.setValueStateText("")}}).catch(function(){throw"User couldn't be determined at all"})}function m(e){D(e.getSource())}function D(e){var t=e.getBindingContext("pageInternal");var r=e.getBindingContext("internal").getProperty("id");var n=t.getProperty("collaboration/invitedUsers");n=n.filter(function(e){return e.id!==r});t.setProperty("collaboration/invitedUsers",n)}function p(e){return r.byId("manageCollaborationDraft--".concat(e))}function A(){p("dialog").close()}function O(e){var r=[];var n=e.getSource();var o=n.getBindingContext();var a=p("userList").getBinding("items").getContexts();a.forEach(function(e){r.push({UserID:e.getProperty("id"),UserAccessRole:"O"})});c(o,r).then(function(){t.show(l("C_COLLABORATIONDRAFT_INVITATION_SUCCESS_TOAST"))}).catch(function(){t.show(l("C_COLLABORATIONDRAFT_INVITATION_FAILED_TOAST"))});A()}function T(e){switch(e){case i.CurrentlyEditing:return l("C_COLLABORATIONDRAFT_USER_CURRENTLY_EDITING");case i.ChangesMade:return l("C_COLLABORATIONDRAFT_USER_CHANGES_MADE");case i.NoChangesMade:return l("C_COLLABORATIONDRAFT_USER_NO_CHANGES_MADE");case i.NotYetInvited:default:return l("C_COLLABORATIONDRAFT_USER_NOT_YET_INVITED")}}function P(e){switch(e){case i.CurrentlyEditing:return C.Success;case i.ChangesMade:return C.Warning;case i.NoChangesMade:case i.NotYetInvited:default:return C.Information}}return a},false);
//# sourceMappingURL=Manage.js.map
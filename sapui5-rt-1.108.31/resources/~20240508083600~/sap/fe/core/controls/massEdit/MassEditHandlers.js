/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/helpers/ModelHelper","sap/fe/macros/internal/valuehelp/ValueListHelperNew","sap/ui/core/Core"],function(e,t,a,n){"use strict";var r={contextPropertyChange:function(e,t,a){var i=n.byId(a);var u=i&&i.getBindingContext();var o=i&&i.getModel("fieldsInfo");var l=o.getProperty("/values/".concat(t))||o.getProperty("/unitData/".concat(t))||[];if(u&&(l.inputType==="InputWithValueHelp"||l.inputType==="InputWithUnit")&&!l.valueListInfo){r._setValueListInfo(u,i,o,t)}var s=o&&o.getProperty("/isOpen");if(!s||!i.getVisible()){return}r._updateSelectKey(i,t,e)},handleMDCFieldChange:function(t,a){var n=t&&t.getSource();var i=t&&t.getParameter("promise");var u=n.getContent();if(!u||!a){return}i.then(r._updateSelectKeyForMDCFieldChange.bind(r,n,a)).catch(function(t){e.warning("VHD selection couldn't be populated in the mass edit field.".concat(t))})},handleSelectionChange:function(e){var t=e&&e.getSource();var a=t.getSelectedKey();var n=t&&a&&a.split("/");var i;if(n[0]==="UseValueHelpValue"){var u=e.getParameter("previousSelectedItem");var o=u.getKey();i=n.slice(1).join("/");r._onVHSelect(t,i,o);return}var l=t&&t.getModel("fieldsInfo");i=r._getPropertyNameFromKey(a);r._updateSuggestionForFieldsWithInParameters(l,i,a.startsWith("Default/")||a.startsWith("ClearFieldValue/"),true);r._updateSuggestionForFieldsWithOutParameters(l,i,a.startsWith("Default/")||a.startsWith("ClearFieldValue/"),false);r._updateResults(t,n,true)},_updateSelectKeyForMDCFieldChange:function(e,t,a){var n=e&&e.getBindingContext();var i=e&&e.getModel("fieldsInfo");var u=i.getProperty("/values/".concat(t))||i.getProperty("/unitData/".concat(t))||[];if(n&&(u.inputType==="InputWithValueHelp"||u.inputType==="InputWithUnit")&&!u.valueListInfo){r._setValueListInfo(n,e,i,t)}r._updateSuggestionForFieldsWithOutParameters(i,t,false,true);r._updateSuggestionForFieldsWithInParameters(i,t,false,true);var o=e.getFormFormattedValue();r._updateSelectKey(e,t,a,o)},_updateSuggestionForFieldsWithInParameters:function(e,t,a,n){var i=e.getProperty("/values");var u=e.getProperty("/unitData");var o=Object.keys(i);var l=Object.keys(u);o.forEach(r._updateInParameterSuggetions.bind(r,e,"/values/",t,a,n));l.forEach(r._updateInParameterSuggetions.bind(r,e,"/unitData/",t,a,n))},_updateInParameterSuggetions:function(e,t,a,n,i,u){var o=e.getProperty("".concat(t+u,"/valueListInfo"));if(o&&a!=u){var l=o.inParameters;if(l&&l.length>0&&l.includes(a)){r._updateFieldPathSuggestions(e,t+u,n,i)}}},_updateSuggestionForFieldsWithOutParameters:function(e,t,a,n){var i=e.getProperty("/values/".concat(t,"/valueListInfo"))||e.getProperty("/unitData/".concat(t,"/valueListInfo"));if(i&&i.outParameters){var u=i.outParameters;if(u.length&&u.length>0){r._updateOutParameterSuggetions(u,e,a,n);var o=e.getProperty("/values/".concat(t))&&"/values/".concat(t)||e.getProperty("/unitData/".concat(t))&&"/unitData/".concat(t);if(o){r._updateFieldPathSuggestions(e,o,false,true)}}}},_updateOutParameterSuggetions:function(e,t,a,n){var i=t.getProperty("/values");var u=t.getProperty("/unitData");var o=Object.keys(i);var l=Object.keys(u);e.forEach(function(e){if(o.includes(e)){r._updateFieldPathSuggestions(t,"/values/".concat(e),a,n)}else if(l.includes(e)){r._updateFieldPathSuggestions(t,"/unitData/".concat(e),a,n)}})},_updateFieldPathSuggestions:function(e,t,a,n){var r=e.getProperty(t);var i=r.defaultOptions;var u=e.getProperty("".concat(t,"/selectedKey"));var o=n&&r.find(function(e){return e.key===u});if(a){var l=r.selectOptions;r.length=0;i.forEach(function(e){return r.push(e)});l.forEach(function(e){return r.push(e)})}else{r.length=0;i.forEach(function(e){return r.push(e)})}e.setProperty(t,r);if(o&&!r.includes(o)){r.push(o);e.setProperty("".concat(t,"/selectedKey"),u)}},_setValueListInfo:function(e,t,a,n){var i=a.getProperty("/values/".concat(n))&&"/values/"||a.getProperty("/unitData/".concat(n))&&"/unitData/";if(a.getProperty("".concat(i).concat(n,"/valueListInfo"))){return}var u=a.getProperty("".concat(i).concat(n,"/valueListInfo"));if(!u){r._requestValueList(e,t,a,n)}},_requestValueList:function(n,i,u,o){var l;var s=t.getMetaPathForContext(n);var c=s&&"".concat(s,"/").concat(o);var d=i===null||i===void 0?void 0:i.getDependents();var v=i===null||i===void 0?void 0:i.getFieldHelp();var f=d===null||d===void 0?void 0:d.find(function(e){return e.getId()===v});var g=(l=f.getDelegate())===null||l===void 0?void 0:l.payload;if(!(f!==null&&f!==void 0&&f.getBindingContext())){f===null||f===void 0?void 0:f.setBindingContext(n)}var p=n.getModel().getMetaModel();a.createVHUIModel(f,c,p);var y=a.getValueListInfo(f,c,g);y.then(function(e){var t=e[0];var n=u.getProperty("/values/".concat(o))&&"/values/"||u.getProperty("/unitData/".concat(o))&&"/unitData/";var i={inParameters:t.vhParameters&&a.getInParameters(t.vhParameters).map(function(e){return e.helpPath}),outParameters:t.vhParameters&&a.getOutParameters(t.vhParameters).map(function(e){return e.helpPath})};u.setProperty("".concat(n).concat(o,"/valueListInfo"),i);if(i.outParameters.length>0){r._updateFieldPathSuggestions(u,"/values/".concat(o),false,true)}}).catch(function(){e.warning("Mass Edit: Couldn't load valueList info for ".concat(c))})},_getValueHelp:function(e,t){var a=t===null||t===void 0?void 0:t.getDependents();var n=t===null||t===void 0?void 0:t.getFieldHelp();return a===null||a===void 0?void 0:a.find(function(e){return e.getId()===n})},_onVHSelect:function(e,t,a){var n=e&&e.getModel("fieldsInfo");var i=n.getProperty("/values/".concat(t))&&"/values/"||n.getProperty("/unitData/".concat(t))&&"/unitData/";var u=e.getBindingContext();var o=r._getValueHelp(u,e.getParent());if(!(o!==null&&o!==void 0&&o.getBindingContext())){o===null||o===void 0?void 0:o.setBindingContext(u)}e.fireValueHelpRequest();n.setProperty("".concat(i+t,"/selectedKey"),a)},_getPropertyNameFromKey:function(e){var t="";if(e.startsWith("Default/")||e.startsWith("ClearFieldValue/")||e.startsWith("UseValueHelpValue/")){t=e.substring(e.indexOf("/")+1)}else{t=e.substring(0,e.lastIndexOf("/"))}return t},_updateSelectKey:function(e,t,a,n){var i=e.getContent();if(!i||!t){return}var u=i.getSelectedKey();if((u.startsWith("Default/")||u.startsWith("ClearFieldValue/"))&&!a){return}var o=r._valueExists(n)?n:a;var l=e&&e.getModel("fieldsInfo");var s=l.getProperty("/values/".concat(t))||l.getProperty("/unitData/".concat(t))||[];var c=l.getProperty("/values/".concat(t))&&"/values/"||l.getProperty("/unitData/".concat(t))&&"/unitData/";var d=s.find(function(e){var t;return(e===null||e===void 0?void 0:(t=e.textInfo)===null||t===void 0?void 0:t.value)===a||e.text===a});if(d){if(n&&d.textInfo&&d.textInfo.descriptionPath&&(d.text!=o||d.textInfo.fullText!=o)){d.text=o;d.textInfo.fullText=o;d.textInfo.description=e.getAdditionalValue()}if(d.key===u){l.setProperty("".concat(c+t,"/selectedKey"),u);return}u=d.key}else if([undefined,null,""].indexOf(a)===-1){u="".concat(t,"/").concat(a);var v={text:o,key:u,textInfo:{description:e.getAdditionalValue(),descriptionPath:s&&s.textInfo&&s.textInfo.descriptionPath,fullText:o,textArrangement:e.getDisplay(),value:e.getValue(),valuePath:t}};s.push(v);s.selectOptions=s.selectOptions||[];s.selectOptions.push(v);l.setProperty(c+t,s)}else{u="Default/".concat(t)}l.setProperty("".concat(c+t,"/selectedKey"),u);r._updateResults(i)},_getValue:function(e){var t;return e.getMetadata().getName()==="sap.fe.core.controls.MassEditSelect"?(t=e.getSelectedItem())===null||t===void 0?void 0:t.getText():e.getValue()},_getValueOnEmpty:function(e,t,a,n){if(!a){var r=t.getProperty("/values/".concat(n))||t.getProperty("/unitData/".concat(n))||[];if(r.unitProperty){a=0;e.setValue(a)}else if(r.inputType==="CheckBox"){a=false}}return a},_valueExists:function(e){return e!=undefined&&e!=null},_updateResults:function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var a=arguments.length>2?arguments[2]:undefined;var n=e&&e.getModel("fieldsInfo");var i=n&&n.getData();var u=r._getValue(e);t=t.length>0?t:e&&e.getSelectedKey()&&e.getSelectedKey().split("/");var o;var l=e.data("fieldPath");if(t[0]==="Default"){o={keyValue:t[1],value:t[0]}}else if(t[0]==="ClearFieldValue"){u="";u=r._getValueOnEmpty(e,n,u,l);o={keyValue:t[1],value:u}}else if(!t){u=r._getValueOnEmpty(e,n,u,l);o={keyValue:l,value:u}}else{var s=t.slice(0,-1).join("/");var c=n.getProperty("/values/".concat(s))||n.getProperty("/unitData/".concat(s))||[];var d=(c||[]).find(function(e){var t;return(e===null||e===void 0?void 0:(t=e.textInfo)===null||t===void 0?void 0:t.value)===u||e.text===u});o={keyValue:s,value:d.textInfo&&r._valueExists(d.textInfo.value)?d.textInfo.value:d.text}}var v=-1;for(var f=0;f<i.results.length;f++){if(i.results[f].keyValue===o.keyValue){v=f}}if(v!==-1){i.results[v]=o}else{i.results.push(o)}if(a&&!o.keyValue.includes("/")){var g=e.getBindingContext();if(t[0]==="Default"||t[0]==="ClearFieldValue"){g.setProperty(o.keyValue,null)}else if(o){g.setProperty(o.keyValue,o.value)}}}};return r},false);
//# sourceMappingURL=MassEditHandlers.js.map
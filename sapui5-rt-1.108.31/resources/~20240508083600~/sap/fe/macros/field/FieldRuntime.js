/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/ActivitySync","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controls/FieldWrapper","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/macros/CommonHelper","sap/fe/macros/field/FieldAPI","sap/fe/macros/ResourceModel","sap/m/MessageBox","sap/ui/core/Core","sap/ui/core/IconPool","sap/ui/model/Filter","sap/ui/unified/FileUploaderParameter","sap/ui/util/openWindow"],function(e,t,n,r,a,i,o,c,s,l,u,d,g,f,v,p,h){"use strict";var m=r.Activity;function C(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}function P(e){return O(e)||E(e)||S(e)||_()}function _(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function S(e,t){if(!e)return;if(typeof e==="string")return T(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return T(e,t)}function E(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function O(e){if(Array.isArray(e))return T(e)}function T(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,r=new Array(t);n<t;n++){r[n]=e[n]}return r}var A={resetChangesHandler:undefined,uploadPromises:undefined,formatDraftOwnerTextInPopover:function(e,t,n,r,a){if(e){var i=r||t||a||n;if(!i){return u.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_UNSAVED_CHANGES_BY_UNKNOWN")}else{return t?u.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_LOCKED_BY_KNOWN",i):u.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_UNSAVED_CHANGES_BY_KNOWN",i)}}else{return u.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_NO_DATA_TEXT")}},onDataFieldWithNavigationPath:function(n,r,i){if(r._routing){var o=n.getBindingContext();var s=t.getTargetView(n),l=o.getModel().getMetaModel(),u=function(e){if(e){o=e}r._routing.navigateToTarget(o,i,undefined,true)};if(s.getViewData().converterType==="ObjectPage"&&!c.isStickySessionSupported(l)){a.processDataLossOrDraftDiscardConfirmation(u,Function.prototype,o,s.getController(),true,a.NavigationType.ForwardNavigation)}else{u()}}else{e.error("FieldRuntime: No routing listener controller extension found. Internal navigation aborted.","sap.fe.macros.field.FieldRuntime","onDataFieldWithNavigationPath")}},isDraftIndicatorVisible:function(e,t,n,r,a){if(r!==undefined&&n!==undefined&&(!r||n)&&!a){return e===t}else{return false}},hasTargets:function(e){return e?e:false},getStateDependingOnSemanticObjectTargets:function(e){return e?"Information":"None"},onValidateFieldGroup:function(e,t){var n=A._getExtensionController(e);n._sideEffects.handleFieldGroupChange(t)},handleChange:function(e,r){var a=r.getSource(),i=a&&a.getBindingContext().isTransient(),o=r.getParameter("promise")||Promise.resolve(),c=r.getSource(),s=r.getParameter("valid");o.then(function(){r.oSource=c;r.mParameters={valid:s};l.handleChange(r,e)}).catch(function(){r.oSource=c;r.mParameters={valid:false};l.handleChange(r,e)});var u=A._getExtensionController(e);u._editFlow.syncTask(o);if(i){return}u._sideEffects.handleFieldChange(r,o);var d=r.getSource(),g=n.isConnected(d);var f,v;if(g&&this.getFieldStateOnChange(r).state["validity"]){var p,h;f=d.getBindingContext().getBinding();if(!f.isA("sap.ui.model.odata.v4.ODataListBinding")){var C=t.getTargetView(d);f=C.getBindingContext().getBinding()}var _=[].concat(P((p=d.getBindingInfo("value"))===null||p===void 0?void 0:p.parts),P(((h=d.getBindingInfo("additionalValue"))===null||h===void 0?void 0:h.parts)||[])).map(function(e){if(e){var t;v=e.path;return"".concat((t=d.getBindingContext())===null||t===void 0?void 0:t.getPath(),"/").concat(v)}});f.attachEventOnce("patchCompleted",function(){n.send(d,m.Change,_)})}},handleLiveChange:function(e){var t=this;var r=e.getSource(),a=n.isConnected(r);if(a){var i=r.getBindingInfo("value").parts[0].path;var o="".concat(r.getBindingContext().getPath(),"/").concat(i);n.send(r,m.LiveChange,o);if(!this.resetChangesHandler){this.resetChangesHandler=function(){if(r.getValue()===r.getBinding("value").getValue()){n.send(r,m.Undo,o)}r.detachBrowserEvent("focusout",t.resetChangesHandler);delete t.resetChangesHandler};r.attachBrowserEvent("focusout",this.resetChangesHandler)}}},handleOpenPicker:function(e){var t=e.getSource(),r=n.isConnected(t);if(r){var a=t.getBindingInfo("value").parts[0].path;var i="".concat(t.getBindingContext().getPath(),"/").concat(a);n.send(t,m.LiveChange,i)}},handleClosePicker:function(e){var t=e.getSource(),r=n.isConnected(t);if(r){var a=t.getBindingInfo("value").parts[0].path;var i="".concat(t.getBindingContext().getPath(),"/").concat(a);if(new Date(t.getValue()).toDateString()===new Date(t.getBinding("value").getValue()||"").toDateString()){n.send(t,m.Undo,i)}}},handleOpenUploader:function(e){var t=e.getSource(),r=n.isConnected(t);if(r){var a;var i=t.getParent().getAvatar().getBindingInfo("src").parts[0].path;var o="".concat((a=t.getBindingContext())===null||a===void 0?void 0:a.getPath(),"/").concat(i);n.send(t,m.LiveChange,o)}},handleCloseUploader:function(e){var t=e.getSource(),r=n.isConnected(t);if(r){var a;var i=t.getParent().getAvatar().getBindingInfo("src").parts[0].path;var o="".concat((a=t.getBindingContext())===null||a===void 0?void 0:a.getPath(),"/").concat(i);n.send(t,m.Undo,o)}},getFieldStateOnChange:function(e){var t=e.getSource(),n={};var r=function(e){return e&&e.getDataState()?e.getDataState().getInvalidValue()===undefined:true};if(t.isA("sap.fe.macros.field.FieldAPI")){t=t.getContent()}if(t.isA(i.getMetadata().getName())&&t.getEditMode()==="Editable"){t=t.getContentEdit()[0]}if(t.isA("sap.ui.mdc.Field")){var a=e.getParameter("valid")||e.getParameter("isValid");if(a===undefined){if(t.getMaxConditions()===1){var o=t.getBindingInfo("value");a=r(o&&o.binding)}if(t.getValue()===""&&!t.getProperty("required")){a=true}}n={fieldValue:t.getValue(),validity:!!a}}else{var c=t.getBinding("uploadUrl")||t.getBinding("value")||t.getBinding("selected");n={fieldValue:c&&c.getValue(),validity:r(c)}}return{field:t,state:n}},_fnFixHashQueryString:function(e){if(e&&e.indexOf("?")!==-1){e=e.split("?")[0]}return e},_fnGetLinkInformation:function(e,n,r,a,i){var o=n&&n.getModel();var c=o&&o.getMetaModel();var s=a||e&&e.getValue();var l=n&&t.getTargetView(n);var u=l&&l.getBindingContext("internal");var d=l&&t.getAppComponent(l);var g=d&&d.getShellServices();var f=g&&g.getLinksWithCache([[{semanticObject:s}]]);var v=c&&c.getObject("".concat(r,"@com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions"));return{SemanticObjectName:s,SemanticObjectFullPath:r,MetaModel:c,InternalModelContext:u,ShellServiceHelper:g,GetLinksPromise:f,SemanticObjectUnavailableActions:v,fnSetActive:i}},_fnQuickViewHasNewCondition:function(e,t){if(e&&e.path&&e.path===t.SemanticObjectFullPath){var n=e[!t.SemanticObjectUnavailableActions?"HasTargetsNotFiltered":"HasTargets"];t.fnSetActive(!!n);return true}else{return false}},_fnQuickViewSetNewConditionForConditionalWrapper:function(e,t){if(t[e.SemanticObjectName]){var n,r;var a=Object.keys(t[e.SemanticObjectName]);for(var i in a){n=a[i];r=t[e.SemanticObjectName]&&t[e.SemanticObjectName][n];if(A._fnQuickViewHasNewCondition(r,e)){break}}}},_fnUpdateSemanticObjectsTargetModel:function(n,r,a,i){var o=n&&n.getSource();var c;if(a.isA("sap.m.ObjectStatus")){c=function(e){return a.setActive(e)}}if(a.isA("sap.m.ObjectIdentifier")){c=function(e){return a.setTitleActive(e)}}var s=a&&a.getParent();if(s&&s.isA("sap.fe.core.controls.ConditionalWrapper")){c=function(e){return s.setCondition(e)}}if(c!==undefined){var l=A._fnGetLinkInformation(o,a,i,r,c);l.fnSetActive=c;var u=A._fnFixHashQueryString(t.getHash());t.updateSemanticTargets([l.GetLinksPromise],[{semanticObject:l.SemanticObjectName,path:l.SemanticObjectFullPath}],l.InternalModelContext,u).then(function(e){if(e){A._fnQuickViewSetNewConditionForConditionalWrapper(l,e)}}).catch(function(t){e.error("Cannot update Semantic Targets model",t)})}},_checkControlHasModelAndBindingContext:function(e){if(!e.getModel()||!e.getBindingContext()){return false}else{return true}},_checkCustomDataValueBeforeUpdatingSemanticObjectModel:function(e,t,n){var r;var a;var i=function(e){return!(e!==null&&typeof e==="object")};n=n.filter(function(e){return e.getKey()!=="sap-ui-custom-settings"});for(var o in n){r=n[o].getValue();if(!r&&i(r)){a=n[o].getBinding("value");if(a){a.attachEventOnce("change",function(n){A._fnUpdateSemanticObjectsTargetModel(n,null,e,t)})}}else if(i(r)){A._fnUpdateSemanticObjectsTargetModel(null,r,e,t)}}},LinkModelContextChange:function(e,t,n){var r=e.getSource();if(A._checkControlHasModelAndBindingContext(r)){var a="".concat(n,"/").concat(t);var i=r.getDependents().length?r.getDependents()[0]:undefined;var o=i===null||i===void 0?void 0:i.getCustomData();if(o&&o.length>0){A._checkCustomDataValueBeforeUpdatingSemanticObjectModel(r,a,o)}}},openExternalLink:function(e){var t=e.getSource();if(t.data("url")&&t.getProperty("text")!==""){h(t.data("url"),"_self")}},pressLink:function(n){try{var r=function(n){try{var r=C(function(){return Promise.resolve(n.getTriggerHref()).then(function(r){var a=function(){if(!r){var a=C(function(){return Promise.resolve(n.open(i)).then(function(){})},function(t){e.error("Cannot retrieve the QuickView Popover dialog",t)});if(a&&a.then)return a.then(function(){})}else{var c=t.getTargetView(i);var s=t.getAppComponent(c);var l=s.getShellServices();var u=l.parseShellHash(r);var d={target:{semanticObject:u.semanticObject,action:u.action},params:u.params};o.storeControlRefreshStrategyForHash(c,u);var g=function(){if(t.isStickyEditMode(i)!==true){l.toExternal(d,s)}else{var n=C(function(){return Promise.resolve(l.hrefForExternalAsync(d,s)).then(function(e){h(e)})},function(t){e.error("Error while retireving hrefForExternal : ".concat(t))});if(n&&n.then)return n.then(function(){})}}();if(g&&g.then)return g.then(function(){})}}();if(a&&a.then)return a.then(function(){})})},function(t){e.error("Error triggering link Href",t)});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};var a=n.getSource();var i=a.isA("sap.m.ObjectIdentifier")?a.findElements(false,function(e){return e.isA("sap.m.Link")})[0]:a;var c=function(){if(a.getDependents()&&a.getDependents().length>0&&i.getProperty("text")!==""){var e=a.getDependents()[0];var t=function(){if(e&&e.isA("sap.ui.mdc.Link")){return Promise.resolve(r(e)).then(function(){})}}();if(t&&t.then)return t.then(function(){})}}();return Promise.resolve(c&&c.then?c.then(function(){return i}):i)}catch(e){return Promise.reject(e)}},uploadStream:function(e,t){var n=this;var r=t.getSource(),a=A._getExtensionController(e),i=r.getParent(),o=i.getUploadUrl();if(o!==""){var c,s;i.setUIBusy(true);r.setUploadUrl(o);r.removeAllHeaderParameters();var l=(c=r.getModel())===null||c===void 0?void 0:c.getHttpHeaders()["X-CSRF-Token"];if(l){var g=new p;g.setName("x-csrf-token");g.setValue(l);r.addHeaderParameter(g)}var f=(s=r.getBindingContext())===null||s===void 0?void 0:s.getProperty("@odata.etag");if(f){var v=new p;v.setName("If-Match");v.setValue(f);r.addHeaderParameter(v)}var h=new p;h.setName("Accept");h.setValue("application/json");r.addHeaderParameter(h);var m=new Promise(function(e,t){n.uploadPromises=n.uploadPromises||{};n.uploadPromises[r.getId()]={resolve:e,reject:t};r.upload()});a._editFlow.syncTask(m)}else{d.error(u.getText("M_FIELD_FILEUPLOADER_ABORTED_TEXT"))}},handleUploadComplete:function(e,t,r,a){var i=e.getParameter("status"),o=e.getSource(),c=o.getParent();c.setUIBusy(false);if(i===0||i>=400){this._displayMessageForFailedUpload(e);this.uploadPromises[o.getId()].reject()}else{var s=o.getBindingContext(),l=e.getParameter("headers").etag;if(l){s===null||s===void 0?void 0:s.setProperty("@odata.etag",l,null)}if(t!==null&&t!==void 0&&t.path){s===null||s===void 0?void 0:s.setProperty(t.path,o.getValue())}s===null||s===void 0?void 0:s.setProperty(r,null,null);s===null||s===void 0?void 0:s.setProperty(r,undefined,null);this._callSideEffectsForStream(e,c,a);this.uploadPromises[o.getId()].resolve()}var u=e.getSource(),d=n.isConnected(u);var g;if(d){var f,v;var p=[].concat(P((f=u.getParent().getAvatar().getBindingInfo("src"))===null||f===void 0?void 0:f.parts),P(((v=u.getParent().getAvatar().getBindingInfo("additionalValue"))===null||v===void 0?void 0:v.parts)||[])).map(function(e){if(e){var t;g=e.path;return"".concat((t=u.getBindingContext())===null||t===void 0?void 0:t.getPath(),"/").concat(g)}});n.send(u,m.Change,p)}delete this.uploadPromises[o.getId()]},_displayMessageForFailedUpload:function(e){var t=e.getParameter("responseRaw")||e.getParameter("response");var n,r;try{r=t&&JSON.parse(t);n=r.error&&r.error.message}catch(e){n=t||u.getText("M_FIELD_FILEUPLOADER_ABORTED_TEXT")}d.error(n)},removeStream:function(e,r,a){var i=e.getSource(),o=i.getParent(),c=o.getBindingContext();c.setProperty(r,null);c.setProperty(r,undefined,null);this._callSideEffectsForStream(e,o,a);var s=n.isConnected(i);var l,u;if(s){var d,g;l=c.getBinding();if(!l.isA("sap.ui.model.odata.v4.ODataListBinding")){var f=t.getTargetView(i);l=f.getBindingContext().getBinding()}var v=[].concat(P((d=o.getAvatar().getBindingInfo("src"))===null||d===void 0?void 0:d.parts),P(((g=o.getAvatar().getBindingInfo("additionalValue"))===null||g===void 0?void 0:g.parts)||[])).map(function(e){if(e){u=e.path;return"".concat(c.getPath(),"/").concat(u)}});n.send(i,m.LiveChange,v);l.attachEventOnce("patchCompleted",function(){n.send(i,m.Change,v)})}},_callSideEffectsForStream:function(e,t,n){var r=A._getExtensionController(n);if(t&&t.getBindingContext().isTransient()){return}if(t){e.oSource=t}r._sideEffects.handleFieldChange(e)},getIconForMimeType:function(e){return f.getIconForMimeType(e)},retrieveTextFromValueList:function(t,n,r){var a;var i;var o;if(t){i=s.getMetaModel();o=i.getObject("".concat(n,"@sapui.name"));return i.requestValueListInfo(n,true).then(function(e){var n=e[e[""]?"":Object.keys(e)[0]];var i=n.$model;var c=i.getMetaModel();var s=n.Parameters.find(function(e){return e.LocalDataProperty&&e.LocalDataProperty.$PropertyPath===o});if(s&&!s.ValueListProperty){return Promise.reject("Inconsistent value help annotation for ".concat(o))}var l=c.getObject("/".concat(n.CollectionPath,"/").concat(s.ValueListProperty,"@com.sap.vocabularies.Common.v1.Text"));if(l&&l.$Path){a=l.$Path;var u=new v({path:s.ValueListProperty,operator:"EQ",value1:t});var d=i.bindList("/".concat(n.CollectionPath),undefined,undefined,u,{$select:a});return d.requestContexts(0,2)}else{r="Value";return t}}).then(function(e){var n;var i=a?(n=e[0])===null||n===void 0?void 0:n.getObject()[a]:"";switch(r){case"Description":return i;case"DescriptionValue":return g.getLibraryResourceBundle("sap.fe.core").getText("C_FORMAT_FOR_TEXT_ARRANGEMENT",[i,t]);case"ValueDescription":return g.getLibraryResourceBundle("sap.fe.core").getText("C_FORMAT_FOR_TEXT_ARRANGEMENT",[t,i]);default:return t}}).catch(function(t){var r=t.status&&t.status===404?"Metadata not found (".concat(t.status,") for value help of property ").concat(n):t.message;e.error(r)})}return t},handleTypeMissmatch:function(e){d.error(u.getText("M_FIELD_FILEUPLOADER_WRONG_MIMETYPE"),{details:"<p><strong>".concat(u.getText("M_FIELD_FILEUPLOADER_WRONG_MIMETYPE_DETAILS_SELECTED"),"</strong></p>").concat(e.getParameters().mimeType,"<br><br>")+"<p><strong>".concat(u.getText("M_FIELD_FILEUPLOADER_WRONG_MIMETYPE_DETAILS_ALLOWED"),"</strong></p>").concat(e.getSource().getMimeType().toString().replaceAll(",",", ")),contentWidth:"150px"})},handleFileSizeExceed:function(e){d.error(u.getText("M_FIELD_FILEUPLOADER_FILE_TOO_BIG",e.getSource().getMaximumFileSize().toFixed(3)),{contentWidth:"150px"})},_getExtensionController:function(e){return e.isA("sap.fe.core.ExtensionAPI")?e._controller:e}};return A},true);
//# sourceMappingURL=FieldRuntime.js.map
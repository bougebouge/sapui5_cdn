/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/TemplateModel","sap/fe/core/templating/PropertyFormatters","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/filter/FilterUtils","sap/fe/macros/ResourceModel","sap/ui/mdc/FilterBarDelegate","sap/fe/core/type/TypeUtil","sap/ui/model/json/JSONModel"],function(e,t,r,n,i,o,a,l,s,u,c,f,d,p,g){"use strict";var v=l.hasValueHelp;var m=o.generate;var h=n.processSelectionFields;function P(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}var y=function(t,r,n,i){try{return Promise.resolve(P(function(){i=i.replace("*","");var e=m([i]);if(r&&!r.modifier){throw"FilterBar Delegate method called without modifier."}return Promise.resolve(r.modifier.getProperty(t,"delegate")).then(function(o){return Promise.resolve(r.modifier.getProperty(t,"propertyInfo")).then(function(a){if(a){var l=a.some(function(t){return t.key===e||t.name===e});if(!l){var s=o.payload.entityTypePath;var u=c.createConverterContext(t,s,n,r.appComponent);var f=u.getEntityType();var d=c.getFilterField(i,u,f);d=c.buildProperyInfo(d,u);a.push(d);r.modifier.setProperty(t,"propertyInfo",a)}}})})},function(r){e.warning("".concat(t.getId()," : ").concat(r))}))}catch(e){return Promise.reject(e)}};var F=function(t,r,n){try{return Promise.resolve(P(function(){return Promise.resolve(Promise.resolve(r.getAggregation(t,"dependents"))).then(function(e){var t;if(e&&e.length>1){for(t=0;t<=e.length;t++){var r=e[t];if(r&&r.isA("sap.ui.mdc.FilterField")){var i=r.getFieldPath(),o=r.getId();if(n===i&&o.indexOf("CustomFilterField")){return Promise.resolve(r)}}}}})},function(t){e.error("Filter Cannot be added",t)}))}catch(e){return Promise.reject(e)}};var C=Object.assign({},d);var b="$editState",x="$search",M="FilterFieldValueHelp",I="sap_fe_FilterBarDelegate_propertyInfoMap",S=/\+|\*/g;function D(e,t,r){var n=new g({id:e,isDraftCollaborative:i.isCollaborationDraftSupported(t)}),o={bindingContexts:{this:n.createBindingContext("/")},models:{"this.i18n":f.getModel(),this:n}};return u.templateControlFragment("sap.fe.macros.filter.DraftEditState",o,undefined,r).finally(function(){n.destroy()})}C._templateCustomFilter=function(e,t,n,i,o){try{return Promise.resolve(u.getCustomData(e,"entityType",o)).then(function(l){var s=new g({id:t}),c=new a(n,i),f={bindingContexts:{contextPath:i.createBindingContext(l),this:s.createBindingContext("/"),item:c.createBindingContext("/")},models:{contextPath:i,this:s,item:c}},d=r.getTargetView(e),p=d?d.getController():undefined,v={controller:p?p:undefined,view:d};return u.templateControlFragment("sap.fe.macros.filter.CustomFilter",f,v,o).finally(function(){s.destroy();c.destroy()})})}catch(e){return Promise.reject(e)}};function L(e){return e.replace(S,"")}C._findSelectionField=function(e,t){return e.find(function(e){return(e.conditionPath===t||e.conditionPath.replaceAll(/\*/g,"")===t)&&e.availability!=="Hidden"})};function E(e,t,r){return r?m([e,t,r]):m([e,t])}function A(r,n){var i=new g({idPrefix:n.sVhIdPrefix,conditionModel:"$filters",navigationPrefix:n.sNavigationPrefix?"/".concat(n.sNavigationPrefix):"",filterFieldValueHelp:true,useSemanticDateRange:n.bUseSemanticDateRange,useNewValueHelp:location.href.indexOf("sap-fe-oldFieldValueHelp=true")<0});var o=t({},r,{bindingContexts:{this:i.createBindingContext("/")},models:{this:i}});return Promise.resolve(u.templateControlFragment("sap.fe.macros.internal.valuehelp.ValueHelp",o,{isXML:r.isXML})).then(function(e){if(e){var t="dependents";if(e.length){e.forEach(function(e){if(n.oModifier){n.oModifier.insertAggregation(n.oControl,t,e,0)}else{n.oControl.insertAggregation(t,e,0,false)}})}else if(n.oModifier){n.oModifier.insertAggregation(n.oControl,t,e,0)}else{n.oControl.insertAggregation(t,e,0,false)}}}).catch(function(t){e.error("Error while evaluating DelegateUtil.isValueHelpRequired",t)}).finally(function(){i.destroy()})}function T(e,r){var n=new g({idPrefix:r.sIdPrefix,vhIdPrefix:r.sVhIdPrefix,propertyPath:r.sPropertyName,navigationPrefix:r.sNavigationPrefix?"/".concat(r.sNavigationPrefix):"",useSemanticDateRange:r.bUseSemanticDateRange,settings:r.oSettings,visualFilter:r.visualFilter});var i=r.oMetaModel;var o=new a(r.visualFilter,i);var l=t({},e,{bindingContexts:{this:n.createBindingContext("/"),visualFilter:o.createBindingContext("/")},models:{this:n,visualFilter:o,metaModel:i}});return u.templateControlFragment("sap.fe.macros.internal.FilterField",l,{isXML:e.isXML}).finally(function(){n.destroy()})}C.addItem=function(e,t,r){try{if(!r){return Promise.resolve(C._addP13nItem(e,t))}var n=r.appComponent&&r.appComponent.getModel().getMetaModel();if(!n){return Promise.resolve(null)}return Promise.resolve(y(t,r,n,e)).then(function(){return C._addFlexItem(e,t,n,r.modifier,r.appComponent)})}catch(e){return Promise.reject(e)}};C.removeItem=function(e,t,r){try{var n=false;function a(o){if(n)return o;if(typeof e!=="string"&&e.isA&&e.isA("sap.ui.mdc.FilterField")){if(e.data("isSlot")==="true"&&r){var a=r.modifier;a.insertAggregation(t,"dependents",e);i=false}}return Promise.resolve(i)}var i=true;var o=function(){if(!t.data("sap_fe_FilterBarDelegate_propertyInfoMap")){var i=r&&r.appComponent&&r.appComponent.getModel().getMetaModel();if(!i){var o=Promise.resolve(null);n=true;return o}var a=function(){if(typeof e!=="string"&&e.getFieldPath()){return Promise.resolve(y(t,r,i,e.getFieldPath())).then(function(){})}else{return Promise.resolve(y(t,r,i,e)).then(function(){})}}();if(a&&a.then)return a.then(function(){})}}();return Promise.resolve(o&&o.then?o.then(a):a(o))}catch(l){return Promise.reject(l)}};C.addCondition=function(e,t,r){try{var n=r&&r.appComponent&&r.appComponent.getModel().getMetaModel();if(!n){return Promise.resolve(null)}return Promise.resolve(y(t,r,n,e)).then(function(){return Promise.resolve()})}catch(e){return Promise.reject(e)}};C.removeCondition=function(e,t,r){try{var n=false;function o(e){return n?e:Promise.resolve()}var i=function(){if(!t.data("sap_fe_FilterBarDelegate_propertyInfoMap")){var i=r&&r.appComponent&&r.appComponent.getModel().getMetaModel();if(!i){var o=Promise.resolve(null);n=true;return o}return Promise.resolve(y(t,r,i,e)).then(function(){})}}();return Promise.resolve(i&&i.then?i.then(o):o(i))}catch(a){return Promise.reject(a)}};C._addP13nItem=function(t,r){return u.fetchModel(r).then(function(e){return C._addFlexItem(t,r,e.getMetaModel(),undefined)}).catch(function(t){e.error("Model could not be resolved",t);return null})};C.fetchPropertiesForEntity=function(e,t,n){var o=t.getObject(e);var a=n.isA("sap.ui.mdc.filterbar.vh.FilterBar")?true:undefined;if(!n||!o){return[]}var l=c.createConverterContext(n,e);var d=i.getEntitySetPath(e);var g=c.getConvertedFilterFields(n,e,a);var m=[];g.forEach(function(e){if(e.annotationPath){var n=s.getLocationForPropertyPath(t,e.annotationPath);var i=e.annotationPath.replace("".concat(n,"/"),"");if(r.isPropertyFilterable(t,n,L(i),true)){m.push(e)}}else{m.push(e)}});var P=[];var y=h(m,l);var F=[];y.forEach(function(e){if(e.key){F.push(e.key)}});m=m.filter(function(e){return F.includes(e.key)});var C=r.getFilterRestrictionsByPath(d,t),b=C.FilterAllowedExpressions;Object.keys(y).forEach(function(e){var n=y[e];var i=m[e];if(!i||!i.conditionPath){return}var o=L(i.conditionPath);n=Object.assign(n,{group:i.group,groupLabel:i.groupLabel,path:i.conditionPath,tooltip:null,removeFromAppState:false,hasValueHelp:false});if(i.annotationPath){var a=i.annotationPath;var l=t.getObject(a),c=t.getObject("".concat(a,"@")),f=t.createBindingContext(a);var d=c["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||c["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||c["@com.sap.vocabularies.Analytics.v1.Measure"];var p=s.getLocationForPropertyPath(t,i.annotationPath);var g=a.replace("".concat(p,"/"),"");var h;var P;if(r.isPropertyFilterable(t,p,L(g),true)){h=c["@com.sap.vocabularies.Common.v1.FilterDefaultValue"];if(h){P=h["$".concat(u.getModelType(l.$Type))]}n=Object.assign(n,{tooltip:c["@com.sap.vocabularies.Common.v1.QuickInfo"]||undefined,removeFromAppState:d,hasValueHelp:v(f.getObject(),{context:f}),defaultFilterConditions:P?[{fieldPath:i.conditionPath,operator:"EQ",values:[P]}]:undefined})}}if(n){if(b[o]&&b[o].length>0){n.filterExpression=r.getSpecificAllowedExpression(b[o])}else{n.filterExpression="auto"}n=Object.assign(n,{visible:i.availability==="Default"})}y[e]=n});y.forEach(function(e){if(e.path==="$editState"){e.label=f.getText("FILTERBAR_EDITING_STATUS")}e.typeConfig=p.getTypeConfig(e.dataType,e.formatOptions,e.constraints);e.label=u.getLocalizedText(e.label,n)||"";if(e.isParameter){P.push(e.name)}});m=y;u.setCustomData(n,"parameters",P);return m};function B(e,t){if(e.isA("sap.fe.macros.table.TableAPI")){var r=e.getMetaPath().split("#")[0].split("/");switch(r[r.length-1]){case"@".concat("com.sap.vocabularies.UI.v1.SelectionPresentationVariant"):case"@".concat("com.sap.vocabularies.UI.v1.PresentationVariant"):return t.getObject(e.getMetaPath()).Visualizations.find(function(e){return e.$AnnotationPath.includes("@".concat("com.sap.vocabularies.UI.v1.LineItem"))}).$AnnotationPath;case"@".concat("com.sap.vocabularies.UI.v1.LineItem"):var n=e.getMetaPath().split("/");return n[n.length-1]}}return undefined}C._addFlexItem=function(e,t,r,n,o){var a=n?n.getId(t):t.getId(),l=n?"":"Adaptation",f=c.getConvertedFilterFields(t,null,undefined,r,o,n,n?undefined:B(t.getParent(),r)),d=C._findSelectionField(f,e),p=L(e),g=!!n&&n.targets==="xmlTree";if(e===b){return D(a,r,n)}else if(e===x){return Promise.resolve(null)}else if(d&&d.template){return C._templateCustomFilter(t,E(a,"".concat(l,"FilterField")),d,r,n)}if(d.type==="Slot"&&n){return F(t,n,p)}var v=s.getNavigationPath(p);var m=d.annotationPath;var h;var P;var y;var I;var S;return Promise.resolve().then(function(){if(d.isParameter){return m.substr(0,m.lastIndexOf("/")+1)}return u.getCustomData(t,"entityType",n)}).then(function(e){h=e;return u.getCustomData(t,"useSemanticDateRange",n)}).then(function(e){P=e;var o=r.createBindingContext(h+p);var a=n?n.getId(t):t.getId();y={bindingContexts:{contextPath:r.createBindingContext(h),property:o},models:{contextPath:r,property:r},isXML:g};I="/".concat(i.getEntitySetPath(h).split("/").filter(i.filterOutNavPropBinding).join("/"));S={sPropertyName:p,sBindingPath:I,sValueHelpType:l+M,oControl:t,oMetaModel:r,oModifier:n,sIdPrefix:E(a,"".concat(l,"FilterField"),v),sVhIdPrefix:E(a,l+M),sNavigationPrefix:v,bUseSemanticDateRange:P,oSettings:d?d.settings:{},visualFilter:d?d.visualFilter:undefined};return u.doesValueHelpExist(S)}).then(function(e){if(!e){return A(y,S)}return Promise.resolve()}).then(function(){return T(y,S)})};function w(e){if(e instanceof window.Element){return null}return u.getCustomData(e,I)}function _(e,t){if(e instanceof window.Element){return}u.setCustomData(e,I,t)}function j(e,t,r){var n=w(r);var i;if(!n){n=C.fetchPropertiesForEntity(e,t,r);n.forEach(function(e){i=null;if(e.groupLabel){i=u.getLocalizedText(e.groupLabel,r);e.groupLabel=i===null?e.groupLabel:i}});n.sort(function(e,t){if(e.groupLabel===undefined||e.groupLabel===null){return-1}if(t.groupLabel===undefined||t.groupLabel===null){return 1}return e.groupLabel.localeCompare(t.groupLabel)});_(r,n)}return n}C.fetchProperties=function(e){var t=u.getCustomData(e,"entityType");return u.fetchModel(e).then(function(r){if(!r){return[]}return j(t,r.getMetaModel(),e)})};C.getTypeUtil=function(){return p};return C},false);
//# sourceMappingURL=FilterBarDelegate.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/controls/filterbar/utils/VisualFilterUtils","sap/fe/core/templating/FilterHelper","sap/fe/macros/CommonHelper","sap/fe/macros/filter/FilterUtils","sap/ui/core/Core","sap/ui/mdc/condition/Condition","sap/fe/core/type/TypeUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,r,a,i,n,o,s,l,f,u){"use strict";var g=r.getFiltersConditionsFromSelectionVariant;var d={selectionChanged:function(r){var a=r.getSource();var i=a.data("outParameter");var n=a.data("dimension");var s=a.data("dimensionText");var l=a.data("multipleSelectionAllowed");var f=a.data("dimensionType");var u=r.getParameter("bar")||r.getParameter("point")||r.getParameter("segment");var g=r.getParameter("selected");var d=a.getModel("$field");var p=d.getProperty("/conditions");if(!i||i!==n){e.error("VisualFilter: Cannot sync values with regular filter as out parameter is not configured properly!")}else{var v=u.getBindingContext().getObject(i);if(v){var c=u.getBindingContext().getObject(s);if(typeof c!=="string"&&!(c instanceof String)){c=undefined}if(g){if(l==="false"){p=[]}if(f==="Edm.DateTimeOffset"){v=t._parseDateTime(v)}var m=o.createItemCondition(v,c||undefined,{},{});p.push(m)}else{p=p.filter(function(e){if(f==="Edm.DateTimeOffset"){return e.operator!=="EQ"||Date.parse(e.values[0])!==Date.parse(v)}return e.operator!=="EQ"||e.values[0]!==v})}d.setProperty("/conditions",p)}else{e.error("VisualFilter: No vaue found for the outParameter")}}},getAggregationSelected:function(e){var r;var a=[];if(!this.getBindingContext()){return}for(var i=0;i<=e.length-1;i++){var n=e[i];if(n.operator==="EQ"){a.push(n.values[0])}}var o=this.getParent();var s=o.data("dimension");var l=o.data("dimensionType");var f=(r=this.getBindingContext())===null||r===void 0?void 0:r.getObject(s);if(l==="Edm.DateTimeOffset"){f=t._parseDateTime(f)}return a.indexOf(f)>-1},getFiltersFromConditions:function(){for(var e=arguments.length,r=new Array(e),o=0;o<e;o++){r[o]=arguments[o]}var d=this.getParent();var p=d.getParent().getParent().getParent().getParent();var v=d.data("inParameters").customData;var c=d.data("draftSupported")==="true";var m=p.getPropertyInfo();var h={};var y=[];var P;var E=[];var T=d.data("parameters").customData;var F=a.parseCustomData(d.data("selectionVariantAnnotation"));var C=d.getBinding("bars")||d.getBinding("points")||d.getBinding("segments");var L=C.getPath();var _=d.getModel().getMetaModel();var b=C.getPath();var O=g(b,_,F,t.getCustomConditions.bind(t));for(var S in m){m[S].typeConfig=s.getTypeConfig(m[S].dataType,{},{})}var I=t.convertFilterCondions(O);Object.keys(I).forEach(function(e){h[e]=I[e];var r=v.find(function(t){return t.valueListProperty===e});var a=r?r.localDataProperty:e;if(!T||T&&T.indexOf(e)===-1){for(var i in m){var n=m[i];if(a===n.name){if(n.typeConfig.baseType==="DateTime"){if(h[e]){h[e].forEach(function(e){e.values[0]=t._formatDateTime(e.values[0])})}}y.push({name:e,typeConfig:n.typeConfig})}}}});v.forEach(function(e,a){if(r[a].length>0){h[e.valueListProperty]=r[a];if(!T||T&&T.indexOf(e.valueListProperty)===-1){for(var i in m){var n=m[i];if(n.name===e.localDataProperty){if(n.typeConfig.baseType==="DateTime"){if(h[e.valueListProperty]){h[e.valueListProperty].forEach(function(e){e.values[0]=t._formatDateTime(e.values[0])})}}y.push({name:e.valueListProperty,typeConfig:n.typeConfig})}}}}});var D=d.getBindingContext("internal");var M=d.data("infoPath");var V;var R=n.getLibraryResourceBundle("sap.fe.macros");var x=a.parseCustomData(d.data("requiredProperties"));if(x.length){var A=Object.keys(h)||[];var w=[];x.forEach(function(e){if(A.indexOf(e)===-1){w.push(e)}});if(!w.length){V=D.getProperty("".concat(M,"/showError"));D.setProperty(M,{errorMessageTitle:"",errorMessage:"",showError:false})}else if(w.length>1){D.setProperty(M,{errorMessageTitle:R.getText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"),errorMessage:R.getText("M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF"),showError:true});return}else{var B=_.getObject("".concat(b,"/").concat(w[0],"@com.sap.vocabularies.Common.v1.Label"))||w[0];D.setProperty(M,{errorMessageTitle:R.getText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"),errorMessage:R.getText("M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_SINGLEVF",B),showError:true});return}}else{V=D.getProperty("".concat(M,"/showError"));D.setProperty(M,{errorMessageTitle:"",errorMessage:"",showError:false})}var j=p.data("entityType").split("/")[1];var U=L.split("/")[1].split("(")[0];if(T&&T.length&&j===U){var k=V?i.getBindingPathForParameters(p,h,m,T):undefined;if(k){C.sPath=k}}if(T&&T.length){T.forEach(function(e){if(h[e]){delete h[e]}})}Object.keys(h).forEach(function(e){h[e].forEach(function(e){if(e.values.length>1){e.values=e.values.slice(0,1)}})});if(Object.keys(h).length>0&&y.length){P=l.getFilterInfo(p,h,y,[]).filters;if(P){if(!P.aFilters){E.push(P)}else if(P.aFilters){E=P.aFilters}}}if(c){E.push(new f("IsActiveEntity",u.EQ,true))}if(E&&E.length>0){C.filter(E)}else if(!Object.keys(h).length){C.filter()}if(V&&C.isSuspended()){C.resume()}return E},getFilterCounts:function(e){if(e.length>0){return"(".concat(e.length,")")}else{return undefined}},scaleVisualFilterValue:function(e,r,a,i,n){if(r){return t.getFormattedNumber(n,r,a)}else if(i){return t.getFormattedNumber(n,undefined,undefined,i)}else if(a>0){a=a>2?2:a;return t.getFormattedNumber(n,undefined,a)}else{return e}},fireValueHelp:function(e){e.getSource().getParent().getParent().getParent().fireValueHelpRequest()}};return d},true);
//# sourceMappingURL=VisualFilterRuntime.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/converters/controls/Common/DataVisualization","sap/fe/core/converters/ManifestSettings","sap/fe/core/converters/MetaModelConverter","sap/fe/core/formatters/TableFormatter","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/UIFormatters","sap/fe/macros/CommonHelper","sap/fe/macros/field/FieldTemplating","sap/fe/macros/internal/helpers/ActionHelper","sap/fe/macros/table/TableSizeHelper"],function(e,t,a,n,i,o,r,l,s,c,u,d,v,g){"use strict";var f=d.formatValueRecursively;var p=c.getEditMode;var b=s.getTargetObjectPath;var m=s.getContextRelativeTargetObjectPath;var h=r.generate;var A=n.getInvolvedDataModelObjects;var O=a.TemplateType;var y=t.getUiControl;var T=l.CreationMode;var $={_isStaticAction:function(e,t){var a;if(e){if(Array.isArray(e)){var n=this._getActionOverloadEntityType(t);if(n){a=e.find(function(e){return e.$IsBound&&e.$Parameter[0].$Type===n})}else{a=e[0]}}else{a=e}}return!!a&&a.$IsBound&&a.$Parameter[0].$isCollection},_getActionOverloadEntityType:function(e){if(e&&e.indexOf("(")>-1){var t=e.split("(");return t[t.length-1].replaceAll(")","")}return undefined},_isActionOverloadOnDifferentType:function(e,t){var a=this._getActionOverloadEntityType(e);return!!a&&t!==a},getMessageForDraftValidation:function(e){var t,a;var n=e.collection.getObject("./@");var i=(t=n["@com.sap.vocabularies.Common.v1.Messages"])===null||t===void 0?void 0:t.$Path;if(i&&((a=e.tableDefinition)===null||a===void 0?void 0:a.getProperty("/template"))===O.ObjectPage&&!!Object.keys(n).find(function(e){var t;var a=n[e];return a&&a.$Type==="com.sap.vocabularies.Common.v1.SideEffectsType"&&!a.SourceProperties&&!a.SourceEntities&&((t=a.TargetProperties)===null||t===void 0?void 0:t.indexOf(i))>-1})){return i}return""},getFieldsRequestedByPresentationVariant:function(e){var t;return((t=e.RequestAtLeast)===null||t===void 0?void 0:t.map(function(e){return e.value}))||[]},getNavigationAvailableFieldsFromLineItem:function(e){var t=[];(e.getObject()||[]).forEach(function(e){var a;if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"&&!e.Inline&&!e.Determining&&(a=e.NavigationAvailable)!==null&&a!==void 0&&a.$Path){t.push(e.NavigationAvailable.$Path)}});return t},getNavigationAvailableMap:function(e){var t={};e.forEach(function(e){var a="".concat(e.SemanticObject,"-").concat(e.Action);if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"&&!e.Inline&&e.RequiresContext){if(e.NavigationAvailable!==undefined){t[a]=e.NavigationAvailable.$Path?e.NavigationAvailable.$Path:e.NavigationAvailable}}});return JSON.stringify(t)},getUiLineItem:function(e){return y(e,"@com.sap.vocabularies.UI.v1.LineItem")},create$Select:function(e){var t=e.collection;var a=[];var n=$.getUiLineItem(e.metaPath);var i=u.getTargetCollection(t);function o(e){if(e&&!a.includes(e)&&e.indexOf("/")!==0){a.push(e)}}function r(e){if(e&&e.length){e.forEach(o)}}if(!e.tableDefinition.getObject("enableAnalytics")&&n.getPath().indexOf("@com.sap.vocabularies.UI.v1.LineItem")>-1){var l,s,c,d;var v=A(e.metaPath).targetObject;var g=(e.tableDefinition.getObject("operationAvailableProperties")||"").split(",");var f=$._filterNonApplicableProperties(g,t);var p=(t.getObject("".concat(i,"/@com.sap.vocabularies.Common.v1.SemanticKey"))||[]).map(function(e){return e.$PropertyPath});if((v===null||v===void 0?void 0:v.$Type)==="com.sap.vocabularies.UI.v1.PresentationVariantType"){r($.getFieldsRequestedByPresentationVariant(v))}r($.getNavigationAvailableFieldsFromLineItem(n));r(f);r(p);o($.getMessageForDraftValidation(e));o((l=t.getObject("".concat(i,"@Org.OData.Capabilities.V1.DeleteRestrictions")))===null||l===void 0?void 0:(s=l.Deletable)===null||s===void 0?void 0:s.$Path);o((c=t.getObject("".concat(i,"@Org.OData.Capabilities.V1.UpdateRestrictions")))===null||c===void 0?void 0:(d=c.Updatable)===null||d===void 0?void 0:d.$Path)}return a.join(",")},getColumnWidth:function(e,t,a,n,i,o,r,l,s,c,u){var d,v=false;if(t.width){return t.width}else if(c.targetObject.Value&&p(c.targetObject.Value.$target,c,false,false,c.targetObject)==="Display"){v=a&&a.hasOwnProperty("@com.sap.vocabularies.Common.v1.Text");if(o==="Edm.Stream"&&!v&&a.hasOwnProperty("@Org.OData.Core.V1.MediaType")&&a["@Org.OData.Core.V1.MediaType"].includes("image/")){d="7em"}}else if(a&&(a.hasOwnProperty("@com.sap.vocabularies.UI.v1.IsImageURL")&&a.hasOwnProperty("@com.sap.vocabularies.UI.v1.IsImageURL")===true||a.hasOwnProperty("@Org.OData.Core.V1.MediaType")&&a["@Org.OData.Core.V1.MediaType"].includes("image/"))){d="7em"}else if(n==="com.sap.vocabularies.UI.v1.DataFieldForAction"||n==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||n==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"&&l.Target.$AnnotationPath.indexOf("@com.sap.vocabularies.UI.v1.FieldGroup")===-1){var f;var b,m;if(s&&s.length>=l.Label.length){b=g.getButtonWidth(s)}else if(l){b=g.getButtonWidth(l.Label)}else{b=g.getButtonWidth(a.Label)}if(r){m=r*2}if(m&&!isNaN(m)&&m>b){d="".concat(m,"em")}else if(s||a&&(a.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||a.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction")){b+=2;d="".concat(b,"em")}if(l!==null&&l!==void 0&&(f=l.Target)!==null&&f!==void 0&&f.$AnnotationPath&&l.Target.$AnnotationPath.indexOf("@com.sap.vocabularies.UI.v1.Chart")!==-1){var h;switch(this.getChartSize(e,t)){case"XS":h=5;break;case"S":h=5.2;break;case"M":h=6.3;break;case"L":h=7.9;break;default:h=6}b+=2;if(!this.getShowOnlyChart(e,t)&&u&&(u.Title.length||u.Description.length)){var A=u.Title.length>u.Description.length?u.Title:u.Description;var O=g.getButtonWidth(A)+7;var y=O>b?O:b;d="".concat(y,"em")}else if(b>h){d="".concat(b,"em")}else{d="".concat(h,"em")}}}if(d){return d}},getMarginClass:function(e,t,a,n){var i,o="";if(JSON.stringify(e[e.length-1])==JSON.stringify(t)){if(a=="com.sap.vocabularies.UI.v1.VisualizationType/Rating"){o="sapUiNoMarginBottom sapUiNoMarginTop"}}else if(a==="com.sap.vocabularies.UI.v1.VisualizationType/Rating"){o="sapUiNoMarginTop"}else{o="sapUiTinyMarginBottom"}if(n&&n!=="true"&&n!=="false"){var r=n.substring(n.indexOf("{=")+2,n.lastIndexOf("}"));i="{= "+r+" ? '"+o+"' : "+"''"+" }";return i}else{return o}},getVBoxVisibility:function(e,t){var a=true;var n=false;var r=[];for(var l=0;l<e.length;l++){var s=e[l]["@com.sap.vocabularies.UI.v1.Hidden"];if(s!==undefined&&s!==false){if(s!==true){if(s.$Path){r.push(s.$Path);a=false}else if(typeof s==="object"){n=true;break}}else{r.push(s)}}else{r.push(false)}}if(!n&&r.length>0&&a!==true){var c=r.map(function(e){if(typeof e==="boolean"){return e}else{return o.pathInModel(e)}});return o.compileExpression(o.formatResult(c,i.getVBoxVisibility))}else if(n){return t}else if(r.length>0&&r.indexOf(false)===-1&&a){return false}else{return true}},formatHiddenFilters:function(e){if(e){try{return JSON.stringify(e)}catch(e){return undefined}}return undefined},getColumnStableId:function(e,t){return e?h([e,"C",t.Target&&t.Target.$AnnotationPath||t.Value&&t.Value.$Path||(t.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||t.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"?t:"")]):undefined},getFieldGroupLabelStableId:function(e,t){return e?h([e,"FGLabel",t.Target&&t.Target.$AnnotationPath||t.Value&&t.Value.$Path||(t.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||t.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"?t:"")]):undefined},_filterNonApplicableProperties:function(e,t){return e&&e.filter(function(e){return t.getObject("./".concat(e))})},getRowsBindingInfo:function(e){var t=A(e.collection,e.contextPath);var a=m(t)||b(t);var n={ui5object:true,suspended:false,path:u.addSingleQuotes(a),parameters:{$count:true},events:{}};if(!e.tableDefinition.getObject("enableAnalytics")){var i=$.create$Select(e);if(i){n.parameters.$select="'".concat(i,"'")}n.parameters.$$getKeepAliveContext=true}n.parameters.$$groupId=u.addSingleQuotes("$auto.Workers");n.parameters.$$updateGroupId=u.addSingleQuotes("$auto");n.parameters.$$ownRequest=true;n.parameters.$$patchWithoutSideEffects=true;n.events.patchSent=u.addSingleQuotes(".editFlow.handlePatchSent");n.events.dataReceived=u.addSingleQuotes("API.onInternalDataReceived");n.events.dataRequested=u.addSingleQuotes("API.onInternalDataRequested");n.events.createActivate=u.addSingleQuotes(".editFlow.handleCreateActivate");if(e.onContextChange!==undefined&&e.onContextChange!==null){n.events.change=u.addSingleQuotes(e.onContextChange)}return u.objectToString(n)},validateCreationRowFields:function(e){if(!e){return false}return Object.keys(e).length>0&&Object.keys(e).every(function(t){return e[t]["validity"]})},pressEventDataFieldForActionButton:function(e,t,a,n,i,o,r,l){var s=t.Action,c=e&&e.collection.getObject("$Type"),d=this._isStaticAction(i,s)||this._isActionOverloadOnDifferentType(s,c),g={contexts:!d?"${internal>selectedContexts}":null,bStaticAction:d?d:undefined,entitySetName:u.addSingleQuotes(a),applicableContext:!d?"${internal>dynamicActions/"+t.Action+"/aApplicable/}":null,notApplicableContext:!d?"${internal>dynamicActions/"+t.Action+"/aNotApplicable/}":null,isNavigable:o,enableAutoScroll:r,defaultValuesExtensionFunction:l?"'"+l+"'":undefined};return v.getPressEventDataFieldForActionButton(e.id,t,g,n)},isDataFieldForActionEnabled:function(t,a,n,i,o,r){var l=a.Action,s=t&&t.collection.getObject("$Type"),c=t&&t.tableDefinition&&t.tableDefinition.getObject(),u=this._isStaticAction(o,l),d=c&&c.enableAnalytics;if(!i&&this._isActionOverloadOnDifferentType(l,s)){var g=c&&JSON.parse(c.operationAvailableMap);if(g&&g.hasOwnProperty(l)){return"{= ${internal>dynamicActions/"+l+"/bEnabled} }"}return true}if(!n||u){if(i){var f=t.collection.getPath();var p=t.collection.getModel();if(r==="false"&&!d){e.warning("NavigationAvailable as false is incorrect usage");return false}else if(!d&&a&&a.NavigationAvailable&&a.NavigationAvailable.$Path&&p.getObject(f+"/$Partner")===a.NavigationAvailable.$Path.split("/")[0]){return"{= ${"+r.substr(r.indexOf("/")+1,r.length)+"}"}else{return true}}return true}var b="",m,h;if(i){if(r==="true"||d){b="%{internal>numberOfSelectedContexts} >= 1"}else if(r==="false"){e.warning("NavigationAvailable as false is incorrect usage");return false}else{m="%{internal>numberOfSelectedContexts} >= 1";h="${internal>ibn/"+a.SemanticObject+"-"+a.Action+"/bEnabled"+"}";b=m+" && "+h}}else{m=v.getNumberOfContextsExpression(r);h="${internal>dynamicActions/"+a.Action+"/bEnabled"+"}";b=m+" && "+h}return"{= "+b+"}"},pressEventForCreateButton:function(e,t){var a=e.creationMode;var n;var i=t?"${$source>}.getParent()":"${$source>}.getParent().getParent().getParent()";var o=i+".getRowBinding() || "+i+".data('rowsBindingInfo').path";switch(a){case T.External:n={creationMode:u.addSingleQuotes(T.External),outbound:u.addSingleQuotes(e.createOutbound)};break;case T.CreationRow:n={creationMode:u.addSingleQuotes(T.CreationRow),creationRow:"${$source>}",createAtEnd:e.createAtEnd!==undefined?e.createAtEnd:false};o="${$source>}.getParent()._getRowBinding()";break;case T.NewPage:case T.Inline:n={creationMode:u.addSingleQuotes(a),createAtEnd:e.createAtEnd!==undefined?e.createAtEnd:false,tableId:u.addSingleQuotes(e.id)};if(e.createNewAction){n.newAction=u.addSingleQuotes(e.createNewAction)}break;case T.InlineCreationRows:return u.generateFunction("._editFlow.scrollAndFocusOnInactiveRow",i);default:return undefined}return u.generateFunction(".editFlow.createDocument",o,u.objectToString(n))},getIBNData:function(e){var t=e.createOutboundDetail;if(t){var a={semanticObject:u.addSingleQuotes(t.semanticObject),action:u.addSingleQuotes(t.action)};return u.objectToString(a)}},pressEventForDeleteButton:function(e,t,a,n){var i="${internal>deletableContexts}";var r,l,s,c,d,v;if(a!==null&&a!==void 0&&a.Title){if(typeof a.Title.Value==="string"){s=u.addSingleQuotes(a.Title.Value)}else{var g;r=o.getExpressionFromAnnotation(a===null||a===void 0?void 0:(g=a.Title)===null||g===void 0?void 0:g.Value);if(o.isConstant(r)||o.isPathInModelExpression(r)){l=f(r,n);s=o.compileExpression(l)}}}if(a!==null&&a!==void 0&&a.Description){if(typeof a.Description.Value==="string"){v=u.addSingleQuotes(a.Description.Value)}else{var p;c=o.getExpressionFromAnnotation(a===null||a===void 0?void 0:(p=a.Description)===null||p===void 0?void 0:p.Value);if(o.isConstant(c)||o.isPathInModelExpression(c)){d=f(c,n);v=o.compileExpression(d)}}}var b={id:u.addSingleQuotes(e.id),entitySetName:u.addSingleQuotes(t),numberOfSelectedContexts:"${internal>selectedContexts}.length",unSavedContexts:"${internal>unSavedContexts}",lockedContexts:"${internal>lockedContexts}",controlId:"${internal>controlId}",title:s,description:v};return u.generateFunction(".editFlow.deleteMultipleDocuments",i,u.objectToString(b))},handleTableDeleteEnablementForSideEffects:function(e,t){if(e&&t){var a=$.getDeletablePathForTable(e),n=e.getSelectedContexts(),i=[];t.setProperty("deleteEnabled",false);for(var o=0;o<n.length;o++){if(typeof a==="string"&&a!==undefined){var r=n[o];if(r&&r.getProperty(a)){t.setProperty("deleteEnabled",true);i.push(r)}}}t.setProperty("deletableContexts",i)}},getDeletablePathForTable:function(e){var t;var a=e.getRowBinding();if(a){var n,i;var o=e.getModel().getMetaModel();var r=a.getPath();var l=(n=a.getContext())===null||n===void 0?void 0:n.getPath();if(l){var s,c;var u=o.getMetaPath(l);var d=(s=o.getObject(u))===null||s===void 0?void 0:(c=s["$NavigationPropertyBinding"])===null||c===void 0?void 0:c[r];if(d!==undefined){r="/".concat(d)}}t=(i=o.getObject("".concat(r,"@Org.OData.Capabilities.V1.DeleteRestrictions/Deletable")))===null||i===void 0?void 0:i.$Path}return t},setHeaderLabelVisibility:function(e,t){if(!t){if(e.$Type.indexOf("DataFieldForAction")>-1&&e.Inline){return false}if(e.$Type.indexOf("DataFieldForIntentBasedNavigation")>-1&&e.Inline){return false}return true}return t.some(function(e){if((e.$Type==="com.sap.vocabularies.UI.v1.DataField"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation")&&e["@com.sap.vocabularies.UI.v1.Hidden"]!==true){return true}})},getValueOnRatingField:function(e,t){if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"){if(t.context.getObject("Target/$AnnotationPath").indexOf("@com.sap.vocabularies.UI.v1.DataPoint")>-1&&t.context.getObject("Target/$AnnotationPath/$Type")=="com.sap.vocabularies.UI.v1.DataPointType"&&t.context.getObject("Target/$AnnotationPath/Visualization/$EnumMember")=="com.sap.vocabularies.UI.v1.VisualizationType/Rating"){return t.context.getObject("Target/$AnnotationPath/TargetValue")}if(t.context.getObject("Target/$AnnotationPath").indexOf("@com.sap.vocabularies.UI.v1.FieldGroup")>-1){var a="Target/$AnnotationPath/Data/";for(var n in t.context.getObject(a)){if(t.context.getObject("".concat(a+n,"/$Type"))==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"&&t.context.getObject("".concat(a+n,"/Target/$AnnotationPath")).indexOf("@com.sap.vocabularies.UI.v1.DataPoint")>-1&&t.context.getObject("".concat(a+n,"/Target/$AnnotationPath/$Type"))=="com.sap.vocabularies.UI.v1.DataPointType"&&t.context.getObject("".concat(a+n,"/Target/$AnnotationPath/Visualization/$EnumMember"))=="com.sap.vocabularies.UI.v1.VisualizationType/Rating"){return t.context.getObject("".concat(a+n,"/Target/$AnnotationPath/TargetValue"))}}}}},getTextOnActionField:function(e,t){if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){return e.Label}if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"&&t.context.getObject("Target/$AnnotationPath").indexOf("@com.sap.vocabularies.UI.v1.FieldGroup")>-1){var a="Target/$AnnotationPath/Data/";var n=[];for(var i in t.context.getObject(a)){if(t.context.getObject("".concat(a+i,"/$Type"))==="com.sap.vocabularies.UI.v1.DataFieldForAction"||t.context.getObject("".concat(a+i,"/$Type"))==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){n.push(t.context.getObject("".concat(a+i,"/Label")))}}if(n.length>1){return n.reduce(function(e,t){return e.length>t.length?e:t})}else{return n.length===0?undefined:n.toString()}}},_getResponsiveTableColumnSettings:function(e,t){if(e.tableType==="ResponsiveTable"){return t.settings}return null},getChartSize:function(e,t){var a=this._getResponsiveTableColumnSettings(e,t);if(a&&a.microChartSize){return a.microChartSize}return"XS"},getShowOnlyChart:function(e,t){var a=this._getResponsiveTableColumnSettings(e,t);if(a&&a.showMicroChartLabel){return!a.showMicroChartLabel}return true},getDelegate:function(e,t,a){var n;if(t==="true"){n={name:e?"sap/fe/macros/table/delegates/AnalyticalALPTableDelegate":"sap/fe/macros/table/delegates/ALPTableDelegate",payload:{collectionName:a}}}else{n={name:e?"sap/fe/macros/table/delegates/AnalyticalTableDelegate":"sap/fe/macros/table/delegates/TableDelegate"}}return JSON.stringify(n)},setIBNEnablement:function(e,t,a){for(var n in t){e.setProperty("ibn/".concat(n),{bEnabled:false,aApplicable:[],aNotApplicable:[]});var i=[],o=[];var r=t[n];for(var l=0;l<a.length;l++){var s=a[l];if(s.getObject(r)){e.getModel().setProperty("".concat(e.getPath(),"/ibn/").concat(n,"/bEnabled"),true);i.push(s)}else{o.push(s)}}e.getModel().setProperty("".concat(e.getPath(),"/ibn/").concat(n,"/aApplicable"),i);e.getModel().setProperty("".concat(e.getPath(),"/ibn/").concat(n,"/aNotApplicable"),o)}}};$.getNavigationAvailableMap.requiresIContext=true;$.getValueOnRatingField.requiresIContext=true;$.getTextOnActionField.requiresIContext=true;return $},false);
//# sourceMappingURL=TableHelper.js.map
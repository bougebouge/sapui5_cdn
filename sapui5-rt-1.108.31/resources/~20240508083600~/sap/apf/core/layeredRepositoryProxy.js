/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/apf/core/constants","sap/apf/utils/hashtable","sap/apf/abap/LrepConnector","sap/apf/utils/parseTextPropertyFile","sap/ui/thirdparty/jquery"],function(e,a,n,t,i,jQuery){"use strict";sap.apf.core.LayeredRepositoryProxy=function(e,a){var n=a.instances.coreApi;var t;var i=a.instances.messageHandler;var r="sap/apf/dt";var o="text.properties";var s=new sap.apf.utils.Hashtable(a.instances.messageHandler);var c=new sap.apf.utils.Hashtable(a.instances.messageHandler);var f;var u=false;this.getConnector=function(){return t};this.readEntity=function(e,a,n,r,o,s,c){var f=n[0].value;var u=T(o);var p=[];var l=false;var d=1;var m=0;var A;var S;var O;var b;var E;var P;var x;var N;var j=h(s);var I;i.check(e==="configuration","layered repository proxy - only read entity of configuration supported");if(c&&c.noMetadata){t.getStaticResource(u,f,"apfconfiguration").then(function(e){O={Application:o};N=e.response;if(typeof N==="string"){O.SerializedAnalyticalConfiguration=N}else{O.SerializedAnalyticalConfiguration=JSON.stringify(N)}O.AnalyticalConfiguration=f;a(O,C())},function(e){a(undefined,C(),y({code:"5221",aParameters:[o,f]},e&&e.messages))});return}if(r===undefined||r.indexOf("SerializedAnalyticalConfiguration")>=0){l=true;if(j==="VENDOR"){var U={contentType:"application/json"};var D=[];D.push({name:"layer",value:j});D.push({name:"dt",value:"true"});var H="/sap/bc/lrep/content/"+u+"/"+f+".apfconfiguration";H+=t._buildParams(D);I=t.send(H,"GET",undefined,U)}else{I=t.getStaticResource(u,f,"apfconfiguration")}p.push(I)}else{d=0}A=v(o,f);if(A===undefined){var M=t.getFileAttributes(u,f,"apfconfiguration",j);p.push(M)}S=Promise.all(p);S.then(function(e){A=v(o,f);if(A===undefined){A=e[d].response}g(o,f,A);O=F(o,A);if(l){N=e[m].response;if(typeof N==="string"){O.SerializedAnalyticalConfiguration=N}else{O.SerializedAnalyticalConfiguration=JSON.stringify(N)}}O.AnalyticalConfiguration=f;if(r&&r.length!==0){E=r.length;P={};for(b=0;b<E;b++){x=r[b];P[x]=O[x]}O=P}a(O,C())},function(e){a(undefined,C(),y({code:"5221",aParameters:[o,f]},e&&e.messages))})};this.doChangeOperationsInBatch=function(e,a,n){function t(e,n){a(n)}var i,r;function o(){}O(n).then(function(){for(i=0;i<e.length;i++){r=e[i];r.application=n;if(r.method==="DELETE"&&r.entitySetName==="texts"){A(r,o)}else if(r.method==="POST"&&sap.apf.utils.isValidPseudoGuid(r.data.TextElement)){b(r.data,o)}else{b(r.data,o)}}E(n,t,true)}).fail(function(e){a(e)})};this.readCollectionsInBatch=function(e,a){var n=e.length;var t=[];var i=0;function r(e){function r(r,o,s){if(s){a(undefined,s)}else{i++;t[e]=r;if(i===n){a(t)}}}return r}for(var o=0;o<n;o++){var s=e[o];this.readCollection(s.entitySetName,r(o),s.inputParameters,s.selectList,s.filter)}};this.readCollection=function(e,a,n,t,r,o){var c,f;var u;var p;if(o&&o.layer){p=o.layer}else{p="CUSTOMER"}var l=function(e,n){if(n&&(n==="error"||n==="timeout"||n==="abort"||n==="parsererror")){a(undefined,C(),y({code:"5222",aParameters:[f]},[n]));return}var t=new sap.apf.utils.Hashtable(i);var r=[];var o=e&&e.response||e&&e.responseText||"";var c=sap.apf.utils.parseTextPropertyFile(o,{instances:{messageHandler:i}});var u,p;if(c.Messages.length>0){u=i.createMessageObject({code:"5416"});p=u;c.Messages.forEach(function(e){p.setPrevious(e);p=e})}t=new sap.apf.utils.Hashtable(i);c.TextElements.forEach(function(e){if(e.TextElement){t.setItem(e.TextElement,e);r.push(e)}});s.setItem(f,t);a(r,C(),u)};if(e==="application"){i.check(!n&&!t&&!r,"unsupported parameters when calling readCollection for application");L(a,p)}else if(e==="texts"){c=r.getFilterTermsForProperty("Application");f=c[0].getValue();u=S(f,o);u.then(function(e){l(e)},function(e){a(undefined,C(),y({code:"5222",aParameters:[f]},e&&e.messages))})}else if(e==="configuration"){c=r.getFilterTermsForProperty("Application");f=c[0].getValue();P(f,a,t)}};this.remove=function(e,a,n,t,r,o){if(!o){o="CUSTOMER"}if(e==="application"){M(a,n,o)}else if(e==="configuration"){U(a,n,r,o)}else{i.check(false,"the remove operation on entity set "+e+" is currently not supported by the lrep proxy")}};this.create=function(e,a,n,t){if(e==="application"){D(a,n,t)}else if(e==="configuration"){I(a,n,t)}else if(e==="texts"){b(a,n)}else{i.check(false,"the create operation on entity set "+e+" is currently not supported by the lrep proxy")}};this.update=function(e,a,n){if(e==="configuration"){j(a,n)}else if(e==="application"){H(a,n)}else{i.check(false,"the update operation on entity set "+e+" is currently not supported by the lrep proxy")}};function p(e,a){var n={async:true,contentType:"application/json"};var i=[];i.push({name:"layer",value:e});i.push({name:"deep-read",value:true});i.push({name:"metadata",value:true});i.push({name:"type",value:a});var o="/sap/bc/lrep/content/"+r+"/";o+=t._buildParams(i);return t.send(o,"GET",undefined,n)}function l(e){var a=e.ns.split("/");return a[a.length-2]}function d(e,a){var n=undefined;e.metadata.forEach(function(e){if(e.name===a){n=e.value}});return n}this.readAllConfigurationsFromVendorLayer=function(){var e=jQuery.Deferred();var a=[];p("VENDOR","apf*").then(function(n){var t={};n.response.forEach(function(e){if(e.fileType&&e.fileType==="apfapplication"){t[l(e)]=d(e,"apfdt-applname")}});n.response.forEach(function(e){var n;var i;var r;if(e.fileType&&e.fileType==="apfconfiguration"){n=l(e);i=e.name;if(!(sap.apf.utils.isValidPseudoGuid(n)&&sap.apf.utils.isValidPseudoGuid(i))){return}r=d(e,"apfdt-configname");a.push({configurationText:r,applicationText:t[n],value:n+"."+i})}});e.resolve(a)},function(a){e.reject(y({code:"5231"},a&&a.messages))});return e.promise()};m();function m(){if(a.constructors&&a.constructors.LrepConnector){t=a.constructors.LrepConnector.createConnector()}else{t=sap.apf.abap.LrepConnector.createConnector()}if(!t._sClient){t._sClient=n.getStartParameterFacade().getSapClient()}}function v(e,a){var n=c.getItem(e);if(n===undefined){return undefined}a=n.getItem(a);return a}function g(e,a,n){var t=c.getItem(e);if(t===undefined){t=new sap.apf.utils.Hashtable(i)}t.setItem(a,n);c.setItem(e,t)}function h(e){var a=e&&e.layer||"CUSTOMER";if(a==="ALL"){return undefined}return a}function y(e,a){var n=i.createMessageObject(e);var t="";if(a){a.forEach(function(e){t=t+e+" "});n.setPrevious(i.createMessageObject({code:5220,aParameters:[t]}))}return n}function C(){return{}}function T(e){return r+"/"+e}function A(e,a){var n=e.application;var t=e.inputParameters[0].value;var i;O(n).done(function(){i=s.getItem(n);i.removeItem(t);a(e,C())}).fail(function(e){a(undefined,C(),e)})}function S(e,a){var n;var i=[];var s="/sap/bc/lrep/content/";var c=h(a);s+=r+"/"+e+"/"+o;if(c){i.push({name:"layer",value:c})}n={contentType:"text/plain"};s+=t._buildParams(i);return t.send(s,"GET",undefined,n)}function O(e){var a=jQuery.Deferred();var n;var t=s.getItem(e);var r=function(n){var r=n&&n.response||n&&n.responseText||"";var o=sap.apf.utils.parseTextPropertyFile(r,{instances:{messageHandler:i}});t=new sap.apf.utils.Hashtable(i);o.TextElements.forEach(function(e){if(e.TextElement){t.setItem(e.TextElement,e)}});s.setItem(e,t);a.resolve({})};if(t===undefined){n=S(e);n.then(function(e){r(e)},function(n){a.reject(y({code:"5222",aParameters:[e]},n&&n.messages))})}else{a.resolve({})}return a.promise()}function b(e,a){var n=e.Application;if(e.TextElement===undefined||!sap.apf.utils.isValidGuid(e.TextElement)){e.TextElement=sap.apf.utils.createPseudoGuid()}O(n).done(function(){var t=s.getItem(n);t.setItem(e.TextElement,e);a(e,C())}).fail(function(e){a(undefined,C(),e)})}function E(e,a,n){var r=T(e);var o;function c(){var n=sap.apf.utils.renderHeaderOfTextPropertyFile(e,i);n=n+sap.apf.utils.renderTextEntries(o,i);var s=t.upsert(r,"text","properties","CUSTOMER",n,"text/plain");s.then(function(){a(C())},function(n){a(C(),y({code:"5230",aParameters:[e]},n&&n.messages))})}o=s.getItem(e);if(!o){a(C());return}if(n){c()}else{var f=S(e);f.then(function(e){var a=e&&e.response||"";var n=sap.apf.utils.parseTextPropertyFile(a,{instances:{messageHandler:i}});n.TextElements.forEach(function(e){if(e.TextElement){o.setItem(e.TextElement,e)}});c()},function(n){a(C(),y({code:"5222",aParameters:[e]},n&&n.messages))})}}function P(e,a,n){var i=[];var r=T(e);var o=t._buildParams([{name:"layer",value:"CUSTOMER"},{name:"metadata",value:"true"},{name:"type",value:"apfconfiguration"}]);var s=t.send("/sap/bc/lrep/content/"+r+o);s.then(function(o){var s=o.response;s.forEach(function(a){if(a.fileType==="apfconfiguration"){a.metadata.forEach(function(n){if(n.name==="apfdt-configname"){i.push({AnalyticalConfiguration:a.name,Application:e,AnalyticalConfigurationName:n.value})}})}});if(n&&n.indexOf("SerializedAnalyticalConfiguration")>=0){var c=[];i.forEach(function(e){var a=jQuery.Deferred();c.push(a);t.getStaticResource(r,e.AnalyticalConfiguration,"apfconfiguration").then(function(n){if(n.response){e.SerializedAnalyticalConfiguration=JSON.stringify(n.response);a.resolve()}else{a.reject()}},function(e){a.reject(e)})});jQuery.when.apply(jQuery,c).then(function(){a(i,C())},function(n){a([],C(),y({code:"5223",aParameters:[e]},n&&n.messages))})}else{a(i,C())}},function(n){a([],C(),y({code:"5223",aParameters:[e]},n&&n.messages))})}function x(){var e=jQuery.Deferred();var a=[];if(u){e.resolve(f)}else{a.push({name:"dt",value:false});var n="/sap/bc/lrep/content/sap/ui/fl/settings/main.flsettings";n+=t._buildParams(a);var i=t.send(n,"GET",undefined);i.then(function(a){var n=a&&a.response||{};u=true;if(n.isAtoEnabled===true){f="ATO_NOTIFICATION"}e.resolve(f)},function(a){e.reject(a)})}return e.promise()}function N(e,a,n,i){var r=i||"CUSTOMER";var o=T(e);var s=t.getFileAttributes(o,a,"apfconfiguration",r);s.then(function(t){var i=t.response;if(r==="CUSTOMER"){g(e,a,i);E(e,n)}else{n(C())}},function(t){n(C(),y({code:"5232",aParameters:[e,a]},t&&t.messages))})}function j(e,a,n){if(!n){n="CUSTOMER"}var i=e.Application;var r=e.AnalyticalConfiguration;var o=JSON.parse(e.SerializedAnalyticalConfiguration);var s=T(i);var c=x();c.then(function(c){var f=t.getStaticResource(s,"metadata","apfapplication");f.then(function(a){var f={Application:i,ApplicationName:a.response.ApplicationName,SemanticObject:a.response.SemanticObject,AnalyticalConfiguration:r,AnalyticalConfigurationName:e.AnalyticalConfigurationName,CreationUTCDateTime:e.CreationUTCDateTime,LastChangeUTCDateTime:e.LastChangeUTCDateTime};o=jQuery.extend(true,o,{configHeader:f});o=JSON.stringify(o);var u=t.upsert(s,r,"apfconfiguration",n,o,"application/json",c);return u},function(e){a(C(),y({code:"5233",aParameters:[i,r]},e&&e.messages))}).then(function(){N(i,r,a,n)},function(e){a(C(),y({code:"5233",aParameters:[i,r]},e&&e.messages))})},function(e){a(C(),y({code:"5224"},e&&e.messages))})}function I(e,a,n){var i=h(n);var r=e.Application;var o=e.AnalyticalConfiguration;if(o===undefined||!sap.apf.utils.isValidGuid(o)){o=sap.apf.utils.createPseudoGuid(32)}var s=JSON.parse(e.SerializedAnalyticalConfiguration);var c=T(r);var f=t.getStaticResource(c,"metadata","apfapplication");f.then(function(n){var t={Application:r,ApplicationName:n.response.ApplicationName,SemanticObject:n.response.SemanticObject,AnalyticalConfiguration:o,AnalyticalConfigurationName:s.analyticalConfigurationName,CreationUTCDateTime:e.CreationUTCDateTime,LastChangeUTCDateTime:e.LastChangeUTCDateTime};s=jQuery.extend(true,s,{configHeader:t});s=JSON.stringify(s);u(r,o,e.AnalyticalConfigurationName,s,a)},function(e){a(undefined,C(),y({code:"5223",aParameters:[r]},e&&e.messages))});function u(a,n,r,o,s){var c=T(a);var f=x();f.then(function(r){var f=t.upsert(c,n,"apfconfiguration",i,o,"application/json",r);f.then(function(){N(a,n,function(a,t){if(!t){s({AnalyticalConfiguration:n,AnalyticalConfigurationName:e.AnalyticalConfigurationName},C())}else{s(undefined,C(),t)}},i)},function(e){s(undefined,C(),y({code:"5226",aParameters:[a,n]},e&&e.messages))})},function(e){s(undefined,C(),y({code:"5224"},e&&e.messages))})}}function U(e,a,n,r){var o=e[0].value;i.check(o!==undefined,"configuration may not be undefined");i.check(n!==undefined,"application of configuration not found");var s=T(n);x().then(function(e){var i=t.deleteFile(s,o,"apfconfiguration",r,e);i.then(function(){a(C())},function(e){a(C(),y({code:"5225",aParameters:[n,o]},e&&e.messages))})},function(e){a(C(),y({code:"5224"},e&&e.messages))})}function F(e,a){var n;var t={Application:e};var i,r;for(n=0;n<a.length;n++){i=a[n].name;r=a[n].value;if(i==="apfdt-applname"){i="ApplicationName"}else if(i==="createdAt"){i="CreationUTCDateTime"}else if(i==="createdBy"){i="CreatedByUser"}else if(i==="lastChangedAt"){i="LastChangeUTCDateTime"}else if(i==="lastChangedBy"){i="LastChangedByUser"}else if(i==="apfdt-configname"){i="AnalyticalConfigurationName"}else if(i==="size"||i==="layer"){continue}t[i]=r}return t}function D(e,a,n){i.check(e.ApplicationName!==undefined&&e.ApplicationName!=="","Valid application name is required");var r=e.Application;if(r===undefined||!sap.apf.utils.isValidGuid(r)){r=sap.apf.utils.createPseudoGuid(32)}var o=JSON.stringify({ApplicationName:e.ApplicationName,SemanticObject:e.SemanticObject,Application:r});var c=sap.apf.utils.renderHeaderOfTextPropertyFile(r,i);var f=h(n);function u(e){a(undefined,C(),y({code:"5227"},e&&e.messages))}var p=T(r);var l=t.upsert(p,"metadata","apfapplication",f,o,"application/json");l.then(function(){var n=t.upsert(p,"text","properties",f,c,"text/plain");n.then(function(){s.setItem(r,new sap.apf.utils.Hashtable(i));a({Application:r,ApplicationName:e.ApplicationName,SemanticObject:e.SemanticObject},C())},u)},u)}function H(e,a){i.check(e.ApplicationName!==undefined&&e.ApplicationName!=="","Valid application name is required");var n=e.Application;var r=JSON.stringify({ApplicationName:e.ApplicationName,SemanticObject:e.SemanticObject,Application:n});function o(e){a(undefined,y({code:"5228",aParameters:[n]},e&&e.messages))}var s=T(n);var c=t.upsert(s,"metadata","apfapplication","CUSTOMER",r,"application/json");c.then(function(){a({Application:n,ApplicationName:e.ApplicationName,SemanticObject:e.SemanticObject})},o)}function M(e,a,n){var i=e[0].value;function r(e){var n=R(e);a(C(),n)}var o=T(i);var s=t.listContent(o,n);s.then(function(e){var n=e.response;var i=[];n.forEach(function(e){if(e.fileType==="apfconfiguration"){x().then(function(a){i.push(t.deleteFile(o,e.name,e.fileType,e.layer,a))},function(e){a(C(),y({code:"5224"},e&&e.messages))})}else{i.push(t.deleteFile(o,e.name,e.fileType,e.layer))}});var r=Promise.all(i);return r},r).then(function(){a(C())},r)}function R(e){var a;if(e&&e.messageObject&&e.messageObject.getCode){a=e.messageObject}else if(e&&e.response&&e.response.statusCode&&e.response.statusCode>=400){a=i.createMessageObject({code:"11005",aParameters:[e.response.statusCode.toString(),e.response.statusText]})}else{a=i.createMessageObject({code:"5201",aParameters:e&&e.messages||[]})}return a}function L(e,a){var n=[];p(a,"apfapplication").then(function(a){var t=a.response;t.forEach(function(e){var a;var t;if(e.fileType&&e.fileType==="apfapplication"){a=l(e);if(!sap.apf.utils.isValidPseudoGuid(a)){return}var i="";t=d(e,"apfdt-applname");n.push({Application:a,ApplicationName:t,SemanticObject:i})}});e(n,C())},t);function t(a){e(undefined,C(),y({code:"5229"},a&&a.messages))}}}});
//# sourceMappingURL=layeredRepositoryProxy.js.map
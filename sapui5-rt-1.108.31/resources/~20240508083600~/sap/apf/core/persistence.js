/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/constants"],function(e){"use strict";function t(t){var a;this.createPath=function(e,a,n){var i;var c=r(n);u().then(function(a){i={data:{AnalysisPath:"",AnalysisPathName:e,LogicalSystem:a,ApplicationConfigurationURL:t.functions.getComponentName(),SerializedAnalysisPath:JSON.stringify(n),StructuredAnalysisPath:JSON.stringify(c)},method:"POST"};if(t.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){i.data.AnalyticalConfiguration=t.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId}s(i,o)},function(e){a({oResponse:undefined,status:"failed"},{},e)});function o(e,s,n){if(n){a({oResponse:e,status:"failed"},s,n)}else{t.instances.messageHandler.check(e&&e.data&&e.statusCode===201,"Persistence create Path - proper response");a({AnalysisPath:e.data.AnalysisPath,status:"successful"},s,n)}}};this.readPaths=function(e){var a={method:"GET"};s(a,n.bind(this));function n(a,s,n){if(!n&&a&&a.data&&a.data.results){for(var i in a.data.results){a.data.results[i].StructuredAnalysisPath=JSON.parse(a.data.results[i].StructuredAnalysisPath)}}else if(!n||a.statusCode!==200){n=t.instances.messageHandler.createMessageObject({code:"5211"})}if(n){e({oResponse:a,status:"failed"},s,n)}else{e({paths:a.data.results,status:"successful"},s,n)}}};this.deletePath=function(e,a){var n={method:"DELETE"};s(n,i.bind(this),e);function i(e,s,n){if(e.statusCode!==204&&!n){n=t.instances.messageHandler.createMessageObject({code:5201});n.setPrevious(t.instances.messageHandler.createMessageObject({code:5200,aParameters:[e.statusCode,e.statusText]}))}if(n){a({oResponse:e,status:"failed"},s,n)}else{a({status:"successful"},s,n)}}};this.modifyPath=function(e,a,n,i){var c=r(i);u().then(function(n){var r={data:{AnalysisPath:e,AnalysisPathName:a,LogicalSystem:n,ApplicationConfigurationURL:t.functions.getComponentName(),SerializedAnalysisPath:JSON.stringify(i),StructuredAnalysisPath:JSON.stringify(c)},method:"PUT"};if(t.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){r.data.AnalyticalConfiguration=t.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId}s(r,o.bind(this),e)},function(e){n({oResponse:undefined,status:"failed"},{},e)});function o(a,s,i){if(a.statusCode!==204&&!i){i=t.instances.messageHandler.createMessageObject({code:5201});i.setPrevious(t.instances.messageHandler.createMessageObject({code:5200,aParameters:[a.statusCode,a.statusText]}))}if(i){n({oResponse:a,status:"failed"},s,i)}else{n({AnalysisPath:e,status:"successful"},s,i)}}};this.openPath=function(e,a){var n={method:"GET"};s(n,i,e);function i(e,s,n){var i;if(!n&&e&&e.statusCode===200&&e.data&&e.data.SerializedAnalysisPath){e.data.SerializedAnalysisPath=JSON.parse(e.data.SerializedAnalysisPath)}if(n){i=t.instances.messageHandler.createMessageObject({code:"5210"});i.setPrevious(n);t.instances.messageHandler.putMessage(i)}a({path:e.data,status:"successful"},s)}};function s(e,a,s){var r=function(e,t){c().done(function(e){a(t,e,undefined)})};var o=function(e){var s;if(e.messageObject&&e.messageObject.getCode&&e.messageObject.getCode()===5021){c().done(function(t){a(e,t,e.messageObject)});return}var n=i(e.response.body);if(n!==undefined){s=t.instances.messageHandler.createMessageObject({code:n})}if(e.response.body.match("274")){s=t.instances.messageHandler.createMessageObject({code:"5207"})}if(e.response.statusCode===400){s=t.instances.messageHandler.createMessageObject({code:"5203"})}if(e.response.statusCode===403){s=t.instances.messageHandler.createMessageObject({code:"5206"})}if(e.response.statusCode===405){s=t.instances.messageHandler.createMessageObject({code:"5202"})}if(e.response.statusCode===404){s=t.instances.messageHandler.createMessageObject({code:"5208"})}if(!s&&e.response.statusCode===500){s=t.instances.messageHandler.createMessageObject({code:"5200",aParameters:[e.response.statusCode,e.response.statusText]})}if(!s){s=t.instances.messageHandler.createMessageObject({code:"5201"})}t.instances.messageHandler.putMessage(s);c().done(function(t){a(e,t,s)})};t.instances.coreApi.getPersistenceConfiguration().done(function(i){var d=i.path.service+"/"+i.path.entitySet;t.instances.coreApi.getXsrfToken(i.path.service).done(function(i){e.headers={"x-csrf-token":i};switch(e.method){case"GET":if(!e.data&&s){e.requestUri=d+"('"+s+"')";t.instances.coreApi.odataRequest(e,r,o)}else if(!e.data&&!s){n().then(function(a){e.requestUri=d+a;t.instances.coreApi.odataRequest(e,r,o)},function(e){c().done(function(t){a({},t,e)})})}break;case"POST":if(e.data&&!s){e.requestUri=d}t.instances.coreApi.odataRequest(e,r,o);break;case"DELETE":if(!e.data&&s){e.requestUri=d+"('"+s+"')"}t.instances.coreApi.odataRequest(e,r,o);break;case"PUT":if(e.data&&s){e.requestUri=d+"('"+s+"')"}t.instances.coreApi.odataRequest(e,r,o);break;default:t.instances.coreApi.odataRequest(e,r,o);break}})})}function n(){var e=jQuery.Deferred();u().then(function(a){var s="";if(t.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){s="AnalyticalConfiguration%20eq%20'"+t.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId+"'%20and%20"}var n="?$select=AnalysisPath,AnalysisPathName,StructuredAnalysisPath,CreationUTCDateTime,LastChangeUTCDateTime&$filter=("+s+"LogicalSystem%20eq%20'"+a+"'%20and%20"+"ApplicationConfigurationURL%20eq%20'"+t.functions.getComponentName()+"')"+"&$orderby=LastChangeUTCDateTime%20desc";e.resolve(n)},function(t){e.fail(t)});return e.promise()}function i(e){var t=e.match("52[0-9]{2}");if(t){return t[0]}return undefined}function r(e){var t=[];var a=e.path.steps;var s;for(var n in a){t.push({stepId:a[n].stepId,selectedRepresentationId:a[n].binding.selectedRepresentationId})}s={steps:t,indexOfActiveStep:e.path.indicesOfActiveSteps[0]};return s}function c(){var e=jQuery.Deferred();t.instances.coreApi.getPersistenceConfiguration().done(function(a){t.instances.coreApi.getEntityTypeMetadata(a.path.service,a.path.entitySet).done(function(t){e.resolve(t)})});return e}function o(e){var t=e&&e.getFilterTermsForProperty("SAPClient");if(t===undefined||t.length!==1){return undefined}return t[0].getValue()}function d(s,n){t.instances.coreApi.getPersistenceConfiguration().done(function(i){var r=t.instances.messageHandler;var c=i.logicalSystem;if(!c){a=n;s.resolve(n);return s.promise()}var o=c.service;var d=c.entitySet||c.entityType;if(o===null){a=n;s.resolve(n);return s.promise()}if(d===undefined){d=e.entitySets.logicalSystem}t.instances.coreApi.getMetadata(o).done(function(e){t.instances.coreApi.getXsrfToken(o).done(function(i){var c=new sap.apf.core.utils.Filter(r,"SAPClient","eq",n);var u=t.instances.coreApi.getUriGenerator().getAbsolutePath(o);u=u+t.instances.coreApi.getUriGenerator().buildUri(r,d,["LogicalSystem"],c,undefined,undefined,undefined,undefined,undefined,"Results",e);var f={requestUri:u,method:"GET",headers:{"x-csrf-token":i}};var l=function(e){var t;if(e&&e.results&&e.results instanceof Array&&e.results.length===1&&e.results[0].LogicalSystem){a=e.results[0].LogicalSystem;s.resolve(a)}else{t=r.createMessageObject({code:"5026",aParameters:[n]});s.fail(t)}};var g=function(e){var t=r.createMessageObject({code:"5026",aParameters:[n]});if(e.messageObject!==undefined&&e.messageObject.type==="messageObject"){t.setPrevious(e.messageObject)}s.fail(t)};t.instances.coreApi.odataRequest(f,l,g)})})})}function u(){var e=jQuery.Deferred();if(a){e.resolve(a);return e.promise()}var s=t.instances.coreApi.getStartParameterFacade().getSapClient();if(s){d(e,s);return e.promise()}t.instances.coreApi.getCumulativeFilter().done(function(t){s=o(t);if(!s){e.resolve("")}else{d(e,s)}});return e.promise()}}sap.apf.core.Persistence=t;return{constructor:t}},true);
//# sourceMappingURL=persistence.js.map
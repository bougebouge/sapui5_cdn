/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filter","sap/apf/utils/hashtable","sap/apf/core/messageHandler","sap/apf/core/messageDefinition","sap/apf/core/odataProxy","sap/apf/core/layeredRepositoryProxy","sap/apf/cloudFoundry/runtimeProxy","sap/apf/core/constants","sap/apf/utils/startParameter","sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(e,a,t,i,s,o,n,r,c,p,jQuery){"use strict";sap.apf.core.ResourcePathHandler=function(e){var a=this;var t=e.instances.coreApi;var i=e.instances.messageHandler;var s=new sap.apf.utils.Hashtable(i);var o;var n;var r=null;var c=jQuery.Deferred();var p=false;var u;this.loadConfigFromFilePath=function(a){if(p){return}p=true;var s=t.getStartParameterFacade().getAnalyticalConfigurationId();var o=a;t.ajax({url:o,dataType:"json",success:n,error:function(e,a,t){var s=i.createMessageObject({code:"5068",aParameters:[o,a,t]});x(s)},async:true,suppressSapSystem:true});function n(t,o,n){var r=e.functions.checkForTimeout(n);var c;if(r){c=i.createMessageObject({code:"5054",aParameters:[a]});c.setPrevious(r);x(c)}if(!t||!t.applicationConfiguration){x(i.createMessageObject({code:"5055",aParameters:[a]}))}if(t.applicationConfiguration.textResourceLocations===undefined){x(i.createMessageObject({code:"5056",aParameters:[a]}));return}S(t,s);v().done(function(){if(s){l(s)}else{g()}})}};function f(){return t.getStartParameterFacade().isLrepActive()}function l(a){var s=a.applicationId;var r=a.configurationId;if(f()&&!s){x(i.createMessageObject({code:"5024"}))}var p=new u({serviceRoot:n&&n.path&&n.path.service,entityTypes:{configuration:sap.apf.core.constants.entitySets.configuration,texts:sap.apf.core.constants.entitySets.texts}},{instances:{coreApi:t,messageHandler:i},manifests:e.manifests});if(f()){var l=[];var g=jQuery.Deferred();l.push(g);l.push(d(s,p))}p.readEntity("configuration",function(e,a,n){if(n){x(i.createMessageObject({code:"5022",aParameters:[r]}));c.resolve()}else{var u=JSON.parse(e.SerializedAnalyticalConfiguration);t.loadAnalyticalConfiguration(u);if(u.applicationTitle){o.appName=u.applicationTitle.key;o.appTitle=u.applicationTitle.key}if(f()){g.resolve()}else{s=s||e.Application;d(s,p).then(function(){c.resolve()})}}},[{name:"AnalyticalConfiguration",value:r}],undefined,s,{layer:"ALL"},{noMetadata:true});if(f()){jQuery.when.apply(jQuery,l).then(function(){c.resolve()})}}function d(e,a){var s=jQuery.Deferred();var o=new sap.apf.core.utils.Filter(i,"Application","eq",e);var n=new sap.apf.core.utils.Filter(i,"Language","eq",sap.apf.core.constants.developmentLanguage);n.addAnd(o);var r=["TextElement","TextElementDescription"];a.readCollection("texts",function(e,a,o){if(o){x(i.createMessageObject({code:"5023",aParameters:[t.getStartParameterFacade().getAnalyticalConfigurationId()]}))}else{t.loadTextElements(e)}s.resolve()},undefined,r,n,{layer:"ALL"});return s.promise()}function g(){var e=a.getResourceLocation(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation);var s;if(e!==""){t.ajax({url:e,dataType:"json",success:function(a,n,r){if(a){t.loadAnalyticalConfiguration(a);if(a.applicationTitle){o.appName=a.applicationTitle.key;o.appTitle=a.applicationTitle.key}c.resolve()}else{s=i.createMessageObject({code:"5057",aParameters:[e]});x(s)}},error:function(a,t,o,n){s=i.createMessageObject({code:"5057",aParameters:[e]});if(n){s.setPrevious(n)}x(s)},async:true,suppressSapSystem:true})}else{s=i.createMessageObject({code:"5060"});x(s)}}function v(){t.loadMessageConfiguration(sap.apf.core.messageDefinition,true);return m(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,false)}function m(s,o){var n=jQuery.Deferred();var r=a.getResourceLocation(s);if(r!==""){t.ajax({url:r,dataType:"json",success:c,error:function(e,a,t,s){var o=i.createMessageObject({code:"5058",aParameters:[a,t,r]});if(s){o.setPrevious(s)}x(o)},async:true,suppressSapSystem:true})}else{n.resolve()}return n.promise();function c(a,s,r){var c;var p=e.functions.checkForTimeout(r);if(!p){if(a.messageConfiguration){t.loadMessageConfiguration(a.messageConfiguration.definitions,o)}}else{c=i.createMessageObject({code:"5067"});c.setPrevious(p);x(c)}n.resolve()}}function y(e){var a;if(!e||!e.path){a=i.createMessageObject({code:"5066"});x(a)}if(!e.path.service){a=i.createMessageObject({code:"5067"});x(a)}if(e.analyticalConfiguration){if(!e.analyticalConfiguration.service){a=i.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service or entity set are missing in analytical configuration in the application configuration"});x(a)}}}function L(e){var a;if(e.evaluations&&!e.evaluations.service){a=i.createMessageObject({code:"5063"});x(a)}if(e.evaluations&&(!e.evaluations.type||e.evaluations.type!=="smartBusinessRequest")){a=i.createMessageObject({code:"5062",rawText:"type in Smart Business configuration is not smartBusinessRequest"});x(a)}if(e.evaluations&&!e.evaluations.entityType){a=i.createMessageObject({code:"5061"});x(a)}}this.getResourceLocation=function(e){return s.getItem(e)};this.getPersistenceConfiguration=function(){var e=jQuery.Deferred();c.done(function(){e.resolve(n)});return e};this.getConfigurationProperties=function(){var a=jQuery.Deferred();e.corePromise.done(function(){a.resolve(o)});return a};function P(){var a=sap.apf.core.utils.uriGenerator;var s,o,n;var r=e.manifests.manifest;var p=e.manifests.baseManifest;var u;if(c.state()==="resolved"){return}var f=a.getBaseURLOfComponent(sap.apf.utils.getComponentNameFromManifest(e.manifests.baseManifest));var d=a.getBaseURLOfComponent(sap.apf.utils.getComponentNameFromManifest(e.manifests.manifest));if(r["sap.app"].dataSources&&r["sap.app"].dataSources.PathPersistenceServiceRoot){n=r["sap.app"].dataSources.PathPersistenceServiceRoot.uri}else if(e.functions.isUsingCloudFoundryProxy()){n=""}else{u=i.createMessageObject({code:"5064"});x(u)}var m=p["sap.app"].i18n;if(typeof m==="string"){m=a.addRelativeToAbsoluteURL(f,m)}else if(typeof m==="object"){m=a.addRelativeToAbsoluteURL(f,m.bundleUrl)}var y=r["sap.app"].i18n;if(typeof y==="string"){y=a.addRelativeToAbsoluteURL(d,y)}else if(typeof y==="object"){y=a.addRelativeToAbsoluteURL(d,y.bundleUrl)}var L=r["sap.app"].title;var P=sap.apf.utils.createPseudoGuid();t.registerTextWithKey(P,L);var C=t.getStartParameterFacade().getAnalyticalConfigurationId();var T="";if(r["sap.app"].dataSources&&r["sap.app"].dataSources.AnalyticalConfigurationLocation&&r["sap.app"].dataSources.AnalyticalConfigurationLocation.uri){T=r["sap.app"].dataSources.AnalyticalConfigurationLocation.uri;T=a.addRelativeToAbsoluteURL(d,T)}if(!C&&!T){u=i.createMessageObject({code:"5065"});x(u)}var b={appName:P,appTitle:P,analyticalConfigurationLocation:T,textResourceLocations:{apfUiTextBundle:m,applicationUiTextBundle:y},persistence:{path:{service:n}}};if(r["sap.apf"]&&r["sap.apf"].appSpecificParameters){for(s in r["sap.apf"].appSpecificParameters){b[s]=r["sap.apf"].appSpecificParameters[s]}}if(r["sap.app"].dataSources&&r["sap.app"].dataSources.SmartBusiness){o=r["sap.app"].dataSources.SmartBusiness.uri;b.smartBusiness={runtime:{service:o}}}if(r["sap.app"].dataSources&&r["sap.app"].dataSources.LogicalSystem){b.persistence.logicalSystem={service:r["sap.app"].dataSources.LogicalSystem.uri}}S({applicationConfiguration:b},C);v().done(function(){if(C){l(C)}else{g()}})}function C(){var e=t.getUriGenerator().getApfLocation();s.setItem(sap.apf.core.constants.resourceLocation.apfUiTextBundle,e+"resources/i18n/apfUi.properties");s.setItem(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,"");s.setItem(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle,"");s.setItem(sap.apf.core.constants.resourceLocation.applicationUiTextBundle,"");s.setItem(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation,"")}function S(a,t){function c(e){o=jQuery.extend(true,{},e);delete o.type;delete o.analyticalConfigurationLocation;delete o.applicationMessageDefinitionLocation;delete o.textResourceLocations;delete o.persistence}var p=a.applicationConfiguration;c(p);var u=a.applicationConfiguration.textResourceLocations;n=a.applicationConfiguration.persistence;if(!e.functions.isUsingCloudFoundryProxy()){y(n);if(!n.path.entitySet){n.path.entitySet=sap.apf.core.constants.entitySets.analysisPath}}if(a.applicationConfiguration.smartBusiness){r=a.applicationConfiguration.smartBusiness;L(r)}var f;var l;var d;for(d in sap.apf.core.constants.resourceLocation){if(!sap.apf.core.constants.resourceLocation.hasOwnProperty(d)){continue}if(d===sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation&&t){continue}if(p[d]!==undefined){l=p[d]}else if(u[d]!==undefined){l=u[d]}else{continue}if(e.manifests){s.setItem(d,l)}else if(d===sap.apf.core.constants.resourceLocation.apfUiTextBundle||e.instances.fileExists.check(l,true)){s.setItem(d,l)}else if(!t){f=i.createMessageObject({code:"5059",aParameters:[l,d]});x(f)}}}function x(e){i.putMessage(e)}function T(){var t;var i;var s;jQuery.when(c).done(function(){t=a.getResourceLocation(sap.apf.core.constants.resourceLocation.apfUiTextBundle);i=a.getResourceLocation(sap.apf.core.constants.resourceLocation.applicationUiTextBundle);s=a.getResourceLocation(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle);e.functions.initTextResourceHandlerAsPromise(t,i,s).done(function(){e.corePromise.resolve()})})}C();if(e.constructors&&e.constructors.ProxyForAnalyticalConfiguration){u=e.constructors.ProxyForAnalyticalConfiguration}else if(e.functions.isUsingCloudFoundryProxy()){u=sap.apf.cloudFoundry.RuntimeProxy}else if(f()){u=sap.apf.core.LayeredRepositoryProxy}else{u=sap.apf.core.OdataProxy}if(e.manifests&&e.manifests.manifest){P()}if(e.corePromise){T()}}});
//# sourceMappingURL=resourcePathHandler.js.map
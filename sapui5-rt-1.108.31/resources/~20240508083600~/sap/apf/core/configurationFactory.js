/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/step","sap/apf/core/hierarchicalStep","sap/apf/core/request","sap/apf/utils/hashtable","sap/apf/core/binding","sap/apf/core/representationTypes","sap/apf/core/constants","sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(e,t,n,a,s,r,i,o,jQuery){"use strict";sap.apf.core.ConfigurationFactory=function(e){var t=this;var n;var a=false;var s=jQuery.Deferred();var r=new sap.apf.utils.Hashtable(e.instances.messageHandler);var i=function(t){e.instances.messageHandler.check(t!==undefined&&t.hasOwnProperty("id")!==false,"oItem is undefined or property 'id' is missing",sap.apf.core.constants.message.code.errorCheckConfiguration);if(!r){r=new sap.apf.utils.Hashtable(e.instances.messageHandler)}var n=r.setItem(t.id,t);e.instances.messageHandler.check(n===undefined,"Configuration includes duplicated identifiers (IDs): "+t.id+"",sap.apf.core.constants.message.code.errorCheckConfigurationWarning)};var o=function(t){var n=[];if(!a&&s.state()==="pending"){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5020"}))}if(r.getNumberOfItems()!==0){r.each(function(e,a){if(a.type===t){n.push(a)}});return n}return n};function c(t){if(!sap.apf.core.constants.configurationObjectTypes.hasOwnProperty(t.type)){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5033",aParams:[t.type]}))}if(t.type===sap.apf.core.constants.configurationObjectTypes.facetFilter&&!t.property){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5034"}))}r.setItem(t.id,t)}function f(e){if(e.type===undefined){e.type="step"}i(e)}function p(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"aSteps is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);t.forEach(function(e){f(e)})}function u(e){if(e.type===undefined){e.type="request"}if(e.entitySet){e.entityType=e.entitySet;delete e.entitySet}i(e)}function d(e){if(e.type===undefined){e.type="navigationTarget"}i(e)}function l(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"aRequests is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);t.forEach(function(e){u(e)})}function g(t){function n(){var n=new sap.apf.utils.Hashtable(e.instances.messageHandler);t.representations.forEach(function(a){if(!(a.id&&typeof a.id==="string")){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5028",aParameters:[t.id]}))}if(n.setItem(a.id,a.id)){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5029",aParameters:[t.id]}))}})}if(t.type===undefined){t.type="binding"}e.instances.messageHandler.check(t.id!==undefined,"binding has no id");e.instances.messageHandler.check(t.representations!==undefined&&t.representations instanceof Array!==false,"representations for binding "+t.id+" not defined",sap.apf.core.constants.message.code.errorCheckConfiguration);n();i(t)}function h(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"aBindings is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);t.forEach(function(e){g(e)})}function y(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"navigationTarget is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);t.forEach(function(e){d(e)})}function m(e){r.setItem("configHeader",e)}function v(e){if(e.type===undefined){e.type="category"}i(e)}function H(n){e.instances.messageHandler.check(n!==undefined&&n instanceof Array!==false,"aCategories is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);n.forEach(function(n){var a=n.steps;e.instances.messageHandler.check(a!==undefined&&a instanceof Array!==false,"steps for category "+n.id+" are missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);a.forEach(function(a){e.instances.messageHandler.check(a.type&&(a.type==="step"||a.type==="hierarchicalStep")&&a.id,"step with wrong format assigned to category '"+n.id+"'");e.instances.messageHandler.check(t.existsConfiguration(a.id),"step with id '"+a.id+"' which is assigned to category '"+n.id+"' does not exist")});v(n)})}function b(e){var t=false;var n=sap.apf.core.representationTypes();n.forEach(function(n){if(e===n.id){t=true}});return t}function C(t){var n;if(t.type===undefined){t.type="representationType"}if(!b(t.id)){n=sap.apf.utils.extractFunctionFromModulePathString(t.constructor);if(!jQuery.isFunction(n)){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5030",parameters:[t.id]}))}}i(t)}function k(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"aRepresentationInfo is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);t.forEach(function(e){C(e)})}function T(e){if(e.type===undefined){e.type="smartFilterBar"}c(e)}function F(e){if(e.type===undefined){e.type="facetFilter"}c(e)}function I(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"Facet filter configuration is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);if(t.length===0){r.setItem(sap.apf.core.constants.existsEmptyFacetFilterArray,true);return}t.forEach(F)}function S(t,s,i,o){var c,f,p;function u(e){return e.alias||e.property}function d(e){var t=e.preselectionDefaults&&e.preselectionDefaults.length>0;var n=e.valueList&&e.valueList.length>0;return t||n}function l(e,t,n,a,s){e.metadataProperty=t;F(e);S(n,a,i,s)}function g(e,t){if(sap.apf.utils.isPropertyTypeWithDateSemantics(t)){e.preselectionDefaults=sap.apf.utils.convertDateListToInternalFormat(e.preselectionDefaults,t);e.valueList=sap.apf.utils.convertDateListToInternalFormat(e.valueList,t)}}if(s===t.length){i.resolve();a=false;return}f=t[s];s++;p=u(f);n=n||e.instances.coreApi.getMetadataFacade();var h=o&&Array.prototype.indexOf.call(o,p)>-1;if(h&&d(f)){if(f.valueHelpRequest||f.filterResolutionRequest){if(f.valueHelpRequest){c=r.getItem(f.valueHelpRequest)}else if(f.filterResolutionRequest){c=r.getItem(f.filterResolutionRequest)}n.getPropertyMetadataByEntitySet(c.service,c.entityType,p).done(function(e){g(f,e);l(f,e,t,s,o)})}else{n.getProperty(p).done(function(e){g(f,e);l(f,e,t,s,o)})}}else if(h){if(f.valueHelpRequest||f.filterResolutionRequest){if(f.valueHelpRequest){c=r.getItem(f.valueHelpRequest)}else if(f.filterResolutionRequest){c=r.getItem(f.filterResolutionRequest)}n.getPropertyMetadataByEntitySet(c.service,c.entityType,p).done(function(e){l(f,e,t,s,o)})}else{n.getProperty(p).done(function(e){l(f,e,t,s,o)})}}else{l(f,{},t,s,o)}}function A(t){var s=jQuery.Deferred();n=n||e.instances.coreApi.getMetadataFacade();e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"Facet filter configuration is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);if(t.length===0){r.setItem(sap.apf.core.constants.existsEmptyFacetFilterArray,true);s.resolve();return s.promise()}a=true;n.getAllProperties(function(e){S(t,0,s,e)});return s.promise()}function w(e){k(e)}function R(t,n){function a(t,n){var a=n.getConfigurationById(t.binding).representations;if(a){return a}e.instances.messageHandler.check(false,'Binding of step with ID "'+t.id+'" does not contain any representations.',sap.apf.core.constants.message.code.errorCheckConfigurationWarning)}function s(t,n){var s;var r=[];if(t.binding){s=a(t,n);s.forEach(function(e){var t=jQuery.extend(true,{},n.getConfigurationById(e.representationTypeId));t.representationId=e.id;t.representationLabel=e.label;t.parameter=jQuery.extend(true,{},e.parameter);r.push(t)});return r}e.instances.messageHandler.check(false,'Step with ID "'+t.id+'" does not contain any binding references.',sap.apf.core.constants.message.code.errorCheckConfigurationWarning)}var r=jQuery.extend(true,{},t);var i=s(t,n);delete r.request;delete r.binding;delete r.thumbnail;delete r.longTitle;r.type="stepTemplate";r.getRepresentationInfo=function(){var e=jQuery.extend(true,[],i);e.forEach(function(e){delete e.id;delete e.type;delete e.constructor});return e};return r}var q=function(e,t){var n=this;this.type=e.type;this.id=e.id;this.label=e.label;this.stepTemplates=[];e.steps.forEach(function(e){var a=t.getConfigurationById(e.id);n.stepTemplates.push(new R(a,t))});return this};var M=function(e,t){this.type="thumbnail";if(e===undefined){return this}this.leftUpper=t.createLabel(e.leftUpper);this.rightUpper=t.createLabel(e.rightUpper);this.leftLower=t.createLabel(e.leftLower);this.rightLower=t.createLabel(e.rightLower);this.altTitle=t.createLabel(e.altTitle);return this};this.createThumbnail=function(e){return new M(e,this)};function E(e){this.type="label";this.kind=e.kind;if(this.kind==="text"){this.file=e.file;this.key=e.key}else if(this.kind==="property"){this.property=e.property}else if(this.kind==="sapLabel"){this.labelOf=e.labelOf}}this.createLabel=function(e){return new E(e,this)};this.loadConfig=function(t,n){r=new sap.apf.utils.Hashtable(e.instances.messageHandler);if(t.applicationTitle){r.setItem("applicationTitle",t.applicationTitle)}var a={constructors:{Hashtable:sap.apf.utils.Hashtable},instances:{messageHandler:e.instances.messageHandler}};sap.apf.utils.migrateConfigToCategoryStepAssignment(t,a);var i=sap.apf.core.representationTypes();w(i);p(t.steps);H(t.categories);l(t.requests);h(t.bindings);if(t.representationTypes){k(t.representationTypes)}if(t.smartFilterBar){T(t.smartFilterBar)}if(t.facetFilters){if(n){I(t.facetFilters);s.resolve()}else{A(t.facetFilters).done(function(){s.resolve()})}}else{s.resolve()}if(t.navigationTargets){y(t.navigationTargets)}if(t.configHeader){m(t.configHeader)}return s};this.getConfigurationById=function(e){return r.getItem(e)};this.existsConfiguration=function(e){return r.hasItem(e)};this.getServiceDocuments=function(){var t=o("request");var n=[];t.forEach(function(e){n.push(e.service)});return sap.apf.utils.eliminateDuplicatesInArray(e.instances.messageHandler,n)};this.getNavigationTargets=function(){var e=o("navigationTarget");return jQuery.extend(true,[],e)};this.getStepTemplates=function(){var e=[];var n=o("step");n=jQuery.merge(n,o("hierarchicalStep"));n.forEach(function(n,a){e[a]=new R(n,t)});return e};this.getSmartFilterBarConfiguration=function(){var e=jQuery.Deferred();var t;s.done(function(){t=o("smartFilterBar")[0];if(typeof t==="object"&&t.service&&(t.entityType||t.entitySet)){e.resolve(jQuery.extend(true,{},t))}else{e.resolve()}});return e.promise()};this.getFacetFilterConfigurations=function(){var t=o("facetFilter");var n,a,s;var r=jQuery.extend(true,[],t);for(s=0;s<r.length;s++){a=r[s];if(t[s].metadataProperty&&t[s].metadataProperty.clone){a.metadataProperty=t[s].metadataProperty.clone()}if(a.preselectionFunction){n=sap.apf.utils.extractFunctionFromModulePathString(a.preselectionFunction);if(!jQuery.isFunction(n)){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5035",parameters:[a.id]}));a.preselectionFunction=undefined}else{a.preselectionFunction=n}}}return r};this.getCategories=function(){var e=o("category");var n=[];e.forEach(function(e,a){n[a]=new q(e,t)});return n};this.getConfigHeader=function(){return r.getItem("configHeader")};this.createStep=function(t,n){var a=this.getConfigurationById(t);e.instances.messageHandler.check(a!==undefined&&(a.type==="step"||a.type==="hierarchicalStep"),"Error - referenced object is undefined or has not type step",sap.apf.core.constants.message.code.errorCheckConfiguration);e.instances.messageHandler.check(sap.apf.core.Step!==undefined,"Step must be defined ",sap.apf.core.constants.message.code.errorCheckConfiguration);e.instances.messageHandler.check(typeof sap.apf.core.Step==="function","Step must be constructor function");if(a.type==="hierarchicalStep"){e.instances.messageHandler.check(typeof sap.apf.core.HierarchicalStep==="function","HierarchicalStep must be constructor function");return new sap.apf.core.HierarchicalStep(e.instances.messageHandler,a,this,n,e.instances.coreApi)}return new sap.apf.core.Step(e.instances.messageHandler,a,this,n,e.instances.coreApi)};this.createBinding=function(t,n,a,s){var r=this.getConfigurationById(t);e.instances.messageHandler.check(r!==undefined&&r.type==="binding","Error - oBindingConfig is undefined or has not type binding",sap.apf.core.constants.message.code.errorCheckConfiguration);r.oTitle=n;r.oLongTitle=a;return new sap.apf.core.Binding(e,r,this,s)};this.createRequest=function(n){if(n.entitySet){n.entityType=n.entitySet;delete n.entitySet}var a;var s;if(typeof n==="string"){s=t.getConfigurationById(n);if(!(s!==undefined&&s.type==="request")){a=e.instances.messageHandler.createMessageObject({code:"5004",aParameters:[n]});e.instances.messageHandler.putMessage(a);return undefined}}else{s=n;e.instances.messageHandler.check(s.type&&s.type==="request"&&s.service&&s.entityType,"Wrong request configuration when creating a new request");if(!s.id){a=e.instances.messageHandler.createMessageObject({code:"5004",aParameters:[n]});e.instances.messageHandler.putMessage(a);return undefined}}return new(e&&e.constructors&&e.constructors.Request||sap.apf.core.Request)(e,s)};if(e.constructors&&e.constructors.RegistryProbe){this.getRegistry=function(){return new e.constructors.RegistryProbe(r)}}}});
//# sourceMappingURL=configurationFactory.js.map
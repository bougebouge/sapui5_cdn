sap.ui.define(["sap/apf/utils/trace","sap/apf/core/utils/filter","sap/apf/core/utils/areRequestOptionsEqual","sap/apf/utils/utils","sap/apf/utils/filter","sap/apf/utils/executeFilterMapping","sap/apf/core/constants","sap/apf/core/metadataProperty","sap/ui/thirdparty/jquery"],function(e,t,i,r,n,a,s,o,jQuery){"use strict";function l(t,i,r,n,a){t.check(i!==undefined,"Step: step configuration is missing");t.check(i.binding!==undefined,"No binding assigned to step "+i.id+" in analytical configuration",sap.apf.core.constants.message.code.errorCheckConfiguration);var s=sap.apf.core.constants.representationMetadata.labelDisplayOptions;var o=this;var l,p,u,f;var d={responseData:[]};var g=jQuery.extend(true,{},i);this.type="step";this.title=jQuery.extend(true,{},i.title);this.longTitle=undefined;if(i.longTitle){this.longTitle=jQuery.extend(true,{},i.longTitle)}this.thumbnail=jQuery.extend(true,{},i.thumbnail);this.categories=i.categories;this.destroy=function(){if(l){l.destroy()}p=undefined;u=undefined;f=undefined;l=undefined;o=undefined};this.getRequestConfiguration=function(){return r.getConfigurationById(i.request)};this.getAdditionalConfigurationProperties=function(){return g};this.update=function(t,n){var s;var o=this.getFilter();var d=!t.isEqual(u);var g=l.getRequestOptions(d);var c=!sap.apf.core.utils.areRequestOptionsEqual(f,g);var h=r.getConfigurationById(i.request);e.logCall("Step.update",", bFilterChanged",d,", bRequestOptionsChanged",c);a.getMetadata(h.service).then(function(r){e.log("update  -  in oCoreApi.getMetadata().then()");if(!o.isEmpty()&&!i.topNSettings&&l.getSelectedRepresentation().type==="TableRepresentation"){var a=o.getProperties()[0];var u=[a];var f=r.getPropertyMetadata(h.entityType,a)["sap:text"];if(f){u.push(f)}s={selectionFilter:o,requiredFilterProperties:u}}if(p&&(d||c)){e.log("update() - before sendGetInBatch");p.sendGetInBatch(t,n,g,s)}else{e.log("update() - no request, before callbackAfterRequest");n({},false)}},function(){e.log("update - then.reject() - before callbackAfterRequest");n({},false)});e.logReturn("update")};this.determineFilter=function(e,n){var l;var p;if(this.adjustCumulativeFilter){l=this.adjustCumulativeFilter(e)}if(h()&&this.getFilter().toUrlParam()){var u=r.getConfigurationById(i.filterMapping.requestForMappedFilter);u.selectProperties=i.filterMapping.target.slice();if(i.filterMapping.targetPropertyDisplayOption===s.TEXT||i.filterMapping.targetPropertyDisplayOption===s.KEY_AND_TEXT){a.getMetadata(u.service).done(function(e){var t=e.getPropertyMetadata(u.entityType,u.selectProperties[0]);if(t.text){u.selectProperties.push(t.text)}f.call(this,u)}.bind(this))}else{f.call(this,u)}}else{d.responseData=[];n(this.getFilter(),l)}function f(a){var s=r.createRequest(a);p=e.addAnd(this.getFilter());if(l){p=l.copy().addAnd(this.getFilter())}if(p.isEqual(d.mergedFilter)){n(d.mappedFilter,l)}else{sap.apf.utils.executeFilterMapping(p,s,i.filterMapping.target,g,t)}}function g(e,t,r){if(!t){if(i.filterMapping.keepSource==="true"){e=o.getFilter().addAnd(e)}d.mergedFilter=p;d.mappedFilter=e;d.responseData=r;n(e,l)}}};this.getBinding=function(){return l};this.getFilter=function(){return l.getFilter(this.getContextInfo())};this.getContextInfo=function(){var e=r.getConfigurationById(i.request);var t={entityType:e.entityType,service:e.service};return t};this.setData=function(e,t){var i=!t.isEqual(u);u=t.copy();f=jQuery.extend({},l.getRequestOptions(i));l.setData(e)};this.getRepresentationInfo=function(){return l.getRepresentationInfo()};this.getSelectedRepresentationInfo=function(){return l.getSelectedRepresentationInfo()};this.getSelectedRepresentation=function(){return l.getSelectedRepresentation()};this.setSelectedRepresentation=function(e){l.setSelectedRepresentation(e)};this.getFilterInformation=function(e,t){var n=jQuery.Deferred();var o;if(i.longTitle&&i.longTitle.key){o=a.getTextNotHtmlEncoded(i.longTitle.key)}else{o=a.getTextNotHtmlEncoded(i.title.key)}if(h()&&i.filterMapping.keepSource==="true"){jQuery.when(f(e,o),p(e,o)).then(function(e,t){n.resolve([e,t])})}else if(h()){jQuery.when(p(e,o)).then(function(e){n.resolve([e])})}else{jQuery.when(f(e,o)).then(function(e){n.resolve([e])})}return n;function p(){var e=jQuery.Deferred();var t;if(i.filterMapping.targetPropertyLabelKey){t=a.getTextNotHtmlEncoded(i.filterMapping.targetPropertyLabelKey)}var n=i.filterMapping.target[0];var s=r.getConfigurationById(i.filterMapping.requestForMappedFilter);u(n,s).done(function(i){g(e,n,i,t,s,true)});return e}function u(e,t){var r=jQuery.Deferred();a.getMetadata(t.service).done(function(n){var o;var l=new sap.apf.core.MetadataProperty(n.getPropertyMetadata(t.entityType,e));if(l.text){o=l.text}var p=[];var u=i.filterMapping.targetPropertyDisplayOption;var f=false;d.responseData.forEach(function(t){if(u===s.TEXT&&o){p.push({text:t[o]})}else if(u===s.KEY_AND_TEXT&&o){p.push({text:a.getTextNotHtmlEncoded("keyAndTextSelection",[t[o],sap.apf.utils.convertToExternalFormat(t[e],l)])})}else{p.push({text:t[e]});f=true}});p=sap.apf.utils.sortByProperty(p,"text",l);if(f===true){p.forEach(function(e){e.text=sap.apf.utils.convertToExternalFormat(e.text,l)})}r.resolve(p)});return r}function f(){var e=jQuery.Deferred();var t;var n;var s=r.getConfigurationById(i.binding);var o=r.getConfigurationById(i.request);if(s.requiredFilters&&s.requiredFilters.length===1){t=s.requiredFilters[0];if(s.requiredFilterOptions&&s.requiredFilterOptions.fieldDesc){n=a.getTextNotHtmlEncoded(s.requiredFilterOptions.fieldDesc.key)}}g(e,t,l.getSortedSelections(),n,o,false);return e}function g(i,r,n,s,l,p){var u;var f;if(!s){u=a.getMetadata(l.service)}if(r){f=a.getMetadata(e.getRequestConfiguration().service)}jQuery.when(u,f).then(function(u,f){var d=false;var g;var c=e.getRequestConfiguration().entityType;var h;if(f){h=f.getFilterableProperties(c).concat(f.getParameterEntitySetKeyProperties(c))}if(!s&&u&&r){s=u.getPropertyMetadata(l.entityType,r)["sap:label"]}if(!r){d=true;g=a.getTextNotHtmlEncoded("noSelectionPossible")}else if(h.indexOf(r)===-1){d=true;g=a.getTextNotHtmlEncoded("filterNotApplicable")}else if(n.length===0){d=true;g=a.getTextNotHtmlEncoded("nothingSelected")}i.resolve({text:o,selectablePropertyLabel:s||r,filterValues:n,infoIcon:p,infoText:p?a.getTextNotHtmlEncoded("infoIconfilterMapping"):undefined,warningIcon:d,warningText:g,stepIndex:t})})}};this.serialize=function(){return{stepId:i.id,binding:l.serialize()}};this.deserialize=function(e){l.deserialize(e.binding);t.check(i.id,e.stepId,"sap.apf.core.step.deserialize inconsistent serialization data - id "+e.stepId);return this};this.getAssignedNavigationTargets=function(){return i.navigationTargets};c();function c(){l=r.createBinding(i.binding,undefined,undefined,n);delete g.binding;if(i.request!==undefined&&i.request!==""){p=r.createRequest(i.request);delete g.request}}function h(){if(i.filterMapping){if(i.filterMapping.requestForMappedFilter&&i.filterMapping.target instanceof Array&&i.filterMapping.keepSource){return true}t.putMessage(t.createMessageObject({code:"5104"}))}return false}}sap.apf.core.Step=l;return{constructor:l}},true);
//# sourceMappingURL=step.js.map
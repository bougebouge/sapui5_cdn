/* SAP APF Analysis Path Framework
* 
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
sap.ui.define(["sap/apf/core/constants","sap/apf/ui/utils/formatter","sap/apf/ui/representations/utils/paginationHandler","sap/apf/ui/representations/BaseUI5ChartRepresentation","sap/apf/ui/representations/utils/paginationDisplayOptionHandler","sap/ui/model/Sorter","sap/ui/table/Table","sap/ui/table/Column","sap/ui/core/CustomData","sap/ui/model/json/JSONModel","sap/ui/core/Icon","sap/ui/layout/VerticalLayout","sap/m/Text","sap/m/Label","sap/m/Button","sap/m/HBox","sap/m/VBox","sap/m/ScrollContainer","sap/ui/export/Spreadsheet","sap/apf/ui/utils/determineColumnSettingsForSpreadSheetExport","sap/ui/export/EdmType","sap/m/Dialog","sap/ui/thirdparty/jquery"],function(e,t,a,i,n,o,r,s,l,p,d,u,h,c,g,f,m,v,b,y,T,A,jQuery){"use strict";function x(e,t){t.forEach(function(t){e.addSelectionInterval(t,t)})}function S(e){e.loadAllButton.attachEvent("setFocusOnLoadAllButtonEvent",e.loadAllButton.setFocusOnLoadAllButton)}function D(e,t){if(e.bIsAlternateRepresentation&&e.oApi.getActiveStep()){e.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.getFilterValues().forEach(function(t){if(e.aFiltersInTable.indexOf(t)===-1){e.aFiltersInTable.push(t)}})}if(t&&e.oParameter.top||e.oParameter.isAlternateRepresentation){e.aFiltersInTable=F(e,t)}}function F(e,t){var a=[];e.aFiltersInTable.forEach(function(i){e.aDataResponse.forEach(function(e){var n=e[t];if(n==i&&a.indexOf(i)===-1){a.push(i)}})});return a}function w(e,t,a){var i=e.tableControl.getContextByIndex(a[0]).getProperty(t);if(e.tableControl.isIndexSelected(a[0])&&e.aFiltersInTable.indexOf(i)===-1){e.aFiltersInTable.push(i)}else{var n=e.aFiltersInTable.indexOf(i);if(n!==-1){e.aFiltersInTable.splice(n,1)}}}function C(e,t){P(e);e.aFiltersInTable=t;e.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.updateFilterFromSelection(t);e.oApi.selectionChanged()}function P(e){e.oRepresentationFilterHandler.clearFilters();e.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.clearFilters();e.aValidatedFilter=[];e.aFiltersInTable=[]}function R(e,t,a,i,n){var o=e.nDataResponseCount||0;var r,s;var l=e.oApi.getTextNotHtmlEncoded("buttonTextExport");var p=new sap.m.Button({text:l,press:function(){if(e.aDataResponse.length>1e4){var a=e;a.newOpenDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:e.oApi.getTextNotHtmlEncoded("warningTitle"),state:"Warning",content:new sap.m.Text({text:e.oApi.getTextNotHtmlEncoded("exportWarning")}),beginButton:new sap.m.Button({text:e.oApi.getTextNotHtmlEncoded("warningExport"),press:function(){e.exportExcel(t);a.newOpenDialog.close()}}),endButton:new sap.m.Button({text:e.oApi.getTextNotHtmlEncoded("warningCancel"),press:function(){a.newOpenDialog.close()}}),afterClose:function(){a.oUiApi.getLayoutView().setBusy(false);a.newOpenDialog.destroy()}});a.newOpenDialog.open()}else{e.exportExcel(t)}}}).addStyleClass("sapUiTinyMarginBeginEnd");e.titleControl=new sap.m.Title({level:sap.ui.core.TitleLevel.H1}).addStyleClass("sapUiTinyMarginBegin").addStyleClass("sapUiTinyMarginTop");if(e.aDataResponse.length===0){p.setEnabled(false)}if(n){s=e.title}else if(e.oParameter.top){r=new sap.m.HBox({items:[p]});s=e.title}else if(i){r=new sap.m.HBox({items:[p]});s=e.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[e.title,a,a])}else{l=e.oApi.getTextNotHtmlEncoded("buttonTextLoadAll");if(e.loadAllButton===undefined){e.loadAllButton=new sap.m.Button({text:l,press:e.loadAll.bind(e)});e.loadAllButton.setFocusOnLoadAllButton=function(){this.focus();this.detachEvent("setFocusOnLoadAllButtonEvent",this.setFocusOnLoadAllButton)}}r=new sap.m.HBox({items:[e.loadAllButton,p]});s=e.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[e.title,a,o]);e.loadAllButton.addAriaLabelledBy(e.titleControl)}p.addAriaLabelledBy(e.titleControl);e.titleControl.setText(s);var d=new sap.m.HBox({alignItems:"Start",wrap:"Wrap",justifyContent:"SpaceBetween",items:[e.titleControl,r]});return d}function E(e,t,a,i){var n=function(t){return function(i){if(a.metadata!==undefined){var n;if(e.value[t]&&i){n=a.oFormatter.getFormattedValueAsString(e.value[t],i);if(n!==undefined){return n}}}return i}};var o=new sap.ui.table.Table({title:t,showNoData:false,enableSelectAll:false,visibleRowCountMode:sap.ui.table.VisibleRowCountMode.Auto});if(i){o.setWidth(i+"px")}o.setLayoutData(new sap.m.FlexItemData({growFactor:1}));if(sap.ui.Device.system.desktop){o.addStyleClass("sapUiSizeCompact")}var r=a.oParameter.requiredFilters;var s=r&&r.length>0?"MultiToggle":"None";o.setSelectionMode(s);var l=[],p,d,u;for(var h=0;h<e.name.length;h++){p=new sap.m.Text({wrapping:false});p.bindText(e.value[h],n(h),sap.ui.model.BindingMode.OneWay);p.bindProperty("tooltip",e.value[h],n(h));d=new sap.ui.table.Column({label:new sap.m.Label({text:e.name[h],tooltip:e.name[h]}),template:p});u=new sap.ui.core.CustomData({value:{text:e.name[h],key:e.value[h]}});if(i){d.setMinWidth(125)}d.addCustomData(u);l.push(d)}var c;c=l;c.forEach(function(e){o.addColumn(e)});if(l.length>10){o.getColumns().forEach(function(e){e.setWidth("125px")})}var g=new sap.ui.model.json.JSONModel;g.setSizeLimit(1e4);var f=a.getData();g.setData({tableData:f});o.setModel(g);o.bindRows("/tableData");if(a.metadata!==undefined){for(var m=0;m<e.name.length;m++){var v=a.metadata.getPropertyMetadata(e.value[m]);if(v["aggregation-role"]==="measure"){var b=o.getColumns()[m];b.setHAlign(sap.ui.core.HorizontalAlign.End)}}}return o}function I(e){var t=e.getData();var a=[],i;var n={name:[],value:[]};a=e.oParameter.dimensions.concat(e.oParameter.measures).length?e.oParameter.dimensions.concat(e.oParameter.measures):e.parameter.properties;if(t.length!==0){for(var o=0;o<a.length;o++){n.value[o]=a[o].fieldName;var r=e.metadata.getPropertyMetadata(a[o].fieldName).label||e.metadata.getPropertyMetadata(a[o].fieldName).name;var s="";if(e.metadata!==undefined&&e.metadata.getPropertyMetadata(a[o].fieldName).unit!==undefined){var l=e.metadata.getPropertyMetadata(a[o].fieldName).unit;s=e.getData()[0][l];for(i=0;i<e.getData().length;i++){if(s!==e.getData()[i][l]){s=undefined;break}}n.name[o]=a[o].fieldDesc===undefined||!e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc).length?r:e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc);if(s!==undefined&&s!==""){n.name[o]=e.oApi.getTextNotHtmlEncoded("displayUnit",[n.name[o],s])}}else{n.name[o]=a[o].fieldDesc===undefined||!e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc).length?r:e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc)}}}return n}function O(e){var t;var a=e.getSelectedSortItem();e.getSortItems().forEach(function(e){if(e.getId()===a){t=e.getKey()}});return t}var H=function(e,t){this.oViewSettingDialog=undefined;this.aDataResponse=[];this.aValidatedFilter=[];this.aFiltersInTable=[];this.oParameter=t;this.orderby=t.orderby;this.omitTopAndSkipOptionsForNextPathUpdate=false;sap.apf.ui.representations.BaseUI5ChartRepresentation.apply(this,[e,t]);this.alternateRepresentation=t.alternateRepresentationType;this.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;this.oPaginationHandler=new sap.apf.ui.representations.utils.PaginationHandler(this);this.oPaginationDisplayOptionHandler=new sap.apf.ui.representations.utils.PaginationDisplayOptionHandler;this._drawSelection=function(e){var t=this.oParameter.requiredFilters;var a=t&&t.length>0?t[0]:undefined;var i=e.getParameter("userInteraction");var n=e.getParameter("rowIndices");if(!i||n.length===0){return}if(e.getSource().getFocusDomRef()&&e.getSource().getFocusDomRef().offsetTop!==0){this.nFirstVisibleRow=this.tableControl.getFirstVisibleRow()}w(this,a,n);var o=jQuery.unique(this.aFiltersInTable);C(this,o)};this._handleSelectionEvent=function(e){this._drawSelection(e)};this._getSelectedIndicesInTable=function(e){var t=this;var a=[];t.aDataResponse.forEach(function(i,n){var o=i[e];if(t.aFiltersInTable.indexOf(o)!==-1){a.push(n)}});return a}};H.prototype=Object.create(sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype);H.prototype.constructor=H;H.prototype.setData=function(e,t,a,i){var n=this;var o,r;if(!t){var s=this.oApi.createMessageObject({code:"6004",aParameters:[this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(s)}this.metadata=t;this.oFormatter=new sap.apf.ui.utils.formatter({getEventCallback:this.oApi.getEventCallback.bind(this.oApi),getTextNotHtmlEncoded:this.oApi.getTextNotHtmlEncoded,getExits:this.oApi.getExits()},this.metadata,this.aDataResponse);if(this.oParameter.requiredFilters.length>0){o=this.oParameter.requiredFilters[0];r=t.getPropertyMetadata(o).text}if(!this.oParameter.isAlternateRepresentation){if(o){this.aValidatedFilter=[];if(i&&i.length>0){i.forEach(function(e){n.aValidatedFilter.push(e[o]);n.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(e[o],e[r])});n.aFiltersInTable=n.aValidatedFilter}else{n.aFiltersInTable=[]}}var l=this.getRequestOptions();var p=l.paging&&l.paging.skip;this.nDataResponseCount=a;if(p===undefined||p===0){this.aDataResponse=e}else{e.map(function(e){n.aDataResponse.push(e)})}if(!this.oParameter.top&&this.titleControl){var d=this.aDataResponse&&this.aDataResponse.length||0;var u=this.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[this.title,d,a]);this.titleControl.setText(u)}}else{this.aDataResponse=e}if(r){this.aDataResponse.forEach(function(e){n.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(e[o],e[r])})}};H.prototype.getFilter=function(){this.filter=this.oRepresentationFilterHandler.createFilterFromSelectedValues(this.aFiltersInTable);return this.filter};H.prototype.getSelections=function(){var e=this,t=[],a;var i=e.parameter.requiredFilters[0];D(e,i);e.aFiltersInTable.forEach(function(n){a=e.oPaginationDisplayOptionHandler.getDisplayNameForPaginatedFilter(n,e.parameter.requiredFilterOptions,i,e.oFormatter,e.metadata);t.push({id:n,text:a})});return t};H.prototype.markSelectionInTable=function(e){var t=this.oParameter.requiredFilters?this.oParameter.requiredFilters[0]:undefined;if(t){var a=this._getSelectedIndicesInTable(t);if(this.oParameter.isAlternateRepresentation){var i=[];var n=this.tableControl.getBinding().aIndices;a.forEach(function(e){i.push(n.indexOf(e))});a=i}this.tableControl.clearSelection();if(a.length>0){x(this.tableControl,a)}}};H.prototype.getRequestOptions=function(e,t){this.bIsAlternateRepresentation=t;if(e){this.oPaginationHandler.resetPaginationOption()}var a={paging:{},orderby:[]};if(e){this.omitTopAndSkipOptionsForNextPathUpdate=false}if(this.omitTopAndSkipOptionsForNextPathUpdate){a.paging={inlineCount:true}}else if(!this.bIsAlternateRepresentation){a.paging=this.oPaginationHandler.getPagingOption(this.oParameter.top)}if(this.orderby){a.orderby=this.orderby}if(this.oViewSettingDialog){var i=O(this.oViewSettingDialog);if(i){var n={property:O(this.oViewSettingDialog),ascending:!this.oViewSettingDialog.getSortDescending()};this.orderby=[n];a.orderby=[n]}}return a};H.prototype.resetPaginationForTable=function(){this.omitTopAndSkipOptionsForNextPathUpdate=false;this.oPaginationHandler.resetPaginationOption()};H.prototype.getMainContent=function(e,t,a){var i=this;var n=this.getData();this.title=e;var o=this.oParameter.dimensions.concat(this.oParameter.measures).length?this.oParameter.dimensions.concat(this.oParameter.measures):this.oParameter.properties;var r=I(this);var s;if(!e){s=this.oApi.createMessageObject({code:"6002",aParameters:["title",this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(s)}if(o.length===0){s=this.oApi.createMessageObject({code:"6002",aParameters:["dimensions",e]});this.oApi.putMessage(s)}if(!n||n.length===0){s=this.oApi.createMessageObject({code:"6000",aParameters:[e]});this.oApi.putMessage(s)}var l;if(this.oParameter.isAlternateRepresentation){l=R(this,e,n.length,true,t)}else{l=R(this,e,n.length,false,t)}this.tableControl=E(r,l,this,t);this.tableControl.addAriaLabelledBy(l.getItems()[0]);this.tableControl.addEventDelegate({onAfterRendering:function(){if(i.oParameter){i.markSelectionInTable(true);if(i.loadAllButton){i.loadAllButton.fireEvent("setFocusOnLoadAllButtonEvent")}if(!i.oParameter.top&&!i.oParameter.isAlternateRepresentation&&i.nDataResponseCount>100){i.oPaginationHandler.attachPaginationOnTable(i)}}}});this.tableControl.attachRowSelectionChange(this._handleSelectionEvent.bind(this));this.oLoadMoreLink=new sap.m.Link({text:this.oApi.getTextNotHtmlEncoded("moreIcon"),visible:false});var p=new sap.m.VBox({fitContainer:true,items:[this.tableControl,this.oLoadMoreLink]}).addStyleClass("tableRepresentation");if(a){p.setHeight(a+"px")}return p};H.prototype.getThumbnailContent=function(){var e;var t=this.getData();var a=this.oParameter.isAlternateRepresentation?"sap-icon://table-view":"sap-icon://table-chart";if(t!==undefined&&t.length!==0){var i=new sap.ui.core.Icon({src:a,size:"70px"}).addStyleClass("thumbnailTableImage");e=i}else{var n=new sap.m.Text({text:this.oApi.getTextNotHtmlEncoded("noDataText")}).addStyleClass("noDataText");e=new sap.ui.layout.VerticalLayout({content:n})}return e};H.prototype.removeAllSelection=function(){P(this);this.tableControl.clearSelection();this.oApi.selectionChanged()};H.prototype.getPrintContent=function(e){var t=this.tableControl.clone();t.getColumns().forEach(function(e){e.setWidth("auto");e.getTemplate().setWrapping(true)});var a=this.tableControl.getSelectedIndices();t.setVisibleRowCountMode(sap.ui.table.VisibleRowCountMode.Fixed);t.setVisibleRowCount(t.getModel().getData().tableData.length);t.onAfterRendering=function(){a.forEach(function(e){t.getRows()[e].getDomRef().classList.add("sapTableSelectionForPrint")})};var i={oRepresentation:t};return i};H.prototype.getViewSettingDialog=function(){if(!this.oViewSettingDialog){var e={oTableInstance:this};var t=new sap.ui.view({type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.apf.ui.reuse.view.viewSetting",viewData:e});this.oViewSettingDialog=t.getContent()[0];this.oViewSettingDialog.addStyleClass("sapUiSizeCompact")}return this.oViewSettingDialog};H.prototype.loadAll=function(){this.omitTopAndSkipOptionsForNextPathUpdate=true;if(this.loadAllButton){S(this)}this.oApi.selectionChanged()};H.prototype.exportExcel=function(e){var t=this;function a(){var e=I(t);var a=[];var i,n;for(i=0;i<e.value.length;i++){n=sap.apf.ui.utils.determineColumnSettingsForSpreadSheetExport(e.value[i],t.metadata);n.property=e.value[i];n.label=e.name[i];a.push(n)}return a}var i=this.getData();var n=a();var o={workbook:{columns:n},dataSource:i,fileName:e+".xlsx"};var r=new sap.ui.export.Spreadsheet(o);r.build()};H.prototype.onChartSwitch=function(){this.resetPaginationForTable()};H.prototype.destroy=function(){if(this.orderby){this.orderby=null}if(this.oParameter){this.oParameter=null}if(this.oViewSettingDialog){this.oViewSettingDialog.destroy()}if(this.aDataResponse){this.aDataResponse=null}if(this.aValidatedFilter){this.aValidatedFilter=[]}if(this.aFiltersInTable){this.aFiltersInTable=[]}sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype.destroy.call(this)};return H},true);
//# sourceMappingURL=table.js.map
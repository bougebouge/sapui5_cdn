/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
*/
sap.ui.define(["sap/apf/core/constants","sap/apf/ui/utils/formatter","sap/apf/modeler/ui/utils/constants","sap/apf/ui/representations/BaseUI5ChartRepresentation","sap/apf/ui/representations/utils/paginationDisplayOptionHandler","sap/ui/table/TreeTable"],function(e,t,a,r,i,o){"use strict";function n(e){return e.metadata.getPropertyMetadata(e.requiredFilter).text}function l(e){return e.oTreeTableControlObject.parameters.treeAnnotationProperties.hierarchyNodeExternalKeyFor}function s(e,t){if(e){if(t.getPropertyMetadata(e)["filter-restriction"]==="single-value"){return sap.ui.table.SelectionMode.Single}return sap.ui.table.SelectionMode.MultiToggle}return sap.ui.table.SelectionMode.None}function p(e,t,a){var r;var i=function(e){return function(t){if(a.metadata!==undefined){var r;if(t){r=a.oFormatter.getFormattedValue(e,t);if(r!==undefined){return r}}}return t}};r=new sap.ui.table.TreeTable({showNoData:false,title:t,enableSelectAll:false,visibleRowCountMode:sap.ui.table.VisibleRowCountMode.Auto});r.setLayoutData(new sap.m.FlexItemData({growFactor:1}));r.addStyleClass("sapUiSizeCompact");r.setSelectionMode(s(a.requiredFilter,a.metadata));var o=[],n,l;e.name.forEach(function(t,a){n=(new sap.m.Text).bindText(e.value[a],i(e.value[a]),sap.ui.model.BindingMode.OneWay);l=new sap.ui.table.Column({label:new sap.m.Label({text:t}),template:n,tooltip:t});o.push(l)});o.forEach(function(e){r.addColumn(e)});a.oTreeTableModel.attachBatchRequestCompleted(function(){if(a.oApi.getUiApi().getLayoutView().getController()&&a.oApi.getUiApi().getLayoutView().getController().byId("stepContainer")){a.oApi.getUiApi().getLayoutView().getController().byId("stepContainer").getContent()[0].byId("idStepLayout").setBusy(false)}d(a,r,e);if(a.oRepresentationFilterHandler!==null){if(a.oRepresentationFilterHandler!==undefined){if(a.oRepresentationFilterHandler.getFilterValues().length>0){u(a)}else{a.oTreeTable.clearSelection()}}}});a.oTreeTableModel.attachBatchRequestSent(function(e){if(a.oApi.getUiApi().getLayoutView().getController()&&a.oApi.getUiApi().getLayoutView().getController().byId("stepContainer")){a.oApi.getUiApi().getLayoutView().getController().byId("stepContainer").getContent()[0].byId("idStepLayout").setBusy(true)}});r.setModel(a.oTreeTableModel);r.bindRows(a.oTreeTableControlObject);return r}function u(e){var t=e.oTreeTable.getRows();e.oTreeTable.clearSelection();setTimeout(function(){t.forEach(function(t,a){var r=t.getBindingContext();if(r){var i=r.getProperty(e.requiredFilter);e.oRepresentationFilterHandler.getFilterValues().forEach(function(t){if(i===t){e.oTreeTable.addSelectionInterval(a,a)}})}})},1)}function d(e,t,a){if(e.metadata!==null){if(e.metadata!==undefined){for(var r=0;r<a.name.length;r++){var i=e.metadata.getPropertyMetadata(a.value[r]);if(i["aggregation-role"]==="measure"){var o=t.getColumns()[r];o.setHAlign(sap.ui.core.HorizontalAlign.End)}}}}}function c(e,t){var a=e.oTreeTable.getContextByIndex(t).getProperty(e.requiredFilter);var r=e.oTreeTable.getSelectionMode(e.requiredFilter);var i=e.oTreeTable.isIndexSelected(t);var o=e.oTreeTable.getContextByIndex(t).getProperty(n(e));var s=e.oTreeTable.getContextByIndex(t).getProperty(l(e));e.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(a,o,s);var p=e.oRepresentationFilterHandler.getFilterValues();if(i){p=g(e,r,a,p)}else{p=h(e,r,a,p)}b(e,p)}function f(e){e.oRepresentationFilterHandler.clearFilters()}function T(e){return e.filter(function(e,t,a){return a.indexOf(e)===t})}function g(e,t,a,r){if(t===sap.ui.table.SelectionMode.Single){r=[a]}else{r.push(a)}return T(r)}function h(e,t,a,r){if(t===sap.ui.table.SelectionMode.Single){r=[]}else{var i=r.indexOf(a);if(i!==-1){r.splice(i,1)}}return r}function b(e,t){f(e);e.oRepresentationFilterHandler.updateFilterFromSelection(t);e.oApi.selectionChanged()}function y(e){var t={name:[],value:[]};var a=e.oParameters.hierarchicalProperty.concat(e.oParameters.properties);a.forEach(function(a,r){var i=a.fieldName;var o=e.metadata.getPropertyMetadata(i).label||e.metadata.getPropertyMetadata(i).name;if(a.kind===sap.apf.modeler.ui.utils.CONSTANTS.propertyTypes.HIERARCHIALCOLUMN){if(a.labelDisplayOption==="text"){i=e.metadata.getPropertyMetadata(e.oTreeTableControlObject.parameters.treeAnnotationProperties.hierarchyNodeFor).text}else{i=e.oTreeTableControlObject.parameters.treeAnnotationProperties.hierarchyNodeExternalKeyFor}}t.name[r]=a.fieldDesc===undefined||!e.oApi.getTextNotHtmlEncoded(a.fieldDesc).length?o:e.oApi.getTextNotHtmlEncoded(a.fieldDesc);t.value[r]=i});return t}var m=function(e,t){var a=this;a.oParameters=t;a.requiredFilter=a.oParameters.requiredFilters[0];a.oKeyTextLookup={};a.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TREE_TABLE_REPRESENTATION;sap.apf.ui.representations.BaseUI5ChartRepresentation.apply(a,[e,t]);a.oPaginationDisplayOptionHandler=new sap.apf.ui.representations.utils.PaginationDisplayOptionHandler;a._selectRowInTreeTable=function(e){var t=e.getParameter("userInteraction");var r=e.getParameter("rowIndex");if(!t||r===undefined||r===null){return}c(a,r)};a.handleRowSelectionInTreeTable=function(e){a._selectRowInTreeTable(e)}};m.prototype=Object.create(sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype);m.prototype.constructor=m;m.prototype.getMainContent=function(e){if(!this.oTreeTable){var t=y(this);this.oTreeTable=p(t,e,this);this.oTreeTable.attachRowSelectionChange(this.handleRowSelectionInTreeTable.bind(this))}return new sap.m.VBox({fitContainer:true,items:[this.oTreeTable]})};m.prototype.getSelections=function(){var e=[],t=this,a;this.oRepresentationFilterHandler.getFilterValues().forEach(function(r){a=t.oPaginationDisplayOptionHandler.getDisplayNameForPaginatedFilter(r,t.parameter.requiredFilterOptions,t.requiredFilter,t.oFormatter,t.metadata);e.push({id:r,text:a})});return e};m.prototype.removeAllSelection=function(){this.oRepresentationFilterHandler.clearFilters();this.oTreeTable.clearSelection();this.oApi.selectionChanged()};m.prototype.getFilter=function(){var e=this.oApi.createFilter();var t=e.getTopAnd().addOr("exprssionOr");this.oRepresentationFilterHandler.getFilterValues().forEach(function(e){var a={id:e,name:this.requiredFilter,operator:"EQ",value:e};t.addExpression(a)}.bind(this));return e};m.prototype.setFilterValues=function(e){var t=this,a=[];var r=t.requiredFilter;t.oRepresentationFilterHandler.clearFilters();e.forEach(function(e){var i=e[r];var o=e[n(t)];var s=e[l(t)];t.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(i,o,s);a.push(i)});t.oRepresentationFilterHandler.updateFilterFromSelection(a)};m.prototype.updateTreetable=function(e,t,a,r){this.oTreeTableModel=t;this.oTreeTableControlObject=e;this.metadata=a;this.oFormatter=new sap.apf.ui.utils.formatter({getEventCallback:this.oApi.getEventCallback.bind(this.oApi),getTextNotHtmlEncoded:this.oApi.getTextNotHtmlEncoded,getExits:this.oApi.getExits()},this.metadata);if(this.oTreeTable&&r){this.oTreeTable.bindRows(this.oTreeTableControlObject)}};m.prototype.getPrintContent=function(e){var t=this.oTreeTable.clone();var a={oRepresentation:t};return a};m.prototype.getSelectedFilterPropertyLabel=function(e){return this.metadata.getPropertyMetadata(e)["hierarchy-node-for"]};m.prototype.destroy=function(){if(this.oParameters){this.oParameters=null}if(this.oTreeTableModel){this.oTreeTableModel=null}if(this.oTreeTableControlObject){this.oTreeTableControlObject=null}if(this.oTreeTable){this.oTreeTable.destroy()}if(this.metadata){this.metadata=null}if(this.oRepresentationFilterHandler){this.oRepresentationFilterHandler=null}sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype.destroy.call(this)};return m},true);
//# sourceMappingURL=treeTable.js.map
/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/ui/utils/helper","sap/apf/core/constants","sap/ui/core/mvc/Controller","sap/apf/ui/utils/constants","sap/suite/ui/commons/ChartContainerContent","sap/suite/ui/commons/ChartContainerToolbarPlaceholder","sap/ui/core/Icon","sap/ui/core/CustomData","sap/m/Link","sap/m/ToggleButton","sap/m/Label","sap/m/Button","sap/m/ToolbarSpacer","sap/m/List","sap/m/ListMode","sap/m/ListSeparators","sap/m/StandardListItem","sap/m/Popover","sap/m/PlacementType","sap/apf/utils/trace"],function(e,t,n,a,r,i,o,s,l,d,p,c,u,g,f,v,h,C,y,m){"use strict";var I,S,T,b=false;function w(){var e=T.getSelectedRepresentation();return e.type===a.representationTypes.TABLE_REPRESENTATION}function R(){var e=T.getSelectedRepresentation();return e.type===a.representationTypes.TREE_TABLE_REPRESENTATION}function A(){if(T.getSelectedRepresentation().bIsAlternateView===undefined||T.getSelectedRepresentation().bIsAlternateView===false){return false}return true}function P(e){var t=e.getCurrentRepresentation();var n=t.getParameter().requiredFilters;if(n===undefined||n.length===0){return undefined}return n[0]}function x(e){m.logCall("StepContainer._setChartContainerContent");var t=e.byId("idChartContainer");var n=e.getCurrentRepresentation();var a=T.longTitle&&!I.isInitialTextKey(T.longTitle.key)?T.longTitle:T.title;var i=I.getTextNotHtmlEncoded(a);m.log("_setChartContainerContent"," title=",i);var o=n.getMainContent(i);var s={onBeforeRendering:function(){D(e,o)}};o.addEventDelegate(s);t.removeAllContent();var l=new r({content:o});t.addContent(l);m.logReturn("_setChartContainerContent")}function D(e,t){var n=e.byId("idChartContainer");var a="0";var r=jQuery(window).width();var i=n.getId();if(jQuery("#"+i).length!==0){a=jQuery("#"+i+" > div:first-child > div:nth-child(2)").offset().top;r=jQuery("#"+i+" > div:first-child > div:nth-child(2)").width()}var o=jQuery(window).height()-a-jQuery(".applicationFooter").height();var s=r;t.setHeight(o+"px");t.setWidth(s+"px")}function E(e,t){var n=e.byId("idSelectedText");var a=e.getCurrentRepresentation();var r=_(e);var i=a.getSelectionFilterLabel();var o=i+" ("+r+") ";var s=e.byId("idSelPropertyAndCount");if(!s){s=new l({id:e.createId("idSelPropertyAndCount"),press:e.handlePressSelectedPropertyCountLink.bind(e)});s.addAriaLabelledBy(n.getId())}else{if(s&&a.chart!==undefined&&(a.chart!==null&&a.chart.setFocusOnSelectLink)){a.chart.detachEvent("setFocusOnSelectedLinkEvent",a.chart.setFocusOnSelectLink)}}if(s&&a.chart!==undefined&&a.chart!==null){a.chart.setFocusOnSelectLink=function(){s.focus()}}s.setVisible(true);s.setText(o);t.addContent(s);t.onAfterRendering=function(){if(s&&a.chart!==undefined&&a.chart!==null){a.chart.fireEvent("setFocusOnSelectedLinkEvent");a.chart.detachEvent("setFocusOnSelectedLinkEvent",a.chart.setFocusOnSelectLink)}}}function V(e){var t=e.byId("idChartContainer");t.removeAllCustomIcons();N(e);L(e);B(e)}function N(t){var n=t.byId("idChartContainer");var a=T.getSelectedRepresentationInfo();var r;if(a.parameter&&a.parameter.orderby){var i=a.parameter.orderby;new e(I).getRepresentationSortInfo(a).done(function(e){for(var s=0;s<e.length;s++){r=i[0].property}var l=i[0].ascending==true?"Sort Order: Ascending":"Sort Order: Descending";var d=I.getTextNotHtmlEncoded(a.label)+"\n"+(r!==undefined?I.getTextNotHtmlEncoded("sortBy")+": "+r:"")+"\n"+l;var p=new o({src:a.picture,tooltip:d,press:function(e){t.handlePressChartIcon(e)}});n.addCustomIcon(p)})}else{var s=I.getTextNotHtmlEncoded(a.label)+"\n"+(r!==undefined?I.getTextNotHtmlEncoded("sortBy")+": "+r:"");var l=new o({src:a.picture,tooltip:s,press:function(e){t.handlePressChartIcon(e)}});n.addCustomIcon(l)}}function L(e){var t=e.byId("idChartContainer");var n=I.getTextNotHtmlEncoded("listView");var a=new sap.ui.core.Icon({src:"sap-icon://table-view",tooltip:n,press:e.handlePressAlternateRepIcon.bind(e)});var r=e.getCurrentRepresentation();var i=r.type;if(w()||R()||i=="TableRepresentation"){t.removeCustomIcon(a);return}t.addCustomIcon(a)}function B(e){if(e.getCurrentRepresentation().topN!==undefined||!A()&&!w()||R()){return}var t=e.byId("idChartContainer");var n=I.getTextNotHtmlEncoded("view-Settings-Button");var a=new o({src:"sap-icon://drop-down-list",tooltip:n,press:function(){e.getView().addDependent(e.getCurrentRepresentation().getViewSettingDialog());e.getCurrentRepresentation().getViewSettingDialog().open()}});t.addCustomIcon(a)}function F(e,t){var n=e.byId("idSelectedText");if(!n){n=new p({id:e.createId("idSelectedText"),text:I.getTextNotHtmlEncoded("selectedValue")})}n.setVisible(true);t.addContent(n)}function H(e,t){var n=e.byId("idReset");if(!n){n=new c({text:I.getTextNotHtmlEncoded("reset"),id:e.createId("idReset"),type:"Transparent",press:e.handlePressResetButton.bind(e)}).addStyleClass("chartContainerResetStyle")}n.setVisible(true);t.addContent(n)}function O(e,t){var n=_(e);if(n>0&&P(e)!==undefined){F(e,t);E(e,t);H(e,t)}}function j(e,t){var n=e.byId("idPathFilterDisplayButton");if(!n){n=new c({text:I.getTextNotHtmlEncoded("pathFilterDisplayButton"),id:e.createId("idPathFilterDisplayButton"),icon:"sap-icon://message-information",type:"Transparent",press:function(){if(e.byId("idStepLayout").getBusy()===false){I.getPathFilterInformation().then(function(t){var n=new sap.ui.core.mvc.XMLView({viewName:"sap.apf.ui.reuse.view.pathFilterDisplay",viewData:{pathFilterInformation:t,oCoreApi:I,oUiApi:S},id:e.createId("pathFilterDisplay")});n.setParent(e.getView(),"content",true);n.getContent()[0].open()})}}})}t.addContent(n)}function k(e,t){var n=e.getCurrentRepresentation();var a=n.type;var r=undefined;var i=false;if(a!=="TableRepresentation"&&a!=="listView"&&a!=="TreeTableRepresentation"){if(n.chart!==undefined){if(Object.getOwnPropertyNames(n.chart).length!==0){r=n.chart.vizSelection();i=n.chart.getVizProperties().plotArea.dataLabel.visible}}if(n!==undefined){if(n.aDataResponse!==0){var o=e.byId("idToggleDisplayButton");if(!o){o=new sap.m.ToggleButton({id:e.createId("idToggleDisplayButton"),pressed:false,text:I.getTextNotHtmlEncoded("values"),tooltip:I.getTextNotHtmlEncoded("displayValues"),press:e.handleToggleDisplay.bind(e)})}else{n=e.getCurrentRepresentation();o.setPressed(i)}if(r!==undefined){e.getCurrentRepresentation().chart.vizSelection(r,{clearSelection:false})}t.addContent(o)}}}}function M(e){var t=e.byId("idChartContainer");var n=t.getToolbar();n.removeAllContent();var a=new p({text:I.getTextNotHtmlEncoded("currentStep")});n.addContent(a);var r=new u;n.addContent(r);k(e,n);O(e,n);j(e,n);n.addContent(new i);t.setToolbar(n)}function Q(e,t,n){m.logCall("StepContainer._drawChartContainer",", isActiveStep=",n,", oActiveStep=",t);if(t!==undefined){x(e);V(e);M(e)}m.logReturn("_drawChartContainer")}function _(e){var t=e.getCurrentRepresentation();var n=t.getSelections().length;return n}function z(t,n){var a=new g({mode:f.SingleSelectMaster,showSeparators:v.None,includeItemInSelection:true,selectionChange:t.handleSelectionChartSwitchIcon.bind(t)});var r;var i;for(var o=0;o<T.getRepresentationInfo().length;o++){i=T.getRepresentationInfo()[o];r=undefined;if(i.parameter&&i.parameter.orderby){new e(I).getRepresentationSortInfo(i).done(function(e){var t=[];for(var n=0;n<e.length;n++){e[n].done(function(e){t.push(e)})}r=t.join(", ");var o=r!==undefined?I.getTextNotHtmlEncoded("sortBy")+": "+r:"";var l=new h({description:o,icon:i.picture,title:I.getTextNotHtmlEncoded(i.label),customData:[new s({key:"data",value:{oRepresentationType:i,icon:i.picture}})]});a.addItem(l)})}else{var l=r!==undefined?I.getTextNotHtmlEncoded("sortBy")+": "+r:"";var d=new h({description:l,icon:i.picture,title:I.getTextNotHtmlEncoded(i.label),customData:[new s({key:"data",value:{oRepresentationType:i,icon:i.picture}})]});a.addItem(d)}}if(!t.byId("idAllChartPopover")){var p=new C({id:t.createId("idAllChartPopover"),placement:y.Bottom,showHeader:false,content:[a],afterClose:function(){p.destroy()}})}t.byId("idAllChartPopover").openBy(n)}function U(e,t){e.byId("idReset").setVisible(t);e.byId("idSelPropertyAndCount").setVisible(t);e.byId("idSelectedText").setVisible(t)}return n.extend("sap.apf.ui.reuse.controller.stepContainer",{onInit:function(){var e=this;I=e.getView().getViewData().oCoreApi;S=e.getView().getViewData().uiApi;T=I.getActiveStep();this.initialText=new p({id:this.createId("idInitialText")}).addStyleClass("initialText");this.initialText.setText(I.getTextNotHtmlEncoded("initialText"))},onAfterRendering:function(){jQuery(S.getStepContainer().getDomRef()).hide();if(jQuery("#"+this.initialText.getId()).length===0&&I.getSteps().length===0){jQuery("#"+S.getStepContainer().getId()).parent().append(sap.ui.getCore().getRenderManager().getHTML(this.initialText))}else if(I.getSteps().length>0){jQuery(S.getStepContainer().getDomRef()).show()}if(S.getAnalysisPath().getController().isOpenPath){jQuery(".initialText").remove()}},getCurrentRepresentation:function(){var e=T.getSelectedRepresentation();if(A()){e=T.getSelectedRepresentation().toggleInstance}return e},handlePressSelectedPropertyCountLink:function(){var e=this;e.oCoreApi=I;var t=new sap.ui.jsfragment("idSelectionDisplayFragment","sap.apf.ui.reuse.fragment.selectionDisplay",e);t.open()},handleToggleDisplay:function(){var e=this;e.oCoreApi=I;var t=e.getCurrentRepresentation();var n=e.byId("idToggleDisplayButton");if(t.measures!==undefined){var a=t.getFormatStringForMeasure(t.measures[0]);if(t.type==="PieChart"){t.chart.setVizProperties({plotArea:{dataLabel:{visible:n.getPressed(),type:"percentage"}}})}else{t.chart.setVizProperties({plotArea:{dataLabel:{visible:n.getPressed(),formatString:a}}})}return t.chart.getVizProperties().plotArea.dataLabel.visible}var r=t.chartPlotArea.plotArea.dataLabel.visible;r=n.getPressed();return r},handlePressResetButton:function(){var e=this;if(A()){e.getCurrentRepresentation().removeAllSelection()}e.getCurrentRepresentation().removeAllSelection();U(e,false)},createToggleRepresentationInstance:function(e,n){var a={};function r(n){var a=n.dimensions;var r=e.getMetaData();n.isAlternateRepresentation=true;if(r===undefined){return n}var i,o;for(i=0;i<a.length;i++){var s=r.getPropertyMetadata(a[i].fieldName).hasOwnProperty("text");if(s&&a[i].labelDisplayOption===t.representationMetadata.labelDisplayOptions.KEY_AND_TEXT){o={};o.fieldName=r.getPropertyMetadata(a[i].fieldName).text;n.dimensions.splice(i+1,0,o)}else if(s&&a[i].labelDisplayOption===t.representationMetadata.labelDisplayOptions.TEXT){o={};o.fieldName=r.getPropertyMetadata(a[i].fieldName).text;n.dimensions.splice(i,1,o)}}return n}var i=jQuery.extend(true,{},e.getParameter());delete i.alternateRepresentationTypeId;delete i.alternateRepresentationType;i=r(i);if(n){i.orderby=n}a=I.createRepresentation(e.getParameter().alternateRepresentationType.constructor,i);var o=e.getData(),s=e.getMetaData();if(o!==undefined&&s!==undefined){a.setData(o,s)}return a},handlePressAlternateRepIcon:function(){var e=this;var t=T.getSelectedRepresentation();t.bIsAlternateView=true;if(A()){t.toggleInstance=e.createToggleRepresentationInstance(t)}b=true;e.getView().getViewData().uiApi.selectionChanged(true)},handlePressChartIcon:function(e){var t=this;var n=T.getSelectedRepresentation();var a=I.getSteps().indexOf(T);var r=null;if(T.getRepresentationInfo().length>1){r=e.getParameter("controlReference");z(t,r)}else{n.bIsAlternateView=false;b=true;t.getView().getViewData().uiApi.selectionChanged(true);n.createDataset();t.drawStepContent();S.getAnalysisPath().getController().updateCustomListView(T,a,false)}},handleSelectionChartSwitchIcon:function(e){this.byId("idAllChartPopover").close();var t=T.getSelectedRepresentation();var n=e.getParameter("listItem").getCustomData()[0].getValue();var a=T.getSelectedRepresentationInfo().representationId;var r=n.oRepresentationType.representationId;if(a===r&&t.bIsAlternateView===false){return}b=true;t.bIsAlternateView=false;T.setSelectedRepresentation(n.oRepresentationType.representationId);S.getAnalysisPath().getController().refresh(n.nActiveStepIndex);I.updatePath(S.getAnalysisPath().getController().callBackForUpdatePath.bind(S.getAnalysisPath().getController()));t.createDataset()},drawStepContent:function(e,t){m.logCall("StepContainer.drawStepContent"," bStepUpdated="+e);var n=this;var a=false;var r=T;T=I.getActiveStep();if(T===undefined){m.logReturn("drawStepContent",", the active step === undefined");return}if(r!==T){a=true}if(e||b||a){Q(n,T,t)}else{M(n)}b=false;n.initialText.destroy();n.byId("idStepLayout").setBusy(false);m.logReturn("drawStepContent",", bIsActiveStepChanged",a)}})},true);
//# sourceMappingURL=stepContainer.controller.js.map
/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/utils/proxyTextHandlerForLocalTexts","sap/apf/cloudFoundry/utils"],function(e,i){"use strict";function n(e,n){var a=n.instances.messageHandler;var t=n.manifests.manifest;var r=t["sap.app"].dataSources;var o=r&&r["apf.designTime.customer.applications"]&&r["apf.designTime.customer.applications"].uri;var l=r&&r["apf.designTime.customer.analyticalConfigurations"]&&r["apf.designTime.customer.analyticalConfigurations"].uri;var c=r&&r["apf.designTime.customer.applicationAndAnalyticalConfiguration"]&&r["apf.designTime.customer.applicationAndAnalyticalConfiguration"].uri;var u=r&&r["apf.designTime.textFileAndAnalyticalConfigurations"]&&r["apf.designTime.textFileAndAnalyticalConfigurations"].uri;var s=r&&r["apf.designTime.textFiles"]&&r["apf.designTime.textFiles"].uri;var f=r&&r["apf.designTime.vendor.importToCustomerLayer"]&&r["apf.designTime.vendor.importToCustomerLayer"].uri;var d=r&&r["apf.designTime.vendor.analyticalConfigurations"]&&r["apf.designTime.vendor.analyticalConfigurations"].uri;var p=n.instances.proxyTextHandlerForLocalTexts;var y=i.resolveUri.bind(this,n.instances.coreApi);function g(){return{}}function v(e){var i=JSON.parse(e.SerializedAnalyticalConfiguration);delete e.SerializedAnalyticalConfiguration;i.configHeader=e;e.SerializedAnalyticalConfiguration=JSON.stringify(i);return e}this.create=function(e,i,n){if(e==="application"){m(i,n)}else if(e==="configuration"&&i.CreationUTCDateTime&&i.LastChangeUTCDateTime){i=v(i);var t=i.AnalyticalConfiguration;z({type:"HEAD",url:y(l+"/"+t),success:function(){var e=a.createMessageObject({code:"5238",aParams:[t]});n(undefined,undefined,e)},error:function(e,t,r,o){if(e.status===404){S(i,function(e,a){n(i,e,a)})}else{var l=L(e,o,a);n(undefined,undefined,l)}}})}else if(e==="configuration"){i=v(i);T(i,n)}else if(e==="texts"){C(i,n)}else{a.check(false,"The create operation on entity set "+e+" is currently not supported by the modeler proxy.")}};function m(e,n){var t={applicationName:e.ApplicationName,textFile:{inDevelopmentLanguage:""}};var r="POST";var l=y(o);if(e.Application){r="PUT";l=l+"/"+e.Application}z({type:r,url:l,data:JSON.stringify(t),dataType:"json",success:function(t,o,l){if(r==="POST"&&t&&!jQuery.isEmptyObject(t)){var c={ApplicationName:e.ApplicationName,Application:t.application};n(c,g(),undefined)}else if(r==="PUT"){var c={ApplicationName:e.ApplicationName,Application:e.Application};n(c,g(),undefined)}else{var u=i.buildErrorMessage(l,"5227",[],undefined,a);n(undefined,g(),u)}},error:function(e,t,r,o){var l=i.buildErrorMessage(e,"5227",[],o,a);n(undefined,g(),l)},async:true})}function T(e,n){var t=e.Application;var r={analyticalConfigurationName:e.AnalyticalConfigurationName,application:t,serializedAnalyticalConfiguration:e.SerializedAnalyticalConfiguration,textFile:{inDevelopmentLanguage:p.createTextFileOfApplication(t)}};z({type:"POST",url:y(l),data:JSON.stringify(r),dataType:"json",success:function(e,o,l){if(e&&!jQuery.isEmptyObject(e)){var c={AnalyticalConfiguration:e.analyticalConfiguration,AnalyticalConfigurationName:r.analyticalConfigurationName};n(c,g(),undefined)}else{var u=i.buildErrorMessage(l,"5226",[t],undefined,a);n(undefined,g(),u)}},error:function(e,r,o,l){var c=i.buildErrorMessage(e,"5226",[t],l,a);n(undefined,g(),c)},async:true})}function C(e,i){var n=p.addText(e);e.TextElement=n;i(e,g())}this.readCollection=function(e,i,n,t,r){if(e==="application"){A(i)}else if(e==="configuration"){h(i,r)}else if(e==="texts"){i([],undefined)}else{a.check(false,"The read collection operation on entity set "+e+" is currently not supported by the modeler proxy.")}};function A(e){var n=y(o+"?$select=Application,ApplicationName");z({type:"GET",url:n,success:function(n,t,r){if(n&&!jQuery.isEmptyObject(n)){var o=[];if(n.applications!==null){n.applications.forEach(function(e){o.push({Application:e.application,ApplicationName:e.applicationName,SemanticObject:""})})}e(o,g(),undefined)}else{var l=i.buildErrorMessage(r,"5229",[],undefined,a);e(undefined,g(),l)}},error:function(n,t,r,o){var l=i.buildErrorMessage(n,"5229",[],o,a);e(undefined,g(),l)},async:true})}function h(e,n){var t=n.getFilterTermsForProperty("Application");var r=t[0].getValue();var o=y(u+"?$select=AnalyticalConfiguration,AnalyticalConfigurationName,SerializedAnalyticalConfiguration&$filter="+n.toUrlParam());z({type:"GET",url:o,success:function(n,t,o){if(n&&!jQuery.isEmptyObject(n)){var l=[];if(n.analyticalConfigurations!==null){n.analyticalConfigurations.forEach(function(e){l.push({AnalyticalConfiguration:e.analyticalConfiguration,Application:r,AnalyticalConfigurationName:e.analyticalConfigurationName,SerializedAnalyticalConfiguration:e.serializedAnalyticalConfiguration})})}p.initApplicationTexts(r,n.textFile.inDevelopmentLanguage);e(l,g(),undefined)}else{var c=i.buildErrorMessage(o,"5223",[r],undefined,a);e(undefined,g(),c)}},error:function(n,t,o,l){var c=i.buildErrorMessage(n,"5223",[r],l,a);e(undefined,g(),c)},async:true})}this.readEntity=function(e,i,n,t,r){if(e==="configuration"){var o=n[0].value;if(t&&t.length===2&&jQuery.inArray("CreationUTCDateTime",t)>-1&&jQuery.inArray("LastChangeUTCDateTime",t)>-1){x(o,r,i)}else{E(o,r,i)}}else{a.check(false,"The read single entity operation on entity set "+e+" is currently not supported by the modeler proxy.")}};function x(e,n,t){var r=y(l+"/"+e+"?$select=Application,CreationUtcDateTime,LastChangeUtcDateTime,ServiceInstance");z({type:"GET",url:r,success:function(r,o,l){if(r&&!jQuery.isEmptyObject(r)){var c={CreationUTCDateTime:r.analyticalConfiguration.creationUtcDateTime,LastChangeUTCDateTime:r.analyticalConfiguration.lastChangeUtcDateTime};t(c,g())}else{var u=i.buildErrorMessage(l,"5221",[n,e],undefined,a);t(undefined,g(),u)}},error:function(r,o,l,c){var u=i.buildErrorMessage(r,"5221",[n,e],c,a);t(undefined,g(),u)},async:true})}function E(e,n,t){var r=y(l+"/"+e+"?$select=AnalyticalConfigurationName,SerializedAnalyticalConfiguration");z({type:"GET",url:r,success:function(r,o,l){if(r&&!jQuery.isEmptyObject(r)){var c={Application:n,SerializedAnalyticalConfiguration:r.analyticalConfiguration.serializedAnalyticalConfiguration,AnalyticalConfiguration:e};t(c,g(),undefined)}else{var u=i.buildErrorMessage(l,"5221",[n,e],undefined,a);t(undefined,g(),u)}},error:function(r,o,l,c){var u=i.buildErrorMessage(r,"5221",[n,e],c,a);t(undefined,g(),u)},async:true})}this.update=function(e,i,n,t){if(e==="application"){var r=t[0].value;N(i,r,n)}else if(e==="configuration"&&i.CreationUTCDateTime&&i.LastChangeUTCDateTime){i=v(i);S(i,n)}else if(e==="configuration"){i=v(i);b(i,n)}else{a.check(false,"The update operation on entity set "+e+" is currently not supported by the modeler proxy.")}};function N(e,n,t){var r={applicationName:e.ApplicationName};var l=y(o+"/"+n);z({type:"PUT",url:l,data:JSON.stringify(r),dataType:"json",success:function(e,i,n){t(g(),undefined)},error:function(e,r,o,l){var c=i.buildErrorMessage(e,"5228",[n],l,a);t(g(),c)},async:true})}function b(e,n){var t=JSON.parse(e.SerializedAnalyticalConfiguration);var r=e.AnalyticalConfiguration;var o=y(l+"/"+r);var c=e.Application;t.configHeader={Application:c,AnalyticalConfiguration:r,AnalyticalConfigurationName:e.AnalyticalConfigurationName,CreationUTCDateTime:e.CreationUTCDateTime,LastChangeUTCDateTime:e.LastChangeUTCDateTime};var u={analyticalConfigurationName:e.AnalyticalConfigurationName,serializedAnalyticalConfiguration:JSON.stringify(t),textFile:{inDevelopmentLanguage:p.createTextFileOfApplication(c)}};z({type:"PUT",url:o,data:JSON.stringify(u),dataType:"json",success:function(e,i,a){n(g(),undefined)},error:function(e,t,o,l){var u=i.buildErrorMessage(e,"5233",[c,r],l,a);n(g(),u)},async:true})}function S(e,n){var t=JSON.parse(e.SerializedAnalyticalConfiguration);var r=t.configHeader.AnalyticalConfiguration;var o=y(c+"/"+r);var l=e.Application;var u={analyticalConfigurationName:e.AnalyticalConfigurationName,application:l,serializedAnalyticalConfiguration:e.SerializedAnalyticalConfiguration};z({type:"PUT",url:o,data:JSON.stringify(u),dataType:"json",success:function(e,i,a){n(g(),undefined)},error:function(e,t,o,c){var u=i.buildErrorMessage(e,"5233",[l,r],c,a);n(g(),u)},async:true})}this.remove=function(e,i,n,t,r,o){if(e==="application"){var l=i[0].value;O(l,n)}else if(e==="configuration"){var c=i[0].value;F(c,r,n)}else{a.check(false,"The delete operation on entity set "+e+" is currently not supported by the modeler proxy.")}};function O(e,n){var t=y(o+"/"+e);z({type:"DELETE",url:t,success:function(e,i,a){n(g(),undefined)},error:function(t,r,o,l){var c=i.buildErrorMessage(t,"5237",[e],l,a);n(g(),c)},async:true})}function F(e,n,t){var r=y(l+"/"+e);z({type:"DELETE",url:r,success:function(e,i,n){t(g(),undefined)},error:function(r,o,l,c){var u=i.buildErrorMessage(r,"5225",[n,e],c,a);t(g(),u)},async:true})}this.doChangeOperationsInBatch=function(e,i,n,t){e.forEach(function(e){if(e.entitySetName!=="texts"){a.check(false,"The create/update/delete operation in batch on entity set "+e.entitySetName+" is not supported by the modeler proxy.")}e.application=n});this._readConfigurationListAndTextFile(n).then(function(a){var r=a.textFile.inDevelopmentLanguage;this._initText(n,r);this._applyChangesOnTextFile(e);var o=this._createTextFileOfApplication(n);this._updateRemoteTextFile(n,"DEV",o,t).then(function(){i(undefined)},function(e){i(e)})}.bind(this),function(e){i(e)})};this._readConfigurationListAndTextFile=function(e){var n="'";var t=new Promise(function(t,r){var o=y(u+"?$select=AnalyticalConfiguration,AnalyticalConfigurationName,SerializedAnalyticalConfiguration"+"&$filter=(Application%20eq%20"+n+e+n+")");z({type:"GET",url:o,success:function(e,i,n){var a=[];if(e.analyticalConfigurations!==null){e.analyticalConfigurations.forEach(function(e){a.push({analyticalConfiguration:e.analyticalConfiguration,analyticalConfigurationName:e.analyticalConfigurationName,serializedAnalyticalConfiguration:e.serializedAnalyticalConfiguration})})}var r={analyticalConfigurations:a,textFile:{inDevelopmentLanguage:e.textFile.inDevelopmentLanguage}};t(r)},error:function(n,t,o,l){var c=i.buildErrorMessage(n,"5222",[e],l,a);r(c)},async:true})});return t};this._initText=function(e,i){p.initApplicationTexts(e,i)};this._applyChangesOnTextFile=function(e){e.forEach(function(e){if(e.entitySetName==="texts"){switch(e.method){case"POST":var i=e.data;this._createOrUpdateLocalText(i);break;case"PUT":var n=e.data;this._createOrUpdateLocalText(n);break;case"DELETE":var t=e.application;var r=e.inputParameters[0].value;this._deleteLocalText(t,r);break;default:a.check(false,"The method "+e.method+" is not supported during text processing in batch mode by the modeler proxy.");break}}else{a.check(false,"The create/update/delete operation on entity set "+e.entitySetName+" is not supported by the modeler proxy.")}}.bind(this))};this._createTextFileOfApplication=function(e){return p.createTextFileOfApplication(e)};this._createOrUpdateLocalText=function(e){p.addText(e)};this._deleteLocalText=function(e,i){var n={application:e,inputParameters:[{value:i}]};p.removeText(n)};this._updateRemoteTextFile=function(e,n,t,r){var o=new Promise(function(o,l){var c;if(r===true){c=y(s+"/"+e)}else{c=y(s+"/"+e+"/"+n)}var u={serializedTextFile:t};z({type:"PUT",data:JSON.stringify(u),url:c,success:function(e,i,n){o()},error:function(n,t,r,o){var c=i.buildErrorMessage(n,"5230",[e],o,a);l(c)},async:true})});return o};this.readCollectionsInBatch=function(e,i){var n=e[0];a.check(n.entitySetName==="configuration","wrong usage, only 'configuration' is allowed");var t=n.filter.getFilterTermsForProperty("Application");var r=t[0].getValue();function o(){function e(e,n,a){if(a){i(undefined,a)}else{var t=[];t.push(e);t.push(p.getTextElements(r));i(t)}}return e}this.readCollection(n.entitySetName,o(),n.inputParameters,n.selectList,n.filter)};function L(e,i,n){var a=n.createMessageObject({code:"5214",aParameters:[e.status,e.statusText]});if(i){a.setPrevious(i)}return a}this.importVendorContent=function(e,i,n,a,t){this.readAllConfigurationsFromVendorLayer().done(function(r){D(e,i,n,a,t,r)}).fail(function(e){a(undefined,undefined,e)})};function D(e,i,n,t,r,o){var c;var u,s;var f=e+"."+i;for(c=0;c<o.length;c++){if(o[c].value===f){s=o[c].configurationText;u=o[c].applicationText;break}}z({type:"HEAD",url:y(l+"/"+i),success:function(){n(g,v,s)},error:function(e,n,r,o){if(e.status===404){j(i,p)}else{var l=L(e,o,a);t(undefined,undefined,l)}}});function p(i,n,a){if(!a){r(e,u)}t(i,n,a)}function g(){j(i,t)}function v(n){var r=y(d+"/"+i+"?$select=SerializedAnalyticalConfiguration");z({type:"GET",url:r,success:function(i){U(e,n,i.serializedAnalyticalConfiguration,t)},error:function(e,i,n,r){var o=L(e,r,a);t(undefined,undefined,o)}})}}function U(e,i,n,t){var r=y(l);var o={analyticalConfigurationName:i,application:e,serializedAnalyticalConfiguration:n};z({type:"POST",url:r,dataType:"json",data:JSON.stringify(o),success:function(e){t(e.analyticalConfiguration)},error:function(e,i,n,r){var o=L(e,r,a);t(undefined,undefined,o)}})}function j(e,i){z({type:"PUT",url:y(f+"/"+e),contentType:"application/x-www-form-urlencoded",success:function(){i(e)},error:function(e,n,t,r){var o=L(e,r,a);i(undefined,undefined,o)}})}var P;this.readAllConfigurationsFromVendorLayer=function(){var e=jQuery.Deferred();if(P){e.resolve(P)}else{z({url:y(d+"?$select=Application,ApplicationName,AnalyticalConfiguration,AnalyticalConfigurationName"),success:function(i){var n=[];if(i!==null){i.forEach(function(e){n.push({configurationText:e.analyticalConfigurationName,applicationText:e.applicationName,value:e.application+"."+e.analyticalConfiguration})})}P=n;e.resolve(n)},error:function(i,n,t,r){var o=L(i,r,a);var l=a.createMessageObject({code:"5231"});l.setPrevious(o);e.reject(l)}})}return e.promise()};function z(e){return n.instances.ajaxHandler.send(e)}}var a={ModelerProxy:n};return a},true);
//# sourceMappingURL=modelerProxy.js.map
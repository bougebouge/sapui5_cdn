/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2017 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/core/util/MockServer","sap/apf/utils/utils","sap/base/Log","sap/ui/util/Storage","sap/ui/thirdparty/jquery","sap/apf/utils/parseTextPropertyFile"],function(t,e,a,r,jQuery){"use strict";var r=new r;return n;function n(e){var n=[];var i=r;var o={setupConstants:function(t){this.constants={LOCAL_STORAGE_CONFIGURATION:"ApfConfiguration",LOCAL_STORAGE_TEXTS:"ApfTexts",CONFIGURATION_ENTITYSET:"AnalyticalConfigurationQueryResults",TEXTS_ENTITYSET:"TextElementQueryResults",RUNTIME_DATA_PATH:t+"model/apf/",RUNTIME_SERVICE_URL:"/sap/hba/r/apf/core/odata/apf.xsodata/",RUNTIME_SERVICE_METADATA:t+"model/apf/AnalysisPath.xml",PATH_ENTITYSET:"AnalysisPathQueryResults",MODELER_DATA_PATH:t+"model/apf/",CONFIGURATION_SERVICE:"/sap/hba/r/apf/core/odata/modeler/AnalyticalConfiguration.xsodata/",CONFIGURATION_SERVICE_METADATA:t+"model/apf/AnalyticalConfiguration.xml",DEMOKIT_SERVICE_URL:"/tmp/demokit/demokit.xsodata/",DEMOKIT_METADATA:t+"model/data/Demokit.xml",DEMOKIT_DATA_PATH:t+"model/data/",DEMOKIT_HIERARCHY_SERVICE_URL:"/tmp/demokit/hierarchy.xsodata/",DEMOKIT_HIERARCHY_METADATA:t+"model/data/hierarchyMetadata.xml",HIERARCHY_SERVICE_SPEC:{levelProperty:"Customer_Level",hierarchyNode:"Customer_NodeID",parentNode:"Customer_ParentID",measureName:"Revenue"}}},teardownMockserver:function(){n.forEach(function(t){t.stop();t.destroy()})},_getStorage:function(){return i},getConfigurationId:function(t){var e;var a=t.indexOf(o.constants.LOCAL_STORAGE_CONFIGURATION);if(a!==-1){e=t.slice(a+o.constants.LOCAL_STORAGE_CONFIGURATION.length)}return e},getAllConfigurationIdsInStorage:function(){var t=[];Object.keys(sessionStorage).forEach(function(e){var a=o.getConfigurationId(e);if(a){t.push(a)}});return t},getConfigurationFromLocalStorage:function(t){return i.get(o.constants.LOCAL_STORAGE_CONFIGURATION+t)},idIsContained:function(t,e){return t.reduce(function(t,a){return t||a.AnalyticalConfiguration===e},false)},importTextsFromFile:function(t,e,r){r=r||function(){};jQuery.ajax({url:t,method:"GET",dataType:"text"}).done(function(t){var a=sap.apf.utils.parseTextPropertyFile(t,{instances:{messageHandler:function(){}}});var n=[];a.TextElements.forEach(function(t){n.push(t)});e.setEntitySetData(o.constants.TEXTS_ENTITYSET,n);r(n)}).fail(function(e,n,i){var o='while importing "'+t+'" jQuery.ajax fails with '+n+",  "+i;a.error(i);r({errorText:o,filePath:t})})},mockDemokitService:function(){var t=new sap.ui.core.util.MockServer({rootUri:o.constants.DEMOKIT_SERVICE_URL});t.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,o._postProcessDemokitData);t.simulate(o.constants.DEMOKIT_METADATA,o.constants.DEMOKIT_DATA_PATH);t.start();n.push(t);return t},_loadAnalyticalConfiguration:function(t){function e(t){var e=t.AnalyticalConfiguration;t.SerializedAnalyticalConfiguration=o.getConfigurationFromLocalStorage(e);t.AnalyticalConfigurationName=JSON.parse(t.SerializedAnalyticalConfiguration).analyticalConfigurationName}var a=t.mParameters.oEntry;if(a){if(a.SerializedAnalyticalConfiguration&&a.AnalyticalConfigurationName){e(a)}}else if(Array.isArray(t.mParameters.oFilteredData.results)){var r=t.mParameters.oFilteredData.results;r.forEach(function(t){e(t)})}},_initialLoadConfigurationsToMockServer:function(t,e){function a(t,e){for(var a in t){if(t.hasOwnProperty(a)){e(t[a])}}}var r=[];o.getAllConfigurationIdsInStorage().forEach(function(t){var e=o.getConfigurationFromLocalStorage(t);var a=JSON.parse(e);s(a)});a(e,s);a(e,n);t.setEntitySetData("AnalyticalConfigurationQueryResults",r);function n(t){var e=t.configHeader.AnalyticalConfiguration;if(!o.getConfigurationFromLocalStorage(e)){var a=JSON.stringify(t);i.put(o.constants.LOCAL_STORAGE_CONFIGURATION+e,a)}}function s(t){var e=t.configHeader.AnalyticalConfiguration;if(o.idIsContained(r,e)){return}var a=JSON.stringify(t);var n={AnalyticalConfiguration:e,Application:t.configHeader.Application,AnalyticalConfigurationName:t.configHeader.AnalyticalConfigurationName,SerializedAnalyticalConfiguration:a,CreationUTCDateTime:"/Date(1478533989544)/",LastChangeUTCDateTime:"/Date(1478533989544)/",CreatedByUser:"demokit engine",LastChangedByUser:null};r.push(n)}},savePath:function(t){var e=t.mParameters.oXhr.requestBody;var a=JSON.parse(e);if(!a.AnalysisPath){a.AnalysisPath=sap.apf.utils.createPseudoGuid()}if(!a.CreationUTCDateTime){a.CreationUTCDateTime="/Date("+(new Date).getTime()+")/"}if(!a.LastChangeUTCDateTime){a.LastChangeUTCDateTime="/Date("+(new Date).getTime()+")/"}t.mParameters.oXhr.requestBody=JSON.stringify(a)},mockRuntimeService:function(e){var a=new t({rootUri:o.constants.RUNTIME_SERVICE_URL});a.attachBefore(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,o.savePath,o.constants.PATH_ENTITYSET);a.attachBefore(sap.ui.core.util.MockServer.HTTPMETHOD.POST,o.savePath,o.constants.PATH_ENTITYSET);a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,o._loadAnalyticalConfiguration,o.constants.CONFIGURATION_ENTITYSET);a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,o.loadTexts,o.constants.TEXTS_ENTITYSET);a.simulate(o.constants.RUNTIME_SERVICE_METADATA,o.constants.RUNTIME_DATA_PATH);n.push(a);a.start();o._initialLoadConfigurationsToMockServer(a,e);return a},mockConfigurationService:function(e){var a=new t({rootUri:o.constants.CONFIGURATION_SERVICE});a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,o._loadAnalyticalConfiguration,o.constants.CONFIGURATION_ENTITYSET);a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,o.saveAnalyticalConfiguration.bind(null,"PUT"),o.constants.CONFIGURATION_ENTITYSET);a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.POST,o.saveAnalyticalConfiguration.bind(null,"POST"),o.constants.CONFIGURATION_ENTITYSET);a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.POST,o.saveText,o.constants.TEXTS_ENTITYSET);a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,o.saveText,o.constants.TEXTS_ENTITYSET);a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,o.loadTexts,o.constants.TEXTS_ENTITYSET);a.simulate(o.constants.CONFIGURATION_SERVICE_METADATA,o.constants.MODELER_DATA_PATH);n.push(a);a.start();o._initialLoadConfigurationsToMockServer(a,e);return a},saveAnalyticalConfiguration:function(t,e){var a=e.mParameters.oEntity.SerializedAnalyticalConfiguration;var r;var n=e.mParameters.oEntity.AnalyticalConfiguration;if(t==="POST"){n=sap.apf.utils.createPseudoGuid();e.mParameters.oEntity.AnalyticalConfiguration=n;r=JSON.parse(a);r.configHeader.AnalyticalConfiguration=n;a=JSON.stringify(r);e.mParameters.oEntity.SerializedAnalyticalConfiguration=a}i.put(o.constants.LOCAL_STORAGE_CONFIGURATION+n,a)},saveText:function(t){t.mParameters.oEntity=t.mParameters.oEntity||{};if(!sap.apf.utils.isValidGuid(t.mParameters.oEntity.TextElement)){t.mParameters.oEntity.TextElement=sap.apf.utils.createPseudoGuid()}var e=i.get(o.constants.LOCAL_STORAGE_TEXTS);if(!e){e=[]}else{e=JSON.parse(e)}e.push({TextElement:t.mParameters.oEntity.TextElement,TextElementDescription:t.mParameters.oEntity.TextElementDescription,MaximumLength:t.mParameters.oEntity.MaximumLength,TextElementType:t.mParameters.oEntity.TextElementType});i.put(o.constants.LOCAL_STORAGE_TEXTS,JSON.stringify(e))},loadTexts:function(t){var e=i.get(o.constants.LOCAL_STORAGE_TEXTS);if(e){t.mParameters.oFilteredData=t.mParameters.oFilteredData||{};t.mParameters.oFilteredData.results=t.mParameters.oFilteredData.results||[];e=JSON.parse(e);e.forEach(function(e){t.mParameters.oFilteredData.results.push(e)})}},mockHierarchyService:function(){var t=jQuery.sap.sjax({url:o.constants.DEMOKIT_DATA_PATH+"RevenueHryQueryResults.json",dataType:"json"}).data;var e=new sap.ui.core.util.MockServer({rootUri:o.constants.DEMOKIT_HIERARCHY_SERVICE_URL});e.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,a);e.simulate(o.constants.DEMOKIT_HIERARCHY_METADATA,o.constants.DEMOKIT_DATA_PATH);e.start();n.push(e);return e;function a(e){var a;var n=e.getParameters().oFilteredData;var l=e.getParameters().oXhr.url;var d=l.indexOf("P_Currency")+14;var p=l.indexOf("%27",d);var v=l.slice(d,p);var _=E(JSON.parse(JSON.stringify(t)),"Currency",[v],true);_=E(_,"Country",c(l,"Country"),true);_=E(_,"Customer",c(l,"Customer"),true);a=_;var A=c(l,"Customer_NodeID");if(A.length>0){_=s(_,A)}var g=l.indexOf("Customer_ParentID%20eq")+28;if(g>=28){var h=l.indexOf("%27",g);var C=l.slice(g,h);_=E(_,"Customer_ParentID",[T(C)],false)}if(l.indexOf("Customer_Level%20eq%200")>-1){_=i(_)}f(_,a);m(_);_=r(_);u(_,l);var O=o._parseUrl(l);n.results=o._sortData(o._aggregateData(_),O.parameters.$orderby)}function r(t){var e=[];t.forEach(function(t){if(t.Revenue===undefined||t.Revenue>0){e.push(t)}});return e}function i(t){var e=[];var a=[];t.forEach(function(t){a.push(t.Customer_NodeID)});t.forEach(function(t){if(a.indexOf(t.Customer_ParentID)===-1){e.push(t)}});return e}function s(t,e){var a=[];var r=false;var n=[];e.forEach(function(t){n.push(T(t))});t.forEach(function(t){if(n.indexOf(t.Customer_NodeID)>-1){a.push(t);r=true}});function i(t){if(n.indexOf(t.Customer_ParentID)>-1&&n.indexOf(t.Customer_NodeID)===-1){a.push(t);n.push(t.Customer_NodeID);r=true}}while(r){r=false;t.forEach(i)}return a}function u(t,e){e=T(e);var a=e.indexOf("$select");if(a>-1&&t.length>0){var r=e.indexOf("$",a+1);Object.keys(t[0]).forEach(function(n){if(n!=="__metadata"){var i=e.indexOf(n+"&",a);var o=e.indexOf(n+",",a);var s=i===-1?o:i;if(s<0||r>-1&&s>r){t.forEach(function(t){delete t[n]})}}})}}function c(t,e){var a=0;var r=[];r[a]=[];var n=t.indexOf(e+"%20eq%20%27")+e.length+11;while(n>=e.length+11){if(o&&o>-1&&o<n){a++;r[a]=[]}var i=t.indexOf("%27",n);r[a].push(t.slice(n,i));var o=t.indexOf("%20and%20",i);n=t.indexOf(e+"%20eq%20%27",i)+e.length+11}if(a>0){var s=r[0];var u=[];r.forEach(function(t){s.forEach(function(e){if(t.indexOf(e)>=0){u.push(e)}});s=u});return u}return r[a]}function f(t,e){t.forEach(function(t){if(t.Revenue===null){t.Revenue=l(t,e)}})}function l(t,e){var a=t.Customer_NodeID;var r=0;e.forEach(function(t){if(t.Customer_ParentID===a){if(t.Revenue===null){r+=l(t,e)}else{r+=t.Revenue}}});return r}function T(t){return t.replace(new RegExp("%3a","g"),":").replace(new RegExp("%20","g")," ").replace(new RegExp("%2c","g"),",")}function E(t,e,a,r){if(a.length===0){return t}var n=[];t.forEach(function(t){if(t[e]===null&&r||a.indexOf(t[e])>=0){n.push(t)}});return n}function m(t){t.forEach(function(t){t.__metadata={id:"/tmp/demokit/hierarchy.xsodata/RevenueHryQueryResults('"+t.GenID+"')",type:"tmp.demokit.demokit.RevenueHryQueryResultsType",uri:"/tmp/demokit/hierarchy.xsodata/RevenueHryQueryResults('"+t.GenID+"')"}})}},_postProcessDemokitData:function(t){var e=t.getParameter("oXhr");var a=t.getParameter("oFilteredData");if(e&&a){var r=o._parseUrl(e.url);var n=r.couldParse&&(r.parameters.$top!==undefined||r.parameters.$skip!==undefined);if(n){var i=jQuery.extend({},r.parameters);delete i.$top;delete i.$skip;var s=o._generateUrlString(r.path,i);var u=jQuery.sap.sjax({url:s,dataType:"json"}).data.d;var c=r.parameters.$skip||0;var f=r.parameters.$top;var l;if(f){l=u.results.slice(c,Number(c)+Number(f))}else{l=u.results.slice(c)}a.results=l;a.__count=u.__count}else{a.results=o._attachGUIDs(o._sortData(o._aggregateData(a.results||[]),r.parameters.$orderby));a.__count=a.results.length}}},_aggregateData:function(t){var e=["Revenue","ShippingCosts","Discount","NumberOfOrders"];var a=[];if(t.length>0){var r={};var n=Object.getOwnPropertyNames(t[0]);var i=[];var o=[];n.forEach(function(t){if(t!=="__metadata"){if(e.indexOf(t)>-1){o.push(t)}else{i.push(t)}}});if(o.length>0){t.forEach(function(t){var e="";var a=false;i.forEach(function(r){if(t[r]===null){a=true}e=e+t[r]});if(a){return}if(!r[e]){r[e]=jQuery.extend(true,{},t);o.forEach(function(a){r[e][a]=Number(t[a])})}else{o.forEach(function(a){r[e][a]=Number(r[e][a])+Number(t[a])})}});a=jQuery.map(r,function(t){return t});if(a.length>0){return a}}else if(i.length===1||i.length===2){var s=[];t.forEach(function(t){if(s&&Array.prototype.indexOf.call(s,t[i[0]])===-1){s.push(t[i[0]]);a.push(t)}});if(a.length>0){return a}}}return t},_sortData:function(t,e){var a=o._parseOrderBy(e);if(a.length===0){return t}var r=t.slice().sort(function(t,e){var r=a.filter(function(a){return t[a.attr]!==e[a.attr]})[0];if(!r){return 0}if(t[r.attr]>e[r.attr]){return r.direction}return-r.direction});return r},_parseOrderBy:function(t){if(typeof t!=="string"||t.trim()===""){return[]}var e=t.split(",").map(function(t){var e=t.trim().split("%20");if(e[1]&&e[1].toLowerCase().trim()==="desc"){return{attr:e[0].trim(),direction:-1}}return{attr:e[0].trim(),direction:1}});return e},_parseUrl:function(t){if(typeof t!=="string"){return{couldParse:false}}var e=t.split("?");if(e.length<1||e.length>2){return{couldParse:false}}else if(e.length==1){return{couldParse:true,path:e[0],parameters:{}}}var a={};e[1].split("&").map(function(t){var e=t.split("=");var a=e[0];var r=e[1];return{lhs:a,rhs:r}}).forEach(function(t){a[t.lhs]=t.rhs});return{couldParse:true,path:e[0],parameters:a}},_generateUrlString:function(t,e){var a=Object.keys(e).map(function(t){return t+"="+e[t]}).join("&");return t+"?"+a},_attachGUIDs:function(t){return t.map(function(t){if(t.__metadata){var e="('"+sap.apf.utils.createPseudoGuid()+"')";var a=jQuery.extend(true,{},t);a.__metadata.uri=t.__metadata.uri.replace("('undefined')",e);a.__metadata.id=t.__metadata.id.replace("('undefined')",e);return a}return t})}};o.setupConstants(e);return o}});
//# sourceMappingURL=mockserver.js.map
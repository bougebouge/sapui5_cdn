/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
sap.ui.define(["sap/apf/modeler/ui/utils/representationHandler","sap/apf/ui/utils/constants","sap/apf/core/constants","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/sortDataHandler","sap/apf/modeler/ui/utils/representationBasicDataHandler","sap/apf/modeler/ui/utils/stepPropertyMetadataHandler","sap/apf/ui/utils/representationTypesHandler","sap/apf/modeler/ui/utils/viewValidator","sap/ui/core/mvc/Controller"],function(e,t,r,n,a,i,o,s,p,d,u){"use strict";var l,f,T,c,g,y,v,m,h,C;var D=r.representationMetadata.labelDisplayOptions;function P(e){e.byId("idVisualization").setText(f.getText("visualization"));e.byId("idChartTypeLabel").setText(f.getText("chartType"));e.byId("idChartTypeLabel").setTooltip(f.getText("chartType"));e.byId("idBasicData").setText(f.getText("basicData"));e.byId("idSorting").setText(f.getText("sorting"));e.byId("idChartType").setValueStateText(f.getText("modeler.ui.representation.invalidChartTypeError"))}function w(e,t){var r;var n=y.getPictureOfRepresentationType(c.getRepresentationType());var a=T.getCategoriesForStep(g.getId());if(a.length===1){r={id:c.getId(),icon:n};if(t){r.name=t}e.getView().getViewData().updateSelectedNode(r)}else{e.getView().getViewData().updateTree()}}function E(e,t){var r=f.getText("representation")+": "+t;e.getView().getViewData().updateTitleAndBreadCrumb(r)}function I(e){c.setRepresentationType(e);var r="TableRepresentation";if(e===t.representationTypes.TABLE_REPRESENTATION||e===t.representationTypes.TREE_TABLE_REPRESENTATION){r=undefined}c.setAlternateRepresentationType(r)}function V(e){var t;var r=jQuery.Deferred();v.getEntityTypeMetadataAsPromise().done(function(n){var a=v.getDimensionsProperties(n);var i=y.getKindsForDimensionPropertyType(e);i.forEach(function(e,r){t=false;var i;var o;var s=a[r];if(c.getDimensions().length!==0){if(c.getDimensions()[r]){if(c.getDimensionKind(c.getDimensions()[r])){t=true}}}if(!t&&s){i=v.hasTextPropertyOfDimension(n,s);o=i?D.KEY_AND_TEXT:D.KEY;c.addDimension(s);c.setLabelDisplayOption(s,o);c.setDimensionKind(s,e)}});r.resolve()});return r.promise()}function R(e){var t;var r=v.oStep.getService();var n=v.oStep.getEntitySet();var a=v.oStep.getHierarchyProperty();T.getHierarchyNodeIdAsPromise(r,n,a).done(function(r){t=v.hasTextPropertyOfDimension(e,r)});return t}function b(e){var t,r;var n=jQuery.Deferred();v.getEntityTypeMetadataAsPromise().done(function(e){var a=v.getHierarchicalProperty();if(a&&c.getHierarchyPropertyLabelDisplayOption()===undefined){t=R(e);r=t?D.TEXT:D.KEY;c.setHierarchyPropertyLabelDisplayOption(r)}n.resolve()});return n.promise()}function x(e){var t=jQuery.Deferred(),r,n;var a;var i=0;v.getEntityTypeMetadataAsPromise().done(function(o){a=y.getKindsForMeasurePropertyType(e);r=v.getMeasures(o);a.forEach(function(t){var a=y.getDefaultCountForRepresentationKind(e,t);for(var o=0;o<a;o++){n=false;var s=r[i];if(c.getMeasures().length!==0){if(c.getMeasures()[i]){if(c.getMeasureKind(c.getMeasures()[i])){n=true}}}if(!n&&s){c.addMeasure(s);c.setMeasureKind(s,t)}i++}});t.resolve()});return t.promise()}function S(e){var t=jQuery.Deferred();var r,n;if(e==="TableRepresentation"){if(c.getProperties().length===0){n=y.getKindsForPropertyType(e);r=v.getProperties()[0];c.addProperty(r);c.setPropertyKind(r,n[0]);t.resolve()}else{t.resolve()}}else if(e==="TreeTableRepresentation"){b(e).done(function(){t.resolve()})}else{V(e).done(function(){x(e).done(function(){t.resolve()})})}return t.promise()}function M(){if(l&&l.arguments&&l.arguments.stepId){g=T.getStep(l.arguments.stepId)}}function A(){var e=f.getRepresentationTypes()[0].id;if(g.getType()==="hierarchicalStep"){e="TreeTableRepresentation"}return e}function O(e){var t;var r=jQuery.Deferred();if(l&&l.arguments&&l.arguments.representationId){c=g.getRepresentation(l.arguments.representationId)}if(!n.checkIsNotUndefined(c)){c=g.createRepresentation();t=A();I(t);w(e,f.getText(t));T.setIsUnsaved();S(t).done(function(){return r.resolve()})}else{t=c.getRepresentationType();j().done(function(){S(t).done(function(){return r.resolve()})})}return r.promise()}function N(e){var t=new sap.m.Button({id:e.createId("idPreviewButton"),text:f.getText("preview"),press:e.handlePreviewButtonPress.bind(e)});var r=e.getView().getViewData().oFooter;r.addContentRight(t)}function K(e){var t=e.getView().getViewData().oConfigurationHandler.getTextPool();var r={oTextReader:f.getText,oConfigurationEditor:T,oTextPool:t,oParentObject:c,oParentStep:g,oRepresentationTypeHandler:y};var n=new sap.ui.controller("sap.apf.modeler.ui.controller.representationCornerTexts");var a=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.cornerTexts",type:sap.ui.core.mvc.ViewType.XML,id:e.createId("representationCornerTexts"),viewData:r,controller:n});e.byId("idCornerTextsVBox").insertItem(a);e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON,a.getController().setChartIcon.bind(a.getController()))}function H(){c.getDimensions().forEach(function(e){c.removeDimension(e)});c.getMeasures().forEach(function(e){c.removeMeasure(e)})}function L(){var e,t;if(c.getRepresentationType()==="TableRepresentation"){e=c.getDimensions();t=c.getMeasures();e.forEach(function(e){c.addProperty(e);c.setPropertyTextLabelKey(e,c.getDimensionTextLabelKey(e));c.setPropertyKind(e,r.representationMetadata.kind.COLUMN);T.setIsUnsaved()});t.forEach(function(e){c.addProperty(e);c.setPropertyTextLabelKey(e,c.getMeasureTextLabelKey(e));c.setPropertyKind(e,r.representationMetadata.kind.COLUMN);T.setIsUnsaved()});H()}}function B(e){var t;v.getEntityTypeMetadataAsPromise().done(function(r){t=v.hasTextPropertyOfDimension(r,e);if(t){c.setLabelDisplayOption(e,D.KEY_AND_TEXT)}else{c.setLabelDisplayOption(e,D.KEY)}T.setIsUnsaved()})}function _(){var e=jQuery.Deferred();v.getEntityTypeMetadataAsPromise().done(function(t){c.getDimensions().forEach(function(e){if(c.getLabelDisplayOption(e)===undefined){B(e)}});e.resolve()});return e.promise()}function j(){L();return _()}function F(e){C.instantiateRepresentationSortData();K(e);return h.instantiateBasicDataAsPromise()}function U(e){if(!e.getValidationState()){if(e.byId("idChartType").getValueState("None")){setTimeout(function(){e.byId("idChartType").setValueState("Error")},1)}}else{e.byId("idChartType").setValueState("None")}}var Q=u.extend("sap.apf.modeler.ui.controller.representation",{onInit:function(){var t=this;t.promiseControllerIsCreated=new Promise(function(r){var n=t.getView().getViewData();f=n.oCoreApi;l=n.oParams;T=n.oConfigurationEditor;y=new p;t.oViewValidator=new d(t.getView());P(t);M();if(g.getType()!=="hierarchicalStep"){N(t)}v=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(f,g);O(t).then(function(){m=new e(c,y,f.getText);h=new o(t.getView(),v,m,t.oViewValidator);C=new i(t.getView(),c,v,f.getText);F(t).then(function(){t.setDetailData();r()})})})},promiseControllerIsCreated:null,setDetailData:function(){var e=this;e._setChartType()},handleChangeForChartType:function(e){var t=this;var r=e.getParameter("selectedItem").getKey();var n=f.getText(r);var a=c.getRepresentationType();I(r);w(t,n);E(t,n);if(!y.isChartTypeSimilar(a,r)){t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.REMOVEALLPROPERTIESFROMPARENTOBJECT);H();S(r).done(function(){h.instantiateBasicDataAsPromise().then(function(){U(t)});t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);T.setIsUnsaved()})}else{h.instantiateBasicDataAsPromise().then(function(){U(t)});t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);T.setIsUnsaved()}},handlePreviewButtonPress:function(){var e=this;var t={oParentStep:g,oRepresentation:c,oConfigurationHandler:e.getView().getViewData().oConfigurationHandler,oCoreApi:f,oRepresentationHandler:m,oStepPropertyMetadataHandler:v,oRepresentationTypeHandler:y};sap.ui.view({id:e.createId("idPreviewContentView"),viewName:"sap.apf.modeler.ui.view.previewContent",type:sap.ui.core.mvc.ViewType.XML,viewData:t})},onExit:function(){var e=this;e.getView().getViewData().oFooter.removeContentRight(e.byId("idPreviewButton"));h.destroyBasicData();C.destroySortData();e.byId("idCornerTextsVBox").destroyItems()},getValidationState:function(){return this.oViewValidator.getValidationState()},_setChartType:function(){var e=this;v.getEntityTypeMetadataAsPromise().done(function(t){var r;var n=v.getDimensionsProperties(t);var i=v.getMeasures(t);var o=e._getAnnotatedChartTypes(y.aRepresentationTypes,v.getRepresentationTypesArray(),n,i,f);r=a.prepareModel(o);e.byId("idChartType").setModel(r);e.byId("idChartType").setSelectedKey(c.getRepresentationType());U(e)})},_getAnnotatedChartTypes:function(e,t,r,n,a){function i(e,t){var r;e.forEach(function(e){if(e["id"]===t){r=e}});return r}var o=jQuery.extend(true,[],t);o.forEach(function(t){var o=0,s=0;var p=i(e,t.key);if(p.metadata&&p.id!=="TableRepresentation"&&p.id!=="TreeTableRepresentation"){p.metadata.dimensions.supportedKinds.forEach(function(e){o+=parseInt(e.min,10)});p.metadata.measures.supportedKinds.forEach(function(e){s+=parseInt(e.min,10)});if(r.length<o||n.length<s){t.name=a.getText("modeler.ui.representation.invalidChartTypes",[t.name])}}});return o}});return Q},true);
//# sourceMappingURL=representation.controller.js.map
sap.ui.define(["sap/ovp/cards/AnnotationHelper","sap/fe/navigation/SelectionVariant","sap/ui/model/Filter","sap/ovp/cards/Integration/Helpers/Filters","sap/ovp/app/FilterHelper","sap/base/security/encodeURL","sap/ovp/cards/CommonUtils","sap/ui/model/odata/ODataUtils","sap/ui/model/FilterProcessor"],function(t,e,a,r,n,i,l,o,s){"use strict";var f={contentDataUrlUpdated:false,headerDataUrlUpdated:false};function u(t,e){var a=t.split(/\?/);var r=a[1]&&a[1].replace(/^.*\?/,"").split(/&/);var n="";r&&r.forEach(function(t){if(t.indexOf(e)===-1){if(n.length===0){n+=t}else{n+="&"+t}}});return a[0]+(n!==""?"?"+n:"")}function v(t,e){if(t&&e){if(t.indexOf("?")===-1){t+="?"+e}else{t+="&"+e}}return t}function d(t,e){var a=t.split(/\?/);if(a.length>1){var r=a[1].replace(/^.*\?/,"").split(/&/);var n=r.filter(function(t){return t.includes(e)});return n.length===1?n[0]:""}return""}function p(t,e,a,r){if(r){var n=a&&a._oFilterProvider;var i=n&&n._oParameterization;var l=i&&i.getNavigationPropertyToQueryResult();return{_entitySet:{value:i&&i.getName()},_urlSuffix:{value:"/"+l}}}else{var o=e&&e.getModel(),s=o&&o.getMetaModel(),f=s&&s.getODataEntityContainer(),u=f&&f["entitySet"];var v="",d=t&&t.startsWith("/")?t.substr(1):t;u.map(function(t){if(t&&t.name&&d&&d.startsWith(t.name)){v=t.name}});var p=t.split("/").length>2?t.substring(t.lastIndexOf("/")):"";return{_entitySet:{value:v},_urlSuffix:{value:p}}}}function g(e){var a=e.cardComponentData.mainComponent;var r=e.view.getController();var n=a.getGlobalFilter();var i=r.getCardItemsBinding().getPath();var l;if(n&&n.getConsiderAnalyticalParameters()){var o=n.getAnalyticBindingPath();var s=r.getEntitySet().entityType;var f=n.getEntityType();if(o&&o.length>0){if(s===f){l=p(o,r,n,true);return{sPath:o,_entitySet:l._entitySet,_urlSuffix:l._urlSuffix}}}else{var u=r.getCardPropertiesModel().getProperty("/selectionAnnotationPath");var v=e.entityType[u];var d=t.resolveParameterizedEntitySet(r.getModel(),e.entitySet,v);l=p(d,r,n,false);return{sPath:d,_entitySet:l._entitySet,_urlSuffix:l._urlSuffix}}}l=p(i,r,n,false);return{sPath:"",_entitySet:l._entitySet,_urlSuffix:l._urlSuffix}}function c(t,e){var a=e.oMainComponent,r=a.getGlobalFilter(),n=r&&r.getAnalyticBindingPath();var i=e.getEntityType().name;var l=e.getModel();var o=l.getMetaModel();var s=o.getODataEntityContainer();var f=s.entitySet.filter(function(t){return t.entityType===s.namespace+"."+i});var u=f.length>0?f[0]:{};if(r&&r.getConsiderAnalyticalParameters()){var n=r.getAnalyticBindingPath();var v,d,p;if(n&&n.length>0){if(u.entityType===r.getEntityType()){d=t;v=t.indexOf("$");if(v>0){d=t.substring(0,v-1)}p=n;if(p.startsWith("/")){p=p.slice(1)}if(d!==p){t=t.replace(d,p)}}else{var g=a._getParametersFromEntityPath(t);var c=a._getParametersFromEntityPath(n);var h,m,y;var U={};if(g&&g.length>0){var _=a._getEntityTypeFromPath(l,t,U.context,true);for(var P=0;P<c.length;P++){h=a._getPropertyMapping(g,c[P].name,_.name,r.getEntityType(),l,r.getModel());if(h){m=h+"=.*?[,)]";y=t.match(new RegExp(m));if(y&&y.length>0){d=y[0].slice(0,-1);p=h+"="+c[P].sValue;if(d!==p){t=t.replace(d,p)}}}}}}}}return t}function h(t,e,a,r){var n=t.view.getModel("ovpCardProperties");var l=n&&n.getProperty("/bInsightRTEnabled");var o="";if(l||r){o+=_(t)}else{o+=m(t,e)}var s=d(a,"$filter");if(s.length>0){s=decodeURIComponent(s);s=s.replace("$filter=","");s=!s.startsWith("(")?"("+s+")":s}if(o.length>0&&s.length>0){o+=" and "}o+=s;if(o.length!==0){return"$filter="+i(o)}return""}function m(t,n){var i=t.cardComponentData.mainComponent;var l=i.getGlobalFilter();var o=l&&l.getUiState();var s=l&&l.determineMandatoryFilterItems();var f=n.parameters._mandatoryODataFilters.value;var u=new e(o&&o.getSelectionVariant());if(!s||s.length===0||(!f||f.length===0)){return""}else{var v=[];for(var d=0;d<f.length;d++){var p=f[d];var g=u.getSelectOption(p);var c=new a(g);var h=c.aFilters&&c.aFilters.length||0;var m=[];for(var y=0;y<h;y++){var U=c.aFilters[y];var _=r.getSingleFilterValue(U,p);if(_.length>0){m.push(_)}}if(m.length>0){var P=m.join(" or ");P="("+P+")";v.push(P)}}return v.length>0?v.join(" and "):""}}function y(t,e){t&&t.forEach(function(t){if(t&&t.getFilters()){y(t.getFilters(),e)}else if(t&&t.getPath()&&e.indexOf(t.getPath())===-1){e.push(t.getPath())}});return e}function U(t,e){if(t&&e){var a=t&&t.property.filter(function(t){return e.indexOf(t.name)>-1})||[];a.forEach(function(t){var e=t.type||"";if(!e.startsWith("Edm")){t.type="Edm."+t.type}})}}function _(t){var e=t.view;var a=e.getController();var r=a.getEntityType(),i=a.oMainComponent.getGlobalFilter(),l=i&&i.getModel(),f=a.getView().getModel("ovpCardProperties"),u=f&&f.getProperty("/entityType"),v=u&&u.name,d=a.oMainComponent.aFilters;if(r&&l&&v){var p=n.getEntityRelevantFilters(r,d,v,l);if(p.length){var g=s.groupFilters(p),c=y(p,[]),h=e&&e.getModel()&&e.getModel().oMetadata;U(r,c);var m=o.createFilterParams(g,h,r);if(m.length){m=m.replace("$filter=","");m=decodeURIComponent(m);return m}return""}}return""}function P(t,e,a,r){var n=t.view;if(!n){return{}}var i=n.getModel("ovpCardProperties");var l=i&&i.getProperty("/bInsightRTEnabled");var o=t.cardComponentData.model.sServiceUrl;var s=n.getController();var f=a?s.getKPIBinding():s.getCardItemsBinding();var p=f&&f.sRangeParams||"";if(t.cardComponentName==="List"||t.cardComponentName==="Table"){p="$skip=0&$top=13"}var m=g(t);var y=f&&f.getDownloadUrl()||"";var U;if(y){y=u(y,"sap-client");y=u(y,"_requestFrom");y=y.split(o+"/")[1];if(l||r){y=c(y,s)}U=h(t,e,y,r);if(U.length>0){y=u(y,"$filter");y=v(y,U)}var _=d(y,"$inlinecount");if(_.length===0&&(t.cardComponentName==="List"||t.cardComponentName==="Table")){var P="$inlinecount=allpages";y=v(y,P)}if(p){y=v(y,p)}}return{sPath:y,_entitySet:m._entitySet,_urlSuffix:m._urlSuffix}}function S(t,e,a){if(!f.headerDataUrlUpdated){var r=this._getRequestUrlAndEntityInfo(t,e,true,a);e["parameters"]["_headerDataUrl"]={value:r.sPath}}if(!f.contentDataUrlUpdated){var n=this._getRequestUrlAndEntityInfo(t,e,false,a)||"";e["parameters"]["_contentDataUrl"]={value:n.sPath}}f.contentDataUrlUpdated=false;f.headerDataUrlUpdated=false}function D(t,e){var a=t.cardComponentData.settings,r=t.entitySet.name,n={};if(r.endsWith("Results")){r=r.replace("Results","")}if(a.dataPointAnnotationPath||a.kpiAnnotationPath){var i=this._getRequestUrlAndEntityInfo(t,e,true)||"";e["parameters"]["_headerDataUrl"]={value:i.sPath};if(i.sPath){n.header={method:"GET",url:i.sPath,headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"},retryAfter:30}}}var l=this._getRequestUrlAndEntityInfo(t,e,false)||"";e["parameters"]["_contentDataUrl"]={value:l.sPath};if(l.sPath){n.content={method:"GET",url:l.sPath,headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"}}}if(l._entitySet||l._urlSuffix){e["parameters"]["_entitySet"]=l._entitySet;e["parameters"]["_urlSuffix"]=l._urlSuffix}return n}function C(t){var e=t.configuration.parameters;var a=e._mandatoryODataParameters.value;var r=e._mandatoryODataFilters.value;var n=r.some(function(t){var a=e[t]&&e[t].value;var r=true;if(a&&l.isJSONData(a)){a=JSON.parse(a);var n=a&&a["SelectOptions"];n.forEach(function(t){if(t&&t["Ranges"]&&t["Ranges"].length>0){r=false}});return r}return false});var i=a.some(function(t){return e[t]&&!e[t].value});if(n||i){if(!e._headerDataUrl){e._headerDataUrl={value:""}}if(!e._contentDataUrl){e._contentDataUrl={value:""}}e._headerDataUrl.value="";e._contentDataUrl.value="";f.headerDataUrlUpdated=true;f.contentDataUrlUpdated=true}}function E(t){var e=t&&t.data&&t.data.request,a=t&&t.configuration.parameters._headerDataUrl,n=t&&t.configuration.parameters._contentDataUrl,i=a&&a.value,l=n&&n.value;if(e&&e.batch){var o=e.batch.header||{},s=e.batch.content||{},u=r.IsSemanticDateExistsInUrl(i),v=r.IsSemanticDateExistsInUrl(l);if(u){o.url="{= extension.formatters.formatHeaderDataUrlForSemanticDate() }";a.value="";f.headerDataUrlUpdated=true}if(v){s.url="{= extension.formatters.formatContentDataUrlForSemanticDate() }";n.value="";f.contentDataUrlUpdated=true}}else if(e&&e.url){var d=r.IsSemanticDateExistsInUrl(l);if(d){e.url="{= extension.formatters.formatContentDataUrlForSemanticDate() }";n.value="";f.contentDataUrlUpdated=true}}}return{_getQueryParam:d,_removeQueryParam:u,_getRequestUrlAndEntityInfo:P,getBatchObject:D,enhanceHeaderAndContentURL:C,updateBatchObject:S,enhanceHeaderAndContentURLForSemanticDate:E}},true);
//# sourceMappingURL=Batch.js.map
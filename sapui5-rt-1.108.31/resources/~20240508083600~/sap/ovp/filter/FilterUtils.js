sap.ui.define(["sap/ovp/cards/Filterhelper","sap/ovp/app/FilterHelper","sap/ovp/cards/ovpLogger","sap/ui/base/SyncPromise","sap/ui/model/FilterOperator"],function(e,t,r,a,i){"use strict";var l={applyFiltersToV2Card:function(e,a){var i=a.getEntityType(),l=a.oMainComponent.getMacroFilterBar()||a.oMainComponent.getGlobalFilter(),n=l&&l.getModel(),o=a.getView().getModel("ovpCardProperties"),s=o&&o.getProperty("/entityType"),p=s&&s.name;if(i&&n&&p){var g=t.getEntityRelevantFilters(i,e,p,n);var d=t.mergeFilters(g,a.selectionVaraintFilter);try{var c=a.getCardItemsBinding();if(c){c.filter(d)}if(a.getKPIBinding()){a.getKPIBinding().filter(d)}}catch(e){var f=new r("sap.ovp.filter.filterUtils");f.error(e)}}},applyFiltersToV4Card:function(t,a){if(a.getView().getModel().getMetaModel().getData){var i=a.getView().getModel().getMetaModel().getData();var l=a.getView().getModel("ovpCardProperties").getProperty("/entityType");var n=l&&l["$Type"];if(n){var o=e._getEntityRelevantFilters(i[n],t);o=e.mergeFilters(o,a.selectionVaraintFilter);try{a.getCardItemsBinding().filter(o);if(a.getKPIBinding()){a.getKPIBinding().filter(o)}}catch(e){var s=new r("sap.ovp.filter.filterUtils");s.error(e)}}}},applyFiltersToV4AnalyticalCard:function(t,a){if(a.getView().getModel().getMetaModel().getData){var i=a.getView().getModel().getMetaModel().getData();var l=a.getView().getModel("ovpCardProperties").getData().entityType.$Type;var n=e._getEntityRelevantFilters(i[l],t);n=e.mergeFilters(n,a.selectionVaraintFilter);var o=a.getCardItemsBinding();try{if(n&&n.aFilters){this.fetchFilter(n,o,{}).then(function(e){var t=o.mParameters.$apply.split("/").length>1?a.getCardItemsBinding().mParameters.$apply.split("/")[1]:a.getCardItemsBinding().mParameters.$apply.split("/")[0];o.mParameters.$apply="filter("+e+")/"+t;o.setAggregation()}).catch(function(e){var t=new r("sap.ovp.filter.filterUtils- v4Analytical card case");t.error(e)})}else{if(o.mParameters.$apply.split("/").length>1){o.mParameters.$apply=o.mParameters.$apply.split("/")[1];o.setAggregation()}}if(a.getKPIBinding()){a.getKPIBinding().filter(n)}}catch(e){var s=new r("sap.ovp.filter.filterUtils");s.error(e)}}},fetchFilter:function(e,t,r,l){var n;var o=t.oModel.getMetaModel();var s=o.getMetaContext(t.oModel.resolve(t.sPath,t.oContext));if(!e){return a.resolve()}if(e.aFilters){return a.all(e.aFilters.map(function(a){return this.fetchFilter(a,t,r,e.bAnd)},this)).then(function(t){return this.wrap(t.join(e.bAnd?" and ":" or "),l&&!e.bAnd)}.bind(this))}n=o.resolve(this.replaceLambdaVariables(e.sPath,r),s);return o.fetchObject(n).then(function(t){var a,o,s;if(!t){throw new Error("Type cannot be determined, no metadata for path: "+n)}s=e.sOperator;if(s===i.All||s===i.Any){a=e.oCondition;o=e.sVariable;if(s===i.Any&&!a){return e.sPath+"/any()"}r=Object.create(r);r[o]=this.replaceLambdaVariables(e.sPath,r);return this.fetchFilter(a,r).then(function(t){return e.sPath+"/"+e.sOperator.toLowerCase()+"("+o+":"+t+")"})}return this.getSingleFilterValue(e,t.$Type,l)}.bind(this))},wrap:function(e,t){return t?"("+e+")":e},replaceLambdaVariables:function(e,t){var r=e.split("/");r[0]=t[r[0]];return r[0]?r.join("/"):e},getSingleFilterValue:function(t,r,a){var l,n,o,s;function p(e){return o?"tolower("+e+")":e}o=r==="Edm.String"&&t.bCaseSensitive===false;n=p(decodeURIComponent(t.sPath));s=p(e.formatLiteral(t.oValue1,r));switch(t.sOperator){case i.BT:l=n+" ge "+s+" and "+n+" le "+p(e.formatLiteral(t.oValue2,r));break;case i.NB:l=this.wrap(n+" lt "+s+" or "+n+" gt "+p(e.formatLiteral(t.oValue2,r)),a);break;case i.EQ:case i.GE:case i.GT:case i.LE:case i.LT:case i.NE:l=n+" "+t.sOperator.toLowerCase()+" "+s;break;case i.Contains:case i.EndsWith:case i.NotContains:case i.NotEndsWith:case i.NotStartsWith:case i.StartsWith:l=t.sOperator.toLowerCase().replace("not","not ")+"("+n+","+s+")";break;default:throw new Error("Unsupported operator: "+t.sOperator)}return l}};return{applyFiltersToV2Card:l.applyFiltersToV2Card,applyFiltersToV4Card:l.applyFiltersToV4Card,applyFiltersToV4AnalyticalCard:l.applyFiltersToV4AnalyticalCard,fetchFilter:l.fetchFilter,wrap:l.wrap,replaceLambdaVariables:l.replaceLambdaVariables,getSingleFilterValue:l.getSingleFilterValue}});
//# sourceMappingURL=FilterUtils.js.map
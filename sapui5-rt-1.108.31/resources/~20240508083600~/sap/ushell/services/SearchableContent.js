// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/Config","sap/ushell/adapters/cdm/v3/_LaunchPage/readApplications","sap/ushell/adapters/cdm/v3/_LaunchPage/readPages","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/base/util/values","sap/ui/thirdparty/jquery","sap/ushell/library","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/base/Log"],function(e,t,i,a,n,jQuery,r,o,s){"use strict";var l=r.DisplayFormat;var u=function(){};u.COMPONENT_NAME="sap/ushell/services/SearchableContent";u.prototype.getApps=function(){if(e.last("/core/spaces/enabled")){return this._getPagesAppData().then(this._filterGetApps)}return this._getLaunchPageAppData().then(this._filterGetApps).then(function(e){s.debug("SearchableContent@getApps in classic mode found "+e.length+" apps");return e}).catch(function(e){s.error("SearchableContent@getApps in classic mode failed",e);return Promise.reject(e)})};u.prototype._filterGetApps=function(e){e.forEach(function(e){var t=e.visualizations;var i=[];e.visualizations=[];t.forEach(function(t){var a=JSON.stringify({title:t.title,subtitle:t.subtitle,icon:t.icon,vizTypeId:t.vizTypeId});if(i.indexOf(a)===-1){e.visualizations.push(t);i.push(a)}})});return e.filter(function(e){return e.visualizations.length>0})};u.prototype._getLaunchPageAppData=function(){return sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){this._oLaunchPageService=e;return this._collectLaunchPageTiles()}.bind(this)).then(function(e){return Promise.all(e.map(function(e){var t={tileId:null,tile:e};var i;try{t.tileId=this._oLaunchPageService.getCatalogTileId(e)||this._oLaunchPageService.getTileId(e);i=this._oLaunchPageService.getCatalogTilePreviewTitle(e)}catch(e){s.error("Could not get search data from tile "+t.tileId,e)}if(!i){return new Promise(function(t,i){this._oLaunchPageService.getCatalogTileViewControl(e).done(t).fail(i)}.bind(this)).then(function(e){t.view=e;return t}).catch(function(e){s.error("Could not get search data from tile "+t.tileId,e);return t})}return Promise.resolve(t)}.bind(this)))}.bind(this)).then(function(e){var t={};var i=e.map(function(e){try{return this._buildVizDataFromLaunchPageTile(e.tile)}catch(t){s.error("Could not get search data from tile "+e.tileId,t);return null}}.bind(this)).filter(function(e){return e});e.forEach(function(e){var t=e.view;if(t){if(!t.destroy){s.error("The tile with id '"+e.tileId+"' does not implement mandatory function destroy")}else{t.destroy()}}});i.forEach(function(e){var i=e.targetURL;if(i){if(t[i]){t[i].visualizations.push(e)}else{t[i]=this._buildAppDataFromViz(e)}}}.bind(this));return n(t)}.bind(this))};u.prototype._collectLaunchPageTiles=function(){var e=this._oLaunchPageService.getGroups().then(function(e){return e.reduce(function(e,t){return Promise.all([e,this._oLaunchPageService.getGroupTilesForSearch(t)]).then(function(e){var t=e[0];var i=e[1];return t.concat(i)})}.bind(this),Promise.resolve([]))}.bind(this));var t=this._oLaunchPageService.getCatalogs().then(function(e){return e.reduce(function(e,t){return Promise.all([e,this._oLaunchPageService.getCatalogTiles(t)]).then(function(e){var t=e[0];var i=e[1];return t.concat(i)})}.bind(this),Promise.resolve([]))}.bind(this));return Promise.all([t,e]).then(function(e){return e[0].concat(e[1])})};u.prototype._getPagesAppData=function(){var e,t;return sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(e){return Promise.all([e.getAllPages({personalizedPages:true}),e.getApplications(),e.getVisualizations(),e.getVizTypes(),sap.ushell.Container.getServiceAsync("URLParsing"),sap.ushell.Container.getServiceAsync("ClientSideTargetResolution")])}).then(function(i){var a=i[0];var n=i[1];var r=i[2];var o=i[3];var s=i[4];var l=i[5];t={applications:n,visualizations:r,vizTypes:o};e={};this._applyCdmVisualizations(t,e,s);this._applyCdmPages(t,a,e,s);return this._filterAppDataByIntent(e,s,l)}.bind(this)).then(function(){this._applyCdmApplications(t,e);return n(e)}.bind(this))};u.prototype._filterAppDataByIntent=function(e,t,i){var a=Object.keys(e).map(function(e){return t.isIntentUrlAsync(e).then(function(t){return t?e:null})});return Promise.all(a).then(function(t){var a=t.filter(function(e){return!!e});if(a.length===0){return}var n=500;var r=0;var o=n;var s=[];while(r<a.length){s.push(a.slice(r,o));r=r+n;o=o+n}return s.reduce(function(t,a){return t.then(function(e){return new Promise(function(t,a){i.isIntentSupported(e).done(t).fail(a)})}.bind(null,a)).then(function(t){Object.keys(t).forEach(function(i){if(!t[i].supported&&e[i]){delete e[i]}})}).catch(function(){})},Promise.resolve())})};u.prototype._applyCdmApplications=function(e,i){Object.keys(i).forEach(function(a){try{var n=i[a].visualizations;var r=n.find(function(e){return e.target.appId&&e.target.inboundId});if(r){var o=e.applications[r.target.appId];var l=t.getInbound(o,r.target.inboundId);i[a]=this._buildAppDataFromAppAndInbound(o,l);i[a].visualizations=n;i[a].target=n[0].target}else{i[a]=this._buildAppDataFromViz(n[0]);i[a].visualizations=n;i[a].target=n[0].target}}catch(e){s.error("Could not get search data from application "+a,e)}}.bind(this))};u.prototype._applyCdmVisualizations=function(e,t,i){Object.keys(e.visualizations).forEach(function(n){try{var r={vizId:n,displayFormatHint:l.Standard};var o=a.getVizData(e,r,i);var u=o.targetURL;this._changeVizType(o);o.preview=true;if(u){if(t[u]){t[u].visualizations.push(o)}else{t[u]={visualizations:[o]}}}}catch(e){s.error("Could not get search data from visualization "+n,e)}}.bind(this))};u.prototype._applyCdmPages=function(e,t,n,r){t.forEach(function(t){var o=i.getVisualizationReferences(t);o.forEach(function(t){try{if(t.displayFormatHint&&t.displayFormatHint!==l.Standard){t=Object.assign({},t);t.displayFormatHint=l.Standard}var i=a.getVizData(e,t,r);var o=i.targetURL;this._changeVizType(i);i.preview=true;if(o){if(n[o]){n[o].visualizations.push(i)}else{n[o]={visualizations:[i]}}}}catch(e){s.error("Could not get search data from vizReference "+t.id,e)}}.bind(this))}.bind(this))};u.prototype._changeVizType=function(e){if(e._instantiationData.platform==="CDM"&&!o.isStandardVizType(e.vizType)){e.vizType="sap.ushell.StaticAppLauncher";e._instantiationData.vizType={"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}};u.prototype._buildAppDataFromAppAndInbound=function(e,i){return{id:t.getId(e),title:i.title||t.getTitle(e),subtitle:i.subTitle||t.getSubTitle(e),icon:i.icon||t.getIcon(e),info:i.info||t.getInfo(e),keywords:i.keywords||t.getKeywords(e),visualizations:[]}};u.prototype._buildAppDataFromViz=function(e){return{id:e.vizId,title:e.title,subtitle:e.subtitle,icon:e.icon,info:e.info,keywords:e.keywords,target:e.target,visualizations:[e]}};u.prototype._buildVizDataFromLaunchPageTile=function(e){var t;if(this._oLaunchPageService.getCatalogTileTargetURL(e)&&this._oLaunchPageService.isTileIntentSupported(e)){t={id:this._oLaunchPageService.getTileId(e)||this._oLaunchPageService.getCatalogTileId(e),vizId:this._oLaunchPageService.getCatalogTileId(e)||this._oLaunchPageService.getTileId(e)||"",vizTypeId:"",title:this._oLaunchPageService.getCatalogTilePreviewTitle(e)||this._oLaunchPageService.getCatalogTileTitle(e)||this._oLaunchPageService.getTileTitle(e)||"",subtitle:this._oLaunchPageService.getCatalogTilePreviewSubtitle(e)||"",icon:this._oLaunchPageService.getCatalogTilePreviewIcon(e)||"sap-icon://business-objects-experience",info:this._oLaunchPageService.getCatalogTilePreviewInfo(e)||"",keywords:this._oLaunchPageService.getCatalogTileKeywords(e)||[],target:{type:"URL",url:this._oLaunchPageService.getCatalogTileTargetURL(e)},targetURL:this._oLaunchPageService.getCatalogTileTargetURL(e)};if(e.getChip){t._instantiationData={platform:"LAUNCHPAGE",launchPageTile:e}}else{t._instantiationData={platform:"CDM",vizType:{"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}}}return t};u.hasNoAdapter=true;return u},true);
//# sourceMappingURL=SearchableContent.js.map
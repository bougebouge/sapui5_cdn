// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessageAPI","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/base/util/UriParameters","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/core/BusyIndicator","sap/ushell/appRuntime/ui5/performance/FesrEnhancer","sap/ushell/EventHub","sap/base/Log","sap/ui/thirdparty/hasher","sap/ushell/resources"],function(e,t,s,i,jQuery,r,a,n,o,u,p,l){"use strict";function d(){var d=this,c,f,h=true,g={},v,C={},y={},m={},b={},I={},S,A,w,R,O;this.init=function(i,r,a,u,f,g){S=undefined;c=i;v=r;A=a;if(u!==undefined){h=u}this.addAppInfoToCache(f,g);e.registerCommHandlers({"sap.ushell.services.appLifeCycle":{oServiceCalls:{create:{executeServiceCallFn:function(e){n.startInteraction();var t=JSON.parse(e.oMessage.data),i=s.fromURL(t.body.sUrl).get("sap-ui-app-id");p.disableCFLPUpdate=true;p.replaceHash("");p.replaceHash(t.body.sHash);p.disableCFLPUpdate=false;return d.create(i,t.body.sUrl)}},destroy:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);d.destroy(t.body.sCacheId);return(new jQuery.Deferred).resolve().promise()}},store:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);d.store(t.body.sCacheId);return(new jQuery.Deferred).resolve().promise()}},restore:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);p.disableCFLPUpdate=true;p.replaceHash("");p.replaceHash(t.body.sHash);p.disableCFLPUpdate=false;d.restore(t.body.sCacheId);return(new jQuery.Deferred).resolve().promise()}}}}});o.on("disableKeepAliveRestoreRouterRetrigger").do(function(e){if(e.componentId&&m[e.componentId]){m[e.componentId]=e.disable}});t.sendMessageToOuterShell("sap.ushell.services.appLifeCycle.setup",{isStateful:true,isKeepAlive:true,isIframeValid:true,session:{bLogoutSupport:true}});if(!l.browserI18n){l.browserI18n=l.getTranslationModel(window.navigator.language).getResourceBundle()}R=l.browserI18n.getText("dataLossExternalMessage");window.onbeforeunload=function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getDirtyFlag()){return R}return undefined}};this.create=function(e,t){var s=new jQuery.Deferred;if(r.browser.chrome){a.show(0)}if(w){w._resetBackNavigationCallback()}sap.ui.getCore().getEventBus().publish("launchpad","appOpening",{});d.getAppInfo(e,t).then(function(r){var a;if(Object.keys(C).length>0){a=Object.keys(C).find(function(e){var t=y[C[e].sId];var s=r.ui5ComponentName||r.name;return t&&t===s});if(a){d.destroy(a)}}d.getURLParameters(new i(t).query(true)).then(function(t){v(e,t,r).then(function(e){A(e);sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",{});s.resolve({deletedKeepAliveId:a})})})});return s.promise()};this.destroy=function(e){function t(e){var t=e.sId||"<unkown>";try{e.destroy()}catch(e){u.error("exception when trying to close sapui5 application with id '"+t+"' when running inside the appruntim iframe '"+document.URL+"'. This error must be fixed in order for the iframe to operate properly.\n",e.stack,"sap.ushell.appRuntime.ui5.services.AppLifeCycleAgent::destroy")}}if(e&&C[e]){if(C[e]===S){S=undefined}delete m[C[e].sId];delete y[C[e].sId];t(C[e]);delete C[e]}else if(S){delete m[S.sId];delete y[S.sId];t(S);S=undefined}sap.ushell.Container.cleanDirtyStateProviderArray();if(w){w._resetBackNavigationCallback()}n.setAppShortId();sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",{})};this.store=function(e){var t=S,s;C[e]=t;if(w){I[e]=w._getBackNavigationCallback()}s=t.getComponentInstance();t.setVisible(false);if(sap.ushell.Container){b[e]=sap.ushell.Container.getAsyncDirtyStateProviders();sap.ushell.Container.cleanDirtyStateProviderArray()}if(s){if(s.isKeepAliveSupported&&s.isKeepAliveSupported()===true){s.deactivate()}else{if(s.suspend){s.suspend()}if(s.getRouter&&s.getRouter()){s.getRouter().stop()}}}sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",{})};this.restore=function(e){var t=C[e],s=t.getComponentInstance(),i=m[t.sId];sap.ui.getCore().getEventBus().publish("launchpad","appOpening",{});t.setVisible(true);if(b[e]&&sap.ushell.Container){sap.ushell.Container.setAsyncDirtyStateProviders(b[e])}if(w){w.setBackNavigation(I[e])}if(s){if(s.isKeepAliveSupported&&s.isKeepAliveSupported()===true){s.activate()}else{if(s.restore){s.restore()}if(s.getRouter&&s.getRouter()&&s.getRouter().initialize){if(i===false){s.getRouter().initialize()}else{s.getRouter().initialize(true)}}}S=t}sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",{})};this.getURLParameters=function(e){return new Promise(function(s,r){if(e.hasOwnProperty("sap-intent-param")){var a=e["sap-intent-param"];t.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:a}).then(function(t){delete e["sap-intent-param"];var r=jQuery.extend({},e,new i("?"+t).query(true),true);s(r)},function(t){s(e)})}else{s(e)}})};this.getAppInfo=function(e,t){return new Promise(function(s){function i(){f.getAppInfo(e,t).then(function(t){d.addAppInfoToCache(e,t);s(t)})}if(h===true&&g[e]){s(JSON.parse(JSON.stringify(g[e])))}else if(f){i()}else{sap.ui.require([c.replace(/\./g,"/")],function(e){f=e;i()})}})};this.addAppInfoToCache=function(e,t){if(e&&t&&h===true&&g[e]===undefined){g[e]=JSON.parse(JSON.stringify(t))}};this.setComponent=function(e,t){S=e;if(S){m[S.sId]=true;y[S.sId]=t}};this.setShellUIService=function(e){w=e};this.setShellNavigationService=function(e){O=e};this.checkDataLossAndContinue=function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getDirtyFlag(O.getNavigationContext())){if(window.confirm(R)){sap.ushell.Container.setDirtyFlag(false);return true}else{return false}}return true}}return new d},true);
//# sourceMappingURL=AppLifeCycleAgent.js.map
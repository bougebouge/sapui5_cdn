// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","./DashboardUIActions","sap/ushell/components/HomepageManager","sap/ushell/utils","sap/ushell/EventHub","sap/ui/Device","sap/ushell/resources","sap/ushell/Layout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/Log","sap/ui/core/mvc/Controller"],function(jQuery,e,t,i,r,o,s,n,a,l,u,d){"use strict";return d.extend("sap.ushell.components.homepage.DashboardContent",{onInit:function(){var e=sap.ui.getCore().getEventBus();this.handleDashboardScroll=function(){window.setTimeout(this._handleDashboardScroll.bind(this),0)}.bind(this);e.subscribe("sap.ushell","appOpened",this._appOpenedHandler,this);e.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.subscribe("launchpad","actionModeInactive",this._handleGroupVisibilityChanges,this);e.subscribe("launchpad","switchTabBarItem",this._handleTabBarItemPressEventHandler,this);window.document.addEventListener("visibilitychange",i.handleTilesVisibility,false)},onExit:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("launchpad","contentRefresh",this._webkitMobileRenderFix,this);e.unsubscribe("sap.ushell","appOpened",this._appOpenedHandler,this);e.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.unsubscribe("launchpad","switchTabBarItem",this._handleTabBarItemPressEventHandler,this);window.document.removeEventListener("visibilitychange",i.handleTilesVisibility,false);if(this.oDashboardUIActionsModule){this.oDashboardUIActionsModule.destroy();delete this.oDashboardUIActionsModule}window.removeEventListener("resize",this._resizeHandler.bind(this))},onAfterRendering:function(){i.setPerformanceMark("FLP - dashboard after rendering");var e=t.prototype.getInstance();if(!e.getPreparedGroupModel()){e.loadPersonalizedGroups()}else{r.once("firstSegmentCompleteLoaded").do(e.handleFirstSegmentLoaded.bind(e))}var s=sap.ui.getCore().getEventBus(),n,a,l,u;s.unsubscribe("launchpad","scrollToGroup",this._scrollToGroup,this);s.unsubscribe("launchpad","scrollToGroupByName",this._scrollToGroupByName,this);s.subscribe("launchpad","scrollToGroup",this._scrollToGroup,this);s.subscribe("launchpad","scrollToGroupByName",this._scrollToGroupByName,this);o.orientation.attachHandler(function(){var e=jQuery("#dashboardGroups").find(".sapUshellTileContainer").filter(":visible");if(e.length){n=this.getView().getModel();a=n.getProperty("/topGroupInViewPortIndex");if(e.get(a)){l=sap.ui.getCore().byId(e.get(a).id);u=n.getProperty("/editTitle");this._publishAsync("launchpad","scrollToGroup",{group:l,isInEditTitle:u})}}},this);window.addEventListener("resize",this._resizeHandler.bind(this));this._updateTopGroupInModel()},_resizeHandler:function(){clearTimeout(this._resizeTimer);this._resizeTimer=setTimeout(this.resizeHandler.bind(this),300)},_dashboardDeleteTileHandler:function(e){var t=e.getSource().getBindingContext().getObject();sap.ui.getCore().getEventBus().publish("launchpad","deleteTile",{tileId:t.uuid,items:"tiles"},this)},dashboardTilePress:function(e){var t=e.getSource();if(!t){return}sap.ui.getCore().getEventBus().publish("launchpad","dashboardTileClick",{uuid:t.getUuid()});if(o.system.desktop){var i=sap.ushell.Container.getRenderer();var r=i.getRouter().getRoute("home");if(this._fnSetFocusOnLastVisitedTile){r.detachBeforeMatched(this._fnSetFocusOnLastVisitedTile)}this._fnSetFocusOnLastVisitedTile=this._setFocusOnLastVisitedTile.bind(this,t,r);r.attachBeforeMatched(this._fnSetFocusOnLastVisitedTile)}},_setFocusOnLastVisitedTile:function(e,t){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(i){i.getInstance().then(function(i){i.moveScrollDashboard(e.$());t.detachBeforeMatched(this._fnSetFocusOnLastVisitedTile);delete this._fnSetFocusOnLastVisitedTile}.bind(this))}.bind(this))},_updateTopGroupInModel:function(){var e=this.getView().getModel(),t=this._getIndexOfTopGroupInViewPort();var i=this._getModelGroupFromVisibleIndex(t);e.setProperty("/iSelectedGroup",i);e.setProperty("/topGroupInViewPortIndex",t)},_getIndexOfTopGroupInViewPort:function(){var e=this.getView().getDomRef(),t=e.getElementsByTagName("section")[0],i=jQuery(t).find(".sapUshellTileContainer").not(".sapUshellHidden");if(!i){return 0}for(var r=0;r<i.length;r++){var o=i[r].parentElement;if(t.scrollTop<=o.offsetTop+o.offsetHeight){return r}}return i.length?i.length-1:0},_handleDashboardScroll:function(){var e=this.getView(),t=e.getModel(),r=100;var s=t.getProperty("/homePageGroupDisplay"),n=s!=="tabs",a=t.getProperty("/tileActionModeActive");function l(){i.handleTilesVisibility()}clearTimeout(this.timeoutId);this.timeoutId=setTimeout(l,r);if(!o.system.phone){e.oAnchorNavigationBar.closeOverflowPopup()}if(n||a){this._updateTopGroupInModel()}e.oAnchorNavigationBar.reArrangeNavigationBarElements()},_handleGroupDeletion:function(e){sap.ui.require(["sap/m/MessageBox"],function(t){var i=sap.ui.getCore().getEventBus(),r=e.getObject(),o=r.removable,n=r.title,a=r.groupId,l=s.i18n,u=t.Action,d=o?u.DELETE:l.getText("ResetGroupBtn");sap.ushell.Container.getServiceAsync("Message").then(function(e){e.confirm(l.getText(o?"delete_group_msg":"reset_group_msg",n),function(e){if(e===d){i.publish("launchpad",o?"deleteGroup":"resetGroup",{groupId:a})}},l.getText(o?"delete_group":"reset_group"),[d,u.CANCEL])})})},_modelLoaded:function(){this.bModelInitialized=true;n.getInitPromise().then(function(){this._initializeUIActions()}.bind(this))},_initializeUIActions:function(){if(!this.oDashboardUIActionsModule){this.oDashboardUIActionsModule=new e}this.oDashboardUIActionsModule.initializeUIActions(this)},resizeHandler:function(){i.recalculateBottomSpace();i.handleTilesVisibility();if(r.last("AppRendered")!==undefined){r.emit("AppRendered",undefined)}if(n&&jQuery("#dashboardGroups").is(":visible")&&this.bModelInitialized){n.reRenderGroupsLayout(null);this._initializeUIActions()}},_appOpenedHandler:function(e,t,r){var o,s,n=this.getView().getModel(),a=r.additionalInformation||"";o=this.getOwnerComponent();s=o.getMetadata().getComponentName();if(a.indexOf(s)===-1){i.setTilesNoVisibility()}if(n.getProperty("/tileActionModeActive")&&sap.ushell.components.homepage.ActionMode){sap.ushell.components.homepage.ActionMode.toggleActionMode(n,"Menu Item");if(n.getProperty("/homePageGroupDisplay")==="tabs"){this._deactivateActionModeInTabsState();this.getView().oAnchorNavigationBar.reArrangeNavigationBarElements()}}if(this.oDashboardUIActionsModule){this.oDashboardUIActionsModule.disableAllDashboardUiAction()}},_scrollToGroupByName:function(e,t,i){var r=this.getView().getModel().getProperty("/groups"),o=i.groupName;sap.ushell.Container.getServiceAsync("LaunchPage").then(function(i){r.forEach(function(r){if(i.getGroupTitle(r.object)===o){this._scrollToGroup(e,t,{groupId:r.groupId})}}.bind(this))}.bind(this))},_scrollToGroup:function(e,t,r){var s=r.group?r.group.getGroupId():r.groupId;var n;if(this.oView.oDashboardGroupsBox.getGroups()){n=this.oView.oDashboardGroupsBox.getGroups().reduce(function(e,t){return t&&t.getGroupId()===s?t:e},null)}var a=n&&n.getDomRef();if(!a){return Promise.reject()}var l=a.querySelector(".sapUshellTileContainerContent");if(!l){return Promise.reject()}var u=document.getElementById("dashboardGroups");var d=l.getBoundingClientRect();var p=u.getBoundingClientRect();if(d.top===p.top){u.parentElement.scrollTop=0}else{l.scrollIntoView()}var g=new Promise(function(e){if(o.system.desktop&&(r.restoreLastFocusedTile||r.groupChanged)){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(t){t.getInstance().then(function(e){var t=n.$();if(r.restoreLastFocusedTile){var i=false;if(r.restoreLastFocusedTileContainerById){t=jQuery("#"+r.restoreLastFocusedTileContainerById);i=true}e.goToLastVisitedTile(t,i)}else if(r.groupChanged){var o=t.find(".sapUshellTile, .sapMGTLineMode, .sapFCard").filter(":visible").eq(0);if(o.length){e.moveScrollDashboard(o)}}}).then(e)})}else{e()}});g.then(function(){if(r.isInEditTitle){n.setEditMode(true)}i.handleTilesVisibility()});return g},_handleDrop:function(e,t){var i=n.getLayoutEngine(),r=i.layoutEndCallback(),o=!r.dstArea,s=sap.ui.getCore().getEventBus(),a,l,u,d=jQuery.Deferred(),p=this.getView(),g=p.getModel(),h=g.getProperty("/homePageGroupDisplay")&&g.getProperty("/homePageGroupDisplay")==="tabs",c=g.getProperty("/tileActionModeActive"),f=true,b;if(!r.tile){s.publish("launchpad","sortableStop");return null}n.getLayoutEngine()._toggleAnchorItemHighlighting(false);if(r.dstGroup){var v=r.dstGroup.getBindingContext(),m=v.getProperty(v.sPath).isGroupLocked;f=o&&m}b=r.tile.getBindingContext().getObject().isLinkPersonalizationSupported;if(!r.tileMovedFlag||f||!b&&r.dstArea==="links"){s.publish("launchpad","sortableStop");return null}if(!c&&!h&&r.dstArea==="links"&&!r.dstGroupData.getLinks().length){s.publish("launchpad","sortableStop");return null}a=true;l=true;if(r.srcGroup!==r.dstGroup){a=l=false}else if(r.tile!==r.dstGroup.getTiles()[r.dstTileIndex]){l=false}u=this._getTileUuid(r.tile);if(r.srcGroup&&r.srcGroup.removeAggregation&&r.srcArea){r.srcGroup.removeAggregation("tiles",r.tile,a)}var G=r.dstGroupData&&r.dstGroupData.insertAggregation&&r.dstArea===r.srcArea;if(G){r.tile.sParentAggregationName=r.dstArea;r.dstGroupData.insertAggregation(r.dstArea,r.tile,r.dstTileIndex,l);d=this._handleSameTypeDrop(r,u,G)}else if(o){d=this._handleShortDrop(r,u,G)}else{d=this._handleConvertDrop(r,G,t)}if(this.getView().getModel()){this.getView().getModel().setProperty("/draggedTileLinkPersonalizationSupported",true)}s.publish("launchpad","sortableStop");return d.promise()},_handleSameTypeDrop:function(e,t,i){var r=sap.ui.getCore().getEventBus(),o=jQuery.Deferred();e.tile._getBindingContext().oModel.setProperty(e.tile._getBindingContext().sPath+"/draggedInTabBarToSourceGroup",false);r.publish("launchpad","movetile",{sTileId:t,sToItems:e.dstArea?e.dstArea:"tiles",sFromItems:e.srcArea?e.srcArea:"tiles",sTileType:e.dstArea?e.dstArea.substr(0,e.dstArea.length-1):undefined,toGroupId:e.dstGroupData.getGroupId?e.dstGroupData.getGroupId():e.dstGroupData.groupId,toIndex:e.dstTileIndex,longDrop:i,callBack:function(){o.resolve()}});return o.promise()},_handleShortDrop:function(e,t,i){var r=sap.ui.getCore().getEventBus(),o=jQuery.Deferred();r.publish("launchpad","movetile",{sTileId:t,sToItems:e.srcArea||"tiles",sFromItems:e.srcArea||"tiles",sTileType:e.srcArea?e.srcArea.substr(0,e.srcArea.length-1):undefined,toGroupId:e.dstGroupData.getGroupId?e.dstGroupData.getGroupId():e.dstGroupData.groupId,toIndex:e.dstTileIndex,longDrop:i,callBack:function(){o.resolve()}});return o.promise()},_handleConvertDrop:function(e,t,i){var r=sap.ui.getCore().getEventBus(),o=jQuery.Deferred();r.publish("launchpad","convertTile",{toGroupId:e.dstGroupData.getGroupId?e.dstGroupData.getGroupId():e.dstGroupData.groupId,toIndex:e.dstTileIndex,tile:sap.ui.getCore().byId(i.id),srcGroupId:e.srcGroup.getGroupId?e.srcGroup.getGroupId():e.srcGroup.groupId,longDrop:t,callBack:function(){o.resolve()}});return o.promise()},_getTileUuid:function(e){if(e.getUuid){return e.getUuid()}var t=e.getBindingContext().getObject();if(t.getParent){return t.getParent().getUuid()}return t.uuid},_handleDrag:function(e,t){var i=n.getLayoutEngine().layoutEndCallback(),r=i.tile.getBindingContext().getObject(),o=this.getView().getModel();if(o){o.setProperty("/draggedTileLinkPersonalizationSupported",r.isLinkPersonalizationSupported)}},_handleTabBarItemPressEventHandler:function(e,t,i){var r=this.getView(),o=r.getModel(),s=o.getProperty("/groups"),n=i.iGroupIndex;for(var a=0;a<s.length;a++){o.setProperty("/groups/"+a+"/isGroupSelected",false)}o.setProperty("/groups/"+n+"/isGroupSelected",true);this._handleTabBarItemPress(e,t,n)},_handleTabBarItemPress:function(e,t,r,o){var s=this.getView(),n,a;if(o){n=o.getParameter("group").getIndex()}else{n=r}sap.ui.getCore().getEventBus().publish("launchpad","tabSelected",{iSelectedGroup:n});a=this._getVisibleGroupIndex(n);s.oDashboardGroupsBox.removeLinksFromUnselectedGroups();s.oDashboardGroupsBox.getBinding("groups").filter([s.oFilterSelectedGroup]);s.oAnchorNavigationBar.setSelectedItemIndex(a);s.oAnchorNavigationBar.reArrangeNavigationBarElements();setTimeout(function(){i.handleTilesVisibility()},0)},_getVisibleGroupIndex:function(e){var t=this.getView().getModel().getProperty("/groups");var i=0;for(var r=0;r<e;r++){if(!t[r].isGroupVisible||!t[r].visibilityModes[0]){i++}}return e-i},_getModelGroupFromVisibleIndex:function(e){var t=this.getView().getModel().getProperty("/groups"),i=0;for(var r=0;r<t.length;r++){if(t[r].isGroupVisible&&t[r].visibilityModes[0]){i++;if(i>e){return r}}}return 0},_handleAnchorItemPress:function(e){var t=this.getView(),i=t.getModel(),r=i.getProperty("/groups");if(o.system.phone&&e.getParameter("manualPress")){e.oSource.openOverflowPopup()}for(var s=0;s<r.length;s++){if(i.getProperty("/groups/"+s+"/isGroupSelected")===true){i.setProperty("/groups/"+s+"/isGroupSelected",false)}}i.setProperty("/groups/"+e.getParameter("group").getIndex()+"/isGroupSelected",true);i.setProperty("/iSelectedGroup",e.getParameter("group").getIndex());if(i.getProperty("/homePageGroupDisplay")&&i.getProperty("/homePageGroupDisplay")==="tabs"&&!i.getProperty("/tileActionModeActive")){this._handleTabBarItemPress(undefined,undefined,undefined,e)}else{if(!i.getProperty("/tileActionModeActive")){t.oDashboardGroupsBox.getBinding("groups").filter([new a("isGroupVisible",l.EQ,true)])}else{t.oDashboardGroupsBox.getBinding("groups").filter([])}this._scrollToGroup("launchpad","scrollToGroup",{group:e.getParameter("group"),groupChanged:true,focus:e.getParameter("action")==="sapenter"})}},_addGroupHandler:function(e){var t,i=e.getSource().getBindingContext().getPath(),r=i.split("/");t=window.parseInt(r[r.length-1],10);if(e.getSource().sParentAggregationName==="afterContent"){t=t+1}sap.ui.getCore().getEventBus().publish("launchpad","createGroupAt",{title:"",location:t,isRendered:true})},_publishAsync:function(e,t,i){var r=sap.ui.getCore().getEventBus();window.setTimeout(jQuery.proxy(r.publish,r,e,t,i),1)},_changeGroupVisibility:function(e){var t=e.getPath(),i=e.getModel(),r=i.getProperty(t+"/isGroupVisible");if(i.getProperty(t+"/isDefaultGroup")||i.getProperty(t+"/isGroupLocked")){return}i.setProperty(t+"/isGroupVisible",!r)},_handleGroupVisibilityChanges:function(e,r,o){var n=this.getView().getModel(),a=t.prototype.getInstance(),l=a.getCurrentHiddenGroupIds(n),u=l.length===o.length,d=u,p;l.some(function(e,t){if(!d){return true}d=o&&Array.prototype.indexOf.call(o,e)!==-1;return!d});if(!d){sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){p=e.hideGroups(l);p.done(function(){n.updateBindings("groups")});p.fail(function(){sap.ushell.Container.getServiceAsync("Message").then(function(e){e.error(s.i18n.getText("hideGroups_error"))})})})}window.setTimeout(function(){i.recalculateBottomSpace()},0)},_updateShellHeader:function(){if(!this.oShellUIService){this._initializeShellUIService()}else{this.oShellUIService.setTitle();this.oShellUIService.setHierarchy()}},_initializeShellUIService:function(){return sap.ui.require(["sap/ushell/ui5service/ShellUIService"],function(e){this.oShellUIService=new e({scopeObject:this.getOwnerComponent(),scopeType:"component"});this.oShellUIService.setTitle();this.oShellUIService.setHierarchy();return this.oShellUIService}.bind(this))},_deactivateActionModeInTabsState:function(){var e=this.getView(),t=e.getModel(),i;var r=t.getProperty("/groups");for(i=0;i<r.length;i++){t.setProperty("/groups/"+i+"/isGroupSelected",false)}var o=e.oAnchorNavigationBar.getSelectedItemIndex();var s=0;if(!this._isGroupVisible(o)){for(i=0;i<r.length;i++){if(!this._isGroupVisible(i)){s++}else{o=i;break}}}else{for(i=0;i<o;i++){if(!this._isGroupVisible(i)){s++}}}var n=o-s;e.oAnchorNavigationBar.setSelectedItemIndex(n);e.oAnchorNavigationBar.adjustItemSelection();t.setProperty("/groups/"+o+"/isGroupSelected",true);e.oDashboardGroupsBox.removeLinksFromAllGroups();var a=t.getProperty("/homePageGroupDisplay");if(a&&a==="tabs"){e.oDashboardGroupsBox.getBinding("groups").filter([e.oFilterSelectedGroup]);var l=e.oDashboardGroupsBox.getGroups&&e.oDashboardGroupsBox.getGroups();var u=Array.isArray(l)&&l[0];if(u&&u.updateLinks){u.updateLinks()}}},_isGroupVisible:function(e){var t=this.getView().getModel().getProperty("/groups");return t[e].isGroupVisible&&t[e].visibilityModes[0]}})});
//# sourceMappingURL=DashboardContent.controller.js.map
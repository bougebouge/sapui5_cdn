// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/performance/Measurement","sap/base/util/UriParameters","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/model/json/JSONModel","sap/ui/core/message/Message","sap/ui/core/MessageType"],function(e,t,a,r,n,s,i,o,g,u){"use strict";return e.extend("sap.ushell.components.shell.Settings.userLanguageRegion.LanguageRegionSelector",{onInit:function(){this.oUserInfoServicePromise=sap.ushell.Container.getServiceAsync("UserInfo");return this.oUserInfoServicePromise.then(function(e){this.oUser=sap.ushell.Container.getUser();var t=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var a=i.getInstance(t);var r,n,s,g;var u=sap.ushell.Container.getRenderer("fiori2").getShellConfig().enableSetLanguage||false;var l=this.oUser.isLanguagePersonalized();var c=e.getUserSettingListEditSupported();var m=[];if(c){var d=sap.ui.getCore().getConfiguration().getFormatSettings();r=d.getLegacyDateFormat();s=d.getLegacyTimeFormat();g=this._getLegacyNumberFormat(d);m.push(this._loadUserSettingList())}else{r=a.getDatePattern("medium");n=a.getTimePattern("medium");s=n.indexOf("H")===-1?"12h":"24h"}var L=new o({languageList:null,DateFormatList:null,TimeFormatList:null,NumberFormatList:null,TimeZoneList:null,selectedLanguage:this.oUser.getLanguage(),selectedLanguageText:this.oUser.getLanguageText(),selectedDatePattern:r,selectedTimeFormat:s,selectedNumberFormat:g,selectedTimeZone:this.oUser.getTimeZone(),isSettingsLoaded:true,isLanguagePersonalized:l,isEnableSetLanguage:u,isEnableUserProfileSetting:c,isTimeZoneIanaAvailable:true});L.setSizeLimit(1e3);var f=sap.ushell.Container.getUser().getTimeZoneIana();if(f===undefined||f!==""&&typeof f==="string"){L.setProperty("/isTimeZoneIanaAvailable",false)}if(u){m.push(this._loadLanguagesList())}if(m.length>0){this.getView().setBusy(true);return Promise.all(m).then(function(e){var t=c?e[0]:null;var a=null;if(u){a=e.length===1?e[0]:e[1]}if(a&&a.length>1){L.setProperty("/languageList",a);var r=a.some(function(e){return e.key==="default"});if(!l&&r){L.setProperty("/selectedLanguage","default")}}if(t&&t.TIME_FORMAT&&t.TIME_FORMAT.length>0){L.setProperty("/TimeFormatList",t.TIME_FORMAT)}if(t&&t.DATE_FORMAT&&t.DATE_FORMAT.length>0){L.setProperty("/DateFormatList",t.DATE_FORMAT)}if(t&&t.TIME_ZONE&&t.TIME_ZONE.length>0){L.setProperty("/TimeZoneList",t.TIME_ZONE)}if(t&&t.NUMBER_FORMAT&&t.NUMBER_FORMAT.length>0){L.setProperty("/NumberFormatList",t.NUMBER_FORMAT)}this.oView.setModel(L);this.getView().setBusy(false)}.bind(this))}this.oView.setModel(L)}.bind(this))},_loadLanguagesList:function(){t.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");return this.oUserInfoServicePromise.then(function(e){return new Promise(function(a){t.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");e.getLanguageList().done(function(e){t.end("FLP:LanguageRegionSelector._getLanguagesList");a(e)}).fail(function(e){t.end("FLP:LanguageRegionSelector._getLanguagesList");n.error("Failed to load language list.",e,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");a(null)})})})},_loadUserSettingList:function(){t.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");return this.oUserInfoServicePromise.then(function(e){return new Promise(function(a){t.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");e.getUserSettingList().then(function(e){t.end("FLP:LanguageRegionSelector._loadUserSettingList");a(e)})})})},onCancel:function(){var e=this.getView().getModel(),t=e.getData(),a=t.languageList,r=t.isEnableSetLanguage;if(r&&a){var n=this.oUser.getLanguage();var s=t.isLanguagePersonalized?n:"default";e.setProperty("/selectedLanguage",s);this._updateTextFields(n)}if(t.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}},onSaveSuccess:function(e,t,r){var s={refresh:true};e.resetChangedProperty("dateFormat");e.resetChangedProperty("timeFormat");e.resetChangedProperty("numberFormat");e.resetChangedProperty("timeZone");if(t){n.debug("[000] onSaveSuccess: oUser.resetChangedPropertyLanguage:","LanguageRegionSelector.controller");e.resetChangedProperty("language");var i=a.fromQuery(window.location.search).get("sap-language");if(i&&r!=="default"){s.urlParams=[{"sap-language":r}]}this._removeLanguageFromUserContextCookie()}return s},onSave:function(e){var t=this.oUser,a=this.getView().getModel().getData(),r=a.selectedLanguage,s=t.getLanguage(),i=r!==(a.isLanguagePersonalized?s:"default"),o=a.isEnableUserProfileSetting,g=a.isEnableSetLanguage&&a.languageList&&i,u=false,l=["DATE_FORMAT","TIME_FORMAT","NUMBER_FORMAT","TIME_ZONE","LANGUAGE"];n.debug("[000] LanguageRegionSelector:onSave:bUpdateLanguage, bIsEnableSetUserProfileSetting:",g,"LanguageRegionSelector.controller");if(g){n.debug("[000] LanguageRegionSelector:onSave:UserInfo: oUser.setLanguage:",r,"LanguageRegionSelector.controller");t.setLanguage(r)}if(o){var c=sap.ui.getCore().getConfiguration().getFormatSettings();if(c.getLegacyDateFormat()!==a.selectedDatePattern){u=true;t.setChangedProperties({propertyName:"dateFormat",name:"DATE_FORMAT"},c.getLegacyDateFormat(),a.selectedDatePattern)}if(c.getLegacyTimeFormat()!==a.selectedTimeFormat){u=true;t.setChangedProperties({propertyName:"timeFormat",name:"TIME_FORMAT"},c.getLegacyTimeFormat(),a.selectedTimeFormat)}if(this._getLegacyNumberFormat(c)!==a.selectedNumberFormat){u=true;t.setChangedProperties({propertyName:"numberFormat",name:"NUMBER_FORMAT"},this._getLegacyNumberFormat(c),a.selectedNumberFormat)}if(this.oUser.getTimeZone()!==a.selectedTimeZone){u=true;t.setChangedProperties({propertyName:"timeZone",name:"TIME_ZONE"},this.oUser.getTimeZone(),a.selectedTimeZone)}}if(g||u){return e().then(function(){n.debug("[000] onSave:fnUpdateUserPreferences","LanguageRegionSelector.controller");return this.onSaveSuccess(t,g,r)}.bind(this)).catch(function(e){n.debug("[000] onSave:catch:errorMessage",e,"LanguageRegionSelector.controller");var i=l.some(function(t){return e.includes(t)});if(!i){return this.onSaveSuccess(t,g,r)}if(g){t.setLanguage(s);t.resetChangedProperty("language");this._updateTextFields(s)}t.resetChangedProperty("dateFormat");t.resetChangedProperty("timeFormat");t.resetChangedProperty("numberFormat");t.resetChangedProperty("timeZone");if(a.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}n.error("Failed to save Language and Region Settings",e,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");throw e}.bind(this))}return Promise.resolve()},_restoreUserSettingPreferenceValues:function(){var e=this.getView().getModel();var t=sap.ui.getCore().getConfiguration().getFormatSettings();e.setProperty("/selectedDatePattern",t.getLegacyDateFormat());e.setProperty("/selectedTimeFormat",t.getLegacyTimeFormat());e.setProperty("/selectedNumberFormat",this._getLegacyNumberFormat(t));e.setProperty("/selectedTimeZone",this.oUser.getTimeZone())},_removeLanguageFromUserContextCookie:function(){var e=document.cookie.split(";").find(function(e){return e.indexOf("sap-usercontext")!==-1});if(!e){return}var t=e.replace("sap-usercontext=","").split("&");t=t.filter(function(e){return e.indexOf("sap-language")===-1});document.cookie="sap-usercontext="+t.join("&")+";path=/"},_handleSelectChange:function(e){var t=e.getParameters().selectedItem.getKey();this._updateTextFields(t)},_updateTextFields:function(e){var t;if(e===this.oUser.getLanguage()){t=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale()}else{t=new s(e)}var a=this.getView().getModel(),r=i.getInstance(t),n=r.getDatePattern("medium"),o=r.getTimePattern("medium"),g=o.indexOf("H")===-1?"12h":"24h";if(!a.getData().isEnableUserProfileSetting){a.setProperty("/selectedDatePattern",n);a.setProperty("/selectedTimeFormat",g)}},_getLegacyNumberFormat:function(e){var t=e.getLegacyNumberFormat();if(t){return t.trim()}}})});
//# sourceMappingURL=LanguageRegionSelector.controller.js.map
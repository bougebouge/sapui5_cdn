// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/UriParameters","sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/Device","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/utils","sap/ushell/utils/WindowUtils","sap/ushell/components/shell/Settings/ErrorMessageHelper","sap/ui/core/message/Message","sap/ushell/components/shell/Settings/UserSettingsErrorMessagePopover","sap/ui/core/MessageType"],function(e,t,s,n,r,i,o,a,l,u,d,g,c,f){"use strict";return s.extend("sap.ushell.components.shell.Settings.UserSettings",{onInit:function(){this.getView().byId("userSettingEntryList").addEventDelegate({onAfterRendering:this._listAfterRendering.bind(this)});i.orientation.attachHandler(function(){var e=this.getView().byId("settingsApp");this._updateHeaderButtonVisibility(e.isMasterShown())}.bind(this))},_afterClose:function(){if(window.document.activeElement&&window.document.activeElement.tagName==="BODY"){window.document.getElementById("meAreaHeaderButton").focus()}},_listAfterRendering:function(){var e=this.getView().byId("userSettingEntryList");var t=e.getItems();for(var s=0;s<t.length;s++){var n=t[s].getBindingContextPath();this._setEntryValueResult(n)}if(!i.system.phone){var r=e.getItems()[0];if(r){e.setSelectedItem(r);this._toDetail(r);r.getDomRef().focus()}}},_setEntryValueResult:function(t){var s=this.getView().getModel(),n=s.getProperty(t+"/valueArgument"),r=s.getProperty(t+"/valueResult");if(typeof n==="function"){s.setProperty(t+"/valueResult",a.i18n.getText("genericLoading"));try{n().then(function(e){if(e&&e.value!==undefined){s.setProperty(t+"/visible",!!e.value)}var n;if(typeof e==="object"){n=e.displayText||""}else{n=e||""}s.setProperty(t+"/valueResult",n)},function(){s.setProperty(t+"/valueResult",a.i18n.getText("loadingErrorMessage"))})}catch(n){e.error("Can not load value for "+s.getProperty(t+"/title")+" entry",n);s.setProperty(t+"/valueResult",a.i18n.getText("loadingErrorMessage"))}}else if(r===null||r===undefined){s.setProperty(t+"/valueResult",n||"")}},_navBackButtonPressHandler:function(){var e=this.getView().byId("settingsApp");e.backDetail();this._updateHeaderButtonVisibility(true)},_navToggleButtonPressHandler:function(){var e=this.getView().byId("settingsApp"),t=e.isMasterShown();if(t){e.hideMaster()}else{e.showMaster()}this._updateHeaderButtonVisibility(!t)},_updateHeaderButtonVisibility:function(e){if(i.system.phone){var t=this.getView().byId("userSettingsNavBackButton");t.setVisible(!e)}else{var s=this.getView().byId("userSettingsMenuButton");if(i.orientation.portrait){s.setVisible(true);s.setPressed(e);s.setTooltip(a.i18n.getText(e?"ToggleButtonHide":"ToggleButtonShow"))}else{s.setVisible(false)}}},_itemPress:function(e){this._toDetail(e.getSource().getSelectedItem())},_toDetail:function(e){var t=this.getView().getModel(),s=e.getBindingContextPath(),n=t.getProperty(s+"/contentResult");if(i.system.phone){e.setSelected(false)}if(n){this._navToDetail(n,s);return Promise.resolve()}var r=t.getProperty(s);return this._createEntryContent(r).then(function(e){t.setProperty(s+"/contentResult",e);this._navToDetail(e,s)}.bind(this))},_createEntryContent:function(t){var s=this;var n=this._addContentWrapper(t);if(typeof t.contentFunc==="function"){t.contentFunc().then(function(e){if(e instanceof sap.ui.core.Control){n=n.then(function(t){t.addContent(e);t.setBusy(false);return t})}else{n=n.then(s._addErrorContentToWrapper.bind(null,a.i18n.getText("loadingErrorMessage")))}},function(r){e.error("Can not load content for "+t.title+" entry",r);n=n.then(s._addErrorContentToWrapper.bind(null,a.i18n.getText("loadingErrorMessage")))})}else{n=n.then(this._addErrorContentToWrapper.bind(null,a.i18n.getText("userSettings.noContent")))}return n.then(function(e){return e.getId()})},_addContentWrapper:function(e){var t=this;return n.load({name:"sap.ushell.components.shell.Settings.ContentWrapper"}).then(function(s){var n=new r({title:e.title,showHeader:!e.provideEmptyWrapper});s.setModel(n,"entryInfo");t.getView().byId("settingsApp").addDetailPage(s);return s})},_addErrorContentToWrapper:function(e,t){return n.load({name:"sap.ushell.components.shell.Settings.ErrorContent"}).then(function(s){t.setBusy(false);t.getModel("entryInfo").setProperty("/errorMessage",e);t.addContent(s);return t})},_navToDetail:function(e,t){var s=this.getView().byId("settingsApp");s.toDetail(e);if(s.getMode()==="ShowHideMode"){s.hideMaster();this._updateHeaderButtonVisibility(false)}this._emitEntryOpened(t)},_emitEntryOpened:function(e){var t=o.last("UserSettingsOpened")||{},s=this.getView().getModel().getProperty(e),n=s.id;if(!n){n=l._getUid();this.getView().getModel().setProperty(e+"/id",n)}t[n]=true;o.emit("UserSettingsOpened",t)},_createMessagePopover:function(){if(!this.oMessagePopover){return c.create().then(function(e){e.setModel(this.getView().getModel("i18n"),"i18n");this.oMessagePopover=e}.bind(this))}return Promise.resolve()},_handleMessagePopoverPress:function(e){this.oMessagePopover.toggle(e.getSource())},updateUserPreferences:function(){e.debug("[000] updateUserPreferences: ","UserSettings.controller");if(this._updateUserPreferencesPromise){return this._updateUserPreferencesPromise}var t,s;this._updateUserPreferencesPromise=new Promise(function(e,n){t=e;s=n});this._updateUserPreferencesPromise.sendRequest=function(){sap.ushell.Container.getServiceAsync("UserInfo").then(function(n){e.debug("[000] updateUserPreferences: sendRequest","UserSettings.controller");n.updateUserPreferences().done(t).fail(s).always(function(){e.debug("[000] updateUserPreferences: sendRequest: _updateUserPreferencesPromise","UserSettings.controller");this._updateUserPreferencesPromise=null}.bind(this))}.bind(this))}.bind(this);return this._updateUserPreferencesPromise},_handleSaveButtonPress:function(){d.removeErrorMessages();var t=this,s=this.getView().byId("userSettingsDialog"),n=this.getView().getModel().getProperty("/entries"),i=o.last("UserSettingsOpened")||{},a;if(Object.keys(i).length===0){this._handleSettingsDialogClose();this._showSuccessMessageToast();return Promise.resolve()}s.setBusy(true);a=n.reduce(function(t,s){if(i[s.id]){e.debug("[000] _handleSaveButtonPress: oEntry.id: ",s.id,"UserSettings.controller");t.push(this._executeEntrySave(s))}return t}.bind(this),[]);e.debug("[000] _handleSaveButtonPress:_updateUserPreferencesPromise",this._updateUserPreferencesPromise,"UserSettings.controller");if(this._updateUserPreferencesPromise){this._updateUserPreferencesPromise.sendRequest()}return Promise.all(a).then(function(n){e.debug("[000] _handleSaveButtonPress: then save aResults",JSON.stringify(n),"UserSettings.controller");var i=d.filterMessagesToDisplay();s.setBusy(false);if(i.length>0){sap.ushell.Container.getUser().resetChangedProperties();var a=t.getView().byId("userSettingsMessagePopoverBtn");a.setText(i.length);a.setVisible(true);var l=new Promise(function(e){var t={onAfterRendering:function(){a.removeEventDelegate(t);e()}};a.invalidate();a.addEventDelegate(t)});var g="";i.forEach(function(e){g+="Entry: "+e.getAdditionalText()+" - Error message: "+e.getDescription()+"\n"});e.error("Failed to save the following entries",g);return Promise.all([l,t._createMessagePopover()]).then(function(){t.oMessagePopover.setModel(new r(i),"errorMessages");t.oMessagePopover.openBy(a)})}t._handleSettingsDialogClose();t._showSuccessMessageToast();o.emit("UserSettingsOpened",null);var c=false,f=false;var h=[];n.forEach(function(e){if(e&&e.refresh){c=true}if(e&&e.noHash){f=true}if(e&&e.urlParams&&e.urlParams.length>0){h=h.concat(e.urlParams)}});if(c&&!f){e.debug("[000]refresh browser 1"+JSON.stringify(h));u.refreshBrowser(h)}else if(c&&f){e.debug("[000]refresh browser"+JSON.stringify(h));window.location=window.location.href.replace(window.location.hash,"")}return Promise.resolve()})},_executeEntrySave:function(t){var s,n;function r(e){return e||{}}function i(s){e.debug("[000] _onError: errorInformation",JSON.stringify(s),"UserSettings.controller");var n;var r=t.id;var i=t.title;if(!s){n=a.i18n.getText("userSettings.SavingError.Undefined")}else if(typeof s==="string"){n=s}else if(Array.isArray(s)){s.forEach(function(e){e.setAdditionalText(i);e.setTechnicalDetails({pluginId:r});d.addMessage(e)});return}else if(s instanceof sap.ui.core.message.Message){s.setAdditionalText(i);s.setTechnicalDetails({pluginId:r});d.addMessage(s);return}else{n=a.i18n.getText("userSettings.SavingError.WithMessage",s.message)}d.addMessage(new g({type:f.Error,additionalText:i,technicalDetails:{pluginId:r},description:n,message:n}))}try{e.debug("[000] onSave: oEntry.id: "+t.id,"UserSettings.controller");this._isExececuteEntrySavedInUserSettingsController=true;s=t.onSave(this.updateUserPreferences.bind(this))}catch(e){return i(e)}if(s&&s.promise){e.warning("jQuery.promise is used to save "+t.title+" settings entry.\n"+"The using of jQuery.promise for onSave is deprecated. Please use the native promise instead.");n=new Promise(function(e){s.done(function(t){e(r(t))}).fail(function(t){e(i(t))})})}else{n=s.then(r,i)}return n},_showSuccessMessageToast:function(){sap.ui.require(["sap/m/MessageToast"],function(e){var t=a.i18n.getText("savedChanges");e.show(t,{offset:"0 -50"})})},_handleCancel:function(){var t=this.getView().getModel().getProperty("/entries");var s=o.last("UserSettingsOpened")||{};if(s){t.forEach(function(t){if(s[t.id]&&t.onCancel){try{t.onCancel()}catch(t){e.error("Failed to cancel the following entries",t)}}})}o.emit("UserSettingsOpened",null);this._handleSettingsDialogClose()},_handleSettingsDialogClose:function(){sap.ushell.Container.getUser().resetChangedProperties();if(i.system.phone){this.getView().byId("settingsApp").toMaster("settingsView--userSettingMaster")}this.getView().byId("userSettingsMessagePopoverBtn").setVisible(false);this.getView().byId("userSettingsDialog").close()}})});
//# sourceMappingURL=UserSettings.controller.js.map
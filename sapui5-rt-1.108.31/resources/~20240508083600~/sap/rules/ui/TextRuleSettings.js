/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/rules/ui/library","sap/ui/core/Control","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Switch","sap/m/Select","sap/m/MessageBox","sap/m/Table","sap/m/Column","sap/m/Text","sap/m/Input","sap/m/Button","sap/m/ComboBox","sap/rules/ui/ExpressionAdvanced","sap/ui/layout/VerticalLayout","sap/rules/ui/type/Expression","sap/rules/ui/oldast/lib/AstYamlConverter","sap/rules/ui/Constants","sap/rules/ui/AstExpressionBasic","sap/rules/ui/services/AstExpressionLanguage","./TextRuleSettingsRenderer"],function(jQuery,e,t,s,r,i,a,n,o,l,u,d,p,g,c,f,h,y,T,b,x,R){"use strict";var v=t.extend("sap.rules.ui.TextRuleSettings",{metadata:{library:"sap.rules.ui",properties:{modelName:{type:"string",defaultValue:""},newTextRule:{type:"boolean",defaultValue:false},enableSettingResult:{type:"boolean",defaultValue:true}},aggregations:{mainLayout:{type:"sap.ui.layout.form.SimpleForm",multiple:false}},defaultAggregation:"mainLayout",associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,singularName:"expressionLanguage"},astExpressionLanguage:{type:"sap.rules.ui.services.AstExpressionLanguage",multiple:false,singularName:"astExpressionLanguage"}}},renderer:R});sap.rules.ui.TextRuleSettings.prototype._addNodeObject=function(e){var t=[];var s=sap.ui.getCore().byId(this.getAstExpressionLanguage());var r=s._astBunldeInstance.ASTUtil;var i=[];i.Root=e.Root;i.SequenceNumber=e.Sequence;i.ParentId=e.ParentId;i.Reference=e.Reference;i.Id=e.NodeId;i.Type=e.Type;i.Value=e.Value?e.Value:"";if(e.Type==="I"){i.Value=e.IncompleteExpression}if(e.Function){i.Function=e.Function}if(e.Type!=="P"&&!e.Function){var a=[];a.BusinessDataType=e.Output?e.Output.BusinessDataType:e.BusinessDataType;a.DataObjectType=e.Output?e.Output.DataObjectType:e.DataObjectType;i.Output=a}r.createNode(i)};sap.rules.ui.TextRuleSettings.prototype._bindPredefinedTable=function(e,t){var s=this;this.oPredefinedTable.destroyItems();var r=this.getModel("oDataModel");var i;if(this.getExpressionLanguage()){i=sap.ui.getCore().byId(this.getExpressionLanguage())}else{i=sap.ui.getCore().byId(this.getAstExpressionLanguage())}var a=new sap.ui.model.odata.v2.ODataModel(i.getModel().sServiceUrl);var o;var l;var u;var d=function(e){if(e&&e.length>0){s.oPredefinedTable.setBusy(true);for(var i=0;i<e.length;i++){if(t==="/TextRuleResults"){l={RuleId:e[i].RuleId,Id:e[i].Id,RuleVersion:e[i].RuleVersion};o=r.createKey(t,l);u=new sap.ui.model.Context(r,o)}else{l={DataObjectId:e[i].DataObjectId,Id:e[i].Id,VocabularyId:e[i].VocabularyId,RootDataObjectId:e[i].RootDataObjectId,AttributeId:e[i].AttributeId};o=a.createKey(t,l);u=new sap.ui.model.Context(a,o)}s.oPredefinedTable.addItem(s._predefinedFactory("col-"+i,u))}s.oPredefinedTable.setBusy(false);s._internalModel.setProperty("/needToRefresh",false)}};if(t==="/TextRuleResults"){var p=this.getModel("TextRuleModel").getProperty("/textRuleResults");d(p)}else{if(this.getModel().getProperty("/ResultDataObjectId")){a.read(e,{urlParameters:{$expand:"ExpandedAttributes"},success:function(e){d(e.ExpandedAttributes.results)},error:function(e){n.error(e.responseText,{title:s.oBundle.getText("ERROR_DIALOG"),actions:[sap.m.MessageBox.Action.OK]})}})}}};sap.rules.ui.TextRuleSettings.prototype._callRefreshResultsFunctionImport=function(){var e=this;var t=this.getModel("oDataModel");var s=this.getModel("TextRuleModel").getData();var r={groupId:"changes"};t.setDeferredGroups([r.groupId]);var i=function(t){if(t&&t.__batchResponses&&t.__batchResponses[0].message==="HTTP request failed"){n.error(t.__batchResponses[0].response.body,{title:e.oBundle.getText("refreshFailed"),actions:[sap.m.MessageBox.Action.OK]})}else{e._createPredefinedTable();e._internalModel.setProperty("/needToRefresh",false)}};var a=function(){var e=s.ruleId;t.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:r.groupId,urlParameters:{RuleId:e}});t.submitChanges({groupId:r.groupId,success:i})};if(this._internalModel.getProperty("/needToRefresh")){a()}};sap.rules.ui.TextRuleSettings.prototype._createInfoMessageStrip=function(e,t){var s=new sap.m.MessageStrip({visible:true,id:t,text:e,type:sap.ui.core.MessageType.Information,showIcon:true,showCloseButton:true}).addStyleClass("sapTextRuleSettingsMessageStrip");return s};sap.rules.ui.TextRuleSettings.prototype._createLayout=function(){if(!this.oForm){this._destroyElements();this.oForm=new s("_formLayout",{editable:true,layout:"ResponsiveGridLayout",maxContainerCols:1,columnsL:1,columnsM:1,labelSpanM:1,content:[new r({text:this.oBundle.getText("output")}).setTooltip(this.oBundle.getText("output")),new sap.ui.layout.HorizontalLayout({content:[new a("__resultSelect",{width:"220px",items:{path:"settingModel>/results/resultsEnumeration",template:new sap.ui.core.Item({key:"{settingModel>id}",text:"{settingModel>label}"})},enabled:this.getProperty("enableSettingResult"),selectedKey:"{/ResultDataObjectId}",tooltip:this.oBundle.getText("chooseResultTooltip"),change:function(e){var t=this.getParent();var s=t.getButtons()[0];s.setEnabled(true);var r=e.getSource();var i=this.getModel().getData();if(i.ResultDataObjectStatus!=="C"){i.ResultDataObjectId=r.getSelectedKey();i.ResultDataObjectName=r._getSelectedItemText();i.ResultDataObjectStatus="U";if(i.ResultDataObjectId!==r.getSelectedKey()){this._updateRefreshFlags(false,false,false)}}this._internalModel.setProperty("/resultDataObjectChanged",true);if(this.getExpressionLanguage()&&this._internalModel.getProperty("/results/resultsEnumeration/0").id==="0"){this._internalModel.getProperty("/results/resultsEnumeration").splice(0,1)}this._createPredefinedTable()}.bind(this)}),this._createRefreshButton()]}),new r,this._createVerticalLayout()]}).addStyleClass("sapTextRuleSettingsForm")}this.oForm.setBusyIndicatorDelay(0);return this.oForm};sap.rules.ui.TextRuleSettings.prototype._createPredefinedTable=function(){if(!this.oPredefinedTable){this.oPredefinedTable=new o("idPredefinedTable",{backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.All,swipeDirection:sap.m.SwipeDirection.Both,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new l({width:"45%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedResultColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new l({width:"25%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedAccessColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new l({width:"45%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedValuesColumnHeaderText"),design:sap.m.LabelDesign.Bold})})]})}var e=this._internalModel.getProperty("/resultDataObjectChanged");var t=this._internalModel.getProperty("/refreshButtonClicked");var s=this.getModel("oDataModel");this._handleVisibilityForPredefinedResults();if(!e&&!t){this.oPredefinedTable.setModel(s);var r=[this.getModel("TextRuleModel").getProperty("/ruleBindingPath"),"/TextRule/TextRuleResults"].join("");this._bindPredefinedTable(r,"/TextRuleResults");this.oPredefinedTable.setBusyIndicatorDelay(0);return this.oPredefinedTable}else{this._updatePredefinedTable(this.getModel().getData())}return null};sap.rules.ui.TextRuleSettings.prototype._handleVisibilityForPredefinedResults=function(){if(this.getModel()&&!this.getModel().getProperty("/ResultDataObjectId")){this.oPredefinedTable.setVisible(false);if(sap.ui.getCore().byId("id_HiddenAccessMessageStrip")){sap.ui.getCore().byId("id_HiddenAccessMessageStrip").setVisible(false)}if(sap.ui.getCore().byId("id_EditableAccessMessageStrip")){sap.ui.getCore().byId("id_EditableAccessMessageStrip").setVisible(false)}}else{this.oPredefinedTable.setVisible(true);if(sap.ui.getCore().byId("id_HiddenAccessMessageStrip")){sap.ui.getCore().byId("id_HiddenAccessMessageStrip").setVisible(true)}if(sap.ui.getCore().byId("id_EditableAccessMessageStrip")){sap.ui.getCore().byId("id_EditableAccessMessageStrip").setVisible(true)}}};sap.rules.ui.TextRuleSettings.prototype._createRefreshButton=function(){var e=function(){this._internalModel.setProperty("/refreshButtonEnabled",true,null,true);return this.oBundle.getText("textRuleRefreshWarning")}.bind(this);var t=function(){this._updateRefreshFlags(true,false,true)}.bind(this);var s=e();var r=function(){var e=s;n.warning(e,{title:this.oBundle.getText("refeshResultWarningTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e===sap.m.MessageBox.Action.OK){t()}}})}.bind(this);var i=new p({layoutData:new sap.ui.layout.ResponsiveFlowLayoutData({weight:1}),icon:sap.ui.core.IconPool.getIconURI("synchronize"),width:"3rem",type:sap.m.ButtonType.Transparent,text:"",press:r,visible:true,enabled:"{settingModel>/refreshButtonEnabled}"}).setTooltip(this.oBundle.getText("refreshBtnTooltip"));this.refreshButton=i;return i};sap.rules.ui.TextRuleSettings.prototype._createVerticalLayout=function(){var e=new sap.ui.layout.VerticalLayout("verticalLayout",{content:[this._createInfoMessageStrip(this.oBundle.getText("TRPredefinedMessageStripHiddenAccessInfoText"),"id_HiddenAccessMessageStrip"),this._createInfoMessageStrip(this.oBundle.getText("TRPredefinedMessageStripEditableAccessInfoText"),"id_EditableAccessMessageStrip"),this._createPredefinedTable()]});return e};sap.rules.ui.TextRuleSettings.prototype._destroyElements=function(){if(sap.ui.getCore().byId("_formLayout")){sap.ui.getCore().byId("_formLayout").destroy()}if(sap.ui.getCore().byId("__elseCheckBox")){sap.ui.getCore().byId("__elseCheckBox").destroy()}if(sap.ui.getCore().byId("__resultSelect")){sap.ui.getCore().byId("__resultSelect").destroy()}if(sap.ui.getCore().byId("id_HiddenAccessMessageStrip")){sap.ui.getCore().byId("id_HiddenAccessMessageStrip").destroy()}if(sap.ui.getCore().byId("id_EditableAccessMessageStrip")){sap.ui.getCore().byId("id_EditableAccessMessageStrip").destroy()}if(sap.ui.getCore().byId("idPredefinedTable")){sap.ui.getCore().byId("idPredefinedTable").destroy()}};sap.rules.ui.TextRuleSettings.prototype._formRuleData=function(e,t){var s=e.getProperty("RuleId");var r=e.getProperty("Version");var i=jQuery.extend({},this.getModel().oData);if(!i){i={}}if(!i.DecisionTable){i.DecisionTable={}}i.Type="DT";i.DecisionTable.metadata={};i.DecisionTable.RuleID=s;i.DecisionTable.version=r;i.DecisionTable.HitPolicy="FM";i.DecisionTable.DecisionTableColumns={};i.DecisionTable.DecisionTableColumns.results=[];i.DecisionTable.DecisionTableColumns.results.push({metadata:{},RuleId:s,Id:1,Version:r,Sequence:1,Type:"CONDITION",Condition:{metadata:{},RuleId:s,Id:1,Version:r,Expression:t,Description:null,ValueOnly:false,FixedOperator:null},Result:null});i.DecisionTable.DecisionTableRows={};i.DecisionTable.DecisionTableRows.results=[];i.DecisionTable.DecisionTableColumnsCondition={};i.DecisionTable.DecisionTableColumnsCondition.results=[];i.DecisionTable.DecisionTableColumnsResult={};i.DecisionTable.DecisionTableColumnsResult.results=[];return i};sap.rules.ui.TextRuleSettings.prototype._getAccessOptions=function(){var e={accessEnumration:[{key:T.KEY_EDITABLE,value:T.EDITABLE},{key:T.KEY_HIDDEN,value:T.HIDDEN}]};return e};sap.rules.ui.TextRuleSettings.prototype._getASTExpressionBasic=function(e,t,s,r,i,a){var n=this;var o=sap.ui.getCore().byId(this.getAstExpressionLanguage());var l=r?r:sap.rules.ui.ExpressionType.NonComparison;var u=this._getExpressionFromAstNodes(e,a);var d=e.getObject(e.getPath());var p=d.DataObjectAttributeId?d.DataObjectAttributeId:d.Id;var g=this.getModel().getProperty("/ResultDataObjectId");var c="/"+g+"/"+this._formatAttributeId(p);if(u&&u.relString){u.relString=u.relString.replace(/\\/g,"\\\\").replace(/{/g,"\\{").replace(/}/g,"\\}")}var f=new b({id:t,value:u.relString?u.relString:"",placeholder:this.oBundle.getText("expressionPlaceHolder"),astExpressionLanguage:o,attributeInfo:c,valueState:u.valueState,change:function(t){this.expressionControl=t.getSource();var s=e.getModel();var r=t.getParameter("astNodes");if(r&&r.length===1&&r[0].Type==="I"&&r[0].Value!==""){this.expressionControl.setValueState("Error")}else{this.expressionControl.setValueState("None")}n._internalModel.setProperty("/resultAttributeChanged",true);n._updateResultAttributeJSON(e,null,null,null,r,false,false);this.expressionControl._validateControl()}.bind(this)}).setBindingContext(e);return f};sap.rules.ui.TextRuleSettings.prototype._getCurrentResult=function(){var e=this.getModel().getData();var t=this.getModel("TextRuleModel").getData();var s={Id:t.ruleId,Version:t.ruleVersion};var r=this.getModel("oDataModel");var i=r.createKey("/Rules",s);e.ResultDataObjectId=r.getProperty(i+"/ResultDataObjectId");e.ResultDataObjectName=r.getProperty(i+"/ResultDataObjectName");e.ResultDataObjectStatus="A";if(this.getExpressionLanguage()&&this._internalModel.getProperty("/results/resultsEnumeration/0").id==="0"){this._internalModel.getProperty("/results/resultsEnumeration").splice(0,1)}};sap.rules.ui.TextRuleSettings.prototype._getExpressionFieldForPredefined=function(e,t,s,r,i,a){var n;if(this.getAstExpressionLanguage()){n=this._getASTExpressionBasic(e,t,s,r,i,a)}else{n=this._getPredefinedExpressionAdvanced(e,t,s,r,i)}return n};sap.rules.ui.TextRuleSettings.prototype._getExpressionFromAstNodes=function(e,t){var s=this;var r=sap.ui.getCore().byId(this.getAstExpressionLanguage());var i=r._astBunldeInstance.TermsProvider.TermsProvider;var a="";var n=e.getPath();var o=e.getObject(n);var l=r._astBunldeInstance.ASTUtil;l.clearNodes();var u=t?t:o.TextRuleResultASTs.__list;if(u&&u.length>0){for(var d in u){var p=e.getObject("/"+u[d])?e.getObject("/"+u[d]):u[d];this._addNodeObject(p)}var t=l.getNodes();a=l.toAstExpressionString(t);if(t&&t.length===1&&t[0].Type==="I"){a.valueState="Error"}else{a.valueState="None"}}return a};sap.rules.ui.TextRuleSettings.prototype._getPredefinedExpressionAdvanced=function(e,t,s,r,i){var a=sap.ui.getCore().byId(this.getExpressionLanguage());var n=r?r:sap.rules.ui.ExpressionType.NonComparison;var o=this;return new c({expressionLanguage:a,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,id:t,type:n,value:s,editable:true,attributeInfo:i,change:function(t){o.expressionControl=t.getSource();var s=o._getConvertedExpression(o.expressionControl.getValue(),true,e);var r="";if(s&&s!==""){var i=s.output.decisionTableData.DecisionTable.DecisionTableColumns.results["0"].Condition.parserResults;if(i&&i.status!=="Error"){o._astUtils.Id=0;var a=e.getPath();var n=i.converted.ASTOutput;try{r=JSON.stringify(o._astUtils.parseConditionStatement(n));var l=e.oModel.oMetadata.mEntityTypes["/TextRuleConditions"].property;var u=0;if(l){for(var d=0;d<l.length;d++){if(l[d].name==="AST"){u=l[d].maxLength}}if(r&&r.length>u){o._updateModelExpressionModelAst(a,e,r)}}}catch(e){console.log("Exception while converting ast for expression"+o.expressionControl.getValue()+" :"+e.message)}}}this._internalModel.setProperty("/resultAttributeChanged",true);this._updateResultAttributeJSON(e,null,o.expressionControl.getValue(),r,[],false,false)}.bind(this)}).setBindingContext(e)};sap.rules.ui.TextRuleSettings.prototype._getConvertedExpression=function(e,t,s){var r=sap.ui.getCore().byId(this.getExpressionLanguage());var i=this._formRuleData(s,e);var a;if(t){a=r.convertRuleToCodeValues(i)}else{a=r.convertRuleToDisplayValues(i)}return a};sap.rules.ui.TextRuleSettings.prototype._getSelectedVisibilityStatus=function(e){if(e===T.HIDDEN){return T.KEY_HIDDEN}else{return T.KEY_EDITABLE}};sap.rules.ui.TextRuleSettings.prototype._initSettingsModel=function(e){var t={};t.predefinedResults=[];t.results=e;t.accessOptions=this._getAccessOptions();this._internalModel=new sap.ui.model.json.JSONModel(t);this.setModel(this._internalModel,"settingModel")};sap.rules.ui.TextRuleSettings.prototype._getResultsData=function(e){var t;var s={resultsEnumeration:[]};if(this.getExpressionLanguage()){t=sap.ui.getCore().byId(this.getExpressionLanguage());s={resultsEnumeration:t.getResults()};s.resultsEnumeration.unshift({id:"0",name:"",label:""})}else{t=sap.ui.getCore().byId(this.getAstExpressionLanguage());s={resultsEnumeration:t.getResults()};s.resultsEnumeration.unshift({id:undefined,name:this.oBundle.getText("textRuleNoDefaultResult"),label:this.oBundle.getText("textRuleNoDefaultResult")})}this._initSettingsModel(s);if(e){this._setDefaultResult()}else{this._getCurrentResult()}if(this.needCreateLayout){var r=this.getAggregation("mainLayout");if(r){r.destroy()}r=this._createLayout();this.setAggregation("mainLayout",r);this.needCreateLayout=false}};sap.rules.ui.TextRuleSettings.prototype._predefinedFactory=function(e,t){var s=e.split("-")[1];var r="exp"+s;var i=t.getProperty("DataObjectAttributeLabel")?t.getProperty("DataObjectAttributeLabel"):t.getProperty("Label");var a=t.getProperty("DataObjectAttributeName")?t.getProperty("DataObjectAttributeName"):t.getProperty("Name");var n=i?i:a;var o=t.getProperty("DataObjectAttributeId")?t.getProperty("DataObjectAttributeId"):t.getProperty("Id");var l;var u;var d=t.getProperty("BusinessDataType");var p;var g=[];var c=this._internalModel.getProperty("/predefinedResults");var f=function(e){var s=[];for(var r in e){s.push(t.getObject("/"+e[r]))}return s};if(this._internalModel.getProperty("/resultDataObjectChanged")){this._updateResultAttributeJSON(t,T.EDITABLE,"","",[],true,false);p=T.EDITABLE;l="";u=""}else if(this._internalModel.getProperty("/refreshButtonClicked")){var h=c[o];p=h?h.AccessMode:T.EDITABLE;l=h?h.Expression:"";u=h?h.AST:"";g=h?h.ASTNodes:[];this._updateResultAttributeJSON(t,p,l,u,g,false,true)}else{l=t.getProperty("Expression");u=t.getProperty("AST");p=t.getProperty("AccessMode");g=t.getProperty("TextRuleResultASTs");g=f(g);this._updateResultAttributeJSON(t,p,l,u,g,false,false)}var y=this._getSelectedVisibilityStatus(p);var b=false;if(this.getExpressionLanguage()){if(d===T.DATE_BUSINESS_TYPE||d===T.TIMESTAMP_BUSINESS_TYPE||d===T.NUMBER||d===T.STRING||d===T.BOOLEAN_BUSINESS_TYPE||d===T.BOOLEAN_ENHANCED_BUSINESS_TYPE){b=true}}else{b=true}if(b){return new sap.m.ColumnListItem({visible:true,cells:[new sap.m.Label({visible:true,design:sap.m.LabelDesign.Standard,text:n,labelFor:r,textAlign:sap.ui.core.TextAlign.Begin,textDirection:sap.ui.core.TextDirection.Inherit}).setBindingContext(t),new sap.m.Select({width:"65%",id:"select"+s,items:{path:"settingModel>/accessOptions/accessEnumration",template:new sap.ui.core.Item({key:"{settingModel>key}",text:"{settingModel>value}"})},selectedKey:y,change:function(e){this._setColumnAccessMode(t,e)}.bind(this)}).setBindingContext(t),this._getExpressionFieldForPredefined(t,r,l,d,o,g)]})}};sap.rules.ui.TextRuleSettings.prototype._setDefaultResult=function(){var e=this.getModel().getData();var t=this._internalModel.getProperty("/results/resultsEnumeration");if(t.length>0){e.ResultDataObjectId=t[0].Id;e.ResultDataObjectName=t[0].Name;e.ResultDataObjectStatus="A"}var s=this.getParent();var r=s.getButtons()[0];r.setEnabled(false);if(this.getExpressionLanguage()){r.setEnabled(false)}else{r.setEnabled(true)}};sap.rules.ui.TextRuleSettings.prototype._setColumnAccessMode=function(e,t){var s=t.getSource();var r="exp"+t.getSource().sId.split("select")[1];this.expressionControl=sap.ui.getCore().byId(r);var i=s.getSelectedKey();if(this.expressionControl instanceof c){if(i===T.KEY_HIDDEN){this.expressionControl.setValue("");this.expressionControl.setValueStateText("");this._updateResultAttributeJSON(e,T.HIDDEN,null,null,null,false,false)}else{this.expressionControl.setValueStateText("");this._updateResultAttributeJSON(e,T.EDITABLE,null,null,null,false,false)}}else{if(i===T.KEY_HIDDEN){this.expressionControl.setValue("");this.expressionControl._input[0].textContent="";var r=this.expressionControl.sId+"-input";var a={expId:r};var n=sap.ui.getCore().getEventBus();n.publish("sap.ui.rules","_onHiddenSelected",a);this._updateResultAttributeJSON(e,T.HIDDEN,null,null,null,false,false)}else{this.expressionControl._input[0].classList.remove("sapAstExpressionInputError");this._updateResultAttributeJSON(e,T.EDITABLE,null,null,null,false,false)}}this._internalModel.setProperty("/resultAttributeChanged",true)};sap.rules.ui.TextRuleSettings.prototype._updateApplyBtnActions=function(){if(this._internalModel){var e=this._internalModel.oData.predefinedResults;var t=false;for(var s in e){if(e[s].AccessMode===T.HIDDEN){if(this.getAstExpressionLanguage()&&e[s].ASTExpressionCleared){t=true;break}if(this.getExpressionLanguage()&&(e[s].ASTExpressionCleared||!e[s].Expression)){t=true;break}}}if(t){sap.ui.getCore().byId("ApplyBtn").setEnabled(false)}else{sap.ui.getCore().byId("ApplyBtn").setEnabled(true)}}};sap.rules.ui.TextRuleSettings.prototype._updatePredefinedTable=function(e){if(this._internalModel.getProperty("/resultDataObjectChanged")){this._internalModel.setProperty("/predefinedResults",[])}var t=this.getModel("oDataModel");var s=this.getModel("TextRuleModel").getData();var r="/DataObjects(VocabularyId='"+s.projectId+"',Id='"+e.ResultDataObjectId+"')";this.oPredefinedTable.setModel(t);this._bindPredefinedTable(r,"/ExpandedAttributes");this.oPredefinedTable.setBusyIndicatorDelay(0);return this.oPredefinedTable};sap.rules.ui.TextRuleSettings.prototype._updateRefreshFlags=function(e,t,s){this._internalModel.setProperty("/needToRefresh",e);this._internalModel.setProperty("/refreshButtonEnabled",t,null,true);this._internalModel.setProperty("/refreshButtonClicked",s);this._callRefreshResultsFunctionImport()};sap.rules.ui.TextRuleSettings.prototype._updateResultAttributeJSON=function(e,t,s,r,i,a,n){var o=e.getProperty("DataObjectAttributeId")?e.getProperty("DataObjectAttributeId"):e.getProperty("Id");var l="/predefinedResults/"+o;if(this._internalModel.getProperty("/predefinedResults")){if(this._internalModel.getProperty(l)){if(a){this._internalModel.setProperty(l+"/AccessMode",T.EDITABLE);this._internalModel.setProperty(l+"/Expression","");this._internalModel.setProperty(l+"/AST","");this._internalModel.setProperty(l+"/ASTNodes",[]);this._internalModel.setProperty(l+"/updatePredefinedResults",true)}if(n){this._internalModel.setProperty(l+"/isAttributeinBackend",true);this._internalModel.setProperty(l+"/AccessMode",t);this._internalModel.setProperty(l+"/Expression",s);this._internalModel.setProperty(l+"/AST",r);this._internalModel.setProperty(l+"/ASTNodes",i);this._internalModel.setProperty(l+"/updatePredefinedResults",true)}if(!a&&!n&&t){this._internalModel.setProperty(l+"/AccessMode",t);this._internalModel.setProperty(l+"/updatePredefinedResults",true);if(t===T.HIDDEN){this._internalModel.setProperty(l+"/ASTExpressionCleared",true)}}if(!a&&!n&&(s||s==="")){this._internalModel.setProperty(l+"/Expression",s);this._internalModel.setProperty(l+"/updatePredefinedResults",true)}if(!a&&!n&&(r||r==="")){this._internalModel.setProperty(l+"/AST",r);this._internalModel.setProperty(l+"/updatePredefinedResults",true)}if(!a&&!n&&i){this._internalModel.setProperty(l+"/ASTNodes",i);this._internalModel.setProperty(l+"/updatePredefinedResults",true);var u=this._internalModel.getProperty(l+"/AccessMode");var d=this._internalModel.getProperty(l+"/ASTExpressionCleared");var p=i.length;if(u===T.HIDDEN&&d){if(this.getAstExpressionLanguage()&&p>0||this.getExpressionLanguage()&&s){this._internalModel.setProperty(l+"/ASTExpressionCleared",false)}}if(this.getExpressionLanguage()&&!a&&!n){this._internalModel.setProperty(l+"/updatePredefinedResults",true);var u=this._internalModel.getProperty(l+"/AccessMode");var d=this._internalModel.getProperty(l+"/ASTExpressionCleared");if(u===T.HIDDEN&&d&&s){this._internalModel.setProperty(l+"/ASTExpressionCleared",false)}}}}else{this._internalModel.setProperty(l,e.getObject(e.sPath));this._internalModel.setProperty(l+"/ASTNodes",i);if(a){this._internalModel.setProperty(l+"/AccessMode",T.EDITABLE);this._internalModel.setProperty(l+"/Expression","");this._internalModel.setProperty(l+"/AST","");this._internalModel.setProperty(l+"/ASTNodes",[])}if(n){this._internalModel.setProperty(l+"/AccessMode",t);this._internalModel.setProperty(l+"/Expression",s);this._internalModel.setProperty(l+"/AST",r);this._internalModel.setProperty(l+"/ASTNodes",i);this._internalModel.setProperty(l+"/isAttributeinBackend",true)}}}if(this.expressionControl&&l&&this._internalModel.getProperty(l+"/AccessMode")===T.HIDDEN){var i=this._internalModel.getProperty(l+"/ASTNodes");if(this.getAstExpressionLanguage()&&i&&i.length>0){if(i[0].Type==="I"&&i[0].Value!==""){this.expressionControl.setValueStateText(this.oBundle.getText("PredefinedResultsValueStateText"))}else{this.expressionControl.setValueStateText("")}}else if(this.getExpressionLanguage()){if(!s){}else if(s&&this.expressionControl.getValueStateText()){this.expressionControl.setValueStateText(this.oBundle.getText("PredefinedResultsValueStateText"))}else{this.expressionControl.setValueStateText("")}}}else if(this.expressionControl&&l&&this._internalModel.getProperty(l+"/AccessMode")===T.EDITABLE){this.expressionControl.setValueStateText("")}};sap.rules.ui.TextRuleSettings.prototype.getButtons=function(e){var t=[];var s=new p({text:this.oBundle.getText("cancelBtn")}).setTooltip(this.oBundle.getText("cancelBtnTooltip"));s.attachPress(function(){e.close()},this);var r=sap.ui.getCore().byId("ApplyBtn");if(!r){r=new p({text:this.oBundle.getText("applyChangesBtn"),id:"ApplyBtn"}).setTooltip(this.oBundle.getText("applyChangesBtnTooltip"))}r.attachPress(function(){if(!this._applyButtonPressed){this._applySettingsModelChangesToOData(e);this._applyButtonPressed=true}},this);t.push(r);t.push(s);return t};sap.rules.ui.TextRuleSettings.prototype.init=function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.needCreateLayout=true;this.firstLoad=true;this.setBusyIndicatorDelay(0);this._astUtils=y;this._applyButtonPressed=false};sap.rules.ui.TextRuleSettings.prototype.onBeforeRendering=function(){if(this.firstLoad){var e=this.getProperty("newTextRule");this._getResultsData(e);this.firstLoad=false}};sap.rules.ui.TextRuleSettings.prototype._formatAttributeId=function(e){var t=e;if(t&&t.indexOf(":")>-1){t=t.replace(/:/g,"/")}return t};sap.rules.ui.TextRuleSettings.prototype._applySettingsModelChangesToOData=function(e){var t=this;var s=this.getModel();var r=this.getModel("oDataModel");var i=this.getModel("TextRuleModel");var a=this._internalModel;var n=i.getProperty("/ruleId");var o=i.getProperty("/ruleVersion");var l=s.getProperty("/ResultDataObjectId");var u=a.getProperty("/resultDataObjectChanged");var d=a.getProperty("/resultAttributeChanged");var p=a.getProperty("/refreshButtonClicked");var g={groupId:"changes"};var c=false;var f=this.getProperty("newTextRule");var h=[];var y=function(){var s=[i.getProperty("/ruleBindingPath"),"/TextRule/TextRuleResults"].join("");var a={success:function(t){r.setDeferredGroups([g.groupId]);h=t.results;P();if(c){r.submitChanges({groupId:g.groupId,success:function(){e.setBusy(false);i.setProperty("/resultChanged",u);e.setState(sap.ui.core.ValueState.Success);e.close();return}})}else{e.setBusy(false);i.setProperty("/resultChanged",u);e.setState(sap.ui.core.ValueState.Success);e.close()}}};if(t.getAstExpressionLanguage()){a.urlParameters={$expand:"TextRuleResultASTs"}}r.read(s,a)};var T=function(){c=false;if(u){y()}else{e.setBusy(false);i.setProperty("/resultChanged",u);e.setState(sap.ui.core.ValueState.Success);e.close();sap.m.MessageToast.show(t.oBundle.getText("settingsApplySuccess"))}};r.setDeferredGroups([g.groupId]);var b=function(e,t){for(var s in e){var i={};if(e[s].Root){i.Sequence=1;i.Root=true}else{i.Sequence=e[s].SequenceNumber;i.ParentId=e[s].ParentId}if(e[s].Function){i.Function=e[s].Function?e[s].Function:""}if(e[s].Type==="I"){i.IncompleteExpression=e[s].Value}if(e[s].Type!=="P"&&e[s].Type!=="O"&&!e[s].Function){i.BusinessDataType=e[s].Output?e[s].Output.BusinessDataType:e[s].BusinessDataType;i.DataObjectType=e[s].Output?e[s].Output.DataObjectType:e[s].DataObjectType;i.Value=e[s].Value?e[s].Value:""}else if(e[s].Type==="O"){i.Reference=e[s].Reference}i.NodeId=e[s].Id;i.Type=e[s].Type;i.RuleId=n;i.RuleVersion=o;i.Id=t;var a={};a.properties=i;a.groupId="changes";r.createEntry("/TextRuleResultASTs",a)}};var x=function(e){var t={};t.Id=e;t.RuleId=n;t.RuleVersion=o;r.callFunction("/DeleteTextRuleResultASTDraft",{method:"POST",groupId:"changes",urlParameters:t})};var R=function(){var e=a.getProperty("/predefinedResults");for(var t in e){if(!e[t].isAttributeinBackend){var s={RuleId:e[t].RuleId,RuleVersion:e[t].RuleVersion,Id:e[t].Id};var n=r.createKey("/TextRuleResults",s);var o=new sap.ui.model.Context(r,n);r.deleteCreatedEntry(o);var l=i.getProperty("/textRuleResultExpressions");for(var u=0;u<l.length;u++){if(l[u].ResultId===e[t].Id){var d={RuleId:e[t].RuleId,RuleVersion:e[t].RuleVersion,ResultId:e[t].Id,ConditionId:l[u].ConditionId};n=r.createKey("/TextRuleResultExpressions",d);o=new sap.ui.model.Context(r,n);r.deleteCreatedEntry(o)}}}}};var v=function(){var e={};var t={RuleId:n,RuleVersion:o};var s=r.createKey("/TextRules",t);if(!r.getData(s)){e.properties=t;r.createEntry("/TextRules",e)}var i={RuleId:n,RuleVersion:o,Sequence:1};e.properties=i;r.createEntry("/TextRuleBranches",e)};var I=function(){var e=a.getProperty("/predefinedResults");if(e){var s;for(s in e){if(e[s].updatePredefinedResults){c=true;var i=e[s].AccessMode;var l=e[s].Expression?e[s].Expression:"";var d=e[s].AST?e[s].AST:"";var f=s.replace(/:/g,"%3A");var y="/PredefinedResults(RuleId='"+n+"',DataObjectAttributeId='"+f+"')";var T={AccessMode:i,AST:d,Type:"TextRule"};var R={groupId:g.groupId};if(t.getAstExpressionLanguage()&&e[s].ASTNodes){var v=e[s].Id;if(u||p){for(var I in h){if(h[I].DataObjectAttributeId===s){v=h[I].Id;break}}}var S="/TextRuleResults(RuleId='"+n+"',RuleVersion='"+o+"',Id='"+v+"')";var _={BusinessDataType:e[s].BusinessDataType};r.update(S,_,R);x(v);b(e[s].ASTNodes,v)}else{T.Expression=l}r.update(y,T,R)}}}};var S=function(){r.callFunction("/SetRuleResultDataObject",{method:"POST",groupId:g.groupId,urlParameters:{RuleId:n,ResultDataObjectId:l}})};var _=function(){r.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:g.groupId,urlParameters:{RuleId:n}})};e.setBusy(true);var P=function(){if(d){I()}var e=a.getProperty("/needToRefresh");if(e){c=true;_()}if(f){c=true;v()}};if(p){R()}if(u){c=true;S()}else if(p){y()}else{P()}var D={};D.success=T;D.groupId=g.groupId;if(c){r.submitChanges(D);if(!u){return}}else if(!p&&!u&&!d){e.setState(sap.ui.core.ValueState.Success);e.setBusy(false);e.close();sap.m.MessageToast.show(this.oBundle.getText("settingsApplySuccess"))}};return v},true);
//# sourceMappingURL=TextRuleSettings.js.map
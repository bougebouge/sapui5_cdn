/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["./ExpressionAdvancedRenderer","sap/base/Log","sap/m/Dialog","sap/ui/core/Control","sap/m/Button","sap/m/TextArea","sap/m/Text","sap/m/MessageBox","sap/ui/layout/HorizontalLayout","sap/rules/ui/Utils","sap/ui/core/Popup","jquery.sap.global","sap/rules/ui/ExpressionBase","sap/ui/comp/odata/MetadataAnalyser","sap/rules/ui/providers/ValueHelpProvider","sap/ui/core/LocaleData","sap/rules/ui/Constants","sap/rules/ui/codemirror/lib/codemirror","sap/rules/ui/codemirror/addon/hint/show-hint","sap/rules/ui/codemirror/mode/hdf/hdf","sap/rules/ui/codemirror/addon/display/placeholder","sap/rules/ui/codemirror/addon/mh/mark-selection","sap/rules/ui/codemirror/addon/hint/hdf-hint","sap/rules/ui/codemirror/addon/closeBrackets/closebrackets","sap/rules/ui/codemirror/addon/search/search"],function(e,t,r,a,o,i,s,n,l,p,u,d,h,c,f,g,v){"use strict";var m=h.extend("sap.rules.ui.ExpressionAdvanced",{metadata:{properties:{type:{type:"sap.rules.ui.ExpressionType",defaultValue:sap.rules.ui.ExpressionType.All,bindable:"bindable"},collection:{type:"boolean",defaultValue:false},placeholder:{type:"string",defaultValue:null},focusOnLoad:{type:"boolean",defaultValue:false},attributeInfo:{type:"string",defaultValue:"",bindable:"bindable"}},aggregations:{_expressionArea:{type:"sap.m.TextArea",multiple:false,visibility:"hidden"}},events:{change:{},liveChange:{},valueHelpRequest:{parameters:{fromSuggestions:{type:"boolean"}}}},publicMethosds:["validate"]},renderer:e});m.prototype.init=function(){h.prototype.init.apply(this,arguments);var e=jQuery.sap.getModulePath("sap.rules.ui.codemirror.lib")+"/codemirror.css";var t=jQuery.sap.getModulePath("sap.rules.ui.codemirror.addon.hint")+"/show-hint.css";jQuery.sap.includeStyleSheet(e);jQuery.sap.includeStyleSheet(t);this.pop=new u(d("<span></span>")[0],false,false,false);this.errorWidgets=[];this.expressionTokens=[];this._liveValue="";this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.dataModel=this.initControlDataModel();this.oTextArea=new i({width:"100%"});this.validationCompleteEvent=document.createEvent("Event");this.validationCompleteEvent.initEvent("validationCompleteEvent",true,false);this.setAggregation("_expressionArea",this.oTextArea,true);this.bFlagForEventListener=true;var r=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var a=g.getInstance(r);this.oFormatDate=sap.ui.core.format.DateFormat.getInstance({pattern:a.getDatePattern("short"),calendarType:sap.ui.core.CalendarType.Gregorian},r);this._dateBusinessDataType="Date";this._valueHelpSelectionText="Select from value help...";this._hasValueSource="HasValueSource";this._propertyValue="Value";this._propertyDescription="Description"};m.prototype._processValidationResult=function(e){if(e.status===sap.rules.ui.ValidationStatus.Error){var t=p.parseUTFToString(e.errorDetails);t=t.replace(/\r\n/g," ").replace(/\r/g," ").replace(/\n/g," ");this.errorCursorPosition=e.cursorPosition;this.setValueStateText(t)}else{this.oTextArea.setValueState("None");this.oTextArea.setValueStateText("");this.setValueStateText("");jQuery(this.codeMirror.getWrapperElement()).removeClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError")}};m.prototype.validateExpression=function(e){for(var t=0;t<this.errorWidgets.length;t++){this.codeMirror.removeLineWidget(this.errorWidgets[t])}this.errorWidgets=[];var r=this.codeMirror?this.codeMirror.getValue():this.getValue();var a={};var o={};var i=sap.ui.getCore().byId(this.getExpressionLanguage());if(i){o=i.validateExpression(e||r,this.getProperty("type"),this.getCollection(),false);if(o&&this.isActive()){a=o;this._processValidationResult(a);if(a.deferredResult){a.deferredResult.done(function(e){this._processValidationResult(e);document.dispatchEvent(this.validationCompleteEvent)}.bind(this))}}}return o};m.prototype._showPopUp=function(){var e="Error";var t=this.getProperty("valueStateText");var r=this.getId()+"-message";var a=this.pop;if(!this.pop){return}a.attachClosed(function(){d.sap.byId(r).remove()});var o=u.Dock;var i="sapMInputBaseMessage"+e+" sapMFocus";var s="sapMValueStateMessageError sapMText";var n=sap.ui.getCore().getLibraryResourceBundle("sap.m");if(e===sap.ui.core.ValueState.Success){i="sapUiInvisibleText";t=""}var l=d("<div>",{id:r,class:i,role:"tooltip","aria-live":"assertive"}).append(d("<span>",{"aria-hidden":true,class:"sapUiHidden",text:n.getText("INPUTBASE_VALUE_STATE_"+e.toUpperCase())})).append(d("<span>",{id:r+"-text",class:s,text:t}));a.setContent(l[0]);a.close(0);a.open(0,o.BeginTop,o.BeginBottom,jQuery(this.codeMirror.getWrapperElement()),null,"none flip",true);var p=this.pop.oContent.clientWidth;var h=document.getElementById(this.getAggregation("_expressionArea"));if(!h){return}var c=h.sId.clientWidth;if(p>c){jQuery(".sapMText").css("width",c);jQuery(".sapMText").css("padding-left","12px");jQuery(".sapMText").css("padding-right","12px");jQuery(".sapMText").css("padding-top","8px");jQuery(".sapMText").css("padding-bottom","8px")}};m.prototype._closePopUp=function(){if(this.pop){this.pop.close(0)}};m.prototype._showErrorMessage=function(){var e=this.getValueStateText();if(e&&e!==""){this._setExpressionErrorStyle()}};m.prototype.initControlDataModel=function(){var e=new sap.ui.model.json.JSONModel;var t={};e.setData(t);return e};m.prototype.setExpressionTokens=function(e){var t=0,r=false;this.expressionTokens=[];if(e instanceof Array){for(var a=0;a<e.length;a++){var o=e[a];var i=/\n/;if(i.test(o.token)){t=o.start+o.token.lastIndexOf("\n")+1;r=true;continue}if(r){o.start=o.start-t;o.end=o.end-t+1}else{o.end=o.end+1}this.expressionTokens.push(o)}}};m.prototype.getExpressionTokens=function(){return this.expressionTokens};m.prototype.getValue=function(){if(this.codeMirror!==undefined){return this.codeMirror.getValue()}return this.getProperty("value")};m.prototype.setValue=function(e){if(e===undefined||e===null){e=""}this._liveValue=e;this.oTextArea.setValue(e);if(this.getProperty("value")===e){return}this.setProperty("value",e,true);if(this.codeMirror!==undefined){this.codeMirror.setValue(e)}};m.prototype.setPlaceholder=function(e){this.setProperty("placeholder",e);var t=this.getEditable()?e:"";this.dataModel.setProperty("/placeholder",t)};m.prototype.getPlaceholder=function(){return this.dataModel.getProperty("/placeholder")};m.prototype.setValueStateText=function(e){this.setProperty("valueStateText",e,true);if(e){this._showErrorMessage(e)}else{jQuery(this.codeMirror.getWrapperElement()).removeClass("CodeMirror-error");jQuery(this.codeMirror.getWrapperElement()).removeClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError")}};m.prototype.setEditable=function(e){this.setProperty("editable",e);this.getAggregation("_expressionArea").setProperty("editable",e);if(this.codeMirror){jQuery(this.codeMirror.getWrapperElement()).addClass("CodeMirror-rules-Not-Editable")}var t=e?this.getProperty("placeholder"):"";this.dataModel.setProperty("/placeholder",t);this.invalidate()};m.prototype.setType=function(e){if(e===v.DATE_BUSINESS_TYPE||e===v.TIMESTAMP_BUSINESS_TYPE||e===v.NUMBER||e===v.STRING||e===v.BOOLEAN_BUSINESS_TYPE||e===v.BOOLEAN_ENHANCED_BUSINESS_TYPE){this.setProperty("type",e)}if(this.codeMirror){this.codeMirror.options.returnType=e}};m.prototype.setCollection=function(e){this.setProperty("collection",e,true);if(this.codeMirror){this.codeMirror.options.collection=e}};m.prototype.validate=function(){return this.validateExpression()};m.prototype.setFocusOnLoad=function(e){this.dataModel.setProperty("/focus",e);this.setProperty("focusOnLoad",e,true)};m.prototype.focus=function(){if(this.codeMirror){var e=this.codeMirror.getLine(this.codeMirror.lastLine());var t=e.length;this.codeMirror.setCursor({line:this.codeMirror.lastLine(),ch:t});this.codeMirror.focus()}};m.prototype.onAliasLinkPress=function(e){var t=sap.ui.getCore().byId(this.getExpressionLanguage());if(t){t.onAliasLinkPress(e);t.attachEvent("aliasDialogClosed",this.aliasClickCancel,this)}};m.prototype.onCreateAliasLinkForText=function(e){var t=sap.ui.getCore().byId(this.getExpressionLanguage());if(t){t.attachEvent("aliasDialogClosed",this.replaceTextWithAlias,this);t.onCreateAliasLinkForText(e)}};m.prototype.replaceTextWithAlias=function(e){if(e.getParameter("isSave")){this.codeMirror.replaceSelection(e.getParameter("savedAliasName"))}};m.prototype.aliasClickCancel=function(e){this.codeMirror.focus();this.codeMirror.execCommand("goLineEnd");this.fireDialog({dialogStatus:sap.rules.ui.ValueListDialogMode.Close})};m.prototype.onAfterRendering=function(){this.timer=null;this.needAutoComplete=false;this.endCompletion=false;this._setCodeMirror();this._setEditorStyle();this._handleMousedown();this._handleChange();this._handleFocusLeave();this._handleEndCodeCompletion();this._handleKeyPress();this._handleEditableProperty();this._handleOnLoadValidation();this._refreshOnNavigationEnd();this._handleFocus();this._handleValueListSelect();this._handleCalendarChange();if(this.bFlagForEventListener){this.bFlagForEventListener=false;this.fnMouseDownListsner=function(e){this.bFlagForChangeBeforeBlur=e.target.className.indexOf("CodeMirror-hint")>-1}.bind(this);this.fnBlurListsner=function(e){if(this.bFlagForChangeBeforeBlur){this.bFlagForChangeBeforeBlur=false;e.stopPropagation();this.codeMirror.focus()}}.bind(this);document.addEventListener("mousedown",this.fnMouseDownListsner,true);document.getElementById(this.getId()).addEventListener("blur",this.fnBlurListsner,true)}};m.prototype._handleCalendarChange=function(){var e=this;this.codeMirror.on("onChangeDate",function(){e._createCalendarDialog(e.codeMirror.getCursor())}.bind(this))};m.prototype._createCalendarDialog=function(e){var t=false;var a=this;var i=new sap.ui.unified.Calendar({width:"100%",select:this.handleCalendarSelect.bind(this)});this._oSelectNewDateDialog=new r({title:this.oBundle.getText("calendarTitle"),content:[i],beginButton:new o({text:this.oBundle.getText("okBtn"),enabled:false,press:function(){var r=this.updateText(i);a._updateModal(false);a.setTextOnCursor(r,e,false,this._dateBusinessDataType,t,false);a._oSelectNewDateDialog.close();a.focus(a.codeMirror)}.bind(this)}),endButton:new o({text:this.oBundle.getText("clsBtn"),press:function(){a._updateModal(false);a._oSelectNewDateDialog.close();a.focus(a.codeMirror)}.bind(this)})});this._oSelectNewDateDialog.open()};m.prototype._updateModal=function(e){var t=sap.ui.getCore().byId("popover");if(t){t.setModal(e)}};m.prototype.handleCalendarSelect=function(e){var t=e.getSource(),r=t.getSelectedDates()[0].getStartDate();if(r){this._oSelectNewDateDialog.getBeginButton().setEnabled(true)}};m.prototype.updateText=function(e){var t=e.getSelectedDates();var r;if(t.length>0){r=t[0].getStartDate();return this.oFormatDate.format(r)}};m.prototype._raiseError=function(e){t.error(e);var r=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.setValueStateText(r.getText("valueHelpTechnicalError"));this._showPopUp()};m.prototype._handleValueListSelect=function(){this.codeMirror.on("onValueListSelect",function(){var e=this.codeMirror.currentHintData.data.listCompletion;var t=[];for(var r=0;r<e.length;r++){if(e[r].text===this._valueHelpSelectionText){t=e[r].info}}var a=sap.ui.getCore().byId(this.getExpressionLanguage());t.expressionLanguage=a;var o=a.getValueHelpCallback();this.oTextArea.setValueState("None");this.oTextArea.setValueStateText("");this.setValueStateText("");jQuery(this.codeMirror.getWrapperElement()).removeClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError");if(typeof o!=="function"&&t.metadata.hasOwnProperty(this._hasValueSource)&&t.metadata.HasValueSource===true){this._createCpValueHelp(t,this.codeMirror.getCursor(),false)}else{if(typeof o!=="function"){this._raiseError("value help callback is not set or is not a function")}else{o.call(this,t);var i=t[0].model;if(!(i instanceof sap.ui.model.odata.v2.ODataModel)){this._raiseError("value help model is not an oData V2 model")}else if(i.isMetadataLoadingFailed()){this._raiseError("model metadata loading has failed in the past")}else if(!i.getMetaModel().oModel){i.attachMetadataLoaded(function(){this._createValueHelpProvider(t[0])}.bind(this));i.attachMetadataFailed(function(){this._raiseError("attached model metadata failed")}.bind(this))}else{this._createValueHelpProvider(t[0])}}}}.bind(this))};m.prototype._createValueHelpProvider=function(e,t){var r=e.model;this.oMetadataAnalyzer=new sap.ui.comp.odata.MetadataAnalyser(r);var a=e.metadata.propertyPath;var o=this.oMetadataAnalyzer.getValueListAnnotation(a);if(!o.primaryValueListAnnotation){this._raiseError("proprety path is wrong");return}var i=this.getExpressionTokens();var s=false;if(i.length>0){s=i[i.length-1].tokenType!=="whitespace"}if(this.oValueHelpDialogProvider){this.oValueHelpDialogProvider.destroy()}this.oValueHelpDialogProvider=new f({annotation:o.primaryValueListAnnotation,additionalAnnotations:o.additionalAnnotations,control:this,model:r,preventInitialDataFetchInValueHelpDialog:false,supportMultiSelect:false,supportRanges:false,takeOverInputValue:false,fieldName:o.primaryValueListAnnotation.valueListTitle,title:o.primaryValueListAnnotation.valueListTitle,cursorPosition:this.codeMirror.getCursor(),bReplaceWord:t,businessDataType:e.metadata.businessDataType,bAddSpace:s});this.fireValueHelpRequest({fromSuggestions:false})};m.prototype._createCpValueHelp=function(e,t,r,a){var o=e.metadata.businessDataType;var i=this.getExpressionTokens();var s=false;var n=sap.ui.getCore().byId("popover");if(n){n.setModal(true)}if(i.length>0){s=i[i.length-1].tokenType!=="whitespace"}if(this.oDialog){this.oDialog.destroy()}var l=sap.ui.getCore().byId(this.getExpressionLanguage()).getModel().sServiceUrl;this._createDialog(l,e,t,o,s,r,a)};m.prototype._createDialog=function(e,t,r,a,o,i,s){this._createValueHelpDialog(e,t,r,a,o,i,s);this._createSmartFilterBar(e,t);this.oValueHelpDialog.setFilterBar(this.oFilterBar);this.oValueHelpDialog.open();this.oValueHelpDialog.getTable().setBusy(true)};m.prototype._createValueHelpDialog=function(e,t,r,a,o,i,s){var n=this;var l=t.expressionLanguage.getModel();var p="Attributes(Id='"+t.metadata.attributeId+"',VocabularyId='"+t.metadata.vocabularyId+"',DataObjectId='"+t.metadata.dataObjectId+"')";if(p.includes(":")){p=p=p.replace(":","%3A")}this.attributeName=l.oData[p].Name;sap.ui.core.BusyIndicator.show(0);this.oValueHelpDialog=new sap.ui.comp.valuehelpdialog.ValueHelpDialog({supportMultiselect:false,supportRanges:false,horizontalScrolling:false,title:n.attributeName,resizable:false,beforeOpen:function(){n._bindTable(e,t)},ok:function(e){var t=e.getParameter("tokens")[0].data("row");var l=t.Value;if(a===n._dateBusinessDataType){l=n._formatDate(l)}n.setTextOnCursor(l,r,i,a,o,s);n._updateModal(false);n.oValueHelpDialog.close();n.focus(n.codeMirror)},cancel:function(){n._updateModal(false);n.oValueHelpDialog.close();n.focus(n.codeMirror)},afterClose:function(){n._updateModal(false);n.oValueHelpDialog.destroy();n.focus(n.codeMirror);n.oFilterBar.destroy();sap.ui.core.BusyIndicator.hide()}})};m.prototype._formatDate=function(e){return this.oFormatDate.format(this.oFormatDate.parse(e))};m.prototype._createSmartFilterBar=function(e,t){var r=this;this.oFilterBar=new sap.ui.comp.smartfilterbar.SmartFilterBar({entitySet:t.metadata.entitySet,enableBasicSearch:true,advancedMode:true,filterBarExpanded:true,search:function(){r.onSearch(e,t)},filterChange:function(e){r.setValueStateFilter(e)},controlConfiguration:[r._createControlConfiguration()]});var a=new sap.ui.model.odata.v2.ODataModel(e);this.oFilterBar.setModel(a)};m.prototype._createControlConfiguration=function(){var e=[new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Value",label:"Value",visibleInAdvancedArea:true,width:"100px",index:1}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Description",label:"Description",visibleInAdvancedArea:true,width:"100px",index:2}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"VocabularyId",label:"VocabularyId",width:"100px",visible:false,index:3}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"DataObjectId",label:"DataObjectId",visible:false,width:"100px",groupId:"abc",index:4}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"AttributeId",label:"AttributeId",visible:false,width:"100px",index:5}),new sap.ui.comp.smartfilterbar.ControlConfiguration({hasValueHelpDialog:true,key:"Version",label:"Version",visible:false,width:"100px",index:6})];return e};m.prototype.onSearch=function(e,t){this.oValueHelpDialog.getTable().setBusy(true);this._unBindTable();this._bindTable(e,t)};m.prototype._bindTable=function(e,t){var r=t.metadata.serviceURL;var a=this._fetchFilterParams(t);var o={valueHelp:{collection:r,properties:[this._propertyValue,this._propertyDescription]}};var i=this.oValueHelpDialog.getTable();i.setThreshold(10);for(var s=0;s<o.valueHelp.properties.length;s++){this._addValueHelpColumn(o.valueHelp.properties[s],i)}var n=new sap.ui.model.odata.v2.ODataModel(e);i.setModel(n);i.bindRows(o.valueHelp.collection,null,a);i.getBinding("rows").attachDataReceived(this._handleRowsDataReceived,this)};m.prototype._handleRowsDataReceived=function(e){var t=this;var r=e.getParameter("data");if(jQuery.isEmptyObject(r)||r&&r.results&&r.results.length===0){this.oValueHelpDialog.getTable().setNoData(t.oBundle.getText("no_data"))}else{this.oValueHelpDialog.getTable().setNoData(t.oBundle.getText("searching"))}this.oValueHelpDialog.getTable().setBusy(false)};m.prototype._addValueHelpColumn=function(e,t){var r=(new sap.ui.table.Column).setLabel(new sap.m.Label({text:e}));if(e===this._propertyValue){r.setSortProperty(e)}t.addColumn(r.setTemplate((new sap.m.Text).bindProperty("text",e)))};m.prototype._unBindTable=function(){var e=this.oValueHelpDialog.getTable();e.destroyColumns();e.unbindRows()};m.prototype._fetchFilterParams=function(e){var t=this;var r=[];var a=[new sap.ui.model.Filter("AttributeId",sap.ui.model.FilterOperator.EQ,e.metadata.attributeId),new sap.ui.model.Filter("DataObjectId",sap.ui.model.FilterOperator.EQ,e.metadata.dataObjectId),new sap.ui.model.Filter("VocabularyId",sap.ui.model.FilterOperator.EQ,e.metadata.vocabularyId)];var o=this.oFilterBar.getFilters();var i=this.oFilterBar.getParameters();if(!jQuery.isEmptyObject(i)&&o&&o.length>0){i=this.oFilterBar.getParameters().custom.search;r=this._getSearchFilters(i);o=t._formatFilterParams(o);a.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(o),new sap.ui.model.Filter(r)],and:true}))}else if(!jQuery.isEmptyObject(i)){i=this.oFilterBar.getParameters().custom.search;r=this._getSearchFilters(i);a.push(r)}else if(o&&o.length>0){o=t._formatFilterParams(o);a.push(o[0])}return a};m.prototype._formatFilterParams=function(e){var t=this;if(e[0]&&e.length===1&&e[0].aFilters[0]&&e[0].aFilters[0].sOperator){e=t._formatSingleFilter(e)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[0].aFilters[0]&&e[0].aFilters[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters[0].aFilters){e=t._formatMultiFilter(e,0,true);e=t._formatMultiFilter(e,1,true)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[0].aFilters[0]&&e[0].aFilters[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters){e=t._formatMultiFilter(e,0,true);e=t._formatMultiFilter(e,1,false)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[1].aFilters[0]&&e[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters[0].aFilters){e=t._formatMultiFilter(e,0,false);e=t._formatMultiFilter(e,1,true)}else if(e[0]&&e[0].aFilters[0]&&e[0].aFilters[1]&&e[0].aFilters[0].aFilters&&e[0].aFilters[1].aFilters){e=t._formatMultiFilter(e,0,false);e=t._formatMultiFilter(e,1,false)}return e};m.prototype._formatSingleFilter=function(e){var t=this;var r=null;for(var a=0;a<e[0].aFilters.length;a++){if(e[0].aFilters[a].sOperator==="Contains"){e[0].aFilters[a].sOperator="EQ"}else if(e[0].aFilters[a].sOperator==="BT"){var o=t._manageParam(e[0].aFilters[a].sPath,e[0].aFilters[a].sOperator,e[0].aFilters[a].oValue1,e[0].aFilters[a].oValue2);delete e[0].aFilters[a];e[0].aFilters[a]=o}else if(e[0].aFilters[a].sOperator==="StartsWith"){r=e[0].aFilters[a].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;r.setValueState("Error");r.setValueStateText(e[0].aFilters[a].sOperator+" operator not supported")}else if(e[0].aFilters[a].sOperator==="EndsWith"){r=e[0].aFilters[a].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;r.setValueState("Error");r.setValueStateText(e[0].aFilters[a].sOperator+" operator not supported")}}return e};m.prototype._formatMultiFilter=function(e,t,r){var a=this;var o=null;var i=[];if(r){i=e[0].aFilters[t].aFilters[0].aFilters}else{i=e[0].aFilters[t].aFilters}for(var s=0;s<i.length;s++){if(i[s].sOperator==="Contains"){i[s].sOperator="EQ"}else if(i[s].sOperator==="BT"){var n=a._manageParam(i[s].sPath,i[s].sOperator,i[s].oValue1,i[s].oValue2);delete i[s];i[s]=n}else if(i[s].sOperator==="StartsWith"){o=i[s].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;o.setValueState("Error");o.setValueStateText(i[s].sOperator+" operator not supported")}else if(i[s].sOperator==="EndsWith"){o=i[s].sPath===this._propertyValue?this._valueFieldValue:this._valueFieldDescription;o.setValueState("Error");o.setValueStateText(i[s].sOperator+" operator not supported")}}return e};m.prototype._manageParam=function(e,t,r,a){var o=[];if(r&&a){o=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(e,sap.ui.model.FilterOperator.GT,r),new sap.ui.model.Filter(e,sap.ui.model.FilterOperator.LT,a)],and:true})}return o};m.prototype._getSearchFilters=function(e){return new sap.ui.model.Filter({filters:[new sap.ui.model.Filter(this._propertyValue,sap.ui.model.FilterOperator.EQ,e),new sap.ui.model.Filter(this._propertyDescription,sap.ui.model.FilterOperator.EQ,e)],and:false})};m.prototype.setValueStateFilter=function(e){var t=e.getSource().sId;this._valueFieldValue=sap.ui.getCore().byId(t+"-filterItemControlA_-Value");if(this._valueFieldValue){this._valueFieldValue.setValueState("None");this._valueFieldValue.setValueStateText("")}this._valueFieldDescription=sap.ui.getCore().byId(t+"-filterItemControlA_-Description");if(this._valueFieldDescription){this._valueFieldDescription.setValueState("None");this._valueFieldDescription.setValueStateText("")}};m.prototype.onValueHelpLinkPress=function(e,t){if(!this.getEditable()){return}var r=sap.ui.getCore().byId(this.getExpressionLanguage());var a=r.getValueHelpCallback();var o=this.getExpressionTokens();var i;var s;var n=this.codeMirror.getCursor().line;var l;for(i=0;i<o.length;i++){if(o[i].tokenType==="valueList"&&o[i].info&&o[i].info.id===t&&o[i].token===e){s=[o[i].info];l=o[i].end;break}}var p={};p.ch=l;p.line=n;if(typeof a==="function"){a.call(this,s);var u=s[0].model;if(!u.getMetaModel().oModel){u.attachMetadataLoaded(function(){this._createValueHelpProvider(s[0],true)}.bind(this))}else{this._createValueHelpProvider(s[0],true)}}else if(s&&s[0].metadata.hasOwnProperty(this._hasValueSource)&&s[0].metadata.HasValueSource===true){s[0].expressionLanguage=r;this._createCpValueHelp(s[0],p,true,true)}};m.prototype._createSearchCursor=function(e){var t=this.codeMirror;t.getCursor().ch=t.getCursor().ch+e.length;var r=t.getSearchCursor(e,t.getCursor(),typeof e=="string"&&e==e.toLowerCase());return r};m.prototype.setTextOnCursor=function(e,t,r,a,o,i){function s(e,t){var r=e+1;for(var a=r;a<t.length;a++){if(t[a].length===0){r++}else{break}}return r}var n="String",l="Date",p="Timestamp",u="Time";var d;var h=a===n||a===l||a===p||a===u?"'"+e+"'":e;var c=this.getExpressionTokens();var f=this.getValue().split("\n");var g=-1;var v={start:{line:t.line,ch:t.ch},end:{line:t.line,ch:t.ch}};for(var m=0;m<c.length;m++){g=c[m].start===0?s(g,f):g;if(g===t.line&&c[m].end>t.ch||c[m].end>=t.ch&&i){v.start.ch=c[m].start;v.end.ch=c[m].end;r=true;break}}if(r){this.codeMirror.replaceRange(h,v.start,v.end);d=this.codeMirror.findPosH(v.start,h.length,"char",true);this.codeMirror.setCursor(d)}else{h=o?" "+h:h;this.codeMirror.replaceRange(h,t);d=this.codeMirror.findPosH(t,h.length,"char",true);this.codeMirror.setCursor(d)}var y=sap.ui.getCore().byId(this.getExpressionLanguage());this.getFormattingTokens(y);this.ValueHelpRequested=false};m.prototype._setCodeMirror=function(){var e=this.getEditable();var t;if("getAttributeInfo"in this&&this.getAttributeInfo()){t=this.getAttributeInfo()}var r=sap.ui.getCore().byId(this.getExpressionLanguage());var a;if(t){a=r.getValueListAttribute(t)}function o(e,t,r){var a=e.options.expressionEditor;if(a.getEditable()!==false&&sap.ui.getCore().byId(a.getExpressionLanguage())){window.clearTimeout(a.timer);a.timer=window.setTimeout(function(){e.execCommand(t)},r);return window.CodeMirror.Pass}return null}function i(e){var t=e.options.expressionEditor;if(t.getEditable()!==false){window.clearTimeout(t.timer);t.needAutoComplete=true;t.timer=window.setTimeout(function(){if(t.needAutoComplete&&sap.ui.getCore().byId(t.getExpressionLanguage())){e.execCommand("autocomplete")}},500);return window.CodeMirror.Pass}return null}function s(e){return o(e,"enterAutocomplete",500)}function n(e){return o(e,"colonAutocomplete",500)}function l(e){o(e,"autocomplete",0)}function u(e){return o(e,"autocomplete",500)}function d(e){var t=e.options.expressionEditor;var r=e.getRange({line:0,ch:0},e.getCursor());if(e.options.headerValue){var a=e.options.headerValue+" ";if(e.options.fixedOperator){a=a+e.options.fixedOperator+" "}r=a+r}var o=e.options.relDelegate.getSuggestions(r,e.options.returnType,e.options.collection);var i;if(o&&o.hasOwnProperty("suggs")&&o.suggs.length>0){i=o.suggs;for(var s=0;s<i.length;s++){if(i[s].tokenType==="valueList"&&i[s].info.metadata.hasOwnProperty(t._hasValueSource)){t._createCpValueHelp(i[s].info,e.getCursor(),false)}}}}this.keyMap={Tab:false,"Shift-Tab":false,"Ctrl-Space":l,Backspace:i,Enter:s,"':'":n,"'+'":i,"'-'":i,"'*'":i,"'/'":i,"'_'":i,"'o'":i,"'q'":i,"'w'":i,"'e'":i,"'r'":i,"'t'":i,"'y'":i,"'u'":i,"'i'":i,"'p'":i,"'.'":i,"'a'":i,"'s'":i,"'d'":i,"'f'":i,"'g'":i,"'h'":i,"'j'":i,"'k'":i,"'l'":i,"'z'":i,"'x'":i,"'c'":i,"'v'":i,"'b'":i,"'n'":i,"'m'":i,"'O'":i,"'Q'":i,"'W'":i,"'E'":i,"'R'":i,"'T'":i,"'Y'":i,"'U'":i,"'I'":i,"'P'":i,"'A'":i,"'S'":i,"'D'":i,"'F'":i,"'G'":i,"'H'":i,"'J'":i,"'K'":i,"'L'":i,"'Z'":i,"'X'":i,"'C'":i,"'V'":i,"'B'":i,"'N'":i,"'M'":i,"'0'":false,"'1'":false,"'2'":false,"'3'":false,"'4'":false,"'5'":false,"'6'":false,"'7'":false,"'8'":false,"'9'":false,"' '":u,F4:d};function h(e){return e.keyMap}if(this.expressionTokens.length===0){var c=sap.ui.getCore().byId(this.getExpressionLanguage());if(c){this.getFormattingTokens(c)}}var f=h(this);var g=this.oTextArea.getId()+"-inner";var v=p.msieversion()>=0;if(v){jQuery("#"+g).attr("placeholder",this.getProperty("placeholder"))}this.codeMirror=window.CodeMirror.fromTextArea(document.getElementById(g),{mode:"text/hdf",lineNumbers:false,lineWrapping:true,matchBrackets:e===true?true:false,highlightSelectionMatches:e===true?{showToken:/\w/}:{},relDelegate:r,returnType:this.getProperty("type"),collection:this.getProperty("collection"),valueListAttribute:a,expressionEditor:this,stillNeedShowHint:true,shouldValidate:true,styleSelectedText:true,smartIndent:true,autoCloseBrackets:true,indentUnit:6});this.codeMirror.addKeyMap(f,true)};m.prototype.getFormattingTokens=function(e){this.tokens=[];this.valueListAttrInfo=e.getValueListAttribute(this.mProperties.attributeInfo);var t=e.getExpressionMetadata(this._liveValue);if(t){this.tokens=t.tokens}if(e._hasValueSource&&this.valueListAttrInfo){this.newExpression=this.valueListAttrInfo.navPath+" "+v.IS_EQUAL_TO+" "+this._liveValue;t=e.getExpressionMetadata(this.newExpression);if(t){var r=t.tokens;for(var a=0;a<r.length;a++){for(var o=0;o<this.tokens.length;o++){if(r[a].tokenType==="valueList"&&r[a].token===this.tokens[o].token){this.tokens[o].info=r[a].info;this.tokens[o].tokenType=r[a].tokenType}}}}}this.setExpressionTokens(this.tokens)};m.prototype._setEditorStyle=function(){if(this.getValueStateText()&&this.getValueStateText()!==""){jQuery(this.codeMirror.getWrapperElement()).addClass("CodeMirror-error");jQuery(this.codeMirror.getWrapperElement()).addClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError");jQuery("#"+this.oTextArea.getId()).addClass("sapMInputBaseError")}jQuery("#"+this.oTextArea.getId()).removeClass().addClass("sapMInput");jQuery(this.codeMirror.getWrapperElement()).addClass("sapMInputBaseInner CodeMirror-rules");if(!this.getEditable()){jQuery(this.codeMirror.getWrapperElement()).addClass("CodeMirror-rules-Not-Editable")}else{jQuery(this.codeMirror.getWrapperElement()).removeClass("CodeMirror-rules-Not-Editable")}if(this.codeMirror){this.codeMirror.refresh()}};m.prototype._handleOnLoadValidation=function(){if(this.getValidateOnLoad()){this.validateExpression();this.setValidateOnLoad(false)}};m.prototype._handleEditableProperty=function(){if(this.getEditable()===false){this.codeMirror.setOption("readOnly","true");this.codeMirror.setOption("theme","read-only")}};m.prototype._handleFocus=function(){var e=this.codeMirror;if(this.getFocusOnLoad()){this.focus()}this.codeMirror.on("focus",function(e,t){var r=e.options.expressionEditor.getProperty("valueStateText");if(r&&r!==""){e.options.expressionEditor._showPopUp()}e.options.stillNeedShowHint=true;jQuery("#"+e.options.expressionEditor.oTextArea.getId()).addClass("sapMInputFocused");jQuery(e.getWrapperElement()).removeClass("CodeMirror-errorBackground")});if(this.dataModel.getProperty("/focus")===true){window.setTimeout(function(){var t=e.getLine(e.lastLine());var r=t.length;e.setCursor({line:e.lastLine(),ch:r})},10)}};m.prototype._refreshOnNavigationEnd=function(){jQuery(".sapMNav").on("webkitTransitionEnd oTransitionEnd transitionend msTransitionEnd",jQuery.proxy(e,this));function e(){if(this.codeMirror){this.codeMirror.refresh()}}};m.prototype._handleKeyPress=function(){this.codeMirror.on("keyHandled",function(e,t,r){if(r.keyCode===27&&this&&this.endCompletion===true){r.stopPropagation();this.endCompletion=false}if(r.ctrlKey===true&&t==="Ctrl-A"){r.stopPropagation()}})};m.prototype._handleEndCodeCompletion=function(){this.codeMirror.on("endCompletion",function(e){e.options.expressionEditor.needAutoComplete=false;e.options.expressionEditor.endCompletion=!e.options.expressionEditor.endCompletion})};m.prototype._handleMousedown=function(){this.codeMirror.on("mousedown",function(e,t){t.stopPropagation();var r=t.target||t.srcElement;if(r&&t.button===0){var a=r.className.split(/\s+/);for(var o=0;o<a.length;o++){if(a[o]==="cm-valuehelp"){var i=a[++o].split("-valuehelpid-")[1];e.options.expressionEditor.onValueHelpLinkPress(r.textContent,i)}}}})};m.prototype._handleChange=function(){this.codeMirror.on("change",function(e,t){var r=e.options.expressionEditor;if(r.codeMirror.state.completionActive&&r.keyMap["'"+t.text[0]+"'"]===false){r.codeMirror.state.completionActive.close()}jQuery(r.codeMirror.getWrapperElement()).removeClass("CodeMirror-error");jQuery(r.codeMirror.getWrapperElement()).removeClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError");r._liveValue=e.getValue();var a=sap.ui.getCore().byId(r.getExpressionLanguage());if(a){r.getFormattingTokens(a)}r.codeMirror.options.shouldValidate=true;r.fireLiveChange({newValue:e.getValue()});if(t.origin!=="+delete"){e.operation(function(){for(var t=0,r=e.lineCount();t<r;++t){e.indentLine(t,"smart")}})}})};m.prototype._handleFocusLeave=function(){this.codeMirror.on("blur",function(e){var t=e.options.expressionEditor;t._closePopUp();t.codeMirror.options.stillNeedShowHint=false;if(t.codeMirror.options.shouldValidate&&!t.bFlagForPreventBlurWhenPopOverOpen){t.setValue(t.codeMirror.getValue());if(!(t instanceof sap.rules.ui.DecisionTableCellExpressionAdvanced)){t.validate()}t._closePopUp();t.fireChange({newValue:e.getValue()});t.codeMirror.options.shouldValidate=false}jQuery("#"+t.oTextArea.getId()).removeClass("sapMInputFocused");t.dataModel.setProperty("/focus",false)})};m.prototype._setExpressionErrorStyle=function(){var e=this.getProperty("valueStateText");if(e!==""&&e!==undefined&&this.codeMirror){jQuery(this.codeMirror.getWrapperElement()).addClass("CodeMirror-error");jQuery(this.codeMirror.getWrapperElement()).addClass("sapMInputBaseStateInner sapMInputBaseErrorInner sapMInputBaseContentWrapper sapMInputBaseContentWrapperState sapMInputBaseContentWrapperError");jQuery("#"+this.oTextArea.getId()).addClass("sapMInputBaseError");var t;if(this.errorCursorPosition<0){var r=this.codeMirror.getLine(this.codeMirror.lastLine());t=r.length;jQuery(this.codeMirror.getWrapperElement()).addClass("CodeMirror-errorBackground")}else{var a=e.lastIndexOf("'");if(a>0){var o=e.substring(0,a);a=o.lastIndexOf("'");if(a>0){o=o.substring(a+1)}var i=false;for(var s=this.codeMirror.lastLine();!i&&s>=0;s--){var n=this.codeMirror.getLine(s);t=n.lastIndexOf(o);if(t>=0){i=true;this.codeMirror.setSelection({line:s,ch:t},{line:s,ch:t+o.length})}}}}}};m.prototype.getSelectedText=function(){return this.codeMirror.getSelection()};m.prototype.exit=function(){document.removeEventListener("mousedown",this.fnMouseDownListsner,true)};return m},true);
//# sourceMappingURL=ExpressionAdvanced.js.map
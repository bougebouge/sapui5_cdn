/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/rules/ui/library","sap/ui/core/Control","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Switch","sap/m/Select","sap/m/MessageBox","sap/m/Table","sap/m/Text","sap/m/CheckBox","sap/m/Input","sap/m/Button","sap/rules/ui/ExpressionAdvanced","sap/ui/layout/VerticalLayout","sap/rules/ui/type/Expression","sap/rules/ui/Constants","sap/rules/ui/AstExpressionBasic","sap/rules/ui/services/AstExpressionLanguage","sap/rules/ui/ast/util/AstUtil","./DecisionTableSettingsRenderer"],function(jQuery,e,t,s,i,a,r,o,n,l,u,d,p,g,c,h,f,b,y,v,T){"use strict";var D=t.extend("sap.rules.ui.DecisionTableSettings",{metadata:{library:"sap.rules.ui",properties:{cellFormat:{type:"sap.rules.ui.DecisionTableCellFormat",defaultValue:sap.rules.ui.DecisionTableCellFormat.Both},hitPolicies:{type:"sap.rules.ui.RuleHitPolicy[]",defaultValue:[sap.rules.ui.RuleHitPolicy.FirstMatch,sap.rules.ui.RuleHitPolicy.AllMatch]},modelName:{type:"string",defaultValue:""},newDecisionTable:{type:"boolean",defaultValue:false},decisionTableFormat:{type:"sap.rules.ui.DecisionTableFormat",defaultValue:sap.rules.ui.DecisionTableFormat.CellFormat},enableSettingResult:{type:"boolean",defaultValue:true}},aggregations:{mainLayout:{type:"sap.ui.layout.form.SimpleForm",multiple:false}},defaultAggregation:"mainLayout",associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,singularName:"expressionLanguage"},astExpressionLanguage:{type:"sap.rules.ui.services.AstExpressionLanguage",multiple:false,singularName:"astExpressionLanguage"}},events:{},publicMethods:[]},renderer:T});sap.rules.ui.DecisionTableSettings.prototype._addColumnToJsonModel=function(e){var t=this.getModel();var s=t.getData();var i=t.oData.DecisionTable.DecisionTableColumns.results;var a={Condition:{Expression:"",FixedOperator:"",Id:this.mNextColumnId,RuleId:s.Id,ValueOnly:this._getCellFormat(),Version:s.Version},Id:this.mNextColumnId,RuleId:s.Id,Sequence:e+1,Type:sap.rules.ui.DecisionTableColumn.Condition,Version:s.Version,Status:"C"};this.mNextColumnId++;i.splice(e,0,a);for(var r=e+1;r<i.length;r++){i[r].Sequence=r+1;if(i[r].Status&&i[r].Status==="C"){continue}i[r].Status="U"}this._setDisplayModelData(s)};sap.rules.ui.DecisionTableSettings.prototype._addNodeObject=function(e){var t=[];var s=sap.ui.getCore().byId(this.getAstExpressionLanguage());var i=s._astBunldeInstance.ASTUtil;var a=[];a.Root=e.Root;a.SequenceNumber=e.Sequence;a.ParentId=e.ParentId;a.Reference=e.Reference;a.Id=e.NodeId;a.Type=e.Type;a.Value=e.Value?e.Value:"";if(e.Type==="I"){a.Value=e.IncompleteExpression}if(e.Function){a.Function=e.Function}if(e.Type!=="P"&&!e.Function){var r=[];r.BusinessDataType=e.Output?e.Output.BusinessDataType:e.BusinessDataType;r.DataObjectType=e.Output?e.Output.DataObjectType:e.DataObjectType;a.Output=r}i.createNode(a)};sap.rules.ui.DecisionTableSettings.prototype._bindPredefinedTable=function(e,t){var s=this;this.oPredefinedTable.destroyItems();var i=this.getModel("oDataModel");var a;if(this.getExpressionLanguage()){a=sap.ui.getCore().byId(this.getExpressionLanguage())}else{a=sap.ui.getCore().byId(this.getAstExpressionLanguage())}var r=new sap.ui.model.odata.v2.ODataModel(a.getModel().sServiceUrl);var n=true;var l;var u;var d;var p=function(e){if(e&&e.length>0){s.oPredefinedTable.setBusy(true);for(var a=0;a<e.length;a++){l="";if(t==="/DecisionTableColumnResults"&&e[a].Type==="RESULT"){u={RuleId:e[a].RuleId,Id:e[a].Id,Version:e[a].Version};l=i.createKey(t,u);d=new sap.ui.model.Context(i,l)}else if(t==="/ExpandedAttributes"){u={DataObjectId:e[a].DataObjectId,Id:e[a].Id,VocabularyId:e[a].VocabularyId,RootDataObjectId:e[a].RootDataObjectId,AttributeId:e[a].AttributeId};l=r.createKey(t,u);d=new sap.ui.model.Context(r,l);d.DataObjectAttributeinfo=e[a]}if(s.getExpressionLanguage()){var o=d?d.getObject(l).BusinessDataType:"";if(o===f.DATE_BUSINESS_TYPE||o===f.TIMESTAMP_BUSINESS_TYPE||o===f.NUMBER||o===f.STRING||o===f.BOOLEAN_BUSINESS_TYPE||o===f.BOOLEAN_ENHANCED_BUSINESS_TYPE){n=true}else{n=false}}if(l&&n){s.oPredefinedTable.addItem(s._predefinedFactory("col-"+a,d))}}s.oPredefinedTable.setBusy(false);s._internalModel.setProperty("/needToRefresh",false)}};if(t==="/DecisionTableColumnResults"){var g=this.getModel().getProperty("/DecisionTable/DecisionTableColumns/results");var c=s.getModel("settingsModel").attributeSequenceArray;var h=[];if(c&&c.length>0){var b=0;for(var y in g){if(g[y].Type===f.CONDITION){h.push(g[y]);b=b+1}}for(var v in c){for(var T=b;T<g.length;T++){if(g[T].Result&&g[T].Result.DataObjectAttributeId===c[v]){h.push(g[T])}}}p(h)}else{p(g)}}else if(t==="/ExpandedAttributes"){var D=this.getModel("settingsModel").oData.newDOAttributeList;var m=this.getModel("settingsModel").oData.resultDataObjectChanged;var S=this.getModel("settingsModel").oData.refreshButtonClicked;var C=this.getModel("settingsModel").oData.resultAttributeSequenceChanged;var c=this.getModel("settingsModel").attributeSequenceArray;if(m&&!S&&C){var x=this._getOrderedAttributesArray(D);p(x)}else{r.read(e,{urlParameters:{$expand:"ExpandedAttributes"},success:function(e){if(e.ExpandedAttributes.results<=0){s.attributeListEmpty=true}var t=e.ExpandedAttributes.results;var i=s._getOrderedAttributesArray(t);if(i.length>0){s.getModel("settingsModel").oData.newDOAttributeList=i;p(i)}else{s.getModel("settingsModel").oData.newDOAttributeList=t;p(t)}},error:function(e){o.error(e.responseText,{title:s.oBundle.getText("ERROR_DIALOG"),actions:[sap.m.MessageBox.Action.OK]})}})}}};sap.rules.ui.DecisionTableSettings.prototype._getAttributeSequenceArray=function(){var e=this.getModel("settingsModel").attributeSequenceArray;if(!this.getModel("settingsModel").attributeSequenceArray){var t=this.getModel("settingsModel");var s=t.getData();var i=s.predefinedResults;var a=[];var r=0;for(var o in i){a[r]=i[o].DataObjectAttributeId?i[o].DataObjectAttributeId:i[o].Id;r++}this.getModel("settingsModel").attributeSequenceArray=a}return this.getModel("settingsModel").attributeSequenceArray};sap.rules.ui.DecisionTableSettings.prototype._getOrderedAttributesArray=function(e){var t=this.getModel("settingsModel").attributeSequenceArray;if(!t){t=this._getAttributeSequenceArray()}var s=[];if(t&&t.length>0&&(this.getModel("settingsModel").getData().resultAttributeSequenceChanged||this.getModel("settingsModel").getData().refreshButtonClicked)){for(var i in t){for(var a in e){if(e[a].Id===t[i]){s.push(e[a])}}}}return s};sap.rules.ui.DecisionTableSettings.prototype._calcNextColumnId=function(){var e=this.getModel();var t=e.getData();var s=t.DecisionTable?t.DecisionTable.DecisionTableColumns.results:[];var i=0;for(var a=0;a<s.length;a++){if(s[a].Id>i){i=s[a].Id}}var r=i+1;return r};sap.rules.ui.DecisionTableSettings.prototype._callRefreshResultsFunctionImport=function(){var e=this;var t=this.getModel("oDataModel");var s=this.getModel().getData();var i={groupId:"changes"};t.setDeferredGroups([i.groupId]);var a=function(t){if(e.needToRenderPredefinedResultsTable){e._createPredefinedResultsTable()}e.getModel().getData().needToRefresh=false};var r=function(e){sap.m.MessageToast.show(e)};var o=function(e){var o=s.Id;t.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:i.groupId,urlParameters:{RuleId:o}});t.submitChanges({groupId:i.groupId,success:a,error:r})};if(s.needToRefresh){o()}};sap.rules.ui.DecisionTableSettings.prototype._changeColumnInputMode=function(e,t){var s=t.getSource();this._openWarningDialog(s,e)};sap.rules.ui.DecisionTableSettings.prototype._changeColumnStatusToUpdate=function(e){var t=e.getModel();var s=e.getProperty("Status");if(!s||s!=="C"){t.setProperty(e.getPath()+"/Status","U")}};sap.rules.ui.DecisionTableSettings.prototype._changeInputMode=function(e,t,s){if(!e){t.setSelectedKey(this.oBundle.getText("valueOnly"));return}t.setEnabled(false);this.getModel().setProperty(s.sPath+"/Condition/ValueOnly",false);this._changeColumnStatusToUpdate(s)};sap.rules.ui.DecisionTableSettings.prototype._createDefaultColumn=function(){var e=this.getModel();var t=e.getData();if(!t.DecisionTable){t.DecisionTable={DecisionTableColumns:[]}}if(t.DecisionTable.DecisionTableColumns&&t.DecisionTable.DecisionTableColumns.results){t.DecisionTable.DecisionTableColumns.results.push({Condition:{Expression:"",FixedOperator:"",Id:this.mNextColumnId++,RuleId:t.Id,Version:t.Version,ValueOnly:this._getCellFormat()},Id:1,Sequence:1,Type:sap.rules.ui.DecisionTableColumn.Condition,Status:"C"})}};sap.rules.ui.DecisionTableSettings.prototype._createTable=function(){this.conditionsTable=new n({backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.None,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new sap.m.Column({width:"50%",header:new sap.m.Label({text:this.oBundle.getText("colOfDecisionTable"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("colOfDecisionTable"))}),new sap.m.Column({width:"25%",header:new sap.m.Label({text:this.oBundle.getText("label"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("label"))}),new sap.m.Column({width:"25%",header:new sap.m.Label({text:this.oBundle.getText("fixedOperator"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("fixedOperator"))}),new sap.m.Column({width:"20%"})]}).data("hrf-id","columnsTable",true);var e=this.getModel();this.conditionsTable.setModel(e);this.conditionsTable.bindItems({path:"/DecisionTable/DecisionTableColumns/results",factory:this._tableColumnsFactory.bind(this)});this.conditionsTable.setBusyIndicatorDelay(0);return this.conditionsTable};sap.rules.ui.DecisionTableSettings.prototype._createRefreshButton=function(){var e=function(){var e=this.getModel("settingsModel").oData.results.resultsEnumration;var t=this.getModel().oData.ResultDataObjectId;var s=[];var i=false;if(t){for(var a=0;a<e.length;a++){if(e[a].id===t){if(e[a].columns){s=e[a].columns;i=true;break}else{this.getModel("settingsModel").setProperty("/refreshButtonEnabled",true,null,true);this.getModel("settingsModel").setProperty("/resultDataObjectId",t);i=true;var r=this.oBundle.getText("refreshingWillDeleteMsg");var o=this.oBundle.getText("refreshAreyouSureMsg");return r+o}}}if(!i){s=null}if(s&&s.length>0){var n=this._ruleResultColumns();var l=this._getResultsUpdates(n,s);return this._getMessageByResultUpdates(l)}}this.getModel("settingsModel").setProperty("/refreshButtonEnabled",false,null,true);return null}.bind(this);var t=function(){this._updateRefreshFlags(true,false,true)}.bind(this);var s=e();var i=function(){var e=s;o.warning(e,{title:this.oBundle.getText("refeshResultWarningTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e===sap.m.MessageBox.Action.OK){t()}}})}.bind(this);var a=new p({layoutData:new sap.ui.layout.ResponsiveFlowLayoutData({weight:1}),icon:sap.ui.core.IconPool.getIconURI("synchronize"),width:"3rem",type:sap.m.ButtonType.Transparent,text:"",press:i,visible:true,enabled:"{settingsModel>/refreshButtonEnabled}"}).setTooltip(this.oBundle.getText("refreshBtn"));this.refreshButton=a;return a};sap.rules.ui.DecisionTableSettings.prototype._createInfoMessageStrip=function(e,t){var s=sap.ui.getCore().byId(t);if(!s){s=new sap.m.MessageStrip({visible:true,id:t,text:e,type:sap.ui.core.MessageType.Information,showIcon:true,showCloseButton:true}).addStyleClass("sapRULTDecisionTableSettingsMessageStrip")}return s};sap.rules.ui.DecisionTableSettings.prototype._createLayout=function(){var e=new s({editable:true,layout:"ResponsiveGridLayout",maxContainerCols:1,columnsL:1,columnsM:1,labelSpanM:1,content:[new i({text:this.oBundle.getText("hitPolicy")}).setTooltip(this.oBundle.getText("hitPolicy")),new r({width:"220px",enabled:"{settingsModel>/hitPolicy/enabled}",items:{path:"settingsModel>/hitPolicy/hitPolicyEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>text}"})},selectedKey:"{/DecisionTable/HitPolicy}",change:function(e){var t=this.getModel();var s=t.getData();if(s.DecisionTable.HitPolicyStatus!="C"){s.DecisionTable.HitPolicyStatus="U"}}.bind(this)}),new i,new sap.ui.layout.HorizontalLayout({}),new i({text:this.oBundle.getText("conditionsTableLabelText")}).setTooltip(this.oBundle.getText("conditionsTableLabelTooltip")),this._createTable(),new i,new sap.ui.layout.HorizontalLayout({}),new i({text:this.oBundle.getText("output")}).setTooltip(this.oBundle.getText("output")),new sap.ui.layout.HorizontalLayout({content:[this._createResultInput(),this._createRefreshButton()]}),new i,this._createPredefinedResultsLayout()]}).addStyleClass("sapRULTDecisionTableSettingsForm");return e};sap.rules.ui.DecisionTableSettings.prototype._createPredefinedResultsLayout=function(){if(this.needToRenderPredefinedResultsTable){var e=new sap.ui.layout.VerticalLayout({content:[this._createInfoMessageStrip(this.oBundle.getText("PredefinedMessageStripHiddenAccessInfoText"),"id_HiddenAccessMessageStrip"),this._createInfoMessageStrip(this.oBundle.getText("PredefinedMessageStripEditableAccessInfoText"),"id_EditableAccessMessageStrip"),this._createPredefinedResultsTable()]});return e}else{return new i}};sap.rules.ui.DecisionTableSettings.prototype._createPredefinedResultsTable=function(){if(!this.oPredefinedTable){this.oPredefinedTable=new sap.m.Table("idPredefinedTable",{backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.All,swipeDirection:sap.m.SwipeDirection.Both,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new sap.m.Column({width:"45%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedResultColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new sap.m.Column({width:"30%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedAccessColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new sap.m.Column({width:"45%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedValuesColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new sap.m.Column({width:"20%",header:new sap.m.Label({text:this.oBundle.getText("ReorderResultDOAttributes"),design:sap.m.LabelDesign.Bold})})]})}var e=this.getModel("settingsModel").getProperty("/resultDataObjectChanged");var t=this.getModel("settingsModel").getProperty("/refreshButtonClicked");var s=this.getModel();var i="";if(!e&&!t){this.oPredefinedTable.setModel(s);this._bindPredefinedTable("/DecisionTable/DecisionTableColumns/results","/DecisionTableColumnResults");this.oPredefinedTable.setBusyIndicatorDelay(0);return this.oPredefinedTable}else{var i=this.getModel().getProperty("/ResultDataObjectId");this._getLatestResultDataObjects(i)}return null};sap.rules.ui.DecisionTableSettings.prototype._createResultInput=function(){var e=this.getModel();var t=e.oData.ResultDataObjectId;var s=this.getModel("settingsModel");var i=this.getProperty("enableSettingResult");var a=s.oData.results.resultsEnumration;if(t!==f.NO_RESULT||t!==""){a.splice(0,1);s.oData.results.resultsEnumration=a}var r=e.oData&&e.oData.ResultDataObjectLabel?e.oData.ResultDataObjectLabel:e.oData.ResultDataObjectName;this.oResultInput=new d({width:"220px",valueHelpOnly:true,showValueHelp:true,value:r,tooltip:this.oBundle.getText("chooseResultTooltip"),valueHelpRequest:function(t){var s=t.getSource();var i=this.getModel();var a=i.getData();var r=function(){var t=function e(t){var s=t.getParameter("value");var i=new sap.ui.model.Filter("name",sap.ui.model.FilterOperator.Contains,s);t.getSource().getBinding("items").filter([i])};this.oSelectDialog=new sap.m.SelectDialog({title:this.oBundle.getText("chooseResultDialogTitle"),styleClass:"sapUiPopupWithPadding",rememberSelections:true,items:{path:"settingsModel>/results/resultsEnumration",template:new sap.m.StandardListItem({title:"{settingsModel>label}",description:"{settingsModel>description}"})},search:t,liveChange:t,confirm:function(t){var i=t.getParameter("selectedItem");var r=t.getParameter("selectedContexts");if(i){var o=r[0].getProperty().id;s.setSelectedKey(o);e=this.getModel();e.oData.ResultDataObjectId=o;e.oData.ResultDataObjectName=r[0].getProperty().name;e.oData.ResultDataObjectLabel=r[0].getProperty().label;var n=this.getModel("settingsModel");n.setProperty("/resultDataObjectChanged",true);n.setProperty("/resultAttributeSequenceChanged",false);n.attributeSequenceArray=[];n.oData.predefinedResults=[];if(this.needToRenderPredefinedResultsTable){this._createPredefinedResultsTable()}if(!a.ResultDataObjectStatus){a.ResultDataObjectStatus="U";if(a.ResultDataObjectId!=i.getInfo()){this._updateRefreshFlags(false,false,false)}}}t.getSource().getBinding("items").filter([]);if(this.oSelectDialog&&this.oSelectDialog._oDialog){this.oSelectDialog._oDialog.destroy();this.oSelectDialog=null}}.bind(this),cancel:function(e){if(this.oSelectDialog&&this.oSelectDialog._oDialog){this.oSelectDialog._oDialog.destroy();this.oSelectDialog=null}this.oSelectDialog=null}.bind(this)});this.oSelectDialog.setModel(this.oResultInput.getModel("settingsModel"),"settingsModel");this.oSelectDialog.open()}.bind(this);function n(){o.warning(this.oBundle.getText("changeResultWarningMsg"),{title:this.oBundle.getText("changeResultWarningTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e===sap.m.MessageBox.Action.OK){r()}}})}if(a.ResultDataObjectStatus){r()}else if(this.getProperty("newDecisionTable")){a.ResultDataObjectStatus="C";r()}else{n.call(this)}}.bind(this)});if(i){this.oResultInput.bindAggregation("suggestionItems",{path:"settingsModel>/results/resultsEnumration",template:new sap.ui.core.Item({key:"{settingsModel>id}",text:"{settingsModel>label}"})});this.oResultInput.setSelectedKey(this.getModel().getData().ResultDataObjectId);this.oResultInput.setEnabled(i)}else{this.oResultInput.setEnabled(i)}return this.oResultInput};sap.rules.ui.DecisionTableSettings.prototype._destroyElement=function(e){var t=sap.ui.getCore().byId(e);if(t){if(e==="idPredefinedTable"){t.destroyColumns()}t.destroy()}};sap.rules.ui.DecisionTableSettings.prototype._findAndRemoveDeletedAttributeFromOModel=function(){var e=this.getModel("settingsModel");var t=e.oData.predefinedResults;for(var s in t){var i=e.oData.predefinedResults;var a=[];var r="";if(!t[s].AttributeInBackend){r=s;for(var o in i){if(o===r){continue}else{a[o]={};a[o].AccessMode=i[o].AccessMode;a[o].Expression=i[o].Expression}}}var n=this.getModel();var l=n.oData.DecisionTable.DecisionTableColumns.results;for(var u=0;u<l.length;u++){if(l[u].Result&&l[u].Result.DataObjectAttributeId===r){this.sequenceOfAttributeDeleted=l[u].Sequence;this._removeColumnFromJsonModel(this.sequenceOfAttributeDeleted,"C")}}}};sap.rules.ui.DecisionTableSettings.prototype._findPropertyAccessMode=function(){var e=this.oModels.oDataModel.oServiceData.oMetadata.mEntityTypes["/DecisionTableColumnResults"].property;if(e){for(var t=0;t<e.length;t++){if(e[t].name===f.KEY_ACCESSMODE){return true}}return false}};sap.rules.ui.DecisionTableSettings.prototype._getASTExpressionBasicForCondition=function(e){var t=this;var s=sap.ui.getCore().byId(this.getAstExpressionLanguage());var i=e.getProperty("Condition/Expression");var a=this._getExpressionFromAstNodes(e);if(a&&a.relString){a.relString=a.relString.replace(/\\/g,"\\\\").replace(/{/g,"\\{").replace(/}/g,"\\}")}var r=new b({astExpressionLanguage:s,value:a.relString?a.relString:"",placeholder:this.oBundle.getText("expressionPlaceHolder"),valueState:a.valueState,jsonData:a.JSON,change:function(s){var i=s.getSource();e=i.getBindingContext();var a=e.getPath();var o=s.getParameter("astNodes");var n=s.getParameter("newValue");if(o&&o.length===1&&o[0].Type==="I"&&o[0].Value&&o[0].Value!==""){i.setValueState("Error")}else{i.setValueState("None")}var l=e.getModel();var u=e.getProperty("Condition/ValueOnly");var d=t._getASTNodes(o,e);l.setProperty(a+"/Condition/ASTNodes",d);t._setExpressionRelevantOperators(n,e.getProperty("Condition/Id"),u,r);if(d.length===1&&d[0].Value===""){l.setProperty(a+"/Condition/FixedOperator","");l.setProperty(a+"/Condition/ASTNodes",[])}t._changeColumnStatusToUpdate(e);i._validateControl()}.bind(this)}).setBindingContext(e);this._setExpressionRelevantOperators(a.relString,e.getProperty("Condition/Id"),e.getProperty("Condition/ValueOnly"),r);if(document.getElementById("content")&&document.getElementById("content").classList&&document.getElementById("content").classList.length>0&&o(document.getElementById("content").classList)){r.addStyleClass("sapRULDecisionTableSettingsAstExpressionCompactSize")}else{r.addStyleClass("sapRULDecisionTableSettingsAstExpressionCozySize")}function o(e){for(var t=0;t<e.length;t++){if(e[t]==="sapUiSizeCompact"){return true}}return false}return r};sap.rules.ui.DecisionTableSettings.prototype._getASTExpressionBasicForPredefined=function(e,t,s,i,a){var r=this;var o="";var n=e.getObject(e.getPath());if(n&&!o){o=n.DataObjectAttributeId?n.DataObjectAttributeId:n.Id}else if(e.DataObjectAttributeinfo){o=e.DataObjectAttributeinfo.Id}if(o){s=this._getExpressionFromAstNodes(e,a);var l=this.getModel().oData.ResultDataObjectId;this.attributeInfo="/"+l+"/"+this._formatAttributeId(o)}if(s&&s.relString){s.relString=s.relString.replace(/\\/g,"\\\\").replace(/{/g,"\\{").replace(/}/g,"\\}")}var u=sap.ui.getCore().byId(this.getAstExpressionLanguage());var d=i?i:sap.rules.ui.ExpressionType.NonComparison;var p=new b({id:t,astExpressionLanguage:u,value:s.relString?s.relString:"",jsonData:s.JSON,attributeInfo:this.attributeInfo,placeholder:this.oBundle.getText("expressionPlaceHolder"),valueState:s.valueState,change:function(t){r.expressionControl=t.getSource();var s=t.getParameter("astNodes");var i=e.getModel();var a=e.getPath();var o=t.getParameter("newValue");var n=r._getASTNodes(s,e);if(n&&n.length===1&&n[0].Type==="I"&&n[0].Value!==""){r.expressionControl.setValueState("Error")}else{r.expressionControl.setValueState("None")}r.getModel("settingsModel").setProperty("/resultAttributeChanged",true);r._updateResultAttributeJSON(e,null,null,n,false,false,false);r.expressionControl._validateControl()}.bind(this)}).setBindingContext(e);return p};sap.rules.ui.DecisionTableSettings.prototype._getASTNodes=function(e,t){var s=[];for(var i in e){var a={};if(e[i].Root){a.Sequence=1;a.Root=true}else{a.Sequence=e[i].SequenceNumber;a.ParentId=e[i].ParentId}if(e[i].Function){a.Function=e[i].Function?e[i].Function:""}if(e[i].Type!=="P"&&e[i].Type!=="O"&&!e[i].Function){a.BusinessDataType=e[i].Output?e[i].Output.BusinessDataType:e[i].BusinessDataType;a.DataObjectType=e[i].Output?e[i].Output.DataObjectType:e[i].DataObjectType;a.Value=e[i].Value?e[i].Value:""}else if(e[i].Type==="O"){a.Reference=e[i].Reference}if(e[i].Type==="I"){a.IncompleteExpression=e[i].Value}a.NodeId=e[i].Id;a.Type=e[i].Type;a.RuleId=t.getProperty("RuleId")?t.getProperty("RuleId"):this.getModel().getData().DecisionTable.RuleId;a.Version=t.getProperty("Version")?t.getProperty("Version"):this.getModel().getData().DecisionTable.Version;a.Id=t.getProperty("Id");s.push(a)}return s};sap.rules.ui.DecisionTableSettings.prototype._getBindModelName=function(){var e="";var t=this.getModelName();if(t){e=t+">"}return e};sap.rules.ui.DecisionTableSettings.prototype._getCellFormat=function(){var e=this.getProperty("cellFormat");var t=this.getProperty("decisionTableFormat");if(t===sap.rules.ui.DecisionTableFormat.RuleFormat){return this.getModel().getData().RuleFormat===sap.rules.ui.RuleFormat.Basic?true:false}return e!==sap.rules.ui.DecisionTableCellFormat.Text?true:false};sap.rules.ui.DecisionTableSettings.prototype._getCellFormatAcccessOptions=function(){var e=this.getProperty("cellFormat");var t={CellFormat:e,cellFormatEnumration:[{key:f.KEY_EDITABLE,value:this.editableModeText},{key:f.KEY_HIDDEN,value:this.hiddenModeText}]};return t};sap.rules.ui.DecisionTableSettings.prototype._getCellFormatData=function(){var e=this.getProperty("cellFormat");var t={CellFormat:e,cellFormatEnumration:[{key:this.oBundle.getText("advancedMode"),value:this.oBundle.getText("advancedMode")},{key:this.oBundle.getText("valueOnly"),value:this.oBundle.getText("valueOnly")}]};return t};sap.rules.ui.DecisionTableSettings.prototype._getColumnInputMode=function(e){if(!e){return this.oBundle.getText("advancedMode")}return this.oBundle.getText("valueOnly")};sap.rules.ui.DecisionTableSettings.prototype._getExpressionAdvanceColumn=function(e){var t=sap.ui.getCore().byId(this.getExpressionLanguage());return new g({expressionLanguage:t,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,type:sap.rules.ui.ExpressionType.NonComparison,value:{path:"Condition/Expression",events:{change:function(e){var t=e.getSource();var s=t.getContext();var i=s.getProperty("Id");var a=s.getProperty("Condition/ValueOnly");this._setExpressionRelevantOperators(t.getValue(),i,a)}.bind(this)}},enabled:true,change:function(e){var t=e.getSource();var s=t.getBindingContext();var i=s.getProperty("Id");var a=s.getModel();var r=s.getProperty("Condition/ValueOnly");var o=t.getValue().replace(/\s*$/,"");t.setValue(o);this._setExpressionRelevantOperators(o,i,r);this._changeColumnStatusToUpdate(s);var n=s.getProperty("Condition/Expression");if(!n){a.setProperty(s.getPath()+"/Condition/FixedOperator","")}}.bind(this)})};sap.rules.ui.DecisionTableSettings.prototype._getExpressionFieldForCondition=function(e){var t;if(this.getExpressionLanguage()){t=this._getExpressionAdvanceColumn(e)}else{t=this._getASTExpressionBasicForCondition(e)}return t};sap.rules.ui.DecisionTableSettings.prototype._getExpressionFieldForPredefined=function(e,t,s,i,a){var r;if(this.getExpressionLanguage()){r=this._getPredefinedExpressionAdvanced(e,t,s,i)}else{r=this._getASTExpressionBasicForPredefined(e,t,s,i,a)}return r};sap.rules.ui.DecisionTableSettings.prototype._getExpressionFromAstNodes=function(e,t){var s=this;var i=sap.ui.getCore().byId(this.getAstExpressionLanguage());var a=i._astBunldeInstance.TermsProvider.TermsProvider;var r="";var o="";var n=[];var l=e.getPath();var u=e.getObject(l);if(u&&u.Type==="CONDITION"){n=u.Condition.ASTNodes?u.Condition.ASTNodes:u.Condition.DecisionTableColumnConditionASTs}else if(u&&u.Type==="RESULT"){n=u.Result.DecisionTableColumnResultASTs}else{n=t}var d=i._astBunldeInstance.ASTUtil;d.clearNodes();n=n&&n.results?n.results:n;if(n&&n.length>0){for(var p in n){this._addNodeObject(n[p])}var t=d.getNodes();r=d.toAstExpressionString(t);if(t&&t.length===1&&t[0].Type==="I"&&t[0].Value&&t[0].Value!==""){r.valueState="Error"}else{r.valueState="None"}}return r};sap.rules.ui.DecisionTableSettings.prototype._getFixedOperatorDataForExpression=function(e,t,s){var i=e?true:false;var a={fixOperatorEnumration:[{key:"",value:"None"}],fixOperatorEnabled:i};var r=[];if(this.getExpressionLanguage()&&i){var o=sap.ui.getCore().byId(this.getExpressionLanguage());var n;if(!t){n=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonExistOp}]}else{n=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp}]}r=o.getSuggestionsByCategories(e,n);for(var l=0;l<r.length;l++){a.fixOperatorEnumration.push({key:r[l].text,value:r[l].text})}}else if(this.getAstExpressionLanguage()&&e&&e!==""){r=s._getSuggestionsForTheGivenInput(e).autoComplete.categories.operators;if(r){if(r.comparision&&r.comparision.length>0){var u=r.comparision;for(var l=0;l<u.length;l++){a.fixOperatorEnumration.push({key:u[l].name,value:u[l].label})}}if(r.logical&&r.logical.length>0){var d=r.logical;for(var l=0;l<d.length;l++){a.fixOperatorEnumration.push({key:d[l].name,value:d[l].label})}}if(r.array&&r.array.length>0){var p=r.array;for(var l=0;l<p.length;l++){a.fixOperatorEnumration.push({key:p[l].name,value:p[l].label})}}if(r.range&&r.range.length>0){var g=r.range;for(var l=0;l<g.length;l++){a.fixOperatorEnumration.push({key:g[l].name,value:g[l].label})}}if(r.miscellaneous&&r.miscellaneous.length>0){var c=r.miscellaneous;for(var l=0;l<c.length;l++){a.fixOperatorEnumration.push({key:c[l].name,value:c[l].label})}}if(r.functional&&r.functional.length>0){var h=r.functional;for(var l=0;l<h.length;l++){a.fixOperatorEnumration.push({key:h[l].name,value:h[l].label})}}}}return a};sap.rules.ui.DecisionTableSettings.prototype._getHitPoliciesData=function(){var e=this.getProperty("hitPolicies");var t=e.length;var s={hitPolicyEnumration:[]};for(var i=0;i<t;i++){s.hitPolicyEnumration.push({key:e[i],text:this.oBundle.getText(e[i])})}s.enabled=t>1?true:false;return s};sap.rules.ui.DecisionTableSettings.prototype._getInputModeEnabled=function(e,t){if(e!==sap.rules.ui.DecisionTableCellFormat.Both||t===false){return false}return true};sap.rules.ui.DecisionTableSettings.prototype._getLatestResultDataObjects=function(e){var t=this;var s=t.getModel().getData();var i=s.ProjectId;var a=t.getModel("settingsModel");var r;if(this.getExpressionLanguage()){r=sap.ui.getCore().byId(this.getExpressionLanguage())}else{r=sap.ui.getCore().byId(this.getAstExpressionLanguage())}var o=new sap.ui.model.odata.v2.ODataModel(r.getModel().sServiceUrl);var n="/DataObjects(VocabularyId='"+i+"',Id='"+e+"')";t._bindPredefinedTable(n,"/ExpandedAttributes");t.oPredefinedTable.setBusyIndicatorDelay(0);return t.oPredefinedTable};sap.rules.ui.DecisionTableSettings.prototype._getMessageByResultUpdates=function(e){var t=this.oBundle.getText("refreshingWillDeleteMsg");var s=this.oBundle.getText("refreshAreyouSureMsg");var i=e.addedColumns.length+e.changedColumns.length+e.removedColumns.length;if(i!=0){var a=function(e){return"'"+e+"'"};var r=e.addedColumns.length==0?"":this.oBundle.getText("columnsWereAdded",e.addedColumns.map(a).toString());var o=e.changedColumns.length==0?"":this.oBundle.getText("columnsWereChanged",e.changedColumns.map(a).toString());var n=e.removedColumns.length==0?"":this.oBundle.getText("columnsWereRemoved",e.removedColumns.map(a).toString());var l=r+o+n+(e.removedColumns.length==0?"":t)+s;this.getModel("settingsModel").setProperty("/refreshButtonEnabled",true,null,true);return l}else{this.getModel("settingsModel").setProperty("/refreshButtonEnabled",false,null,true)}return null};sap.rules.ui.DecisionTableSettings.prototype._getPredefinedExpressionAdvanced=function(e,t,s,i){var a=this;var r="";var o=e.getObject(e.getPath());if(o&&!r){r=o.DataObjectAttributeId?o.DataObjectAttributeId:o.Id}var n=sap.ui.getCore().byId(this.getExpressionLanguage());var l=i?i:sap.rules.ui.ExpressionType.NonComparison;return new g({expressionLanguage:n,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,id:t,type:l,value:s,editable:true,attributeInfo:r,change:function(t){a.expressionControl=t.getSource();this.getModel("settingsModel").setProperty("/resultAttributeChanged",true);this._updateResultAttributeJSON(e,null,a.expressionControl.getValue(),null,false,false,false)}.bind(this)})};sap.rules.ui.DecisionTableSettings.prototype._getResultsData=function(){var e;if(this.getAstExpressionLanguage()){e=sap.ui.getCore().byId(this.getAstExpressionLanguage())}else{e=sap.ui.getCore().byId(this.getExpressionLanguage())}var t=[{id:f.NO_RESULT,name:"",label:""}];t=t.concat(e.getResults());var s={resultsEnumration:t};return s};sap.rules.ui.DecisionTableSettings.prototype._getResultsUpdates=function(e,t){var s=[],i=[],a=[];var r=0,o=0;for(r=0;r<e.length;r++){var n=false;for(o=0;o<t.length;o++){if(t[o].name===e[r].Result.DataObjectAttributeName){n=true;if(t[o].businessDataType!==e[r].Result.BusinessDataType||t[o].name!==e[r].Result.DataObjectAttributeName){a.push(e[r].Result.DataObjectAttributeName)}}}if(!n){i.push(e[r].Result.DataObjectAttributeName)}n=false}for(o=0;o<t.length;o++){var l=false;for(r=0;r<e.length;r++){if(t[o].name===e[r].Result.DataObjectAttributeName){l=true}}if(!l){s.push(t[o].name)}l=false}return{addedColumns:s,changedColumns:a,removedColumns:i}};sap.rules.ui.DecisionTableSettings.prototype._getSelectedVisibilityStatus=function(e){if(e===this.hiddenModeText){return f.KEY_HIDDEN}else{return f.KEY_EDITABLE}};sap.rules.ui.DecisionTableSettings.prototype._initServiceModel=function(){var e=this.getModel("oDataModel");var t=e.sServiceUrl;var s=new sap.ui.model.odata.v2.ODataModel({serviceUrl:t,defaultBindingMode:sap.ui.model.BindingMode.TwoWay});var i=s.getMetaModel();if(i&&i.oMetadata&&i.oMetadata.bLoaded){var a=i.oMetadata.oMetadata.dataServices.schema[0].namespace;var r=a+"."+f.PREDEFINED_RESULT;if(i.oMetadata&&i.oMetadata._entitySetMap&&i.oMetadata._entitySetMap[r]){this.needToRenderPredefinedResultsTable=true}}};sap.rules.ui.DecisionTableSettings.prototype._initSettingsModel=function(){var e={};e.hitPolicy=this._getHitPoliciesData();e.tableData={};e.removeRowEnabled=false;e.cellFormat=this._getCellFormatData();e.accessOptions=this._getCellFormatAcccessOptions();e.updateAllRows=false;e.predefinedResults=[];e.resultDataObjectChanged=false;e.resultAttributeChanged=false;e.refreshButtonClicked=false;e.results=this._getResultsData();this._internalModel=new sap.ui.model.json.JSONModel(e);this.setModel(this._internalModel,"settingsModel");this._initServiceModel()};sap.rules.ui.DecisionTableSettings.prototype._openWarningDialog=function(e,t){var s=new sap.m.Dialog({title:this.oBundle.getText("changeInputModeDialogTitle"),width:"70%",type:"Message",state:"Warning",content:new l({text:this.oBundle.getText("changeInputModeDialogDescription")}),beginButton:new p({text:this.oBundle.getText("okBtn"),press:function(){s.close();s.destroy();this._changeInputMode(true,e,t)}.bind(this)}),endButton:new p({text:this.oBundle.getText("cancelBtn"),press:function(){s.close();s.destroy();this._changeInputMode(false,e,t)}.bind(this)}),afterClose:function(){s.close();s.destroy()}});s.open()};sap.rules.ui.DecisionTableSettings.prototype._predefinedFactory=function(e,t){var s="exp"+e;var i=t.getProperty("Type");var a=[];var r=t.getProperty("DataObjectAttributeLabel")||t.getProperty("Label")||(t.DataObjectAttributeinfo?t.DataObjectAttributeinfo.Label:undefined);var o=t.getProperty("DataObjectAttributeName")||t.getProperty("Name")||(t.DataObjectAttributeinfo?t.DataObjectAttributeinfo.Name:undefined);var n=r?r:o;var l=t.getProperty("DataObjectAttributeId")||t.getProperty("Id")||(t.DataObjectAttributeinfo?t.DataObjectAttributeinfo.Id:undefined);var u;var d=t.getProperty("BusinessDataType");var p;var g=this._internalModel.getProperty("/predefinedResults");var c=this.getModel("settingsModel").getProperty("/resultAttributeSequenceChanged");var h=this._internalModel.getProperty("/resultDataObjectChanged");var b=this._internalModel.getProperty("/refreshButtonClicked");if(h&&!c){this._updateResultAttributeJSON(t,f.EDITABLE,"",[],h,b,c);p=f.EDITABLE;u=""}else if(b||c){var y=g[l];p=y?y.AccessMode:f.EDITABLE;u=y?y.Expression:"";a=y?y.ASTNodes:[];this._updateResultAttributeJSON(t,p,u,a,h,b,c)}else{u=t.getProperty("Expression");var v=t.getProperty("DecisionTableColumnResultASTs");for(var T in v){a.push(t.getProperty("/"+v[T]))}p=t.getProperty("AccessMode");this._updateResultAttributeJSON(t,p,u,a,false,false,false)}var D=this._getSelectedVisibilityStatus(p);return new sap.m.ColumnListItem({visible:true,vAlign:sap.ui.core.VerticalAlign.Middle,cells:[new sap.m.Label({visible:true,design:sap.m.LabelDesign.Standard,text:n,labelFor:s,textAlign:sap.ui.core.TextAlign.Begin,textDirection:sap.ui.core.TextDirection.Inherit}),new sap.m.Select({width:"65%",id:"select"+e,items:{path:"settingsModel>/accessOptions/cellFormatEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>value}"})},selectedKey:D,enabled:true,change:function(e){this._setColumnAccessMode(t,e)}.bind(this)}),this._getExpressionFieldForPredefined(t,s,u,d,a),new sap.ui.layout.HorizontalLayout({content:[new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:"sap-icon://arrow-top",visible:true,press:function(e){this._moveAttributePosition(t,f.UP)}.bind(this)}).setTooltip(this.oBundle.getText("MoveResultAttributeUP")),new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:"sap-icon://arrow-bottom",press:function(e){this._moveAttributePosition(t,f.DOWN)}.bind(this)}).setTooltip(this.oBundle.getText("MoveResultAttributeDown"))]})]})};sap.rules.ui.DecisionTableSettings.prototype._moveAttributePosition=function(e,t){var s=this.getModel("settingsModel");var i=s.getData();var a=this.getModel().getData();var r=a.ProjectId;var o=e.getProperty("DataObjectAttributeId")||e.getProperty("Id")||(e.DataObjectAttributeinfo?e.DataObjectAttributeinfo.Id:undefined);var n=this.getModel().getData().ResultDataObjectId;var l=[];if(this.getModel("settingsModel").getData().resultDataObjectChanged&&!this.getModel("settingsModel").getData().resultAttributeSequenceChanged){this.getModel("settingsModel").attributeSequenceArray=undefined}var l=this.getModel("settingsModel").attributeSequenceArray;if(!l){l=this._getAttributeSequenceArray()}if(l&&l.length>0){var u=l.indexOf(o);var d=-1;if(t===f.UP){d=u===0?0:u-1}else{d=u===l.length?u:u+1}this._internalModel.getProperty("/predefinedResults")[l[u]].SequenceChanged=true;this._internalModel.getProperty("/predefinedResults")[l[u]].NewSequence=d+1;this._internalModel.getProperty("/predefinedResults")[l[d]].SequenceChanged=true;this._internalModel.getProperty("/predefinedResults")[l[d]].NewSequence=u+1;var p=l[d];l[d]=l[u];l[u]=p;this.getModel("settingsModel").attributeSequenceArray=l}this.getModel("settingsModel").setProperty("/resultAttributeSequenceChanged",true);var g="";if(this.getModel("settingsModel").getData().resultDataObjectChanged){var g="/DataObjects(VocabularyId='"+r+"',Id='"+n+"')";this._bindPredefinedTable(g,"/ExpandedAttributes")}else{var g="/DecisionTable/DecisionTableColumns/results";this._bindPredefinedTable(g,"/DecisionTableColumnResults")}this.oPredefinedTable.setBusyIndicatorDelay(0)};sap.rules.ui.DecisionTableSettings.prototype._prepareNewRule=function(){this._updateDecisionTableHeader();this._createDefaultColumn();if(!this.needToRenderPredefinedResultsTable){this._setDefaultResult()}};sap.rules.ui.DecisionTableSettings.prototype._removeColumnFromJsonModel=function(e,t){var s=this.getModel();var i=s.getData();var a=i.DecisionTable.DecisionTableColumns.results;if(!t||t!=="C"){if(!i.DecisionTable.DecisionTableColumns.deleted){i.DecisionTable.DecisionTableColumns.deleted=[]}i.DecisionTable.DecisionTableColumns.deleted.push(a[e-1])}a.splice(e-1,1);for(var r=e-1;r<a.length;r++){a[r].Sequence--;if(a[r].Status&&a[r].Status==="C"){continue}a[r].Status="U"}this._setDisplayModelData(i)};sap.rules.ui.DecisionTableSettings.prototype._ruleResultColumns=function(){var e=this.getModel().oData.DecisionTable.DecisionTableColumns.results;function t(e){return e.Result!=null}return e.filter(t)};sap.rules.ui.DecisionTableSettings.prototype._setColumnAccessMode=function(e,t){this.enableAccessValue=!this.enableAccessValue;var s=t.oSource.sId.split("select")[1];var i="exp"+s;this.expressionControl=sap.ui.getCore().byId(i);this.getModel("settingsModel").setProperty("/resultAttributeChanged",true);var a=t.getSource();var r=a.getSelectedKey();if(this.expressionControl instanceof g){if(r===f.KEY_HIDDEN){this.expressionControl.setValue("");this._updateResultAttributeJSON(e,this.hiddenModeText,null,null,false,false,false)}else{this.expressionControl.setValueStateText("");this.expressionControl.addStyleClass("sapRULExpressionAdvancedResultTable");this._updateResultAttributeJSON(e,this.editableModeText,null,null,false,false,false)}}else{if(r===f.KEY_HIDDEN){this.expressionControl.setValue("");this.expressionControl._input[0].textContent="";var o=this.expressionControl.sId+"-input";var n={expId:o};var l=sap.ui.getCore().getEventBus();l.publish("sap.ui.rules","_onHiddenSelected",n);this._updateResultAttributeJSON(e,f.HIDDEN,null,null,null,false,false,false)}else{this.expressionControl._input[0].classList.remove("sapAstExpressionInputError");this._updateResultAttributeJSON(e,this.editableModeText,null,null,false,false,false)}}this._internalModel.setProperty("/resultAttributeChanged",true)};sap.rules.ui.DecisionTableSettings.prototype._updateApplyBtnActions=function(){if(this._internalModel){var e=this._internalModel.oData.predefinedResults;var t=false;for(var s in e){if(e[s].AccessMode===f.HIDDEN){if(this.getAstExpressionLanguage()&&e[s].ASTExpressionCleared){t=true;break}if(this.getExpressionLanguage()&&(e[s].ASTExpressionCleared||!e[s].Expression)){t=true;break}}}if(t){sap.ui.getCore().byId("ApplyBtn").setEnabled(false)}else{sap.ui.getCore().byId("ApplyBtn").setEnabled(true)}}};sap.rules.ui.DecisionTableSettings.prototype._setDefaultResult=function(){var e=this.getModel();var t=e.getData();var s=this._internalModel.getData().results.resultsEnumration;if(s.length===2){t.ResultDataObjectId=s[1].id;t.ResultDataObjectName=s[1].name;t.ResultDataObjectLabel=s[1].label?s[1].label:s[1].name;t.ResultDataObjectStatus="C"}};sap.rules.ui.DecisionTableSettings.prototype._setDisplayModelData=function(e){this.resultCounter=0;var t=this.getModel();t.setData(e)};sap.rules.ui.DecisionTableSettings.prototype.setExpressionLanguage=function(e){this.setAssociation("expressionLanguage",e,true);this._decisionTableHeaderSettingFormatter.setExpressionLanguage(e)};sap.rules.ui.DecisionTableSettings.prototype._setExpressionRelevantOperators=function(e,t,s,i){var a=this._getFixedOperatorDataForExpression(e,s,i);this._internalModel.setProperty("/tableData/"+t,a,false);this._updateRemoveRowEnabled()};sap.rules.ui.DecisionTableSettings.prototype._tableColumnsFactory=function(e,t){var s=this;var i=t.getProperty("Id");var a=t.getProperty("Sequence");var r=t.getProperty("Label");var o=t.getProperty("Status");var n=t.getProperty("Type");var l=t.getProperty("Condition/FixedOperator");var u=this.getAstExpressionLanguage()?this.astUtil._getCapitalOperatorName(l):l;return new sap.m.ColumnListItem({visible:n===sap.rules.ui.DecisionTableColumn.Condition,cells:[this._getExpressionFieldForCondition(t),new sap.m.Input({value:r,maxLength:f.MAX_LABEL_LENGTH,change:function(e){var s=e.getSource().getValue().trim();var i=e.getSource();var a=t.getModel();a.setProperty(t.getPath()+"/Label",s);this._changeColumnStatusToUpdate(t)}.bind(this)}),new sap.m.Select({width:"100%",showSecondaryValues:true,items:{path:"settingsModel>/tableData/"+i+"/fixOperatorEnumration",template:new sap.ui.core.ListItem({key:"{settingsModel>key}",text:"{settingsModel>key}",additionalText:"{settingsModel>value}"})},selectedKey:u,enabled:"{settingsModel>/tableData/"+i+"/fixOperatorEnabled}",change:function(e){var i=e.getSource();var a=t.getModel();var r=i.getSelectedKey();var o=this.getAstExpressionLanguage()?s.astUtil._getCamelCaseOperatorName(r):r;a.setProperty(t.getPath()+"/Condition/FixedOperator",o);this._changeColumnStatusToUpdate(t)}.bind(this)}),new sap.ui.layout.HorizontalLayout({content:[new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("sys-cancel"),visible:"{settingsModel>/removeRowEnabled}",press:function(e){this._internalModel.setProperty("/tableData",{},true);this._removeColumnFromJsonModel(a,o)}.bind(this)}).setTooltip(this.oBundle.getText("removeColumn")),new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("add"),press:function(e){this._addColumnToJsonModel(a)}.bind(this)}).setTooltip(this.oBundle.getText("addColumn"))]})]}).addStyleClass("sapRULDecisionTableSettingsConditionRow")};sap.rules.ui.DecisionTableSettings.prototype._updateDecisionTableHeader=function(){var e=this.getModel();var t;if(this.getAstExpressionLanguage()){t=sap.ui.getCore().byId(this.getAstExpressionLanguage())}else{t=sap.ui.getCore().byId(this.getExpressionLanguage())}var s=t.getExpressionLanguageVersion();var i=e.getData();i.Type=sap.rules.ui.RuleType.DecisionTable;i.ExpressionLanguageVersion=s};sap.rules.ui.DecisionTableSettings.prototype._updateRefreshFlags=function(e,t,s){this.getModel().getData().needToRefresh=e;this.getModel("settingsModel").setProperty("/refreshButtonEnabled",t,null,true);this.getModel("settingsModel").setProperty("/refreshButtonClicked",s);this._callRefreshResultsFunctionImport()};sap.rules.ui.DecisionTableSettings.prototype._updateRemoveRowEnabled=function(){var e=this.getModel().getProperty("/DecisionTable/DecisionTableColumns/results");var t=0;for(var s=0;s<e.length;s++){if(e[s].Type==="CONDITION"){t++}}var i=t>1;this._internalModel.setProperty("/removeRowEnabled",i,null,true)};sap.rules.ui.DecisionTableSettings.prototype._updateResultAttributeJSON=function(e,t,s,i,a,r,o){var n=e.getProperty("DataObjectAttributeId")||e.getProperty("Id")||(e.DataObjectAttributeinfo?e.DataObjectAttributeinfo.Id:undefined);var l="/predefinedResults/"+n;if(this.getModel("settingsModel").attributeSequenceArray){this._internalModel.setProperty(l+"/AttributeSequence",parseInt(this.getModel("settingsModel").attributeSequenceArray.indexOf(n))+1)}if(this._internalModel.getProperty("/predefinedResults")){var u=[];if(this._internalModel.getProperty(l)){if(o){this._internalModel.setProperty(l+"/updateAttributeSequence",true);u=this._internalModel.getProperty(l).ASTNodes}if(a){this._internalModel.setProperty(l+"/AccessMode",f.EDITABLE);this._internalModel.setProperty(l+"/Expression","");this._internalModel.setProperty(l+"/ASTNodes",u);this._internalModel.setProperty(l+"/updatePredefinedResults",true)}if(r){var d=this._internalModel.getProperty(l);this._internalModel.setProperty(l+"/isAttributeinBackend",true);this._internalModel.setProperty(l+"/AccessMode",t);this._internalModel.setProperty(l+"/Expression",s);this._internalModel.setProperty(l+"/ASTNodes",i);this._internalModel.setProperty(l+"/updatePredefinedResults",true)}if(!a&&!r&&t){if(this._internalModel.getProperty(l+"/AccessMode")!==t){this._internalModel.setProperty(l+"/AccessMode",t);this._internalModel.setProperty(l+"/updatePredefinedResults",true);if(t===f.HIDDEN){this._internalModel.setProperty(l+"/ASTExpressionCleared",true)}}}if(!a&&!r&&(s||s==="")){this._internalModel.setProperty(l+"/Expression",s);this._internalModel.setProperty(l+"/updatePredefinedResults",true)}if(!a&&!r&&i&&!o){this._internalModel.setProperty(l+"/ASTNodes",i);this._internalModel.setProperty(l+"/updatePredefinedResults",true);var p=this._internalModel.getProperty(l+"/AccessMode");var g=this._internalModel.getProperty(l+"/ASTExpressionCleared");var c=i.length;if(p===f.HIDDEN&&g){if(this.getAstExpressionLanguage()&&c>0){this._internalModel.setProperty(l+"/ASTExpressionCleared",false)}}}if(this.getExpressionLanguage()&&!a&&!r){this._internalModel.setProperty(l+"/updatePredefinedResults",true);var p=this._internalModel.getProperty(l+"/AccessMode");var g=this._internalModel.getProperty(l+"/ASTExpressionCleared");if(p===f.HIDDEN&&g&&s){this._internalModel.setProperty(l+"/ASTExpressionCleared",false)}}}else{this._internalModel.setProperty(l,e.getObject(e.sPath));if(e.getObject(e.sPath).Result){this._internalModel.setProperty(l,e.getObject(e.sPath).Result)}this._internalModel.setProperty(l+"/ASTNodes",i);if(a){this._internalModel.setProperty(l+"/AccessMode",f.EDITABLE);this._internalModel.setProperty(l+"/Expression","");this._internalModel.setProperty(l+"/ASTNodes",[])}if(r){this._internalModel.setProperty(l+"/AccessMode",t);this._internalModel.setProperty(l+"/Expression",s);this._internalModel.setProperty(l+"/ASTNodes",i);this._internalModel.setProperty(l+"/isAttributeinBackend",true)}}}if(this.expressionControl&&l&&this._internalModel.getProperty(l+"/AccessMode")===f.HIDDEN){var i=this._internalModel.getProperty(l+"/ASTNodes");if(this.getAstExpressionLanguage()&&i&&i.length>0){if(i[0].Type==="I"&&i[0].Value!==""){this.expressionControl.setValueStateText(this.oBundle.getText("PredefinedResultsValueStateText"))}else{this.expressionControl.setValueStateText("")}}else if(this.getExpressionLanguage()){if(!s){this.expressionControl.setValueStateText("")}else if(s&&this.expressionControl.getValueStateText()){this.expressionControl.setValueStateText(this.oBundle.getText("PredefinedResultsValueStateText"))}else{this.expressionControl.setValueStateText("")}}}else if(this.expressionControl&&l&&this._internalModel.getProperty(l+"/AccessMode")===f.EDITABLE){this.expressionControl.setValueStateText("")}};sap.rules.ui.DecisionTableSettings.prototype.getButtons=function(e){var t=[];var s=new p({text:this.oBundle.getText("cancelBtn")}).setTooltip(this.oBundle.getText("cancelBtnTooltip"));s.attachPress(function(){e.close()},this);var i=sap.ui.getCore().byId("ApplyBtn");if(!i){i=new p({text:this.oBundle.getText("applyChangesBtn"),id:"ApplyBtn"}).setTooltip(this.oBundle.getText("applyChangesBtnTooltip"))}i.attachPress(function(){if(!this._applyButtonPressed){sap.ui.core.BusyIndicator.show();this.multiHeaderFlag=false;this._applySettingsModelChangesToOData(e);this._applyButtonPressed=true}},this);t.push(i);t.push(s);return t};sap.rules.ui.DecisionTableSettings.prototype.init=function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.editableModeText=f.EDITABLE;this.hiddenModeText=f.HIDDEN;this.needCreateLayout=true;this.firstLoad=true;this.resultCounter=0;this.enableAccessValue=false;this.needToRenderPredefinedResultsTable=false;this.attributeListEmpty=false;this.astUtil=new v;this._applyButtonPressed=false;this.onsapescape=function(e){e.stopPropagation()};this._decisionTableHeaderSettingFormatter=new h;this.setBusyIndicatorDelay(0);this._destroyElement("idPredefinedTable");this._destroyElement("id_HiddenAccessMessageStrip");this._destroyElement("id_EditableAccessMessageStrip")};sap.rules.ui.DecisionTableSettings.prototype.onBeforeRendering=function(){this.mNextColumnId=this._calcNextColumnId();if(this.firstLoad){this._initSettingsModel();if(this.getProperty("newDecisionTable")===true){this.mNextColumnId=1;this._prepareNewRule()}this.firstLoad=false}if(this.needCreateLayout){var e=this.getAggregation("mainLayout");if(e){e.destroy()}e=this._createLayout();this.setAggregation("mainLayout",e,true);this.needCreateLayout=false;this.conditionsTable.getBinding("items").attachDataRequested(function(){this.setBusy(true)}.bind(this));this.conditionsTable.getBinding("items").attachDataReceived(function(){this.setBusy(false)}.bind(this))}};sap.rules.ui.DecisionTableSettings.prototype._formatAttributeId=function(e){var t=e;if(t&&t.indexOf(":")>-1){t=t.replace(/:/g,"/")}return t};sap.rules.ui.DecisionTableSettings.prototype._applySettingsModelChangesToOData=function(e){var t=this;var s;if(this.getExpressionLanguage()){s=sap.ui.getCore().byId(this.getExpressionLanguage())}else{s=sap.ui.getCore().byId(this.getAstExpressionLanguage())}var i=this.mNextColumnId;var a=this.getModel();var r=this.getModel("oDataModel");var n=this.getModel("dtModel");var l=this.getModel("settingsModel");var u=this.getBindingContext("dummy");var d=u.getProperty("Id");var p=u.getProperty("Version");var g=a.oData.DecisionTable.HitPolicy;var c=l.getProperty("/resultDataObjectChanged");var h=l.getProperty("/resultAttributeChanged");var b=l.getProperty("/resultAttributeSequenceChanged");var y=l.getProperty("/refreshButtonClicked");var v=this.getProperty("newDecisionTable");var T=[];var D={groupId:"changes"};var m=false;var S=false;var C=function(){var e={};e.groupId=D.groupId;var t={RuleId:d,Version:p,HitPolicy:g};var s="/DecisionTables(Version='"+p+"',RuleId='"+d+"')";r.update(s,t,e)};var x=function(e){var t={};var s={RuleId:d,Version:p,Sequence:1,Id:1};t.properties=s;r.createEntry("/DecisionTableRows",t)};var M=function(e){r.callFunction("/SetRuleResultDataObject",{method:"POST",groupId:D.groupId,urlParameters:{RuleId:d,ResultDataObjectId:e!==f.NO_RESULT?e:""}})};var I=function(e){var s=l.oData.predefinedResults;if(s){var i;for(i in s){if(s[i].updatePredefinedResults||s[i].updateAttributeSequence){m=true;var a=i.replace(/:/g,"%3A");var o="/PredefinedResults(RuleId='"+d+"',DataObjectAttributeId='"+a+"')";var n={AccessMode:s[i].AccessMode,Type:"DT"};var u={groupId:D.groupId};if(t.getAstExpressionLanguage()&&s[i].ASTNodes){var g=s[i].Id;if(c||y){for(var f in T){if(T[f].Type==="RESULT"&&T[f].Result.DataObjectAttributeId===i){g=T[f].Result.Id;break}}}var b="/DecisionTableColumnResults(RuleId='"+d+"',Version='"+p+"',Id="+g+")";var v={BusinessDataType:s[i].BusinessDataType};if(s[i].updatePredefinedResults){r.update(b,v,u);B(g,"/DeleteDTColResultASTDraft");O(s[i].ASTNodes,"/DecisionTableColumnResultASTs",g)}}else{n.Expression=s[i].Expression}if(s[i].SequenceChanged){n.Sequence=s[i].AttributeSequence}if(h||s[i].SequenceChanged){r.update(o,n,u)}}}if(!s){m=false}}};var P=function(){r.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:D.groupId,urlParameters:{RuleId:d}})};var R=function(e,t){var s={};if(!t.getProperty("DecisionTable")){var i={RuleId:d,Version:p,HitPolicy:g};s.properties=i;r.createEntry("/DecisionTables",s)}else{C()}x()};var A=function(e,t,s){var i={};var a={RuleId:e.RuleId,Version:e.Version,Id:e.Id,Type:sap.rules.ui.DecisionTableColumn.Condition,Sequence:t,Label:s};i.properties=a;r.createEntry("/DecisionTableColumns",i);i.properties=e;r.createEntry("/DecisionTableColumnConditions",i)};var E=function(e){var t="/DecisionTableColumns(RuleId='"+d+"',Version='"+p+"',Id="+e+")";B(e,"/DeleteDTColConditionASTDraft");r.remove(t,D)};var _=function(e){var t;var s=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");for(var i=0;i<e.length;i++){t=e[i];if(t.Condition.Expression===""){o.error(s.getText("emptyConditionError"));S=true;return false}else{return true}}};var O=function(e,t,s){for(var i in e){e[i].Id=s;var a={};if(e[i].Type==="I"){e[i].IncompleteExpression=e[i].Value}a.properties=e[i];a.groupId="changes";r.createEntry(t,a)}};var B=function(e,t){var s={};s.Id=e;s.RuleId=d;s.Version=p;r.callFunction(t,{method:"POST",groupId:"changes",urlParameters:s})};var L=function(e,s,i){var a="/DecisionTableColumns(RuleId='"+d+"',Version='"+p+"',Id=ID_PROPERTY)";var o="/DecisionTableColumnConditions(Version='"+p+"',RuleId='"+d+"',Id=ID_PROPERTY)";var n="/DecisionTableColumnResults(Version='"+p+"',RuleId='"+d+"',Id=ID_PROPERTY)";var l;var u="";var g="";var c={};for(var h=0;h<e.length;h++){var f=[];l=e[h];if(l.Status){var b;var y;if(l.Condition&&l.Condition.parserResults){b=l.Condition.parserResults.converted&&l.Condition.parserResults.converted.Expression?l.Condition.parserResults.converted.Expression:l.Condition.Expression;y=l.Condition.parserResults.converted&&l.Condition.parserResults.converted.FixedOperator?l.Condition.parserResults.converted.FixedOperator:l.Condition.FixedOperator}m=true;if(l.Status==="U"){if(!(l.Result&&s)){u=l.Id;var v={Sequence:l.Sequence,Label:l.Label};var T=a.replace("ID_PROPERTY",u);if(l.Label){r.update(T,v,D)}}if(l.Condition){g=o.replace("ID_PROPERTY",u);var S=l.Condition.ValueOnly;c={Id:u,Expression:b?b:l.Condition.Expression,FixedOperator:y?y:l.Condition.FixedOperator,ValueOnly:S};r.update(g,c,D);if(t.getAstExpressionLanguage()&&i[h].Condition.ASTNodes){B(u,"/DeleteDTColConditionASTDraft");O(i[h].Condition.ASTNodes,"/DecisionTableColumnConditionASTs",u)}}}else if(l.Status==="C"){var C={};var x=l.Condition;C.Expression=b?b:l.Condition.Expression;C.FixedOperator=y?y:x.FixedOperator;C.RuleId=x.RuleId;C.Id=x.Id;C.Version=x.Version;delete C.parserResults;A(C,l.Sequence,l.Label);if(t.getAstExpressionLanguage()){O(i[h].Condition.ASTNodes,"/DecisionTableColumnConditionASTs",C.Id)}}}}};var w=function(e){if(!e){return}m=true;for(var t=0;t<e.length;t++){var s=e[t];E(s.Id)}};var N=function(){var s=[n.getProperty("/ruleBindingPath"),"/DecisionTable/DecisionTableColumns"].join("");var i="Condition,Result";if(t.getAstExpressionLanguage()){i="Condition/DecisionTableColumnConditionASTs,Result/DecisionTableColumnResultASTs"}var a={urlParameters:{$expand:i},success:function(t){r.setDeferredGroups([D.groupId]);T=t.results;U(true);if(m){r.submitChanges({groupId:D.groupId,success:function(){sap.ui.core.BusyIndicator.hide();e.setState(sap.ui.core.ValueState.Success);e.close();return}})}else{sap.ui.core.BusyIndicator.hide();e.setState(sap.ui.core.ValueState.Success);e.close()}}};r.read(s,a)};var V=function(s){var i=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");var a=false;sap.ui.core.BusyIndicator.hide();var r=s.__batchResponses["0"].__changeResponses;for(var n in r){if(r[n].message){var l=r[n].response.body;o.error(l,{title:i.getText("RequestFailedText"),actions:[sap.m.MessageBox.Action.OK]});e.setState(sap.ui.core.ValueState.Error);a=true}}if((!a||!m)&&e.isOpen()){m=false;if(c){N()}else{sap.ui.core.BusyIndicator.hide();e.setState(sap.ui.core.ValueState.Success);e.close()}}if(!a){sap.m.MessageToast.show(t.oBundle.getText("settingsApplySuccess"))}};var F=function(e){var t={};t.groupId=D.groupId;var o=a.getData();var n=o.ResultDataObjectName;var l=s.getResultInfo(n);var u=l?l.requiredParams:[];var g=u.length;for(var c=0;c<g;c++){var h={RuleId:d,Version:p,Id:i,Type:sap.rules.ui.DecisionTableColumn.Result,Sequence:e};t.properties=h;r.createEntry("/DecisionTableColumns",t);var f={RuleId:d,Version:p,Id:i,DataObjectAttributeName:u[c].name,DataObjectAttributeId:u[c].paramId,BusinessDataType:u[c].businessDataType};i++;e++;t.properties=f;r.createEntry("/DecisionTableColumnResults",t)}};var j;var q;if(this.getExpressionLanguage()){j=s.convertRuleToCodeValues(a.oData);q=j.output.decisionTableData.DecisionTable.DecisionTableColumns.results}else{q=a.oData.DecisionTable.DecisionTableColumns.results}r.setDeferredGroups([D.groupId]);w(a.oData.DecisionTable.DecisionTableColumns.deleted);var k=a.oData.DecisionTable.DecisionTableColumns.results;L(q,c,k);if(y){this._findAndRemoveDeletedAttributeFromOModel()}var U=function(e){if(h||b){I()}var t=a.oData.needToRefresh;if(t){m=true;P()}if(v){m=true;R(q.length,u)}else if(a.oData.DecisionTable.HitPolicyStatus==="U"){m=true;C(d,p,g,D)}if(v&&!e){F(q.length+1)}};if(c){m=true;M(a.oData.ResultDataObjectId)}else if(y){N()}else{U(false)}var H={};H.success=V;H.groupId=D.groupId;if(m){r.submitChanges(H)}if(y&&this.attributeListEmpty){e.setState(sap.ui.core.ValueState.Success);sap.ui.core.BusyIndicator.hide();e.close();sap.m.MessageToast.show(this.oBundle.getText("settingsApplySuccess"));return}if(!m&&!c&&!y&&!h){e.setState(sap.ui.core.ValueState.Success);sap.ui.core.BusyIndicator.hide();e.close();sap.m.MessageToast.show(this.oBundle.getText("settingsApplySuccess"))}};return D},true);
//# sourceMappingURL=DecisionTableSettings.js.map
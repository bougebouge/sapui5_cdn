/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/rules/ui/Utils","sap/rules/ui/AstExpressionBasic","sap/rules/ui/Constants","./DecisionTableCellAstExpressionBasicRenderer"],function(jQuery,e,t,i,s,a){"use strict";var o=i.extend("sap.rules.ui.DecisionTableCellAstExpressionBasic",{metadata:{library:"sap.rules.ui",properties:{headerValue:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperator:{type:"string",defaultValue:"",bindable:"bindable"},type:{type:"sap.rules.ui.ExpressionType",defaultValue:sap.rules.ui.ExpressionType.BooleanEnhanced,bindable:"bindable"}}},renderer:a});o.prototype.validateExpression=function(){var e=this.getValue();if(e){var t=this.getHeaderValue()+" "+this.getFixedOperator()+" "+e}else{this.setValueStateText("")}};o.prototype.init=function(){sap.rules.ui.AstExpressionBasic.prototype.init.apply(this,arguments);this.bFlagForChangeBeforeBlur=false;this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n")};o.prototype.onAfterRendering=function(){var e=this;this._oAstExpressionLanguage=sap.ui.getCore().byId(this.getAstExpressionLanguage());sap.rules.ui.AstExpressionBasic.prototype.onAfterRendering.apply(this,arguments);this.oDecisionTableCell=this.getParent()&&this.getParent().getParent()?this.getParent().getParent():null;this._handleValidation();if(jQuery.sap.byId(this.getId()).closest("td").next().width()){this._showPopUp()}if(this.oDecisionTableCell){this.markerString=this.oDecisionTableCell._getMarkerString().trim();var t=this.oDecisionTableCell.getValueStatePath();var i=this.oDecisionTableCell.getModel("dtModel");var s=this.oDecisionTableCell.getAggregation("_displayedControl");if(s){i.setProperty(t.slice(8),sap.ui.core.ValueState.None)}}};o.prototype._handleValidation=function(){this.validateExpression()};o.prototype.exit=function(){this._handleValidation();if(this.bFocusCellAfterEscape&&this.oDecisionTableCell){var e=this.oDecisionTableCell.getDomRef().parentElement.parentElement;if(e){jQuery(e).focus()}}};o.prototype.createEventListeners=function(){};o.prototype._updateModelAstNodes=function(e,t){if(this.oDecisionTableCell){var i=t.ASTNodes;for(var s in i){var a={};if(i[s].Root){a.Sequence=1;a.Root=true}else{a.Sequence=i[s].SequenceNumber;a.ParentId=i[s].ParentId}if(i[s].Function){a.Function=i[s].Function?i[s].Function:""}if(i[s].Type==="I"){a.IncompleteExpression=i[s].Value}if(i[s].Type!=="P"&&i[s].Type!=="O"&&!i[s].Function){a.BusinessDataType=i[s].Output?i[s].Output.BusinessDataType:i[s].BusinessDataType;a.DataObjectType=i[s].Output?i[s].Output.DataObjectType:i[s].DataObjectType;a.Value=i[s].Value?i[s].Value:""}else if(i[s].Type==="O"){a.Reference=i[s].Reference}a.NodeId=i[s].Id;a.Type=i[s].Type;a.RuleId=t.RuleId;a.Version=t.Version;a.ColId=t.ColId;a.RowId=t.RowId;var o={};o.properties=a;o.groupId="changes";e.createEntry("/DecisionTableRowCellASTs",o)}}};o.prototype._removeExistingAstNodes=function(e,t,i,s){if(this.oDecisionTableCell){var a={};a.ColId=t.ColId;a.RowId=t.RowId;a.RuleId=t.RuleId;a.Version=t.Version;var o;var r=[];var n;if(s&&s.length>0){for(var l=0;l<s.length;l++){o={};o.ColId=t.ColId;o.RowId=t.RowId;o.RuleId=t.RuleId;o.Version=t.Version;o.NodeId=s[l].Id;n=e.createKey("DecisionTableRowCellASTs",o);r.push(n)}}if(i&&e.getProperty(i)&&"DecisionTableRowCellASTs"in e.getProperty(i)&&e.getProperty(i).DecisionTableRowCellASTs&&"__list"in e.getProperty(i).DecisionTableRowCellASTs){e.getProperty(i).DecisionTableRowCellASTs.__list=r}e.callFunction("/DeleteDTRowCellASTDraft",{method:"POST",groupId:"changes",urlParameters:a})}};o.prototype._checkEmptyMarkerNode=function(e){if(e&&e.length===1&&(e[0].Type==="I"&&(e[0].Value===""||e[0].Value===this.markerString)||e[0].Type==="M")){return false}return true};o.prototype._removeAndUpdateExisitingNodes=function(e,t,i,s,a){e.setDeferredGroups(["changes"]);var o=sap.ui.getCore().getEventBus();e.update(i,{Content:e.getProperty(a)},{groupId:"changes",success:function(e){o.publish("sap.ui.rules","astCreated")}});this._removeExistingAstNodes(e,t,i,s);if(this._checkEmptyMarkerNode(s)){this._updateModelAstNodes(e,t)}e.submitChanges({groupId:"changes"})};o.prototype._changeValue=function(e){var t={};if(this.oDecisionTableCell){var i=e.getSource();var s=sap.ui.getCore().getEventBus();var a=e.getParameter("newValue");i.setValue(a);var o=this.oDecisionTableCell.getAggregation("_displayedControl");o.setValue(e.getParameter("displayText"));o.JSON=this.getJsonData();o.relString=this.relString;var r=sap.ui.getCore().byId(this.getAstExpressionLanguage());var n=this.getBindingContext().getModel();t=this.oDecisionTableCell.getKeyProperties();var l=e.getParameter("astNodes");if(l&&l.length===1&&l[0].Type==="I"&&l[0].Value!==""&&l[0].Value!==this.markerString){o.setValueState("Error");o.setTooltip(this.oBundle.getText("invalidExpression"))}else{o.setValueState("None")}t.ASTNodes=l;var u=this.oDecisionTableCell.getValuePath();var p="/"+u.split("/")[1];s.publish("sap.ui.rules","astCreating");if(!n.hasPendingChanges()){this._removeAndUpdateExisitingNodes(n,t,p,l,u)}}};return o},true);
//# sourceMappingURL=DecisionTableCellAstExpressionBasic.js.map
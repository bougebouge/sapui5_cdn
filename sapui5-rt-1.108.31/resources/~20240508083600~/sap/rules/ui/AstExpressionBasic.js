sap.ui.define(["sap/base/Log","sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","sap/m/ResponsivePopover","sap/m/List","sap/ui/model/json/JSONModel","sap/m/ListMode","sap/m/PlacementType","sap/m/StandardListItem","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/rules/ui/parser/infrastructure/util/utilsBase","sap/rules/ui/services/AstExpressionLanguage","sap/rules/ui/ExpressionAdvanced","sap/rules/ui/AutoCompleteSuggestionContent","sap/rules/ui/ExpressionBase","sap/rules/ui/ast/constants/Constants","sap/rules/ui/ast/util/AggregateFunctionDialog","sap/rules/ui/ast/util/SelectFunctionDialog","sap/rules/ui/ast/provider/TermsProvider","sap/rules/ui/ast/parser/bundlelibrary","sap/ui/core/LocaleData","sap/rules/ui/ast/util/LoopFunctionDialog","./AstExpressionBasicRenderer"],function(e,jQuery,t,i,s,n,r,o,a,l,u,c,h,d,g,p,f,_,S,T,b,x,v,C,A){"use strict";var O=f.extend("sap.rules.ui.AstExpressionBasic",{metadata:{properties:{library:"sap.rules.ui",value:{type:"string",defaultValue:""},dataObjectInfo:{type:"string",bindable:"bindable",defaultValue:""},resultDataObjectId:{type:"string",defaultValue:""},conditionContext:{type:"boolean",defaultValue:false},operationsContext:{type:"boolean",defaultValue:false},jsonData:{type:"array",bindable:"bindable",defaultValue:[]},enableAggregateFunctionVocabulary:{type:"boolean",defaultValue:false},enableAggregateFunctionWhereClause:{type:"boolean",defaultValue:false},isAttributeContext:{type:"boolean",defaultValue:false},placeholder:{type:"string",defaultValue:""},isAssociationContext:{type:"boolean",defaultValue:false},isReferenceContext:{type:"boolean",defaultValue:false},enableAggregateFunctionAttribute:{type:"boolean",defaultValue:false}},aggregations:{},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},ariaHasPopup:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaHasPopup"}},events:{change:{},liveChange:{}}},init:function(){this.infraUtils=new sap.rules.ui.parser.infrastructure.util.utilsBase.utilsBaseLib;this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.aggregateFunctionCallBack=jQuery.proxy(this._updateAggregateFunction,this);this.functionCallBack=jQuery.proxy(this._updateSelectFunction,this);this.loopFunctionCallBack=jQuery.proxy(this._updateLoopFunction,this);this._reference=jQuery.proxy(this.callback,this);this._isDialogOpenedCallbackReference=jQuery.proxy(this.isDialogOpenedCallback,this);this._uiModel=[];this._cursorPostion=0;this._selectedSpans=null;this._hasTextContent=false;this._createPopver();this._attributeContext=false;this._bCtrlSpacePressed=false;this.bShiftPressed=false;this.shiftKey="";this.isDialogOpen=false;this._focusedOut=false;this._jsonArray=[];this.functionClicked=false;this.isAutoSuggestionRequired=true;this.isDotRequired=true;this.aggregateFunctionDialog=S.getInstance();this.selectFunctionDialog=T.getInstance();this.loopFunctionDialog=C.getInstance();this.astLibInstance=x.getInstance();this.bTypingFlow=false;this.bEditInBetween=false;this.nIndexOfToken=0;this.tempRelString="";this.filterText="";this.filterTextLength=0;var e=sap.ui.getCore().getEventBus();e.subscribeOnce("sap.ui.rules","_onHiddenSelected",this._hiddenAccessModeSelected,this)},onBeforeRendering:function(){this._enableAggregateFunctionVocabulary=this.getEnableAggregateFunctionVocabulary();this._enableAggregateFunctionWhereClause=this.getEnableAggregateFunctionWhereClause();this._ariaLabelledById=this.getAriaLabelledBy();this._enableAggregateFunctionAttribute=this.getEnableAggregateFunctionAttribute()},callback:function(e,t){this._setTextOnCursorPosition(e)},isDialogOpenedCallback:function(e){this.isDialogOpen=e;if(!e){this.functionClicked=false}},onAfterRendering:function(){this.referenceId="";this.isAutoSuggestionRequired=true;this.dotInOperationsContext=false;this._oAstExpressionLanguage=sap.ui.getCore().byId(this.getAstExpressionLanguage());this._input=this.$("input");this._validateControl();this._input[0].contentEditable=this.getEditable();this._input[0].classList.add("sapAstExpressionInput");if(!this.getEditable()){this._input[0].classList.add("sapAstExpressionInputNotEditable")}else{this._input[0].classList.remove("sapAstExpressionInputNotEditable")}if(this.aCustomStyleClasses&&this.aCustomStyleClasses.length>0){this._input[0].classList.add(this.aCustomStyleClasses[0])}if(this.getJsonData()){this._jsonArray=this.getJsonData()}if(this.getValue()&&this.getValue().trim()){var e=this.markerString?this.markerString.trim():"";if(e===this.getValue()){this.setValue("")}this._uiModel=this._convertInputToUiModel(this.getValue());this._uiModelToSpan(this._uiModel);this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1]);if(!this.bTypingFlow&&this._selectedSpans[0]&&!this._selectedSpans[0].textContent.endsWith(_.DOT)&&this._selectedSpans[0].getAttribute(_.TOKEN_TYPE)!==_.WS&&this._selectedSpans[0].getAttribute(_.TOKEN_TYPE)!==_.UNDEFINED&&!this.dotInOperationsContext&&!(this._enableAggregateFunctionVocabulary&&this._jsonArray.length===0)&&!this._isFirstTokenUpdateOrAppendOperation()){this._createSpaceSpanItem()}this.bTypingFlow=false;if(!this.dataObjectInfo&&this.getIsAttributeContext()){this.dataObjectInfo=this.getDataObjectInfo()+(this.relString?this.relString.replace(".",""):"")}if(!this.dataObjectInfo){this.dataObjectInfo=this.getDataObjectInfo()+this.relString}this._hasTextContent=true}else{this.relString="";this._uiModel=[];this._uiModelToSpan(this._uiModel);this.dataObjectInfo=""}this._cursorPostion=this._getCaretPosition();this._setCurrentCursorPosition(this._cursorPostion);this._setUpEventHandlers();if(this._ariaLabelledById){this._input[0].setAttribute("aria-labelledby",this._ariaLabelledById+" "+this._input[0].id)}this._input[0].setAttribute("aria-haspopup","list");this._input[0].setAttribute("aria-label",this._input[0].textContent)},_convertInputToUiModel:function(t){if(t){this.astNodesString=this._oAstExpressionLanguage.getAstNodesString(t);this.relString=this._oAstExpressionLanguage.getRelStringForGivenAstString(this.astNodesString).relString;this._tokens=this._oAstExpressionLanguage.getTokensForGivenStringInput(t);try{this.astresponseNodes=JSON.parse(this.astNodesString)}catch(t){e.error("Error in parsing string to JSON: "+t.message)}if(this.astresponseNodes&&this.astresponseNodes[0]&&(this.astresponseNodes[0].Function||this.astresponseNodes[0].Type&&this.astresponseNodes[0].Type!=="I")){this.displayString=this._oAstExpressionLanguage._astBunldeInstance.ASTUtil.toAstExpressionString(astNodes);this._jsonArray=this.displayString.JSON}return this._oAstExpressionLanguage.convertTokensToUiModel(this._tokens,this._jsonArray)}return[]},_generateIDStringFromUIModel:function(){var e="";for(var t in this._uiModel){if(this._uiModel[t].reference!==null){if(this._uiModel[t].text.length>0){e=e+this._uiModel[t].reference}}else{e=e+this._uiModel[t].text}}return e},_getSuggestionsForTheGivenInput:function(e){var t=this._attributeContext;var i=false;var s=false;var n=this.getIsAssociationContext();var r=this.getIsReferenceContext();if(this.getDataObjectInfo()&&!this.functionClicked&&!this.bEditInBetween){e=this.dataObjectInfo}if(this.getHeaderInfo()&&this.getHeaderInfo().headerValue){e=this.getHeaderInfo().headerValue+" "+e}if(this.getAttributeInfo()&&e===""){e=this.getAttributeInfo()+" "+_.EQUAL+" "}if(!this._oAstExpressionLanguage){this._oAstExpressionLanguage=sap.ui.getCore().byId(this.getAstExpressionLanguage())}if(this.getDataObjectInfo()&&this.getIsAttributeContext()){t=this.getIsAttributeContext();e=e.replace(/\./g,"")}if(this._enableAggregateFunctionVocabulary){t=false;n=true;r=true}if(this.getOperationsContext()&&!this._enableAggregateFunctionVocabulary){i=true}if(this.getOperationsContext()&&e!==""){if(this.dotInOperationsContext&&this._selectedSpans[0]&&this._selectedSpans[0].textContent.endsWith(_.DOT)){t=true}else if(this._isFirstTokenUpdateOrAppendOperation()&&this._selectedSpans[0].textContent===" "+_.DOT){t=true;e=e.trim()}else if(!t){t=false;s=this._addDotToMiscellaneousSuggestions()}}var o=this._oAstExpressionLanguage.getTokensForGivenStringInput(e);var a=this._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(o);var l={};l.AttributeContext=t;l.OperationsContext=i;l.AssociationContext=n;l.ReferenceContext=r;var u=this._filterSuggestionBasedOnCardinality(a,l);if(s){var c={name:_.DOT,label:this.oBundle.getText("DOTLABEL")};u.autoComplete.categories.operators=u.autoComplete.categories.operators?u.autoComplete.categories.operators:{};var h=u.autoComplete.categories.operators;if(!("miscellaneous"in h)){h.miscellaneous=[]}h.miscellaneous.push(c)}u.autoComplete.businessDataTypeList=u.businessDataTypeList;if(this._enableAggregateFunctionVocabulary&&u&&u.autoComplete&&u.autoComplete.categories&&u.autoComplete.categories.terms&&u.autoComplete.categories.terms.length===0){this._oAutoSuggestionPopUp.close()}return u},_filterSuggestionBasedOnCardinality:function(e,t){var i=this._oAstExpressionLanguage.getSuggesstions(e,t);if((this._enableAggregateFunctionAttribute||this._enableAggregateFunctionWhereClause)&&i&&i.autoComplete&&i.autoComplete.categories&&i.autoComplete.categories.terms){for(var s=0;s<i.autoComplete.categories.terms.length;s++){if(i.autoComplete.categories.terms[s].cardinality&&i.autoComplete.categories.terms[s].cardinality===_.ONE_TO_N||i.autoComplete.categories.terms[s].type&&i.autoComplete.categories.terms[s].type==="R"&&i.autoComplete.categories.terms[s].isDataObjectTable){i.autoComplete.categories.terms.splice(s,1)}}}return i},_getSuggestionsForEditedInput:function(e){this.tempRelString=this._cursorPostion===0?"":this._calculateStringAndIndexOfNewToken();if(this._enableAggregateFunctionWhereClause){this.tempRelString=this.getDataObjectInfo()+this.tempRelString}var t=this._oAstExpressionLanguage.getTokensForGivenStringInput(this.tempRelString);var i=this._getStringForFilterAndTempRelString(t);this._suggestionsList=this._getSuggestionsForTheGivenInput(i.tempRelString);if(e){var s=i.filterText;var n=this._filterSuggestionList(s);if(n.hasSuggestions){this._suggestionsList=n}}if(!e&&i.filterText){var r=this._getTermIdForTheGivenText(i.filterText);var o=i.tempRelString+r;this._suggestionsList=this._getSuggestionsForTheGivenInput(o)}},_addDotToMiscellaneousSuggestions:function(){if(this.relString&&this.relString.trim().toUpperCase().indexOf(_.UPDATE)===0){var e=this._uiModel.length;var t=this._uiModel[e-1];if(this.bEditInBetween&&this.nIndexOfToken){t=this._uiModel[this.nIndexOfToken]}var i=t.dataObjectType;var s=t.getReference();var n=s?s.split("/"):[];if(!s){return false}if(i===_.ASSOCIATIONDOTYPE||i===_.REFERENCEDOTYPE){return true}else if(n&&n.length>2){return false}else{s=n[1];s=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(s);if(s&&s._isDataObjectElement){return false}else{return true}}}return false},_constructExpandedRelString:function(e){var t="";if(e.function===_.AVG||e.function===_.SUM||e.function===_.MIN||e.function===_.MAX){t=typeof e.vocabulary==="string"||e.vocabulary instanceof String?e.attribute:this._fetchAttributesSelectFunction(e);return e.function+"("+this.getTable(e)+","+t+this.getGroupByAttributes(e.groupBy)+")"}else if(e.function===_.COUNTDISTINCT||e.function===_.DISTINCT){t=typeof e.vocabulary==="string"||e.vocabulary instanceof String?e.attribute:this._fetchAttributesSelectFunction(e);return e.function+"("+this.getTable(e)+","+t+")"}else if(e.function===_.COUNT){return e.function+"("+this.getTable(e)+this.getGroupByAttributes(e.groupBy)+")"}else if(e.function===_.TOP||e.function===_.BOTTOM||e.function===_.SELECT||e.function===_.FIRST){return this._constructExpandedRelStringForSelect(e)}else if(e.function===_.FOREACH){return e.function+"("+this.getTable(e)+" , "+this._fetchForEachOperations(e.actions)+")"}},_fetchForEachOperations:function(e){var t="";for(var i=0;i<e.length-1;i++){if(e[i]!==""){t=t+e[i]+" , "}}t=t+e[i];return t},_fetchAttributesSelectFunction:function(e){if(this._hasAssociationId(e.vocabulary,e.function)||this._hasReferenceId(e.vocabulary,e.function)){return this._returnAttributeBasedOnType(e.vocabulary)}else if(e.vocabulary.attributes&&Object.keys(e.vocabulary.attributes).length===1){for(var t in e.vocabulary.attributes){return t}}},_getAttributesSelectQuery:function(e){var t=",";var i="";if(e&&!jQuery.isEmptyObject(e.attributes)){for(var s in e.attributes){i+=t+s}}return i},_constructSelectQuery:function(e){var t="";if(e.doVocabId){t=e.doVocabId}else{t=e.dataObject}if(this._getAttributesSelectQuery(e)){return _.SELECT+"("+this._constructSortQuery(e)+this._getAttributesSelectQuery(e)+")"}else if(e.filter){return _.FILTER+"("+t+","+e.filter+")"}else{return t}},_constructSortQuery:function(e){var t="";var i="";if(e.doVocabId){i=e.doVocabId}else{i=e.dataObject}if(!e.filter){t=i}else{t=_.FILTER+"("+i+","+e.filter+")"}if(!jQuery.isEmptyObject(e.attributes)){for(var s in e.attributes){if(e.attributes[s]!==_.NOSORT){t=e.attributes[s]+"("+t+","+s+")"}}}return t},_constructExpandedRelStringForSelect:function(e){if(e.function===_.TOP||e.function===_.BOTTOM){return e.function+"("+this._constructSelectQuery(e)+","+e.count+")"}else if(e.function===_.SELECT){return this._constructSelectQuery(e)}else if(e.function===_.FIRST){return e.function+"("+this._constructSelectQuery(e)+")"}},getTable:function(e){var t=typeof e.vocabulary==="string"||e.vocabulary instanceof String?e.vocabulary:this._getDataObjectInfoBaseOnVocaulary(e);if(!e.filter&&(typeof e.vocabulary==="object"||e.vocabulary instanceof Object)){return this._constructExpandedRelStringForSelect(e.vocabulary)}else if(e.filter&&(typeof e.vocabulary==="object"||e.vocabulary instanceof Object)){return _.FILTER+"("+this._constructExpandedRelStringForSelect(e.vocabulary)+","+e.filter+")"}else if(!e.filter){return t}else{return _.FILTER+"("+t+","+e.filter+")"}},_getDataObjectInfoBaseOnVocaulary:function(e){var t=e.dataObject;if(this._hasAssociationId(e.vocabulary,e.function)||this._hasReferenceId(e.vocabulary,e.function)){t=this._returnDataObjectBasedOnType(e.vocabulary)}return t},_hasAssociationId:function(e,t){var i="";if(typeof e==="object"||e instanceof Object){if(e&&e.attributes){for(var s in e.attributes){i=e.doVocabId+s.replace(_.DOT,"");break}}}if(i){var n=i.split("/");var r=n[1];if(n.length>3){for(var o=2;o<n.length-1;o++){r+=_.DOT+n[o]}}if(this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(r)&&this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(r)._dataObjectType==="AO"){return true}}return false},_hasReferenceId:function(e,t){var i="";if(typeof e==="object"||e instanceof Object){if(e&&e.attributes){for(var s in e.attributes){i=e.doVocabId+s.replace(_.DOT,"");break}}}if(i){var n=i.split("/");var r=n[1];if(n.length>3){for(var o=2;o<n.length-1;o++){r+=_.DOT+n[o]}}if(this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(r)&&this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(r)._dataObjectType==="R"){return true}}return false},_returnAttributeBasedOnType:function(e){var t="";if(typeof e==="object"||e instanceof Object){if(e&&e.attributes){for(var i in e.attributes){t=e.doVocabId+i.replace(_.DOT,"");break}}}if(t){var s=t.split("/");var n=s[1];var r=0;var o;var a="";if(s.length>2){for(var l=2;l<s.length;l++){n+=_.DOT+s[l];o=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(n);if(o&&o._dataObjectType==="AO"&&o._cardinality==="1..n"){r=l}else if(o&&o._dataObjectType==="R"&&o._isDataObjectTable){r=l}}if(r>0){for(var l=r+1;l<s.length;l++){a+="/"+s[l]}}if(r===0){for(var l=2;l<s.length;l++){a+="/"+s[l]}}}if(a){return _.DOT+a}else{return"./"+s[s.length-1]}}},_returnDataObjectBasedOnType:function(e){var t="";if(typeof e==="object"||e instanceof Object){if(e&&e.attributes){for(var i in e.attributes){t=e.doVocabId+i.replace(_.DOT,"");break}}}else{t=e}if(t){var s=t.split("/");var n=s[1];var r=0;var o;var a="";if(s.length>2){for(var l=2;l<s.length;l++){n+=_.DOT+s[l];o=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(n);if(o&&o._dataObjectType==="AO"&&o._cardinality==="1..n"){r=l}else if(o&&o._dataObjectType==="R"&&o._isDataObjectTable){r=l}}if(r>0){for(var l=1;l<=r;l++){a+="/"+s[l]}}}if(a){return a}else{return"/"+s[1]}}},getGroupByAttributes:function(e){var t=",";var i="";if(e&&e.length>0){for(var s=0;s<e.length;s++){i+=t+e[s]}}return i},_fetchAttributes:function(e){if(typeof e==="string"||e instanceof String){var t=e.split("/");var i="";if(t.length>3){for(var s=2;s<t.length;s++){i+="/"+t[s]}return _.DOT+i}else{return"./"+t[2]}}else if(Object.keys(e.attributes).length===1){for(var n in e.attributes){return n}}else{}},_createUUID:function(){return this.infraUtils.createUUID()},_createSpanItem:function(e){var t=this.getId();this.ruleWithElementDO=false;if(e.tokenType===_.TERM){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var i=e.reference.split("/")[1];var s=this.termsProvider.getTermByTermId(i);if(s&&s.Type==="Rule"&&s.ResultDataObjectId!==""&&s.ResultDataObjectId!==undefined){var n=this.termsProvider.getTermByTermId(s.ResultDataObjectId);if(n&&n.getIsDataObjectElement()){s=n;this.ruleWithElementDO=true}}if(s&&e&&(s._isDataObjectElement||e.dataObjectType==="ruleWithElementDO")){i="/"+i}else{i=e.reference}var r=this.termsProvider.getTermNameFromASTNodeReference(i);if(r){if("dataObjectType"in e&&e.dataObjectType!=_.Element&&!this._enableAggregateFunctionVocabulary&&!this.ruleWithElementDO){e.text=r;if(this._addDotToReferenceText(e)){e.text=r+_.DOT}}else if(e.resultDataObjectId!==""&&e.resultDataObjectId!==undefined&&!this.ruleWithElementDO||e.tokenType===_.TERM&&e.dataObjectType!=_.Element&&!this.ruleWithElementDO&&!this._enableAggregateFunctionVocabulary){e.text=r;if(this._addDotToReferenceText(e)){e.text=r+_.DOT}}else{e.text=r}}}if(e.tokenType===_.FUNCTION&&e.json){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var r=this.termsProvider.getTermNameFromASTNodeReference(e.json.dataObject);e.text=e.text.replace(e.json.dataObject,r)}if(e.tokenType===_.DATEBUSINESSDATATYPE||e.tokenType===_.TIMEBUSINESSDATATYPE){var o=this._getDateTimeFormatter(e.tokenType);var a=e.text.replace(/\'/g,"");var l=o.format(o.parse(a));if(l!==""){e.text="'"+l+"'"}}var u=e.id.replace("/","");var c=jQuery("<span>",{id:t+"-"+u,class:e.cssClass,reference:e.reference,resultDataObjectId:e.resultDataObjectId,json:JSON.stringify(e.json),tokenType:e.tokenType})["text"](e.text);return c},_getDateTimeFormatter:function(e){var t=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var i=v.getInstance(t);if(e===_.DATEBUSINESSDATATYPE){var s=i.getDatePattern("medium");var n=sap.ui.core.format.DateFormat.getDateInstance({pattern:s});return n}else if(e===_.TIMEBUSINESSDATATYPE){var s=i.getDatePattern("medium");var r=i.getTimePattern("medium");var o=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:s+" "+r});return o}},_isFirstTokenUpdateOrAppendOperation:function(){var e=false;if(this.relString&&(this.relString.trim().toUpperCase().indexOf(_.UPDATE)===0||this.relString.trim().toUpperCase().indexOf(_.APPEND)===0)){e=true}return e},_addDotToReferenceText:function(e){if(this._uiModel&&this.nIndexOfToken&&this._uiModel[this.nIndexOfToken]&&e&&"startIndex"in e&&this._uiModel[this.nIndexOfToken].startIndex!==e.startIndex){return false}var t=this._isFirstTokenUpdateOrAppendOperation()&&this.dotInOperationsContext;if(t||!t&&this._attributeContext||!t&&e.dataObjectType==="AO"||!t&&e.dataObjectType===_.REFERENCEDOTYPE||!this._isFirstTokenUpdateOrAppendOperation()&&(e.dataObjectType==="S"||e.dataObjectType==="T")){this._attributeContext=true;return true}return false},_uiModelToSpan:function(e){var t="";var i="";for(var s=0;s<e.length;s++){i+=this._createSpanItem(e[s])[0].outerHTML}this._input.html(i);return t},_closeAutoSuggestionPopup:function(){if(this._oAutoSuggestionPopUp)this._oAutoSuggestionPopUp.close()},_setUpEventHandlers:function(){var t=this,i=jQuery(this._input),s=[16,17,18,93,13,9,35,36,45,34,33,40,37,38,39,27,44,145,19,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135];this.aKeyTracker=[];if(!this._focusedOut){t._setCurrentCursorPosition(t._cursorPostion)}this._input.on("keydown",function(e){if(e.key!="Tab"){t.aKeyTracker.push({key:e.key,keyCode:e.keyCode,pressed:true})}if(e.keyCode===8||e.keyCode==46){t._selectedSpans=t._getSelectedSpans();t._handleBackSpaceAndDeleteKey(e)}else if(e.keyCode===40||e.keyCode===38){t._handleArrowNavigation(e)}else if(e.key==="Control"){t.ctrlPressed=true}else if(t.ctrlPressed&&(e.keyCode===32||e.key===" ")){t._initializeCursorSpan();t.ctrlPressed=false;t._bCtrlSpacePressed=true;if(!t.dataObjectInfo){t.dataObjectInfo=t.getDataObjectInfo()}if(!t.relString){t.relString=""}}else if(e.key==="Shift"){t.bShiftPressed=true}else if(t.bShiftPressed&&s.indexOf(e.keyCode)===-1){t.shiftKey=e.key;t.bShiftPressed=false}else if(e.key==="Tab"||e.keyCode===27){var n=t.aKeyTracker.findIndex(function(e){return e.pressed===true});if(n!==-1){var r=jQuery.Event("keyup");r.which=t.aKeyTracker[n];r.key=t.aKeyTracker[n].key;r.keyCode=t.aKeyTracker[n].keyCode;i.trigger(r)}t._closeAutoSuggestionPopup()}else if(s.indexOf(e.keyCode)!==-1&&e.keyCode!==35&&e.keyCode!==36&&e.keyCode!==37&&e.keyCode!==39){e.preventDefault()}});this._input.on("click",function(i){t.ctrlPressed=false;t.forceFireChange=false;t._initializeCursorSpan();var s;if(!t.getEditable()){return}if(t._selectedSpans&&t._selectedSpans[0]&&t._selectedSpans[0].getAttribute(_.JSON)){t.functionClicked=true;var n=t._getSuggestionsForTheGivenInput(t._contextForPerviousSpans(t._selectedSpans));t.isDialogOpen=true;try{s=JSON.parse(t._selectedSpans[0].getAttribute(_.JSON));if(s.function===_.FOREACH){t.loopFunctionDialog._createLoopFunctionDialog(n.autoComplete.categories.functions,t.loopFunctionCallBack,t._oAstExpressionLanguage,t._isDialogOpenedCallbackReference,s)}else if(s.function===_.TOP||s.function===_.BOTTOM||s.function===_.SELECT||s.function===_.FIRST){t.selectFunctionDialog._createSelectFunctionDialog(n.autoComplete.categories.functions,t.functionCallBack,t._oAstExpressionLanguage,t._isDialogOpenedCallbackReference,s)}else{s.selectExpression=typeof s.vocabulary==="object"||s.vocabulary instanceof Object?t._constructExpandedRelStringForSelect(s.vocabulary):"";t.aggregateFunctionDialog._createAggregationFunctionDialog(n.autoComplete.categories.functions,t.aggregateFunctionCallBack,t._oAstExpressionLanguage,t._isDialogOpenedCallbackReference,s)}}catch(t){e.error("Error in parsing string to JSON: "+t.message)}}t._closeAutoSuggestionPopup()});this._input.on("keyup",function(e){if(e.key!="Tab"){var i=t.aKeyTracker.findIndex(function(t){return t.keyCode==e.keyCode});t.aKeyTracker.splice(i,1)}var n=jQuery(this);var r=false;if(e.keyCode==8||e.keyCode==46){t._updateUiModel();t._calculateStringAndIndexOfNewToken()}t._initializeCursorSpan();if(!t.dataObjectInfo){t.dataObjectInfo=t.getDataObjectInfo()}if(e.key==="Control"||e.keyCode===35||e.keyCode===36||e.keyCode===37||e.keyCode===39||e.keyCode===20||e.keyCode===144){return}if(t.bEditInBetween){t.bTypingFlow=!t._bCtrlSpacePressed;t._getSuggestionsForEditedInput(true)}if(t._bCtrlSpacePressed){if(!t.bEditInBetween){t._suggestionsList=t._getSuggestionsForTheGivenInput(t.relString);var o=t._input.children()[t._input.children().length-1];if(o){t._selectedSpans=[];t._selectedSpans.push(o)}}if(t._selectedSpans[0]&&t._selectedSpans[0].getAttribute(_.TOKEN_TYPE)===_.UNDEFINED&&t._selectedSpans[0].textContent.startsWith(_.SINGLE_QUOTE)||t._selectedSpans[0].className==="sapAstLiteralClass"){t._suggestionsList.autoComplete.showLiteral=true;t._suggestionsList.autoComplete.literalInput=t._selectedSpans[0].textContent;if(t._selectedSpans[0]&&t._selectedSpans[0].getAttribute("reference")){t._suggestionsList.autoComplete.literalInput=t._selectedSpans[0].getAttribute("reference")}}t._showAutoSuggestion(t._suggestionsList);t._bCtrlSpacePressed=false;return}var a=n.data("before");var l=this.textContent;if(l&&e.key!==" "){l=l.trim()}if(a){a=a.trim()}if(l!==a){t.bTypingFlow=true;if(e.keyCode!==8&&e.keyCode!==46&&s.indexOf(e.keyCode)===-1||e.key==="Shift"&&t.shiftKey!==""){var u=e.key==="Shift"?t.shiftKey:e.key;t._updateUIModelForFreeFlow(u);if(u===" "&&(t._selectedSpans[0].className!=="sapAstLiteralClass"&&t._selectedSpans[0].className!=="sapAstAuxilaryNodeClass"||t._selectedSpans[0].className==="sapAstLiteralClass"&&!(t.filterTextLength<t._selectedSpans[0].textContent.length))){t.nIndexOfToken+=1;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:0})}r=true;t.shiftKey=""}t._handleKeyUpEvent(l,e,r);n.data("before",l);t._bCtrlSpacePressed=false}});this._input.on("focusout",function(e){t._focusedOut=true;if(!t.isDialogOpen&&!t._oAutoSuggestionPopUp.isOpen()){t._validateControl()}t._handlePopupFocusOut(e)});this._input.on("focus",function(e){t._focusedOut=false;var i=jQuery(this);i.data("before",i.context.textContent)})},_handleBackSpaceAndDeleteKey:function(e){var t=false;var i=this;if(e.keyCode==46){t=true}i._calculateStringAndIndexOfNewToken();if(t&&i.bEditInBetween&&i._selectedSpans&&"className"in i._selectedSpans[0]&&(i._selectedSpans[0].className=="sapAstAuxilaryNodeClass"&&this._getFullTextContentLength()===this._cursorPostion)){var s=i._getSelectedSpanGivenIndex(this.nIndexOfToken+1);if(s&&s[0]&&s[0].className==="sapAstObjectClass"){i._selectedSpans=s;i._setCaretPosition({spanIndex:i.nIndexOfToken+1,position:0});i._calculateStringAndIndexOfNewToken()}}if(i._selectedSpans[0].className==="sapAstObjectClass"){var n=i._selectedSpans[0].textContent;var r=i._selectedSpans[0].getAttribute(_.REFERENCE).split("/");var o="";var a="";var l=n.split(_.DOT);var u="";var c="";var h;if(i.filterTextLength>0&&!t||t){for(var d=1;d<r.length;d++){u=a;a+=l[d-1]+_.DOT;i._attributeContext=true;if(i.filterText.indexOf(a)>=0&&(!(i.filterText==a)||t&&i.filterText==a)){o+="/"+r[d];continue}else{break}}var g=b.getInstance();c=o.replace(/\//,"");c=c.replace(/\//g,".");if(c){h=g.getTermByTermId(c)}if(h&&(h._dataObjectType==="AO"||h._dataObjectType===_.REFERENCEDOTYPE)){o=r[0]===_.DOT?_.DOT+o:o;this.isDotRequired=false}else if(h&&(h._dataObjectType==="T"||h._dataObjectType==="S")){this.isDotRequired=false}else{this.isDotRequired=true}var p=i._cursorPostion>0?u.length:i._cursorPostion-i._selectedSpans[0].textContent.length-u.length;i._selectedSpans[0].textContent=u;i._setCaretPosition({spanIndex:i.nIndexOfToken,position:p});i._selectedSpans[0].setAttribute(_.REFERENCE,o);e.preventDefault();if(o===""){i._removeSpans();i.nIndexOfToken=i.nIndexOfToken>0?i.nIndexOfToken-1:0;i._selectedSpans=i._getSelectedSpanGivenIndex(this.nIndexOfToken);var f=i._selectedSpans?i._selectedSpans[0].textContent.length:0;i._setCaretPosition({spanIndex:i.nIndexOfToken,position:f})}}}else if(i._selectedSpans[0]&&i.filterTextLength!==0&&(i._selectedSpans[0].className==="sapAstFunctionClass"&&i._selectedSpans[0].getAttribute(_.JSON)||i._selectedSpans[0].className==="sapAstLiteralClass"&&i._selectedSpans[0].textContent.startsWith("'")&&i.bEditInBetween&&i.filterTextLength===i._selectedSpans[0].textContent.length)){i._removeSpans();i.nIndexOfToken=i.nIndexOfToken>0?i.nIndexOfToken-1:0;i._setCaretPosition({spanIndex:i.nIndexOfToken,position:i._cursorPostion});e.preventDefault()}else if(i._selectedSpans[0]&&i._selectedSpans[0].getAttribute("class")==="sapAstLiteralClass"&&(i._selectedSpans[0].getAttribute("tokentype")==="D"||i._selectedSpans[0].getAttribute("tokentype")==="T"||i._selectedSpans[0].getAttribute("tokentype")==="U")){i._removeSpans();i.nIndexOfToken=i.nIndexOfToken>0?i.nIndexOfToken-1:0;i._setCaretPosition({spanIndex:i.nIndexOfToken,position:i._cursorPostion})}},_handlePopupFocusOut:function(e){var t=e.currentTarget.id;var i=e.relatedTarget;if(i&&t!==i.id&&!this._isAutoSuggestionPopover(i)){if(this._oAutoSuggestionPopUp.isOpen()){this._closeAutoSuggestionPopup()}this._fireChange(this.textContent)}else if(e.relatedTarget==null){this._fireChange(this.textContent)}},_isAutoSuggestionPopover:function(e){var t=[];var i=false;while(e){if(e.id&&e.id.indexOf("autoCompletePopover")!==-1){i=true;break}t.unshift(e);e=e.parentNode}return i},_initializeCursorSpan:function(){this._selectedSpans=this._getSelectedSpans();this._cursorPostion=this._getCaretPosition();if(this._cursorPostion===0){this.filterTextLength=0}if(this._cursorPostion<this._input.text().length){this.bEditInBetween=true;this._calculateStringAndIndexOfNewToken()}else{this.bEditInBetween=false;this.filterTextLength=this._selectedSpans[0].textContent.length;this.nIndexOfToken=this._input.children().length-1}},_handleArrowNavigation:function(e){e.preventDefault();this._bPopUpFocused=true;var t=this._oAutoSuggestionPopUp.getContent()[0];var i=t.getAggregation("mainLayout").getItems()[0];$(i).focus()},_handleKeyUpEvent:function(e,t,i){var s=this;var n;var r=this._oAstExpressionLanguage.getTokensForGivenStringInput(this._uiModeltoString());if(!this.bEditInBetween){n=this._getStringForFilterAndTempRelString(r);if(t.keyCode===8||t.keyCode===46){this.dataObjectInfo=this.getDataObjectInfo()+n.tempRelString}}if(this._jsonArray.length>0){r=this._convertInputToUiModel(this.relString)}this._uiModel=s._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(r);this._uiModelToSpan(this._uiModel);this._uiModeltoString();this._getSelectedSpanFromIndex();if(!this._bCtrlSpacePressed&&i&&this.getDataObjectInfo()&&r[r.length-2].type!==this.astLibInstance.IDPParser.ALL_STRING){this.dataObjectInfo=this.getDataObjectInfo()+n.tempRelString}var o=this.filterTextLength;if(this.bEditInBetween){if(t.keyCode===8||t.keyCode===46){o=this._cursorPostion===0&&this.nIndexOfToken===0&&this.filterTextLength>0?0:this.filterTextLength}else if(!this._uiModel[this.nIndexOfToken].text.endsWith(t.key)&&this._selectedSpans[0].className!=="sapAstLiteralClass"&&this._selectedSpans[0].className!==""){this.nIndexOfToken+=1;o=1}else if(t.key==="'"){o=1}this._getSelectedSpanFromIndex();if(t.key!=="'"&&this._selectedSpans[0]&&"className"in this._selectedSpans[0]&&this._selectedSpans[0].className==="sapAstLiteralClass"){o=this.filterTextLength}}else{this.nIndexOfToken=this._input.children().length-1;o=this._cursorPostion}var a=this._selectedSpans?this._selectedSpans[0]:null;if(this.bEditInBetween&&t.key==="'"&&a&&a.nextSibling&&"getAttribute"in a.nextSibling&&(a.nextSibling.getAttribute("tokenType")==="U"||a.nextSibling.getAttribute("tokenType")==="N")){this._setCaretPosition({spanIndex:this.nIndexOfToken+1,position:o-1})}else if(this.bEditInBetween&&t.key==="'"&&a&&a.nextSibling&&"getAttribute"in a.nextSibling&&a.nextSibling.className==="sapAstLiteralClass"){this._setCaretPosition({spanIndex:this.nIndexOfToken+1,position:o})}else{this._setCaretPosition({spanIndex:this.nIndexOfToken,position:o,keyCode:t.keyCode})}if(e!==""&&t.key!=="Backspace"){var l=t.key!==" ";if(!this.bEditInBetween){this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1]);this._suggestionsList=this._getSuggestionsForTheGivenInput(n.tempRelString);var u=n.filterText;var c=this._filterSuggestionList(u);if(c.hasSuggestions){this._suggestionsList=c}if(!c.hasSuggestions&&n.filterText){var h=this._getTermIdForTheGivenText(n.filterText);if(h){var d=n.tempRelString+h;this._suggestionsList=this._getSuggestionsForTheGivenInput(d)}else{this._suggestionsList=c}}if(!(t.keyCode===8||t.keyCode===46)){this._showAutoSuggestion(this._suggestionsList,l)}}if(this._selectedSpans[0]&&this._selectedSpans[0].className!==""&&this._selectedSpans[0].className!=="sapAstLiteralClass"||this._selectedSpans[0]&&this._selectedSpans[0].getAttribute(_.TOKEN_TYPE)===_.UNDEFINED&&!s._selectedSpans[0].textContent.startsWith(_.SINGLE_QUOTE)){this._showAutoSuggestion(this._suggestionsList,l)}}else{this._closeAutoSuggestionPopup()}},_getTermIdForTheGivenText:function(e){var t=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var i=t.getTermByTermLabel(e);var s="";if(i){s="/"+i._termId}else{var n=t.getTermByTermName(e);s=n?"/"+n._termId:""}return s},_setCaretPosition:function(e){var t=window.getSelection(),i=this.$("input"),s,n,r,o,a=0;var l=function(e){var t=i.children(),s,n,r=0;for(var o=0;o<t.length;o++){s=t[o];n=s.innerText||"";if(r+n.length>e){return{spanIndex:o,position:r+n.length-e}}r+=n.length}return{spanIndex:Math.max(o-1,0),position:100}};if(typeof e==="number"){e=l(e)}r=e&&e.span;if(e){s=i[0];if(!r){r=s&&s.children&&s.children.length>e.spanIndex?s.childNodes[e.spanIndex]:null}if(r){n=document.createRange();o=r.firstChild?r.firstChild:r;if(this.bEditInBetween&&this.bTypingFlow){if(e.spanIndex===0&&e.position===0){a=0}else if(o&&o.length){a=Math.min(o.length,e.position)}}else if(o&&o.length){a=Math.min(o.length,e.position)}}if(!(typeof a==="number")||o&&o.length&&a>o.length||a<0){a=0}if(o){n.setStart(o,a);n.collapse(true);t.removeAllRanges();t.addRange(n)}}},_getStringForFilterAndTempRelString:function(e){var t="";var i="";var s;var n;var r;var o;for(var a in e){s=e[a];o=e[a-1];n=s.type?s.type:s._type;r=o?o.type?o.type:o._type:null;if(n===this.astLibInstance.IDPParser.EOF||n===this.astLibInstance.IDPParser.DOT){continue}else if(n===this.astLibInstance.IDPParser.ALL_STRING||r&&r===this.astLibInstance.IDPParser.ALL_STRING){i+=s.text}else{t+=s.text}}return{tempRelString:t,filterText:i}},_isEmptySpace:function(e){return e===String.fromCharCode(160)||e===" "},_bRequiredFilteredSuggestion:function(e){return!(this._isEmptySpace(e)||e===""||this._selectedSpans[0].className==="sapAstLiteralClass")},_updateUIModelForFreeFlow:function(e){var t=this;var i=this._selectedSpans[0];if(this._uiModel.length===0){var s={id:t._createUUID(),tokenType:_.UNDEFINED};if(i&&"textContent"in i){s["text"]=i.textContent}else{s["text"]=e}this._uiModel.push(s);this._uiModelToSpan(this._uiModel)}else if(i.className==="sapAstObjectClass"){if(e===_.DOT&&this.getOperationsContext()){this.dotInOperationsContext=true;this._attributeContext=true}else{var n=i.getAttribute(_.REFERENCE);if(i.textContent.startsWith(e)&&this.bEditInBetween){i.setAttribute(_.REFERENCE,e+" "+n);this._cursorPosition+=1}else if(i.textContent.endsWith(e)){i.setAttribute(_.REFERENCE,n+e)}}}else if(e===_.SINGLE_QUOTE&&this.bEditInBetween&&i&&i.className!="sapAstLiteralClass"){i.textContent=i.textContent.replace(_.SINGLE_QUOTE,_.SINGLE_QUOTE+_.SINGLE_QUOTE)}else if(this.bEditInBetween&&i.nextSibling&&i.nextSibling.className&&i.nextSibling.className==="sapAstFunctionClass"&&(i.className!=="sapAstLiteralClass"&&i.className!=="sapAstAuxilaryNodeClass"||e!==" "&&i.className==="sapAstAuxilaryNodeClass"&&i.textContent.endsWith(event.key))){i.textContent+=" "}this._updateUiModel()},_filterSuggestionList:function(e){var t=false;var i={autoComplete:{categories:{functions:{},operators:{},terms:[]},showLiteral:this._suggestionsList.autoComplete.showLiteral,businessDataTypeList:this._suggestionsList.autoComplete.businessDataTypeList},businessDataTypeList:this._suggestionsList.autoComplete.businessDataTypeList};if(this._suggestionsList.autoComplete.valuehelp){i.autoComplete.valuehelp=this._suggestionsList.autoComplete.valuehelp}var s=this._suggestionsList.autoComplete.categories;var n=function(i){var s=[];var n,r,o;for(var a=0;a<i.length;a++){n=i[a].label.toLowerCase();o=i[a].name.toLowerCase();r=e.toLowerCase();if((" "+n).indexOf(" "+r)!==-1||(" "+o).indexOf(" "+r)!==-1){s.push(i[a]);t=true}}return s};var r=function(){if(s.terms){i.autoComplete.categories.terms=n(s.terms)}if(s.functions){var e=s.functions.advanced;if(e&&e.length>0){var t=n(e);if(t&&t.length>0){i.autoComplete.categories.functions.advanced=t}}var r=s.functions.aggregate;if(r&&r.length>0){var t=n(r);if(t&&t.length>0){i.autoComplete.categories.functions.aggregate=t}}var o=s.functions.selection;if(o&&o.length>0){var t=n(o);if(t&&t.length>0){i.autoComplete.categories.functions.selection=t}}var a=s.functions.window;if(a&&a.length>0){var t=n(a);if(t&&t.length>0){i.autoComplete.categories.functions.window=t}}var l=s.functions.time_duration;if(l&&l.length>0){var t=n(l);if(t&&t.length>0){i.autoComplete.categories.functions.time_duration=t}}var u=s.functions.loop;if(u&&u.length>0){var t=n(u);if(t&&t.length>0){i.autoComplete.categories.functions.loop=t}}var c=s.functions.operations;if(c&&c.length>0){var t=n(c);if(t&&t.length>0){i.autoComplete.categories.functions.operations=t}}}if(s.operators){var h=s.operators.arithmetic;if(h&&h.length>0){var t=n(h);if(t&&t.length>0){i.autoComplete.categories.operators.arithmetic=t}}var d=s.operators.comparision;if(d&&d.length>0){var t=n(d);if(t&&t.length>0){i.autoComplete.categories.operators.comparision=t}}var g=s.operators.logical;if(g&&g.length>0){var t=n(g);if(t&&t.length>0){i.autoComplete.categories.operators.logical=t}}var p=s.operators.array;if(p&&p.length>0){var t=n(p);if(t&&t.length>0){i.autoComplete.categories.operators.array=t}}var f=s.operators.range;if(f&&f.length>0){var t=n(f);if(t&&t.length>0){i.autoComplete.categories.operators.range=t}}var _=s.operators.miscellaneous;if(_&&_.length>0){var t=n(_);if(t&&t.length>0){i.autoComplete.categories.operators.miscellaneous=t}}var S=s.operators.functional;if(S&&S.length>0){var t=n(S);if(t&&t.length>0){i.autoComplete.categories.operators.functional=t}}}};if(s){r()}if(!t){var o;if(this.bEditInBetween){o=this._oAstExpressionLanguage.getTokensForGivenStringInput(this.tempRelString)}else{o=this._oAstExpressionLanguage.getTokensForGivenStringInput(this.relString)}var a=o.length-2;e=o[a].text;o=o.slice(0,a);var l=this._getStringForFilterAndTempRelString(o);s=this._getSuggestionsForTheGivenInput(l.tempRelString).autoComplete.categories;r()}i.hasSuggestions=t;return i},_fireChange:function(e){if(this.isDialogOpen&&!this.forceFireChange){return}var t="";if(!this.relString&&e){this.relString=e}if(!this.relString){this.relString=""}if(this.markerString){this.markerRelString=this.markerString+this.relString;t=this._oAstExpressionLanguage.getAstNodesString(this.markerRelString)}else{t=this._oAstExpressionLanguage.getAstNodesString(this.relString)}this.astresponseNodes=JSON.parse(t);if(this._getValueAfterReplacingSpace(this.getValue())!==this._getValueAfterReplacingSpace(this.relString)){this.setValue(this.relString);this.setJsonData(this._jsonArray);this.fireChange({newValue:this.relString,astNodes:this.astresponseNodes,displayText:this._input[0].textContent.trim()})}},_getValueAfterReplacingSpace:function(e){if(e){return e.replace(/([^']+)|('(?:[^'\\]|\\.)+')/g,function(e,t,i){if(t){return t.replace(/\s/g,"")}else{return i}})}return""},_contextForPerviousSpans:function(t){var i="";var s;var n=this.getDomRef("input").children;for(var r=0;r<n.length;r++){var o=$("#"+n[r].id);if(n[r].id!==t[0].id){if(o[0].getAttribute(_.JSON)){try{s=JSON.parse(o[0].getAttribute(_.JSON));if(s.expandedText){i+=s.expandedText}}catch(t){e.error("Error in parsing string to JSON: "+t.message)}}else if(o[0].getAttribute(_.REFERENCE)){i+=o[0].getAttribute(_.REFERENCE)}else{i+=o[0].textContent}}else{i+="";break}}return i},_updateSelectFunction:function(e){this.isDialogOpen=false;this._selectedSpans[0].setAttribute(_.JSON,JSON.stringify(e.getSource().mProperties.jsonData));this._selectedSpans[0].textContent=e.getSource().mProperties.value;this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._input.empty();this._uiModelToSpan(this._uiModel);this._setCurrentCursorPosition(this._cursorPostion)},_updateLoopFunction:function(e){this.isDialogOpen=false;this._selectedSpans[0].setAttribute(_.JSON,JSON.stringify(e.getSource().mProperties.jsonData));this._selectedSpans[0].textContent=e.getSource().mProperties.value;this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._input.empty();this._uiModelToSpan(this._uiModel);this._setCurrentCursorPosition(this._cursorPostion)},_updateAggregateFunction:function(e){this.isDialogOpen=false;this._selectedSpans[0].setAttribute(_.JSON,JSON.stringify(e.getSource().mProperties.jsonData));this._selectedSpans[0].textContent=e.getSource().mProperties.value;this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._input.empty();this._uiModelToSpan(this._uiModel);this._setCurrentCursorPosition(this._cursorPostion)},_getNewSpaceSpan:function(){var e={};e.id=this._createUUID();e.text=" ";e.tokenType=_.WS;e.cssClass="sapAstAuxilaryNodeClass";return this._createSpanItem(e)},_createSpaceSpanItem:function(){var e=this._getNewSpaceSpan();var t=this._selectedSpans[0]?this._selectedSpans[0].id:"";var i="#"+t;$(e[0]).insertAfter(i);this._updateUiModel();this._cursorPostion+=e[0].textContent.length;this._selectedSpans=$(e);this._uiModel=this._convertInputToUiModel(this.relString);this._hasTextContent=true;this.nIndexOfToken+=1},_addSpace:function(){this._createSpaceSpanItem();if(this.bEditInBetween){this._getSuggestionsForEditedInput(false)}else{this._suggestionsList=this._getSuggestionsForTheGivenInput(this.relString)}this._setCaretPosition({spanIndex:this.nIndexOfToken,position:this._selectedSpans[0].textContent.length});this._showAutoSuggestion(this._suggestionsList)},_removeSpans:function(){var e=false;if(this._uiModel.length===0||this._input.children().length===0){return e}this._prevNodeofRemovedNode=null;for(var t=0;t<this._selectedSpans.length;t++){this._prevNodeofRemovedNode=$("#"+this._selectedSpans[t].id).prev()[0];if(this._selectedSpans[t]instanceof HTMLSpanElement){if(this._selectedSpans[t].textContent){this._cursorPostion-=this._selectedSpans[t].textContent.length}$(this._selectedSpans[t]).remove();e=true}if("getAttribute"in this._selectedSpans[t]&&this._selectedSpans[t].getAttribute("class")==="sapAstObjectClass"){this._attributeContext=false}}if(this.getDomRef("input")&&this.getDomRef("input").textContent&&!this.getDomRef("input").textContent.length>0){this._hasTextContent=false}return e},_showAutoSuggestion:function(e,t){var i=jQuery(this._selectedSpans);var s=0;if(this._cursorPostion!==0){if(i&&i[0]instanceof HTMLPreElement){s=12}else{if("position"in i&&i.position()){s=parseInt(i.position().left,10)}s+=parseInt(i.width(),10)}}var n=3;s+=10;var r=this;setTimeout(function(){if(r._oAutoSuggestionPopUp&&!r._oAutoSuggestionPopUp.isOpen()&&r._focusedOut==false){r._oAutoSuggestionPopUp.destroyContent();r._oAutoSuggestionPopUp.addContent(new sap.rules.ui.AutoCompleteSuggestionContent({content:e.autoComplete,reference:r._reference,enableAggregateFunctionVocabulary:r._enableAggregateFunctionVocabulary,enableAggregateFunctionWhereClause:r._enableAggregateFunctionWhereClause,dialogOpenedCallbackReference:r._isDialogOpenedCallbackReference,vocabularyInfo:r._oAstExpressionLanguage,expand:t}));r._oAutoSuggestionPopUp.setOffsetX(s);r._oAutoSuggestionPopUp.setOffsetY(n);r._oAutoSuggestionPopUp.openBy(r.getDomRef("input"))}else{r._oAutoSuggestionPopUp.destroyContent();r._oAutoSuggestionPopUp.addContent(new sap.rules.ui.AutoCompleteSuggestionContent({content:e.autoComplete,reference:r._reference,enableAggregateFunctionVocabulary:r._enableAggregateFunctionVocabulary,enableAggregateFunctionWhereClause:r._enableAggregateFunctionWhereClause,dialogOpenedCallbackReference:r._isDialogOpenedCallbackReference,vocabularyInfo:r._oAstExpressionLanguage,expand:t}));r._oAutoSuggestionPopUp.setOffsetX(s);r._oAutoSuggestionPopUp.setOffsetY(n)}if(!r._oAutoSuggestionPopUp.isOpen()&&r._focusedOut==false){r._oAutoSuggestionPopUp.setOffsetX(s);r._oAutoSuggestionPopUp.setOffsetY(n);r._oAutoSuggestionPopUp.openBy(r.getDomRef("input"))}},600)},_isLastTokenSpaceItem:function(){var e=true;var t=[];if(this.bEditInBetween&&this.tempRelString!=""&&this.nIndexOfToken>=0){t=this._uiModel[this.nIndexOfToken];if(this._attributeContext||this._selectedSpans[0].textContent!==this.filterText){return true}}else if(this._uiModel&&this._uiModel.length>0){t=this._uiModel[this._uiModel.length-1]}if(t&&(t.tokenType===_.WS||t.tokenType===_.UNDEFINED)){return true}if(t&&t.tokenType!==_.WS&&t.dataObjectType&&t.dataObjectType!=="S"&&t.dataObjectType!=="T"&&t.dataObjectType!=="AO"&&t.dataObjectType!==_.REFERENCEDOTYPE&&(t.tokenType===_.TERM&&!t.getText().endsWith(_.DOT))){e=false}else if(t&&t.tokenType!==_.WS&&t.tokenType!==_.TERM&&t.reference===undefined){e=false}else if(t&&t.tokenType!==_.WS&&this._isFirstTokenUpdateOrAppendOperation()&&!this._attributeContext){e=false}else if(t&&(t.tokenType==="D"||t.tokenType==="T")&&this._uiModel[0]&&"getText"in this._uiModel[0]){e=false}else if(t&&t.tokenType==="ID"&&!t.dataObjectType){var i=t.getReference()?t.getReference().split("/")[1]:"";if(b.getInstance().getTermByTermId(i).isResultDataObjectElement){e=false}}return e},_addItemToEmptyInput:function(e,t,i,s){if(s.resultDataObjectId&&s.resultDataObjectId!==""&&s.tokenType===_.TERM){this.ruleContext=true}t=this._createSpanItem(s);this._uiModel.push(s);this._uiModeltoString();this._uiModel=this._convertInputToUiModel(this.relString);this._cursorPostion=s.text.length;this._uiModelToSpan(this._uiModel);this._selectedSpans=t;if(this.getIsAttributeContext()&&!this.isAssociation&&!this.isReference&&!s.json&&this._oAutoSuggestionPopUp&&this._oAutoSuggestionPopUp.isOpen){this.isAutoSuggestionRequired=false;this._oAutoSuggestionPopUp.close()}},_addAtBeginningForInBetween:function(e,t,i,s){$(e[0]).insertBefore(t);this._cursorPostion=s.text.length;this._selectedSpans=$(e);$(i[0]).insertBefore(t);s.bAddSpaceAutoMatically=false;if(!s.text.endsWith(_.DOT)){this._cursorPostion+=1;this._selectedSpans=$(i);this.nIndexOfToken+=1}},_handleUndefinedForInBetween:function(e,t,i,s,n,r){if(e.textContent.startsWith(_.SINGLE_QUOTE)){this._selectedSpans[0].textContent+=t.text;this._cursorPostion+=t.text.length}else{var o=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=t.text;this._cursorPostion+=t.text.length-o;this._replacePreviousUndefinedTokens();if(i&&i.getAttribute(_.TOKEN_TYPE)===_.TERM&&i.textContent.endsWith(_.DOT)){this.nIndexOfToken-=1}}if(s&&s.getAttribute(_.TOKEN_TYPE)!==_.WS){$(n[0]).insertAfter(r);t.bAddSpaceAutoMatically=false}if(t.reference){this._selectedSpans[0].setAttribute(_.REFERENCE,t.reference)}if(t.json){this._selectedSpans[0].setAttribute(_.JSON,JSON.stringify(t.json))}},_addInBetweenTermsForInBetween:function(e,t,i,s,n){if(this.filterText.indexOf(_.DOT)>-1){this._appendItemText(this.filterText,e,s)}else if(this.getOperationsContext()&&this.bEditInBetween&&e.getAttribute("tokentype")==="ID"&&e.textContent.endsWith(_.DOT)){this._appendItemText(e.textContent,e,s)}else{this._selectedSpans[0].textContent=s.text;this._selectedSpans[0].setAttribute("reference",s.reference)}this._cursorPostion=this._cursorPostion-this.filterText.length+this._selectedSpans[0].textContent.length},_appendItemText:function(e,t,i){var s=e.split(_.DOT);var n=t.getAttribute("reference").split("/");var r="";var o="";for(var a=0;a<s.length-1;a++){o+=s[a]+_.DOT;r+="/"+n[a+1]}if(n[0]===_.DOT){r=_.DOT+r}i.reference=i.reference.replace(".","");this._selectedSpans[0].textContent=o+i.text;this._selectedSpans[0].setAttribute("reference",r+i.reference)},_addItemInBetween:function(e,t,i,s,n){var r=t.previousSibling;var o=t.nextSibling;e=this._createSpanItem(s);var a=this._getNewSpaceSpan();if(this._cursorPostion===0&&this.nIndexOfToken===0&&!r){this._addAtBeginningForInBetween(e,i,a,s)}else if(t.getAttribute(_.TOKEN_TYPE)===_.UNDEFINED){this._handleUndefinedForInBetween(t,s,r,o,a,i)}else if(s.json){$(e[0]).insertAfter(i);this._selectedSpans=e;this._cursorPostion+=e[0].textContent.length;this.nIndexOfToken+=1;if(o.getAttribute(_.TOKEN_TYPE)!==_.WS){$(a[0]).insertAfter(i);s.bAddSpaceAutoMatically=false;this.nIndexOfToken+=1}}else if(t.getAttribute(_.TOKEN_TYPE)===_.TERM&&!(t.textContent.endsWith(_.DOT)&&this.filterText===t.textContent)||t.getAttribute(_.TOKEN_TYPE)===_.FUNCTION&&t.textContent.length===1){if(this.getOperationsContext()&&this._attributeContext&&e[0].textContent===_.DOT){this._selectedSpans[0].textContent+=s.text;this.isAutoSuggestionRequired=true;this.dotInOperationsContext=true;this._cursorPostion=this._cursorPostion+1}else{this._addInBetweenTermsForInBetween(t,e,i,s,a)}}else if(t.getAttribute(_.TOKEN_TYPE)===_.TERM&&t.textContent.endsWith(_.DOT)){this._selectedSpans[0].textContent+=s.text;if(s.text===_.DOT&&this._attributeContext){this.isAutoSuggestionRequired=true;this.dotInOperationsContext=true;this._cursorPostion=this._cursorPostion+1}else{if(s.reference){var l=t.getAttribute(_.REFERENCE)?t.getAttribute(_.REFERENCE)+s.reference:s.reference;this._selectedSpans[0].setAttribute(_.REFERENCE,l)}if(s.json){this._selectedSpans[0].setAttribute(_.JSON,JSON.stringify(s.json))}}this._cursorPostion+=s.text.length}else if(t.className==="sapAstLiteralClass"){var u=this.filterTextLength;if(this._selectedSpans[0].getAttribute(_.TOKEN_TYPE)==_.DATEBUSINESSDATATYPE||this._selectedSpans[0].getAttribute(_.TOKEN_TYPE)===_.TIMEBUSINESSDATATYPE){this._selectedSpans[0].setAttribute(_.REFERENCE,s.text)}this._selectedSpans[0].textContent=s.text;this._cursorPostion+=s.text.length-u;if(o&&o.getAttribute(_.TOKEN_TYPE)===_.WS){s.bAddSpaceAutoMatically=false}}else if(n){var u=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=s.text;this._cursorPostion+=s.text.length-u;if(r&&r.getAttribute(_.TOKEN_TYPE)===_.TERM&&r.textContent.endsWith(_.DOT)){this.nIndexOfToken-=1}if(s.reference){this._selectedSpans[0].setAttribute(_.REFERENCE,s.reference)}}else{$(e[0]).insertAfter(i);if(t.getAttribute(_.TOKEN_TYPE)!==_.WS){$(a[0]).insertAfter(i);this._cursorPostion+=1;this.nIndexOfToken+=1}this._selectedSpans=$(e);this._cursorPostion+=e[0].textContent.length;if(!this._isLastTokenSpaceItem()){this._addSpace()}else{this.nIndexOfToken+=1}if(o&&o.getAttribute(_.TOKEN_TYPE)!==_.WS){a=this._getNewSpaceSpan();$(a[0]).insertAfter($("#"+this._selectedSpans[0].id));s.bAddSpaceAutoMatically=false}}if(s.text.endsWith(" (")){this.nIndexOfToken+=2}this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._uiModelToSpan(this._uiModel);this._getSelectedSpanFromIndex();this._getSuggestionsForEditedInput(false)},_addItemsToTheEnd:function(e,t,i,s,n){if(t.getAttribute(_.TOKEN_TYPE)===_.UNDEFINED){if(t.textContent.startsWith(_.SINGLE_QUOTE)){this._selectedSpans[0].textContent+=s.text;this._cursorPostion+=s.text.length}else{var r=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=s.text;this._cursorPostion+=s.text.length-r;if(s.tokenType===_.TERM){this._cursorPostion+=1}this._replacePreviousUndefinedTokens()}if(s.reference){this._selectedSpans[0].setAttribute(_.REFERENCE,s.reference)}if(s.json){this._selectedSpans[0].setAttribute(_.JSON,JSON.stringify(s.json))}}else if(s.json||t.getAttribute(_.TOKEN_TYPE)===_.WS){e=this._createSpanItem(s);$(e[0]).insertAfter(i);this._selectedSpans=e;this._cursorPostion+=e[0].textContent.length;this.nIndexOfToken+=1}else if(n){var r=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=s.text;this._cursorPostion+=s.text.length-r;if(s.tokenType===_.TERM){this._cursorPostion+=1}if(s.reference){this._selectedSpans[0].setAttribute(_.REFERENCE,s.reference)}}else{this._selectedSpans[0].textContent+=s.text;if(s.text===_.DOT&&this._attributeContext){this.isAutoSuggestionRequired=true;this.dotInOperationsContext=true;this._cursorPostion=this._cursorPostion+1}else{if(s.reference){var o=this._selectedSpans[0].getAttribute(_.REFERENCE)?this._selectedSpans[0].getAttribute(_.REFERENCE)+s.reference:s.reference;this._selectedSpans[0].setAttribute(_.REFERENCE,o)}if(s.json){this._selectedSpans[0].setAttribute(_.JSON,JSON.stringify(s.json))}this._cursorPostion+=s.text.length}}this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._uiModelToSpan(this._uiModel);this._hasTextContent=true;if(this.getIsAttributeContext()&&!this.isAssociation&&!this.isReference&&!s.json&&this._oAutoSuggestionPopUp&&this._oAutoSuggestionPopUp.isOpen()){this.isAutoSuggestionRequired=false;this._oAutoSuggestionPopUp.close()}},_bReplaceFunctionWithSelectedItem:function(e,t){if(e&&e.className==="sapAstFunctionClass"){var i=t.text.toLowerCase();var s=t.label?t.label.toLowerCase():"";var n=e.textContent.toLowerCase();return i.startsWith(n)||s.indexOf(n)>-1}return false},_resetCursorForRerendering:function(){var e=0;if(this.bEditInBetween){e=this._getFullTextContentLength();if(e!==this._cursorPostion&&this._cursorPostion!==0){this._cursorPostion=e}}},_getFullTextContentLength:function(){var e=0;for(var t=0;t<=this.nIndexOfToken;t++){e+=this._getSelectedSpanGivenIndex(t)[0].textContent.length}return e},_setTextOnCursorPosition:function(e){this.dotInOperationsContext=false;this.bTypingFlow=false;var t;this._resetCursorForRerendering();var i=this._selectedSpans?this._selectedSpans[0]:{};var s="#"+i.id;var n=i.getAttribute(_.TOKEN_TYPE)===_.WS||this._uiModel.length===0?"":i.id;var r=this._getItemFromSuggestionModel(e,n);this.ruleContext=false;this.forceFireChange=false;var o=this._bReplaceFunctionWithSelectedItem(i,r);if(!this._selectedSpans[0].textContent.endsWith(".")&&!o&&!this._isLastTokenSpaceItem()&&e.getSource().mProperties&&e.getSource().mProperties.label&&e.getSource().mProperties.label!==_.DOT&&this._cursorPostion>0){this._createSpaceSpanItem();i=this._selectedSpans[0];s="#"+i.id}if(e&&e.getSource()&&e.getSource().mProperties.forceFireChange){this.forceFireChange=true}if(this._uiModel.length===0){this._addItemToEmptyInput(e,t,s,r)}else if(i&&this.bEditInBetween){this._addItemInBetween(t,i,s,r,o)}else if(i){this._addItemsToTheEnd(t,i,s,r,o);if(this.isAssociation||this.isReference){this._cursorPostion+=1}}else{console.error("could not find the user selected span - currentSpan")}if(this._bPopUpFocused){this._input.focus();this._bPopUpFocused=false}if(!this.bEditInBetween){this.nIndexOfToken=this._input.children().length-1;this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1])}this._setCaretPosition({spanIndex:this.nIndexOfToken,position:this._selectedSpans[0]?this._selectedSpans[0].textContent.length:this._cursorPostion});if(this.isAutoSuggestionRequired){if(r.bAddSpaceAutoMatically&&!this._isLastTokenSpaceItem()&&!(this.bEditInBetween&&this._uiModel[this.nIndexOfToken+1].tokenType===_.WS)){this._addSpace()}else{if(this.bEditInBetween&&!this._isLastTokenSpaceItem()){this._setCaretPosition({spanIndex:this.nIndexOfToken+1,position:1})}else if(!this.bEditInBetween){this._suggestionsList=this._getSuggestionsForTheGivenInput(this.relString)}this._showAutoSuggestion(this._suggestionsList)}}},_replacePreviousUndefinedTokens:function(){var e=this._selectedSpans[0];var t=e.previousSibling;var i;while(t&&t.previousSibling){if(t.getAttribute(_.TOKEN_TYPE)===_.WS&&t.previousSibling.getAttribute(_.TOKEN_TYPE)===_.UNDEFINED||t.getAttribute(_.TOKEN_TYPE)===_.UNDEFINED){i=t;t=t.previousSibling;i.remove();this.nIndexOfToken-=1}else{break}}if(t&&!t.previousSibling&&t.getAttribute(_.TOKEN_TYPE)===_.UNDEFINED){t.remove();this.nIndexOfToken-=1}},_getItemFromSuggestionModel:function(e,t){this._attributeContext=false;this.isAssociation=false;this.isReference=false;var i={};var s=e.getSource();i.id=this._createUUID();if(s&&s.getBindingContext()){var n=s.getBindingContext().getObject();i.dataObjectType=n.type;if(n.ResultDataObjectId){i.resultDataObjectId=n.ResultDataObjectId;if(n.displayType&&n.displayType==="Rule"||i.resultDataObjectId){var r=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var o=r.getTermByTermId(n.ResultDataObjectId);if(o&&o.getIsDataObjectElement()){this.ruleWithElementDO=true;i.dataObjectType="ruleWithElementDO";i.cssClass="sapAstObjectClass";i.tokenType=_.TERM;i.text=n.label!==null&&n.label!==""?n.label:n.name;i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true;i.id=n.id?"/"+n.id:"";i.reference=n.id?"/"+n.id:""}else{var i=this._createObjectSpanItem(i,t,n)}}}else if(n.type===_.Element){i.tokenType=_.TERM;i.cssClass="sapAstObjectClass";i.id="";i.text=n.label!==null&&n.label!==""?n.label:n.name;if(this.getDataObjectInfo()&&this.isDotRequired&&!n.isParentEntity){i.reference=n.id?"./"+n.id:""}else{this.isDotRequired=true;i.reference=n.id?"/"+n.id:""}i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true;if(t&&t.indexOf("-")>0){t=t.substring(t.indexOf("-")+1)}i.id=t!==""?t+_.DOT+n.id:n.id;var a=b.getInstance();var l=a.getTermByTermId(i.id);if(l&&l._isDataObjectElement){i._isDataObjectElement=true}}else if("type"in n){var i=this._createObjectSpanItem(i,t,n)}else{i.text=n.name;if(n&&"noOfMandatoryArgs"in n){if(n.noOfMandatoryArgs==="0"){i.text+=" ( )"}else{i.text+=" ("}}i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true}}else if(e.getParameter("tokens")){var u=e.getParameter("tokens")[0].data("row");i.text=u.Value;i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true;i.cssClass="sapAstLiteralClass"}else if(e.getSource().mProperties.jsonData){i.text=e.getSource().mProperties.value;i.json=e.getSource().mProperties.jsonData;i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true}else{i.text=e.getSource().mProperties.value.trim();i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true}if(this.getDataObjectInfo()&&!this.bEditInBetween){if(i.json){this.dataObjectInfo+=this._constructExpandedRelString(i.json)}else if(this.getIsAttributeContext()&&i.text=="."){this.dataObjectInfo+=i.reference?i.reference.replace(".",""):i.text}else if(i.text!="."){this.dataObjectInfo+=i.reference?i.reference:i.text}if(i&&i.dataObjectType==="E"){this.dataObjectInfo+=" "}}if(e.getSource().mProperties.label===_.DOT){i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=false;this._attributeContext=true}return i},_createObjectSpanItem:function(e,t,i){e.tokenType=_.TERM;e.cssClass="sapAstObjectClass";e.id="";e.text=i.label!==null&&i.label!==""?i.label:i.name;if(!(i.type!==_.ASSOCIATIONDOTYPE||i.type!==_.REFERENCEDOTYPE)){e.reference=i.id?"/"+i.id:"";if(t&&t.indexOf("-")>0){t=t.substring(t.indexOf("-")+1)}e.id=t!==""?t+_.DOT+i.id:i.id}else{if(i.type===_.ASSOCIATIONDOTYPE){this.isAssociation=true}else if(i.type===_.REFERENCEDOTYPE){this.isReference=true}if(this.getDataObjectInfo()&&this.isDotRequired&&i.type!=="S"&&i.type!=="T"){e.reference=i.id?"./"+i.id:"";this.isDotRequired=false}else{e.reference=i.id?"/"+i.id:""}e.id+=i.id}if(this.getDataObjectInfo()){this.isDotRequired=false}this._attributeContext=true;e.bAddDotAutomatically=true;e.bAddSpaceAutoMatically=false;if(this._isFirstTokenUpdateOrAppendOperation()&&this.getOperationsContext()&&!this.getConditionContext()){this._attributeContext=false;e.bAddDotAutomatically=false;e.bAddSpaceAutoMatically=false;this.isDotRequired=false}return e},_createPopver:function(){var e=this;if(!this._oAutoSuggestionPopUp){this._oAutoSuggestionPopUp=new s("autoCompletePopover_"+this._createUUID(),{content:new sap.rules.ui.AutoCompleteSuggestionContent,showArrow:false,placement:a.Vertical,horizontalScrolling:true,showHeader:true,contentWidth:"400px",title:this.oBundle.getText("astSuggestionDialogTitle"),initialFocus:e,afterOpen:function(){var t;if(e.bEditInBetween){t=e.filterTextLength}else{t=e._selectedSpans[0].textContent.length}var i=e._cursorPostion===0?0:t;e._setCaretPosition({spanIndex:e.nIndexOfToken,position:i})}})}},_getCaretPosition:function(e,t){var i,s,n,r=0;var o=function(t){return e&&t===e||!e&&(t===s.anchorNode||t===s.anchorNode.parentNode)};var a=function(e){var t;if(o(e)){return false}if(e.nodeType===3){r+=e.textContent.length}else{for(var i=0;i<e.childNodes.length;i++){t=e.childNodes[i];if(o(t)){return false}r+=t.textContent.length}}return true};try{if(window.getSelection&&window.getSelection().getRangeAt){i=window.getSelection().getRangeAt(0);s=window.getSelection();n=this._input[0].childNodes;for(var l=0;l<n.length;l++){if(!a(n[l])){break}}return(t||i.startOffset)+r}}catch(e){return this._cursorPostion}return 0},_getSelectedSpans:function(){var e=window.getSelection();var t=new Array;if("getRangeAt"in e){var i=e.getRangeAt(0);if(i.startContainer==i.endContainer){t.push(i.startContainer.parentNode)}else{var s=$(i.startContainer.parentNode);var n=$(i.endContainer.parentNode);t.push(s);$(i.startContainer.parentNode).nextAll().each(function(){var e=$(this).attr("id");if(e!=$(n).attr("id")){t.push($(this))}else{t.push(n);return false}})}}else{t.push(e.anchorNode.parentNode)}return t},_createRange:function(e,t,i){if(!i){i=document.createRange();i.selectNode(e);i.setStart(e,0)}if(t.count===0){i.setEnd(e,t.count)}else if(e&&t.count>0){if(e.nodeType===Node.TEXT_NODE){if(e.textContent!=undefined&&e.textContent.length<t.count){t.count-=e.textContent.length}else{i.setEnd(e,t.count);t.count=0}}else{for(var s=0;s<e.childNodes.length;s++){i=this._createRange(e.childNodes[s],t,i);if(t.count===0){break}}}}return i},_setCurrentCursorPosition:function(e){if(e>=0){var t=window.getSelection();var i=this._createRange($("#"+this.getDomRef("input").id)[0],{count:e});if(i){i.collapse(false);t.removeAllRanges();t.addRange(i)}}},_updateUiModel:function(){var t=this;if(this.getDomRef("input")){var i=this.getDomRef("input").children;t._uiModel=[];for(var s=0;s<i.length;s++){var n=i[s].getAttribute(_.TOKEN_TYPE)!==_.GEOBUSINESSDATATYPE?i[s].getAttribute(_.REFERENCE):undefined;var r=i[s].getAttribute(_.JSON);var o={id:i[s].id,cssClass:i[s].className,reference:n,tokenType:i[s].getAttribute(_.TOKEN_TYPE),text:i[s].textContent};if(r){try{o.json=JSON.parse(r)}catch(t){e.error("Error in parsing string to JSON: "+t.message)}}this._uiModel.push(o)}t._uiModeltoString()}},_uiModeltoString:function(){var e=this;e.relString="";e._jsonArray=[];this._uiModel.forEach(function(t,i){if(t.reference){e.relString+=t.reference}else if(t.json){e.relString+=e._constructExpandedRelString(t.json);e._jsonArray.push(t.json)}else{e.relString+=t.text}});return e.relString},_calculateStringAndIndexOfNewToken:function(){var t=this;var i="";var s="";if(this.getDomRef("input")){var n=this.getDomRef("input").children;var r=this._selectedSpans?this._selectedSpans[0].id:"";for(var o=0;o<n.length;o++){var a=n[o].getAttribute(_.TOKEN_TYPE)!==_.GEOBUSINESSDATATYPE?n[o].getAttribute(_.REFERENCE):undefined;var l=n[o].getAttribute(_.JSON);if(l){try{l=JSON.parse(l)}catch(t){e.error("Error in parsing string to JSON: "+t.message)}}if(n[o].id===r){this.nIndexOfToken=o;var u=s+n[o].textContent;var c=n[o].textContent;var h=u.length-this._cursorPostion;this.filterTextLength=h>=0?c.length-h:c.length;var d=this.filterTextLength<0?c:c.slice(0,this.filterTextLength);this.filterText=d;if(a){i+=this._constructReferenceForFilter(d,a,h)}else if(l){i+=t._constructExpandedRelString(l)}else{i+=d}break}s+=n[o].textContent;if(a){i+=a}else if(l){i+=t._constructExpandedRelString(l)}else{i+=n[o].textContent}}}return i},_constructReferenceForFilter:function(e,t,i){var s=e.split(".");var n=t.split("/");var r="";if(i<=0&&s.length===0||this._enableAggregateFunctionWhereClause&&t&&i<=0){return t}if(s.length>1){if(i<=0){if(this.bTypingFlow){return t+s[s.length-1]}else{return t}}for(var o=1;o<s.length;o++){r+="/"+n[o]}r+=s[s.length-1];this._attributeContext=true}else{r=e;this._attributeContext=false}return r},_getSelectedSpanFromIndex:function(){if(this.getDomRef("input")){var e=this.getDomRef("input").children;this._selectedSpans=$(e[this.nIndexOfToken])}},_getSelectedSpanGivenIndex:function(e){if(this.getDomRef("input")){var t=this.getDomRef("input").children;if(t[e]){return $(t[e])}else{return null}}},_isChildOf:function(e,t){while(e!==null){if(e.id===t){return true}e=e.parentNode}return false},_getCurrentCursorPosition:function(){var e=this.getDomRef("input").id;var t=window.getSelection(),i=-1,s;if(t.focusNode){if(this._isChildOf(t.focusNode,e)){s=t.focusNode;i=t.focusOffset;while(s){if(s.id===e){break}if(s.previousSibling){s=s.previousSibling;i+=s.textContent.length}else{s=s.parentNode;if(s===null){break}}}}}return i},_hiddenAccessModeSelected:function(e,t,i){if(this._input&&this._input[0].id===i.expId){this.expId=i.expId}},_validateControl:function(){var e=this.getValueState();var t=this.getValueStateText();if(this.astresponseNodes&&this.astresponseNodes.length===1&&this.astresponseNodes[0].Type==="I"&&this.astresponseNodes[0].Value!==""||this.astresponseNodes&&e==="Error"){this._input[0].classList.add("sapAstExpressionInputError");if(t){this._input[0].title=t}else{this._input[0].title=this.oBundle.getText("invalidExpression")}}else if(this.oBundle.getText("PredefinedResultsValueStateText")===t){this._input[0].classList.add("sapAstExpressionInputError");if(t){this._input[0].title=t}else{this._input[0].title=this.oBundle.getText("invalidExpression")}}else if(this._input[0].classList.contains("sapAstExpressionInputError")){this._input[0].classList.add("sapAstExpressionInputError");this._input[0].title=this.oBundle.getText("PredefinedResultsValueStateText");this.expId=""}else if(this._input[0].id===this.expId&&this._input[0].textContent!==""){this.expId=""}else{if(this._input[0].classList.contains("sapAstExpressionInputError")){this._input[0].classList.remove("sapAstExpressionInputError")}}},renderer:A});return O},true);
//# sourceMappingURL=AstExpressionBasic.js.map
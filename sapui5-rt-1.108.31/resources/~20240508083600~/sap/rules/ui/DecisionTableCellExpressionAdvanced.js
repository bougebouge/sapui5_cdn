/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/rules/ui/Utils","sap/rules/ui/ExpressionAdvanced","sap/rules/ui/Constants","./DecisionTableCellExpressionAdvancedRenderer"],function(jQuery,e,t,i,s,o){"use strict";var r=i.extend("sap.rules.ui.DecisionTableCellExpressionAdvanced",{metadata:{library:"sap.rules.ui",properties:{headerValue:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperator:{type:"string",defaultValue:"",bindable:"bindable"},type:{type:"sap.rules.ui.ExpressionType",defaultValue:sap.rules.ui.ExpressionType.BooleanEnhanced,bindable:"bindable"}}},renderer:o});r.prototype.validateExpression=function(){var e=this.codeMirror?this.codeMirror.getValue():this.getValue();if(e){var t=this.getHeaderValue()+" "+this.getFixedOperator()+" "+e;sap.rules.ui.ExpressionAdvanced.prototype.validateExpression.apply(this,[t])}else{this.setValueStateText("")}};r.prototype.init=function(){sap.rules.ui.ExpressionAdvanced.prototype.init.apply(this,arguments);this.bFlagForChangeBeforeBlur=false};r.prototype.onAfterRendering=function(){sap.rules.ui.ExpressionAdvanced.prototype.onAfterRendering.apply(this,arguments);this.codeMirror.options.fixedOperator=this.getFixedOperator();this.codeMirror.options.headerValue=this.getHeaderValue();this.codeMirror.options.filterOutStructuredCond=true;this.oDecisionTableCell=this.getParent()&&this.getParent().getParent()?this.getParent().getParent():null;this._handleValidation();if(jQuery.sap.byId(this.getId()).closest("td").next().width()){this._showPopUp()}if(this.oDecisionTableCell){var e=this.oDecisionTableCell.getValueStatePath();var t=this.oDecisionTableCell.getModel("dtModel");var i=this.oDecisionTableCell.getAggregation("_displayedControl");if(i){t.setProperty(e.slice(8),sap.ui.core.ValueState.None)}}this.createEventListeners()};r.prototype._handleValidation=function(){this.validateExpression();this._showErrorMessage();if(this.getProperty("valueStateText")&&this.codeMirror){this.codeMirror.options.expressionEditor._showPopUp()}};r.prototype._processValidationResult=function(e){sap.rules.ui.ExpressionAdvanced.prototype._processValidationResult.apply(this,arguments);if(this.oDecisionTableCell){var t=this.oDecisionTableCell.getValueStateTextPath();var i=this.oDecisionTableCell.getValueStatePath();var s=this.oDecisionTableCell.getModel("dtModel");var o=this.oDecisionTableCell.getAggregation("_displayedControl");if(o&&e.status===sap.rules.ui.ValidationStatus.Error){var r=this.getValueStateText();s.setProperty(t.slice(8),r);if(!this.oDecisionTableCell._oPopover||!this.oDecisionTableCell._oPopover.isOpen()){s.setProperty(i.slice(8),sap.ui.core.ValueState.Error)}else{s.setProperty(i.slice(8),sap.ui.core.ValueState.None)}this.setProperty("valueStateText",r)}else if(o){s.setProperty(t.slice(8),"null");s.setProperty(i.slice(8),sap.ui.core.ValueState.None);this.setProperty("valueStateText","")}}};r.prototype.exit=function(){sap.rules.ui.ExpressionAdvanced.prototype.exit.apply(this,arguments);this._handleValidation();this._closePopUp();this.pop=null;var e=this.codeMirror;if(e&&e.state.completionActive){e.state.completionActive.onClose()}if(this.bFocusCellAfterEscape&&this.oDecisionTableCell){var t=this.oDecisionTableCell.getDomRef().parentElement.parentElement;if(t){jQuery(t).focus()}}};r.prototype.getFormattingTokens=function(e){var t=this._liveValue;var i=this.getHeaderValue();var o=this.getFixedOperator();var r="All";if(e._hasValueSource&&i===""&&o===""){this.attributeId=this.mProperties.attributeInfo;this.valueListAttrInfo=e.getValueListAttribute(this.attributeId);if(this.valueListAttrInfo){i=this.valueListAttrInfo.navPath;o=s.IS_EQUAL_TO}}var a=e.getDecisionTableCellTokens(i,o,t,r);var n;if(a.tokens&&a.tokens.cell){n=a.tokens.cell;this.setExpressionTokens(n)}};r.prototype.createEventListeners=function(){document.getElementById(this.getId()).addEventListener("keydown",function(e){var t=e.keyCode||e.charCode;if(t===8){this.bFlagForChangeBeforeBlur=true}else if(t===27){this.bFocusCellAfterEscape=true}}.bind(this),true);var e="ontouchstart"in document.documentElement?"touchstart":"mousedown";if(e==="touchstart"){document.addEventListener("mousedown",function(e){if(e.target.className.includes("CodeMirror-hint")){e.stopPropagation()}}.bind(this),true);document.addEventListener("touchstart",function(e){if(e.target.className.includes("CodeMirror-hint")){e.stopPropagation()}}.bind(this),true)}if(!window.ActiveXObject&&"ActiveXObject"in window){this.codeMirror.on("blur",function(e,t){this.bFlagForPreventBlurWhenPopOverOpen=true}.bind(this));document.getElementById(this.getId()).addEventListener("mousedown",function(e){this.bFlagForChangeBeforeBlur=true}.bind(this),true)}if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1){document.addEventListener("mousedown",function(e){this.bIsClickedOnTheAutoComplete=e.target.className.includes("CodeMirror-hint")}.bind(this),true);document.addEventListener("blur",function(e){if(this.bIsClickedOnTheAutoComplete||this.ValueHelpRequested===true){this.bIsClickedOnTheAutoComplete=false;e.stopPropagation()}}.bind(this),true)}};return r},true);
//# sourceMappingURL=DecisionTableCellExpressionAdvanced.js.map
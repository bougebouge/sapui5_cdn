/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/rules/ui/InstructionRenderer","sap/rules/ui/ExpressionBase","./ExpressionBasicRenderer"],function(jQuery,t,e,i,s,n){"use strict";var r=s.extend("sap.rules.ui.ExpressionBasic",{metadata:{properties:{value:{type:"string",defaultValue:"",bindable:"bindable"}},aggregations:{_instructionRenderer:{type:"sap.rules.ui.InstructionRenderer",multiple:false}}},init:function(){this.shouldReload=true},_removeFurtherInstructions:function(t){var e=this.instructions.length;var i=e-t-1;this.instructions.splice(t+1,i)},_onChange:function(t){var e=t.getParameter("instructionNum");this._onChangeByIndex(e)},_onChangeByIndex:function(t,e,i){e=e||"";i=i===undefined||i===null?t:i;var s=this.getAggregation("_instructionRenderer");var n=s.getExpression();if(t>1){this.setProperty("value",n);return}this._removeFurtherInstructions(i);n=s.getExpression();var r=sap.ui.getCore().byId(this.getExpressionLanguage());var a=sap.rules.ui.SuggestionsPart;var o;var u;if(t==0){o=r._getBasicSuggestions(n,a.compPart)}if(t==1){o=r._getBasicSuggestions(e+" "+n,a.rightPart)}this.oDeferred=new jQuery.Deferred;for(var c=0;c<o.length;c++){if(o[c].valueListObject&&c===o.length-1){this.oDeferred.done(function(t,e){if(e){this.instructions=this.instructions.concat(u);s.setInstructions(this.instructions);this.setProperty("value",n);return}u=t;this.instructions=this.instructions.concat(u);s.setInstructions(this.instructions);this.setProperty("value",n);return}.bind(this))}}u=this._createInstructions(o);if(u){this.instructions=this.instructions.concat(u);s.setInstructions(this.instructions);this.setProperty("value",n)}},_callbackForActionControl:function(t,e){var i=this._createInstructions(e);this.instructions.splice.apply(this.instructions,[t,0].concat(i));var s=this.getAggregation("_instructionRenderer");s.setInstructions(this.instructions)},_createInstructions:function(t){var e=[];var i;var s;var n;for(var r=0;r<t.length;r++){s={};i=t[r];if(Array.isArray(i)){s.type="action";s.callback=this._callbackForActionControl.bind(this,r,i);s.editable=true}else{n=i.sugg;if(n&&n.length!==0){s.valueOptions={};s.valueOptions.type="Set";s.valueOptions.values=[];var a=s.valueOptions.values;for(var o=0;o<n.length;o++){a.push({token:n[o],text:n[o]})}}s.text=i.currentValue;s.token=i.currentValue;if(i.BDT){s.businessDataType=i.BDT}if(i.BDT===sap.rules.ui.ExpressionType.Number){var u=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var c=sap.ui.core.format.NumberFormat.getFloatInstance(u);var l=function(t){t=c.parse(t);if(isNaN(t)){return""}return t};s.text=l(s.text);s.token=l(s.token)}s.editable=true}s.visible=true;if(i.tokenCategory==="reservedword.undefined"||i.tokenCategory==="reservedword.null"){s.editable=false}else{s.editable=true}if(i.valueListObject){var h=[i.valueListObject];s.valueListObject=i.valueListObject;var g=sap.ui.getCore().byId(this.getExpressionLanguage());s.expressionLanguage=g;if(h&&h instanceof Array&&!h[0].metadata.HasValueSource){s.valueListObject=h[0];var d=s.valueListObject.model;if(d&&!d.getMetaModel().oModel){var f=function(){var t=g.getValueHelpCallback();t.call(this,h);var i=s.valueListObject.model;var n=new sap.ui.comp.odata.MetadataAnalyser(i);var r=s.valueListObject.metadata.propertyPath;var a=n.getValueListAnnotation(r);e.forEach(function(t){t.valueListAnnotation=a}.bind(this));this.oDeferred.resolve(e)}.bind(this);if(r===t.length-1){d.attachMetadataLoaded(f);d.attachMetadataFailed(function(){this.oDeferred.resolve(e,true)}.bind(this))}}}}e.push(s)}return e},setValue:function(t){this.shouldReload=true;this.setProperty("value",t)},_reload:function(){this.shouldReload=false;var t=sap.ui.getCore().byId(this.getExpressionLanguage())._getBasicSuggestions(this.getValue());if(this._checkForValueHelpSuggestions(t)){return}this.instructions=this._createInstructions(t);var e=new i({instructions:this.instructions,useIndent:false,change:this._onChange.bind(this)});this.setAggregation("_instructionRenderer",e,true)},onBeforeRendering:function(){if(this.shouldReload==true){this._reload()}},onAfterRendering:function(){if(this.shouldReload==true){this._reload()}var t=this.getAggregation("_instructionRenderer");if(!t){return}var e=t.getAggregation("_content");if(!e){return}var i=this.instructions[this.instructions.length-2];if(i&&!i.editable&&e[e.length-3]){e[e.length-3].focus()}else{e[e.length-1].focus()}jQuery.sap.byId(this.getId()).on("change",null,function(t){this.focus()}.bind(this))},_checkForValueHelpSuggestions:function(t){this.oDeferred=new jQuery.Deferred;for(var e=0;e<t.length;e++){if(t[e].valueListObject){this.oDeferred.done(function(t){var e=new i({instructions:this.instructions,useIndent:false,change:this._onChange.bind(this)});this.setAggregation("_instructionRenderer",e,true);this.shouldReload=false;this.rerender()}.bind(this));this.instructions=this._createInstructions(t);return true}}return false},renderer:n});return r},true);
//# sourceMappingURL=ExpressionBasic.js.map
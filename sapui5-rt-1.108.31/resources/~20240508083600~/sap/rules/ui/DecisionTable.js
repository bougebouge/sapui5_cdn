/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","jquery.sap.global","./library","sap/rules/ui/DecisionTableCell","sap/rules/ui/RuleBase","sap/rules/ui/Utils","sap/ui/table/Table","sap/ui/table/Column","sap/m/OverflowToolbar","sap/m/Popover","sap/m/Menu","sap/m/Dialog","sap/m/MenuButton","sap/m/Button","sap/m/ToolbarSpacer","sap/m/Text","sap/m/Input","sap/m/ObjectIdentifier","sap/m/Link","sap/m/Label","sap/m/BusyIndicator","sap/m/DisplayListItem","sap/m/MenuItem","sap/m/FlexBox","sap/m/MessageStrip","sap/rules/ui/DecisionTableSettingsOld","sap/rules/ui/type/DecisionTableCell","sap/rules/ui/ast/constants/Constants","sap/rules/ui/services/AstExpressionLanguage","sap/rules/ui/ast/util/AstUtil","sap/rules/ui/Constants","sap/ui/core/LocaleData","./DecisionTableRenderer"],function(e,jQuery,t,a,s,i,n,r,o,l,d,u,c,h,g,p,f,b,v,_,m,y,R,T,C,w,M,S,x,D,E,P,B){"use strict";var I={vocabulary:"vocabulary",rule:"rule",columns:"columns",rows:"rows"};var A=3;var O=s.extend("sap.rules.ui.DecisionTable",{metadata:{properties:{enableSettings:{type:"boolean",group:"Misc",defaultValue:false},enableSettingResult:{type:"boolean",defaultValue:true},cellFormat:{type:"sap.rules.ui.DecisionTableCellFormat",defaultValue:sap.rules.ui.DecisionTableCellFormat.Both},hitPolicies:{type:"sap.rules.ui.RuleHitPolicy[]",defaultValue:[sap.rules.ui.RuleHitPolicy.FirstMatch,sap.rules.ui.RuleHitPolicy.AllMatch]},lineActionBuffer:{type:"any",defaultValue:{rowPath:null,operation:null}},decisionTableFormat:{type:"sap.rules.ui.DecisionTableFormat",defaultValue:sap.rules.ui.DecisionTableFormat.CellFormat},threshold:{type:"int",defaultValue:999},visibleRowCount:{type:"int",defaultValue:999}},aggregations:{_toolbar:{type:"sap.m.OverflowToolbar",multiple:false,singularName:"_toolbar"},_table:{type:"sap.ui.core.Control",multiple:false,singularName:"_table"},_errorsText:{type:"sap.m.MessageStrip",multiple:false,singularName:"_errorsText"}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},ariaRoleDescription:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaRoleDescription"}}},_addErrorLabel:function(){var e=new C({showCloseButton:true,showIcon:true,type:sap.ui.core.MessageType.Error,visible:false}).addStyleClass("sapUiTinyMargin");this.setAggregation("_errorsText",e,true)},_addNewRow:function(e,t){var a=this.oMenu;if(a){a.close()}var s=this._getModel();var i=this.dataBucket.columns&&this.dataBucket.columns.results;if(!s||!i){return}var n=this.getAggregation("_table"),r=this.getBindingContext(),o=r.getProperty("Id"),l=r.getProperty("Version");var d={RuleId:o,Version:l};e=e||0;var u;if(t){d.Sequence=1}else{u=n.getContextByIndex(e).getPath();d.Sequence=s.getProperty(u).Sequence;d.Sequence++}d.Id=this._calNextRowId();s.createEntry("/DecisionTableRows",{properties:d});n.setSelectedIndex(d.Sequence-1);this._clearErrorMessages();this._saveWorkAround([],this.oBundle.getText("addRowSuccess"))},_addNewRowWorkaround:function(e){var t=this._internalModel.getProperty("/selectedRow");this._addNewRow(t,e)},_addNodeObject:function(e){var t=[];var a=sap.ui.getCore().byId(this.getAstExpressionLanguage());var s=a._astBunldeInstance.ASTUtil;var i=[];i.Root=e.Root;i.SequenceNumber=e.Sequence;i.ParentId=e.ParentId;i.Reference=e.Reference;i.Id=e.NodeId;i.Type=e.Type;i.Value=e.Value?e.Value:"";if(e.Type==="I"){i.Value=e.IncompleteExpression}if(e.Function){i.Function=e.Function}if(e.Type!=="P"&&e.Type!=="O"&&!e.Function){var n=[];n.BusinessDataType=e.Output?e.Output.BusinessDataType:e.BusinessDataType;n.DataObjectType=e.Output?e.Output.DataObjectType:e.DataObjectType;i.Output=n}s.createNode(i)},_addTable:function(){var e=new n({visibleRowCount:this.VISIBLEROWCOUNT,threshold:this.THRESHOLD,visibleRowCountMode:sap.ui.table.VisibleRowCountMode.Fixed,selectionMode:{parts:[{path:"dtModel>/editable"}],formatter:this._decideSelectionMode},rowSelectionChange:function(){this.oParent._rowSelectionChange()},enableColumnReordering:false,busy:"{dtModel>/busyTableState}"});e._updateTableCell=this._updateTableCell;e.setBusyIndicatorDelay(0);this.setAggregation("_table",e,true)},_addToolBar:function(){var e=new o({design:"Transparent",enabled:"{dtModel>/editable}"});var t=new sap.m.Title({text:this.oBundle.getText("decisionTable"),tooltip:this.oBundle.getText("decisionTable")});var a=new c({text:this.oBundle.getText("addRow"),visible:"{dtModel>/editable}",enabled:{parts:[{path:"dtModel>/newTable"}],formatter:this._decideAddRowEnablement},menu:new d({items:this._getMenuItems()})}).setTooltip(this.oBundle.getText("addRow"));var s=new h({text:this.oBundle.getText("deleteRow"),press:[this._deleteRowWorkaround,this],visible:"{dtModel>/editable}",type:sap.m.ButtonType.Transparent,enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isAtLeastOneRowSelected"}],formatter:this._decideDeleteRowEnablement}}).setTooltip(this.oBundle.getText("deleteRow"));var i=new h({text:this.oBundle.getText("copyRow"),press:[this._copyRow,this],type:sap.m.ButtonType.Transparent,visible:{parts:[{path:"dtModel>/editable"},{path:"dtModel>/sequenceExist"}],formatter:this._decideLineActionVisibility},enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement}}).setTooltip(this.oBundle.getText("copyRow"));var n=new h({text:this.oBundle.getText("cutRow"),type:sap.m.ButtonType.Transparent,press:[this._cutRow,this],visible:{parts:[{path:"dtModel>/editable"},{path:"dtModel>/sequenceExist"}],formatter:this._decideLineActionVisibility},enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement}}).setTooltip(this.oBundle.getText("cutRow"));var r=new c({text:this.oBundle.getText("pasteRow"),type:sap.m.ButtonType.Transparent,visible:{parts:[{path:"dtModel>/editable"},{path:"dtModel>/sequenceExist"}],formatter:this._decideLineActionVisibility},enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"},{path:"dtModel>/isSelection"}],formatter:this._decidePasteRowEnablement},menu:new d({items:this._getPasteMenuItems()})}).setTooltip(this.oBundle.getText("pasteRow"));var l=new h({text:"",press:this._openTableSettings.bind(this),visible:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement},enabled:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement}}).setTooltip(this.oBundle.getText("tableSettings"));l.setIcon("sap-icon://action-settings");e.addContent(t);e.addContent(new g({}));e.addContent(a);e.addContent(new g({width:"1em"}));e.addContent(s);e._delete=s;e.addContent(new g({width:"1em"}));e.addContent(i);e.addContent(new g({width:"1em"}));e.addContent(n);e.addContent(new g({width:"1em"}));e.addContent(r);e.addContent(new g({width:"1em"}));e.addContent(l);e.addContent(new g({width:"1em"}));this.setAggregation("_toolbar",e,true)},_bindColumns:function(){var e=this.getAggregation("_table");var t=[this._getBindModelName(),this.getBindingContextPath(),"/DecisionTable/DecisionTableColumns"].join("");var a="Condition,Result";if(this.getAstExpressionLanguage()){a="Condition/DecisionTableColumnConditionASTs,Result/DecisionTableColumnResultASTs"}e.bindColumns({path:t,parameters:{expand:a},factory:this._columnFactory.bind(this)});e.getBinding("columns").attachDataRequested(this._handleColumnsDataRequested,this);e.getBinding("columns").attachDataReceived(this._handleColumnsDataReceived,this);e.attachColumnResize(e,this._onColumnResize,this)},_onColumnResize:function(){this.columnResized=true;var e={colResize:true};var t=sap.ui.getCore().getEventBus();t.publish("sap.ui.rules","_onColumnResized",e)},_bindRows:function(){var e=this.getAggregation("_table");var t=[this._getBindModelName(),this.getBindingContextPath(),"/DecisionTable/DecisionTableRows"].join("");var a="Cells";if(this.getAstExpressionLanguage()){a="Cells/DecisionTableRowCellASTs"}var s=new sap.ui.model.Sorter("Sequence");e.bindRows({path:t,parameters:{expand:a},sorter:s});e.getBinding("rows").attachDataRequested(this._handleRowsDataRequested,this);e.getBinding("rows").attachDataReceived(this._handleRowsDataReceived,this)},_bindRule:function(){var e=[this._getBindModelName(),this.getBindingContextPath()].join("");this.bindElement({path:e,parameters:{expand:"DecisionTable"}});this.getElementBinding().attachDataRequested(this._handleRuleDataRequested,this);this.getElementBinding().attachDataReceived(this._handleRuleDataReceived,this);this.getElementBinding().refresh()},_buildMessagesStructure:function(e,t,a){var s;var i;var n;var r;if(!e.details){return t}for(var o=0;o<e.details.length;o++){s=e.details[o];if(!s.messages){continue}for(var l=0;l<s.messages.length;l++){n=s.messages[l].description;i=s.messages[l].additionalInfo;if(i.type==="ruleResult"){a.push(n);r="genericError";t[r]=a}else if(i.type==="column"){r="errorInColumnHeader";t[r]=true}else if(i.type==="cell"){r="RowId="+i.rowId+",ColId="+i.colId;t[r]=n}}}return t},_callCopyRuleRow:function(e,t,a,s,i,n){var r={groupId:"changes"};this._getModel().setDeferredGroups([r.groupId]);var o=function(e){this.resetControl();this._internalModel.setProperty("/busyState",false)}.bind(this);var l=function(e){sap.m.MessageToast.show(e)}.bind(this);var d=function(t){this._getModel().callFunction("/CopyRuleRow",{method:"POST",groupId:r.groupId,urlParameters:{RuleId:e,SourceRowId:a,TargetRowSeq:s,DeleteSourceRow:i,OverrideTargetRow:n}});this._getModel().submitChanges({groupId:r.groupId,success:o,error:l})}.bind(this);if(this._getModel().hasPendingChanges()){this._getModel().submitChanges({groupId:r.groupId,success:d,error:l})}else{d()}},_calNextRowId:function(){var e=this.dataBucket.rows.results;var t=0;for(var a=0;a<e.length;a++){if(e[a].Id>t){t=e[a].Id}}var s=t+1;return s},_clearErrorMessages:function(){var e=this.getAggregation("_errorsText");e.setText("");e.setVisible(false);this._internalModel.setProperty("/validationStatus",{},null,true);this._internalModel.setProperty("/valueState",{},null,true)},_closePopover:function(){var e=sap.ui.getCore().byId("popover");if(e){e.close()}},_collectColIdAndExpressionDetails:function(e){var t=e.length;var a=[];for(var s=0;s<t;s++){if(e[s].Result&&e[s].Result.Expression){var i={columnID:e[s].Result.Id,expressionContent:e[s].Result.Expression};a.push(i)}}return a},_columnFactory:function(e,t){var a=this;if(this.multiHeaderFlag){this.multiHeaderFlag=false}var s=this._getBindModelName();var i=t.getProperty("Type"),n=t.getProperty("Id"),o=t.getProperty("RuleId"),l=t.getProperty("Version");var d={RuleId:o,Id:n,Version:l};var u=s+t.getModel().createKey("/DecisionTableColumnResults",d);var c=t.getModel();var h=c.aBindings;this.columnWidth="auto";var g=new r(e,{width:this.columnWidth,minWidth:128,multiLabels:[this._createColIfThenHeader(t),this._createColDescriptionHeader(t,this)],template:this._createCell(t)});s=this._getBindModelName();this.firstResultColumnBound=t.getProperty(s+"Type")===sap.rules.ui.DecisionTableColumn.Result;if(i===sap.rules.ui.DecisionTableColumn.Result){if(this.getAstExpressionLanguage()){g.bindProperty("visible",{parts:[{path:u+"/AccessMode"}],formatter:this._columnVisibility})}if(this.getExpressionLanguage()){g.bindProperty("visible",{parts:[{path:u+"/AccessMode"}],formatter:function(){var e=a.getModel()&&u!==""?a.getModel().getObject(u).BusinessDataType:"";if(e===E.DATE_BUSINESS_TYPE||e===E.TIMESTAMP_BUSINESS_TYPE||e===E.NUMBER||e===E.STRING||e===E.BOOLEAN_BUSINESS_TYPE||e===E.BOOLEAN_ENHANCED_BUSINESS_TYPE){var t=a.getModel().getObject(u).AccessMode;return a._columnVisibility(t)}else{return false}}})}}return g},_columnVisibility:function(e){if(e==="Hidden"||e==="HIDDEN"){return false}else{return true}},_concatinateColumnsHeaderErrors:function(e){var t="";for(var a in e){if(e.hasOwnProperty(a)){if(e[a].header){t+="In Col: "+a+" - "+e[a].header+"\n"}}}return t},_concatinateHeaderErrors:function(e){var t="";for(var a=0;a<e.length;a++){t+="\n"+e[a]}return t},_convertAndValidate:function(){var e=this._getRuleData();var t=sap.ui.getCore().byId(this.getExpressionLanguage());if(t){var a={};if(t&&e){a=t.convertRuleToDisplayValues(e);if(a.deferredResult){a.deferredResult.done(this._processValidationResults.bind(this))}else{this._processValidationResults(a,e)}}}else{this._displayModel.setData(e);this._settingsModel.setData(e)}},_copyRow:function(){this._cutCopyRow("copy")},_createCell:function(e){var t=e.getProperty("Id");var s=e.getProperty("Type");var i=new a({editable:"{dtModel>/editable}",displayModelName:"displayModel",decisionTableCellType:this._decisionTableCellFormatter}).data({colId:t,colType:s,table:this.getAggregation("_table")});if(this.getAstExpressionLanguage()){i.setAstExpressionLanguage(this.getAstExpressionLanguage())}else{i.setExpressionLanguage(this.getExpressionLanguage())}return i},_createColDescriptionHeader:function(e,t){var a=this;var s=e.getProperty("Type"),i=e.getProperty("Id"),n=e.getProperty("RuleId"),r=e.getProperty("Version");var o="";var l;var d;var u;var c;var h={RuleId:n,Id:i,Version:r};var g;if(this.getExpressionLanguage()){o="displayModel>"}var f=document.getElementsByClassName("sapUiSizeCozy").length>0?3:1;var b=new p({maxLines:f}).addStyleClass("sapRULDecisionTableColumnHeaderLabel");if(s===sap.rules.ui.DecisionTableColumn.Condition){d=e.getModel().createKey("/DecisionTableColumnConditions",h);g=e.getModel().createKey("/DecisionTableColumns",h);u=new sap.ui.model.Context(e.getModel(),d);if(this.getAstExpressionLanguage()){c=t._getExpressionFromAstNodes(u)}l=o+d;b.bindText({parts:[{path:l+"/Expression"},{path:g+"/Label"},{path:l+"/FixedOperator"}],formatter:function(e,t,s){var i="";if(a.getAstExpressionLanguage()){i=!t?c:t}else{i=!t?e:t}if(s){var n=a.getAstExpressionLanguage()?a.astUtil._getCapitalOperatorName(s):s;i+=" "+n}return i}});b.bindProperty("tooltip",{parts:[{path:l+"/Expression"},{path:l+"/FixedOperator"}],formatter:function(e,t){var s="";if(a.getAstExpressionLanguage()){s=c?c:""}else{s=e}if(t){var i=a.getAstExpressionLanguage()?a.astUtil._getCapitalOperatorName(t):t;s+=" "+i}return s}})}else if(s===sap.rules.ui.DecisionTableColumn.Result){var v=e.getModel().createKey("/DecisionTableColumnResults",h);l=o+v;b.bindText({parts:[{path:l+"/DataObjectAttributeName"},{path:l+"/DataObjectAttributeLabel"},{path:"dtModel>/busyState"}],formatter:this._getOutputColumnDescription.bind(this)});b.bindProperty("tooltip",{parts:[{path:l+"/DataObjectAttributeName"},{path:l+"/DataObjectAttributeLabel"},{path:"dtModel>/busyState"}],formatter:this._getOutputColumnDescription.bind(this)})}return b},_createColIfThenHeader:function(e){var t=this._getBindModelName();var a=this.oBundle;return new _({text:{parts:[{path:t+"Type"},{path:t+"Sequence"}],formatter:function(e,t){if(t===1){return a.getText("conditionIfColumn")}else if(e===sap.rules.ui.DecisionTableColumn.Result){return a.getText("resultThenColumn")}else{return""}}},design:"Bold"})},_createDecisionTableSettings:function(){var e;if(this.isSequenceExistsInOdataMetadata()){e=this._createNewDecisionTableSettings()}else{e=this._createOldDecisionTableSettings()}return e},_createNewDecisionTableSettings:function(){var e=this._getModel();var t=this.getBindingContext();var a=new sap.rules.ui.DecisionTableSettings({hitPolicies:"{dtModel>/hitPolicies}",newDecisionTable:this._internalModel.getProperty("/newTable"),cellFormat:"{dtModel>/cellFormat}",decisionTableFormat:this.getDecisionTableFormat(),enableSettingResult:this.getEnableSettingResult()});if(this.getAstExpressionLanguage()){a.setAstExpressionLanguage(this.getAstExpressionLanguage())}else{a.setExpressionLanguage(this.getExpressionLanguage())}var s=JSON.stringify(this._settingsModel.getData());var i=JSON.parse(s);var n=new sap.ui.model.json.JSONModel(i);a.setModel(n);a.setModel(this._internalModel,"dtModel");a.setModel(e,"oDataModel");a.setBindingContext(t,"dummy");return a},_createOldDecisionTableSettings:function(){var e=this._getModel();var t=this.getBindingContext();var a=new w({expressionLanguage:this.getExpressionLanguage(),hitPolicies:"{dtModel>/hitPolicies}",newDecisionTable:this._internalModel.getProperty("/newTable")});a.setModel(e);a.setModel(this._internalModel,"dtModel");a.setBindingContext(t);return a},_cutCopyRow:function(e){var t=this._getModel();if(!t){return}var a=this.getAggregation("_table");var s=[];if(a){s=a.getSelectedIndices()}if(s.length!==1){return}var i=a.getContextByIndex(s[0]).getPath();this._markSelection(false);this.setLineActionBuffer({rowPath:i,operation:e});this._markSelection(true);a.setSelectedIndex(-1);sap.m.MessageToast.show(this.oBundle.getText(e+"RowSuccess"))},_cutRow:function(){this._cutCopyRow("cut")},_dataPartRequested:function(e){this.dataBucket.dataReceived[e]=false;this._setDataLoadedPromise();this._updateBusyState()},_dataPartReceived:function(e){this.dataBucket.dataReceived[e]=true;if(!this._isAllDataReceived()){return}try{this._convertAndValidate();this.dataBucket.collectRowsMode="replace"}catch(e){window.console.log(e)}this._updateBusyState();this._dataLoaded.resolve()},_decideAddRowEnablement:function(e){return!e},_decideCopyRowEnablement:function(e,t){return e===false&&t},_decideDeleteRowEnablement:function(e,t){return e===false&&t},_decideLineActionVisibility:function(e,t){return e===true&&t},_decidePasteRowEnablement:function(e,t,a){return e===false&&t&&a},_decideSelectionMode:function(e){return e?sap.ui.table.SelectionMode.MultiToggle:sap.ui.table.SelectionMode.None},_decideSettingsEnablement:function(e,t){return e&&t},_deleteRow:function(){var e=this._getModel();if(!e){return}var t=this.getAggregation("_table");var a=[];if(t){a=t.getSelectedIndices()}if(a.length===0){return}var s=a.length;for(var i=0;i<s;i++){var n=t.getContextByIndex(a[i]).getPath();e.remove(n)}t.setSelectedIndex(-1);this._clearErrorMessages();this.setLineActionBuffer({rowPath:null,operation:null});sap.m.MessageToast.show(this.oBundle.getText("deleteRowSuccess"))},_deleteRowWorkaround:function(){var e=this._getModel();if(e.hasPendingChanges()){this._saveWorkAround({success:function(){this._deleteRow()}.bind(this)})}else{this._deleteRow()}},_displayErrorMessages:function(e,t){},_displayHeaderErrorMessages:function(e,t){var a=this.getAggregation("_errorsText");this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");var s=this._concatinateHeaderErrors(e);a.setText(this.oBundle.getText("errorInTableHeader")+s);a.setVisible(true)},_flatRule:function(t){var a=this._getModel();var s={};var i=function(e,t,s){var i=a.createKey(t,s);e[i]=s};t.DecisionTable.DecisionTableColumns.results.forEach(function(e,t){if(e.Type==="CONDITION"){var a=e.Condition;if(a.parserResults&&a.parserResults.status==="Success"){a.Expression=a.parserResults.converted.Expression;if(a.parserResults.converted.FixedOperator||a.parserResults.converted.FixedOperator===""){a.FixedOperator=a.parserResults.converted.FixedOperator}else{a.FixedOperator=a.FixedOperator}}else{try{a.Expression=JSON.parse(a.Expression).text}catch(e){a.Expression=a.Expression}try{a.FixedOperator=JSON.parse(a.FixedOperator).text}catch(e){a.Expression=a.Expression}}delete a.parserResults;i(s,"DecisionTableColumnConditions",a)}else if(e.Type==="RESULT"){var n=e.Result;i(s,"DecisionTableColumnResults",n)}});t.DecisionTable.DecisionTableRows.results.forEach(function(t){var a=t.Cells;a.results.forEach(function(t){if(t.parserResults&&t.parserResults.status==="Success"){if(t.parserResults.converted.Content){t.Content=t.parserResults.converted.Content}else{t.Content=t.Content}}else if(t.parserResults&&t.parserResults.status==="Error"){try{if(t.Content===Object){t.Content=JSON.parse(t.Content).text}else{t.Content=t.Content}}catch(a){t.Content="";e.error("failed to pars AST cell in ColId "+t.ColId+" RowId "+t.RowId+" set cell content to empty")}}delete t.parserResults;i(s,"DecisionTableRowCells",t)})});return s},_getBindModelName:function(){var e="";var t=this.getModelName();if(t){e=t+">"}return e},_getBlankContent:function(){var e=new _({text:this.oBundle.getText("start")});var t=new p;t.setText(" ");var a=new v({enabled:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement},text:" "+this.oBundle.getText("settings"),press:[this._openTableSettings,this]}).addStyleClass("sapRULDecisionTableLink");var s=new T({justifyContent:"Center",items:[e,t,a],visible:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement}}).addStyleClass("sapUiMediumMargin");return s},_getDataLoadedPromise:function(){if(!this._dataLoaded){this._setDataLoadedPromise()}return this._dataLoaded.promise()},_getExpressionFromAstNodes:function(e){var t=this;var a=sap.ui.getCore().byId(this.getAstExpressionLanguage());var s=a._astBunldeInstance.TermsProvider.TermsProvider;var i="";var n="";var r=e.getPath();var o=e.getObject(r);var l=o.DecisionTableColumnConditionASTs;var d=a._astBunldeInstance.ASTUtil;var u=this._internalModel.getProperty("/conditionCellAstValues");var c=0;var h=0;var g=[S.AVG,S.SUM,S.COUNT,S.COUNTDISTINCT,S.DISTINCT,S.MIN,S.MAX,S.FILTER,S.TOP,S.BOTTOM,S.FIRST,S.SELECT,S.SORTASC,S.SORTDESC];d.clearNodes();l=l.__list;if(l&&l.length>0){for(var p in l){var f=l[p];t._addNodeObject(e.getObject("/"+f))}var b=d.getNodes();var v=t._getDateFormatter();var _=t._getDateTimeFormatter();i=d.toAstExpressionStringForDt(b,v,_);h=i.JSON.length;var m=e.getObject(e.getPath()).FixedOperator;var y=t.astUtil._getCapitalOperatorName(m);if(i&&i.relString){i.relString=i.relString.replace(/\\/g,"\\\\").replace(/{/g,"\\{").replace(/}/g,"\\}")}u[e.getPath()]={headerValue:i.relString+" "+y};var R=i.shortRELString?i.shortRELString.split(" "):[];R=i.displayString?i.displayString.split(" "):[];for(var T in R){var C="";if(R[T].startsWith("./")||R[T].startsWith("/")){C=s.getTermNameFromASTNodeReference(R[T])}if(C!==""){n=n+" "+C}else{var w=R[T].split("(");if(t.includes(g,w[0])&&c<h){R[T]=R[T].replace(i.JSON[c].dataObject,s.getTermNameFromASTNodeReference(i.JSON[c].dataObject));c++}n=n+" "+R[T]}}if(n!=""){i=n}}if(!u[e.getPath()]){u[e.getPath()]={headerValue:""}}this._internalModel.setProperty("/conditionCellAstValues",u);return i instanceof Object?i.shortRELString:i.trim()},_getMenuItems:function(){var e=[new R({text:this.oBundle.getText("insertFirst"),enabled:true,press:this._addNewRowWorkaround.bind(this,true)}),new R({text:this.oBundle.getText("insertAfter"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._addNewRowWorkaround.bind(this,false)})];return e},_getModel:function(){var e=this.getModelName();if(e){return this.getModel(e)}return this.getModel()},_getOutputColumnDescription:function(e,t){var a;if(this.getExpressionLanguage()){a=sap.ui.getCore().byId(this.getExpressionLanguage());if(a&&a._isDataExist()){var s=this.getBindingContext().getProperty("ResultDataObjectId");var i=a.getResultColumnDescription(e,s,t);return i}}return t?t:e},_getPasteMenuItems:function(){var e=[new R({text:this.oBundle.getText("pasteRowAction"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._rowAction.bind(this,"paste")}),new R({text:this.oBundle.getText("insertBeforeRowAction"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._rowAction.bind(this,"insertBefore")}),new R({text:this.oBundle.getText("insertAfterRowAction"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._rowAction.bind(this,"insertAfter")})];return e},_getRuleData:function(){var e=this.getBindingContextPath();var t=this._getModel();var a=jQuery.extend({},true,t.getProperty(e,null,true));var s=a.DecisionTable;s.DecisionTableColumns=this.dataBucket.columns;s.DecisionTableRows=this.dataBucket.rows;return a},_handleColumnsDataReceived:function(e){var t=e.getParameter("data");if(!t){return}var a=this.getAggregation("_table");if(t.results&&t.results.length>0){this._internalModel.setProperty("/newTable",false);a.setNoData(null);this._setExpressionLanguageVersionOnoData(false)}else{this._internalModel.setProperty("/newTable",true);var s=this._getBlankContent();a.setNoData(s);this._setExpressionLanguageVersionOnoData(true)}this.dataBucket[I.columns]=t;this._dataPartReceived(I.columns);this._handleHeaderSpan()},_handleColumnsDataRequested:function(e){this._dataPartRequested(I.columns)},_handleRowsDataReceived:function(e){var t=e.getParameter("data");if(t){if(this.dataBucket.collectRowsMode==="replace"){this.dataBucket[I.rows]=t;this.dataBucket.collectRowsMode="append"}else{var a=this.dataBucket[I.rows];var s={results:a.results?a.results.concat(t.results):t.results};this.dataBucket[I.rows]=s}this._dataPartReceived(I.rows)}this._setTableRows()},_handleRowsDataRequested:function(e){this._dataPartRequested(I.rows)},_handleRuleDataReceived:function(e){if(e){this._dataPartReceived(I.rule)}},_handleRuleDataRequested:function(){this._dataPartRequested(I.rule)},_handleVocabularyDataChanged:function(e){var t=e.getParameter("data");if(t){this._handleVocabularyDataReceived(t)}else{this._handleVocabularyDataRequested()}},_handleVocabularyDataReceived:function(e){if(e){this._dataPartReceived(I.vocabulary)}},_handleVocabularyDataRequested:function(){this._dataPartRequested(I.vocabulary)},_handleHeaderSpan:function(){if(!this.multiHeaderFlag){var e;this.multiHeaderFlag=true;var t=this.dataBucket.columns.results;this.iNumOfCondition=0;this.iNumOfResults=0;for(e=0;e<t.length;e++){if(t[e].Type===sap.rules.ui.DecisionTableColumn.Condition){this.iNumOfCondition++}else if(t[e].Type===sap.rules.ui.DecisionTableColumn.Result){this.iNumOfResults++}}var a=this.getAggregation("_table");t=a.getAggregation("columns");for(e=0;e<this.iNumOfCondition;e++){t[e].setHeaderSpan([this.iNumOfCondition,1])}for(;e<t.length;e++){t[e].setHeaderSpan([this.iNumOfResults,1])}}},_initDataBucket:function(){var e=false;var t;if(this.getAstExpressionLanguage()){t=sap.ui.getCore().byId(this.getAstExpressionLanguage())}else{t=sap.ui.getCore().byId(this.getExpressionLanguage())}if(t&&t._isDataExist()){e=true}this.dataBucket={dataReceived:{vocabulary:e,rule:false,rows:false,columns:false},rows:{},columns:{},collectRowsMode:"replace"}},_initDisplayModel:function(){this._displayModel=new sap.ui.model.json.JSONModel;this.setModel(this._displayModel,"displayModel");this._settingsModel=new sap.ui.model.json.JSONModel;this.setModel(this._settingsModel,"settingModel")},_initInternalModel:function(){var e={};e.editable=this.getEditable();e.newTable=true;e.sequenceExist=true;e.busyState=true;e.busyTableState=true;e.cellFormat=this.getCellFormat();e.hitPolicies=this.getHitPolicies();e.enableSettings=this.getEnableSettings();e.isAtLeastOneRowSelected=false;e.isExactlyOneRowSelected=false;e.isSelection=false;e.validationStatus={};e.valueState={};e.selectedRow=null;e.conditionCellAstValues=[];e.ruleBindingPath="";this._internalModel=new sap.ui.model.json.JSONModel(e);this.setModel(this._internalModel,"dtModel")},_isAllDataReceived:function(){var e=this.dataBucket.dataReceived;return e.rule&&e.rows&&e.columns&&e.vocabulary},_markSelection:function(e){var t=this.getLineActionBuffer().rowPath;var a=this.getAggregation("_table");var s=this._getModel();if(t){var i=a.getFirstVisibleRow();var n=s.getProperty(t).Sequence-1;if(n-i>-1&&n-i<a.getVisibleRowCount()){var r=a.getRows()[n-i];var o=r.getCells();if(o){for(var l=0;l<o.length;l++){if(e){o[l].addStyleClass("sapRULDecisionTableSCellMarked")}else{o[l].removeStyleClass("sapRULDecisionTableSCellMarked")}}}}}},_openTableSettings:function(){this.dataBucket.dataReceived.rows=false;var e=this._createDecisionTableSettings();var t=new u({contentWidth:"70%",contentHeight:"490px",title:this.oBundle.getText("tableSettings")});t.addContent(e);var a=e.getButtons(t);for(var s=0;s<a.length;s++){t.addButton(a[s])}t.attachBeforeClose(function(e){var a=t.getState();t.destroy();if(a===sap.ui.core.ValueState.Success){this._initDisplayModel();this._refreshBinding()}},this);this._closePopover();t.open()},_processValidationResults:function(e,t){if(e&&e.output){if(e.output.status==="Error"){var a=[];var s=this._internalModel.getProperty("/validationStatus");var i={};s=this._buildMessagesStructure(e,s,a);for(var n in s){if(s.hasOwnProperty(n)&&typeof s[n]==="string"&&s[n]!=="null"){i[n]=sap.ui.core.ValueState.Error}}this._displayErrorMessages(a,s);this._internalModel.setProperty("/validationStatus",s,null,true);this._internalModel.setProperty("/valueState",i,null,true)}var r=this._flatRule(e.output.decisionTableData);this._settingsModel.setData(e.output.decisionTableData);if(this.dataBucket.rows.results){this._settingsModel.rowLength=this.dataBucket.rows.results.length}this._displayModel.setData(r,true)}},_rowAction:function(e){this._rowActionWorkAround(e)},_rowActionWorkAround:function(e){var t=this._internalModel.getProperty("/selectedRow");this._markSelection(false);var a=this.getLineActionBuffer();this.setLineActionBuffer({rowPath:null,operation:null});var s=this.getAggregation("_table");var i=t+1;if(e==="insertAfter"){i++}var n=this._getModel();var r=n.getProperty(a.rowPath).Id;var o=n.getProperty(a.rowPath).RuleId;var l=n.getProperty(a.rowPath).Version;this._internalModel.setProperty("/busyState",true);var d=a.operation==="cut";if(e==="paste"){this._callCopyRuleRow(o,l,r,i,d,true)}else{this._callCopyRuleRow(o,l,r,i,d,false)}s.setSelectedIndex(-1);if(e==="insertBefore"||e==="insertAfter"){sap.m.MessageToast.show(this.oBundle.getText("addRowSuccess"))}if(e==="paste"){sap.m.MessageToast.show(this.oBundle.getText("pasteSuccess"))}},_refreshBinding:function(){var e=this.getAggregation("_table");var t=this.getElementBinding();if(t){t.refresh()}var a=e.getBinding("columns");if(a){a.refresh()}var s=e.getBinding("rows");if(s){s.refresh()}var i=sap.ui.getCore().getEventBus();i.publish("sap.ui.rules","refreshDTRuleModel")},_rowSelectionChange:function(){var e=this.getAggregation("_table");var t=[];if(e){t=e.getSelectedIndices()}if(t.length>0){this._internalModel.setProperty("/isAtLeastOneRowSelected",true);this._internalModel.setProperty("/selectedRow",t[0])}else{this._internalModel.setProperty("/isAtLeastOneRowSelected",false)}if(t.length==1){this._internalModel.setProperty("/isExactlyOneRowSelected",true)}else{this._internalModel.setProperty("/isExactlyOneRowSelected",false)}if(this.getLineActionBuffer().rowPath){this._internalModel.setProperty("/isSelection",true)}else{this._internalModel.setProperty("/isSelection",false)}},_setDataLoadedPromise:function(){if(!this._dataLoaded||this._dataLoaded.state()!=="pending"){this._dataLoaded=new jQuery.Deferred}},_setExpressionLanguageVersionOnoData:function(e){var t=this._getModel();var a=this.getBindingContext();var s="1.0.0";if(e){var i;if(this.getAstExpressionLanguage()){i=sap.ui.getCore().byId(this.getAstExpressionLanguage());s="2.0.0"}else{i=sap.ui.getCore().byId(this.getExpressionLanguage());s=i.getExpressionLanguageVersion()}t.setProperty("ExpressionLanguageVersion",s,a,true)}else{s=t.getProperty(this.getBindingContextPath()+"/ExpressionLanguageVersion");if(!s){s="1.0.0"}}this._decisionTableCellFormatter.setExpressionLanguageVersion(s)},_setTableRows:function(){var e=this.getAggregation("_table");var t=e.getBinding("rows");var a=A;if(t&&t.getLength()){a=Math.min(t.getLength(),this.VISIBLEROWCOUNT)}var s=e.getVisibleRowCount();if(s!==a){e.setVisibleRowCount(a)}if(this.dataBucket&&this.dataBucket.rows&&this.dataBucket.rows.results.length===0||!this.getEditable()){e.setSelectionMode(sap.ui.table.SelectionMode.None)}else{e.setSelectionMode(sap.ui.table.SelectionMode.MultiToggle)}},_unbindColumns:function(){var e=this.getAggregation("_table");e.unbindColumns()},_unbindRows:function(){var e=this.getAggregation("_table");e.unbindRows()},_unbindRule:function(){this.unbindElement()},_updateBusyState:function(){var e=this.dataBucket.dataReceived;var t=e.rule&&e.columns&&e.vocabulary;var a=!t;this._internalModel.setProperty("/busyState",a);var s=!e.rows;this._internalModel.setProperty("/busyTableState",s)},_updateTableCell:function(e,t,a,s){e.removeStyleClass("sapRULDecisionTableSCellMarked");var i="null";var n=this;var r=this.getParent();if(t){var o=e.data("colId");var l=t.getProperty("Id");var d=t.getProperty("RuleId");var u=t.getProperty("Version");var c=t.getModel();var h="";var g="";var p={RuleId:d,ColId:o,RowId:l,Version:u};var f=c.createKey("/DecisionTableRowCells",p);var b=new sap.ui.model.Context(c,f);var v={RuleId:d,Id:o,Version:u};var _=c.createKey("/DecisionTableColumnConditions",v);var m=r.getModel("dtModel").getData().conditionCellAstValues;var y={RuleId:d,Id:o,Version:u};var R={Id:d,Version:u};i=f+"/Content";switch(e.data("colType")){case"CONDITION":h="/"+c.createKey("DecisionTableColumnConditions",y);g="/"+c.createKey("Rules",R);e.setHeaderValuePath(h+"/Expression");e.setFixedOperatorPath(h+"/FixedOperator");e.setRuleFormatPath(g+"/RuleFormat");e.setDecisionTableFormat(n.getParent().getDecisionTableFormat());e.setValueOnlyPath(h+"/ValueOnly");if(m[_]){e.setHeaderInfo(m[_])}break;case"RESULT":h="/"+c.createKey("DecisionTableColumnResults",y);g="/"+c.createKey("Rules",R);e.setTypePath(h+"/BusinessDataType");if(sap.ui.getCore().byId(r.getAstExpressionLanguage())){var T=r.getModel("settingModel").getData().ResultDataObjectId;var C=c.getProperty(h+"/DataObjectAttributeId");e.setAttributeInfoPath("/"+T+"/"+n.getParent()._formatAttributeId(C))}else{e.setAttributeInfoPath(h+"/DataObjectAttributeId")}e.setAttributeNamePath(h+"/DataObjectAttributeName");e.setRuleFormatPath(g+"/RuleFormat");e.setDecisionTableFormat(n.getParent().getDecisionTableFormat());break;default:break}e.setKeyProperties(p);e.setValueStateTextPath("dtModel>/validationStatus/"+"RowId="+l+",ColId="+o);e.setValueStatePath("dtModel>/valueState/"+"RowId="+l+",ColId="+o)}e.setValuePath(i)},_formatAttributeId:function(e){var t=e;if(t&&t.indexOf(":")>-1){t=t.replace(/:/g,"/")}return t},exit:function(){var e=this.oMenu;if(e){e.destroy()}},init:function(){this.multiHeaderFlag=false;this.resetContent=true;this.astUtil=new D;this._initInternalModel();this._initDisplayModel();this._initDataBucket();this.bindProperty("busy","dtModel>/busyState");this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this._addToolBar();this._addTable();this._addErrorLabel();this._decisionTableCellFormatter=new M;this.setBusyIndicatorDelay(0)},isSequenceExistsInOdataMetadata:function(){var e=this.getModel();if(e){var t=e.getServiceMetadata();if(t){var a=t.dataServices.schema[0].entityType;var s;var i;var n;for(var r=0;r<a.length;r++){s=a[r];if(s.name!=="DecisionTableColumn"){continue}i=s.property;for(var o=0;o<i.length;o++){n=i[o];if(n.name==="Sequence"){return true}}}}}return false},onBeforeRendering:function(){if(this.resetContent){this.resetControl();this.resetContent=false}},resetControl:function(){this._unbindRule();this._unbindRows();this._unbindColumns();this._clearErrorMessages();this._initDataBucket();this._initDisplayModel();this._updateBusyState();var e=this._getModel();var t=this.getBindingContextPath();if(!t||!e){return}var a=new sap.ui.model.Context(e,t);this._internalModel.setProperty("/ruleBindingPath",t);this.setBindingContext(a);this._bindRule();this._bindRows();this._bindColumns()},setAstExpressionLanguage:function(e){this.setAssociation("astExpressionLanguage",e,true);var t=e instanceof Object?e:sap.ui.getCore().byId(e);if(!t){return this}var a=this.getAggregation("_table");if(a){var s=a.getBinding("columns");if(s){s.refresh()}}if(t._isDataExist()){var i=new sap.ui.base.Event("","",{data:true});this._handleVocabularyDataChanged(i)}t.attachDataChange(this._handleVocabularyDataChanged.bind(this));return this},setBindingContextPath:function(e){var t=this.getBindingContextPath();if(e&&t!==e){this._unbindRule();this._unbindRows();this._unbindColumns();this.setProperty("bindingContextPath",e);this.resetContent=true;this._initDataBucket();var a=this.getModel();if(!a.isMetadataLoadingFailed()){if(a.getServiceMetadata()){this._internalModel.setProperty("/sequenceExist",this.isSequenceExistsInOdataMetadata())}else{a.attachMetadataLoaded(function(){this._internalModel.setProperty("/sequenceExist",this.isSequenceExistsInOdataMetadata())}.bind(this))}}}return this},setCellFormat:function(e){this.setProperty("cellFormat",e,true);this._internalModel.setProperty("/cellFormat",e);return this},setEditable:function(e){this.setProperty("editable",e,true);this._internalModel.setProperty("/editable",e);this._internalModel.setProperty("/sequenceExist",this.isSequenceExistsInOdataMetadata());var t=this.getAggregation("_table");var a=this.getAggregation("_toolbar");if(e===false){t.addStyleClass("sapRULDecisionTableEdit");a.removeStyleClass("sapRULDecisionTableToolBar")}else{t.removeStyleClass("sapRULDecisionTableEdit");a.addStyleClass("sapRULDecisionTableToolBar")}if(e===false){this._clearErrorMessages()}return this},setEnableSettings:function(e){this.setProperty("enableSettings",e,true);this._internalModel.setProperty("/enableSettings",e);return this},setEnableSettingResult:function(e){this.setProperty("enableSettingResult",e,true);return this},setExpressionLanguage:function(e){this.setAssociation("expressionLanguage",e,true);this._decisionTableCellFormatter.setExpressionLanguage(this.getExpressionLanguage());var t=e instanceof Object?e:sap.ui.getCore().byId(e);if(!t){return this}var a=this.getAggregation("_table");if(a){var s=a.getBinding("columns");if(s){s.refresh()}}if(t._isDataExist()){var i=new sap.ui.base.Event("","",{data:true});this._handleVocabularyDataChanged(i)}t.attachDataChange(this._handleVocabularyDataChanged.bind(this));return this},setHitPolicies:function(e){this.setProperty("hitPolicies",e,true);this._internalModel.setProperty("/hitPolicies",e);return this},setModelName:function(e){this.setProperty("modelName",e);this.resetContent=true;return this},renderer:B});sap.rules.ui.DecisionTable.prototype._saveWorkAround=function(e,t){var a=this._getModel();a.submitChanges(e);sap.m.MessageToast.show(t)};sap.rules.ui.DecisionTable.prototype.includes=function(e,t){var a=false;if(e.indexOf(t)!==-1){a=true}return a};sap.rules.ui.DecisionTable.prototype._getLocaleData=function(){var e=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();return P.getInstance(e)};sap.rules.ui.DecisionTable.prototype._getDateFormatter=function(){var e=this._getLocaleData();var t=e.getDatePattern("medium");var a=sap.ui.core.format.DateFormat.getDateInstance({pattern:t});return a};sap.rules.ui.DecisionTable.prototype._getDateTimeFormatter=function(){var e=this._getLocaleData();var t=e.getDatePattern("medium");var a=e.getTimePattern("medium");var s=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:t+" "+a});return s};sap.rules.ui.DecisionTable.prototype.VISIBLEROWCOUNT=30;sap.rules.ui.DecisionTable.prototype.THRESHOLD=30;return O},true);
//# sourceMappingURL=DecisionTable.js.map
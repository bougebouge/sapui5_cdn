/*
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/library","sap/ui/comp/library","sap/ui/model/BindingMode","sap/ui/comp/util/FormatUtil","sap/ui/comp/providers/ValueHelpProvider","sap/ui/comp/providers/ValueListProvider","sap/ui/comp/smartfield/BindingUtil","sap/ui/comp/odata/MetadataAnalyser","sap/m/HBox","sap/base/Log","sap/base/strings/capitalize","sap/ui/comp/smartfilterbar/SmartFilterBar"],function(t,e,a,i,o,n,r,s,l,d,u,p,g){"use strict";var f=a.smartfield.ControlContextType;var h=e.ValueState;var c=t.extend("sap.ui.comp.smartfield.ControlFactoryBase",{constructor:function(e,a){t.apply(this,arguments);this.sName="ControlFactoryBase";this._oModel=e;this._oParent=a;this._oBinding=new s;this._aProviders=[];this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp")}});c.prototype.bind=function(){return Promise.resolve()};c.prototype.createControl=function(t){var e,a;e=this._getCreator(t);if(e){a=this[e](t);this._addAriaLabelledBy(a);this._addAriaDescribedBy(a);if(a&&a.onCreate){this[a.onCreate](a.control,a.params)}}return a};c.prototype.updateControl=function(t){var e,a=t.mode,i=this._oParent,o=i.data("configdata");if(o&&o.configdata){e=i.getFirstInnerControl();if(o.configdata.onText&&a==="display"){o.configdata.onText(e)}else if(o.configdata.onInput&&a==="edit"){o.configdata.onInput(e)}}};c.prototype._addAriaLabelledBy=function(t){var e=this._getTargetControlForAccAttributes(t),a=this._oParent.getAriaLabelledBy();if(e&&e.addAriaLabelledBy&&a.length>0){e.removeAllAriaLabelledBy();a.forEach(function(t){e.addAriaLabelledBy(t)})}};c.prototype._addAriaDescribedBy=function(t){var e=this._getTargetControlForAccAttributes(t),a=this._oParent.getAriaDescribedBy();if(e&&e.addAriaDescribedBy&&a.length>0){e.removeAllAriaDescribedBy();a.forEach(function(t){e.addAriaDescribedBy(t)})}};c.prototype._getTargetControlForAccAttributes=function(t){var e,a=this._oParent.getControlContext();if(a===f.None||a===f.Form||a===f.SmartFormGrid){if(t){e=t.control;if(e instanceof d){if(e.getItems().length>0){e=e.getItems()[0]}}}}return e};c.prototype.addValidations=function(t,e){var a,i,o=this;a=function(t,a){var i,n,r=a.getParameter("targetControl")||a.getSource();if(r){if(r.setValueState){r.setValueState(t)}n=a.getParameter("exception");if(n){i=n.message}if(!i){i=a.getParameter("message")}if(r.setValueStateText){r.setValueStateText(i)}}if(e){o._oParent[e](t===h.Error)}};i=function(t){a(h.Error,t)};t.attachFormatError(i);t.attachParseError(i);t.attachValidationError(i);t.attachValidationSuccess(function(t){o._oParent.onValidation(t);a(h.None,t)})};c.prototype._isInnerUoM=function(){var t=this.getCustomDataConfiguration();return t&&t.isUOM&&t.isInnerControl};c.prototype._getDisplayBehaviourConfiguration=function(t){var e=null,a=this._oParent._getComputedTextInEditModeSource()==="ValueListNoValidation";var i=this._oParent.getConfiguration();if(i){e=i.getDisplayBehaviour()}if(!e&&this._oMetaData&&this._oMetaData.entityType){e=this._oHelper.oAnnotation.getTextArrangement(this._oMetaData.property.property,this._oMetaData.entityType,a)}if(!e){e=this._oParent.data(t?t:"defaultInputFieldDisplayBehaviour")}return e};c.prototype._getPreventInitialDataFetchInVHDialog=function(t){var e=this._oParent.getConfiguration();if(e&&!e.isPropertyInitial("preventInitialDataFetchInValueHelpDialog")){return e.getPreventInitialDataFetchInValueHelpDialog()}if(l.isValueList(t)&&t["com.sap.vocabularies.Common.v1.ValueList"]&&t["com.sap.vocabularies.Common.v1.ValueList"].FetchValues){return t["com.sap.vocabularies.Common.v1.ValueList"].FetchValues.Int!=="1"}return false};c.prototype._formatDisplayBehaviour=function(t,e,a){var i=this._getDisplayBehaviourConfiguration(t);if(t==="defaultCheckBoxDisplayBehaviour"){return this._getFormattedExpressionFromDisplayBehaviour(i,e)}if(t==="defaultComboBoxReadOnlyDisplayBehaviour"&&!i){i="descriptionAndId"}return o.getFormattedExpressionFromDisplayBehaviour(i||"idOnly",e,a)};c.prototype._getFormattedExpressionFromDisplayBehaviour=function(t,e){var a="";switch(t){case"OnOff":a=e?"SMARTFIELD_CB_ON":"SMARTFIELD_CB_OFF";break;case"TrueFalse":a=e?"SMARTFIELD_CB_TRUE":"SMARTFIELD_CB_FALSE";break;default:a=e?"SMARTFIELD_CB_YES":"SMARTFIELD_CB_NO";break}return this._oRb.getText(a)};c.prototype.getDropdownItemKeyType=function(){};c.prototype.getValueStateBindingInfoForRecommendationStateAnnotation=function(){};c.prototype.createValueHelp=function(t){var e,a=this.getCustomDataConfiguration(),i=this._isInnerUoM()?a&&a.smartFieldRootControl:this._oParent,o=t.edmProperty,s=t.valueHelp;if(s.annotation&&(o["sap:value-list"]||o["com.sap.vocabularies.Common.v1.ValueList"])){var l=s.displayBehaviour||this._getDisplayBehaviourConfiguration("defaultDropDownDisplayBehaviour"),d=this._oParent.data("dateFormatSettings"),u=this._getPreventInitialDataFetchInVHDialog(o);if(typeof d==="string"){try{d=JSON.parse(d)}catch(t){}}var p,f,h,c,y,m,_;if(typeof s.annotation==="string"){f=s.annotation}else if(s&&typeof s.annotation==="object"){if(a){h=a.annotations;if(h&&h.valuelist&&typeof h.valuelist==="string"){f=h.valuelist}}c=h&&(h.valueListData&&h.valueListData.annotation||h.valuelist);p=s.analyser.getValueListAnnotationForFunctionImport({"":c||s.annotation},o.name).primaryValueListAnnotation}var v=t.control,P=t.model,A=t.onValueListChange;if(!s.noDialog){if(v.setFilterSuggests){v.setFilterSuggests(false)}if(i){if(i.isContextTable&&i.isContextTable()){_=i.data("configdata")&&i.data("configdata").configdata;if(_){y=_.defaultFilterBarExpanded;m=_.defaultShowAllFilters}}else{y=i.data("defaultFilterBarExpanded");m=i.data("defaultShowAllFilters")}}var B=new n({context:"SmartField",fnAsyncWritePromise:this._oParent._isAsync&&this._oParent._isAsync()?this._oParent.checkValuesValidity.bind(this._oParent):null,selectedODataRowHandler:this._selectedODataRowHandler.bind(this),fieldName:o.name,control:v,model:P,dateFormatSettings:d,displayBehaviour:l,loadAnnotation:true,fullyQualifiedFieldName:f,metadataAnalyser:s.analyser,annotation:p,title:s.dialogtitle,preventInitialDataFetchInValueHelpDialog:u,supportMultiSelect:!!s.supportMultiSelect,supportRanges:!!s.supportRanges,takeOverInputValue:true,type:s.type,maxLength:o.maxLength,filterBarClass:g,defaultFilterBarExpanded:y,defaultShowAllFilters:m});if(A){B.attachValueListChanged(A)}this._aProviders.push(B);if(v.setShowValueHelp){v.setShowValueHelp(true)}}var b=true,D=true;if(this._oParent._getHistoryEnabled){b=this._oParent._getHistoryEnabled();D=this._oParent.isPropertyInitial("historyEnabled")}if(!s.noTypeAhead||!v.isA("sap.m.Input")){e={control:v,model:P,dateFormatSettings:d,displayBehaviour:l,fieldViewMetadata:o,loadAnnotation:true,fullyQualifiedFieldName:f,metadataAnalyser:s.analyser,annotation:p,aggregation:s.aggregation,typeAheadEnabled:!s.noTypeAhead,dropdownItemKeyType:this.getDropdownItemKeyType(v),maxLength:o.maxLength,fieldHistoryEnabled:b,fieldHistoryEnabledInitial:D};var F=new r(this.getValueListProviderConfiguration(e));if(!s.noTypeAhead){if(v.setShowSuggestion){v.setShowSuggestion(true)}}if(A){F.attachValueListChanged(A)}this._aProviders.push(F)}}};c.prototype.getValueListProviderConfiguration=function(t){return{context:"SmartField",fnAsyncWritePromise:this._oParent._isAsync&&this._oParent._isAsync()?this._oParent.checkValuesValidity.bind(this._oParent):null,selectedODataRowHandler:this._selectedODataRowHandler.bind(this),control:t.control,model:t.model,dateFormatSettings:t.dateFormatSettings,displayBehaviour:t.displayBehaviour,fieldViewMetadata:t.fieldViewMetadata,loadAnnotation:true,fullyQualifiedFieldName:t.fullyQualifiedFieldName,metadataAnalyser:t.metadataAnalyser,annotation:t.annotation,aggregation:t.aggregation,typeAheadEnabled:t.typeAheadEnabled,dropdownItemKeyType:t.dropdownItemKeyType,maxLength:t.maxLength,fieldHistoryEnabled:t.fieldHistoryEnabled,fieldHistoryEnabledInitial:t.fieldHistoryEnabledInitial}};c.prototype._selectedODataRowHandler=function(t,e,a){if(this.oTextArrangementDelegate){this.oTextArrangementDelegate.setDataForNextDescriptionRequest(t,e);this.oTextArrangementDelegate.setAbsolutePathToVLProperty(a)}};c.prototype.getAttribute=function(t){var e=this._oParent.getBindingInfo(t);if(e){return this._oBinding.toBindingPath(e)}return this._oParent["get"+t.substring(0,1).toUpperCase()+t.substring(1)]()};c.prototype.getCustomDataConfiguration=function(){var t=this._oParent&&this._oParent.data&&this._oParent.data("configdata");return t&&t.configdata?t.configdata:null};c.prototype.createAttributes=function(t,e,a,i){var o=this,n,r={};for(var s in a){if(a.hasOwnProperty(s)){var l=this._oParent.getBindingInfo(s);if(l){r[s]=this._oBinding.toBinding(l)}else if(s==="valueState"&&this._oParent.isPropertyInitial("valueState")){l=this.getValueStateBindingInfoForRecommendationStateAnnotation();if(l){r[s]=l}else{r[s]=this._oParent["get"+p(s)]()}}else{r[s]=this._oParent["get"+p(s)]()}}}if(t){if(e&&e.property&&e.property.type==="Edm.String"&&!this._oParent.getClientSideMandatoryCheck()){n={parseKeepsEmptyString:true}}r[t]={model:this._oMetaData.model,path:this._oMetaData.path,type:e?this._oTypes.getType(e,n):null,mode:this._oParent.getBindingMode("value")}}if(i){r[i.event]=function(t){try{var e=t.getParameters();var a={value:e[i.parameter],newValue:e[i.parameter]};o._oParent.fireChange(a)}catch(t){u.warning(t)}}}return r};c.prototype.mapBindings=function(t,e,a){var i,o;for(i in e){o=this._oParent.getBindingInfo(i);if(o){t[e[i]]=this._oBinding.toBinding(o)}else{t[e[i]]=a&&a[e[i]]||this._oParent["get"+i.substring(0,1).toUpperCase()+i.substring(1)]()}}};c.prototype.getFormatSettings=function(t){var e=null,a,i,o;if(t){e=this._oParent.data(t);if(!e){a=this._oParent.getCustomData();if(a){o=a.length;while(o--){i=a[o];if(i.getKey()===t){e=i.getValue();break}}}}if(e&&typeof e==="string"){try{e=JSON.parse(e)}catch(t){return null}}}return e};c.prototype.getValueListProvider=function(){return this._aProviders.find(function(t){return t.isA("sap.ui.comp.providers.ValueListProvider")})};c.prototype.destroyValueHelp=function(){this._aProviders.forEach(function(t){t.destroy()});this._aProviders=[]};c.prototype.destroy=function(){this.destroyValueHelp();if(this._oBinding){this._oBinding.destroy()}this._oBinding=null;this._oParent=null;this._oModel=null;this._oRb=null};return c},true);
//# sourceMappingURL=ControlFactoryBase.js.map
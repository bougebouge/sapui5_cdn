/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/registry/Settings","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Storage","sap/ui/fl/Utils","sap/ui/fl/write/api/Version","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode"],function(e,r,t,n,i,s,a){"use strict";var o={};var f=9;var l=f+1;function u(e,r){if(r!==i.Number.Original&&r!==i.Number.Draft){return e.some(function(e){return e.version===r&&e.isPublished===false})}return false}function d(e,r){var t=p(r);var o=[];var l=i.Number.Original;return n.getUShellService("URLParsing").then(function(d){var c=n.getParameter(i.UrlParameter,d);if(!c){if(r.length>0){c=r[0].version}else{c=i.Number.Original}}r.forEach(function(e){if(e.version===i.Number.Draft){e.type=i.Type.Draft;e.isPublished=false;o=e.filenames}else{if(l===i.Number.Original){e.type=i.Type.Active;l=e.version}else{e.type=i.Type.Inactive}}});var v=new s({publishVersionEnabled:u(r,c),versioningEnabled:e,versions:r,activeVersion:l,backendDraft:t,dirtyChanges:false,draftAvailable:t,activateEnabled:t,persistedVersion:c,displayedVersion:c,draftFilenames:o});v.setDefaultBindingMode(a.OneWay);v.setSizeLimit(f);v.setDirtyChanges=function(e){v.setProperty("/dirtyChanges",e);v.updateDraftVersion();v.updateBindings(true)};v.updateDraftVersion=function(){var e=v.getProperty("/versions");var r=v.getProperty("/versioningEnabled");var t=v.getProperty("/dirtyChanges");var n=v.getProperty("/backendDraft");var s=r&&(t||n);v.setProperty("/draftAvailable",s);if(t){v.setProperty("/displayedVersion",i.Number.Draft)}if(!p(e)&&s){e.splice(0,0,{version:i.Number.Draft,type:i.Type.Draft,filenames:[],isPublished:false})}if(p(e)&&!s){e.shift();v.setProperty("/displayedVersion",v.getProperty("/persistedVersion"))}var a=v.getProperty("/displayedVersion")!==v.getProperty("/activeVersion");v.setProperty("/activateEnabled",a)};return v})}function c(e,r){var t=[];var n=r.changePersistences;n.forEach(function(e){t=e.getDirtyChanges().concat();t.forEach(function(r){e.deleteChange(r,true)})});return t.length>0}function v(e){var t={dirtyChangesExist:false,changePersistences:[]};if(e.reference){var n=r.getChangePersistenceForComponent(e.reference);if(n.getDirtyChanges().length>0){t.dirtyChangesExist=true;t.changePersistences.push(n)}}if(e.nonNormalizedReference){var i=r.getChangePersistenceForComponent(e.nonNormalizedReference);if(i.getDirtyChanges().length>0){t.dirtyChangesExist=true;t.changePersistences.push(i)}}return t}function p(e){return e.some(function(e){return e.version===i.Number.Draft})}var y={};y.initialize=function(r){var n=r.reference;var i=r.layer;r.limit=l;return e.getInstance().then(function(e){var s=e.isVersioningEnabled(i);var a=s?t.versions.load(r):Promise.resolve([]);return a.then(function(e){return d(s,e)}).then(function(e){o[n]=o[n]||{};o[n][i]=o[n][i]||{};o[n][i]=e;return o[n][i]})})};y.getVersionsModel=function(e){var r=e.reference;var t=e.layer;if(!y.hasVersionsModel(e)){throw Error("Versions Model for reference '"+r+"' and layer '"+t+"' were not initialized.")}var n=v(e);if(n.dirtyChangesExist){o[r][t].updateDraftVersion(e)}return o[r][t]};y.hasVersionsModel=function(e){var r=e.reference;var t=e.layer;return o[r]&&o[r][t]};y.clearInstances=function(){o={}};y.onAllChangesSaved=function(e){e.reference=n.normalizeReference(e.reference);var r=y.getVersionsModel(e);var t=r.getProperty("/versioningEnabled");var s=r.getProperty("/dirtyChanges");r.setProperty("/dirtyChanges",true);r.setProperty("/backendDraft",t&&s);r.setProperty("/persistedVersion",i.Number.Draft);r.updateDraftVersion()};y.activate=function(e){var r=y.getVersionsModel(e);var n=r.getProperty("/versions");var s=p(n);var a=r.getProperty("/activeVersion");if(e.displayedVersion===a){return Promise.reject("Version is already active")}e.version=e.displayedVersion;var o=v(e);var f=o.changePersistences;var l=f.some(function(e){return e.getDirtyChanges().length>0});if(l){return Promise.reject("unsaved changes exists")}return t.versions.activate(e).then(function(e){n.forEach(function(e){e.type=i.Type.Inactive});e.type=i.Type.Active;e.isPublished=false;if(s){n.shift()}n.splice(0,0,e);r.setProperty("/publishVersionEnabled",true);r.setProperty("/backendDraft",false);r.setProperty("/dirtyChanges",false);r.setProperty("/draftAvailable",false);r.setProperty("/publishVersionEnabled",true);r.setProperty("/activateEnabled",false);r.setProperty("/activeVersion",e.version);r.setProperty("/displayedVersion",e.version);r.setProperty("/persistedVersion",e.version);r.updateBindings(true)})};y.discardDraft=function(e){var r=y.getVersionsModel(e);var n=r.getProperty("/versions");var i=v(e);var s=r.getProperty("/backendDraft");var a=s?t.versions.discardDraft(e):Promise.resolve();return a.then(function(){n.shift();r.setProperty("/backendDraft",false);r.setProperty("/dirtyChanges",false);r.setProperty("/draftAvailable",false);r.setProperty("/activateEnabled",false);r.setProperty("/displayedVersion",r.getProperty("/persistedVersion"));r.updateBindings(true);var t=c(e,i);return{backendChangesDiscarded:s,dirtyChangesDiscarded:t}})};y.publish=function(e){var r=y.getVersionsModel({reference:n.normalizeReference(e.reference),layer:e.layer});return t.versions.publish(e).then(function(t){if(t!=="Error"&&t!=="Cancel"){r.setProperty("/publishVersionEnabled",false);var n=r.getProperty("/versions");var i=false;n.forEach(function(r){if(r.isPublished){return}if(r.version===e.version){i=true}if(i&&!r.isPublished){r.isPublished=true}})}return t})};return y});
//# sourceMappingURL=Versions.js.map
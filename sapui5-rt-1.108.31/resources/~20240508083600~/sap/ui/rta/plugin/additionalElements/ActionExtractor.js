/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_difference","sap/base/util/merge","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/ui/rta/plugin/additionalElements/AdditionalElementsUtils","sap/ui/rta/Utils"],function(e,t,n,a,r,i,o,l,g){"use strict";var s={};function u(){var e=[];var t=o.getKnownDefaultDelegateLibraries();t.forEach(function(t){var a=sap.ui.getCore().loadLibrary(t,{async:true}).then(function(){return Promise.resolve(t)}).catch(function(e){n.warning("Required library not available: ",e);return Promise.resolve()});e.push(a)});return Promise.all(e)}function d(e,t,n){return n.hasChangeHandler(e.changeType,e.element).then(function(n){if(n){return{aggregationName:e.aggregation,addPropertyActionData:{designTimeMetadata:t,action:e,delegateInfo:{payload:e.delegateInfo.payload||{},delegate:e.delegateInfo.instance,modelType:e.delegateInfo.modelType,requiredLibraries:e.delegateInfo.requiredLibraries,delegateType:e.delegateInfo.delegateType}}}}return undefined})}function c(e,t,a){var r=l.getParents(e,t,a);var i=r.parentOverlay&&r.parentOverlay.getDesignTimeMetadata();var o=i?i.getActionDataFromAggregations("addODataProperty",r.parent):[];if(o.length>0){n.error("Outdated addODataProperty action in designtime metadata in "+i.getData().designtimeModule+" or propagated or via instance specific designtime metadata.")}var g=i?i.getActionDataFromAggregations("add",r.parent):[];g.forEach(function(e){if(e["custom"]){n.error("Outdated custom add action in designtime metadata in "+i.getData().designtimeModule+" or propagated or via instance specific designtime metadata.")}})}function f(e,t,n){var a=e.getElement();if(!a){return[]}var o=r.getAggregation(a,t,n).filter(function(t){var a=i.getOverlay(t);if(!n.hasStableId(a)){return false}var r=e.getRelevantContainer(true);var o=i.getOverlay(r);var l=e;var g=false;do{g=!l.getElementVisibility();if(g){break}if(l===o){break}else{l=l.getParentElementOverlay()}}while(l);if(g){return true}return a.getElementVisibility()===false},this);return o.map(function(e){return{element:e,sourceAggregation:t}})}function v(e,t){return t.sParentAggregationName}function m(e,t,n,a){var r=n.changeType&&a.hasStableId(e);if(r&&e!==t.relevantContainerOverlay){r=a.hasStableId(t.relevantContainerOverlay)}return r}function p(t,n,r,l){function g(t,g){var s=g.changeOnRelevantContainer?n.relevantContainer:n.parent;var u=i.getOverlay(s);var d=m(u,n,g,r);if(d){g.element=s;return o.getDelegateForControl({control:n.relevantContainer,modifier:a,supportsDefault:g.supportsDefaultDelegate}).then(function(a){if(a&&a.names&&a.names.length&&a.delegateType===o.types.COMPLETE){var r=o.getRequiredLibrariesForDefaultDelegate({delegateName:a.names,control:n.relevantContainer});if(e(r,l.filter(Boolean)).length===0){g.delegateInfo=a;t.push(g)}}return t})}return t}return t.reduce(function(e,t){return e.then(function(e){return g(e,t)})},Promise.resolve([]))}function h(e,t,n,a,r){var i=e.reduce(function(e,t){var n=[];a.forEach(function(e){n=n.concat(f.call(this,t,e,r))}.bind(this),[]);return t?e.concat(n):e}.bind(this),[]);var o={elements:[],controlTypeNames:[]};var l=i.reduce(function(e,t){return e.then(function(e){return y(e,t,r,n)})},Promise.resolve(o));return l.then(function(e){if(e.elements.length>0){t[n]={reveal:e}}return t})}function y(e,t,n,a){var o=t.element;var s;var u;var d=false;var c=Promise.resolve(false);var f=t.sourceAggregation;var m=i.getOverlay(o);if(m){s=m.getDesignTimeMetadata();u=s&&s.getAction("reveal",o);if(u&&u.changeType){var p=o;if(u.changeOnRelevantContainer){p=m.getRelevantContainer()}c=n.hasChangeHandler(u.changeType,p).then(function(e){if(r.isElementValid(o)){var t=l.getParents(true,m,n);if(e){if(u.changeOnRelevantContainer){d=n.hasStableId(t.relevantContainerOverlay)&&n.hasStableId(t.parentOverlay)}else{d=true}if(!u.getAggregationName){u.getAggregationName=v}if(d&&f!==a){var i=t.parentOverlay.getAggregationOverlay(a);return g.checkTargetZone(i,m,n)}}}return d})}}return c.then(function(t){if(t){e.elements.push({element:o,designTimeMetadata:s,action:u,sourceAggregation:f,targetAggregation:a});var n=s.getName(o);if(n){e.controlTypeNames.push(n)}}return e})}s.getActions=function(e,n,a,r,i){var o=e?"asSibling":"asChild";if(!r&&n._mAddActions){return Promise.resolve(n._mAddActions[o])}var l=this._getRevealActions(e,n,a,i);var g=this._getAddViaDelegateActions(e,n,a);return Promise.all([l,g,c(e,n,a)]).then(function(e){var a=t(e[0],e[1]);n._mAddActions=n._mAddActions||{asSibling:{},asChild:{}};n._mAddActions[o]=a;return a})};s.getActionsOrUndef=function(e,t){var n=e?"asSibling":"asChild";return t._mAddActions&&t._mAddActions[n]};var A={};var O=true;s._getRevealActions=function(e,t,n,a){if(O){O=false;a.attachEventOnce("synced",function(){A={};O=true},this)}var o=l.getParents(e,t,n);var g=[o.parentOverlay];if(o.relevantContainer!==o.parent){g=r.findAllSiblingsInContainer(o.parent,o.relevantContainer).map(function(e){return i.getOverlay(e)}).filter(function(e){return e})}var s=[];if(o.parentOverlay){var u=A[o.parentOverlay.getId()];if(u&&e){return u}s=o.parentOverlay.getAggregationOverlays().filter(function(e){return!e.getDesignTimeMetadata().isIgnored(o.parent)}).map(function(e){return e.getAggregationName()});return s.reduce(function(e,t){return e.then(function(e){return h(g,e,t,s,n)})},Promise.resolve({})).then(function(t){if(e){A[o.parentOverlay.getId()]=t}return t})}return Promise.resolve({})};s._getAddViaDelegateActions=function(e,t,n){var a=l.getParents(e,t,n);var r=a.parentOverlay&&a.parentOverlay.getDesignTimeMetadata();return Promise.resolve().then(function(){var e=r?r.getActionDataFromAggregations("add",a.parent,undefined,"delegate"):[];if(e.length){return u().then(p.bind(this,e,a,n))}return[]}.bind(this)).then(function(e){return e.reduce(function(e,t){return e.then(function(e){return d.call(this,t,r,n).then(function(t){if(t){t.addPropertyActionData.relevantContainer=a.relevantContainer;if(!e[t.aggregationName]){e[t.aggregationName]={}}e[t.aggregationName].addViaDelegate=t.addPropertyActionData}return e})}.bind(this))}.bind(this),Promise.resolve({}))}.bind(this))};return s});
//# sourceMappingURL=ActionExtractor.js.map
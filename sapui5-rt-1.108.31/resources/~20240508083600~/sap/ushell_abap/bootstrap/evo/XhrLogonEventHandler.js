// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["./abap.bootstrap.utils","sap/base/util/ObjectPath","sap/base/Log"],function(e,o,t){"use strict";var i="sap-ushell-reloaded";function a(e,o){this._oWindow=e||window;this._sXhrLogonMode=o;this._bPending=false}a.prototype.handleEvent=function(e){if(this._bPending){return true}if(e.type==="logon"){this._bPending=true;if(this._sXhrLogonMode==="logoffAndRedirect"){this._showErrorAndReload({key:"bootstrap.xhr.authenticationRequired",text:"Authentication required"},{key:"bootstrap.xhr.sessionExpired",text:"Your session has expired. Press OK to reload."},this._logoffAndRedirect,this._handleAuthenticationRequiredNoUi5.bind(this))}else{this._showErrorAndReload({key:"bootstrap.xhr.authenticationRequired",text:"Authentication required"},{key:"bootstrap.xhr.sessionExpired",text:"Your session has expired. Press OK to reload."},this._reloadPage,this._handleAuthenticationRequiredNoUi5.bind(this))}}else{t.error("Cannot handle event with type: "+e.type,null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler")}return true};a.prototype._getUpdatedLocationSearchForReload=function(e){var o=Date.now(),t=new RegExp(["(.*)([?&])",i,"(=[^&]*)?(.*)"].join("")),a,s=false;if(typeof e!=="string"){throw new Error("Illegal argument: sCurrentLocationSearch must be a string")}a=e.replace(t,function(e,t,a,r,n){s=true;return[t,a,i,"=",o,n].join("")});if(!s){if(e){a=[e,"&",i,"=",o].join("")}else{a=["?",i,"=",o].join("")}}return a};a.prototype._reloadPage=function(){var e=this;e._oWindow.setTimeout(function(){e._oWindow.location.search=e._getUpdatedLocationSearchForReload(e._oWindow.location.search)},0)};a.prototype._logoffAndRedirect=function(){var t=e.getLocationHref(),i=o.get("sap-ushell-config.services.Container.adapter.config.client"),a;a=new URI("/sap/public/bc/icf/logoff").absoluteTo(t).search("sap-client="+i+"&propagateLogoff=false&redirectURL="+encodeURIComponent(t)).toString();document.location=a};a.prototype._isPageReloaded=function(){return new RegExp(["[?&]",i].join("")).test(this._oWindow.location.search)};a.prototype._handleAuthenticationRequiredNoUi5=function(e){if(!this._isPageReloaded()){t.error("Illegal state: XHR authentication (mode=reload) requested before SAPUI5 is initialized. "+"This should not happen if the FioriLaunchpad.html page is loaded from the server. Trying to reload page once.",null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler");var o="Authentication required\n\nYour session might have expired. Press OK to reload.";this._oWindow.alert(o);e.call(this)}else{t.error("Illegal state: XHR authentication (mode=reload) requested before SAPUI5 is initialized and page reload has been triggered once."+" Stopping reload to avoid endless loop. This state cannot be overcome. Please ensure that the FioriLaunchpad.html"+" page is not cached, but always loaded from the server.",null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler")}};a.prototype._showErrorAndReload=function(e,o,t,i){var a,s;if(sap&&sap.ui&&typeof sap.ui.getCore==="function"&&sap.ui.getCore().isInitialized()&&sap.ui.require("sap/m/MessageBox")){if(sap.ui.require("sap/ushell/resources")){a=this._getText(e);s=this._getText(o)}if(sap.ui.require("sap/ui/core/BusyIndicator")){if(typeof sap.ui.core.BusyIndicator.show==="function"&&typeof sap.ui.core.BusyIndicator.hide==="function"){sap.ui.core.BusyIndicator.hide();sap.ui.core.BusyIndicator.show=function(){}}}if(sap&&sap.ca&&sap.ca.ui&&sap.ca.ui.utils&&sap.ca.ui.utils.busydialog){if(typeof sap.ca.ui.utils.busydialog.releaseBusyDialog==="function"){for(var r=0;r<200;++r){sap.ca.ui.utils.busydialog.releaseBusyDialog()}}}sap.m.MessageBox.show(s,{icon:sap.m.MessageBox.Icon.ERROR,title:a,actions:[sap.m.MessageBox.Action.OK],onClose:t.bind(this)})}else{i.call(this,t)}};a.prototype._getText=function(e){var o=sap.ushell.resources.i18n.getText(e.key);if(o&&o!==e.key){return o}return e.text};return a},true);
//# sourceMappingURL=XhrLogonEventHandler.js.map
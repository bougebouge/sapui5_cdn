// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/bootstrap/common/common.load.xhrlogon","sap/ushell/utils","./abap.bootstrap.utils","./abap.request.startup","./abap.request.pageset","./abap.xhr.handler","./abap.theme.handler","sap/ushell/EventHub","sap/ui/performance/trace/initTraces","sap/base/util/ObjectPath","sap/base/Log","sap/ushell_abap/pbServices/ui2/Utils"],function(e,a,t,r,i,n,s,o,l,c,u,p){"use strict";var g={};var f=new RegExp("^(#)?([A-Za-z0-9_]+)-([A-Za-z0-9_]+)"),h,d;function m(e){function a(e){if(!e){return false}return e.indexOf("Shell-home")===0||e.indexOf("Launchpad-openFLPPage")===0||e.indexOf("Shell-appfinder")===0||e.indexOf("Shell-catalog")===0||e.indexOf("shell-catalog")===0||e.indexOf("Action-search")===0}function t(){return window["sap-ushell_abap-bootstrap-abap-noInitialTarget"]!==undefined}var r=e.match(f);var i=r&&r[2];var n=r&&r[3];var s=e&&!a(e)&&!t()&&i&&n;return s}function v(){var e,a=t.getLocationHref(),r=a.indexOf("#");if(r<0){return""}e=decodeURI(a.slice(r+1));return e}function b(){var e=v(),a=e.indexOf("&/");return a<0?e:e.slice(0,a)}function P(e){var a=e.match(f);return a?{semanticObject:a[2],action:a[3]}:undefined}function S(e){if(!e||e==="#"){return true}return e.indexOf("Shell-home")===0||e.indexOf("Launchpad-openFLPPage")===0||e.indexOf("Shell-appfinder")===0||e.indexOf("Shell-catalog")===0||e.indexOf("shell-catalog")===0}function C(e){if(e===undefined){return undefined}try{return JSON.parse(JSON.stringify(e))}catch(e){u.error("Could not clone object",null,"sap.ushell_abap.bootstrap");return undefined}}function y(e){return e.indexOf("sap_")===0}function F(e,a,t){var r=sap.ui.getCore(),i=r.getConfiguration(),n=i.getFormatSettings();u.debug("setSapui5Settings()",JSON.stringify(e),"sap.ushell_abap.bootstrap.abap");if(e.language){i.setLanguage(e.language,e.ABAPLanguage)}if(e.legacyDateFormat){n.setLegacyDateFormat(e.legacyDateFormat)}if(e.legacyDateCalendarCustomizing){n.setLegacyDateCalendarCustomizing(e.legacyDateCalendarCustomizing)}if(e.legacyNumberFormat){n.setLegacyNumberFormat(e.legacyNumberFormat)}if(e.legacyTimeFormat){n.setLegacyTimeFormat(e.legacyTimeFormat)}if(typeof a==="object"){n.addCustomCurrencies(a)}if(t!==""&&typeof t==="string"){i.setTimezone(t)}}function A(e){(c.get("sap-ushell-config.services.Container.adapter.config")||c.create("sap-ushell-config.services.Container.adapter.config")).bootTheme=C(e)}function T(e){if(!e){u.error("extractSystemThemeRoot: mandatory parameter oStartupServiceResult not supplied")}if(e.themeRoot){return e.themeRoot}if(e.client){u.warning("Theme root was not contained in startup service result. A fallback to /sap/public/bc/themes/~client-<client number> is used",null,"sap.ushell_abap.bootstrap");return"/sap/public/bc/themes/~client-"+e.client}u.error("extractSystemThemeRoot: Could not determine system theme root")}function w(e){var a,t;if(e&&e.userProfile&&e.userProfile.filter){a=e.userProfile.filter(function(e){return e.id==="THEME"});t=a.length?a[0]:{};if(t.value){return t.value}}if(e&&e.theme){return e.theme}return""}function x(e,a){if(e&&y(e)){return""}return a}function L(e,a){var t;t=w(e);return{theme:t,root:x(t,a)}}function R(e){var a,r;a=t.getUrlParameterValue("sap-theme");if(a){if(a.indexOf("@")>0){r=a.split("@",2);return{theme:r[0],root:r[1]}}return{theme:a,root:x(a,e)}}return undefined}function O(){var e=p.getParameterMap()["sap-theme"]&&p.getParameterMap()["sap-theme"][0];if(e){return e}return undefined}function _(e){var a=e;var t=e.indexOf("@");if(t>=0){var r=a.slice(t+1);return s.isThemeRootSafe(r)}return true}function z(e,a){var t,r={},i,n=O();if(n&&_(n)){t=R(a);i=t;u.debug("theme: URL theme = '"+i.theme+"' theme root = '"+i.root+"'",null,"sap.ushell_abap.bootstrap");if(i.root){sap.ui.getCore().setThemeRoot(i.theme,i.root.replace(/\/?$/,"/UI5/"))}}else if(e){i=e;u.debug("theme: startup service theme = '"+i.theme+"' theme root = '"+i.root+"'",null,"sap.ushell_abap.bootstrap");if(i.root){sap.ui.getCore().applyTheme(i.theme,i.root+"/UI5/")}else{sap.ui.getCore().applyTheme(i.theme)}}else{r.theme=c.get("sap-ui-config.theme");if(r.theme){r.root=c.get("sap-ui-config.themeRoots."+r.theme||"");if(!r.root){r.root=x(r.theme,a)}i={theme:r.theme,root:r.root};u.debug("theme: html file theme = '"+i.theme+"' theme root = '"+i.root+"'",null,"sap.ushell_abap.bootstrap")}else{i={theme:"",root:""};u.error("Could not determine theme",null,"sap.ushell_abap.bootstrap")}}A(i);return i}function D(e){var a=p.getParameterMap(),r=t.getUrlParameterValue("sap-locale",a),i={},n,s;n=c.get("sap-ushell-config.services.SupportTicket.config")||c.create("sap-ushell-config.services.SupportTicket.config");if(n.enabled!==false){n.enabled=e.isEmbReportingActive===true}n=c.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config.services")||c.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config.services");n.targetMappings=e.services&&e.services.targetMappings;n=c.get("sap-ushell-config.services.LaunchPage.adapter.config.services")||c.create("sap-ushell-config.services.LaunchPage.adapter.config.services");n.targetMappings=e.services&&e.services.targetMappings;n.launchPage=e.services&&e.services.pbFioriHome;n=c.get("sap-ushell-config.services.VisualizationDataProvider.adapter")||c.create("sap-ushell-config.services.VisualizationDataProvider.adapter");n.module="sap.ushell_abap.adapters.abap.LaunchPageAdapter";n=c.get("sap-ushell-config.services.VisualizationDataProvider.adapter.config.services")||c.create("sap-ushell-config.services.VisualizationDataProvider.adapter.config.services");n.targetMappings=e.services&&e.services.targetMappings;n.launchPage=e.services&&e.services.pbFioriHome;n=c.get("sap-ushell-config.services.PageBuilding.adapter.config.services")||c.create("sap-ushell-config.services.PageBuilding.adapter.config.services");n.pageBuilding=e.services&&e.services.pbFioriHome;n=c.get("sap-ushell-config.services.Personalization.adapter.config.services")||c.create("sap-ushell-config.services.Personalization.adapter.config.services");n.personalization=e.services&&e.services.personalization;if(!r){i={language:e.languageBcp47||e.language,ABAPLanguage:e.language,legacyDateFormat:e.dateFormat,legacyDateCalendarCustomizing:e.tislcal,legacyNumberFormat:e.numberFormat===""?" ":e.numberFormat,legacyTimeFormat:e.timeFormat}}s=c.get("sap-ushell-config.startupConfig.timeZoneIana");if(s===undefined){s=c.set("sap-ushell-config.startupConfig.timeZoneIana","")}z(d,h);F(i,e.currencyFormats,s)}function M(e){var a=b(),t=v(),i=P(a),n=[i],s={},o={},l;var u=c.get("sap-ushell-config.services.AppState.config")||c.create("sap-ushell-config.services.AppState.config");var p=c.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config")||c.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config");function g(e,a){var t=a.match(e);var r=[];if(!t){return}r=t[2].toString().split("=");o[r[0]]=r[1]}function f(e,a,t,r,i){if(a&&a[i]&&t&&t[r]){e[t[r]]=a[i]}}if(m(a)){g(/(\?|&)(sap-xapp-state=[A-Z0-9]+)/,a);g(/(\?|&)(sap-intent-param=[A-Z0-9]+)/,a);g(/(\?|&)(sap-system=[A-Z0-9]+)/,a);g(/(\?|&|[/])(sap-iapp-state=[A-Z0-9]+)/,t);l=r.requestDirectStart(e,i,o);u.initialAppStatesPromise=l.then(function(e){f(s,e,o,"sap-intent-param","iparState");f(s,e,o,"sap-iapp-state","iappState");f(s,e,o,"sap-xapp-state","xappState");u.initialAppStates=s;return Promise.resolve(s)});p.initialSegmentPromise=l.then(function(e){if(e.targetMappings){return Promise.resolve([n,e.targetMappings,e.systemAliases,e.urlTemplates])}return Promise.resolve(null)})}else{u.initialAppStatesPromise=Promise.resolve({});p.initialSegmentPromise=Promise.resolve(null)}}function H(){var e=new Promise(function(e,a){var t,r;r=function(){u.info("Direct application start: resolving component waitFor promise after shell renderer created event fired.");e();sap.ushell.Container.detachRendererCreatedEvent(r)};o.once("ShellNavigationInitialized").do(function(){t=sap.ushell.Container.getRenderer();if(t){u.info("Direct application start: resolving component waitFor promise immediately (shell renderer already created).");e()}else{sap.ushell.Container.attachRendererCreatedEvent(r)}})});return e}function I(){var a=b();if(S(a)&&window["sap-ushell-config"].ushell&&window["sap-ushell-config"].ushell.spaces&&window["sap-ushell-config"].ushell.spaces.enabled){N(a)}var t=e.FrameLogonManager.getInstance();sap.ushell.Container.oFrameLogonManager=t;if(m(a)){var r,i;window["sap-ushell-async-libs-promise-directstart"]=new Promise(function(e,a){r=e;i=a});window["sap-ushell-async-libs-promise-directstart"].catch(function(e){});sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(e){e.resolveHashFragment("#"+b()).done(function(e){var t=sap.ui.require("sap/ushell/services/AppConfiguration");t.setCurrentApplication(e);if(e&&e.ui5ComponentName){sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(t){t.createComponent(e,P(a),H(),"Application").done(function(e){r({resolvedHashFragment:e,dependenciesLoaded:true})}).fail(function(e){i(e)})})}else{r({resolvedHashFragment:e,dependenciesLoaded:false})}}).fail(function(e){i(e)})})}}function N(e){if(e&&e.indexOf("Shell-appfinder")===0){return}sap.ushell.Container.getServiceAsync("Personalization").then(function(e){var a={container:"sap.ushell.cdm3-1.personalization",item:"data"};var t={validity:"Infinity",keyCategory:e.constants.keyCategory.GENERATED_KEY,writeFrequency:e.constants.writeFrequency.HIGH,clientStorageAllowed:false};return e.getPersonalizer(a,t).getPersData()});sap.ui.require(["sap/ushell/components/pages/controller/PagesAndSpaceId"],function(a){var t=a._getPageAndSpaceId(e);var r=sap.ushell.Container.getServiceAsync("PagePersistence");Promise.all([t,r]).then(function(e){var a=e[0];var t=e[1];t.getPage(a.pageId)}).catch(function(e){u.error(e)})})}function q(e){n.initXhrLogon(window["sap-ushell-config"]);l();r.requestStartupConfig().then(function(e){var a=b();(c.get("sap-ushell-config.services.Container.adapter")||c.create("sap-ushell-config.services.Container.adapter")).config=e;var t=c.get("sap-ushell-config.services.LaunchPage.adapter.config")||c.create("sap-ushell-config.services.LaunchPage.adapter.config");var n=c.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config")||c.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config");if(c.get("sap-ushell-config.ushell.spaces.enabled")){c.set("sap-ushell-config.services.VisualizationDataProvider.adapter.config",t);c.set("sap-ushell-config.services.NavigationDataProvider.adapter.config",n)}M(e);h=T(e);d=L(e,h);if(!O()&&d){u.debug("theme: load theme from startup service via window",null,"sap.ushell_abap.bootstrap")}if(S(a)&&!c.get("sap-ushell-config.ushell.spaces.enabled")){i.requestPageSet(e)}var s=r.requestFullTM(e);n.navTargetDataPromise=s;t.compactTMPromise=s;return Promise.resolve(e)},function(e){u.error("start_up request failed: "+e,null,"sap.ushell_abap.bootstrap");return Promise.resolve({})}).then(function(a){D(a);e()})}g.start=q;g.afterBootstrap=I;g._getShellHash=b;g._getFullShellHash=v;g._createWaitForRendererCreatedPromise=H;g._loadPage=N;return g});
//# sourceMappingURL=boottask.js.map
// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/ObjectPath","sap/ushell/utils/HttpClient","sap/ushell/resources","sap/ushell/utils/chipsUtils","sap/ushell/Config"],function(e,t,i,a,r){"use strict";function n(){var t=window["sap-ushell-config"].services&&window["sap-ushell-config"].services.PagePersistence||{};return(e.get("config.serviceUrl",t.adapter)||"").replace(/\/?$/,"/")}var s=function(){this.S_COMPONENT_NAME="sap.ushell_abap.adapters.abap.PagePersistenceAdapter"};s.prototype.getPage=function(e){return Promise.all([this._readPage(e),sap.ushell.Container.getServiceAsync("URLParsing")]).then(function(e){var t=e[0];var i=e[1];return this._convertODataToReferenceData(t,i)}.bind(this)).catch(this._rejectWithError.bind(this))};s.prototype.getPages=function(e){return Promise.all([this._readPages(e),sap.ushell.Container.getServiceAsync("URLParsing")]).then(function(e){var t=e[0].results;var i=e[1];return t.map(function(e){return this._convertODataToReferenceData(e,i)}.bind(this))}.bind(this)).catch(this._rejectWithError.bind(this))};s.prototype._readPage=function(e){return new Promise(function(i,a){var r={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Accept-Language":sap.ui.getCore().getConfiguration().getLanguage()||"",Accept:"application/json, text/plain"};var s=sap.ushell.Container.getUser().getLanguage();if(s){r["sap-language"]=s}var o=sap.ushell.Container.getLogonSystem();var p=o?o.getClient():"";if(p){r["sap-client"]=p}var c=n();var l=new t(c,{headers:r});var u=c+"pageSet('"+encodeURIComponent(e)+"')"+"?$expand=sections/viz,vizReferences/chipBags/properties,tileTypes/vizOptions/displayFormats/supported";l.get(u).then(function(e){i(JSON.parse(e.responseText).d)}).catch(a)})};s.prototype._readPages=function(e){return new Promise(function(i,a){var r={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Accept-Language":sap.ui.getCore().getConfiguration().getLanguage()||"",Accept:"application/json, text/plain","content-type":"multipart/mixed; boundary=batch_bd56-ff53-571c"};var s=sap.ushell.Container.getUser().getLanguage();if(s){r["sap-language"]=s}var o=sap.ushell.Container.getLogonSystem();var p=o?o.getClient():"";if(p){r["sap-client"]=p}var c="pageSet?$expand="+encodeURIComponent("sections/viz,vizReferences/chipBags/properties,tileTypes/vizOptions/displayFormats/supported")+"&$filter=";var l=e.length?"id eq '"+e.join("' or id eq '")+"'":"";var u=n();var d=u+"$batch";var g=new t(u,{headers:r});var h=this._createBatchData(c+encodeURIComponent(l).replace(/[!'()*]/g,escape));g.post(d,{data:h}).then(function(e){var t=this._retrieveBatchData(e);i(t)}.bind(this)).catch(a)}.bind(this))};s.prototype._createBatchData=function(e){var t=sap.ushell.Container.getUser().getLanguage();var i=sap.ushell.Container.getLogonSystem()?sap.ushell.Container.getLogonSystem().getClient():"";var a=["--batch_bd56-ff53-571c","Content-Type: application/http","Content-Transfer-Encoding: binary","","GET "+e+" HTTP/1.1","sap-cancel-on-close: true","sap-language: "+(t||""),"sap-client: "+(i||""),"sap-contextid-accept: header","Accept: application/json","Accept-Language: "+(t||""),"DataServiceVersion: 2.0","MaxDataServiceVersion: 2.0","X-Requested-With: XMLHttpRequest","","","","--batch_bd56-ff53-571c--"];return a.join("\r\n")};s.prototype._retrieveBatchData=function(e){var t=e.responseText.split("\r\n");var i=[];for(var a=0;a<t.length;a++){if(t[a].startsWith("{")){i=t[a]}}return JSON.parse(i).d};s.prototype._convertODataToReferenceData=function(e,t){var i={};var n=r.last("/core/stableIDs/enabled");var s={page:{id:e.id,title:e.title,description:e.description,createdBy:e.createdBy,createdByFullname:e.createdByFullname||e.createdBy,modifiedBy:e.modifiedBy,modifiedByFullname:e.modifiedByFullname||e.modifiedBy,sections:e.sections.results.map(function(e){return{id:e.id,sectionIndex:e.sectionIndex,title:e.title,viz:e.viz.results.map(function(e){return{catalogTileId:e.catalogTileId,id:e.id,itemIndex:e.itemIndex,targetMappingId:e.targetMappingId,vizId:n?e.catalogTileIdStable:e.catalogTileId,inboundPermanentKey:n?e.targetMappingIdStable:e.targetMappingId,displayFormatHint:e.displayFormatHint}}).sort(function(e,t){return e.itemIndex-t.itemIndex})}}).sort(function(e,t){return e.sectionIndex-t.sectionIndex})},visualizations:e.vizReferences.results.reduce(function(e,r){var s=this._getSimplifiedChip(r);var o={vizType:r.tileType,title:r.title,subTitle:r.subTitle,icon:r.iconUrl,info:a.getInfoFromSimplifiedChip(s),keywords:a.getKeywordsFromSimplifiedChip(s),size:a.getTileSizeFromSimplifiedChip(s),indicatorDataSource:a.getIndicatorDataSourceFromSimplifiedChip(s),url:a.getTargetUrlFromSimplifiedChip(s,t),numberUnit:a.getNumberUnitFromSimplifiedChip(s),isCustomTile:a.isCustomTileFromSimplifiedChip(s),_instantiationData:{platform:"ABAP",simplifiedChipFormat:true,chip:s}};if(n){o.vizId=r.catalogTileIdStable;e[r.catalogTileIdStable]=o;if(r.fromPersonalization&&r.id!==r.catalogTileIdStable){i[r.id]=o}}else{e[r.id]=o}return e}.bind(this),{}),vizTypes:e.tileTypes.results.reduce(function(e,t){var i=t.vizOptions.displayFormats;var a=t.id;e[a]={id:a,url:t.url,vizOptions:{displayFormats:{supported:i.supported.results.map(function(e){return e.id}),default:i.preferred}}};return e},{})};if(n){s.unstableVisualizations=Object.keys(i).length>0?i:null}return s};s.prototype._getSimplifiedChip=function(e){var t={};var i;try{i=JSON.parse(e.configuration)}catch(e){i={}}e.chipBags.results.forEach(function(e){t[e.id]={texts:{},properties:{}};e.properties.results.forEach(function(i){if(i.translatable){t[e.id].texts[i.id]=i.value}else{t[e.id].properties[i.id]=i.value}})});return{chipId:e.tileType,configuration:i,bags:t}};s.prototype._rejectWithError=function(e){var t={component:this.S_COMPONENT_NAME,description:i.i18n.getText("PagePersistenceAdapter.CannotLoadPage"),detail:e};return Promise.reject(t)};return s},true);
//# sourceMappingURL=PagePersistenceAdapter.js.map
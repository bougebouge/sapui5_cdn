// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/datajs","sap/ushell_abap/pbServices/ui2/Utils","sap/ushell_abap/pbServices/ui2/ODataService","sap/ushell_abap/pbServices/ui2/Error","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,t,a,r,n,jQuery){"use strict";function s(){}function i(e,a){if(t.isArray(e)){e.forEach(function(e){e.reject(a)})}else{e.reject(a)}}var o;o=function(e,a){var u="saplb",f,p,l,d=this,h,g;function b(e){var t={};t.baseUrl=e[0];if(typeof e[2]==="boolean"){t.supportsChangeSets=e[2]}return t}this.getBatchQueue=function(){return f};o.headerValue=function(e,t){e=e.toLowerCase();for(var a in t){if(Object.prototype.hasOwnProperty.call(t,a)&&a.toLowerCase()===e){return t[a]}}return undefined};function O(t){var a=e["sap-language"]||o["sap-language"],r=e["sap-statistics"]||o["sap-statistics"],n=e["sap-client"]||o["sap-client"];t=t||{};if(a){t["sap-language"]=a}if(r||r==="false"){t["sap-statistics"]=""+r}if(n){t["sap-client"]=n}return t}function S(e){e=e||{};var t=o.oStickySessionConfiguration[h];if(typeof t==="undefined"){return e}if(t&&t.enabled&&typeof t.value!=="undefined"){e[u]=t.value}return e}this.detectStickySession=function(e){var t,a=o.oStickySessionConfiguration[h];if(!a||!a.enabled){return}t=o.headerValue(u,e);if(typeof t==="undefined"){return}if(a.value!==t){a.value=t}};o.csrfTokenValue=function(e){var t=o.headerValue("x-csrf-token",e);if(t==="Required"){return t}var a=o.headerValue("cache-control",e);if(a===undefined||a.indexOf("max-age=0")>-1||a.indexOf("no-cache")>-1){return t||""}return""};this.doRequest=function(e,r,i,u,c,f,p){n.debug("[000] do request, sMethod",r,"ODataWrapper");var l;u=u||s;c=c||a.getDefaultErrorHandler();d.check(u,c);l={Accept:"application/json","Accept-Language":sap.ui.getCore().getConfiguration().getLanguage()||"","X-CSRF-Token":a.getCsrfToken()};O(l);S(l);OData.request({requestUri:e,method:r,data:i,headers:l},function(a,s){this.detectStickySession((s||{}).headers);n.debug("Received OData response for "+r+' "'+e+'"',null,"ODataWrapper");t.callHandler(u.bind(null,a),c)}.bind(this),function(t){function s(){c.apply(null,arguments)}function l(){u.apply(null,arguments)}if(!p&&t.response.statusCode===403&&o.csrfTokenValue(t.response.headers).toLowerCase()==="required"){n.debug("CSRF token required for "+r+' "'+e+'", refreshing it',JSON.stringify(t.response),"ODataWrapper");a.refreshCsrfToken(this.doRequest.bind(d,e,r,i,l,s,f,true),s)}else{d.onError(r,e,c,null,t)}}.bind(this),f);n.debug("Sent OData request for "+r+' "'+e+'"',null,"ODataWrapper")};this.toRelativeUrl=function(e){var t=e.indexOf(h);if(t<0){throw new r('Not relative to base URL "'+h+'": '+e,"ODataWrapper")}return e.slice(t+h.length)};this.toRequestUrl=function(e){if(/^\//.test(e)){throw new r("Not a relative URL: "+e,"ODataWrapper")}return h+e};this.readOrBatch=function(e,t,a){var r,s=this.toRequestUrl(e),i=S(O());if(f){n.debug('Queued OData request for GET "'+e+'"',null,"ODataWrapper");f.push({method:"GET",requestUri:e,headers:i});r=(new jQuery.Deferred).done(t).fail(a);l.push(r);p=false;return}i.Accept="application/json";i["Accept-Language"]=sap.ui.getCore().getConfiguration().getLanguage()||"";i["X-CSRF-Token"]="Fetch";OData.read({requestUri:s,headers:i},t,a);n.debug('Sent OData request for GET "'+s+'"',null,"ODataWrapper")};this.requestOrBatch=function(e,r,i,o,u){var c,h={data:i,method:r,requestUri:e,headers:S(O())},b=this.toRequestUrl(e);if(f){o=o||s;u=u||a.getDefaultErrorHandler();d.check(o,u);n.debug("Queued OData request for "+r+' "'+e+'"',null,"ODataWrapper");if(!p){f.push({__changeRequests:[]});l.push([]);p=g}f[f.length-1].__changeRequests.push(h);c=(new jQuery.Deferred).done(function(e,a){n.debug("Received OData response for "+r+' "'+b+'"',null,"ODataWrapper");t.callHandler(o.bind(null,e),u)}).fail(d.onError.bind(d,r,b,u,null));l[l.length-1].push(c);return}this.doRequest(b,r,i,o,u)};this.isStickySessionEnabled=function(){return(o.oStickySessionConfiguration[h]||{}).enabled||false};this.enableStickySession=function(){o.oStickySessionConfiguration[h].enabled=true};this.check=function(e,t){if(!e){throw new r("Missing success callback","ODataWrapper")}if(typeof e!=="function"){throw new r("Success callback is not a function","ODataWrapper")}if(!t){throw new r("Missing error callback","ODataWrapper")}if(typeof t!=="function"){throw new r("Error callback is not a function","ODataWrapper")}};this.create=function(e,t,a,r){n.debug("[000] create: url",e,"ODataWrapper");this.requestOrBatch(e,"POST",t,a,r)};this.del=function(e,t,a){var r=e;if(typeof r!=="string"){r=this.toRelativeUrl(e.__metadata.uri)}this.requestOrBatch(r,"DELETE",null,function(e){if(t){t()}},a)};this.getBaseUrl=function(){return h};this.getODataService=function(){return a};this.onError=function(e,t,a,r,s){var i,o="Error ";if(s.response&&s.response.statusCode){o+="("+s.response.statusCode+", "+s.response.statusText+") "}o+="in OData response for "+e+' "'+t+'": '+s.message;if(s.response&&s.response.body){try{i=JSON.parse(s.response.body).error;if(i){if(i.hasOwnProperty("message")&&i.message.hasOwnProperty("value")){o+="\nDetails: "+i.message.value}if(s.response.statusCode&&!i.httpStatus){i.httpStatus=s.response.statusCode}}}catch(e){}}n.error(o,JSON.stringify(s.response),"ODataWrapper");if(r){r.reject(o,i)}a(o,i)};this.openBatchQueue=function(){if(f){throw new r("Batch queue already open","ODataWrapper")}f=[];l=[];p=false};this.isBatchQueueOpen=function(){return!!f};this.read=function(e,r,s,i){var u,c=this.toRequestUrl(e),f;function p(e,i){this.detectStickySession(i.headers);a.setCsrfToken(o.csrfTokenValue(i.headers)||a.getCsrfToken());n.debug('Received OData response for GET "'+c+'"',null,"ODataWrapper");f=o.headerValue("sap-message",i.headers);if(f){n.warning("SAP message for GET "+c,f,"ODataWrapper")}if(u){u.resolve(JSON.parse(JSON.stringify(e)),a.getCsrfToken())}t.callHandler(r.bind(null,e),s)}s=s||a.getDefaultErrorHandler();this.check(r,s);if(i){OData.read.$cache=OData.read.$cache||new t.Map;u=OData.read.$cache.get(c);if(u){n.debug('Using cached response for GET "'+c+'"',null,"ODataWrapper");u.done(function(e,n){a.setCsrfToken(a.getCsrfToken()||n);t.callHandler(r.bind(null,JSON.parse(JSON.stringify(e))),s)}).fail(s);return}u=new jQuery.Deferred;OData.read.$cache.put(c,u.promise())}this.readOrBatch(e,p.bind(this),this.onError.bind(this,"GET",c,s,u))};this.batch=function(e,t,a){var r=this.toRequestUrl("$batch");this.doRequest(r,"POST",e,t,a,OData.batchHandler)};this.submitBatchQueue=function(e,s){var o=l;function u(r){var n=r.__batchResponses.length,u=o.length;if(u!==n){d.onError("POST",this.toRequestUrl("$batch"),s,null,{message:"Protocol error! Expected "+u+" responses, but received "+n});return}r.__batchResponses.forEach(function(e,t){var a=o[t];if(e.response){i(a,e)}else if(e.__changeResponses){e.__changeResponses.forEach(function(e,t){a[t].resolve(e.data,e)})}else{a.resolve(e.data,e)}});if(e){t.callHandler(e,a.getDefaultErrorHandler())}}if(!f){throw new r("No open batch queue to submit","ODataWrapper")}if(f.length>0){n.debug("[000] submit batch queue: batch","ODataWrpper");this.batch({__batchRequests:f},u.bind(this),s)}else if(e){t.callHandler(e,a.getDefaultErrorHandler(),true)}n.debug("[000] submit batch queue","ODataWrapper");f=undefined;l=undefined};this.toString=function(e){var t=['ODataWrapper({sBaseUrl:"',h,'"'];t.push("})");return t.join("")};this.put=function(e,t,a,r){n.debug("[000] put: request or batch, payload.id",t.id,"ODataWrapper");this.requestOrBatch(e,"PUT",t,function(e){if(a){a()}},r)};this.update=function(e,t,a){var r={__metadata:{type:e.__metadata&&e.__metadata.type}},n,s=this.toRelativeUrl(e.__metadata.uri);for(n in e){if(Object.prototype.hasOwnProperty.call(e,n)&&n.indexOf("$")!==0&&typeof e[n]!=="object"){r[n]=e[n]}}this.put(s,r,t,a)};if(typeof e==="string"){e=b(arguments)}else if(typeof e==="object"){e=c(e)}if(!e||!e.baseUrl||typeof e.baseUrl!=="string"){throw new r("Missing base URL","ODataWrapper")}if(!a||typeof a!=="object"){throw new r("Missing OData service facade","ODataWrapper")}e.baseUrl=e.baseUrl.replace(/\/$/,"")+"/";h=e.baseUrl;g=e.supportsChangeSets;if(typeof o.oStickySessionConfiguration==="undefined"){n.error("ODataWrapper.oStickySessionConfiguration is not defined!","the ODataWrapper constructor was called before the static property was defined","ODataWrapper")}else if(typeof o.oStickySessionConfiguration[h]==="undefined"){o.oStickySessionConfiguration[h]={enabled:false,value:undefined}}};function u(e){var t={};var a={};t.baseUrl=e[0];if(typeof e[1]==="boolean"){t.supportsChangeSets=e[1]}if(typeof e[2]==="function"){a.defaultFailure=e[2]}a.settings=t;return a}function c(e){if(e===undefined){return undefined}try{return JSON.parse(JSON.stringify(e))}catch(e){return undefined}}if(typeof o.oStickySessionConfiguration==="undefined"){o.oStickySessionConfiguration={}}o.checkSapStatisticsSetting=function(e){try{o["sap-statistics"]=sap.ui.getCore().getConfiguration().getStatistics()}catch(t){o["sap-statistics"]=/sap-statistics=(true|x|X)/.test(e)}};o.checkSapStatisticsSetting(window.location.search);o._Service=function e(t,r){var n=new o(t,this);a.call(this,n,r);return n};o.createODataWrapper=function(e,t){n.debug("[000] createOdataWrapper","ODataWrapper");if(typeof arguments[0]==="string"){var a=u(arguments);e=a.settings;if(a.defaultFailure){t=a.defaultFailure}}else if(typeof arguments[0]==="object"){e=c(e)}return new o._Service(e,t)};return o});
//# sourceMappingURL=ODataWrapper.js.map
// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell_abap/pbServices/ui2/Error","sap/ushell_abap/pbServices/ui2/Utils","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,t,i,jQuery){"use strict";var n=function(n,a){var r,o,s=[],l,u=true,d,g,f,c=[],h=this;function p(){if(u){throw new e(h+": page is just a stub","Page")}}function C(){if(!r){throw new e(h+": catalog is just an ID","Catalog")}}this.exit=function(){var e=h.toString();if(o){o.exit()}r=undefined;a=undefined;s=[];u=true;l=undefined;f=undefined;c=[];Object.keys(h).forEach(function(e){if(!/getCatalogData|getId|isStub|toString/.test(e)){delete h[e]}});n.forgetCatalog(h);i.debug("Exited: "+e,null,"Catalog")};this.getRemoteBaseUrl=function(){return h.addSystemToServiceUrl(r.type==="H"?"/sap/hba/apps/kpi/s/odata/hana_chip_catalog.xsodata/":r.baseUrl)};this.getRemoteCatalogService=function(){return n.getRemoteCatalogService(r)||{readChips:function(e,n,a,o,s){i.error("Catalog '"+r.id+"', type '"+r.type+"' not supported",null,"Catalog");t.callHandler(o.bind(null,{results:[]}),undefined,true)}}};function S(){var e,t,a;i.debug("Loaded: "+h,null,"Catalog");if(r.Chips){a=r.Chips.results||r.Chips;delete r.Chips;s=[];for(e=0,t=a.length;e<t;e+=1){s[e]=n.createChip(a[e])}u=false;i.debug("Initialized: "+h,null,"Catalog")}delete r.CatalogPage}this.read=function(e,i,a){var o;function s(e){r=e;S();o.resolve()}function u(e){r.Chips=e;S();o.resolve()}function f(e){e.results.forEach(function(e){e.remoteCatalogId=g});u(e)}function c(){S();d=arguments;o.reject.apply(this,arguments)}function p(t){var i;if(t.remoteId){r=t;try{i=h.getRemoteBaseUrl()}catch(e){c(e.toString());return}h.getRemoteCatalogService().readChips(i,r.remoteId,undefined,f,c)}else if(r&&e){u(t.Chips)}else{s(t)}}if(!l||l.state()!=="pending"){o=new jQuery.Deferred;l=o.promise();if(!r||e&&!r.remoteId){n.getPageBuildingService().readCatalog(g,p,o.reject.bind(o))}else{p.bind(this)(r)}}a=a||n.getPageBuildingService().getDefaultErrorHandler();l.done(t.callHandler.bind(null,i,a));l.fail(a)};this.addSystemToServiceUrl=function(t,i){if(t.indexOf("/")!==0||t.indexOf("//")===0){throw new e("addSystemToServiceUrl: Invalid URL: "+t,"Catalog")}i=i||this.getSystemAlias();if(/^[^?]*(;o=([\/;?]|$))/.test(t)){t=t.replace(/;o=([\/;?]|$)/,(i?";o="+i:"")+"$1")}else if(!/^[^?]*;o=/.test(t)&&i){t=t.replace(/(\/[^?]*?)(\/$|$|(\/?\?.*))/,"$1;o="+i+"$2")}sap.ui.getCore().getEventBus().publish("sap.ushell.Container","addRemoteSystemForServiceUrl",t);return t};this.clone=function(e,t,i,a){var o,s=function(e,t){return a(e,undefined,t)};if(r&&r.type==="REMOTE"){o=this.getCatalogData();delete o.id;o.domainId=e;if(t!==undefined){o.title=t}n.createNewCatalog(o,i,a)}else{n.getPageBuildingService().cloneCatalog(this.getId(),e,t,function(e){n.createCatalog(e.id,i,s)},s)}};this.getCatalogData=function(){var e;if(!r){return undefined}e=JSON.parse(JSON.stringify(r));delete e.__metadata;return e};this.getCatalogPage=function(){C();if(r.type!=="P"&&r.type!=="CATALOG_PAGE"){return undefined}if(!o){o=n.createPage(g)}return o};this.getChips=function(){if(u){throw new e(h+": catalog is just a stub","Catalog")}return s.slice()};this.getDomainId=function(){return r&&r.domainId};this.getId=function(){return g};this.getSystemAlias=function(){return r&&r.systemAlias||undefined};this.getTitle=function(){C();return r.title};this.getType=function(){C();return r&&r.type};this.isOutdated=function(){C();return o&&!o.isStub()&&o.isOutdated()||r.outdated==="X"};this.isReadOnly=function(){p();return r.isReadOnly==="X"};this.isStub=function(){return u};this.getCachedRemoteFailureArguments=function(){return d};this.load=function(t,i){if(!u){throw new e("Catalog is not a stub anymore","Catalog")}this.read(false,t,i)};this.readChips=function(e,i,a){function o(e){e.results.forEach(function(e){n.createChip(e)});t.callHandler(i,a)}function s(e){e.results.forEach(function(e){e.remoteCatalogId=g});o(e)}function l(t){r=t;if(r.remoteId){this.getRemoteCatalogService().readChips(this.getRemoteBaseUrl(),r.remoteId,e,s,a)}else{n.getPageBuildingService().readCatalogChips(g,e,o,a)}}if(!r){n.getPageBuildingService().readCatalog(g,l.bind(this),a,true)}else{l.bind(this)(r)}};this.readRegisteredChips=function(e,i){function a(){var e=new jQuery.Deferred,t=c;c=[];if(t.length){h.readChips(t,e.resolve.bind(e),e.reject.bind(e))}else{e.resolve()}return e.promise()}if(!f||f.state()!=="pending"){f=a()}i=i||n.getPageBuildingService().getDefaultErrorHandler();f.fail(i).done(t.callHandler.bind(null,e,i))};this.refresh=function(e,t){this.read(true,e,t)};this.registerChip=function(t){if(f&&f.state()==="pending"){throw new e("Invalid state: registerChip while readRegisteredChips pending","Catalog")}c.push(t.getId())};this.remove=function(t,a){C();if(l&&l.state()==="pending"){throw new e("Catalog is being refreshed: "+this,"Catalog")}i.debug("Removing: "+this,null,"Catalog");n.getPageBuildingService().deleteCatalog(r,function(){this.exit();t()}.bind(this),a)};this.toString=function(e){var t=['Catalog({sId:"',g,'"',",bIsStub:",u];if(e){t.push(",oAlterEgo:",JSON.stringify(r),",oFactory:",n.toString(e),",aChips:",JSON.stringify(s))}t.push("})");return t.join("")};this.update=function(t,i,a){var o;C();if(Object.hasOwnProperty.call(t,"__metadata")){throw new e("Unsupported __metadata update","Catalog")}o=JSON.parse(JSON.stringify(r));Object.keys(t).forEach(function(e){o[e]=t[e]});u=true;d=undefined;n.getPageBuildingService().updateCatalog(o,function(){r=o;this.read(true,i,a)}.bind(this),function(){u=false;a=a||n.getPageBuildingService().getDefaultErrorHandler();a.apply(null,arguments)})};if(typeof a==="object"){g=a.id;if(a.remoteId){delete a.Chips}r=a;S()}else if(typeof a==="string"){g=a}if(!g){throw new e("Missing ID","Catalog")}i.debug("Created: "+this,null,"Catalog")};return n});
//# sourceMappingURL=Catalog.js.map
/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/base/Object","sap/gantt/misc/ShapeManager","sap/gantt/misc/Format","sap/ui/core/Core","sap/gantt/misc/Utility","sap/gantt/drawer/ShapeInRow"],function(jQuery,e,t,i,a,s,o,r){"use strict";var n=t.extend("sap.gantt.eventHandler.ShapeResizeHandler",{constructor:function(e){t.call(this);this._oSourceChart=e;this._bResizing=false;this._oResizingData=undefined;this._oShapeManager=e._oShapeManager;this._oSourceChartId=this._oSourceChart.getId();this._oShapeInRowDrawer=new r;this._DEFAULT_RESIZE_CURSOR_SHOWING_THRESHOLD=1;this._DEFAULT_MOUSE_MOVE_PIXEL=3;this._TIMESTAMP_START_TIME_KEY="time";this._TIMESTAMP_END_TIME_KEY="endTime"}});n.prototype.getIsResizing=function(){return this._bResizing};n.prototype.getResizingData=function(){return this._oResizingData};n.prototype.handleShapeResize=function(e){if(e.button===0){var t=d3.select(e.target).datum();if(e.target.getAttribute("class")&&t){var i=e.target.getAttribute("class").split(" ")[0];if(d3.select(e.target).classed("sapUiShapeResizingCursor")&&this._oShapeManager.isShapeResizable(t,i)&&this._oShapeManager.isShapeDuration(t,i)){this._handleShapeResizeStart(e);this._preventBubbleAndDefault(e)}}}};n.prototype._handleShapeResizeStart=function(e){var t=jQuery(this._oSourceChart.getDomSelectorById("svg"));var i=d3.select(e.target).datum();if(i){var a=o.getRowDatumByShapeUid(i.uid,this._oSourceChart.getId());if(a){a.y=this._oSourceChart._oAxisOrdinal.elementToView(a.uid);var r=e.pageX-t.offset().left||e.offsetX;var n=this._getTopShapeInstance(i,e.target.getAttribute("class").split(" ")[0]);var h,p;if(n){if(s.getConfiguration().getRTL()===true){h=n.getEndTime(i);p=n.getTime(i)}else{h=n.getTime(i);p=n.getEndTime(i)}}var g={shapeData:i,objectInfoRef:a};this._oResizingData={oShapeData:g,aOldTime:[h,p],resizeStartPointX:r,topShapeInstance:n};jQuery(document.body).unbind("mousemove.shapeResizing");jQuery(document.body).unbind("mouseup.shapeResizing");jQuery(document.body).bind("mousemove.shapeResizing",this._handleShapeResizing.bind(this));jQuery(document.body).bind("mouseup.shapeResizing",this._handleShapeResizeEnd.bind(this))}}};n.prototype.checkShapeResizable=function(e,t,i){if(e&&t&&i){jQuery(t).removeClass("sapUiShapeResizingCursor");var s=t.getAttribute("class")?t.getAttribute("class").split(" ")[0]:undefined;if(!s||s.indexOf("__")<0){return}if(this._oShapeManager.isShapeResizable(e,s)){var o,r,n;var h=this._getShapeInstance(e,s);if(h){var p=h.getTime(e);var g=h.getEndTime(e);r=this._oSourceChart.getAxisTime().timeToView(a.abapTimestampToDate(p));n=this._oSourceChart.getAxisTime().timeToView(a.abapTimestampToDate(g));o=Math.abs(n-i)<Math.abs(r-i)?Math.abs(n-i):Math.abs(r-i)}if(o<=this._DEFAULT_RESIZE_CURSOR_SHOWING_THRESHOLD&&!this._oSourceChart._bDragging){jQuery(t).addClass("sapUiShapeResizingCursor")}else{jQuery(t).removeClass("sapUiShapeResizingCursor")}}}};n.prototype._preventBubbleAndDefault=function(e){e.preventDefault();e.stopPropagation()};n.prototype._handleShapeResizing=function(t){if(!e.support.touch&&(t.button!==0||t.buttons===0||t.ctrlKey)){return false}var i=jQuery(this._oSourceChart.getDomSelectorById("svg"));var a=Math.abs((t.pageX-i.offset().left||t.offsetX)-this._oResizingData.resizeStartPointX);if(a>this._DEFAULT_MOUSE_MOVE_PIXEL){if(this._oResizingData!==undefined){this._updateResizingShapeData(t);this._bResizing=true;this._oSourceChart._oAutoScrollHandler.autoScroll(this._oSourceChart,t)}}};n.prototype._handleShapeResizingWhenAutoScroll=function(){if(this.getIsResizing()){this._updateResizingShapeData(this._oLastEvent)}};n.prototype._updateResizingShapeData=function(e){this._oLastEvent=e;var t=jQuery(this._oSourceChart.getDomSelectorById("svg"));var i=e.pageX-t.offset().left||e.offsetX;var a=this._calculateResizedNewTime(i);this._drawResizingShadow(a)};n.prototype._parseShapeTimeProperty=function(e,t){var i;if(e.mShapeConfig.hasShapeProperty(t)){var a=e.mShapeConfig.getShapeProperty(t);if(typeof a==="string"&&a.charAt(0)==="{"&&a.charAt(a.length-1)==="}"){i=a.substring(1,a.length-1)}}return i};n.prototype._drawResizingShadow=function(e){var t=d3.select(this._oSourceChart.getDomSelectorById("svg"));if(e){var i=jQuery.extend(true,{},this._oResizingData.oShapeData.shapeData);var a=this._oResizingData.topShapeInstance.getAggregation("resizeShadowShape");var o=this._parseShapeTimeProperty(a,this._TIMESTAMP_START_TIME_KEY);var r=this._parseShapeTimeProperty(a,this._TIMESTAMP_END_TIME_KEY);var n,h;if(s.getConfiguration().getRTL()===true){n=e[1];h=e[0]}else{n=e[0];h=e[1]}if(i[o]){i[o]=n}if(i[r]){i[r]=h}var p={objectInfoRef:this._oResizingData.oShapeData.objectInfoRef};p.shapeData=i;a.dataSet=[p];this._oShapeInRowDrawer.drawResizeShadow(t,a,this._oSourceChart.getAxisTime(),this._oSourceChart._oAxisOrdinal,this._oSourceChart._oStatusSet)}};n.prototype._calculateResizedNewTime=function(e){var t=[];var i,s;var o=this._oResizingData.aOldTime[0];var r=this._oResizingData.aOldTime[1];var n=this._oSourceChart.getAxisTime().timeToView(a.abapTimestampToDate(o));var h=this._oSourceChart.getAxisTime().timeToView(a.abapTimestampToDate(r));var p;if(this._oResizingData.isLeftSideClick!==undefined&&this._oResizingData.isLeftSideClick!==null){p=this._oResizingData.isLeftSideClick}else{p=Math.abs(this._oResizingData.resizeStartPointX-n)<Math.abs(this._oResizingData.resizeStartPointX-h)?true:false;this._oResizingData.isLeftSideClick=p}if(p){s=r;if(e>=h){i=r}else{i=a.dateToAbapTimestamp(this._oSourceChart.getAxisTime().viewToTime(e))}}else{i=o;if(e<=n){s=o}else{s=a.dateToAbapTimestamp(this._oSourceChart.getAxisTime().viewToTime(e))}}t=[i,s];return t};n.prototype._getShapeInstance=function(e,t){var i=this._oShapeManager.getShapeInstance(e,t);if(i){if(i.getId()===t){return i}else if(i.getShapes()){var a=i.getShapes();for(var o=0;o<a.length;o++){if(a[o].getId()===t){return a[o]}}}}else{var r=s.byId(t).getParent();if(r){return r}}return undefined};n.prototype._getTopShapeInstance=function(e,t){var i=this._oShapeManager.getShapeInstance(e,t);if(i){return i}else{var a=s.byId(t).getParent();if(a){return a}}return undefined};n.prototype._handleShapeResizeEnd=function(e){this._oSourceChart._oAutoScrollHandler.stop();var t=d3.selectAll(".resizingShadow");if(!t.empty()){t.remove()}if(this._bResizing&&this._oResizingData!==undefined){this._collectResizingShapeData(e);this._oSourceChart.fireShapeResizeEnd({shapeUid:this._oResizingData.oShapeData.shapeData.uid,rowObject:this._oResizingData.oShapeData.objectInfoRef,oldTime:this._oResizingData.aOldTime,newTime:this._oResizingData.aNewTime})}jQuery(document.body).unbind("mousemove.shapeResizing");jQuery(document.body).unbind("mouseup.shapeResizing");jQuery(e.target).removeClass("sapUiShapeResizingCursor");this._bResizing=false;this._oResizingData=undefined;this._oLastEvent=undefined};n.prototype._collectResizingShapeData=function(e){var t=jQuery(this._oSourceChart.getDomSelectorById("svg"));var i=e.pageX-t.offset().left||e.offsetX;var a=this._calculateResizedNewTime(i);var o,r;if(s.getConfiguration().getRTL()===true){o=a[1];r=a[0]}else{o=a[0];r=a[1]}this._oResizingData.aNewTime=[o,r]};return n},true);
//# sourceMappingURL=ShapeResizeHandler.js.map
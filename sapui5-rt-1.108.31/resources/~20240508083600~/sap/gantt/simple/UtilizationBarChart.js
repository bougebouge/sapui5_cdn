/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./UtilizationChart","./BaseRectangle","sap/gantt/def/pattern/BackSlashPattern"],function(jQuery,t,e,r){"use strict";var o=t.extend("sap.gantt.simple.UtilizationBarChart",{metadata:{library:"sap.gantt",properties:{consumptionColor:{type:"sap.gantt.ValueSVGPaintServer",defaultValue:"lightgray"}},defaultAggregation:"periods",aggregations:{periods:{type:"sap.gantt.simple.UtilizationPeriod",group:"Data"}}},renderer:{apiVersion:2}});o.prototype.applySettings=function(e,r){e=e||{};e.remainCapacityColor=e.remainCapacityColor||"#fff";t.prototype.applySettings.call(this,e,r);this._createDefaultDefs()};o.prototype.renderElement=function(t,e){t.openStart("g",this);t.class("sapGanttUtilizationBar");t.openEnd();var r=this.getX(),o=this.getHeight(),n=this.getRowYCenter()-o/2,i=this.getWidth();var a={x:r,y:n,width:i,height:o};this.renderBackgroundDefs(t);this.renderUBCBackground(t,a);var s=this.filterPeriods();if(s.length>0){this._iMaxAllowedSupply=this._getMaxAllowedSupply(s);this.renderOverConsumptionPolygon(t,a,s);this.renderRemainConsumptionPolygon(t,a,s);this.renderConsumptionPolygon(t,a,s);this.renderConsumptionPath(t,a,s);this.renderTooltips(t,a,s)}t.close("g")};o.prototype.filterPeriods=function(){var t=this.getPeriods();var e=this.getGanttChartBase(),r=e.getRenderedTimeRange(),o=r[0],n=r[1];return t.filter(function(t,e,r){var i=e===0||e===r.length-1;if(i){return true}else{return t.getFrom()>=o&&t.getFrom()<=n}})};o.prototype.renderUBCBackground=function(t,e){var r=this.getFill();if(!r){r="url(#"+this.getId()+"-defaultBgPattern)"}var o=jQuery.extend({id:this.getId()+"-ubcBg",fill:r,"fill-opacity":this.getFillOpacity()},e);this.renderRectangleWithAttributes(t,o)};o.prototype.renderOverConsumptionPolygon=function(t,e,r){t.openStart("polygon",this.getId()+"-ubcOCP");t.attr("points",this.getPolygonPoints(e,function(t,r){var o=e.height,n=e.y+o;return n-t.getDemand()/r*o},r));t.attr("fill",this.getOverConsumptionColor());t.openEnd();t.close("polygon")};o.prototype.renderConsumptionPath=function(t,e,r){t.openStart("path",this.getId()+"-ubcPath");t.attr("d",this.getDemandPathD(e,r));t.attr("fill","none");t.attr("stroke",this.getStroke()||"#000");t.attr("stroke-width",this.getStrokeWidth()||2);t.attr("stroke-dasharray",this.getStrokeDasharray()||"0,0");t.openEnd();t.close("path")};o.prototype.renderRemainConsumptionPolygon=function(t,e,r){t.openStart("polygon",this.getId()+"-ubcRCP");t.attr("points",this.getPolygonPoints(e,function(t,r){var o=e.height,n=e.y+o;return n-t.getSupply()/r*o},r));t.attr("fill",this.getRemainCapacityColor());t.openEnd();t.close("polygon")};o.prototype.renderConsumptionPolygon=function(t,e,r){t.openStart("polygon",this.getId()+"-ubcCP");t.attr("points",this.getPolygonPoints(e,function(t,r){var o=e.height,n=e.y+o;var i=Math.min(t.getDemand(),t.getSupply());return n-i/r*o},r));t.attr("fill",this.getConsumptionColor());t.openEnd();t.close("polygon")};o.prototype.renderTooltips=function(t,r,o){var n=[];t.openStart("g");t.class("ubc-tooltips").openEnd();for(var i=0;i<o.length;i++){var a=o[i];var s=o[i+1];if(s){var l=this.toX(a.getFrom()),p=this.toX(s.getFrom());n.push(new e({x:parseFloat(l),y:r.y,height:r.height,width:Math.abs(p-l),fill:"transparent",tooltip:a.getTooltip()}).setProperty("childElement",true))}}n.forEach(function(e){e.renderElement(t,e)});t.close("g")};o.prototype._getMaxAllowedSupply=function(t){var e=Math.max.apply(null,t.map(function(t){return t.getSupply()}));var r=e*this.getOverConsumptionMargin()/100;return e+r};o.prototype.getPolygonPoints=function(t,e,r){var o=t.y+t.height;var n=function(t,e){return[t,e].join(",")+" "};var i="";for(var a=0;a<r.length;a++){var s=r[a],l=a===0,p=a===r.length-1,g=r[p?r.length-1:a+1];var h=this.toX(s.getFrom()),u=this.toX(g.getFrom());if(l){i+=n(h,o)}var d=e(s,this._iMaxAllowedSupply);d=d.toFixed(1);i+=n(h,d);i+=n(u,d);if(p){i+=n(h,d);i+=n(h,o)}}return i};o.prototype.getDemandPathD=function(t,e){var r="";for(var o=0;o<e.length;o++){var n=e[o],i=o===e.length-1,a=e[i?e.length-1:o+1];var s=this.toX(n.getFrom()),l=this.toX(a.getFrom());var p=this.toY(n.getDemand(),t),g=this.toY(a.getDemand(),t);r+=" M "+s+" "+p+" L "+l+" "+p;r+=" M "+l+" "+p+" L "+l+" "+g}return r};o.prototype.toY=function(t,e){var r=e.y,o=e.height,n=r+o;var i=n-t/this._iMaxAllowedSupply*o;i=i<r?r:i;return parseFloat(i.toFixed(1))};o.prototype._createDefaultDefs=function(){if(this.getFill()){return}this.mDefaultDefs=new sap.gantt.def.SvgDefs({defs:[new r({id:this.getId()+"-defaultBgPattern",tileWidth:5,tileHeight:9,backgroundColor:"#fff",stroke:"#ececec",strokeWidth:1})]})};o.prototype.renderBackgroundDefs=function(t){if(this.getFill()==null&&this.mDefaultDefs){t.unsafeHtml(this.mDefaultDefs.getDefString())}};return o},true);
//# sourceMappingURL=UtilizationBarChart.js.map
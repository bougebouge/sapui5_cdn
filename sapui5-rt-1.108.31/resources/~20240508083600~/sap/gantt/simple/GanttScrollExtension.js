/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/ui/Device","../misc/Format","../config/TimeHorizon","./GanttExtension","./RenderUtils","./GanttUtils","sap/gantt/simple/AggregationUtils"],function(jQuery,t,e,i,n,o,r,s,a){"use strict";var l=function(e,i){var n=t.getConfiguration().getRTL();var o=n?"scrollLeftRTL":"scrollLeft";if(typeof i==="number"){e[o](i)}return e[o]()};var h=".sapGanttScroll";var f="scroll"+h;var c={onHSBScroll:function(t){if(this._iScrollTimer!==null){clearTimeout(this._iScrollTimer)}this._iScrollTimer=setTimeout(function(){this._getScrollExtension().updateVisibleHorizonIfNecessary()}.bind(this),150)},onMouseWheelScrolling:function(t){if(t.shiftKey&&t.ctrlKey){return}var e=0;if("detail"in t){e=t.detail}if("wheelDelta"in t){e=t.wheelDelta/120}if("wheelDeltaY"in t){e=t.wheelDeltaY/120}var i=Math.abs(e)>=1;var n=t.deltaX;var o=t.deltaY;if(i){n=t.deltaY;o=t.deltaX}var r=Math.abs(n)>Math.abs(o);var s=this._getScrollExtension(),a=r&&t.shiftKey;var l=r?n:o,h=l>0,f=false;if(l===0){return}if(a){var c=s.getGanttHsb();if(h){f=c.scrollLeft===c.scrollWidth-c.offsetWidth}else{f=c.scrollLeft===0}if(!f){c.scrollLeft=c.scrollLeft+l}t.preventDefault();t.stopPropagation()}},getEventListenerTargets:function(t){var e=[t.getDomRef("svg"),t.getDomRef("header-svg")];return e.filter(function(t){return t!=null})},onTouchStart:function(t){if(t.type==="touchstart"||t.pointerType==="touch"){var e=this._getScrollExtension(),i=e.getGanttHsb();var n=t.touches?t.touches[0]:t;e._mTouchSessionData={initialPageX:n.pageX,initialPageY:n.pageY,initialScrollLeft:i?i.scrollLeft:0,initialScrolledToEnd:null}}},onTouchMoveHorizontalScrolling:function(t){if(t.type==="touchmove"||t.pointerType==="touch"){var e=this._getScrollExtension();var i=e._mTouchSessionData;var n=t.touches?t.touches[0]:t;var o=n.pageX-i.initialPageX;var r=n.pageY-i.initialPageY;var s=false;var a=false;var l=Math.abs(o)>Math.abs(r);if(!i||!l){return}var h=e.getGanttHsb();if(o<0){s=h.scrollLeft===h.scrollWidth-h.offsetWidth}else{s=h.scrollLeft===0}if(!i.initialScrolledToEnd){i.initialScrolledToEnd=s}if(!s&&!i.initialScrolledToEnd){h.scrollLeft=i.initialScrollLeft-o;a=true}if(a){t.preventDefault()}}},addEventListeners:function(t){var e=t._getScrollExtension();this.removeEventListeners(t);jQuery(e.getGanttHsb()).on(f,this.onHSBScroll.bind(t));var i=this.getEventListenerTargets(t);e._mTouchEventListener=this.addTouchEventListener(i,t);e._mMouseWheelEventListener=this.addMouseWheelEventListener(i,t)},removeEventListeners:function(t){var e=t._getScrollExtension();jQuery(e.getGanttHsb()).off(h);c.removeScrollEventListeners(t)},addMouseWheelEventListener:function(t,e){var i=c.onMouseWheelScrolling.bind(e);for(var n=0;n<t.length;n++){t[n].addEventListener("wheel",i)}return{wheel:i}},addTouchEventListener:function(t,i){var n=c.onTouchStart.bind(i);var o=c.onTouchMoveHorizontalScrolling.bind(i);var r={};for(var s=0;s<t.length;s++){if(e.support.pointer&&e.system.desktop){t[s].addEventListener("pointerdown",n);t[s].addEventListener("pointermove",o,e.browser.chrome?{passive:true}:false)}else if(e.support.touch){t[s].addEventListener("touchstart",n);t[s].addEventListener("touchmove",o)}}if(e.support.pointer&&e.system.desktop){r={pointerdown:n,pointermove:o}}else if(e.support.touch){r={touchstart:n,touchmove:o}}return r},removeScrollEventListeners:function(t){var e=t._getScrollExtension();var i=c.getEventListenerTargets(t);function n(t,e){for(var i in e){var n=e[i];if(n){t.removeEventListener(i,n)}}}for(var o=0;o<i.length;o++){n(i[o],e._mTouchEventListener);n(i[o],e._mMouseWheelEventListener)}delete e._mTouchEventListener;delete e._mMouseWheelEventListener}};var g=o.extend("sap.gantt.GanttScrollExtension",{_init:function(t,e){this.oGanttHsb=null;this._bSuppressSetVisibleHorizon=false;this.mOffsetWidth=null;return"ScrollExtension"},_attachEvents:function(){var t=this.getGantt();c.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();c.removeEventListeners(t)},destroy:function(){this._detachEvents();this._delegate=null;this.oGanttHsb=null;this.mOffsetWidth=null;o.prototype.destroy.apply(this,arguments)}});g.prototype.updateVisibleHorizonIfNecessary=function(){var t=this.getGantt();if(t){if(!this._bSuppressSetVisibleHorizon){this._updateVisibleHorizonForce()}this._bSuppressSetVisibleHorizon=false;t.getAggregation("_header").renderElement();if(!this.scrollTimer){this.scrollTimer=window.setTimeout(function(){if(s.isDynamicText()){t.getTable().rerender()}var e=t._getDragDropExtension();if(e._bEnableRowHighlight&&e.isDragging()){e.getShapeDndRowHighlightIndex(t);t.toggleDnDRowHighlight(true)}this.scrollTimer=null}.bind(this),500)}}};g.prototype._updateVisibleHorizonForce=function(){var t=this._scrollLeftToVisibleHorizon();this.getGantt()._updateVisibleHorizon(t,"horizontalScroll",this.getVisibleWidth())};g.prototype.jumpToVisibleHorizon=function(t){this.getGantt()._updateVisibleHorizon(this.getGantt().getAxisTimeStrategy().getVisibleHorizon(),t||"horizontalScroll",this.getVisibleWidth())};g.prototype._getGanttHsbScrollLeft=function(){return l(jQuery(this.getGanttHsb()))};g.prototype.getContentWidth=function(){var t=this.getGantt();var e=t.getAxisTime(),i=e.getViewRange();return Math.abs(Math.ceil(i[1])-Math.ceil(i[0]))};g.prototype.updateGanttScrollWidth=function(){var t=this.getGantt();t.getSyncedControl().setInnerWidth(t.getContentWidth()+"px")};g.prototype.getVisibleWidth=function(){return jQuery(document.getElementById(this.getGantt().getId()+"-gantt")).width()};g.prototype.scrollGanttChartToVisibleHorizon=function(){var t=this._visibleHorizonToScrollLeft();var e=t-this.mOffsetWidth.svgOffset;var i=this.getDomRefs(),n=jQuery(i.gantt),o=jQuery(i.header),r=this.getGantt();if(Math.abs(l(n)-e)>(r._iDiff||0)){var s=this.getGanttHsb();if(s){if(l(jQuery(s))===0){l(n,0);l(o,0)}else{l(n,e);l(o,e)}if(l(n)!==0){r._iDiff=Math.abs(l(n)-e)}}}this.getGantt()._getConnectExtension().updateShapeConnectEffect(this)};g.prototype.clearOffsetWidth=function(){this.mOffsetWidth=null;this.getGantt().getAxisTime().setViewOffset(0)};g.prototype.needRerenderGantt=function(t,e,i){if(this.mOffsetWidth===null&&!i){this.updateGanttScrollWidth()}if(!i&&e!=="initialRender"&&this.mOffsetWidth&&this.doesSvgScrollWithinBuffer()&&!this.getGantt().getSyncedControl().getRowsHeightChanged()){this._scrollTableToVisibleHorizon(true);this.scrollGanttChartToVisibleHorizon();this.getGantt().getSyncedControl().scrollContentIfNecessary();return false}this._scrollTableToVisibleHorizon(true);this.updateSvgOffsetWidth();if((e!=="initialRender"||e==="initialRender"&&i)&&t){t.apply(this.getGantt());this.scrollGanttChartToVisibleHorizon();this.getGantt().getSyncedControl().scrollContentIfNecessary()}return true};g.prototype._scrollTableToVisibleHorizon=function(t){var e=jQuery(this.getGanttHsb()),i=l(e);var n=this._visibleHorizonToScrollLeft();if(Math.abs(i-n)>1){this._bSuppressSetVisibleHorizon=t;l(e,n)}};g.prototype.updateSvgOffsetWidth=function(){var t=this.calcSvgLatestOffsetWidth();this.getGantt().getAxisTime().setViewOffset(t.svgOffset);this.getGantt().iGanttRenderedWidth=t.svgWidth;this.mOffsetWidth={svgWidth:t.svgWidth,svgOffset:t.svgOffset}};g.prototype.doesSvgScrollWithinBuffer=function(){var t=this.getVisibleWidth(),e=this.getContentWidth(),i=this._visibleHorizonToScrollLeft();if(this.mOffsetWidth===null){return false}var n=this.mOffsetWidth.svgOffset,o=this.mOffsetWidth.svgWidth;var r=t>=e||i-n>=0&&o>=i-n+t;return r};g.prototype.calcSvgLatestOffsetWidth=function(){var t=this.getContentWidth(),e=this.getVisibleWidth();var i=this._getGanttHsbScrollLeft()||0;var n=r.getGanttRenderWidth(this.getGantt());var o=i-e*r.RENDER_EXTEND_FACTOR;if(o<0){n+=o;o=0}if(o+n>t){n=t-o}return{svgWidth:n,svgOffset:o}};g.prototype._visibleHorizonToScrollLeft=function(){var e=this.getGantt().getAxisTimeStrategy().getVisibleHorizon();var n=t.getConfiguration().getRTL(),o=e.getStartTime();var r=this.getGantt().getAxisTime().timeToView(i.abapTimestampToDate(o),true);if(n){r=r-this.getVisibleWidth()}if(r<0){r=0}return r};g.prototype._scrollLeftToVisibleHorizon=function(){var e=t.getConfiguration().getRTL(),i=this.getGantt().getAxisTime();var o=this._getGanttHsbScrollLeft();var r=i.viewToTime(o,true),s;if(e){s=i.viewToTime(o,true);r=undefined}return new n({startTime:r,endTime:s})};g.prototype.getGanttHsb=function(){var t=this.getGantt();if(t){this.oGanttHsb=t.getDomRef("hsb")}return this.oGanttHsb};return g});
//# sourceMappingURL=GanttScrollExtension.js.map
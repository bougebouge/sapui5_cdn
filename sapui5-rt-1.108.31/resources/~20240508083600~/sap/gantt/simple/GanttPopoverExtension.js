/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","sap/ui/core/Core","sap/gantt/misc/Utility","./GanttExtension","./GanttUtils","./CoordinateUtils","sap/gantt/library"],function(jQuery,e,t,o,i,n,s,r){"use strict";var a=".sapGanttPopover";var p="mousedown";var v=p+a;var h=["mousemove","mouseup","keydown"];var g=h.reduce(function(e,t){e[t]=t;return e},{});var f=h.map(function(e){return e+a});var u={dispatchEvent:function(e){var t=this._getPopoverExtension();if(e.type===g.mousemove){t.onMouseMove(e)}else if(e.type===g.mouseup){t.onMouseUp(e)}else if(e.type===g.keydown){t.onKeydown(e)}},entry:function(e){var t=this._getPopoverExtension();t.onMouseDown(e)},addEventListeners:function(e){this.removeEventListeners(e);var t=jQuery(e._getPopoverExtension().getDomRefs().ganttSvg);t.on(v,u.entry.bind(e))},removeEventListeners:function(e){var t=jQuery(e._getPopoverExtension().getDomRefs().ganttSvg);t.off(v)},addPopoverEventListeners:function(e){this.removePopoverEventListeners(e);f.forEach(function(t){jQuery(document).on(t,u.dispatchEvent.bind(e))})},removePopoverEventListeners:function(e){jQuery(document).off(a)}};var d=r.dragdrop.SnapMode;var c=i.extend("sap.gantt.simple.GanttPopoverExtension",{_init:function(e,t){this._initPopoverStates();return"PopoverExtension"},_attachEvents:function(){var e=this.getGantt();u.addEventListeners(e)},_detachEvents:function(){var e=this.getGantt();u.removeEventListeners(e)}});c.prototype._initPopoverStates=function(){this._iOffsetX=10;this._iOffsetY=32;this._bNeedReverse=false;this.snapTimer=null};c.prototype.onMouseMove=function(e){var t=this.getGantt()._getDragDropExtension();if(this.getGantt().getShowShapeTimeOnDrag()&&this.isDraggingOrResizing(e)){if(this.getGantt().getSnapMode()!==d.None){this._showPopoverOnSnap(e,true)}else{this._showPopover(e,true)}}else if(t.isDragging()&&this.bMultipleShapes){if(this.getGantt().getSnapMode()!==d.None){this._showPopoverOnSnap(e)}else{this._showPopover(e)}}};c.prototype._showPopoverOnSnap=function(e,t){if(this.snapTimer){window.clearTimeout(this.snapTimer);this.snapTimer=null}this.snapTimer=window.setTimeout(function(){this._showPopover(e,t)}.bind(this),100)};c.prototype.onMouseDown=function(e){var t=this.getGantt().getSelection();var o=t.numberOfSelectedDraggableShapes();this.bMultipleShapes=o>1;this.pageWidth=window.innerWidth;this.pageHeight=window.innerHeight;u.addPopoverEventListeners(this.getGantt())};c.prototype.onMouseUp=function(e){u.removePopoverEventListeners(this.getGantt());this._hidePopover(e);this._initPopoverStates()};c.prototype.onKeydown=function(t){if(t.keyCode===e.ESCAPE){u.removePopoverEventListeners(this.getGantt());this._hidePopover(t);this._initPopoverStates()}};c.prototype.isDraggingOrResizing=function(e){var t=this.getGantt()._getDragDropExtension();var o=this.getGantt()._getResizeExtension();return t.isDragging()&&!this.bMultipleShapes||o.isResizing()};c.prototype._buildPopover=function(e,o){var i=t.getLibraryResourceBundle("sap.gantt").getText("GNT_CURRENT_START");var n=t.getLibraryResourceBundle("sap.gantt").getText("GNT_CURRENT_END");var s=this.getGantt()._getDragDropExtension();var r=s.getNumberOfDragObject();var a=function(e,t){var o="<span class='sapUiTinyMarginEnd sapMLabel'>"+e+"</span>"+"<span class='sapMLabel "+t+"'></span>";return"<div class='sapUiTinyMargin'>"+o+"</div>"};var p=function(e,t){var o="<span class='sapMLabel "+t+"'>"+e+"</span>";return"<div class='sapUiTinyMargin sapGanttPopoverCountText'>"+o+"</div>"};if(o){this.oTimePopover=jQuery("<div id='sapGanttPopoverWrapper' class='sapGanttDragElementHidden'>"+a(i,"sapGanttPopoverStartTime")+a(n,"sapGanttPopoverEndTime")+"</div>")}else{this.oCountPopover=jQuery("<div id='sapGanttPopoverWrapper' class='sapGanttDragElementHidden'>"+p(r,"sapGanttPopoverObjectCount")+"</div>")}this.createAnchor();this._calcPopoverOffset();var v=jQuery(document.getElementById("sapGanttPopoverAnchor"));if(o){v.append(this.oTimePopover)}else{v.append(this.oCountPopover)}var h=this._getPopoverData(e,o);this._updateTime(h,o)};c.prototype._updateTime=function(e,o){var i=t.getConfiguration().getRTL();var n=i?"marginRight":"marginLeft";var s={marginTop:e.offsetY+"px"};s[n]=e.offsetX+"px";var r=jQuery(document.getElementById("sapGanttPopoverWrapper")).css(s);if(o){r.find(".sapGanttPopoverStartTime").text(e.startNewDate);r.find(".sapGanttPopoverEndTime").text(e.endNewDate)}};c.prototype._getDragDropOrResizingDom=function(){var e=this.getGantt()._getDragDropExtension();var t=this.getGantt()._getResizeExtension();if(e.isDragging()){return e.dragGhost.get(0).children[0]}else if(t.isResizing()){var o=n.getShapesWithUid(this.getGantt().getId(),[t.origin.resizeFor]);if(o.length===1&&o[0]){return document.getElementById(o[0].getShapeUid()+"-selected")}}};c.prototype.createAnchor=function(e){var t=jQuery(document.getElementById("sapGanttPopoverAnchor"));if(t.length===0){t=jQuery("<div id='sapGanttPopoverAnchor'></div>");jQuery(document.body).append(t)}this._oTargetDom=t.get(0)};c.prototype.moveAnchor=function(e,t){var o=s.getEventPosition(e),i=o.pageX,n=o.pageY,r=this.pageWidth,a=this.pageHeight;if(i<-this._iOffsetX){i=-this._iOffsetX}else if(i>r+this._iOffsetX){i=r+this._iOffsetX}var p=this._iOffsetY;if(t&&this.oTimePopover){p+=this.oTimePopover.height()}else if(!t&&this.oCountPopover){p+=this.oCountPopover.height()}if(n<-this._iOffsetY){n=-this._iOffsetY}else if(n>a-p){n=a-p}var v=document.getElementById("sapGanttPopoverAnchor");if(v){v.style.left=i+"px";v.style.top=n+"px"}};c.prototype.checkIfNeedReverse=function(e,o){var i=t.getConfiguration().getRTL();var n=s.getEventPosition(e);var r=o?this.oTimePopover.width()+10:this.oCountPopover.width()+10;if(i&&n.pageX<r||!i&&n.pageX+r>=this.pageWidth||this.getGantt().getGhostAlignment()!=="End"&&this.bMultipleShapes){this._bNeedReverse=true}else{this._bNeedReverse=false}};c.prototype._showPopover=function(e,t){this.moveAnchor(e,t);if(t&&this.oTimePopover||!t&&this.oCountPopover){document.getElementById("sapGanttPopoverWrapper").classList.remove("sapGanttDragElementHidden");this.checkIfNeedReverse(e,t);this._calcPopoverOffset();var o=this._getPopoverData(e,t);this._updateTime(o,t)}else{this._buildPopover(e,t)}};c.prototype._hidePopover=function(){var e=document.getElementById("sapGanttPopoverAnchor");if(e){e.parentNode.removeChild(e)}this.oTimePopover=null;this.oCountPopover=null};c.prototype._getPopoverData=function(e,t){var i=this._iOffsetX;if(this._bNeedReverse){i=t?-i-this.oTimePopover.width():-i-this.oCountPopover.width()}var s={offsetX:i,offsetY:this._iOffsetY};if(t){var r=this._getCurrentTime(e);if(r){var a=n.getTimeFormaterBySmallInterval(this.getGantt());s.startNewDate=o.getLowerCaseLabel(a.format(r.time));s.endNewDate=o.getLowerCaseLabel(a.format(r.endTime))}}return s};c.prototype._getCurrentTime=function(e){var t=this.getGantt()._getDragDropExtension();var o=this.getGantt()._getResizeExtension();if(t.isDragging()){return t._getGhostTime(e,true)}else if(o.isResizing()){return o._getResizeTime(e)}};c.prototype._calcPopoverOffset=function(){this._iOffsetY=this._getOffsetY()};c.prototype._getOffsetY=function(){var e=this._getDragDropOrResizingDom();var t=e&&e.getBoundingClientRect();var o=32;if(t){o=t.height+2}return Math.ceil(o)};c.prototype._updatePopoverWhenAutoScroll=function(e){if(this.getGantt().getShowShapeTimeOnDrag()&&this.isDraggingOrResizing()){this._showPopover(e,true)}};return c});
//# sourceMappingURL=GanttPopoverExtension.js.map
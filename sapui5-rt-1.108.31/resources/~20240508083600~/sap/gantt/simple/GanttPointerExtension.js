/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/gantt/misc/Utility","./GanttExtension","../drawer/CursorLine","./CoordinateUtils","./GanttUtils","sap/ui/core/format/DateFormat","sap/m/Text","sap/ui/core/format/TimezoneUtil"],function(jQuery,t,e,o,r,i,n,a,l,s){"use strict";var c=".sapGanttPointer";var u="contextmenu"+c;var g=sap.gantt.DragOrientation;var h=["mouseenter","mouseleave","click","dblclick","mouseup","mousedown"],f=h.map(function(t){return t+c});var d="mousemove",p=d+c,S=p+" mouseup"+c;var v=h.reduce(function(t,e){t[e]=e;return t},{});v[d]=d;var m={Forward:"forward",Backward:"backward",Bottom:"bottom",Top:"top"};var b=50;var w=null;var A={addEventListeners:function(t){var e=t._getPointerExtension(),o=jQuery(e.getDomRefs().ganttSvg),r=jQuery(e.getDomRefs().headerSvg);A.removeEventListeners(t);if(w===null){w=n.adhocLinesPresentAndEnabled(t)}f.forEach(function(t){o.on(t,e.onGanttChartMouseEvent.bind(e));if(w){r.on(t,e.onGanttChartMouseEvent.bind(e))}else{r.off(t,e.onGanttChartMouseEvent.bind(e))}});o.on(S,e.onCrossSvgMouseEvent.bind(e));r.on(S,e.onCrossSvgMouseEvent.bind(e));o.on(p,e.updateGanttCursorLine.bind(e));this.bindBackgroundRowEvent(o,e,t);e._bIsMouseOnCorrectRow=true;e._bMouseOnSvg=true;if(w){this.bindBackgroundRowEventHeader(r,e)}else{this.unbindBackgroundRowEventHeader(r)}r.on(v.mousedown+c,function(e){var o=t._getDragDropExtension();if(!o.isEventTargetAdhocLine(e)&&!o.isEventTargetDeltaLine(e)){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();return false}});jQuery(document.getElementById(t.getId())).on(p,i.updateCursorPosition)},removeEventListeners:function(t){var e=t._getPointerExtension(),o=jQuery(e.getDomRefs().ganttSvg),r=jQuery(e.getDomRefs().headerSvg);o.off(c);if(w===null){w=n.adhocLinesPresentAndEnabled(t)}if(w){r.on(v.mousedown+c)}else{r.off(v.mousedown+c)}this.unbindBackgroundRowEvent(o)},doGanttAutoScroll:function(e,o,r,i){var n=e._getPointerExtension();if(n.iTableAutoScrollTimerId){window.clearTimeout(n.iTableAutoScrollTimerId);n.iTableAutoScrollTimerId=null}if(n._bAutoScroll){if(!n.allowAutoScroll()){return}if(!e._getDragDropExtension().isSnapping){n._toggleCursorLine(false)}var a=e._getResizeExtension();if(a.isResizing()){a.onResizing(r)}var l=e._getConnectExtension();if(l.isShapeConnecting()){l.onShapeConnecting(r)}var s=e._getPopoverExtension();s._updatePopoverWhenAutoScroll(r);var c=e._getZoomExtension();c._handleAutoScroll(r);var u=t.getConfiguration().getRTL();var g=30;if(m.Backward===o||m.Top===o){g=-1*g}if(m.Backward===o||m.Forward===o){n._iStep=g}else{n._iStep=0}var h=this.getScrollArea(e,o);var f,d=false;if(o===m.Forward||o===m.Backward){f=u?"scrollLeftRTL":"scrollLeft";d=true}else{f="scrollTop";d=false}l.storeScrollDistance(g,d);var p=h[f]()+g;h[f](p);var S=h[f]();if(S!==p){l.storeScrollDistance(S-p,d)}if(!(i!==undefined&&i===S)){n.iTableAutoScrollTimerId=window.setTimeout(A.doGanttAutoScroll.bind(A),b,e,o,r,S)}}},getScrollArea:function(t,e){var o;var r=t.getTable();var i=jQuery(r.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar));if(e===m.Forward||e===m.Backward){o=jQuery(document.getElementById(t.getId()+"-hsb"))}else{o=i}return o},bindBackgroundRowEvent:function(t,e,o){function r(t){jQuery(t).on(v.mouseenter+c+" "+v.mouseleave+c,function(t){var r=e._getRowIndexFromEvent(t);var i=o._getDragDropExtension();e._bIsMouseOnCorrectRow=true;if(i._bEnableRowHighlight&&i.isDragging()){e._bIsMouseOnCorrectRow=false;if(i.oLastDraggedShapeData._highlightedRowIndex){i.oLastDraggedShapeData._highlightedRowIndex.forEach(function(t){if(t===r){e._bIsMouseOnCorrectRow=true}})}}e.onMouseHover(r,t.type===v.mouseenter)});jQuery(t).on(v.click+c+" "+v.dblclick+c,function(t){e.dispatchGanttClick(t)});jQuery(t).on(u,function(t){e.onGanttChartContextMenu(t)})}var i=t.find("rect.sapGanttBackgroundSVGRow");var n=i.length;for(var a=0;a<n;a++){r(i[a])}},bindBackgroundRowEventHeader:function(t,e){jQuery(t[0]).on(v.click+c+" "+v.dblclick+c,function(t){e.dispatchGanttClickHeader(t)})},unbindBackgroundRowEvent:function(t){var e=t.find("rect.sapGanttBackgroundSVGRow");var o=e.length;for(var r=0;r<o;r++){jQuery(e[r]).off(c)}},unbindBackgroundRowEventHeader:function(t){jQuery(t[0]).off(c)}};var T=o.extend("sap.gantt.simple.GanttPointerExtension",{_init:function(t,e){this._oCursorLineDrawer=new r;this.bPreventSingleClick=false;this.iTableAutoScrollTimerId=null;this._iStep=0;return"PointerExtension"},_attachEvents:function(){var t=this.getGantt();A.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();A.removeEventListeners(t)},destroy:function(){if(this._oCursorLineDrawer){this._oCursorLineDrawer.destroy()}delete this.bPreventSingleClick}});T.prototype.onGanttChartContextMenu=function(t){t.preventDefault();if(t.target===t.currentTarget){var e=this.getGantt();var o=this._getRowIndexFromEvent(t);var r=e.getTable().getRows()[o];e.fireShapeContextMenu({row:r,pageX:t.pageX,pageY:t.pageY})}};T.prototype.onGanttChartMouseEvent=function(t){this.updateGanttCursorLine(t);if(t.type===v.mousedown){this.oMousedownTargetElement=t.target}this.onMouseEnterLeaveEvent(t)};T.prototype.onCrossSvgMouseEvent=function(t){var e=this.getGantt();if(t.type===v.mousemove){if(this.needAutoscrollInContainerIfNecessary()){this.updateCursorStyle("move");this.tableAutoScroll(t)}else{var o=e._getDragDropExtension();var r=e._getConnectExtension();var i=e._getResizeExtension();var n=e._getZoomExtension();if(o.isDeltaLineDragging()||o.isAdhocLineDragging()||o.isDragging()||i.isResizing()||r.isShapeConnecting()||n.isTimeZooming()){this.tableAutoScroll(t)}}}if(t.type===v.mouseup){this.oMouseupTargetElement=t.target;this._bAutoScroll=false}};T.prototype.needAutoscrollInContainerIfNecessary=function(){var t=this.getGantt().getParent();if(t&&t.getGanttCharts){var e=t.getGanttCharts();var o=this.getGantt();return e.some(function(t){return t!==o&&t._getDragDropExtension().isDragging()})}return false};T.prototype.updateCursorStyle=function(t){document.body.style.cursor=t;this.getDomRefs().ganttSvg.style.cursor=t};T.prototype.isPointerInGanttChart=function(t){return this._bMouseOnSvg};T.prototype.isPointerInCorrectRow=function(t){return this._bIsMouseOnCorrectRow};T.prototype.onMouseEnterLeaveEvent=function(t){this.updateCursorStyle("default");if(t.type===v.mouseenter){this._bMouseOnSvg=true}else if(t.type===v.mouseleave){this._bMouseOnSvg=false}};T.prototype.dispatchGanttClick=function(t){if(this.isEventTargetOnGanttRow(t)===false){return}if(t.type===v.click){if(this.oMousedownTargetElement===this.oMouseupTargetElement){this.onGanttSingleClick(t);delete this.oMouseupTargetElement;delete this.oMousedownTargetElement}}else if(t.type===v.dblclick){this.onGanttDoubleClick(t)}};T.prototype.dispatchGanttClickHeader=function(t){if(t.type===v.click){this.onGanttSingleClick(t);delete this.oMouseupTargetElement;delete this.oMousedownTargetElement}};T.prototype.isEventTargetOnGanttRow=function(t){return jQuery(t.target).hasClass("sapGanttBackgroundSVGRow")};T.prototype._getRowIndexFromEvent=function(t){return parseInt(t.target.getAttribute("data-sap-ui-index"),10)};T.prototype._getRowIndexFromElement=function(t){return parseInt(t.getAttribute("data-sap-ui-index"),10)};T.prototype.onGanttSingleClick=function(t){this.getGantt().getSelection().clearAllSelectedShapeIds();this.getGantt().getSelection().updateShape(null,{selected:false,ctrl:t.ctrlKey||t.metaKey});var e=this.getGantt();n.resetStrokeDasharray(e);var o=this._getRowIndexFromEvent(t);var r=e.getTable().getRows()[o];if(!r){return}var i=function(){if(this.bPreventSingleClick===false){this._selectTableRow(e,o);e.fireShapePress({shape:null,row:r})}this.bPreventSingleClick=false}.bind(this);if(e.getDisableShapeDoubleClickEvent()){this.bPreventSingleClick=false;i();return}this.iSingleClickTimer=window.setTimeout(i.bind(this),300)};T.prototype.onGanttDoubleClick=function(t){var e=this.getGantt(),o=e.getDisableShapeDoubleClickEvent(),r,i;if(!o){window.clearTimeout(this.iSingleClickTimer);this.bPreventSingleClick=true}r=this._getRowIndexFromEvent(t);i=e.getTable().getRows()[r];this._selectTableRow(e,r);if(!o){e.fireShapeDoubleClick({shape:null,row:i})}};T.prototype._selectTableRow=function(t,e){var o=this.getGantt().getTable().getSelectionBehavior();var r=sap.ui.table.SelectionBehavior;if(r.Row===o||r.RowOnly===o){t.getSyncedControl().syncRowSelection(e)}};T.prototype.onMouseHover=function(t,e){this.getGantt().getSyncedControl().syncRowHover(t,e)};T.prototype._getAutoScrollStep=function(){if(this._bAutoScroll){return this._iStep}return 0};T.prototype.updateGanttCursorLine=function(t){if(this.getGantt().getEnableCursorLine()===false){return}if(this.getGantt()._getDragDropExtension().isSnapping){return}if(t.type===v.mousemove){var e=i.getEventSVGPoint(this.getDomRefs().ganttSvg,t);this._toggleCursorLine(true,e)}else if(t.type===v.mouseleave){this._toggleCursorLine(false)}};T.prototype._toggleCursorLine=function(t,e){var o=this._getCursorLineDOMs();var r=this.getGantt().getParent();var i=r.isA("sap.gantt.simple.GanttChartContainer")&&r.getEnableStatusBar();if(t){this._oCursorLineDrawer.drawSvg(o.allGanttSvg,o.allHeaderSvg,this.getGantt().getLocale(),e);if(i){this.customBar(r,true,this.getGantt().getAxisTime().viewToTime(e.x))}}else{this._oCursorLineDrawer.destroySvg(o.allGanttSvg,o.allHeaderSvg);if(i){this.customBar(r,false)}}};T.prototype.customBar=function(t,o,r){var i=new l({text:""});var n=a.getDateTimeWithTimezoneInstance({pattern:t.getStatusBarDatePattern(),calendarWeekNumbering:this.getGantt().getAxisTimeStrategy().getCalendarWeekNumbering(),showTimezone:false});var s=a.getDateTimeWithTimezoneInstance({pattern:t.getStatusBarTimePattern(),showTimezone:false});t.msgText.setWidth(o?"70%":"100%");t.dateTimeText.setWidth(o?"30%":"0%");t.dateTimeText.setText(o?e.getLowerCaseLabel(e.getFormattedDate(n,r)+" "+e.getFormattedDate(s,r)):i.getText())};T.prototype._getCursorLineDOMs=function(){return{allHeaderSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartHeaderSvg"),allGanttSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartSvg")}};T.prototype.tableAutoScroll=function(t){this._bAutoScroll=false;var e=this.getGantt();var o=e._getDragDropExtension();var r=o.isDragging();var i=e.getDragOrientation();var n=r&&i===g.Horizontal;var a=r&&i===g.Vertical;if(this.ifAutoScrollToRight()&&!a){window.setTimeout(function(){A.doGanttAutoScroll(this.getGantt(),m.Forward,t)}.bind(this),b)}else if(this.ifAutoScrollToLeft()&&!a){window.setTimeout(function(){A.doGanttAutoScroll(this.getGantt(),m.Backward,t)}.bind(this),b)}else if(this.ifAutoScrollToDown()&&!n){window.setTimeout(function(){A.doGanttAutoScroll(this.getGantt(),m.Bottom,t)}.bind(this),b)}else if(this.ifAutoScrollToUp()&&!n){window.setTimeout(function(){A.doGanttAutoScroll(this.getGantt(),m.Top,t)}.bind(this),b)}else{this._bAutoScroll=false}};T.prototype.ifAutoScrollToRight=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationX>t.oScrollAreaRect.left+t.iScrollAreaWidth-t.iScrollTriggerAreaWidth&&t.iLocationX<t.oScrollAreaRect.left+t.iScrollAreaWidth&&t.iScrollAreaScrollLeft+t.iScrollAreaWidth<t.oScrollArea.scrollWidth;return this._bAutoScroll};T.prototype.ifAutoScrollToLeft=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationX<t.oScrollAreaRect.left+t.iScrollTriggerAreaWidth&&t.iLocationX>t.oScrollAreaRect.left&&t.iScrollAreaScrollLeft>0;return this._bAutoScroll};T.prototype.ifAutoScrollToDown=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationY>t.oVisibleScrollAreaRect.top+t.iVisibleScrollAreaHeight-t.iScrollTriggerAreaHeight&&t.iLocationY<t.oVisibleScrollAreaRect.top+t.iVisibleScrollAreaHeight&&t.iScrollAreaScrollTop+t.iScrollAreaHeight-t.iBaseRowHeight<=t.iScrollHeight;return this._bAutoScroll};T.prototype.ifAutoScrollToUp=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationY<t.oVisibleScrollAreaRect.top+t.iScrollTriggerAreaHeight&&t.iLocationY>t.oVisibleScrollAreaRect.top;return this._bAutoScroll};T.prototype.getAutoScrollPosition=function(){var e=t.getConfiguration().getRTL();var o=this.getGantt().getTable();var r=20,n=20,a=document.getElementById(this.getGantt().getId()+"-gantt"),l=jQuery(a),s=a.getBoundingClientRect(),c=l.outerWidth(),u=l.outerHeight(),g=s,h=u,f=this.getGantt()._oExpandModel.getBaseRowHeight(),d=e?l.scrollLeftRTL():l.scrollLeft();var p=jQuery(o.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar)),S=p.scrollTop(),v=p.get(0).scrollHeight;var m=i.getLatestCursorPosition().pageX,b=i.getLatestCursorPosition().pageY;return{iLocationX:m,iLocationY:b,oScrollAreaRect:s,oScrollArea:a,iScrollAreaWidth:c,iScrollTriggerAreaWidth:r,iScrollTriggerAreaHeight:n,iScrollAreaScrollLeft:d,oVisibleScrollAreaRect:g,iVisibleScrollAreaHeight:h,iScrollAreaScrollTop:S,iBaseRowHeight:f,iScrollHeight:v,iScrollAreaHeight:u}};T.prototype.allowAutoScroll=function(){return this.ifAutoScrollToRight()||this.ifAutoScrollToLeft()||this.ifAutoScrollToDown()||this.ifAutoScrollToUp()};return T});
//# sourceMappingURL=GanttPointerExtension.js.map
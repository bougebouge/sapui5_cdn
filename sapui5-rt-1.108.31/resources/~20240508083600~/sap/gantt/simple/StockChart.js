/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/util/merge","./UtilizationChart","sap/ui/core/Core","sap/gantt/simple/StockChartPeriod"],function(e,t,i,r){"use strict";var o=t.extend("sap.gantt.simple.StockChart",{metadata:{library:"sap.gantt",properties:{showMiddleLine:{type:"boolean",defaultValue:true},relativeMiddleLinePoint:{type:"float",group:"Misc",defaultValue:50},minValue:{type:"float",group:"Misc",defaultValue:0},maxValue:{type:"float",group:"Misc",defaultValue:100},showCompactView:{type:"boolean",defaultValue:true}},defaultAggregation:"stockChartDimensions",aggregations:{stockChartDimensions:{type:"sap.gantt.simple.StockChartDimension",group:"Data"}}},renderer:{apiVersion:2}});o.prototype.applySettings=function(e,i){e=e||{};t.prototype.applySettings.call(this,e,i)};o.prototype.renderElement=function(e,t){var i=8;if(this.getStockChartDimensions().length===0){this._renderEmptyDomRefs(e,true);return}this._renderEmptyDomRefs(e,false);var r=this.getX(),o=this.getHeight(),a=this.getRowYCenter()-o/2,g=this.getWidth();var n={x:r,y:this.getShowCompactView()?a+i/2:a,width:g,height:this.getShowCompactView()?o-i:o};this._renderDefsDimensionClipPaths(e,n);this._renderMiddleLine(e,n);this._renderDimensionPaths(e,n);this._renderTooltips(e,n);e.close("g")};o.prototype._renderEmptyDomRefs=function(e,t){e.openStart("g",this);e.class("sapGanttStock");e.openEnd();if(t){e.close("g")}};o.prototype._renderDefsDimensionClipPaths=function(e,t){var i=this.getStockChartDimensions();e.openStart("defs").openEnd();for(var r=0;r<i.length;r++){e.openStart("clipPath",i[r].getId()+"-clipPath");e.openEnd();this.renderDimensionPath(e,i[r],t.y,t.height,null,i,true);e.close("clipPath")}e.close("defs")};o.prototype._createThresholdDefsPath=function(e,t){var i=e.getStockChartPeriods();var o=t.getStockChartPeriods();var a=[];var g={};for(var n=0;n<o.length;n++){var s=o[n];var h=s.getValue();if(h>t.getRelativePoint()&&e.getRelativePoint()>t.getRelativePoint()){this._createIntersectionThresholdPaths(o,i,s,t,a,n,true)}else if(h<t.getRelativePoint()&&e.getRelativePoint()<t.getRelativePoint()){this._createIntersectionThresholdPaths(o,i,s,t,a,n,false)}else if(h==t.getRelativePoint()){var l=s.getFrom();var m=s.getTo();if(o[n-1]&&o[n-1].getTo().getTime()==o[n].getFrom().getTime()){var T=this._getNearestThresholdPeriod(i,o[n].getFrom());if(T){var v=this._getCurrentThr(i,T);if(v&&v.getFrom().getTime()>l.getTime()&&T.getTo().getTime()!=v.getFrom().getTime()){var u=this._createSlantThresholdPath(T,v,o,n);g={from:s.getFrom(),to:s.getFrom(),value:u.y};a.push(new r(g))}}}if(e.getRelativePoint()>0&&o[n-1]&&o[n-1].getValue()>t.getRelativePoint()){this._createSlantPath(n,o,i,l,m,t,s,a,true)}else if(e.getRelativePoint()<0&&o[n-1]&&o[n-1].getValue()<t.getRelativePoint()){this._createSlantPath(n,o,i,l,m,t,s,a,true)}g={from:s.getFrom(),to:s.getTo(),value:s.getValue()};a.push(new r(g))}else{g={from:s.getFrom(),to:s.getTo(),value:t.getRelativePoint()};a.push(new r(g))}}return a};o.prototype._getNearestThresholdPeriod=function(e,t){var i=e.filter(function(e){return t.getTime()-e.getFrom().getTime()>0});return i[i.length-1]||null};o.prototype._getNextThresholdPeriod=function(e,t){var i=e.filter(function(e){return e.getFrom().getTime()-t.getTime()>0});return i[0]||null};o.prototype._getFilterThresholdPeriods=function(e,t,i){return e.filter(function(e,r){e._actualIndex=r;var o=t[i];var a=t[i+1];return e.getFrom().getTime()==o.getFrom().getTime()||a&&a.getFrom().getTime()!==o.getTo().getTime()&&e.getFrom().getTime()==o.getTo().getTime()||e.getFrom().getTime()>o.getFrom().getTime()&&e.getFrom().getTime()<o.getTo().getTime()})};o.prototype._getPeriodValue=function(e,t,i){var r;if(i){r=e.getValue()>t.getValue()?t.getValue():e.getValue()}else{r=e.getValue()<t.getValue()?t.getValue():e.getValue()}return r};o.prototype._createIntersectionThresholdPaths=function(e,t,i,o,a,g,n){var s=i.getFrom();var h=i.getTo();var l;var m={};if(s.getTime()!=h.getTime()){var T=this._getFilterThresholdPeriods(t,e,g);this._createSlantPath(g,e,t,s,h,o,i,a,false);if(T.length>0){for(var v=0;v<T.length;v++){if(v==0&&T[v].getFrom().getTime()>s.getTime()){l=this._getNearestThresholdPeriod(t,T[v].getFrom());var u=this._getCurrentThr(t,l);if(l.getTo().getTime()===u.getFrom().getTime()){if(l.getTo().getTime()===T[v].getFrom().getTime()){m={from:i.getFrom(),to:T[v].getFrom()};m.value=this._getPeriodValue(i,l,n)}else{var f=this._createSlantThresholdPath(l,T[v],e,g);if(l.getTo().getTime()>s.getTime()){m={from:this.getAxisTime().viewToTime(f.x),to:l.getTo(),value:l.getValue()}}else{m={from:i.getFrom(),to:i.getFrom(),value:l.getValue()<o.getRelativePoint()?-f.y:f.y}}}a.push(new r(m))}}if(T[v].getFrom().getTime()==s.getTime()){if(g!=0){if(T[v].getTo().getTime()>i.getTo().getTime()){m={from:i.getFrom(),to:i.getTo()};m.value=this._getPeriodValue(i,T[v],n)}else{m={from:i.getFrom(),to:T[v].getTo()};m.value=this._getPeriodValue(i,T[v],n)}}else{m={from:i.getFrom(),to:i.getTo()};m.value=this._getPeriodValue(i,T[v],n)}a.push(new r(m))}else if(T[v].getFrom().getTime()>s.getTime()){l=this._getNearestThresholdPeriod(t,T[v].getFrom());if(l.getTo().getTime()<s.getTime()){var f=this._createSlantThresholdPath(l,T[v],e,g);var p=this.getAxisTime().viewToTime(f.x);m={value:f.y};m.from=p;m.to=p;a.push(new r(m))}if(T[v].getTo().getTime()>i.getTo().getTime()){m={from:T[v].getFrom(),to:i.getTo()};if(i.getValue()>T[v].getValue()&&e[g+1]&&e[g+1].getValue()>T[v].getValue()){m.to=T[v].getTo()}if(e[g-1]&&s.getTime()!=e[g-1].getTo().getTime()&&l.getValue()<T[v].getValue()&&l.getTo().getTime()!=T[v].getFrom().getTime()){m.from=s}}else{m={from:T[v].getFrom(),to:T[v].getTo()}}m.value=this._getPeriodValue(i,T[v],n);a.push(new r(m))}}}else{if(!e[g-1]||s.getTime()==e[g-1].getTo().getTime()){l=this._getNearestThresholdPeriod(t,i.getFrom());var c=this._getNextThresholdPeriod(t,i.getFrom());if(l.getTo().getTime()<i.getFrom().getTime()&&c&&c.getFrom().getTime()>i.getTo().getTime()){var f=this._createSlantThresholdPath(l,c,e,g);var p=this.getAxisTime().viewToTime(f.x);m={value:f.y};m.from=i.getFrom();m.to=i.getFrom();a.push(new r(m));var f=this._createSlantThresholdPath(c,l,e,g);var p=this.getAxisTime().viewToTime(f.x);m={value:f.y};m.from=i.getTo();m.to=i.getTo();a.push(new r(m))}else{if(i.getFrom().getTime()>l.getFrom().getTime()){if(l.getTo().getTime()>i.getTo().getTime()){m={from:i.getFrom(),to:i.getTo()};m.value=this._getPeriodValue(i,l,n)}else if(l.getTo().getTime()>i.getFrom().getTime()){m={from:i.getFrom(),to:l.getTo()};m.value=this._getPeriodValue(i,l,n)}}a.push(new r(m))}}}}};o.prototype._createSlantThresholdPath=function(e,t,i,r){var o=e.getTo().getTime();var a=t.getFrom().getTime();var g=this.getAxisTime().timeToView(o);var n=this.getAxisTime().timeToView(a);var s=e.getValue();var h=t.getValue();var l=this.getAxisTime().timeToView(i[r].getTo().getTime());var m=i[r+1]?this.getAxisTime().timeToView(i[r+1].getFrom().getTime()):l;if(i[r].getFrom().getTime()>e.getTo().getTime()&&i[r].getFrom().getTime()<t.getFrom().getTime()){l=this.getAxisTime().timeToView(i[r].getFrom().getTime());m=i[r-1]?this.getAxisTime().timeToView(i[r-1].getTo().getTime()):l}var T={x:g,y:s};var v={x:n,y:h};var u={x:l,y:h};var f={x:m,y:s};return this._getIntersect(T,v,u,f)};o.prototype._getIntersect=function(e,t,i,r){var o=(e.x-t.x)*(i.y-r.y);var a=(e.y-t.y)*(i.x-r.x);var g=o-a;if(g==0){throw new Error("Number of intersection points is zero or infinity.")}var n=e.x*t.y-e.y*t.x;var s=i.x*r.y-i.y*r.x;var h=i.x-r.x;var l=e.x-t.x;var m=i.y-r.y;var T=e.y-t.y;var v=(n*h-l*s)/g;var u=(n*m-T*s)/g;var f={x:v,y:u};return f};o.prototype._getCurrentThr=function(e,t){var i,r=Number.MAX_SAFE_INTEGER/2;e.forEach(function(e){if(t.getFrom().getTime()!=e.getFrom().getTime()&&t.getTo().getTime()!=e.getTo().getTime()){var o=Math.abs(e.getFrom().getTime()-t.getTo().getTime());if(o<r){r=o;i=e}}});return i};o.prototype._createSlantPath=function(e,t,i,o,a,g,n,s,h){if(t[e-1]&&o.getTime()!=t[e-1].getTo().getTime()){var l=this._getNearestThresholdPeriod(i,o);var m=this._getCurrentThr(i,l);var T=t[e-1].getTo();var v=this.getAxisTime().timeToView(T);var u={x:v,y:t[e-1].getValue()};var f={x:this.getAxisTime().timeToView(t[e].getFrom().getTime()),y:t[e].getValue()};var p,c;if(l.getTo().getTime()>o.getTime()){p={x:this.getAxisTime().timeToView(t[e-1].getTo().getTime()),y:l.getValue()};c={x:this.getAxisTime().timeToView(l.getTo().getTime()),y:l.getValue()}}else{p={x:this.getAxisTime().timeToView(l.getTo().getTime()),y:l.getValue()};c={x:this.getAxisTime().timeToView(m.getFrom().getTime()),y:m.getValue()}}var d=this._getIntersect(u,f,p,c);var y=this.getAxisTime().viewToTime(d.x);var P={value:d.y};P.from=y;P.to=y;s.push(new r(P))}};o.prototype._renderMiddleLine=function(e,t){if(this.getShowMiddleLine()){var i=this._getMiddleLineY(t);e.openStart("path",this.getId()+"-middleLine");e.attr("d","M "+t.x+" "+i+" h "+t.width);e.class("sapGanttStockMiddleLine");e.openEnd().close("path")}};o.prototype._getMiddleLineY=function(e){var t=this._createTransform(this.getRelativeMiddleLinePoint());var i=e.height*(t/100);var r=e.y+e.height-i;return r};o.prototype._getClipPathIdOfDimension=function(e){return"url(#"+e.getId()+"-clipPath)"};o.prototype._renderDimensionPaths=function(e,t){var i=t.x,r=t.y,o=t.width,a=t.height;var g=[];var n=[];var s={};var h;var l=this.getStockChartDimensions();var m=l.filter(function(e){return e.getIsThreshold()!=true});var T=l.filter(function(e){return e.getIsThreshold()==true&&e.getRelativePoint()>m[0].getRelativePoint()}).sort(function(e,t){return t.getRelativePoint()-e.getRelativePoint()});var v=l.filter(function(e){return e.getIsThreshold()==true&&e.getRelativePoint()<m[0].getRelativePoint()}).sort(function(e,t){return e.getRelativePoint()-t.getRelativePoint()});if(m){e.openStart("g").openEnd();var u=m[0];g=[];n=[];for(var f=0;f<u.getStockChartPeriods().length;f++){var p=u.getStockChartPeriods()[f];if(p.getValue()<u.getRelativePoint()){g.push(p)}else{n.push(p)}}var c=a;if(g.length>0&&n.length>0){for(var d=0;d<2;d++){var y=this._createTransform(u.getRelativePoint());var P=a*(y/100);var V=c-P;if(d==1){if(v.length>0){h=v[0].getRemainCapacityColor()}else{h=u.getRemainCapacityColorNegative()}}else{if(T.length>0){h=T[0].getRemainCapacityColor()}else{h=u.getRemainCapacityColor()}}s={id:u.getId()+(d==1?"-scRectNegative":"-scRect"),x:i,y:d==1?r+V:r,width:o,height:d==1?a-V:a-(a-V),fill:h,"clip-path":this._getClipPathIdOfDimension(u)};this.renderRectangleWithAttributes(e,s)}}else if(n.length>0||g.length>0){var x=n.length>0?T:v;if(x.length>0){h=x[0].getRemainCapacityColor()}else{h=n.length>0?u.getRemainCapacityColor():u.getRemainCapacityColorNegative()}s={id:u.getId()+(n.length>0?"-scRect":"-scRectNegative"),x:i,y:r,width:o,height:a,fill:h,"clip-path":this._getClipPathIdOfDimension(u)};this.renderRectangleWithAttributes(e,s)}e.close("g")}if(T.length>0){for(var F=0;F<T.length;F++){e.openStart("g").openEnd();var _=T[F];s={id:_.getId()+"-scRect",x:i,y:r,width:o,height:a,fill:T[F+1]?T[F+1].getRemainCapacityColor():m[0].getRemainCapacityColor(),"clip-path":this._getClipPathIdOfDimension(_)};this.renderRectangleWithAttributes(e,s);e.close("g")}}if(v.length>0){for(var F=0;F<v.length;F++){e.openStart("g").openEnd();var C=v[F];s={id:C.getId()+"-scRect",x:i,y:r,width:o,height:a,fill:v[F+1]?v[F+1].getRemainCapacityColor():m[0].getRemainCapacityColor(),"clip-path":this._getClipPathIdOfDimension(C)};this.renderRectangleWithAttributes(e,s);e.close("g")}}if(m){e.openStart("g").openEnd();var u=m[0];this.renderDimensionPath(e,u,r,a,"scPath");e.close("g")}if(T.length>0){for(var F=0;F<T.length;F++){e.openStart("g").openEnd();var _=T[F];this.renderDimensionPath(e,_,r,a,"scPath");e.close("g")}}if(v.length>0){for(var F=0;F<v.length;F++){e.openStart("g").openEnd();var C=v[F];this.renderDimensionPath(e,C,r,a,"scPath");e.close("g")}}};o.prototype._renderTooltips=function(t,i){var r=i.y,o=i.height,a={};t.openStart("g");t.class("sc-tooltips").openEnd();var g=this.getAllDimensionPoints();g.forEach(function(i,g,n){var s=n[g+1]||i;var h=i.tooltip;var l=i.name!==s.name;if(l){h=i.tooltip+"\n"+s.tooltip}var m=this.toX(i.from),T=n.length-1===g,v=this.toX(T?s.to:s.from),u=Math.abs(v-m);if(u>0){var f={opacity:0,fillOpacity:0,strokeOpacity:0};var p=e({x:m,y:r,width:u,height:o},f);this.renderRectangleWithAttributes(t,p,h);a=p}}.bind(this));if(Object.keys(a).length!=0){a.x=i.x;a.width=0;a.class="stockChartTooltip";this.renderRectangleWithAttributes(t,a,"stockChartTooltip")}t.close("g")};o.prototype.getAllDimensionPoints=function(){var e=[];this.getStockChartDimensions().forEach(function(t){var i=t.getName();t.getStockChartPeriods().forEach(function(t,r,o){var a=t.getTooltip();if(!a){a=i+":"+t.getValue()}if(t.getFrom()!=t.getTo()){e.push({name:i,from:t.getFrom(),to:t.getFrom(),tooltip:a});e.push({name:i,from:t.getTo(),to:t.getTo(),tooltip:a})}else{e.push({name:i,from:t.getFrom(),to:t.getTo(),tooltip:a})}})});return e};o.prototype.renderDimensionPath=function(e,t,i,r,o,a,g){if(t.getIsThreshold()&&g){var n=a.filter(function(e){return e.getIsThreshold()!=true});var s=t.getStockChartPeriods().length>0?this._createThresholdDefsPath(t,n[0]):[]}var h=t.getIsThreshold()&&g?s:t.getStockChartPeriods();var l="";for(var m=0;m<h.length;m++){var T=m===0,v=m===h.length-1;var u=h[m];var f=this.toX(u.getFrom());var p=this.toX(u.getTo());var c=u.getValue();if(c>this.getMaxValue()){c=this.getMaxValue()}if(c<this.getMinValue()){c=this.getMinValue()}var d=i+r;var y=r*(this._createTransform(c)/100);var P=d-y;var V=this._createTransform(t.getIsThreshold()&&g?n[0].getRelativePoint():t.getRelativePoint());var x=r*(V/100);var F=d-x;if(g){l+=(T?" M "+f+" "+F:"")+" L "+f+" "+P+" L "+p+" "+P+(v?" L "+p+" "+F:"")}else{l+=(T?" M "+f+" "+P:"")+(T?"":" L "+f+" "+P)+" L "+p+" "+P}}if(o){e.openStart("path",t.getId()+"-"+o)}else{e.openStart("path")}e.attr("d",l);e.attr("fill","none");e.attr("stroke-width",t.getDimensionStrokeWidth());if(t.getDimensionStrokeDasharray()){e.attr("stroke-dasharray",t.getDimensionStrokeDasharray())}e.attr("stroke",t.getDimensionPathColor());e.class("sapGanttScDimensionPath");e.openEnd().close("path")};o.prototype._createTransform=function(e){var t={max:this.getMaxValue(),min:this.getMinValue()};var i={max:100,min:0};var r=(i.max-i.min)/(t.max-t.min);var o=(e-t.min)*r;return o};o.prototype.destroy=function(){t.prototype.destroy.apply(this,arguments)};return o},true);
//# sourceMappingURL=StockChart.js.map
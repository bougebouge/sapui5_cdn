/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","./GanttExtension","./CoordinateUtils","sap/gantt/misc/Utility"],function(jQuery,t,e,s,o){"use strict";var a=".sapGanttLasso";var n={addEventListeners:function(t){this.removeEventListeners(t);var e=t._getLassoExtension();e.lassoDoms().rowArea.on("mousedown"+a,e.beforeLasso.bind(e))},removeEventListeners:function(t){var e=t._getLassoExtension();e.lassoDoms().rowArea.off(a)},addLassoEventListeners:function(t){this.removeLassoEventListeners(t);var e=t._getLassoExtension();var s=jQuery(e.getDomRefs().gantt);s.on("mousemove"+a,e.onMousemove.bind(e));s.on("mouseup"+a,e.endLasso.bind(e));s.on("mouseleave"+a,e.endLasso.bind(e));s.on("keydown"+a,e.onKeydown.bind(e))},removeLassoEventListeners:function(t){var e=t._getLassoExtension();jQuery(e.getDomRefs().gantt).off(a)}};var i=e.extend("sap.gantt.simple.GanttLassoExtension",{_init:function(t,e){this._initLassoStates();return"LassoExtension"},_attachEvents:function(){var t=this.getGantt();n.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();n.removeEventListeners(t)}});i.prototype._initLassoStates=function(){this.mDom={};this._oLassoStartPoint={};this._bLassoDrawing=false};i.prototype.getSvgElement=function(){return this.getDomRefs().ganttSvg};i.prototype._getShapeConnectRootNode=function(){var t=this.lassoDoms().lasso;return d3.select(t.get(0))};i.prototype.rect=function(t,e,s,o){return"M"+[t,e]+" l"+[s,0]+" l"+[0,o]+" l"+[-s,0]+"z"};i.prototype._getLassoData=function(t){var e=this._oLassoStartPoint.x<t.x?this._oLassoStartPoint.x:t.x;var s=this._oLassoStartPoint.x>t.x?this._oLassoStartPoint.x:t.x;var o=this._oLassoStartPoint.y<t.y?this._oLassoStartPoint.y:t.y;var a=this._oLassoStartPoint.y>t.y?this._oLassoStartPoint.y:t.y;var n={class:"lassoRect",d:this.rect(e,o,s-e,a-o),fill:"#9bdaff",stroke:"#4da5ff","fill-opacity":.5,"stroke-width":2};return n};i.prototype.createLasso=function(t){var e=this._getLassoData(t);if(this.getD3Doms().lassoRect.empty()){var s=this._getShapeConnectRootNode();s.append("path").attr(e)}};i.prototype.isLassoDrawing=function(){return this._bLassoDrawing};i.prototype.beforeLasso=function(t){var e=this.getGantt();if(t.button!==0||e.getSelection().sSelectionMode!==sap.gantt.SelectionMode.MultiWithKeyboardAndLasso&&e.getSelection().sSelectionMode!==sap.gantt.SelectionMode.MultipleWithLasso){return}var o=this.getSvgElement();var a=s.getEventSVGPoint(o,t);this._oLassoStartPoint={x:a.x,y:a.y};if(e.getSelection().sSelectionMode===sap.gantt.SelectionMode.MultiWithKeyboardAndLasso&&!t.ctrlKey){e._bDeselectShapes=true;e.setSelectedShapeUid([])}else{e._bDeselectShapes=false}n.addLassoEventListeners(e)};i.prototype.onMousemove=function(t){if(!this.isLassoDrawing()){this._bLassoDrawing=true;var e=this.getSvgElement();var o=s.getEventSVGPoint(e,t);this.createLasso(o);this.mDom.lassoRect=this.lassoDoms().lassoRect}else{this.onLassoDrawing(t)}};i.prototype.onLassoDrawing=function(t){var e=this.getSvgElement();var o=s.getEventSVGPoint(e,t);var a=this._getLassoData(o);this.mDom.lassoRect.attr(a)};i.prototype.shapeInLasso=function(t,e,s,o,a,n,i,r){if(t>=a&&t<=n&&s>=i&&s<=r||e>=a&&e<=n&&s>=i&&s<=r||t>=a&&t<=n&&o>=i&&o<=r||e>=a&&e<=n&&o>=i&&o<=r||t<=a&&e>=n&&s>=i&&s<=r||t<=a&&e>=n&&o>=i&&o<=r||t>=a&&t<=n&&o>=r&&s<=i||e>=a&&e<=n&&o>=r&&s<=i){return true}return false};i.prototype.getShapeElementByTarget=function(t,e){return jQuery(e.getDraggableDOMElement(t)).control(0,true)};i.prototype.getDraggableDOMElement=function(t){return jQuery(t).closest("[data-sap-gantt-shape-id]").get(0)};i.prototype.endLasso=function(t){var e=this.getGantt();var a=e._getLassoExtension();if(this.isLassoDrawing()){var i=this._getShapeConnectRootNode();i.selectAll("*").remove()}n.removeLassoEventListeners(this.getGantt());var r=this.getSvgElement();var g=s.getEventSVGPoint(r,t);var h=e._getLassoExtension()._oLassoStartPoint;var p=h.x<g.x?h.x:g.x;var v=h.x>g.x?h.x:g.x;var f=h.y<g.y?h.y:g.y;var l=h.y>g.y?h.y:g.y;var c,d,S,u,L,y,E={x:0,y:0};var m=e.getEnableLassoInvert();var x=e.getSelectedShapeUid();var _=m?[]:x;var D=[];var b=jQuery(r);var w=jQuery(b.find(".sapGanttChartShapes")).find(".baseShapeSelection").toArray();var R=jQuery(b.find(".sapGanttChartRls")).find(".baseShapeSelection").toArray();var P=false;w.forEach(function(t,e){if(!t.classList.contains("sapGanttTextNoPointerEvents")){L=a.getShapeElementByTarget(t,a);if(L){P=L.getSelectable();E=o.getShapeBias(L);y=L.getShapeUid()?L.getShapeUid():L.getParentRowSettings().getShapeUid(L)}c=t.getBBox().x+E.x;d=c+t.getBBox().width;S=t.getBBox().y+E.y;u=S+t.getBBox().height;var s=a.shapeInLasso(c,d,S,u,p,v,f,l);var n=L?x.indexOf(y):0;var i=n===-1?false:true;if(s){if(L&&P&&!i&&_.indexOf(y)===-1){_.push(y)}else if(m&&L&&P&&i){D.push(y)}}else if(m&&L&&P&&i){_.push(y)}if(L){w[e]=y}}});R.forEach(function(t,e){L=a.getShapeElementByTarget(t,a);if(L){P=L.getSelectable();y=L.getShapeUid()?L.getShapeUid():L.getParentRowSettings().getShapeUid(L)}if(m&&L&&P&&x.indexOf(y)!==-1){_.push(y)}if(L){R[e]=y}});if(m){x.forEach(function(t){if(w.indexOf(t)===-1&&R.indexOf(t)===-1){_.push(t)}})}var G=[];_.forEach(function(t){if(G.indexOf(t)===-1&&D.indexOf(t)===-1){G.push(t)}});this._initLassoStates();if(e.getSelectedShapeUid().toString()===G.toString()){e._bSupressShapeChangeEvent=true}else{e._bSupressShapeChangeEvent=false}e.setSelectedShapeUid(G)};i.prototype.onKeydown=function(e){if(this.isLassoDrawing()&&e.keyCode===t.ESCAPE){this.endLasso(e)}};i.prototype.lassoDoms=function(){var t=jQuery(this.getSvgElement());var e=t.find("g.sapGanttChartLasso");var s=t.find("rect.sapGanttBackgroundSVGRow");return{lassoRect:e.find(".lassoRect"),rowArea:s,lasso:e}};i.prototype.getD3Doms=function(){var t=this._getShapeConnectRootNode();return{lassoRect:t.selectAll(".lassoRect")}};return i});
//# sourceMappingURL=GanttLassoExtension.js.map
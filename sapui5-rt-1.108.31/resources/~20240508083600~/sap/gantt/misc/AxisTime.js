/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/util/ObjectPath","sap/ui/core/Core","sap/gantt/misc/Utility","sap/gantt/misc/Format","sap/gantt/simple/GanttUtils"],function(e,t,i,a,o){"use strict";var s={};var n=function(e,t,o,s,n,r,f){this.scale=d3.time.scale().domain(e).range(t).clamp(false);this.timeRange=e;this.viewRange=t;this.zoomRate=i.assign(o,1);this.zoomOrigin=i.assign(s,0);this.viewOffset=i.assign(n,0);this.locale=r;if(r&&r.getUtcdiff()){var l=a.getTimeStampFormatter();this.timeZoneOffset=Math.round((l.parse("20000101"+r.getUtcdiff()).getTime()-l.parse("20000101000000").getTime())/1e3);if(r.getUtcsign()==="-"){this.timeZoneOffset=-this.timeZoneOffset}}this._oZoomStrategy=f};n.prototype.CONSTANT={C_SEPARATOR:"_@@_",C_MESSAGE:{ARGUMENT_ERROR:"AxisOrdinal: Argument Error!"}};n.prototype.timeToView=function(e,i){if(t.getConfiguration().getRTL()!==true){return(this.scale(e)-this.zoomOrigin)*this.zoomRate-(i?0:this.viewOffset)}else{return this.viewRange[1]*this.zoomRate-((this.scale(e)+this.zoomOrigin)*this.zoomRate+(i?0:this.viewOffset))}};n.prototype.viewToTime=function(e,i){if(t.getConfiguration().getRTL()!==true){return this.scale.invert((e+(i?0:this.viewOffset))/this.zoomRate+this.zoomOrigin)}else{return this.scale.invert(this.viewRange[1]-(e+(i?0:this.viewOffset))/this.zoomRate-this.zoomOrigin)}};n.prototype.setTimeRange=function(e){this.timeRange=e;this.scale.domain(e);return this};n.prototype.getTimeRange=function(){return this.scale.domain()};n.prototype.getTimeRangeSlice=function(e,i){var a=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(e),this.timeZoneOffset):this.viewToTime(e);var o=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(i),this.timeZoneOffset):this.viewToTime(i);if(t.getConfiguration().getRTL()!==true){return[a,o]}else{return[o,a]}};n.prototype.setViewRange=function(e){this.viewRange=e;this.scale.range(e);return this};n.prototype.getViewRange=function(){var e=this.scale.range();return[Math.round((e[0]-this.zoomOrigin)*this.zoomRate-this.viewOffset),Math.round((e[1]-this.zoomOrigin)*this.zoomRate-this.viewOffset)]};n.prototype.getZoomStrategy=function(){return this._oZoomStrategy};n.prototype.setZoomRate=function(e){this.zoomRate=i.assign(e,1);return this};n.prototype.getZoomRate=function(){return this.zoomRate};n.prototype.setZoomOrigin=function(e){this.zoomOrigin=i.assign(e,0);return this};n.prototype.getZoomOrigin=function(){return this.zoomOrigin};n.prototype.setViewOffset=function(e){this.viewOffset=i.assign(e,0);return this};n.prototype.getViewOffset=function(){return this.viewOffset};n.prototype.setLocale=function(e){this.locale=e;if(e&&e.getUtcdiff()){var t=a.getTimeStampFormatter();this.timeZoneOffset=Math.round((t.parse("20000101"+e.getUtcdiff()).getTime()-t.parse("20000101000000").getTime())/1e3);if(e.getUtcsign()==="-"){this.timeZoneOffset=-this.timeZoneOffset}}return this};n.prototype.getLocale=function(){return this.locale};n.prototype.clone=function(){return new n([new Date(this.timeRange[0].valueOf()),new Date(this.timeRange[1].valueOf())],this.viewRange.slice(0),this.zoomRate,this.zoomOrigin,this.viewOffset,this.locale,this._oZoomStrategy)};n.prototype._get2dContext=function(e,t){if(!s.context){s.context=document.createElement("canvas").getContext("2d")}if(s.fontSize!==e||s.fontFamily!==t){s.context.font=e+"px "+t;s.fontSize=e;s.fontFamily=t}return s.context};n.prototype._getShapeTextWidth=function(e,t,i){return this._get2dContext(t,i).measureText(e).width};n.prototype.getCurrentTickTimeIntervalLevel=function(){var e=this._oZoomStrategy.getTimeLineOption(),t=this._oZoomStrategy.getTimeLineOptions(),i=0;for(var a in t){if(t[a]===e){return i}i++}};n.prototype.getCurrentTickTimeIntervalKey=function(){var e=this._oZoomStrategy.getTimeLineOption(),t=this._oZoomStrategy.getTimeLineOptions();for(var i in t){if(t[i]===e){return i}}};n.prototype.getNowLabel=function(e){var t=new Date;if(e===undefined||e){t=new Date(t.getTime()+t.getTimezoneOffset()*6e4)}var i=this.timeToView(t);var a=d3.time.second.offset(t,this.timeZoneOffset);return[{date:a,value:Math.round(i)}]};n.prototype.getFirstSmallIntervalIndex=function(e,t){for(var i=0;i<e.length;i++){var o=a.dateToAbapTimestamp(e[i].date);if(o>=t){return i}}};n.prototype.getTickTimeIntervalLabel=function(o,s,r){var f,l,g,h=null;if(this.locale&&this.locale.getDstHorizons().length>0){h=this.locale.getDstHorizons()}var m=a.getTimeStampFormatter();var u=[];if(h){for(f=0;f<h.length;f++){u[f]={};l=h[f].getStartTime();g=h[f].getEndTime();u[f].startDate=m.parse(l);u[f].endDate=m.parse(g)}}var v=this.timeZoneOffset?[d3.time.second.offset(this.timeRange[0],this.timeZoneOffset),d3.time.second.offset(this.timeRange[1],this.timeZoneOffset)]:this.timeRange;var c=new n(v,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy);var T=null;var d=null;var p=null;var w=null;var O=null;var S=null;var y=null;var R=[];var Z=[];var _=null;if(s){S=this.timeZoneOffset?d3.time.second.offset(s[0],this.timeZoneOffset):s[0];y=this.timeZoneOffset?d3.time.second.offset(s[1],this.timeZoneOffset):s[1];T=this.timeZoneOffset?[d3.time.second.offset(s[0],this.timeZoneOffset),d3.time.second.offset(s[1],this.timeZoneOffset)]:s;d=[this.timeToView(s[0]),this.timeToView(s[1])];if(u&&u.length){this._calculateTimeRange(u,S,y,R)}_=this._calculateScale(R,Z,T,d,false)}else if(r){S=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(r[0]),this.timeZoneOffset):this.viewToTime(r[0]);y=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(r[1]),this.timeZoneOffset):this.viewToTime(r[1]);T=[S,y];d=r;if(u.length){this._calculateTimeRange(u,S,y,R)}_=this._calculateScale(R,Z,T,d,false)}else{S=v[0];y=v[1];T=v;d=this.viewRange;if(u.length){this._calculateTimeRange(u,S,y,R)}_=this._calculateScale(R,Z,T,d,v)}Z=_.viewRangeSet;p=_.visibleScale;w=_.dstScale;O=_.normalScale;var L=[];var z,D,k,b;var C={unit:this._oZoomStrategy.getTimeLineOption().largeInterval.unit,span:this._oZoomStrategy.getTimeLineOption().largeInterval.span};var I={unit:this._oZoomStrategy.getTimeLineOption().smallInterval.unit,span:this._oZoomStrategy.getTimeLineOption().smallInterval.span};var F,x;var P=this._oZoomStrategy.getUpperRowFormatter(),V=this._oZoomStrategy.getLowerRowFormatter();if(C){var M=[];var U=[];var A=[];if(!(p instanceof Array)){M[0]=this._getTimeIntervalTicks(C,p)}else{for(F=0;F<w.length;F++){U[F]=w[F].ticks(e.get(C.unit).range,C.span);A[F]=O[F].ticks(e.get(C.unit).range,C.span)}for(F=0;F<p.length;F++){M[F]=p[F].ticks(e.get(C.unit).range,C.span)}}var E=[];if(M[0]!==null){for(F=0;F<M.length;F++){for(x=0;x<M[F].length;x++){z=M[F][x];k=c.timeToView(z);b=i.getLowerCaseLabel(i.getFormattedDate(P,z));E.push({date:z,value:Math.round(k),label:b})}}}if(U[0]!==null){for(F=0;F<U.length;F++){for(x=0;x<U[F].length;x++){z=U[F][x];D=A[F][x];k=c.timeToView(d3.time.second.offset(z.getTime(),-60*60));b=i.getLowerCaseLabel(i.getFormattedDate(P,z));E.push({date:z,value:Math.round(k),label:b})}}}L.push(E)}else{L.push([])}if(I){var H=[];var G=[];var N=[];if(!(p instanceof Array)){N[0]=this._getTimeIntervalTicks(I,p)}else{for(F=0;F<w.length;F++){H[F]=w[F].ticks(e.get(I.unit).range,I.span);G[F]=O[F].ticks(e.get(I.unit).range,I.span)}for(F=0;F<p.length;F++){N[F]=p[F].ticks(e.get(I.unit).range,I.span)}}var W=[];if(N[0]){for(F=0;F<N.length;F++){for(x=0;x<N[F].length;x++){z=N[F][x];var q;var j=false;if(u.length){for(var K=0;K<u.length;K++){if(z.getTime()===u[K].startDate.getTime()){q=d3.time.second.offset(z.getTime(),60*60);if(x===N[F].length-1&&this._oZoomStrategy.isLowerRowTickHourSensitive()){j=true}}if(x===N[F].length-1&&z.getTime()===d3.time.second.offset(u[K].endDate.getTime(),60*60).getTime()){q=d3.time.second.offset(z.getTime(),-60*60)}}}k=c.timeToView(z);var B;if(j){break}else if(q){B=i.getLowerCaseLabel(i.getFormattedDate(P,q));b=i.getLowerCaseLabel(i.getFormattedDate(V,q));q=null}else{B=i.getLowerCaseLabel(i.getFormattedDate(P,z));b=i.getLowerCaseLabel(i.getFormattedDate(V,z))}W.push({date:z,value:Math.round(k),label:b,largeLabel:B})}}}if(H[0]){for(F=0;F<H.length;F++){for(x=0;x<H[F].length;x++){z=H[F][x];D=G[F][x];var J;var Q=false;if(x===H[F].length-1&&this._oZoomStrategy.isLowerRowTickHourSensitive()){if(R.length>0){for(var X=0;X<R.length;X++){if(!R[X].haveDST&&D.getTime()===R[X].range[0].getTime()){Q=true}}}}if(u.length){for(var Y=0;Y<u.length;Y++){if(z.getTime()===u[Y].startDate.getTime()){J=d3.time.second.offset(z.getTime(),60*60)}if(x===H[F].length-1&&z.getTime()===d3.time.second.offset(u[Y].endDate.getTime(),60*60).getTime()){J=d3.time.second.offset(z.getTime(),-60*60)}}}if(!this._oZoomStrategy.isLowerRowTickHourSensitive()){k=c.timeToView(d3.time.second.offset(z.getTime(),-60*60))}else{k=c.timeToView(D)}if(Q){break}else if(J){b=i.getLowerCaseLabel(i.getFormattedDate(V,J));J=null}else{b=i.getLowerCaseLabel(i.getFormattedDate(V,z))}W.push({date:z,value:Math.round(k),label:b})}}}L.push(W)}else{L.push([])}var $=L[0];var ee=L[1];var te=this.getZoomStrategy().getVisibleHorizon().getStartTime();this.largeIntervalLabel=true;this.largeIntervalPath=false;var ie=this.getFirstSmallIntervalIndex(ee,te);var ae,oe,se=30;var ne,re,fe=0;var le=t.getConfiguration().getRTL();if(ee[ie]){var ge=ee[ie].largeLabel;this.firstTickPosition=ee[ie].value;var he=false;var me=document.querySelector(".sapGanttTimeHeaderSvgText")||document.querySelector(".sapGanttTimeHeaderSvgText0");if(me){var ue=getComputedStyle(me);ne=ue.fontSize;re=ue.fontFamily;fe=Math.ceil(this._getShapeTextWidth(ge,ne,re))+se}ae=le?this.firstTickPosition-fe:this.firstTickPosition+fe;for(f=0;f<$.length;f++){fe=me?Math.ceil(this._getShapeTextWidth($[f].label,ne,re))+se:0;oe=le?$[f].value-fe:$[f].value+fe;var ve=le?$[f].value<this.firstTickPosition&&$[f].value>=ae:$[f].value>this.firstTickPosition&&$[f].value<=ae;var ce=le?this.firstTickPosition<$[f].value&&this.firstTickPosition>=oe:this.firstTickPosition>$[f].value&&this.firstTickPosition<=oe;var Te=$[f].label!==ge;if(ve||ce&&Te){this.largeIntervalLabel=false;break}}if(this.largeIntervalLabel){for(f=0;f<$.length;f++){if($[f].label===ge){if($[f].value===this.firstTickPosition){this.largeIntervalPath=true}$[f].value=this.firstTickPosition;he=true;break}}if(!he){var de={value:this.firstTickPosition,label:ge};L[0].push(de)}}}return L};n.prototype._getTimeIntervalTicks=function(t,i){if(t.unit!==sap.gantt.config.TimeUnit.week){return i.ticks(e.get(t.unit).range,t.span)}var a=["d3.time.sunday","d3.time.monday","d3.time.tuesday","d3.time.wednesday","d3.time.thursday","d3.time.friday","d3.time.saturday"];return i.ticks(e.get(a[this.getZoomStrategy().getFirstDayOfWeek()]).range,t.span)};n.prototype._calculateScale=function(e,t,i,a,o){var s=null;var r=[];var f=[];if(e.length){s=[];var l=0;var g=0;for(var h=0;h<e.length;h++){t[h]=[this.timeToView(e[h].range[0]),this.timeToView(e[h].range[1])];if(e[h].haveDST){r[l]=new n(e[h].dstRange,t[h],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;f[l]=new n(e[h].range,t[h],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;l++}else{s[g]=new n(e[h].range,t[h],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;g++}}}else if(o){s=new n(o,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null).scale}else{s=new n(i,a,this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale}var m={viewRangeSet:t,visibleScale:s,dstScale:r,normalScale:f};return m};n.prototype._calculateTimeRange=function(e,t,i,a){if(e.length){var o=t;var s=i;var n=[];var r=[];var f,l;f=e[0].startDate;l=e[0].endDate;this._calculateRangeItem(f,l,o,s,n,r);if(e.length>1){for(var g=1;g<e.length;g++){if(n.length){var h=[];for(var m in n){h.push(n[m])}n=[];for(var u=0;u<h.length;u++){f=e[g].startDate;l=e[g].endDate;o=h[u].range[0];s=h[u].range[1];this._calculateRangeItem(f,l,o,s,n,r)}}}}for(var v in r){a.push(r[v])}for(var c in n){a.push(n[c])}}};n.prototype._calculateRangeItem=function(e,t,i,a,o,s){var n=null;if(i<e){if(a<t){if(a>e){n={};n.haveDST=false;n.range=[i,e];o.push(n);n={};n.haveDST=true;n.range=[e,a];n.dstRange=[d3.time.second.offset(e.getTime(),60*60),d3.time.second.offset(a,60*60)];s.push(n)}else{n={};n.haveDST=false;n.range=[i,a];o.push(n)}}else{n={};n.haveDST=false;n.range=[i,e];o.push(n);n={};n.haveDST=true;n.range=[e,t];n.dstRange=[d3.time.second.offset(e.getTime(),60*60),d3.time.second.offset(t.getTime(),60*60)];s.push(n);n={};n.haveDST=false;n.range=[t,a];o.push(n)}}else if(i>=e){if(i<t){if(a<=t){n={};n.haveDST=true;n.range=[i,a];n.dstRange=[d3.time.second.offset(i,60*60),d3.time.second.offset(a,60*60)];s.push(n)}else{n={};n.haveDST=true;n.range=[i,t];n.dstRange=[d3.time.second.offset(i,60*60),d3.time.second.offset(t.getTime(),60*60)];s.push(n);n={};n.haveDST=false;n.range=[t,a];o.push(n)}}else{n={};n.haveDST=false;n.range=[i,a];o.push(n)}}};return n},true);
//# sourceMappingURL=AxisTime.js.map
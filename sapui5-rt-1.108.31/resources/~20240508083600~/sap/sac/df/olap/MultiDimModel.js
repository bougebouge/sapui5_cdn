/*
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/olap/MultiDimModel",["sap/base/Log","sap/ui/model/Model","sap/ui/model/Context","sap/sac/df/types/ValueType","sap/sac/df/olap/SystemLandscape","sap/sac/df/utils/SyncActionHelper","sap/sac/df/utils/ResultSetHelper","sap/sac/df/utils/ListHelper","sap/sac/df/DFKernel","sap/sac/df/olap/OlapListBinding","sap/sac/df/olap/OlapListGridBinding","sap/sac/df/olap/OlapPropertyBinding","sap/sac/df/olap/MultiDimDataProvider","sap/sac/df/utils/ResourceBundle","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library"],function(e,a,t,r,n,i,o,s,c,u,l,d,f,p,v,g){"use strict";var m=new RegExp("/","g");var y=c.extend("sap.sac.df.olap.MultiDimModel",{constructor:function(a){var r=this;var o=a||{};o.systemLandscape=o.systemLandscape||n;o.systemType=o.systemType||"BW";o.masterSystem=o.masterSystem||"local"+o.systemType;c.apply(r,[o]);var s=null;var y={};var h={};var S=r.init(o).then(function(){var e=r.getSession();e.setXVersion(g.XVersion.V190_METADATA_CUBE_RESPONSE_SUPPRESS_PROPERTIES);e.deactivateFeatureToggle(g.FeatureToggleOlap.FUSION_SERVICE);g.XStream.of(g.FeatureToggleOlap.getAllFeatureToggles()).forEach(function(a){var t=a.getXVersion();if(t>g.FeatureToggleOlap.FUSION_SERVICE.getXVersion()&&t<=g.XVersion.MAX){e.activateFeatureToggle(a)}});e.activateFeatureToggle(g.FeatureToggleOlap.METADATA_CACHING);g.UiLocalizationCenter.setExternalLocalizationProvider(p);g.UiLocalizationCenter.getCenter().setProductive(true)}).then(function(){s={ColLimit:50,RowLimit:150,DataProvider:{},VariableGroups:{},SemanticStyles:{},Messages:[]};r.checkUpdate()});r.setDataAccessLanguage=function(e){var a=r.getApplication().getSystemLandscape();var t=a.getSystemNames();for(var n=0;n<t.size();n++){a.getSystemDescription(t.get(n)).setLanguage(e)}};r.getLimit=function(){return{RowLimit:s.RowLimit,ColLimit:s.ColLimit}};r.addVariableGroup=function(e,a){s.VariableGroups[e]={Name:e,Rule:a,MergedVariable:null};b(e)};r.addQuery=function(e,a,t,n,o,c){var u=t||this.masterSystemName;return V(u).then(function(){var a=s.DataProvider[e];if(!a)return;return a.logoff()}).then(function(){var e=g.QueryServiceConfig.createWithDataSourceName(r.getApplication(),null,a);e.setMode(g.QueryManagerMode.DEFAULT);e.setProviderType(g.ProviderType.ANALYTICS);e.setSupportsDimensionLazyLoad(true);var t=["$[][][MY_DATA_AREA]/",c||"query",":","[",o?o:"","]","[",o||n?n:"","]","[",a,"]"].join("");e.setDataSourceByName(t);e.setSystemName(u);return i.syncActionToPromise(e.processQueryManagerCreation,e,[])}).then(function(a){s.DataProvider[e]=new f(r,r.getApplication(),a,e);b();r.fireEvent("queryAdded",{dataProviderName:e});return s.DataProvider[e]})};r.setVariableGroupValue=function(e,a){var t=s.VariableGroups[e];var n=t.MergedVariable.DataProviderName;return s.DataProvider[n].setVariableValue(t.MergedVariable.Name,a).then(function(){b(e);return r.checkUpdate()})};r.deserialize=function(e){s.DataProvider=s.DataProvider||{};s.SemanticStyles=e.SemanticStyles||[];return S.then(function(){var a=[];v.forEach(e.DataProvider,function(e,t){var n=s.DataProvider[t];if(!n){var o=g.QueryServiceConfig.createByDefinition(r.getApplication(),null,g.XContent.createStringContent(g.QModelFormat.INA_REPOSITORY,e));a.push(i.syncActionToPromise(o.processQueryManagerCreation,o,[]).then(function(e){s.DataProvider[t]=new f(r,r.getApplication(),e,t)}))}else{a.push(n.deserialize(e))}});return Promise.all(a)}).then(function(){b();return r.checkUpdate()})};r.serialize=function(){return{DataProvider:v.reduce(s.DataProvider,function(e,a){e[a.Name]=a.serialize();return e},{}),SemanticStyles:r.getSemanticStyles()}};r.openVariableSelector=function(e){return Promise.resolve(null).then(function(){var a=s.VariableGroups[e];if(!a){throw new Error("Invalid VariableGroup: "+e)}if(!a.MergedVariable){return false}var t=s.DataProvider[a.MergedVariable.DataProviderName];return t.openVariableSelector(a.MergedVariable.Name).then(function(a){if(!a){return false}b(e);r.checkUpdate();return true})})};r.searchVariableValues=function(e,a,t){return Promise.resolve(null).then(function(){var r=s.VariableGroups[e];if(!r){throw new Error("Invalid VariableGroup: "+e)}if(!r.MergedVariable){return false}var n=s.DataProvider[r.MergedVariable.DataProviderName];return n.searchVariableValues(r.MergedVariable.Name,a,t)})};r.logoff=function(){return Promise.all(v.invokeMap(s.DataProvider,"logoff"))};r.synchronize=function(e){var a=e?v.filter(s.DataProvider,function(a){return e.includes(a.Name)}):s.DataProvider;var t=v.invokeMap(a,"getResultSet");return Promise.all(t).then(function(){return r.checkUpdate()})};r.resetModel=function(){var e=[];v.forEach(s.DataProvider,function(a){e.push(a.resetToDefault())});return Promise.all(e).then(function(){b()})};r.getDataProvider=function(e){return s.DataProvider[e]};r.clearMessages=function(e){s.Messages=[];return e?r.checkUpdate():r};r.propagateVariableGroupValues=function(e){var a=[];var t=s.DataProvider[e];v.forEach(s.VariableGroups,function(r){var n=h[r.Name];v.forEach(n,function(n){if(n.DataProviderName===e&&!v.isEqual(r.MergedVariable.MemberFilter,n.MemberFilter)){a.push(t.setVariableValue(n.Name,r.MergedVariable.MemberFilter))}})});return Promise.all(a)};r.getProperty=function(e,a){return P(e,a)};r.setProperty=function(a,t){var n=false;var i=v.filter(a.split("/"),v.identity);try{var o=i.pop();var c=i.join(".");var u=v.get(s,c);if(o!=="vizProperties"||t){if(u){u[o]=t}else{e.warning("Failed to set "+t+" on: "+a)}}r.checkUpdate();n=true}catch(a){e.error(a)}return n};r.setSemanticStyles=function(e){s.SemanticStyles=v.clone(e)};r.getSemanticStyles=function(){return s.SemanticStyles};r.addMessages=function(e){s.Messages=v.map(v.groupBy(v.concat(s.Messages,e),"Text"),function(e){return e[0]});return r.checkUpdate()};r.bindProperty=function(e,a,t){var n=new d(r,e,a,t);y[n.getId()]=n;return n};r.bindList=function(e,a,t,n,i){if(e.match(/^(\/)?dataProvider\/(.)*\/Grid\/renderGrid/)){return new l(r,e,a,t,n,i)}else{return new u(r,e,a,t,n,i)}};function P(e,a){var r=a instanceof t?P(a.getPath()):s;if(e){var n=e.replace(m,".");if(n.startsWith(".")){n=n.replace(".","")}return v.get(r,n)}else{return r}}r.isList=function(e,a){return Array.isArray(P(r.resolve(e,a)))};r.checkUpdate=function(e){v.forEach(y,function(a,t){if(a){a.checkUpdate(e)}else{delete y[t]}},false);return r};r.checkMessages=function(){v.forEach(y,function(e){return e.checkDataState?e.checkDataState():null})};r.addBinding=function(e){y[e.getId()]=e;return r};r.removeBinding=function(e){delete y[e.getId()]};var D;function V(e,a){return S.then(function(){if(D){return D}if(e){return null}var t=g.QDataSource.create();t.setDataArea(a||"MY_DATA_AREA");var n=g.OlapApiModule.SERVICE_TYPE_PLANNING.createServiceConfig(r.getApplication());n.setDataSource(t);n.setSystemName(e||o.masterSystem);return i.syncActionToPromise(n.processServiceCreation,n,[]).then(function(e){D=e.getData();return D})})}r.getPlanningService=function(){return D};var M=S.then(function(){if(o&&o.SemanticStyles){r.setSemanticStyles(o.SemanticStyles)}var e=[];v.forEach(o.DataProvider||[],function(a,t){var n=r.addQuery(t,a.dataSourceName,a.systemName,a.packageName,a.schemaName,a.dataSourceType);e.push(a.synchronize?n.then(function(){return r.getDataProvider(t).synchronize()}):n)});return Promise.all(e)});r.dataLoaded=v.constant(M);r.loaded=r.dataLoaded;r.metadataLoaded=r.dataLoaded;r.annotationsLoaded=r.dataLoaded;r.getMetaModel=v.constant(r);r.attachMetadataFailed=v.constant(null);r.fireMetadataFailed=v.constant(null);r.getODataEntityContainer=v.constant(null);r.getODataEntityType=v.constant(r);r.createBindingContext=v.constant(null);r.getODataEntitySet=v.constant(r);r.attachRequestCompleted(function(e){var a=e.mParameters?e.mParameters.infoObject:undefined;var t=s.DataProvider[a];if(!t){return}else{t.callUpdateDimensionData();r.checkUpdate()}});function b(e){if(!e){v.forEach(s.VariableGroups,function(e){b(e.Name)})}else{h[e]=[];v.forEach(s.DataProvider,function(t){v.forEach(t.Variables,function(r){var n=s.VariableGroups[e];if(n){a(n,r,t.Name)}else{console.error("Group "+e+" not found")}})})}function a(e,a,t){if(e.Rule(a,t)){if(e.MergedVariable&&e.MergedVariable.DataProviderName!==t){if(e.MergedVariable.type!==a.type){throw new Error("Could not add variable '"+a.Name+"' for DataProvider='"+t+"'."+" The type="+a.type+" doesn't match type="+e.MergedVariable.type+" of previously added variables ")}}else{e.MergedVariable=a}h[e.Name].push(a)}}}}});return y});
//# sourceMappingURL=MultiDimModel.js.map
/*!
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/olap/DataProvider",["sap/base/Log","sap/sac/grid/Format","sap/sac/df/types/Axis","sap/sac/grid/CellType","sap/sac/df/types/DimensionType","sap/sac/df/types/DisplayType","sap/sac/df/types/ComparisonOperator","sap/sac/df/utils/Utilities","sap/sac/df/utils/SyncActionHelper","sap/sac/df/utils/ListHelper","sap/sac/df/utils/TokenHelper","sap/sac/df/utils/ResultSetHelper","sap/sac/df/utils/ResourceBundle","sap/sac/df/thirdparty/lodash"],function(e,t,r,n,i,a,o,s,l,u,g,c,m,f){"use strict";var y=function(e,o,s,g,y){var p=this;var d=null;var D;var v=true;function M(e){switch(e){case sap.firefly.ComparisonOperator.EQUAL:return"EQ";case sap.firefly.ComparisonOperator.LESS_THAN:return"LT";case sap.firefly.ComparisonOperator.LESS_EQUAL:return"LE";case sap.firefly.ComparisonOperator.GREATER_THAN:return"GT";case sap.firefly.ComparisonOperator.GREATER_EQUAL:return"GE";case sap.firefly.ComparisonOperator.BETWEEN:return"BT";case sap.firefly.ComparisonOperator.NOT_EQUAL:return"NE";default:throw new Error("Invalid Operator: "+e.getName())}}var N={};p.OffsetCol=0;p.Messages=[];p.Name=y;p.OffsetRow=0;p.SuppressRepetition=true;p.Chart={chartType:"column",vizProperties:{categoryAxis:{axisLine:{size:1,visible:true},title:{visible:true},axisTick:{visible:true},label:{alignment:"center",visible:true}},categoryAxis2:{axisLine:{size:1,visible:true},title:{visible:true},axisTick:{visible:true},label:{alignment:"center",visible:true}},valueAxis2:{size:1,visible:true},legend:{visible:true},title:{visible:true},axisTick:{visible:true},label:{alignment:"center",visible:true},valueAxis:{axisLine:{size:1,visible:true},title:{visible:true},axisTick:{visible:true},label:{alignment:"Right",visible:true}}}};var S=t.ExcelStyle;if(g.getCapabilitiesBase().supportsCellDocumentId()){g.getQueryModel().getDocumentsIdsRequest().setDocumentsIdsScope(sap.firefly.DocumentsIdsScope.RESULT_SET_BOUND)}p.setFormat=function(t){S=t;if(p.Grid){p.Grid.format=S}e.checkUpdate()};p.setOffsetCol=function(e){p.virtualOffsetCol=e;return p};p.setOffsetRow=function(e){p.virtualOffsetRow=e;return p};var C;p.getStructureMembers=function(e){var t=g.getQueryModel().getDimensionByName(p.Dimensions[e].TechName);var r=t.getDisplayKeyField();var n=f.reduce(p.getFilterOfDim(e),function(e,t){e[t.Low]=true;return e},{});return f.map(u.arrayFromList(t.getAllStructureMembers()),function(e){return{Name:e.getFieldValue(r)?e.getFieldValue(r).getValue().getString():e.getName(),TechName:e.getName(),Description:e.getText(),isInFilter:!!n[e.getName()]}})};function T(t){C=g.getQueryModel().getCurrencyTranslationManager()&&g.getQueryModel().getCurrencyTranslationManager().getCurrencyTranslationDetails();p.AllowsNewLines=false;p.Functions=[];p.HasVariables=false;p.CurrencyTranslation=C&&{Name:C.getCurrencyTranslationName(),Target:C.getCurrencyTranslationTarget()};if(p.Grid){p.Grid.inputEnabled=f.some(p.Grid.Cells,function(e){return e.Input});p.Grid.input=p.Grid.inputEnabled&&v;p.Grid.DataChanged=e.getPlanningService()?e.getPlanningService().getPlanningContext().hasChangedData():false;if(sap.ushell&&sap.ushell.Container&&e.getPlanningService()){sap.ushell.Container.setDirtyFlag(e.getPlanningService().getPlanningContext().hasChangedData())}}o(s.getUndoManager().getAvailableUndoStepCount()>0);p.QueryTitle=g.getQueryModel().getText()||g.getQueryModel().getDataSource().getName();p.QueryName=g.getQueryModel().getDataSource().getName();p.QueryType=g.getQueryModel().getDataSource().getType().getName();p.SystemName=g.getSystemDescription().getName();p.HasVariables=g.getQueryModel().getVariableContainer().hasVariables();N=f.reduce(u.arrayFromIter(g.getQueryModel().getVariables().getIterator()),function(e,t){e[t.getNameExternal()||t.getName()]=t.getName();return e},N);if(g.getQueryModel().getCubeInfo()){p.CreatedBy=g.getQueryModel().getCubeInfo().getCreatedBy();p.CreatedOn=function(){var e=g.getQueryModel().getCubeInfo().getCreatedOn();return e?new Date([e.getYear(),e.getMonthOfYear(),e.getDayOfMonth()].join("-")):new Date}();p.CreatedOnText=p.QueryDueDateText=sap.ui.core.format.DateFormat.getDateInstance({style:"medium"}).format(p.CreatedOn);p.QueryDueDate=function(){var e=g.getQueryModel().getCubeInfo().getDueDate();return e?new Date([e.getYear(),e.getMonthOfYear(),e.getDayOfMonth()].join("-")):new Date}();p.QueryDueDateText=sap.ui.core.format.DateFormat.getDateInstance({style:"medium"}).format(p.QueryDueDate);if(g.getQueryModel().getResultAlignment()){p.ResultAlignmentRows=g.getQueryModel().getResultAlignment().getName();p.ResultAlignmentColumns=g.getQueryModel().getResultAlignment().getName()}p.LastUpdated=function(){var e=g.getQueryModel().getCubeInfo().getUpdatedOn();return e?new Date([e.getYear(),e.getMonthOfYear(),e.getDayOfMonth()].join("-")):new Date}();p.LastUpdatedBy=g.getQueryModel().getCubeInfo().getUpdatedBy();p.LastUpdatedText=sap.ui.core.format.DateFormat.getDateInstance({style:"medium"}).format(p.LastUpdated)}p.HasCurrencyTranslation=function(){var e=g.getQueryModel().getModelCapabilities();return(e.supportsCurrencyTranslation()||e.supportsQueryCurrencyTranslation())&&C&&g.getQueryModel().getCurrencyTranslationEnabledType()!=="NoCurrency"}();d=g.getQueryModel();var n=d.getSortingManager();function a(e){if(n.supportsDimensionSorting(e,null)){return e.getResultSetSorting().getDirection().getName()}else{return null}}p.Dimensions=f.reduce(u.arrayFromList(d.getDimensions()),function(e,t){var r=t.getAxis();if(t.getDimensionType().getName()===i.MeasureStructure){t.getExternalName=f.constant("MeasureStructure")}else if(t.getDimensionType().getName()===i.SecondaryStructure){t.getExternalName=f.constant("NonMeasureStructure")}e[t.getExternalName()||t.getName()]={Name:t.getExternalName()||t.getName(),TechName:t.getName(),Description:t.getText(),Axis:r.getName(),Type:t.getDimensionType().getName(),HierarchyActive:t.isHierarchyActive(),HasFilter:!!t.getFilter(),SortDirection:a(t),Position:r.getDimensionIndex(t.getName()),LastPosition:r.getDimensionCount()-1,IsStructure:t.getDimensionType().getName()===i.MeasureStructure||t.getDimensionType().getName()===i.SecondaryStructure,IsMeasureStructure:t.getDimensionType().getName()===i.MeasureStructure||t.getDimensionType().getName()===i.SecondaryStructure};if(t.getDimensionType().getName()===i.MeasureStructure||t.getDimensionType().getName()===i.SecondaryStructure){var n=t.getDisplayKeyField();e[t.getExternalName()||t.getName()].Members=f.map(u.arrayFromList(t.getAllStructureMembers()),function(e){return{Name:e.getFieldValue(t.getDisplayKeyField())?e.getFieldValue(n).getValue().getString():e.getName(),TechName:e.getName(),Description:e.getText()}})}return e},{});p.FreeDimensions=f.sortBy(f.filter(p.Dimensions,{Axis:r.Free}),"Description");p.ColumnsDimensions=f.sortBy(f.filter(p.Dimensions,{Axis:r.Columns}),"Position");p.RowsDimensions=f.sortBy(f.filter(p.Dimensions,{Axis:r.Rows}),"Postion");p.FlatDimensions=f.filter(f.concat(p.RowsDimensions,p.ColumnsDimensions),function(e){return!e.IsMeasureStructure});p.AllDimensions=f.sortBy(f.concat(p.RowsDimensions,p.ColumnsDimensions,p.FreeDimensions),"Description");if(!p.Chart.catDimension){p.Chart.catDimension=p.FlatDimensions.length?p.FlatDimensions[0].Name:null}if(!p.Chart.cat2Dimension){p.Chart.cat2Dimension=p.FlatDimensions.length>1?p.FlatDimensions[1].Name:null}var l=g.getQueryModel().getMeasureDimension().getExternalName()||g.getQueryModel().getMeasureDimension().getName();var c=g.getQueryModel().getMeasureDimension()?p.Dimensions[l]:null;if(!p.Chart.valDimension&&c){p.Chart.valDimension=c.Name}if(!p.Chart.val2Dimension&&c){p.Chart.val2Dimension=c.Name}p.Chart.vizProperties.title.text=p.QueryTitle||p.QueryName;var y=g.getQueryModel().getMeasureDimension()&&c.Members||[];if(t){p.FlatResultSet=t.FlatResultSet;p.Chart.Measures=t.Measures;p.Chart.Dimensions=t.Dimensions}else{p.Measures=y}p.Conditions=f.map(g.getQueryModel().getConditionManager()?u.arrayFromList(g.getQueryModel().getConditionManager()):[],function(e){return{Name:e.getName(),Description:e.getText(),StatusText:m.getText(e.isActive()?"ACTIVE":"INACTIVE"),active:e.isActive()}});p.Exceptions=f.map(g.getQueryModel().getExceptionManager()?u.arrayFromList(g.getQueryModel().getExceptionManager()):[],function(e){return{Name:e.getName(),Description:e.getText(),StatusText:m.getText(e.isActive()?"ACTIVE":"INACTIVE"),active:e.isActive()}})}T();p.setInputEnabled=function(e){g.getPlanningManager().setDataEntryEnabled(e);v=e;return p};(function(){var e=null;p.suppressUnit=function(t){e=t};p.getSuppressedUnit=function(){return e}})();p.openAxisDialog=function(){var e=sap.firefly.AldEntryPoint.createEntryPoint(s);var t;function r(e){t=e}e.openAldDialog(m.getText("QUERY_SETTINGS",[p.QueryTitle]),d,{onSubmit:function(){t(true);t=null},onClose:function(){if(t){t(false)}}});return new Promise(r)};p.openCellDialog=function(e,t,r,n){var i=p.Dimensions[e];if(!i||!i.IsStructure){throw new Error("Dimension is not a structure:"+e)}var a=g.getQueryModel().getDimensionByName(i.TechName).getDisplayKeyField();var o=f.find(u.arrayFromList(g.getQueryModel().getDimensionByName(p.Dimensions[e].TechName).getAllStructureMembers()),function(e){var r=e.getFieldValue(a);var n=r?r.getString():e.getName();return n===t});if(!o){throw new Error("Member "+t+" not found in structure: "+e)}var s;if(r){var l=p.Dimensions[r];if(!l||!l.IsStructure){throw new Error("Dimension is not a structure:"+r)}var c=g.getQueryModel().getDimensionByName(p.Dimensions[r].TechName).getDisplayKeyField();s=f.find(u.arrayFromList(g.getQueryModel().getDimensionByName(p.Dimensions[r].TechName).getAllStructureMembers()),function(e){var t=e.getFieldValue(c);var r=t?t.getString():e.getName();return r===n});if(!s){throw new Error("Member "+n+" not found in structure: "+r)}}var y;function d(e){y=e}var D=new Promise(d);var v=sap.firefly.DataCellDialogDragonflyEntryPoint.createEntryPoint(g);v.setI18nProvider(m,null);v.openDataCellPropertiesDialog({onDataCellOk:function(){var e=y;y=null;return e(true)},onDataCellClose:function(){if(y){y(false)}v.close()}},g,o.getName(),s?s.getName():null);return D};p.openDimDialog=function(e){return new Promise(function(t){var r=sap.firefly.ProgramRunner.createRunner(s.getProcess(),sap.firefly.OuDimensionDialog2.DEFAULT_PROGRAM_NAME);r.setObjectArgument(sap.firefly.DfOuDialogProgram.PARAM_QUERY_MANAGER,g);r.setArgument(sap.firefly.OuDimensionDialog2.PARAM_DIMENSION_NAME,p.Dimensions[e].TechName);r.setObjectArgument(sap.firefly.DfOuDialogProgram.PARAM_OK_PROCEDURE,{execute:function(){t(true)}});r.setObjectArgument(sap.firefly.DfOuDialogProgram.PARAM_CANCEL_PROCEDURE,{execute:function(){t(false)}});r.runProgram(null)})};p.setResultVisibility=function(e,t){d.getDimensionByName(p.Dimensions[e].TechName).setResultVisibility(sap.firefly.ResultVisibility[t]);return p.getResultSet()};p.setDimensionDisplay=function(e,t){var r=g.getQueryModel();var n=r.getDimensionByName(p.Dimensions[e].TechName);var i=n.getDisplayKeyField()||n.getKeyField();var o=n.getTextField();var s=n.getResultSetFields();var l=f.filter(u.arrayFromList(s).map(function(e){return e}),function(e){return e!==n.getKeyField()&&e!==n.getTextField()&&e!==n.getDisplayKeyField()});s.clear();switch(t){case a.Key:s.add(i);break;case a.Text:s.add(o);break;case a.KeyText:s.add(i);s.add(o);break;case a.TextKey:s.add(o);s.add(i);break}f.forEach(l,function(e){s.add(e)});return p.getResultSet()};p.isVariableInputEnabled=function(e){var t=N[e];if(!t){return false}var r=g.getQueryModel().getVariable(t);return!!r&&r.isInputEnabled&&r.isInputEnabled()};p.hasVariableValueHelp=function(e){var t=g.getQueryModel().getVariable(e);return!!t&&t.supportsValueHelp&&t.supportsValueHelp()};function h(e,t,r){if(t!=null&&r!=null){e.addSupplementValue(t.getName(),r)}}function E(e,t,r){var n=e.getKeyField();var i=e.getDisplayKeyField()!==n?e.getDisplayKeyField():null;var a=e.getTextField();t.addSupplementField(i);t.addSupplementField(a);for(var o=0;o<r.size();o++){var s=r.get(o);var l=t.addNewCartesianElement();l.setComparisonOperator(sap.firefly.ComparisonOperator.EQUAL);l.setField(n);var u=l.getLow();u.setValue(sap.firefly.XValueUtil.getValueFromString(s.getKey(),n.getValueType()));h(u,i,s.getDisplayKey());h(u,a,s.getText())}}function F(e){var t=N[e];if(!t){return false}return g.getQueryModel().getVariable(t)}p.applySelectionToVariable=function(e,t){var r=function(e){if(!e)return;if(e.getVariableType().isTypeOf(sap.firefly.VariableType.DIMENSION_MEMBER_VARIABLE)){var r=e.getDimension();var n=e.getMemberFilter();n.clear();E(r,n,t)}else{if(!t.isEmpty()){e.setValueByStringExt(t.get(0).getKey(),true)}}};return new Promise(function(t,r){var n=F(e);if(!n||!n.isInputEnabled()){t(null)}if(n&&n.isInputEnabled()){if(g.isReinitNeeded()){g.reInitVariablesAfterSubmit(sap.firefly.SyncType.NON_BLOCKING,function(e){return e.hasErrors()?r(l.reject(e.getErrors())):t(n)})}else{t(n)}}else{r(new Error("Variable is not input enabled"))}}).then(r)};p.openVariableSelector=function(e){var t=F(e);if(!(t&&t.supportsValueHelp&&t.supportsValueHelp())){throw new Error("No Value help for variable "+e)}if(g.isReinitNeeded()){g.reInitVariablesAfterSubmit(sap.firefly.SyncType.BLOCKING,null,null)}var r=t.getDimension();var n=sap.firefly.FdEntryPoint.createEntryPoint(s,m.getText("SELECTOR",[r.getText()]));var i=n.getConfiguration();i.setAlwaysShowSelectionContainer(true);i.setFunctionalValuesEnabled(true);i.setMultiSelection(t.supportsMultipleValues());i.setDetermineSelectionFromContext(true);n.getUiContext().getLocalization().setExternalLocalization(sap.firefly.OrcaI18nMapping.create(),m);var a;function o(e){a=e}n.openWithVariable(t,{onFilterDialogOk:function(e){a(e)},onFilterDialogCancel:function(){a(null)}});var l=new Promise(o);return l.then(function(e){if(!e){return false}return e})};p.openCurrencyTranslationDialog=function(){var e;function t(t){e=t}var r=sap.firefly.CtEntryPoint.createEntryPoint(s);r.setI18nProvider(m,null);r.openQCTDialog(m.getText("QCT_CURRENCY_TRANSLATION"),g.getQueryModel().getCurrencyTranslationManager(),{onSubmit:function(){e(true);e=null},onClose:function(){if(e){e(false)}}});return new Promise(t)};p.getFilterOfDim=function(e){var t=g.getQueryModel().getDimensionByName(p.Dimensions[e].TechName);function r(e){var r=t.getKeyField();var n=t.getDisplayKeyField()!==r?t.getDisplayKeyField():null;var i=t.getTextField();var a=e.getLow();var o=null;if(n!=null){o=a.getSupplementValueString(n.getName())}if(!o&&i){o=a.getSupplementValueString(i.getName())}return o}return f.map(u.arrayFromList(g.getQueryModel().getFilter().getDynamicFilter().getCartesianListByField(t.getKeyField())),function(e){return{ComparisonOperator:M(e.getComparisonOperator()),Text:r(e),Low:e.getLow().getString(),High:e.getHigh().getString(),IsExcluding:e.getSetSign()===sap.firefly.SetSign.EXCLUDING}})};p.openSelector=function(e){var t=g.getQueryModel().getDimensionByName(p.Dimensions[e].TechName);if(!d.getFilter().getDynamicFilter().isCartesianProduct()){throw new Error("Filter to complex")}var r;function n(e){r=e}return Promise.resolve(null).then(function(){var e=sap.firefly.FdEntryPoint.createEntryPoint(s,m.getText("SELECTOR",[t.getText()]));var i=e.getConfiguration();i.setFunctionalValuesEnabled(true);i.setMultiSelection(true);i.setDetermineSelectionFromContext(true);e.getUiContext().getLocalization().setExternalLocalization(sap.firefly.OrcaI18nMapping.create(),m);e.openWithDimension(t,{onFilterDialogOk:function(e){r(e)},onFilterDialogCancel:function(){r(false)}});var a=new Promise(n);return a.then(function(e){if(!e){return false}var r=t.getFilter();if(r!=null){r.clear()}else{var n=t.getQueryModel().getFilter().getDynamicFilter();r=n.getCartesianListWithDefault(t)}E(t,r,e);return true})})};p.setAxesLayout=function(e){f.forEach(f.map(p.FlatDimensions,"Name"),function(e){g.getQueryModel().getAxis(sap.firefly.AxisType.FREE).add(g.getQueryModel().getDimensionByName(p.Dimensions[e].TechName))});f.forEach(e.rows,function(e){A(sap.firefly.AxisType.ROWS,e)});f.forEach(e.columns,function(e){A(sap.firefly.AxisType.COLUMNS,e)});return p};p.removeDrilldown=function(e){g.getQueryModel().getAxis(sap.firefly.AxisType.FREE).add(g.getQueryModel().getDimensionByName(p.Dimensions[e].TechName));return p.getResultSet()};p.drilldown=function(e,t){var r=g.getQueryModel();if(e){var n=r.getDimensionByName(p.Dimensions[e].TechName);var i=r.getAxesManager().getRowsAxis().getDimensionCount()?n.getAxis():r.getAxesManager().getRowsAxis();var a=!i.getDimensionCount()?0:n.getDimension().getAxis().getDimensionIndex(n.getName())+1;i.insert(a,r.getDimensionByName(p.Dimensions[t].TechName))}else{r.getAxesManager().getRowsAxis().insert(r.getAxesManager().getRowsAxis().getDimensionCount(),r.getDimensionByName(p.Dimensions[t].TechName))}return p.getResultSet()};p.moveUp=function(e){var t=g.getQueryModel();var r=t.getDimensionByName(p.Dimensions[e].TechName);var n=r.getAxis();var i=n.getDimensionIndex(r.getName())-1;n.insert(i,r);return p};p.moveDown=function(e){var t=g.getQueryModel();var r=t.getDimensionByName(p.Dimensions[e].TechName);var n=r.getAxis();var i=n.getDimensionIndex(r.getName())+1;n.insert(i,r);return p};p.setDisplayHierarchy=function(e,t,r,n){var i=g.getQueryModel();var a=i.getDimensionByName(p.Dimensions[e].TechName);if(r){a.setHierarchyName(r);if(n){a.setHierarchyVersion(n)}}a.setHierarchyActive(t);return p};p.getScalingFactor=function(e,t){var r=p.Dimensions.MeasureStructure;if(!r){throw new Error("No measure Structure")}var n=t?p.Dimensions.NonMeasureStructure:null;var i=r.TechName;var a=u.arrayFromList(g.getQueryModel().getDimensionByName(i).getAllStructureMembers());var o=g.getQueryModel().getDimensionByName(i).getDisplayKeyField();var s=function(){var t=f.find(a,function(t){var r=t.getFieldValue(o);var n=r?r.getString():t.getName();return n===e});if(!t){throw new Error("Member "+e+" not found in structure: "+i)}return t}();if(!n){return s.getNumericShift()?-1*s.getNumericShift().getInteger():0}else{var l=n.TechName;var c=u.arrayFromList(g.getQueryModel().getDimensionByName(l).getAllStructureMembers());var m=g.getQueryModel().getDimensionByName(l).getDisplayKeyField();var y=function(){var r=f.find(c,function(e){var r=e.getFieldValue(m);var n=r?r.getString():e.getName();return n===t});if(!r){throw new Error("Member "+e+" not found in structure: "+i)}return r}();var d=u.arrayFromIter(g.getQueryModel().getQueryDataCells().getIterator());var D=f.find(d,function(e){return e.hasMemberReference(s)&&e.hasMemberReference(y)});if(!D){throw new Error("Invalid Query Cell")}return D.getScalingFactor()}};p.setScalingFactor=function(e,t,r){var n=p.Dimensions.MeasureStructure;if(!n){throw new Error("No measure Structure")}var i=r?p.Dimensions.NonMeasureStructure:null;var a=n.TechName;var o=u.arrayFromList(g.getQueryModel().getDimensionByName(a).getAllStructureMembers());var s=g.getQueryModel().getDimensionByName(a).getDisplayKeyField();var l=function(){var e=f.find(o,function(e){var r=e.getFieldValue(s);var n=r?r.getString():e.getName();return n===t});if(!e){throw new Error("Member "+t+" not found in structure: "+a)}return e}();if(!i){l.setNumericShift(-1*e);return p}else{var c=i.TechName;var m=u.arrayFromList(g.getQueryModel().getDimensionByName(c).getAllStructureMembers());s=g.getQueryModel().getDimensionByName(c).getDisplayKeyField();var y=function(){var e=f.find(m,function(e){var t=e.getFieldValue(s);var n=t?t.getString():e.getName();return n===r});if(!e){throw new Error("Member "+r+" not found in structure: "+c)}return e}();var d=u.arrayFromIter(g.getQueryModel().getQueryDataCells().getIterator());d=f.filter(d,function(e){return e.hasMemberReference(l)&&e.hasMemberReference(y)});if(!d||d.length<1){throw new Error("Invalid Query Cell")}return f.forEach(d,function(t){t.setScalingFactor(e)})}};p.setDecimalPlaces=function(e,t,r){var n=p.Dimensions.MeasureStructure;if(!n){throw new Error("No measure Structure")}var i=r?p.Dimensions.NonMeasureStructure:null;var a=n.TechName;var o=u.arrayFromList(g.getQueryModel().getDimensionByName(a).getAllStructureMembers());var s=g.getQueryModel().getDimensionByName(a).getDisplayKeyField();var l=function(){var e=f.find(o,function(e){var r=e.getFieldValue(s);var n=r?r.getString():e.getName();return n===t});if(!e){throw new Error("Member "+t+" not found in structure: "+a)}return e}();if(!i){l.setNumericScale(e);return p}else{var c=i.TechName;var m=u.arrayFromList(g.getQueryModel().getDimensionByName(c).getAllStructureMembers());s=g.getQueryModel().getDimensionByName(c).getDisplayKeyField();var y=function(){var e=f.find(m,function(e){var t=e.getFieldValue(s);var n=t?t.getString():e.getName();return n===r});if(!e){throw new Error("Member "+r+" not found in structure: "+c)}return e}();var d=u.arrayFromIter(g.getQueryModel().getQueryDataCells().getIterator());d=f.filter(d,function(e){return e.hasMemberReference(l)&&e.hasMemberReference(y)});if(!d||d.length<1){throw new Error("Invalid Query Cell")}return f.forEach(d,function(t){t.setDecimalPlaces(e)})}};p.getDecimalPlaces=function(e,t){var r=p.Dimensions.MeasureStructure;if(!r){throw new Error("No measure Structure")}var n=t?p.Dimensions.NonMeasureStructure:null;var i=r.TechName;var a=u.arrayFromList(g.getQueryModel().getDimensionByName(i).getAllStructureMembers());var o=g.getQueryModel().getDimensionByName(i).getDisplayKeyField();var s=function(){var t=f.find(a,function(t){var r=t.getFieldValue(o);var n=r?r.getString():t.getName();return n===e});if(!t){throw new Error("Member "+e+" not found in measureDim: "+i)}return t}();if(!n){return s.getNumericScale()}else{var l=n.TechName;var c=u.arrayFromList(g.getQueryModel().getDimensionByName(l).getAllStructureMembers());var m=g.getQueryModel().getDimensionByName(l).getDisplayKeyField();var y=function(){var e=f.find(c,function(e){var r=e.getFieldValue(m);var n=r?r.getString():e.getName();return n===t});if(!e){throw new Error("Member "+t+" not found in measureDim: "+l)}return e}();var d=u.arrayFromIter(g.getQueryModel().getQueryDataCells().getIterator());var D=f.find(d,function(e){return e.hasMemberReference(s)&&e.hasMemberReference(y)});if(!D){throw new Error("Invalid Query Cell")}return D.getDecimalPlaces()}};p.setFilter=function(e,t){var r=p.Dimensions[e];var n=[];if(typeof t==="string"){n.push(t)}else{n=t}sap.firefly.QFilterUtil.clearSelectionsInContainerByDimension(p.Dimensions[e].TechName,g.getQueryModel().getFilter().getDynamicFilter());var i=p.Dimensions[e].TechName;var a=g.getQueryModel().getDimensionByName(i);var o=r.IsStructure?u.arrayFromList(a.getAllStructureMembers()):[];var s=r.IsStructure?a.getDisplayKeyField():null;f.forEach(n,function(e){var t=r.IsStructure?function(){var t=f.find(o,function(t){var r=t.getFieldValue(s);var n=r?r.getString():t.getName();return n===e});if(!t){throw new Error("Member "+e+" not found in structure: "+i)}return t.getName()}():e;g.getQueryModel().getFilter().getDynamicFilter().addSingleMemberFilterByName(i,t,sap.firefly.ComparisonOperator.EQUAL)});return p};p.removeFilter=function(e){sap.firefly.QFilterUtil.clearSelectionsInContainerByDimension(p.Dimensions[e].TechName,g.getQueryModel().getFilter().getDynamicFilter());return p};p.sort=function(e,t,r,n){var i=g.getQueryModel().getDimensionByName(p.Dimensions[e].TechName);if(p.Dimensions[e].IsStructure){var a=g.getConvenienceCommands();a.clearSort(null,null);a.sortByMeasure(f.find(p.Dimensions[e].Members,function(e){return e.Name===n}).TechName,sap.firefly.XSortDirection[t])}else{i.getResultSetSorting().setDirection(sap.firefly.XSortDirection[t]);if(r){i.getResultSetSorting().setSortType(sap.firefly.SortType[r])}}return p};function A(e,t){var r=g.getQueryModel();var n=p.Dimensions[t].TechName;var i=r.getQueryModel().getDimensionByName(n);r.getAxis(e).add(i);var a=c.getFields(i);var o=i.getResultSetFields();var s=a.oTextField;if(s&&!o.contains(s)){o.add(s);s.setObtainability(sap.firefly.ObtainabilityType.USER_INTERFACE)}var l=a.oDisplayKeyField;if(!o.contains(l)){o.add(l);l.setObtainability(sap.firefly.ObtainabilityType.USER_INTERFACE)}}p.toRows=function(e){A(sap.firefly.AxisType.ROWS,e);return p};p.toColumns=function(e){A(sap.firefly.AxisType.COLUMNS,e);return p};p.drill=function(e,t,r){var n=g.getQueryModel().getDimensionByName(p.Dimensions[e].TechName);var i=D.getAxis(n.getAxisType()).getTupleAt(t).getTupleElementByDimension(n);i.setNextDrillState(i.getDrillState()!==sap.firefly.DrillState.COLLAPSED?sap.firefly.DrillState.COLLAPSED:sap.firefly.DrillState.EXPANDED);return p.getResultSet(r)};p.submitVariables=function(){return l.syncActionToPromise(g.submitVariables,g,[]).then(function(t){T();if(t&&t.getMessages().length){e.addMessages(u.arrayFromList(t.getMessages()).map(function(e){var t=e.getSeverity().getName();if(t==="Info"){t="Information"}return{Text:e.getText(),Severity:t,Code:e.getCode(),MessageClass:e.getMessageClass(),LongTextUri:e.getMessageClass()?["/sap/opu/odata/iwbep/message_text;o=LOCAL/T100_longtexts(MSGID='",encodeURIComponent(e.getMessageClass()),"',MSGNO='",encodeURIComponent(e.getCode()),",',MESSAGE_V1='',MESSAGE_V2='',MESSAGE_V3='',MESSAGE_V4='')/$value"].join(""):null}}))}}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);if(!t.getMessages){throw t}p.Grid=null})};var b;p.getResultSet=function(t){if(!t){p.setOffsetCol(0);p.setOffsetRow(0)}if(b){s.getSession().notifyInterruptStep(b,false)}if(g.hasChangedCells()){g.transferNewValues()}g.setOffsetColumns(p.virtualOffsetCol);g.setOffsetRows(p.virtualOffsetRow);g.setMaxRows(e.getLimit().RowLimit);g.setMaxColumns(e.getLimit().ColLimit);e.fireRequestSent({infoObject:p.Name});return l.syncActionToPromise(g.processQueryExecution,g,[]).then(function(t){b=sap.firefly.XInterruptStep.create();s.getSession().notifyInterruptStep(b,true);D=t.getClassicResultSet();var r=function(){var t=sap.firefly.FioriGridFactory.createFioriGrid(D);if(p.getSuppressedUnit()){t.setSuppressUnit(p.getSuppressedUnit())}f.map(e.getSemanticStyles(),function(e,r){t.addSemanticStyle(r,e)});return t.exportToFireflyGrid(p.SuppressRepetition)}();p.Grid=r.convertToNative();p.Grid.format=S;p.Grid.virtualOffsetCol=p.virtualOffsetCol;p.Grid.virtualOffsetRow=p.virtualOffsetRow;if(!p.Grid.Cells||p.Grid.Cells.length===0){p.Grid.Cells=[{Column:0,Row:0,DisplayValue:m.getText("no_data"),CellType:n.EMPTY}]}p.Grid.fixedRows=r.getIntegerByKey("FixedRows");p.Grid.fixedColumns=r.getIntegerByKey("FixedColumns");var i=D.getAxis(sap.firefly.AxisType.ROWS).getTuplesCountTotal();if(i===-1){i=D.getAxis(sap.firefly.AxisType.ROWS).getTuplesCount()}p.Grid.virtualRows=i;i=D.getAxis(sap.firefly.AxisType.COLUMNS).getTuplesCountTotal();if(i===-1){i=D.getAxis(sap.firefly.AxisType.COLUMNS).getTuplesCount()}p.Grid.virtualColumns=i;T(c.flatten(D,p));p._addMessagesToModel(D);e.checkUpdate();e.fireRequestCompleted({infoObject:p.Name});return p}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);if(!t.getMessages){throw t}e.checkUpdate(true);e.fireRequestFailed({});return p})};p.getRRITargets=function(e,t){var r=g.getRriTargetManager();if(!r){return Promise.resolve([])}r.setResultSetContext(e,t);var n,i;function a(e,t){n=e;i=t}r.processRriTargetResolution(sap.firefly.SyncType.NON_BLOCKING,{onRriTargetResolution:function(e){if(e.hasErrors()){i(e.getMessages())}else{var t=sap.ushell?sap.ushell.Container.getService("URLParsing"):{isIntentUrl:f.constant(false)};n(f.filter(e.getData().getListFromImplementation().map(function(e){return e.getParameters().getMapFromImplementation()}),function(e){return t.isIntentUrl(e.URL)||!!e.URL.match(/#/)}).map(function(e){e.URL=e.URL.split("#")[1];return e}))}}});return new Promise(a)};p.synchronize=function(t){e.clearMessages();return p.getResultSet(t)};p.getColumnSelection=function(e){return c.tupleToObject(D.getColumnsAxis().getTupleAt(e))};p.getRowSelection=function(e){return c.tupleToObject(D.getRowsAxis().getTupleAt(e))};p.getSelection=function(e,t){return f.assign(e>=0&&e<D.getRowsAxis().getTuplesCount()?c.tupleToObject(D.getRowsAxis().getTupleAt(e)):{},t>=0&&t<D.getColumnsAxis().getTuplesCount()?c.tupleToObject(D.getColumnsAxis().getTupleAt(t)):{})};p.readHierarchy=function(e,t){var r,n;function i(e,t){r=e;n=t}var a=g.getValueHelpProvider();var o=g.getQueryModel().getDimensionByName(p.Dimensions[e].TechName);var s=o.getInitialDrillLevel();o.setSelectorInitialDrillLevel(t);var u=new Promise(i);a.processValueHelp(o,sap.firefly.SyncType.NON_BLOCKING,{onValuehelpExecuted:function(e){return e.hasErrors()?n(l.reject(e.getErrors())):r(e.getData())}},null,null);return u.then(function(e){function t(e){if(!e){return{}}var r=e.getChildren();return{Name:e.getName(),Text:e.getDimensionMember().getText()||e.getDimensionMember(e.getDimension().getHierarchyDisplayKeyField()).getValue().getString(),hierNodes:r?f.map(r.getListFromImplementation(),t):null}}o.setSelectorInitialDrillLevel(s);var r=f.filter(e.getListFromImplementation(),function(e){return!e.getParentNode()});return r.length===1?t(r[0]):{Name:"$Root",Text:m.getText("ARTIFICIAL_ROOT"),hierNodes:f.map(r,t)}})};p.hasVariable=function(e){var t=F(e);return!!t&&t.isInputEnabled()};p.setVariableValue=function(e,t){return new Promise(function(t,r){var n=F(e);if(n&&n.isInputEnabled()){if(g.isReinitNeeded()){g.reInitVariablesAfterSubmit(sap.firefly.SyncType.NON_BLOCKING,function(e){return e.hasErrors()?r(l.reject(e.getErrors())):t(n)})}else{t(n)}}else{r(new Error("Variable is not input enabled"))}}).then(function(e){return new Promise(function(r){e.clear();if(!t){return p}var n=e.getMemberFilter?e.getMemberFilter():null;f.forEach(t,function(t){if(n){var r=n.addNewCartesianElement();var i=sap.firefly.XValueAccess.createWithType(e.getValueType());i.parseString(t.Low);r.getLow().setValue(i.getValue());if(t.High){i=sap.firefly.XValueAccess.createWithType(e.getValueType());i.parseString(t.High);r.getHigh().setValue(i.getValue())}r.setComparisonOperator(sap.firefly.ComparisonOperator[t.Comparison]);r.setSetSign(sap.firefly.SetSign[t.IsExcluding?"EXCLUDING":"INCLUDING"]);var a=e.getDimension().getFirstFieldByType(sap.firefly.PresentationType.KEY_NOT_COMPOUND);if(a){r.setField(a)}}else{e.setValueByStringExt(t.Low,true)}});r(e)})})};p._addMessagesToModel=function(t){if(t&&t.getMessages().length){e.addMessages(u.arrayFromList(t.getMessages()).map(function(e){var t=e.getSeverity().getName();if(t==="Info"){t="Information"}return{Text:e.getText(),Severity:t,Code:e.getCode(),MessageClass:e.getMessageClass(),LongTextUri:e.getMessageClass()?["/sap/opu/odata/iwbep/message_text;o=LOCAL/T100_longtexts(MSGID='",encodeURIComponent(e.getMessageClass()),"',MSGNO='",encodeURIComponent(e.getCode()),",',MESSAGE_V1='',MESSAGE_V2='',MESSAGE_V3='',MESSAGE_V4='')/$value"].join(""):null}}))}};p.createDocumentId=function(t,r){var n=g.getResultsetContainer().getDocumentIdManager();var i=sap.firefly.RsCellIndexInfo.create();i.initialize(t,r);return l.syncActionToPromise(n.createCellDocumentId,n,i).then(function(e){p._addMessagesToModel(e);return e.getData().isCellDocumentIdCreated()}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);return Promise.reject(t)})};p.getDocumentId=function(t,r){var n=g.getResultsetContainer().getDocumentIdManager();var i=sap.firefly.RsCellIndexInfo.create();i.initialize(t,r);return l.syncActionToPromise(n.getCellDocumentId,n,i).then(function(e){p._addMessagesToModel(e);return e.getData().getCellDocumentId()}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);return Promise.reject(t)})};p.deleteDocumentId=function(t,r){var n=g.getResultsetContainer().getDocumentIdManager();var i=sap.firefly.RsCellIndexInfo.create();i.initialize(t,r);return l.syncActionToPromise(n.deleteCellDocumentId,n,i).then(function(e){p._addMessagesToModel(e);return e.getData().isCellDocumentIdDeleted()}).catch(function(t){e.addMessages(t.getMessages?t.getMessages():[]);return Promise.reject(t)})};function x(){return new Promise(function(e,t){if(g.isReinitNeeded()){g.reInitVariablesAfterSubmit(sap.firefly.SyncType.NON_BLOCKING,function(r){return r.hasErrors()?t(l.reject(r.getErrors())):e()})}else{e()}})}p.deserialize=function(e){return x().then(function(){g.getQueryModel().deserializeExt(sap.firefly.QModelFormat.INA_REPOSITORY,e)})};p.serialize=function(){return g.getQueryModel().serializeToContentExt(sap.firefly.QModelFormat.INA_REPOSITORY,null).getString()};p.getResultRequest=function(){return g.getResultsetContainer().getResultSetManager().getDataRequest().convertToNative()};p.getQueryView=function(){return g.getQueryModel().serializeToElement(sap.firefly.QModelFormat.INA_DATA).convertToNative()};p.addCondition=function(e){return Promise.resolve(null).then(function(){var t=["COND_",Date.now()].join("");var r=g.getQueryModel().getConditionManager().addNewCondition(t);r.setDescription(e.Description);r.setText(e.Description);var n=g.getQueryModel().getDimensionByName(p.Dimensions[e.Structure1Key].TechName);var i=f.find(p.Dimensions[e.Structure1Key].Members,function(t){return e.measure1===t.Name}).TechName;if(!i){throw new Error("Invalid measure")}r.setDimensionEvaluationType(sap.firefly.ConditionDimensionEvaluationType.ALL_IN_DRILL_DOWN);var a=r.createThreshold();var o=n.getStructureMember(i);if(!o){throw new Error("Invalid measure")}a.addMeasureCoordinate(o);a.setComparisonOperator(sap.firefly.ConditionComparisonOperator[e.operator]);a.getLow().setString(e.Value);return p})};p.resetToDefault=function(){return x().then(function(){g.getConvenienceCommands().resetToDefault()})};p.logoff=function(){return new Promise(function(e){g.processShutdown(sap.firefly.SyncType.NON_BLOCKING,{onQueryManagerRelease:function(t,r){sap.firefly.XObjectExt.release(r);e()}})})}};y.prototype.hasVariable=function(){};y.prototype.setAxesLayout=function(){};y.prototype.openCellDialog=function(){};y.prototype.openAxisDialog=function(){};y.prototype.openCurrencyTranslationDialog=function(){};y.prototype.openDimDialog=function(){};y.prototype.openSelector=function(){};y.prototype.setFilter=function(){};y.prototype.removeFilter=function(){};y.prototype.sort=function(){};y.prototype.toRows=function(){};y.prototype.toColumns=function(){};y.prototype.drill=function(){};y.prototype.submitVariables=function(){};y.prototype.getResultSet=function(){};y.prototype.getRRITargets=function(){};y.prototype.addCondition=function(){};y.prototype.moveUp=function(){};y.prototype.moveDown=function(){};y.prototype.setDisplayHierarchy=function(){};y.prototype.getFilterOfDim=function(){};y.prototype.synchronize=function(){};y.prototype.setFormat=function(){};y.prototype.getScalingFactor=function(){};y.prototype.setScalingFactor=function(){};y.prototype.getDecimalPlaces=function(){};y.prototype.setDecimalPlaces=function(){};y.prototype.suppressUnit=function(){};y.prototype.createDocumentId=function(){};y.prototype.getDocumentId=function(){};y.prototype.deleteDocumentId=function(){};return y});
//# sourceMappingURL=DataProvider.js.map
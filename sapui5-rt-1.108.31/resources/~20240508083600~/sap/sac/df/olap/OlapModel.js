/*
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/olap/OlapModel",["sap/base/Log","sap/sac/df/utils/Utilities","sap/ui/model/Model","sap/ui/model/Context","sap/sac/df/types/ValueType","sap/sac/df/olap/SystemLandscape","sap/sac/df/utils/SyncActionHelper","sap/sac/df/utils/ResultSetHelper","sap/sac/df/utils/ListHelper","sap/sac/df/utils/ApplicationHelper","sap/sac/df/olap/OlapListBinding","sap/sac/df/olap/OlapListGridBinding","sap/sac/df/olap/OlapPropertyBinding","sap/sac/df/olap/DataProvider","sap/sac/df/utils/ResourceBundle","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library"],function(e,t,r,a,n,i,o,s,c,u,l,f,d,p,y,g){"use strict";var v=new RegExp("/","g");var m=r.extend("sap.sac.df.olap.OlapModel",{constructor:function(t){var n=this;r.apply(n);var m=g.clone(t||{});m.systemLandscape=m.systemLandscape||i;m.masterSystem=m.masterSystem||"localAbapAnalyticEngine";var h=null;var S=Promise.resolve(null).then(function(){return u.createApplication(m.systemLandscape,m.masterSystem)}).then(function(e){h=e;h.getSession().setXVersion(sap.firefly.XVersion.V190_METADATA_CUBE_RESPONSE_SUPPRESS_PROPERTIES);h.getSession().deactivateFeatureToggle(sap.firefly.FeatureToggleOlap.FUSION_SERVICE);sap.firefly.XStream.of(sap.firefly.FeatureToggleOlap.getAllFeatureToggles()).forEach(function(e){var t=e.getXVersion();if(t>sap.firefly.FeatureToggleOlap.FUSION_SERVICE.getXVersion()&&t<=sap.firefly.XVersion.MAX){h.getSession().activateFeatureToggle(e)}});h.getSession().activateFeatureToggle(sap.firefly.FeatureToggleOlap.METADATA_CACHING);sap.firefly.UiLocalizationCenter.setExternalLocalizationProvider({getText:function(e){return y.getText(e.substring(3))},getTextWithPlaceholder:function(e,t){return y.getText(e.substring(3),t)},getTextWithPlaceholder2:function(e,t,r){return y.getText(e.substring(3),[t,r])}});sap.firefly.UiLocalizationCenter.getCenter().getLocalizationProviderByName(sap.firefly.OuDimensionDialog2.DEFAULT_PROGRAM_NAME).m_isProductive=true}).then(function(){T({HasUndo:false,systems:g.map(c.arrayFromList(h.getSystemLandscape().getSystemNames()),function(e){var t=h.getConnectionPool();var r=t.getSystemLandscape().getSystemDescription(e);if(r.getSystemType().isTypeOf(sap.firefly.SystemType.BW)||r.getSystemType().isTypeOf(sap.firefly.SystemType.BPCS)){t.setMaximumSharedConnections(e,m.numberOfConnections||6)}return{name:e}}),colLimit:-1,rowLimit:125,dataProvider:{},variables:{},semanticStyles:{},messages:[],Functions:[]})});var P=null;var E={};function T(e){P=e;n.checkUpdate()}function b(e){if(P.HasUndo!==e){P.HasUndo=e;n.checkUpdate()}}n.setDataAccessLanguage=function(e){var t=h.getSystemLandscape();var r=t.getSystemNames();for(var a=0;a<r.size();a++){t.getSystemDescription(r.get(a)).setLanguage(e)}};n.bindProperty=function(e,t,r){var a=new d(n,e,t,r);E[a.getId()]=a;return a};n.bindList=function(e,t,r,a,i){if(e.match(/^(\/)?dataProvider\/(.)*\/Grid\/renderGrid/)){return new f(n,e,t,r,a,i)}else{return new l(n,e,t,r,a,i)}};function L(e,t){var r=t instanceof a?L(t.getPath()):P;if(e){var n=e.replace(v,".");if(n.startsWith(".")){n=n.replace(".","")}return g.get(r,n)}else{return r}}n.isList=function(e,t){return Array.isArray(L(n.resolve(e,t)))};n.getLimit=function(){return{rowLimit:P.rowLimit,colLimit:P.colLimit}};n.getProperty=function(e,t){return L(e,t)};n.setProperty=function(t,r){var a=false;var i=t.split("/");if(i[i.length-1]==="visibleWithPrio"){var o=P.FlatVariables[parseInt(i[2],10)];o.visibleWithPrio=r}else{var s=g.filter(t.split("/"),g.identity);try{var c=s.pop();var u=s.join(".");var l=g.get(P,u);if(c!=="vizProperties"||r){if(l){l[c]=r}else{e.warning("Failed to set "+r+" on: "+t)}}n.checkUpdate();a=true}catch(t){e.error(t)}}return a};n.undo=function(){return S.then(function(){var e;var t;if(!P.HasUndo){return Promise.resolve(n)}function r(r,a){e=r;t=a}var a=new Promise(r);h.getUndoManager().processUndo(sap.firefly.SyncType.NON_BLOCKING,{undoRedoActionFinished:function(r){if(r.hasErrors()){t(r.getErrors())}else{e(r)}}});return a.then(function(){var e=[];g.forEach(P.dataProvider,function(t){e.push(t.getResultSet(true))});return Promise.all(e)}).then(function(){return n})})};n.redo=function(){return S.then(function(){var e;var t;function r(r,a){e=r;t=a}var a=new Promise(r);h.getUndoManager().processRedo(sap.firefly.SyncType.NON_BLOCKING,{undoRedoActionFinished:function(r){if(r.hasErrors()){t(r.getErrors())}else{e(r)}}});return a.then(function(){var e=[];g.forEach(P.dataProvider,function(t){e.push(t.getResultSet(true))});return Promise.all(e)})})};n.setSemanticStyles=function(e){P.semanticStyles=g.clone(e)};n.getSemanticStyles=function(){return P.semanticStyles};n.addMessages=function(e){P.messages=g.map(g.groupBy(g.concat(P.messages,e),"Text"),function(e){return e[0]});return n.checkUpdate()};n.clearMessages=function(e){P.messages=[];return e?n.checkUpdate():n};n.checkUpdate=function(e){g.forEach(E,function(t,r){if(t){t.checkUpdate(e)}else{delete E[r]}},false);return n};n.checkMessages=function(){g.forEach(E,function(e){return e.checkDataState?e.checkDataState():null})};n.addBinding=function(e){E[e.getId()]=e;return n};n.removeBinding=function(e){delete E[e.getId()]};n.getSystemId=function(){return n.getProperty("/serverInfo/SystemId")};n.getDataProvider=function(e){return P.dataProvider[e]};function A(){var e=g.map(c.arrayFromList(h.getOlapEnvironment().getVariableProcessor().getVariables()),s.transformVariable).filter(function(e){return e.InputEnabled});P.variables=g.reduce(e,function(e,t){var r=e[t.Name];if(r){e[t.Name].visibleWithPrio=r.visibleWithPrio}e[t.Name]=t;return e},P.variables);P.FlatVariables=g.filter(P.variables,function(e){return e.InputEnabled})}n.addQuery=function(e,t,r,a,i,s){return M(r).then(function(){var t=P.dataProvider[e];if(!t)return;return t.logoff()}).then(function(){var e=sap.firefly.QueryServiceConfig.createWithDataSourceName(h,null,t);e.setMode(sap.firefly.QueryManagerMode.DEFAULT);e.setProviderType(sap.firefly.ProviderType.ANALYTICS);e.setSupportsDimensionLazyLoad(true);var n=["$[][][MY_DATA_AREA]/",s||"query",":","[",i?i:"","]","[",i||a?a:"","]","[",t,"]"].join("");e.setDataSourceByName(n);if(r){e.setSystemName(r)}return o.syncActionToPromise(e.processQueryManagerCreation,e,[])}).then(function(t){P.dataProvider[e]=new p(n,b,h,t,e);A()})};n.setVariableValue=function(e,t){var r=[];g(P.dataProvider).filter(function(t){return t.isVariableInputEnabled(e)}).forEach(function(a){r.push(a.setVariableValue(e,t))});return Promise.all(r).then(function(){A();return n.checkUpdate()})};n.deserialize=function(e){P.dataProvider=P.dataProvider||{};P.semanticStyles=e.semanticStyles||[];P.Functions=e.Functions||[];return S.then(function(){var t=[];g.forEach(e.DataProvider,function(e,r){var a=P.dataProvider[r];if(!a){var i=sap.firefly.QueryServiceConfig.createByDefinition(h,null,sap.firefly.XContent.createStringContent(sap.firefly.QModelFormat.INA_REPOSITORY,e));t.push(o.syncActionToPromise(i.processQueryManagerCreation,i,[]).then(function(e){P.dataProvider[r]=new p(n,b,h,e,r)}))}else{t.push(a.deserialize(e))}});return Promise.all(t)}).then(function(){A();return n.checkUpdate()})};n.serialize=function(){return{DataProvider:g.reduce(P.dataProvider,function(e,t){e[t.Name]=t.serialize();return e},{}),semanticStyles:n.getSemanticStyles(),Functions:P.Functions}};n.openVariableSelector=function(e){return Promise.resolve(null).then(function(){var t=g.find(P.dataProvider,function(t){return t.hasVariableValueHelp(P.variables[e].TechName)});if(!t){throw new Error("Invalid Variable: "+e)}return t.openVariableSelector(e).then(function(t){if(!t){return false}var r=[];g.forEach(P.dataProvider,function(a){r.push(a.applySelectionToVariable(e,t))});return Promise.all(r).then(function(){A();n.checkUpdate();return true})})})};n.submitVariables=function(){var e=g.invokeMap(P.dataProvider,"submitVariables");return Promise.all(e).then(function(){A();n.checkUpdate()})};n.logoff=function(){return Promise.all(g.invokeMap(P.dataProvider,"logoff"))};var D;function M(e,t){return S.then(function(){if(D){return D}if(e){return null}var r=sap.firefly.QDataSource.create();r.setDataArea(t||"MY_DATA_AREA");var a=sap.firefly.OlapApiModule.SERVICE_TYPE_PLANNING.createServiceConfig(h);a.setDataSource(r);a.setSystemName(e||m.masterSystem);return o.syncActionToPromise(a.processServiceCreation,a,[]).then(function(e){D=e.getData();return D})})}n.synchronize=function(e){var t=e?function(){var t=g.reduce(e,function(e,t){e[t]=true;return e},{});return g.filter(P.dataProvider,function(e,r){return t[r]===true})}():P.dataProvider;var r=g.invokeMap(t,"getResultSet");return Promise.all(r).then(function(){return n.checkUpdate()})};n.getPlanningService=function(){return D};(function(){var e=S.then(function(){if(t&&t.SemanticStyles){n.setSemanticStyles(t.SemanticStyles)}var e=[];g.forEach(m.dataProvider||[],function(t,r){var a=n.addQuery(r,t.dataSourceName,t.systemName,t.packageName,t.schemaName,t.dataSourceType);e.push(t.synchronize?a.then(function(){return n.getDataProvider(r).synchronize()}):a)});return Promise.all(e)});n.resetModel=function(){var e=[];g.forEach(P.dataProvider,function(t){e.push(t.resetToDefault())});return Promise.all(e).then(function(){A()})};n.dataLoaded=g.constant(e);n.loaded=n.dataLoaded;n.metadataLoaded=n.dataLoaded;n.annotationsLoaded=n.dataLoaded;n.getMetaModel=g.constant(n);n.attachMetadataFailed=g.constant(null);n.fireMetadataFailed=g.constant(null);n.getODataEntityContainer=g.constant(null);n.getODataEntityType=g.constant(n);n.createBindingContext=g.constant(null);n.getODataEntitySet=g.constant(n)})()},metadata:{publicMethods:["openVariableSelector","submitVariables","synchronize","addQuery","serialize","deserialize","getDataProvider"],events:{metadataFailed:{}}}});m.prototype.openVariableSelector=function(){};m.prototype.submitVariables=function(){};m.prototype.synchronize=function(){};m.prototype.getLimit=function(){};m.prototype.serialize=function(){};m.prototype.deserialize=function(){};m.prototype.addQuery=function(){};m.prototype.undo=function(){};m.prototype.getDataProvider=function(){};m.prototype.resetModel=function(){};m.prototype.setDataAccessLanguage=function(){};return m});
//# sourceMappingURL=OlapModel.js.map
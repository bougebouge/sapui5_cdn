/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/json/JSONModel","sap/m/VBox","sap/m/Label","sap/m/Token","sap/m/Tokenizer","sap/m/Button","sap/m/Toolbar","sap/m/SearchField","sap/m/StandardListItem","sap/m/SelectDialog","sap/ui/core/BusyIndicator","sap/ui/model/Sorter","sap/ui/model/Filter","sap/zen/dsh/utils/BaseHandler","sap/zen/dsh/widgets/ValueHelpDialog","sap/zen/dsh/widgets/emptyComponent","sap/zen/dsh/ValueHelpRangeOperation","sap/ui/comp/util/FormatUtil","sap/ui/core/format/DateFormat"],function(jQuery,e,t,r,a,i,n,o,l,s,p,u,f,c,g,d,m,y){"use strict";var h=g.dispatcher;var v=function(){g.apply(this,arguments);var h=this;this.oClipboard={};this.create=function(r,a){var i=h.createUI5Identifier(a["id"]);var n;var o=new e;o.setData(a);var l=o.getProperty("/property/memberselector")||o.getProperty("/property/popupreference");if(l){n=r?r:new m(i);n.onAfterRendering=function(){new Function(h.prepareCommand(n.getModel().getProperty("/command/showfilterdialog"),"__STRING__",n.getModel().getProperty("/characteristics/0/characteristic/name")))();n.onAfterRendering=undefined}}else{n=r?r:new t(i).addStyleClass("sapzenfilterpanelM");if(!o.getProperty("/property/showembedded")){n.addStyleClass("sapzendimensionfilterM")}}if(!o.getProperty("/property/variablescreen")){n.ZEN_IdToDimensionMap={}}n.setModel(o);if(r){n.removeAllItems()}if(!l){this.addItems(n);n.ZEN_submit=this.submitExternal(o,true);n.ZEN_submit_with_apply=this.submitExternal(o,true,true);n.ZEN_check=this.submitExternal(o,false);n.ZEN_cancel=function(){new Function(o.getProperty("/command/cancelonlyfilter"))()}}var s=n.exit;n.exit=function(){if(s){s.apply(n,arguments)}sap.zen.dsh.sapbi_page.appComponent&&sap.zen.dsh.sapbi_page.appComponent._bIsBeingDestroyed||new Function(o.getProperty("/command/destroyfiltercomponent"))()};if(!this.isDesignModeD4LIncluded()){if(a.visible){n.removeStyleClass("zenHideFilterPanel")}else{n.addStyleClass("zenHideFilterPanel")}}return n};this.update=function(e,t,r){if(e&&t){var a=t.view;if(this.isDesignModeD4LIncluded()||t.newds){e.ZEN_multiInput=[];e=this.create(e,t,r);if(a!=="DIALOG"){return e}}if(t.changeVisibility){if(t.visible){e.removeStyleClass("zenHideFilterPanel")}else{e.addStyleClass("zenHideFilterPanel")}if(a==="SUBMIT"){e.ZEN_submit()}else if(a==="SUBMIT_WITH_APPLY"){e.ZEN_submit_with_apply()}else if(a==="CANCEL"){e.ZEN_cancel()}return e}var i=e.getModel();var n=i.getProperty("/filters"),o;var l=i.getProperty("/property/variablescreen");var s=t.filters;if(s){n=i.getProperty("/filters");var p=false;for(var u in s){var f=s[u];o=n[u];if(!o||!f){continue}p=true;if(t.filtercanceled||!o.dirty||l){if(l&&o.dirty){f.dirty=true}n[u]=f;if(i.getProperty("/dialog/name")===u){i.setProperty("/dialog/filters",f)}}}i.setProperty("/filters",p?n:s);x(i,"/filters")}var c=t.validatedfilters;if(c){n=i.getProperty("/filters");for(u in c){var g=c[u];o=n[u];if(!o||!g){continue}if(o&&o.dirty){g.dirty=true;n[u]=g;if(i.getProperty("/dialog/name")===u){i.setProperty("/dialog/filters",g)}}}x(i,"/filters")}var d=i.getProperty("/axis");var m=false;var y=i.getProperty("/characteristics");if(y){for(k=0;k<y.length;k++){if(y[k].characteristic.axisdirty){m=true;break}}}var h=m||d&&(d.rows.dirty||d.columns.dirty);if(a==="DEFAULT"&&(t.filtercanceled||!h)&&!_(t.characteristics,y)){i.setProperty("/characteristics",t.characteristics)}var v=-1;if(a==="DIALOG"){i.setProperty("/dialog",t.dialog);if(t.characteristics&&!_(t.characteristics,y)){i.setProperty("/characteristics",t.characteristics)}var P=this.getValueHelpDialog(e);P.open();P.update();e.zenValueHelpDialog=P}else if(a==="DIALOG_SEARCH"){var T=t.dialog;i.setProperty("/dialog/selection",T.selection);var b=i.getProperty("/dialog/hierarchical");if(b){var E=T.members;if(E){for(var k=0;k===v+1;k++){var F=E[""+k];if(!F){continue}F.level=0;v=k}}}i.setProperty("/dialog/members",T.members);if(e.zenValueHelpDialog){if(b&&e.zenValueHelpDialog.getTable().collapseAll){e.zenValueHelpDialog.getTable().collapseAll()}e.zenValueHelpDialog.update();e.zenValueHelpDialog.getFilterBar().setBusy(false);if(T.selection.maxelements||T.members&&(b||T.members.size>0)){e.zenValueHelpDialog.TableStateSearchData()}else{e.zenValueHelpDialog.TableStateDataFilled()}}}else if(a==="EXPAND_NODE"){var C=i.getProperty(t.path).level;var D=t.member;D.level=C;for(k=0;k===v+1;k++){F=D[""+k];if(!F){continue}F.level=C+1;v=k}i.setProperty(t.path,t.member);if(e.zenValueHelpDialog){e.zenValueHelpDialog.update(t.messages)}}else if(a==="SUBMIT"){e.ZEN_submit()}else if(a==="SUBMIT_WITH_APPLY"){e.ZEN_submit_with_apply()}else if(a==="CANCEL"){e.ZEN_cancel()}}return e};this.addItems=function(e){var t=e.getModel();var r=t.getProperty("/property/showembedded");if(r){var a=t.getProperty("/property/navigationpanel");var i=new l({liveChange:function(r){var i=r.getParameter("newValue");var n=new c(a?"entry/text":"characteristic/text",sap.ui.model.FilterOperator.Contains,i);var o=[n];var l=t.getProperty("/visibleprompts");if(l){o.push(T(l))}e.ZEN_multiInput=[];var s=e.ZENCharLists;for(var p=0;p<s.length;p++){s[p].getBinding("formElements").filter(o)}}});var n=new o({content:[null,i]});if(t.getProperty("/property/variablescreen")&&t.getProperty("/visibleprompts")){n.addContent(v(e,i))}e.addItem(n)}e.addItem(this.getMainItem(e))};this.getMainItem=function(e){var t=new sap.ui.layout.form.Form({editable:true,formContainers:[this.getMainContent(e)],layout:new sap.ui.layout.form.ResponsiveGridLayout({labelSpanXL:3,labelSpanL:4,labelSpanM:5,labelSpanS:12,adjustLabelSpan:false})});return t};this.getMainContent=function(e){var t;var r=e.getModel();if(r){var a=r.getProperty("/visibleprompts");if(a){t=this.getFormContainer(e,[T(a)])}else{t=this.getFormContainer(e)}}return t};this.getFormContainer=function(e,t,r){var a=new sap.ui.layout.form.FormContainer({formElements:{path:"/characteristics",factory:this.getFromElementsFactory(e,r),filters:t}});e.ZENCharLists=[a];return a};this.getFromElementsFactory=function(e,t){return function(a,i){var n=i.getModel();var o=n.getProperty(t?i.getPath("entry/name"):i.getPath("characteristic/name"));var l=t?b(n,o):i.getPath("characteristic");if(!l){return new sap.ui.layout.form.FormElement({visible:false})}var s=h.getInput(n,o,l,e);e.ZEN_multiInput=[];e.ZEN_multiInput.push(s);var p;var u;if(n.getProperty("/property/variablescreen")){p=e.getId()+"-"+h.createUI5Identifier(o);u=p+"-label"}if(n.getProperty("/property/label")){var f=new r(u).bindProperty("text",{path:l,formatter:function(e){return e.text}});f.bindProperty("tooltip",{path:l,formatter:function(e){return e.text}});f.bindProperty("required",{path:l,formatter:function(e){return e.mandatory}})}var c=new sap.ui.layout.form.FormElement(p,{label:f,fields:[s]});if(e.ZEN_IdToDimensionMap){e.ZEN_IdToDimensionMap[c.getId()]=o}return c}};this.getInput=function(e,t,r,n){var o=this.getCharacteristicByName(e,t);var l=e.getProperty(r+"/type");var s=e.getProperty(r+"/hierarchical");var p=e.getProperty(r+"/supportsMultiSelection");var f=e.getProperty(r+"/supportsInterval");var c=e.getProperty(r+"/supportsRange");var g=e.getProperty(r+"/supportsExcluding");var d=e.getProperty(r+"/showValueHelp");var m,v;if(e.getProperty("/property/variablescreen")){v=n.getId()+"-"+h.createUI5Identifier(t)+"-input"}if(l==="DATE"&&!p&&!g&&!c&&!s||l==="TIME"&&!p&&!f){if(f){m=new sap.m.DateRangeSelection(v,{dateValue:{path:"/filters",mode:sap.ui.model.BindingMode.OneWay,formatter:this.getFilterFormatter(t,l,e,"from")},secondDateValue:{path:"/filters",mode:sap.ui.model.BindingMode.OneWay,formatter:this.getFilterFormatter(t,l,e,"to")},change:function(r){if(r.getParameter("valid")){m.setValueState(sap.ui.core.ValueState.None);n.hasClientError=false;var a=r.getParameter("from")?r.getParameter("from"):r.getParameter("to");var i=r.getParameter("to")?r.getParameter("to"):r.getParameter("from");var l=h.createRange(false,"BT",a,null,i,null);var s=h.createTokenFromRange(e,t,o,l);var p=[];p.push(s);h.applyTokensToFilter(m.getModel(),t,p,false)}else{m.setValueState(sap.ui.core.ValueState.Error);n.hasClientError=true;E()}}})}else{if(l==="DATE"){m=new sap.m.DatePicker(v,{valueFormat:"yyyyMMdd",dateValue:{path:"/filters",mode:sap.ui.model.BindingMode.OneWay,formatter:this.getFilterFormatter(t,l,e,"from")},change:function(r){if(r.getParameter("valid")){m.setValueState(sap.ui.core.ValueState.None);n.hasClientError=false;var a=r.getParameter("value");var i=h.createRange(false,y.EQ,a,null,null,null);var l=h.createTokenFromRange(e,t,o,i);var s=[];s.push(l);h.applyTokensToFilter(m.getModel(),t,s,false)}else{m.setValueState(sap.ui.core.ValueState.Error);n.hasClientError=true;E()}}})}else if(l==="TIME"){m=new sap.m.TimePicker(v,{valueFormat:"HH:mm:ss",dateValue:{path:"/filters",mode:sap.ui.model.BindingMode.OneWay,formatter:this.getFilterFormatter(t,l,e,"from")},change:function(r){if(r.getParameter("valid")){m.setValueState(sap.ui.core.ValueState.None);n.hasClientError=false;var a=r.getParameter("value");var i=h.createRange(false,sap.zen.dsh.ValueHelpRangeOperation.EQ,a,null,null,null);var l=h.createTokenFromRange(e,t,o,i);var s=[];s.push(l);h.applyTokensToFilter(m.getModel(),t,s,false)}else{m.setValueState(sap.ui.core.ValueState.Error);n.hasClientError=true;E()}}})}}}else{m=new sap.m.MultiInput(v,{showValueHelp:d?true:false,enableMultiLineMode:{path:"/filters",mode:sap.ui.model.BindingMode.OneWay,formatter:this.applyFilterToTokens(n,e,t)},tokenUpdate:function(e){if(e.getParameter("type")===sap.m.MultiInput.TokenChangeType.Removed){var r=e.getParameter("removedTokens");var a=m.getTokens().filter(function(e){return r.every(function(t){return t!==e})});h.applyTokensToFilter(m.getModel(),t,a,true)}else if(e.getParameter("type")===sap.m.MultiInput.TokenChangeType.Added){var i=e.getParameter("addedTokens");var n=h.getTokensFromClipboard(t);if(n){for(var o=0;o<i.length;o++){var l=i[o];if(!l){continue}for(var s=0;s<n.length;s++){var p=n[s];if(!p){continue}if(l.getText()===p.getText()){l.setKey(p.getKey());l.setText(p.getText());l.setTooltip(p.getTooltip());l.data(p.data());n.splice(o,1);break}}}}h.clearClipboard(t);a=m.getTokens().filter(function(e){return i.every(function(t){return t!==e})});a=a.concat(i);h.applyTokensToFilter(m.getModel(),t,a,true)}}});m.addValidator(function(e){var t=new a({key:e.text,text:e.text,tooltip:e.text});return t});var P=m.getAggregation("tokenizer");P._copy=function(){if(i.prototype._copy){i.prototype._copy.apply(this,arguments)}h.addTokensToClipboard(t,this.getSelectedTokens())}}if(d&&m.attachValueHelpRequest){var T=function(){u.show(0);new Function(h.prepareCommand(e.getProperty("/command/showfilterdialog"),"__STRING__",t))()};m.attachValueHelpRequest(T)}m.addEventDelegate({onfocusin:function(){n.$().css("z-index","1")},onfocusout:function(){n.$().css("z-index","")},oncopy:function(){}});m.oZenControl=n;return m};this.addTokensToClipboard=function(e,t){if(!this.oClipboard[e]){this.oClipboard[e]=[]}for(var r=0;r<t.length;r++){var a=t[r];if(!a){continue}var i=this.copyToken(a);this.oClipboard[e].push(i)}};this.getTokensFromClipboard=function(e){return this.oClipboard[e]};this.clearClipboard=function(e){this.oClipboard[e]=[]};this.getFilterFormatter=function(e,t,r,a){return function(r){if(r&&e&&r[e]){var i=r[e];if(i.ranges){var n=i.ranges[0];if(n){var o=n[a];if(o){if(t==="DATE"){return h.getDateFormat().parse(o.key)}else if(t==="TIME"){return h.getTimeFormat().parse(o.key)}}}}}return null}};this.getDateFormat=function(){return sap.ui.core.format.DateFormat.getInstance({pattern:"yyyyMMdd",strictParsing:true})};this.getTimeFormat=function(){return sap.ui.core.format.DateFormat.getTimeInstance({pattern:"HH:mm:ss",strictParsing:true})};this.applyFilterToTokens=function(e,t,r){return function(a){if(e.ZEN_multiInput[0].getId()!==this.getId()){e.ZEN_multiInput[0]=this}if(!a||!r||!a[r]){this.setTokens([]);return true}var i=[];var n=a[r];if(n&&n.ranges&&n.ranges.length>0){var o=h.getCharacteristicByName(t,r);for(var l=0;l<n.ranges.length;l++){var s=n.ranges[l];if(!s){continue}var p=h.createTokenFromRange(t,r,o,s);if(p){p.data("validated",true);i.push(p)}}}this.setTokens(i);return true}};this.applyTokensToFilter=function(e,t,r,a){var i=this.getCharacteristicByName(e,t);var n=e.getProperty("/filters");var o=null;if(n){o=n[t]}if(o){o.dirty=true;o.input=[];o.ranges=[];for(var l=0;l<r.length;l++){var s=r[l];if(!s){continue}var p=false;if(s.data("validated")){p=s.data("validated")}var u=this.createRangeFromToken(e,t,i,s);if(u){var f=this.isRangeARangeDefinition(u);if(!p&&(a&&!f)){o.input.push(u.from.key)}else{o.ranges.push(u)}}}}var c=e.getProperty("/property/pauserefresh");if(!c){this.submitAll(e,!e.getProperty("/property/variablescreen"),!c)}else{this.submitAll(e,false,!c)}};this.createTokenFromRange=function(e,t,r,a){if(!a||!a.from){return null}if(!r){r=this.getCharacteristicByName(e,t)}var i=e.getProperty("/property/memberdisplay");var n;if(!r.supportsValueHelp){n=true}var o,l;if(r.type==="DATE"){o=this.getDateFormat();l=sap.ui.core.format.DateFormat.getDateInstance()}else if(r.type==="TIME"){o=this.getTimeFormat();l=sap.ui.core.format.DateFormat.getTimeInstance()}var s=this.isRangeARangeDefinition(a);if(o){s=true}var p,u,f,c;if(a.from){p=a.from.key&&a.from.key.length>0||!a.from.displaykey?a.from.key:a.from.displaykey;u=a.from.displaykey&&a.from.displaykey.length>0||!a.from.key?a.from.displaykey:s?a.from.key:a.from.text;if(o){u=p;try{if(u){c=o.parse(u);if(!c){c=u}f=l.format(c)}}catch(e){}}else{if(n||u===a.from.text){f=sap.ui.comp.util.FormatUtil.getFormattedExpressionFromDisplayBehaviour("idOnly",u)}else{f=sap.ui.comp.util.FormatUtil.getFormattedExpressionFromDisplayBehaviour(this.getValueHelpDialogMemberDisplay(i),u,a.from.text)}}if(!f||f.length<=0){f=u}}else{u="";f=""}var g,m,y,h;if(a.to){g=a.to.key&&a.to.key.length>0||!a.to.displaykey?a.to.key:a.to.displaykey;m=a.to.displaykey&&a.to.displaykey.length>0||!a.to.key?a.to.displaykey:s?a.to.key:a.to.text;if(o){m=g;try{if(m){h=o.parse(m);if(!h){h=m}y=l.format(h)}}catch(e){}}else{if(n||m===a.to.text){y=sap.ui.comp.util.FormatUtil.getFormattedExpressionFromDisplayBehaviour("idOnly",m)}else{y=sap.ui.comp.util.FormatUtil.getFormattedExpressionFromDisplayBehaviour(this.getValueHelpDialogMemberDisplay(i),m,a.to.text)}}if(!y||y.length<=0){y=m}}else{m="";y=""}var v=a.operation?a.operation:sap.zen.dsh.ValueHelpRangeOperation.EQ;var P=a.exclude?true:false;var T="key";var b=null;var E=null;if(r.compound){f=u;y=m}if(!s){b=p;E=f}else{b="range"+"_"+P+"_"+v+"_"+u+"_"+m;E=d.prototype._getFormattedRangeTokenText(v,f,y,P,T)}var _=new sap.m.Token({key:b,text:E,tooltip:E});_.data("range",{isRange:s,exclude:P,operation:v,keyField:T,value1:c?c:u,textFrom:f,value2:h?h:m,textTo:y});return _};this.copyToken=function(e){if(!e){return null}var t=new a({key:e.getKey(),text:e.getText(),tooltip:e.getTooltip()});t.data(e.data());return t};this.createRangeFromToken=function(e,t,r,a){if(!a){return null}if(!r){r=this.getCharacteristicByName(e,t)}var i=null;var n=null;var o=a.getKey();var l=a.getText();var s=null;var p=null;var u=a.data("longKey");var f=false;if(a.data("range")){var c=a.data("range");f=c.isRange;i=c.exclude;n=c.operation;if(f){o=c.value1;l=c.textFrom;s=c.value2;p=c.textTo}}else{if(u){o=u}}var g=null;if(o){if(r.type==="DATE"){g=this.getDateFormat();if(o.getDate){o=g.format(o)}}else if(r.type==="TIME"){g=this.getTimeFormat();if(o.getTime){o=g.format(o)}}}if(s){if(r.type==="DATE"){if(!g){g=this.getDateFormat()}if(s.getDate){s=g.format(s)}}else if(r.type==="TIME"){if(!g){g=this.getTimeFormat()}if(s.getTime){s=g.format(s)}}}var d=this.createRange(i,n,o,l,s,p);return d};this.createRange=function(e,t,r,a,i,n){if(r===null||r===undefined){return null}var o={};if(e){o.exclude=e}if(t){o.operation=t}if(r!==null&&r!==undefined){o.from={};o.from.key=r;if(a){o.from.text=a}}if(i!==null&&i!==undefined){o.to={};o.to.key=i;if(n){o.to.text=n}}return o};this.isRangeARangeDefinition=function(e){var t=true;if(!e.exclude&&(!e.operation||e.operation===sap.zen.dsh.ValueHelpRangeOperation.EQ)){t=false}return t};this.submitExternal=function(e,t,r){return function(a,i){return h.submitAll(e,t,r,a,i)}};this.submitAll=function(e,t,r,a,i){var n=[];var o=e.getProperty("/filters");if(o){for(var l in o){var s=o[l];if(!s){continue}if(s.dirty){var p=this.getCharacteristicByName(e,l);s.dirty=!e.getProperty("/property/variablescreen")&&!t;var u={};u.name=l;if(s.input!==undefined&&s.input!==null){u.input=[];if(Array&&Array.isArray(s.input)||typeof s.input==="object"&&s.input.constructor===Array){u.input=s.input}else{u.input.push(s.input)}}u.ranges=[];n.push(u);var f=s.ranges.length;for(var c=0;c<f;c++){var g=s.ranges[c];if(!g){continue}var d={};if(p.type!=="DATE"&&g.operation&&g.operation!==sap.zen.dsh.ValueHelpRangeOperation.EQ&&!g.exclude&&g.from.displaykey){d.from=g.from.displaykey}else{d.from=g.from.key}if(p.type!=="DATE"&&g.to&&g.to.displaykey){d.to=g.to.displaykey}else if(g.to){d.to=g.to.key}if(g.operation&&g.operation!==sap.zen.dsh.ValueHelpRangeOperation.EQ){d.operation=g.operation}if(g.exclude){d.exclude=true}u.ranges.push(d)}}}}var m=e.getProperty("/characteristics");if(m){var y;for(c=0;c<m.length;c++){var v=m[c];if(!v){continue}if(v.characteristic.axisdirty){if(!y){y=e.getProperty("/axis")}v.characteristic.axisdirty=!t}}if(!y&&(e.getProperty("/axis/rows/dirty")||e.getProperty("/axis/columns/dirty"))){y=e.getProperty("/axis")}if(t&&y){e.setProperty("/axis/rows/dirty",undefined);e.setProperty("/axis/columns/dirty",undefined)}var P=e.getProperty("/property/variablescreen");if(y||n.length>0||P&&t){if(P){sap.zen.MessageViewHandler.clearMessages()}if(!y){y={}}var T={filters:n,axis:y};if(a&&i){var b=h.prepareCommand(i,a,JSON.stringify(T));return b}else{b=h.prepareCommand(e.getProperty(r?"/command/submitfilter":"/command/submitonlyfilter"),"__STRING__",JSON.stringify(T));b=h.prepareCommand(b,"__BOOLEAN__",t?"X":" ");new Function(b)()}}}};this.getValueHelpDialog=function(t){var r=t.getModel();var a=r.getProperty("/dialog/name");var i=r.getProperty("/command/destroyfilterdialog");var n=-1;var o=r.getProperty("/dialog/type");var l=r.getProperty("/dialog/compound");var s=r.getProperty("/dialog/hierarchical");var p=r.getProperty("/dialog/supportsMultiSelection");var u=r.getProperty("/dialog/supportsInterval");var f=r.getProperty("/dialog/supportsRange");var c=r.getProperty("/dialog/supportsIncludingPattern");var g=r.getProperty("/dialog/supportsExcluding");var m=r.getProperty("/dialog/supportsExcludingPattern");var y=r.getProperty("/dialog/supportsValueHelpRange");var v=r.getProperty("/dialog/showValueHelpRangesOnly");var P=r.getProperty("/dialog/showValueHelpConditionEQ");var T=r.getProperty("/dialog/requiresValueHelpRange");var b=r.getProperty("/dialog/range/visible");var E=t.getId()+"_ValueHelpDialog";var _=new d({id:E,title:"{/dialog/title}",supportMultiselect:p?true:false,supportRanges:T?true:false,supportRangesOnly:v?true:false,key:"key",descriptionKey:l?"":"text",ok:function(e){var n=e.getParameter("tokens");h.applyTokensToFilter(r,a,n,false);t.zenValueHelpDialog=null;new Function(h.prepareCommand(i,"__BOOLEAN__"," "))();_.close()},cancel:function(){t.zenValueHelpDialog=null;new Function(h.prepareCommand(i,"__BOOLEAN__","X"))();_.close()},afterClose:function(){if(t.zenValueHelpDialog){t.zenValueHelpDialog=null;new Function(h.prepareCommand(i,"__BOOLEAN__","X"))()}_.destroy()},afterOpen:function(){sap.ui.core.BusyIndicator.hide()}});if(s){_.setTable(new sap.ui.table.TreeTable)}if(T||b){var x=[];if(P){x.push(sap.zen.dsh.ValueHelpRangeOperation.EQ)}if(y){x.push(sap.zen.dsh.ValueHelpRangeOperation.BT)}if(!p){_.setMaxIncludeRanges("1")}else{if(f){x.push(sap.zen.dsh.ValueHelpRangeOperation.LT);x.push(sap.zen.dsh.ValueHelpRangeOperation.LE);x.push(sap.zen.dsh.ValueHelpRangeOperation.GT);x.push(sap.zen.dsh.ValueHelpRangeOperation.GE);if(c){x.push(sap.zen.dsh.ValueHelpRangeOperation.Contains);x.push(sap.zen.dsh.ValueHelpRangeOperation.StartsWith);x.push(sap.zen.dsh.ValueHelpRangeOperation.EndsWith)}}else if(u){_.setMaxIncludeRanges("1")}}_.setIncludeRangeOperations(x);if(o==="DATE"){_.setIncludeRangeOperations(x,"date")}else if(o==="TIME"){_.setIncludeRangeOperations(x,"time")}}else{_.setMaxIncludeRanges("0")}if(g){var k=[];k.push(sap.zen.dsh.ValueHelpRangeOperation.EQ);if(y||b){k.push(sap.zen.dsh.ValueHelpRangeOperation.BT)}if(!p){_.setMaxExcludeRanges("1")}else{if(f){k.push(sap.zen.dsh.ValueHelpRangeOperation.LT);k.push(sap.zen.dsh.ValueHelpRangeOperation.LE);k.push(sap.zen.dsh.ValueHelpRangeOperation.GT);k.push(sap.zen.dsh.ValueHelpRangeOperation.GE);if(m){k.push(sap.zen.dsh.ValueHelpRangeOperation.Contains);k.push(sap.zen.dsh.ValueHelpRangeOperation.StartsWith);k.push(sap.zen.dsh.ValueHelpRangeOperation.EndsWith)}}else if(u){_.setMaxExcludeRanges("1")}}_.setExcludeRangeOperations(k)}else{_.setMaxExcludeRanges("0")}var F=_.getTable();if(s&&F.attachToggleOpenState){var C;F.attachToggleOpenState(function(e){var t=e.getParameters();_._bIgnoreSelectionChange=true;if(t.expanded){var r=t.rowContext;var a=r.oModel;if(a.getProperty(r.sPath+"/0/node")){var i=h.prepareCommand(a.getProperty("/command/expandnode"),"__STRING__",a.getProperty(r.sPath+"/key"));i=h.prepareCommand(i,"__STRING2__",r.sPath);new Function(i)()}else{_.update()}}});var D=F.onclick;F.onclick=function(){if(D){D.apply(F,arguments)}_._bIgnoreSelectionChange=false;if(C){t.zenValueHelpDialog.update();C=false}};_.attachTokenRemove(function(e){var t=e.getParameters().tokenKeys;if(t&&t.length>0){var r=F.getBinding("rows").getContexts(0);if(r&&r.length>0){for(var a=0;a<t.length;a++){var i=t[a];if(!i){continue}for(var n=0;n<r.length;n++){var o=r[n];if(!o){continue}var l=o.getObject();if(l["key"]===i){F.removeSelectionInterval(n,n);_.setChildSelection(false,l);_.update()}}}}}});_.attachUpdateSelection(function(e){F.clearSelection();var t=e.getParameters().tokenKeys;if(t&&t.length>0){var r=F.getBinding("rows").getContexts(0);if(r&&r.length>0){for(var a=0;a<t.length;a++){var i=t[a];if(!i){continue}var n=null;for(var o=0;o<r.length;o++){var l=r[o];if(!l){continue}var s=l.getObject();if(n!==null){if(n<s.lLevel){F.addSelectionInterval(o,o)}else{n=null}}else if(s["key"]===i){this._oSelectedItems.add(s["key"],s);F.addSelectionInterval(o,o);n=s.lLevel}}}}}});_.attachSelectionChange(function(e){var t=F.getBinding("rows");var r=false;if(t.aKeys){r=true}var a=e.getParameter("tableSelectionParams").rowIndices;var i=e.getParameter("tableSelectionParams").selectAll&&!_.getFilterBar().ZEN_searchValue;if(i&&a.length){_.removeAllSelections(false)}if(!this.getSupportMultiselect()){_.removeAllSelections(true)}for(var n=0;n<a.length;n++){var o=a[n];var l=F.getContextByIndex(o);var s=l?l.getObject():null;if(s){var p;if(r){p=l.sPath.substring(1)}else{p=s["key"]}if(F.isIndexSelected(o)||i){if(!i||!s.level){_.setSelection(true,p,s);_.setChildSelection(false,s)}}else{_.setSelection(false,p,s);_.setChildSelection(false,s)}}}_.update()})}var I=new e;var S=r.getProperty("/property/memberdisplay");_.setTokenDisplayBehaviour(this.getValueHelpDialogMemberDisplay(S));if(S==="KEY"){I.setData({cols:[{label:r.getProperty("/text/key"),template:"displaykey"}]})}else if(S==="TEXT"){I.setData({cols:[{label:r.getProperty("/text/text"),template:"text"}]})}else if(S==="KEY_TEXT"){I.setData({cols:[{label:r.getProperty("/text/key"),template:"displaykey"},{label:r.getProperty("/text/text"),template:"text"}]})}else if(S==="TEXT_KEY"){I.setData({cols:[{label:r.getProperty("/text/text"),template:"text"},{label:r.getProperty("/text/key"),template:"displaykey"}]})}F.setModel(I,"columns");var R={label:r.getProperty("/text/key"),key:"key"};if(b||g){if(o==="DATE"){R.type="date"}else if(o==="TIME"){R.type="time"}}_.setRangeKeyFields([R]);_.setModel(r);F.bindRows("/dialog/members");if(t.$().closest(".sapUiSizeCompact").length>0){_.addStyleClass("sapUiSizeCompact")}this.applyFilterToTokens(t,r,r.getProperty("/dialog/name")).call(_,r.getProperty("/filters"));var V=new sap.m.SearchField({width:"95%",placeholder:"{/text/search}"});var w;if(s){w=r.getProperty("/dialog/members");if(w){for(var M=0;M===n+1;M++){var H=w[""+M];if(!H){continue}H.level=0;n=M}}}if(!r.getProperty("/dialog/nosearch")&&(r.getProperty("/dialog/selection/maxelements")||s)){V.setBusyIndicatorDelay(0);_.TableStateSearchData();V.attachSearch(function(e){V.setBusy(true);_.TableStateDataSearching();var t=e.getParameters().query;V.ZEN_searchValue=t;new Function(h.prepareCommand(r.getProperty("/command/membersearch"),"__STRING__",t))()})}else{w=r.getProperty("/dialog/members");if(w){for(M=0;M<w.length;M++){var O=w[M];if(!O){continue}var z="";if(S!=="KEY"){z+=O.text}if(S!=="TEXT"){if(z){z+=" "}z+=O.displaykey}O.searchstring=z}}V.setShowSearchButton(false);V.attachLiveChange(function(e){var t=e.getParameters().newValue?e.getParameters().newValue.toUpperCase():"";var a=["\\\\","\\^","\\$","\\+","\\.","\\(","\\)","\\[","\\]","\\{","\\}"];for(var i=0;i<a.length;i++){var n=a[i];if(!n){continue}t=t.replace(new RegExp(n,"g"),n)}t=t.replace(/\?/g,".").replace(/\*/g,".*?");var o=new sap.ui.model.Filter("searchstring","Wildcard",t);o.fnTest=function(e){return e.search(new RegExp(t))!==-1};if(!r.getProperty("/dialog/selection/maxelements")&&!r.getProperty("/dialog/hierarchical")){_._bIgnoreSelectionChange=true;_.getTable().getBinding("rows").filter([o]);_._bIgnoreSelectionChange=false;_.update()}});_.TableStateDataFilled()}_.setFilterBar(V);return _};this.getValueHelpDialogMemberDisplay=function(e){switch(e){case"TEXT_KEY":return"descriptionAndId";case"KEY_TEXT":return"idAndDescription";case"TEXT":return"descriptionOnly";default:return"idOnly"}};this.getVariableTechnicalName=function(e){return e.substring(e.indexOf(":")+1,e.length)};function v(e,t){var r=e.getModel();return new n({icon:"sap-icon://action-settings",press:function(){var a=new p({items:{path:"/characteristics",template:new s({title:"{characteristic/text}",selected:{path:"/visibleprompts",formatter:function(e){var t=h.getVariableTechnicalName(this.getBindingContext().getProperty("characteristic/name"));for(var r=0;r<e.length;r++){if(e[r]===t){return true}}return false}}}),filters:[P()],sorter:new f({path:"characteristic/text"})},growingThreshold:0,multiSelect:true,liveChange:function(e){var t=new sap.ui.model.Filter("characteristic/text",sap.ui.model.FilterOperator.Contains,e.getParameter("value"));e.getParameter("itemsBinding").filter([P(),t])},cancel:function(){a.destroy()},confirm:function(a){var i=[];var n=a.getParameter("selectedContexts");for(var o=0;o<n.length;o++){var l=n[o];if(!l){continue}var s=l.getProperty("characteristic/name");var p=s.substring(s.indexOf(":")+1,s.length);i.push(p)}r.setProperty("/visibleprompts",i);t.setValue("");e.ZENCharLists[0].getBinding("formElements").filter([T(i)]);new Function(h.prepareCommand(r.getProperty("/command/setvisibleprompts"),"__ARRAY__",JSON.stringify(i)))()}});a.setModel(r);a.open()}})}function P(){return new sap.ui.model.Filter({path:"characteristic",test:function(e){return e.mandatory?false:true}})}function T(e){return new sap.ui.model.Filter({path:"characteristic",test:function(t){if(t.mandatory){return true}var r=h.getVariableTechnicalName(t.name);for(var a=0;a<e.length;a++){if(e[a]===r){return true}}return false}})}function b(e,t){var r=e.getProperty("/characteristics");if(r){for(var a=0;a<r.length;a++){var i=r[a].characteristic;if(!i){continue}if(i.name===t){return"/characteristics/"+a+"/characteristic"}}}return null}function E(){var e=document.getElementsByClassName("zenDialogOkButton");if(e&&e.length){var t=sap.ui.getCore().byId(e[0].id);if(t){t.setEnabled(false)}}}function _(e,t){if(!e&&t||e&&!t){return false}if(e&&t){if(e.length!==t.length){return false}for(var r=0;r<e.length;r++){var a=e[r].characteristic;var i=t[r].characteristic;if(!a||!i){continue}if(a.name!==i.name||a.axis!==i.axis){return false}}}return true}this.isDesignModeD4LIncluded=function(){return sap.zen.designmode};function x(e,t){var r=e.aBindings.slice(0);jQuery.each(r,function(e,r){if(r.sPath===t){r.checkUpdate(true)}})}this.getCharacteristicByName=function(e,t){var r=e.getProperty("/characteristics");for(var a=0;a<r.length;a++){var i=r[a].characteristic;if(!i){continue}if(i.name===t){return i}}return null};this.getContextMenuAction=function(e,t,r){var a=t.getModel().getProperty("/command/createcontextmenu");if(a&&t.ZEN_IdToDimensionMap){var i=this.getListItemElement(r);if(i&&i[0]){var n=t.ZEN_IdToDimensionMap[i[0].id];var o;if(n){var l=h.prepareCommand(a,"__STRING__",e);l=h.prepareCommand(l,"__STRING2__",n);l=h.prepareCommand(l,"__STRING3__",o);l=h.prepareCommand(l,"__STRING4__",r[0].id);return new Function(l)}}}return null};this.getListItemElement=function(e){if(e.hasClass("sapzenfilterpanelM-ListItem")){return e}else{return e.parents(".sapzenfilterpanelM-ListItem")}};this.getType=function(){return"filter"};this.getDecorator=function(){return"DataSourceControlDecorator"}};var P=new v;h.addHandlers(P.getType(),P,"DataSourceControlDecorator");h.addHandlers("filterpanel",P,"DataSourceControlDecorator");return P});
//# sourceMappingURL=filterpanel_m_handler.js.map
/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/base/Log","../data/PushContextData","../data/TelemetryData","../utils/Constants","../ui/UiFactory","./DateCalculator","../utils/Utils"],function(t,e,o,a,n,s,r,i){"use strict";return t.extend("sap.feedback.ui.flpplugin.survey.PresentationController",{_oContextDataController:null,_oResourceBundle:null,_oUserStorage:null,_oCentralConfig:null,_oSurveyInvitationDialog:null,init:function(t,e,o,a){if(!t){throw Error("oContextDataController is not provided!")}if(!e){throw Error("oResourceBundle is not provided!")}if(!o){throw Error("oUserStorage is not provided!")}if(!a){throw Error("oCentralConfig is not provided!")}this._oContextDataController=t;this._oResourceBundle=e;this._oUserStorage=o;this._oCentralConfig=a},surveyUser:function(t,e){return this._prepareAndRunPushSurvey(t,e)},_prepareAndRunPushSurvey:function(t,e){var o=this._preparePushContextData(t,e);if(!this._oSurveyInvitationDialog){this._oSurveyInvitationDialog=s.createSurveyInvitationDialog(this._oResourceBundle)}return new Promise(function(a,n){this._oSurveyInvitationDialog.show(function(t){if(t){this._updateContextDataAndOpenSurvey(o,e).then(a)}else{this._snoozePush();a()}}.bind(this),t.type)}.bind(this))},_preparePushContextData:function(t,e){var a=null;var n,s,r,i;var u=t.type;if(e){n=e.oConfig.getAreaId();s=e.oConfig.getTriggerName()}else{n=t.areaId;s=t.triggerName}r=t.shortText||"";i=t.payload||null;a=new o(n,s,u,r);if(i){a.setPayloadData(i)}return a},_updateContextDataAndOpenSurvey:function(t,o){var a=n.E_CLIENT_ACTION.inAppPushFeedback;if(t.getType()===n.E_PUSH_SRC_TYPE.dynamic){a=n.E_CLIENT_ACTION.dynamicPushFeedBack}var s=0;if(o){s=o.oState.getExecutedCount()}var r=this._collectTelemetry(o);return this._oContextDataController.updateContextData(a,t,r).then(function(){return this._openSurvey(a,s).then(function(){this._updateLastPushTimestamp();this._updatePushState(o);this._updateNextPushDates(t.getType())}.bind(this))}.bind(this)).catch(function(t){e.error("Fiori Feedback Plug-in error occured on updating push context data.",t.message,n.S_PLUGIN_SURVEY_PRESENTATION_CONTROLLER_NAME)})},_collectTelemetry:function(t){var e=new a;var o=i.readUserState(this._oUserStorage);if(o){e.setPushEventSnoozedCount(o.getSnoozeCount());var n=Date.now()-o.getLastPush();e.setTimeSinceLastPushEvent(n)}if(t&&t.oState){e.setPushEventTriggeredCount(t.oState.getTriggeredCount());e.setPushEventExecutedCount(t.oState.getExecutedCount())}return e},_snoozePush:function(){var t=i.readUserState(this._oUserStorage);if(t){var e=t.getSnoozeCount();if(e>=n.I_MAX_SNOOZE_COUNT){this._skipOnSnooze()}else{this._updateSnoozeValues(e+1)}}},_skipOnSnooze:function(){this._updateNextPushDates(n.E_PUSH_SRC_TYPE.pushInApp);this._updateNextPushDates(n.E_PUSH_SRC_TYPE.dynamic);var t=i.readUserState(this._oUserStorage);t.resetSnoozeCount();this._saveUserState(t)},_updateSnoozeValues:function(t){var e=i.readUserState(this._oUserStorage);var o=e.getInAppPushDate();var a=e.getDynamicPushDate();var s=Date.now()+n.E_TIME.hoursToMilliseconds*(this._getPushConfig().getSnoozePeriodInHrs()*t);if(o&&o<s){e.setInAppPushDate(s)}if(a&&a<s){e.setDynamicPushDate(s)}e.increaseSnoozeCount();this._saveUserState(e)},_openSurvey:function(t,e){if(this._oContextDataController){this._oContextDataController.setClientAction(t);this._oContextDataController.setLastTheme(this._sLastThemeId);this._oContextDataController.setFollowUpCount(e)}QSI.API.unload();return QSI.API.load().then(function(){QSI.API.run()})},_updateLastPushTimestamp:function(){var t=i.readUserState(this._oUserStorage);t.updateLastPushToNow();t.resetSnoozeCount();this._saveUserState(t)},_updatePushState:function(t){if(t){var o=t.oState;var a=i.readUserState(this._oUserStorage);a.resetSnoozeCount();var s=a.getFeaturePushState(o.getAreaId(),o.getTriggerName());if(s){s.increaseExecutedCount();this._saveUserState(a)}else{e.error("Feature Push state could not be updated.",null,n.S_PLUGIN_SURVEY_PRESENTATION_CONTROLLER_NAME)}}},_updateNextPushDates:function(t){var e=Date.now()+n.E_TIME.hoursToMilliseconds*this._getPushConfig().getQuietPeriodInHrs();var o=i.readUserState(this._oUserStorage);if(o){if(t===n.E_PUSH_SRC_TYPE.dynamic){o.setDynamicPushDate(r.calculateNextDynamicPushDate(this._getPushConfig()));var a=o.getInAppPushDate();if(a&&a<e){o.setInAppPushDate(e)}}else if(t===n.E_PUSH_SRC_TYPE.pushInApp){o.setInAppPushDate(r.calculateNextInAppPushDate(this._getPushConfig()));var s=o.getDynamicPushDate();if(s&&s<e){o.setDynamicPushDate(e)}}this._saveUserState(o)}},_getPushConfig:function(){return this._oCentralConfig.getPushConfig()},_saveUserState:function(t){this._oUserStorage.saveUserState(t)}})});
//# sourceMappingURL=PresentationController.js.map